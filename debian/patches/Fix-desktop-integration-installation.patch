From: Norbert Preining <norbert@preining.info>
Date: Mon, 17 Jul 2017 14:29:16 +0200
Subject: Fix desktop integration installation

Don't use xdg-mime and xdg-desktop-menu because they hard-code
gnome_app_dir etc which cannot be overridden, and replace with install calls.
---
 src/calibre/linux.py |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- calibre-debian.git.orig/src/calibre/linux.py
+++ calibre-debian.git/src/calibre/linux.py
@@ -890,8 +890,9 @@ class PostInstall:
                     translators = dict(get_all_translators())
 
                 APPDATA = get_appdata()
+                xdgdir = os.environ.get('XDG_DATA_DIRS')
                 for x in des:
-                    cmd = ['xdg-desktop-menu', 'install', '--noupdate', './'+x]
+                    cmd = ['install', '-o', 'root', '-g', 'root', '-m', '0644', './'+x, xdgdir + '/applications']
                     cc(' '.join(cmd), shell=True)
                     self.menu_resources.append(x)
                     ak = x.partition('.')[0]
