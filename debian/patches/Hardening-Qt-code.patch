From: YOKOTA Hiroshi <qykth-git@users.noreply.github.com>
Date: Sat, 23 Nov 2019 17:48:46 +0900
Subject: [PATCH] Hardening Qt code

---
 setup/build.py |   10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

--- calibre-debian.git.orig/setup/build.py
+++ calibre-debian.git/setup/build.py
@@ -168,6 +168,7 @@ def init_env():
         ldflags = os.environ.get('OVERRIDE_LDFLAGS', '-Wall')
         ldflags = shlex.split(ldflags)
         cflags += shlex.split(os.environ.get('CFLAGS', ''))
+        cflags += shlex.split(os.environ.get('CPPFLAGS', ''))
         ldflags += shlex.split(os.environ.get('LDFLAGS', ''))
         cflags += ['-fvisibility=hidden']
 
@@ -517,10 +518,17 @@ class Build(Command):
         macx {{
             QMAKE_LFLAGS += "-undefined dynamic_lookup"
         }}
+        QMAKE_CFLAGS   += {CFLAGS}   {CPPFLAGS}
+        QMAKE_CXXFLAGS += {CXXFLAGS} {CPPFLAGS}
+        QMAKE_LFLAGS   += {LFLAGS}
         ''').format(
             target=sip['target'], headers=' '.join(sip['headers'] + ext.headers), sources=' '.join(ext.sources + sip['sources']),
             sipinc=pyqt['sip_inc_dir'], pyinc=sysconfig.get_python_inc(), py_lib=py_lib,
-            ver=__version__
+            ver=__version__,
+            CFLAGS   = os.environ.get('CFLAGS',   ''),
+            CXXFLAGS = os.environ.get('CXXFLAGS', ''),
+            CPPFLAGS = os.environ.get('CPPFLAGS', ''),
+            LFLAGS   = os.environ.get('LDFLAGS',  '')
         )
         for incdir in ext.inc_dirs:
             pro += '\nINCLUDEPATH += ' + incdir
