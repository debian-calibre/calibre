From: Martin Pitt <mpitt@debian.org>
Date: Mon, 14 Nov 2016 22:41:23 +0100
Subject: Use packaged instead of bundled feedparser Python module

---
 recipes/lenta_ru.recipe           |    4 ++--
 src/calibre/test_build.py         |    2 +-
 src/calibre/web/feeds/__init__.py |    4 ++--
 3 files changed, 5 insertions(+), 5 deletions(-)

Index: b/recipes/lenta_ru.recipe
===================================================================
--- a/recipes/lenta_ru.recipe
+++ b/recipes/lenta_ru.recipe
@@ -4,7 +4,7 @@
 Lenta.ru
 '''
 
-from calibre.web.feeds.feedparser import parse
+from feedparser import parse
 from calibre.ebooks.BeautifulSoup import Tag
 from calibre.web.feeds.news import BasicNewsRecipe
 import re
@@ -63,7 +63,7 @@ class LentaRURecipe(BasicNewsRecipe):
 
     def parse_index(self):
         try:
-            feedData = parse(self.feeds[0])
+            feedData = parse(self.feeds[0], agent='Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.11) Gecko/20101012 Firefox/3.6.11')
             if not feedData:
                 raise NotImplementedError
             self.log("parse_index: Feed loaded successfully.")
Index: b/src/calibre/web/feeds/__init__.py
===================================================================
--- a/src/calibre/web/feeds/__init__.py
+++ b/src/calibre/web/feeds/__init__.py
@@ -329,11 +329,11 @@ def feed_from_xml(raw_xml, title=None, o
                   max_articles_per_feed=100,
                   get_article_url=lambda item: item.get('link', None),
                   log=default_log):
-    from calibre.web.feeds.feedparser import parse
+    from feedparser import parse
     # Handle unclosed escaped entities. They trip up feedparser and HBR for one
     # generates them
     raw_xml = re.sub(br'(&amp;#\d+)([^0-9;])', br'\1;\2', raw_xml)
-    feed = parse(raw_xml)
+    feed = parse(raw_xml, agent='Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.11) Gecko/20101012 Firefox/3.6.11')
     pfeed = Feed(get_article_url=get_article_url, log=log)
     pfeed.populate_from_feed(feed, title=title,
                             oldest_article=oldest_article,
Index: b/src/calibre/test_build.py
===================================================================
--- a/src/calibre/test_build.py
+++ b/src/calibre/test_build.py
@@ -320,7 +320,7 @@ class BuildTest(unittest.TestCase):
         sanitize_comments_html(b'''<script>moo</script>xxx<img src="http://moo.com/x.jpg">''')
 
     def test_feedparser(self):
-        from calibre.web.feeds.feedparser import parse
+        from feedparser import parse
         # sgmllib is needed for feedparser parsing malformed feeds
         # on python3 you can get it by taking it from python2 stdlib and
         # running 2to3 on it
