From cc9ca5f9d324fcb671a3f7f75df28da0910fdabb Mon Sep 17 00:00:00 2001
From: Kovid Goyal <kovid@kovidgoyal.net>
Date: Fri, 10 Jul 2020 12:28:22 +0530
Subject: [PATCH 180/201] Allow easily reading viewer config data from the main
 calibre process

---
 src/calibre/gui2/viewer/config.py   | 18 ++++++++++++++++++
 src/calibre/gui2/viewer/web_view.py | 16 ++++------------
 2 files changed, 22 insertions(+), 12 deletions(-)
 create mode 100644 src/calibre/gui2/viewer/config.py

diff --git a/src/calibre/gui2/viewer/config.py b/src/calibre/gui2/viewer/config.py
new file mode 100644
index 0000000000..5269b7c35c
--- /dev/null
+++ b/src/calibre/gui2/viewer/config.py
@@ -0,0 +1,18 @@
+#!/usr/bin/env python2
+# vim:fileencoding=utf-8
+# License: GPL v3 Copyright: 2020, Kovid Goyal <kovid at kovidgoyal.net>
+
+from __future__ import absolute_import, division, print_function, unicode_literals
+
+import os
+from calibre.constants import config_dir
+from calibre.utils.config import JSONConfig
+
+vprefs = JSONConfig('viewer-webengine')
+viewer_config_dir = os.path.join(config_dir, 'viewer')
+vprefs.defaults['session_data'] = {}
+vprefs.defaults['local_storage'] = {}
+vprefs.defaults['main_window_state'] = None
+vprefs.defaults['main_window_geometry'] = None
+vprefs.defaults['old_prefs_migrated'] = False
+vprefs.defaults['bookmarks_sort'] = 'title'
diff --git a/src/calibre/gui2/viewer/web_view.py b/src/calibre/gui2/viewer/web_view.py
index 98d6679c42..6364c821b3 100644
--- a/src/calibre/gui2/viewer/web_view.py
+++ b/src/calibre/gui2/viewer/web_view.py
@@ -19,18 +19,18 @@ from PyQt5.QtWebEngineWidgets import (
 
 from calibre import as_unicode, prints
 from calibre.constants import (
-    FAKE_HOST, FAKE_PROTOCOL, __version__, config_dir, in_develop_mode,
-    is_running_from_develop, isosx, iswindows
+    FAKE_HOST, FAKE_PROTOCOL, __version__, in_develop_mode, is_running_from_develop,
+    isosx, iswindows
 )
 from calibre.ebooks.metadata.book.base import field_metadata
 from calibre.ebooks.oeb.polish.utils import guess_type
 from calibre.gui2 import choose_images, error_dialog, safe_open_url
+from calibre.gui2.viewer.config import viewer_config_dir, vprefs
 from calibre.gui2.webengine import (
     Bridge, RestartingWebEngineView, create_script, from_js, insert_scripts,
     secure_webengine, to_js
 )
 from calibre.srv.code import get_translations_data
-from calibre.utils.config import JSONConfig
 from calibre.utils.serialize import json_loads
 from calibre.utils.shared_file import share_open
 from polyglot.builtins import as_bytes, iteritems, unicode_type
@@ -42,18 +42,10 @@ except ImportError:
     import sip
 
 SANDBOX_HOST = FAKE_HOST.rpartition('.')[0] + '.sandbox'
-vprefs = JSONConfig('viewer-webengine')
-viewer_config_dir = os.path.join(config_dir, 'viewer')
-vprefs.defaults['session_data'] = {}
-vprefs.defaults['local_storage'] = {}
-vprefs.defaults['main_window_state'] = None
-vprefs.defaults['main_window_geometry'] = None
-vprefs.defaults['old_prefs_migrated'] = False
-vprefs.defaults['bookmarks_sort'] = 'title'
-
 
 # Override network access to load data from the book {{{
 
+
 def set_book_path(path, pathtoebook):
     set_book_path.pathtoebook = pathtoebook
     set_book_path.path = os.path.abspath(path)
-- 
2.28.0.rc0

