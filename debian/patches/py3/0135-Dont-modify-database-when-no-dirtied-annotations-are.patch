From 44aa8db6b1e886fcc982a0a5fe666802bd254fef Mon Sep 17 00:00:00 2001
From: Kovid Goyal <kovid@kovidgoyal.net>
Date: Fri, 12 Jun 2020 19:36:57 +0530
Subject: [PATCH 135/423] Dont modify database when no dirtied annotations are
 present

---
 src/calibre/db/backend.py        |  11 ++++++-----
 src/calibre/db/tests/metadata.db | Bin 245760 -> 252928 bytes
 src/calibre/db/backend.py |   11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

Index: b/src/calibre/db/backend.py
===================================================================
--- a/src/calibre/db/backend.py
+++ b/src/calibre/db/backend.py
@@ -1795,11 +1795,12 @@ class DB(object):
                 save_annotations_for_book(self.conn.cursor(), book_id, fmt, annots_list, user_type, user)
 
     def dirty_books_with_dirtied_annotations(self):
-        self.execute('''
-            INSERT or IGNORE INTO metadata_dirtied(book) SELECT book FROM annotations_dirtied;
-            DELETE FROM annotations_dirtied;
-        ''')
-        return self.conn.changes() > 0
+        with self.conn:
+            self.execute('INSERT or IGNORE INTO metadata_dirtied(book) SELECT book FROM annotations_dirtied;')
+            changed = self.conn.changes() > 0
+            if changed:
+                self.execute('DELETE FROM annotations_dirtied')
+        return changed
 
     def conversion_options(self, book_id, fmt):
         for (data,) in self.conn.get('SELECT data FROM conversion_options WHERE book=? AND format=?', (book_id, fmt.upper())):
