From d19156d5798a6c431bd9af70366260eb784a9679 Mon Sep 17 00:00:00 2001
From: Kovid Goyal <kovid@kovidgoyal.net>
Date: Mon, 18 Nov 2019 14:30:48 +0530
Subject: [PATCH 007/104] Minor fixups for changes when removing py3
 conditionals

---
 bypy/sources.json        |   10 ----------
 setup/build.py           |    4 ++--
 src/calibre/constants.py |    2 +-
 src/polyglot/builtins.py |   16 ++++++++++++++++
 4 files changed, 19 insertions(+), 13 deletions(-)

--- calibre-debian.git.orig/bypy/sources.json
+++ calibre-debian.git/bypy/sources.json
@@ -770,16 +770,6 @@
     },
 
     {
-        "name": "enum34",
-		"python": "<3",
-        "unix": {
-            "filename": "enum34-1.1.6.tar.gz",
-            "hash": "sha256:8ad8c4783bf61ded74527bffb48ed9b54166685e4230386a9ed9b1279e2df5b1",
-            "urls": ["pypi"]
-        }
-    },
-
-    {
         "name": "sip",
         "unix": {
             "filename": "sip-4.19.19.tar.gz",
--- calibre-debian.git.orig/setup/build.py
+++ calibre-debian.git/setup/build.py
@@ -218,8 +218,8 @@ def init_env():
 class Build(Command):
 
     short_description = 'Build calibre C/C++ extension modules'
-    DEFAULT_OUTPUTDIR = os.path.abspath(os.path.join(SRC, 'calibre', 'plugins', sys.version_info.major))
-    DEFAULT_BUILDDIR = os.path.abspath(os.path.join(os.path.dirname(SRC), 'build', sys.version_info.major))
+    DEFAULT_OUTPUTDIR = os.path.abspath(os.path.join(SRC, 'calibre', 'plugins', str(sys.version_info.major)))
+    DEFAULT_BUILDDIR = os.path.abspath(os.path.join(os.path.dirname(SRC), 'build', str(sys.version_info.major)))
 
     description = textwrap.dedent('''\
         calibre depends on several python extensions written in C/C++.
--- calibre-debian.git.orig/src/calibre/constants.py
+++ calibre-debian.git/src/calibre/constants.py
@@ -150,7 +150,7 @@ def cache_dir():
     return ans
 
 
-plugins_loc = os.path.join(sys.extensions_location, sys.version_info.major)
+plugins_loc = os.path.join(sys.extensions_location, str(sys.version_info.major))
 
 
 # plugins {{{
--- calibre-debian.git.orig/src/polyglot/builtins.py
+++ calibre-debian.git/src/polyglot/builtins.py
@@ -121,3 +121,19 @@ def int_to_byte(x):
 def reload(module):
     import importlib
     return importlib.reload(module)
+
+
+def print_to_binary_file(fileobj, encoding='utf-8'):
+
+    def print(*a, **kw):
+        f = kw.get('file', fileobj)
+        if a:
+            sep = as_bytes(kw.get('sep', ' '), encoding)
+            for x in a:
+                x = as_bytes(x, encoding)
+                f.write(x)
+                if x is not a[-1]:
+                    f.write(sep)
+        f.write(as_bytes(kw.get('end', '\n')))
+
+    return print
