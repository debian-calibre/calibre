<!DOCTYPE html>
<html>
    <head>
        <title>calibre</title>
        <meta charset="utf-8">
        <meta name="robots" content="noindex">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="icon" sizes="256x256" type="image/png" href="favicon.png">
        <link rel="apple-touch-icon" sizes="256x256" href="apple-touch-icon.png">
    </head>
    <body>
        <div id="page_load_progress">
            <progress>
            </progress>
            <div>Loading, please wait&hellip;</div>
            <div>You can also use a simple, non-JavaScript version of this site: <a href="mobile">here</a></div>
            <style type="text/css">
#page_load_progress {
    position:relative;
    top: 50px;
    margin-left: auto; margin-right: auto;
    text-align: center;
}
            </style>
        </div>
<!-- reset styles  {{{ -->
        <style type="text/css">
/*
 * Reset CSS to suppress cross-browser differences
*/

html, body {
    margin:0;
    padding:0;
    border:0;
    outline:0;
    vertical-align:baseline;
    background:transparent;
}

div, span, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
abbr, address, cite, code,
del, dfn, em, img, ins, kbd, q, samp,
small, strong, sub, sup, var,
b, i,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, figcaption, figure,
footer, header, hgroup, menu, nav, section, summary,
time, mark, audio, video {
    margin:0;
    padding:0;
    border:0;
    outline:0;
    font-size:100%;
    vertical-align:baseline;
    background:transparent;
}

body {
    line-height:1.2;
}

article,aside,details,figcaption,figure,
footer,header,hgroup,menu,nav,section {
    display:block;
}

nav ul {
    list-style:none;
}

blockquote, q {
    quotes:none;
}

blockquote:before, blockquote:after,
q:before, q:after {
    content:'';
    content:none;
}

a {
    margin:0;
    padding:0;
    font-size:100%;
    vertical-align:baseline;
    background:transparent;
    text-decoration:none;
    color: currentColor;
}

a:visited {
    color: currentColor;
}

table {
    border-collapse:collapse;
    border-spacing:0;
}

hr {
    display:block;
    height:1px;
    border:0;
    border-top:1px solid currentColor;
    margin:1em 0;
    padding:0;
}

input, select {
    vertical-align:middle;
}

input[type=radio] {
    margin-top: 0; margin-bottom: 0; margin-left: 0; margin-right: 0.25em
}

textarea {
    font-family: inherit;
}

        </style>
<!-- }}} -->

<!-- SVG icon definitions {{{ -->
<svg style="display:none">
  <symbol viewBox="0 0 1792 1792" id="icon-arrow-right">
    <path d="M1600 960q0 54-37 91l-651 651q-39 37-91 37-51 0-90-37l-75-75q-38-38-38-91t38-91l293-293h-704q-52 0-84.5-37.5t-32.5-90.5v-128q0-53 32.5-90.5t84.5-37.5h704l-293-294q-38-36-38-90t38-90l75-75q38-38 90-38 53 0 91 38l651 651q37 35 37 90z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-arrow-left">
    <path d="M1664 896v128q0 53-32.5 90.5t-84.5 37.5h-704l293 294q38 36 38 90t-38 90l-75 76q-37 37-90 37-52 0-91-37l-651-652q-37-37-37-90 0-52 37-91l651-650q38-38 91-38 52 0 90 38l75 74q38 38 38 91t-38 91l-293 293h704q52 0 84.5 37.5t32.5 90.5z"/>
  </symbol>
  <symbol viewBox="0 0 18 18" id="icon-full-screen">
    <path d="M4.5 11H3v4h4v-1.5H4.5V11zM3 7h1.5V4.5H7V3H3v4zm10.5 6.5H11V15h4v-4h-1.5v2.5zM11 3v1.5h2.5V7H15V3h-4z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-bullhorn">
    <path d="M1664 640q53 0 90.5 37.5t37.5 90.5-37.5 90.5-90.5 37.5v384q0 52-38 90t-90 38q-417-347-812-380-58 19-91 66t-31 100.5 40 92.5q-20 33-23 65.5t6 58 33.5 55 48 50 61.5 50.5q-29 58-111.5 83t-168.5 11.5-132-55.5q-7-23-29.5-87.5t-32-94.5-23-89-15-101 3.5-98.5 22-110.5h-122q-66 0-113-47t-47-113v-192q0-66 47-113t113-47h480q435 0 896-384 52 0 90 38t38 90v384zm-128 604v-954q-394 302-768 343v270q377 42 768 341z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-random">
    <path d="M666 481q-60 92-137 273-22-45-37-72.5t-40.5-63.5-51-56.5-63-35-81.5-14.5h-224q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h224q250 0 410 225zm1126 799q0 14-9 23l-320 320q-9 9-23 9-13 0-22.5-9.5t-9.5-22.5v-192q-32 0-85 .5t-81 1-73-1-71-5-64-10.5-63-18.5-58-28.5-59-40-55-53.5-56-69.5q59-93 136-273 22 45 37 72.5t40.5 63.5 51 56.5 63 35 81.5 14.5h256v-192q0-14 9-23t23-9q12 0 24 10l319 319q9 9 9 23zm0-896q0 14-9 23l-320 320q-9 9-23 9-13 0-22.5-9.5t-9.5-22.5v-192h-256q-48 0-87 15t-69 45-51 61.5-45 77.5q-32 62-78 171-29 66-49.5 111t-54 105-64 100-74 83-90 68.5-106.5 42-128 16.5h-224q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h224q48 0 87-15t69-45 51-61.5 45-77.5q32-62 78-171 29-66 49.5-111t54-105 64-100 74-83 90-68.5 106.5-42 128-16.5h256v-192q0-14 9-23t23-9q12 0 24 10l319 319q9 9 9 23z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-italic">
    <path d="M384 1662l17-85q6-2 81.5-21.5t111.5-37.5q28-35 41-101 1-7 62-289t114-543.5 52-296.5v-25q-24-13-54.5-18.5t-69.5-8-58-5.5l19-103q33 2 120 6.5t149.5 7 120.5 2.5q48 0 98.5-2.5t121-7 98.5-6.5q-5 39-19 89-30 10-101.5 28.5t-108.5 33.5q-8 19-14 42.5t-9 40-7.5 45.5-6.5 42q-27 148-87.5 419.5t-77.5 355.5q-2 9-13 58t-20 90-16 83.5-6 57.5l1 18q17 4 185 31-3 44-16 99-11 0-32.5 1.5t-32.5 1.5q-29 0-87-10t-86-10q-138-2-206-2-51 0-143 9t-121 11z"/>
  </symbol>
  <symbol viewBox="0 0 576 512" id="icon-faster">
    <path d="M135.52 412.67a15.99 15.99 0 0 0-7.52 13.57v37.74c0 12.57 13.82 20.23 24.48 13.57l66.69-39.87-47.85-47.85-35.8 22.84zm416.76-195.42l-56.42-34.62c-.06-13.95-2.28-30.77-7.07-48.67-11.32-42.24-31.91-73.43-45.99-69.66-14.08 3.77-16.32 41.08-5 83.32.65 2.44 1.44 4.7 2.15 7.06-4.89-6.08-10.23-12.23-16.31-18.32-30.93-30.92-64.35-47.64-74.66-37.33s6.4 43.73 37.33 74.66c12.67 12.67 25.67 22.77 37.42 29.78-3.14 5.76-5.71 12.06-6.89 19.32-.49 3.03-.71 6.15-.75 9.31C364.55 195.11 261.59 128 192 128c-52.08 0-85.21 28.24-104.72 54.09-1.77-2.7-2.96-5.66-5.33-8.03-18.75-18.75-49.14-18.75-67.88 0-18.74 18.74-18.74 49.14 0 67.88 16.4 16.39 41.29 17.57 59.92 5.29l191.4 191.4c6 6 14.14 9.37 22.63 9.37h144c8.84 0 16-7.16 16-16v-16c0-17.67-14.33-32-32-32h-96v-55.59c0-35.53-23.86-67.16-58.02-76.91l-42.38-12.11c-8.5-2.44-13.42-11.3-11-19.78 2.44-8.52 11.41-13.33 19.78-11l42.38 12.11C318.59 234.38 352 278.66 352 328.41V352l64-32h103.35c31.29 0 56.65-25.36 56.65-56.65a56.66 56.66 0 0 0-23.72-46.1zM496 256c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-underline">
    <path d="M176 223q-37-2-45-4l-3-88q13-1 40-1 60 0 112 4 132 7 166 7 86 0 168-3 116-4 146-5 56 0 86-2l-1 14 2 64v9q-60 9-124 9-60 0-79 25-13 14-13 132 0 13 .5 32.5t.5 25.5l1 229 14 280q6 124 51 202 35 59 96 92 88 47 177 47 104 0 191-28 56-18 99-51 48-36 65-64 36-56 53-114 21-73 21-229 0-79-3.5-128t-11-122.5-13.5-159.5l-4-59q-5-67-24-88-34-35-77-34l-100 2-14-3 2-86h84l205 10q76 3 196-10l18 2q6 38 6 51 0 7-4 31-45 12-84 13-73 11-79 17-15 15-15 41 0 7 1.5 27t1.5 31q8 19 22 396 6 195-15 304-15 76-41 122-38 65-112 123-75 57-182 89-109 33-255 33-167 0-284-46-119-47-179-122-61-76-83-195-16-80-16-237v-333q0-188-17-213-25-36-147-39zm1488 1409v-64q0-14-9-23t-23-9h-1472q-14 0-23 9t-9 23v64q0 14 9 23t23 9h1472q14 0 23-9t9-23z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-superscript">
    <path d="M1025 1369v167h-248l-159-252-24-42q-8-9-11-21h-3l-9 21q-10 20-25 44l-155 250h-258v-167h128l197-291-185-272h-137v-168h276l139 228q2 4 23 42 8 9 11 21h3q3-9 11-21l25-42 140-228h257v168h-125l-184 267 204 296h109zm637-679v206h-514l-3-27q-4-28-4-46 0-64 26-117t65-86.5 84-65 84-54.5 65-54 26-64q0-38-29.5-62.5t-70.5-24.5q-51 0-97 39-14 11-36 38l-105-92q26-37 63-66 83-65 188-65 110 0 178 59.5t68 158.5q0 56-24.5 103t-62 76.5-81.5 58.5-82 50.5-65.5 51.5-30.5 63h232v-80h126z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-cloud-download">
    <path d="m 1200.8136,983.39599 q 0,-13.7735 -8.4661,-22.62789 -8.4661,-8.85439 -21.6356,-8.85439 l -210.7119,0 0,-346.30508 q 0,-12.78968 -8.93644,-22.13598 -8.93644,-9.3463 -21.16526,-9.3463 l -180.61017,0 q -12.22881,0 -21.16525,9.3463 -8.93644,9.3463 -8.93644,22.13598 l 0,346.30508 -210.71187,0 q -12.22881,0 -21.16525,9.3463 -8.93644,9.3463 -8.93644,22.13598 0,13.7735 8.4661,22.62791 l 331.11864,346.3051 q 8.46611,8.8544 21.6356,8.8544 13.16949,0 21.63559,-8.8544 l 330.17799,-345.3213 q 9.4068,-11.80585 9.4068,-23.61171 z m 602.0339,220.37601 q 0,156.4276 -105.8263,267.1074 -105.8262,110.6799 -255.394,110.6799 l -1023.45771,0 q -174.02542,0 -297.72457,-129.3725 -123.6991573,-129.3725 -123.6991573,-311.3794 0,-127.8968 65.8474573,-236.11711 65.84746,-108.22034 176.84746,-162.33051 -1.88136,-29.51464 -1.88136,-42.30431 0,-208.57011 141.10169,-356.1433 141.1017,-147.57319 340.52543,-147.57319 146.74576,0 268.56356,85.59245 121.8178,85.59245 177.3178,227.26271 66.7882,-60.99692 156.1526,-60.99692 99.7118,0 170.2627,73.7866 70.5508,73.78659 70.5508,178.07165 0,74.77041 -38.5678,135.76733 122.2882,30.49846 200.8348,133.30778 78.5466,102.80932 78.5466,234.64142 z"/>
  </symbol>
  <symbol viewBox="0 0 25.4 16.933" id="icon-selection-handle-vertical">
    <path style="stroke-width:1.2" d="M 0.40531915,0.22517714 C 0.57570388,5.3511725 1.2577531,11.548814 5.6244322,14.821275 9.1147504,16.85191 12.195909,12.670186 13.111224,9.6410928 c 1.028474,-2.9493579 1.716378,-6.4799769 1.424227,-9.41591566 -4.7100448,0 -9.4200882,0 -14.13013185,0 z m 14.49602685,0.00368 c 3.49955,0 6.999102,0 10.498654,0 -3.499552,0 -6.999104,0 -10.498654,0 z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-ol"><g transform="translate(0,-924.36216)">
    <g>
      <g>
        <path d="m 28.258393,1037.5797 q 0,5.4724 -3.728101,8.619 -3.728102,3.1466 -9.26888,3.1466 -7.2509858,0 -11.7656771,-4.5147 l 3.899039,-6.0196 q 3.3518541,3.0782 7.2509851,3.0782 1.983707,0 3.454417,-0.9919 1.47071,-0.9919 1.47071,-2.9072 0,-4.3779 -7.182518,-3.8307 l -1.77849,-3.8307 q 0.547185,-0.6841 2.223112,-2.9756 1.675927,-2.2916 2.907232,-3.6939 1.231304,-1.4023 2.530984,-2.6336 l 0,-0.068 q -1.094462,0 -3.317667,0.068 -2.223112,0.068 -3.317666,0.068 l 0,3.6254 -7.2508934,0 0,-10.3976 22.7788594,0 0,6.0197 -6.498491,7.8665 q 3.488696,0.8209 5.540871,3.3519 2.052174,2.531 2.052174,6.0197 z"/>
        <path d="m 28.395143,994.68968 0,10.87642 -24.7626581,0 q -0.4104349,-2.4626 -0.4104349,-3.6939 0,-3.48869 1.607552,-6.36165 1.6075521,-2.87304 3.8648515,-4.65153 2.2573915,-1.77858 4.5147835,-3.24929 2.257392,-1.47071 3.864852,-2.97561 1.607552,-1.50489 1.607552,-3.07826 0,-1.71011 -0.9919,-2.63355 -0.991807,-0.92352 -2.702014,-0.92352 -3.146637,0 -5.5407787,3.96751 l -5.8144634,-4.03589 q 1.6417395,-3.48869 4.8910311,-5.43821 3.249199,-1.94952 7.216706,-1.94952 4.993593,0 8.413822,2.83876 3.420229,2.83886 3.420229,7.69561 0,3.42023 -2.325766,6.25909 -2.325767,2.83876 -5.130344,4.41213 -2.804669,1.57327 -5.164624,3.45441 -2.359954,1.88115 -2.428329,3.59126 l 8.687415,0 0,-4.10426 7.182518,0 z"/>
        <path d="m 28.463611,955.01471 0,6.77209 -22.9157941,0 0,-6.77209 7.3193601,0 q 0,-2.80457 0.03419,-8.34545 0.03419,-5.54077 0.03419,-8.27698 l 0,-0.82087 -0.136842,0 q -0.547277,1.16284 -3.4202291,3.69392 l -4.8567512,-5.19881 9.3030673,-8.68751 7.250893,0 0,27.6357 7.387828,0 z"/>
      </g>
      <g>
        <path d="m 124.77795,1016.5109 0,13.1337 q 0,0.8893 -0.64984,1.5392 -0.64984,0.6499 -1.53908,0.6499 l -83.180612,0 q -0.889337,0 -1.539177,-0.6499 -0.64984,-0.6499 -0.64984,-1.5392 l 0,-13.1337 q 0,-0.9577 0.615652,-1.5734 0.615653,-0.6156 1.573365,-0.6156 l 83.180612,0 q 0.88924,0 1.53908,0.6498 0.64984,0.6499 0.64984,1.5392 z"/>
        <path d="m 124.77795,981.48749 0,13.13382 q 0,0.88924 -0.64984,1.53908 -0.64984,0.64984 -1.53908,0.64984 l -83.180612,0 q -0.889337,0 -1.539177,-0.64984 -0.64984,-0.64984 -0.64984,-1.53908 l 0,-13.13382 q 0,-0.95772 0.615652,-1.57337 0.615653,-0.61556 1.573365,-0.61556 l 83.180612,0 q 0.88924,0 1.53908,0.64984 0.64984,0.64984 0.64984,1.53909 z"/>
        <path d="m 124.77795,946.46405 0,13.13382 q 0,0.88925 -0.64984,1.53909 -0.64984,0.64984 -1.53908,0.64984 l -83.180612,0 q -0.889337,0 -1.539177,-0.64984 -0.64984,-0.64984 -0.64984,-1.53909 l 0,-13.13382 q 0,-0.88925 0.64984,-1.53909 0.64984,-0.64984 1.539177,-0.64984 l 83.180612,0 q 0.88924,0 1.53908,0.64984 0.64984,0.64984 0.64984,1.53909 z"/>
      </g>
    </g>
  </g>
</symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-refresh">
    <path d="M1639 1056q0 5-1 7-64 268-268 434.5t-478 166.5q-146 0-282.5-55t-243.5-157l-129 129q-19 19-45 19t-45-19-19-45v-448q0-26 19-45t45-19h448q26 0 45 19t19 45-19 45l-137 137q71 66 161 102t187 36q134 0 250-65t186-179q11-17 53-117 8-23 30-23h192q13 0 22.5 9.5t9.5 22.5zm25-800v448q0 26-19 45t-45 19h-448q-26 0-45-19t-19-45 19-45l138-138q-148-137-349-137-134 0-250 65t-186 179q-11 17-53 117-8 23-30 23h-199q-13 0-22.5-9.5t-9.5-22.5v-7q65-268 270-434.5t480-166.5q146 0 284 55.5t245 156.5l130-129q19-19 45-19t45 19 19 45z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-caret-left">
    <path d="M1216 448v896q0 26-19 45t-45 19-45-19l-448-448q-19-19-19-45t19-45l448-448q19-19 45-19t45 19 19 45z"/>
  </symbol>
  <symbol viewBox="0 0 512 512" id="icon-window-restore">
    <path d="M464 0H144c-26.5 0-48 21.5-48 48v48H48c-26.5 0-48 21.5-48 48v320c0 26.5 21.5 48 48 48h320c26.5 0 48-21.5 48-48v-48h48c26.5 0 48-21.5 48-48V48c0-26.5-21.5-48-48-48zm-96 464H48V256h320v208zm96-96h-48V144c0-26.5-21.5-48-48-48H144V48h320v320z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-chevron-right">
    <path d="M1363 877l-742 742q-19 19-45 19t-45-19l-166-166q-19-19-19-45t19-45l531-531-531-531q-19-19-19-45t19-45l166-166q19-19 45-19t45 19l742 742q19 19 19 45t-19 45z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-ellipsis-v">
    <path d="M1088 1248v192q0 40-28 68t-68 28h-192q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h192q40 0 68 28t28 68zm0-512v192q0 40-28 68t-68 28h-192q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h192q40 0 68 28t28 68zm0-512v192q0 40-28 68t-68 28h-192q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h192q40 0 68 28t28 68z"/>
  </symbol>
  <symbol viewBox="0 -200 1000 1000" id="icon-star-half">
    <g>
      <path d="M 466.134,74.71 320.554,-51.818 c -45.752,-39.7363 -70.796,-61.0836 -75.128,-64.0476 -4.334,-2.962 -8.58,-4.444 -12.738,-4.444 -4.853,0 -9.273,2.004 -13.259,6.013 -3.987,4.008 -5.98,8.453 -5.98,13.332 0,3.1369 9.88,29.6271 29.638,79.4718 l 79.028,201.816 -169.497,109.275 c -47.835,30.673 -73.3963,47.578 -76.6883,50.715 -3.294,3.137 -4.9404,7.668 -4.9404,13.594 0,15.336 8.8398,23.005 26.5166,23.005 1.3867,0 25.6491,-2.092 72.7901,-6.274 l 209.529,-17.776 47.315,202.339 c 12.131,52.633 19.671,81.563 22.617,86.791 2.945,5.229 8.405,7.842 16.377,7.842 8.32,0 0,-575.124 0,-575.124 z" transform="matrix(1,0,0,-1,72.033898,564.7623)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 544 512" id="icon-highlight">
    <path d="M0 479.98L99.92 512l35.45-35.45-67.04-67.04L0 479.98zm124.61-240.01a36.592 36.592 0 0 0-10.79 38.1l13.05 42.83-50.93 50.94 96.23 96.23 50.86-50.86 42.74 13.08c13.73 4.2 28.65-.01 38.15-10.78l35.55-41.64-173.34-173.34-41.52 35.44zm403.31-160.7l-63.2-63.2c-20.49-20.49-53.38-21.52-75.12-2.35L190.55 183.68l169.77 169.78L530.27 154.4c19.18-21.74 18.15-54.63-2.35-75.13z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-toc">
    <path d="M 47.913909,73.44346 M 6.3604493,57.45533 H 44.252305 a 5.358445,5.3634115 0 0 0 0,-10.72682 H 6.3604493 a 5.358445,5.3634115 0 1 0 0,10.72682 z m 0,-21.36425 H 46.854978 a 5.3584485,5.363415 0 0 0 0,-10.72683 H 6.3604493 a 5.3584485,5.363415 0 1 0 0,10.72683 z m 0,-21.36426 H 64.193373 A 5.358445,5.3634115 0 0 0 64.193373,4 H 6.3604493 a 5.358445,5.3634115 0 1 0 0,10.72682 z M 127.002,100.60534 v 23.3947 H 61.169679 L 27.283898,95.43344 a 4.7843252,4.7887596 0 0 1 2.360267,-8.4027 v 0 a 22.964761,22.986046 0 0 1 16.496354,3.7672 l 12.885783,8.939 1.518225,-65.61244 a 8.7393675,8.7474677 0 1 1 17.478735,0 l 2.309235,38.46337 28.157343,5.51667 a 22.964761,22.986046 0 0 1 18.51216,22.5008 z"/>
  </symbol>
  <symbol viewBox="0 0 100 100" id="icon-global-search">
    <path d="m64.094 61.452-4.403-4.403c4.448-5.099 7.153-11.754 7.153-19.024 0-15.973-13.027-29-29-29s-29 13.027-29 29 13.027 29 29 29c7.268 0 13.919-2.703 19.018-7.147l4.403 4.403zm-4.799-24.422h-8.295v-0.195c-0.09-3.781-0.683-7.312-1.656-10.403 1.975-0.458 3.778-1.039 5.366-1.724 2.703 3.423 4.376 7.682 4.585 12.322zm-20.95-20.481c3.348 0.298 6.363 3.531 8.328 8.386-2.599 0.454-5.421 0.705-8.328 0.731zm-2 9.096c-2.542-0.069-5.002-0.307-7.287-0.703 1.764-4.361 4.364-7.436 7.287-8.231zm0 1.999v9.387h-9.643c0.09-3.688 0.688-7.169 1.661-10.18 2.501 0.454 5.2 0.719 7.982 0.793zm0 11.386v9.847c-2.723 0.071-5.362 0.329-7.815 0.767-1.064-3.106-1.727-6.743-1.827-10.613h9.642zm0 11.846v8.416c-2.813-0.766-5.33-3.641-7.088-7.745 2.23-0.376 4.618-0.604 7.088-0.671zm2-0.022c2.819 0.025 5.555 0.265 8.086 0.693-1.964 4.584-4.873 7.638-8.086 7.928zm0-2v-9.824h10.641c-0.101 3.869-0.763 7.506-1.826 10.612-2.755-0.49-5.744-0.76-8.815-0.788zm0-11.824v-9.364c3.146-0.028 6.212-0.307 9.023-0.821 0.952 2.962 1.544 6.374 1.631 10.014v0.172h-10.654zm10.33-12.497c-1.13-2.892-2.619-5.299-4.354-7.03 3.465 1.097 6.542 3.057 9.002 5.615-1.394 0.557-2.953 1.032-4.648 1.415zm-21.606 0.012c-1.714-0.385-3.297-0.861-4.708-1.424 2.482-2.582 5.591-4.558 9.092-5.65-1.744 1.739-3.243 4.166-4.384 7.074zm-0.671 1.896c-1.002 3.15-1.607 6.752-1.695 10.589h-8.31c0.209-4.642 1.883-8.9 4.587-12.324 1.603 0.69 3.424 1.274 5.418 1.735zm-10.002 12.589h8.308c0.098 4.013 0.76 7.768 1.851 11.016-1.932 0.438-3.705 0.989-5.277 1.643-2.874-3.473-4.653-7.866-4.882-12.659zm10.863 12.906c1.115 2.697 2.546 4.952 4.193 6.596-3.336-1.041-6.322-2.876-8.744-5.28 1.371-0.523 2.911-0.957 4.551-1.316zm21.17 0c1.642 0.36 3.175 0.798 4.545 1.32-2.42 2.401-5.406 4.235-8.739 5.275 1.648-1.643 3.079-3.898 4.194-6.595zm0.706-1.891c1.09-3.248 1.752-7.002 1.85-11.015h8.307c-0.229 4.793-2.008 9.187-4.882 12.658-1.571-0.652-3.344-1.206-5.275-1.643zm40.562 32.401-20.47-20.47-7.071 7.071 20.471 20.471c1.944 1.944 5.127 1.944 7.071 0v-1e-3c1.944-1.945 1.944-5.126-1e-3 -7.071z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-check">
    <path d="M1671 566q0 40-28 68l-724 724-136 136q-28 28-68 28t-68-28l-136-136-362-362q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 295 656-657q28-28 68-28t68 28l136 136q28 28 28 68z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-bookmark">
    <path d="M1420 128q23 0 44 9 33 13 52.5 41t19.5 62v1289q0 34-19.5 62t-52.5 41q-19 8-44 8-48 0-83-32l-441-424-441 424q-36 33-83 33-23 0-44-9-33-13-52.5-41t-19.5-62v-1289q0-34 19.5-62t52.5-41q21-9 44-9h1048z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-indent"><g transform="translate(0,-924.36216)">
    <g>
      <path d="m 127,1022.1122 0,13.5 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -121.5,0 q -0.91406,0 -1.58203,-0.668 Q 1,1036.5263 1,1035.6122 l 0,-13.5 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 121.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
      <path d="m 1,961.59431 0,53.35729 q 0,1.2042 0.85111,2.0841 0.85111,0.8801 2.01577,0.8801 1.25426,0 2.06057,-0.8337 l 25.801956,-26.67863 q 0.806308,-0.8337 0.806308,-2.13061 0,-1.2969 -0.806308,-2.13059 L 5.92745,959.46371 q -0.80631,-0.83369 -2.06057,-0.83369 -1.16466,0 -2.01577,0.88007 Q 1,960.39002 1,961.59431 Z"/>
      <g>
        <path d="m 127,995.11216 0,13.50004 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -76.5,0 q -0.91406,0 -1.58203,-0.668 Q 46,1009.5263 46,1008.6122 l 0,-13.50004 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 76.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
        <path d="m 127,968.11216 0,13.5 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -76.5,0 q -0.91406,0 -1.58203,-0.668 Q 46,982.52626 46,981.61216 l 0,-13.5 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 76.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
      </g>
      <path d="m 127,941.11216 0,13.5 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -121.5,0 q -0.91406,0 -1.58203,-0.668 Q 1,955.52626 1,954.61216 l 0,-13.5 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 121.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
    </g>
  </g>
</symbol>
  <symbol viewBox="0 0 128 128" id="icon-help">
    <g>
      <path d="M64,1C29.3,1,1,29.3,1,64s28.3,63,63,63s63-28.3,63-63S98.7,1,64,1z M64,7c11.8,0,22.8,3.6,32,9.8L78.8,34 c-4.5-2.2-9.5-3.5-14.8-3.5S53.7,31.8,49.2,34L32,16.8C41.2,10.6,52.2,7,64,7z M91.5,64c0,15.2-12.3,27.5-27.5,27.5 S36.5,79.2,36.5,64S48.8,36.5,64,36.5S91.5,48.8,91.5,64z M16.8,96C10.6,86.8,7,75.8,7,64c0-12.4,4-23.9,10.7-33.2l17,17 C32,52.6,30.5,58.1,30.5,64c0,5.3,1.3,10.3,3.5,14.8L16.8,96z M64,121c-12.4,0-23.9-4-33.2-10.7l17-17c4.8,2.7,10.3,4.2,16.2,4.2 c5.9,0,11.4-1.5,16.2-4.2l17,17C87.9,117,76.4,121,64,121z M121,64c0,11.8-3.6,22.8-9.8,32L94,78.8c2.2-4.5,3.5-9.5,3.5-14.8 c0-5.9-1.5-11.4-4.2-16.2l17-17C117,40.1,121,51.6,121,64z"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-heart">
    <path d="M896 1664q-26 0-44-18l-624-602q-10-8-27.5-26t-55.5-65.5-68-97.5-53.5-121-23.5-138q0-220 127-344t351-124q62 0 126.5 21.5t120 58 95.5 68.5 76 68q36-36 76-68t95.5-68.5 120-58 126.5-21.5q224 0 351 124t127 344q0 221-229 450l-623 600q-18 18-44 18z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-pencil">
    <path d="M491 1536l91-91-235-235-91 91v107h128v128h107zm523-928q0-22-22-22-10 0-17 7l-542 542q-7 7-7 17 0 22 22 22 10 0 17-7l542-542q7-7 7-17zm-54-192l416 416-832 832h-416v-416zm683 96q0 53-37 90l-166 166-416-416 166-165q36-38 90-38 53 0 91 38l235 234q37 39 37 91z"/>
  </symbol>
  <symbol viewBox="-60.562 -37.846 1024 1024" id="icon-edit">
    <path d="m806.438 431.154v127.581 156.435c0 8.63-.271 17.213-1.394 25.791.583-4.343 1.166-8.685 1.75-13.026-1.87 13.351-5.415 26.329-10.607 38.771 1.646-3.901 3.293-7.804 4.939-11.705-5.179 12.113-11.816 23.464-19.821 33.926 2.554-3.306 5.107-6.611 7.661-9.917-8.04 10.323-17.271 19.566-27.585 27.62 3.306-2.555 6.611-5.108 9.917-7.662-10.448 8.017-21.789 14.665-33.895 19.854 3.901-1.646 7.804-3.293 11.705-4.939-12.434 5.2-25.405 8.753-38.752 10.626 4.342-.583 8.684-1.167 13.026-1.75-12.931 1.696-25.906 1.396-38.907 1.396-19.803 0-39.604 0-59.407 0-61.676 0-123.352 0-185.027 0-58.113 0-116.226 0-174.338 0-13.604 0-27.208 0-40.811 0-10.794 0-21.479.014-32.232-1.396 4.342.583 8.684 1.167 13.026 1.75-13.354-1.874-26.333-5.427-38.775-10.626 3.901 1.646 7.803 3.293 11.705 4.939-12.117-5.188-23.47-11.837-33.933-19.854 3.306 2.554 6.611 5.107 9.917 7.662-10.327-8.053-19.572-17.296-27.626-27.62 2.554 3.306 5.108 6.611 7.662 9.917-8.019-10.46-14.669-21.811-19.859-33.926 1.646 3.901 3.293 7.804 4.939 11.705-5.202-12.44-8.756-25.419-10.63-38.771.583 4.342 1.167 8.684 1.75 13.026-1.697-12.932-1.397-25.907-1.397-38.91 0-19.803 0-39.604 0-59.407 0-61.676 0-123.352 0-185.028 0-58.113 0-116.226 0-174.338 0-13.604 0-27.208 0-40.811 0-10.793-.014-21.478 1.397-32.229-.583 4.342-1.167 8.684-1.75 13.026 1.874-13.348 5.428-26.321 10.63-38.756-1.646 3.901-3.293 7.803-4.939 11.705 5.19-12.108 11.841-23.451 19.859-33.901-2.554 3.306-5.108 6.611-7.662 9.917 8.055-10.316 17.301-19.549 27.626-27.592-3.306 2.554-6.611 5.108-9.917 7.662 10.464-8.008 21.817-14.647 33.933-19.829-3.902 1.646-7.804 3.293-11.705 4.94 12.443-5.193 25.423-8.741 38.775-10.611-4.342.583-8.684 1.167-13.026 1.75 16.377-2.145 33.179-1.395 49.665-1.395h83.863 166.029 10.221c26.711 0 49-22.289 49-49s-22.289-49-49-49c-42.522 0-85.045 0-127.568 0-52.14 0-104.279 0-156.419 0-39.237 0-77.96 9.312-111.443 30.275-46.488 29.107-81.955 77.982-91.591 132.386-3.306 18.664-3.979 36.638-3.979 55.334v57.667 183.773 176.053c0 42.896-3.145 87.646 13.778 128.115 5.766 13.789 11.669 26.971 20.159 39.304 8.252 11.987 17.511 23.577 28.04 33.667 21.655 20.752 46.856 35.272 74.857 45.563 23.74 8.725 49.284 10.863 74.408 10.863h131.396 194.938 139.71c20.572 0 40.767-1.041 61.053-5.574 53.641-11.986 101.442-49.214 128.427-96.735 18.595-32.746 26.234-69.183 26.234-106.545 0-21.306 0-42.611 0-63.917 0-61.141 0-122.281 0-183.422 0-11.603 0-23.205 0-34.807 0-26.711-22.289-49-49-49s-49 22.289-49 49z"/>
    <path d="m845.887 197.439-356.304 356.304-114.833 7.019 5.129-116.722 356.305-356.304c12.619-12.62 32.813-12.882 45.105-.588l65.185 65.185c12.289 12.3 12.033 32.486-.587 45.106z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-warning">
    <path d="M1024 1375v-190q0-14-9.5-23.5t-22.5-9.5h-192q-13 0-22.5 9.5t-9.5 23.5v190q0 14 9.5 23.5t22.5 9.5h192q13 0 22.5-9.5t9.5-23.5zm-2-374l18-459q0-12-10-19-13-11-24-11h-220q-11 0-24 11-10 7-10 21l17 457q0 10 10 16.5t24 6.5h185q14 0 23.5-6.5t10.5-16.5zm-14-934l768 1408q35 63-2 126-17 29-46.5 46t-63.5 17h-1536q-34 0-63.5-17t-46.5-46q-37-63-2-126l768-1408q17-31 47-49t65-18 65 18 47 49z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-justify-center">
    <g>
      <path d="m 127,1024.3622 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,1035.1903 1,1033.3622 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m -27,-27.00004 0,9.00004 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -63,0 q -1.82812,0 -3.16406,-1.3359 Q 28,1008.1903 28,1006.3622 l 0,-9.00004 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 63,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 18,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -99,0 q -1.82812,0 -3.16406,-1.3359 Q 10,981.19026 10,979.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 99,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m -27,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -45,0 q -1.82812,0 -3.16406,-1.3359 Q 37,954.19026 37,952.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 45,0 q 1.82813,0 3.16406,1.3359 Q 91,941.53406 91,943.36216 Z" transform="translate(0,-924.36216)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-copy">
    <path d="M1696 384q40 0 68 28t28 68v1216q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-288h-544q-40 0-68-28t-28-68v-672q0-40 20-88t48-76l408-408q28-28 76-48t88-20h416q40 0 68 28t28 68v328q68-40 128-40h416zm-544 213l-299 299h299v-299zm-640-384l-299 299h299v-299zm196 647l316-316v-416h-384v416q0 40-28 68t-68 28h-416v640h512v-256q0-40 20-88t48-76zm956 804v-1152h-384v416q0 40-28 68t-68 28h-416v640h896z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-play">
    <path d="M1576 927l-1328 738q-23 13-39.5 3t-16.5-36v-1472q0-26 16.5-36t39.5 3l1328 738q23 13 23 31t-23 31z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-print">
    <path d="M448 1536h896v-256h-896v256zm0-640h896v-384h-160q-40 0-68-28t-28-68v-160h-640v640zm1152 64q0-26-19-45t-45-19-45 19-19 45 19 45 45 19 45-19 19-45zm128 0v416q0 13-9.5 22.5t-22.5 9.5h-224v160q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-160h-224q-13 0-22.5-9.5t-9.5-22.5v-416q0-79 56.5-135.5t135.5-56.5h64v-544q0-40 28-68t68-28h672q40 0 88 20t76 48l152 152q28 28 48 76t20 88v256h64q79 0 135.5 56.5t56.5 135.5z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-outdent"><g transform="translate(0,-924.36216)">
    <g>
      <path d="m 127,1022.1122 0,13.5 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -121.5,0 q -0.91406,0 -1.58203,-0.668 Q 1,1036.5263 1,1035.6122 l 0,-13.5 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 121.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
      <path d="m 127,961.59431 0,53.35729 q 0,1.2042 -0.85111,2.0841 -0.85111,0.8801 -2.01577,0.8801 -1.25426,0 -2.06057,-0.8337 L 96.270594,990.40347 q -0.806308,-0.8337 -0.806308,-2.13061 0,-1.2969 0.806308,-2.13059 l 25.801956,-26.67856 q 0.80631,-0.83369 2.06057,-0.83369 1.16466,0 2.01577,0.88007 Q 127,960.39002 127,961.59431 Z"/>
      <g transform="translate(-45,0)">
        <path d="m 127,995.11216 0,13.50004 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -76.5,0 q -0.91406,0 -1.58203,-0.668 Q 46,1009.5263 46,1008.6122 l 0,-13.50004 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 76.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
        <path d="m 127,968.11216 0,13.5 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -76.5,0 q -0.91406,0 -1.58203,-0.668 Q 46,982.52626 46,981.61216 l 0,-13.5 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 76.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
      </g>
      <path d="m 127,941.11216 0,13.5 q 0,0.9141 -0.66797,1.582 -0.66797,0.668 -1.58203,0.668 l -121.5,0 q -0.91406,0 -1.58203,-0.668 Q 1,955.52626 1,954.61216 l 0,-13.5 q 0,-0.9141 0.66797,-1.582 0.66797,-0.668 1.58203,-0.668 l 121.5,0 q 0.91406,0 1.58203,0.668 0.66797,0.6679 0.66797,1.582 z"/>
    </g>
  </g>
</symbol>
  <symbol viewBox="0 0 128 128" id="icon-bg">
    <g>
      <g transform="translate(0,-924.36216) translate(0.00260059,0.00376367)">
        <path d="m 40.013479,999.06915 c 6.359757,4.67475 20.124993,-3.15171 30.748644,-17.46631 l 33.295197,33.61766 c -10.626597,14.3161 -20.771572,17.651 -27.134275,12.9792"/>
        <ellipse cx="-616.16" cy="-748.862" rx="14.29" ry="32.282" transform="matrix(-0.8058623,-0.592103,0.59573364,-0.80318206,0,0)"/>
        <path d="m 85.46409,977.45432 c 3.178405,-2.48472 6.266967,-5.64375 9.022665,-9.36276 0.785028,-1.05546 1.517033,-2.1285 2.198962,-3.20448 7.602843,-12.04097 8.679493,-24.85155 2.075243,-29.70811 -5.9886,-4.40066 -16.413416,-0.87222 -25.244612,7.869"/>
        <path d="m 31.182284,992.23215 56.121393,44.06525 c 5.727905,4.2086 18.116023,-2.8366 27.674813,-15.719 9.55141,-12.8912 12.66501,-26.74548 6.94153,-30.94971 L 69.644231,940.36975"/>
        <path d="m 64.359653,971.28577 c -12.75928,-0.0748 -27.904574,4.3303 -33.175896,7.31929 -5.26985,2.98899 -12.095026,8.47882 -15.822804,14.98012 -3.729251,6.50422 -5.051868,17.33732 -0.29457,24.86472 0,0 6.227201,9.4258 7.65439,19.0671 0.768827,3.1928 -1.322617,7.4981 5.275741,8.7647 6.596886,1.2695 4.73226,-12.8912 4.73226,-12.8912 0,0 -0.631851,-3.8085 -1.543544,-7.9101 -1.624551,-9.263 4.813266,-29.4706 4.813266,-29.4706 0,0 1.857261,-2.08159 6.938586,-4.3347 2.947169,-1.27241 8.386396,-5.52794 8.386396,-5.52794 l 5.857515,-5.61883 4.755826,-5.76395 c -0.0044,0 1.281377,-1.66674 2.422834,-3.47861 z"/>
        <path d="m 24.801907,980.76288 c 0,0 -21.867371,-2.08306 -20.6728915,6.1231 1.1959525,8.20616 7.2611395,3.59148 10.3364455,-1.19032 3.073834,-4.78326 10.336446,-4.93278 10.336446,-4.93278 z"/>
        <path d="m 15.670251,989.86324 c 0,0 -19.2648493,10.50616 -13.6415164,16.62636 5.6233329,6.1187 8.0343844,-1.0877 7.87679,-6.76666 -0.1575947,-5.676 5.7647264,-9.8597 5.7647264,-9.8597 z"/>
      </g>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-subscript">
    <path d="M1025 1369v167h-248l-159-252-24-42q-8-9-11-21h-3l-9 21q-10 20-25 44l-155 250h-258v-167h128l197-291-185-272h-137v-168h276l139 228q2 4 23 42 8 9 11 21h3q3-9 11-21l25-42 140-228h257v168h-125l-184 267 204 296h109zm639 217v206h-514l-4-27q-3-45-3-46 0-64 26-117t65-86.5 84-65 84-54.5 65-54 26-64q0-38-29.5-62.5t-70.5-24.5q-51 0-97 39-14 11-36 38l-105-92q26-37 63-66 80-65 188-65 110 0 178 59.5t68 158.5q0 66-34.5 118.5t-84 86-99.5 62.5-87 63-41 73h232v-80h126z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-image">
    <path d="M576 576q0 80-56 136t-136 56-136-56-56-136 56-136 136-56 136 56 56 136zm1024 384v448h-1408v-192l320-320 160 160 512-512zm96-704h-1600q-13 0-22.5 9.5t-9.5 22.5v1216q0 13 9.5 22.5t22.5 9.5h1600q13 0 22.5-9.5t9.5-22.5v-1216q0-13-9.5-22.5t-22.5-9.5zm160 32v1216q0 66-47 113t-113 47h-1600q-66 0-113-47t-47-113v-1216q0-66 47-113t113-47h1600q66 0 113 47t47 113z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-justify-left">
    <g>
      <path d="m 127,1024.3622 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,1035.1903 1,1033.3622 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m -27,-27.00004 0,9.00004 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -90,0 q -1.82812,0 -3.16406,-1.3359 Q 1,1008.1903 1,1006.3622 l 0,-9.00004 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 90,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 18,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -108,0 q -1.82812,0 -3.16406,-1.3359 Q 1,981.19026 1,979.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 108,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m -27,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -81,0 q -1.82812,0 -3.16406,-1.3359 Q 1,954.19026 1,952.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 81,0 q 1.82813,0 3.16406,1.3359 Q 91,941.53406 91,943.36216 Z" transform="translate(0,-924.36216)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-sort-amount-asc">
    <path d="M736 1440q0 12-10 24l-319 319q-10 9-23 9-12 0-23-9l-320-320q-15-16-7-35 8-20 30-20h192v-1376q0-14 9-23t23-9h192q14 0 23 9t9 23v1376h192q14 0 23 9t9 23zm1056 128v192q0 14-9 23t-23 9h-832q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h832q14 0 23 9t9 23zm-192-512v192q0 14-9 23t-23 9h-640q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h640q14 0 23 9t9 23zm-192-512v192q0 14-9 23t-23 9h-448q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h448q14 0 23 9t9 23zm-192-512v192q0 14-9 23t-23 9h-256q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h256q14 0 23 9t9 23z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-hr">
    <g>
      <path d="m 127,990.98716 v -5.25 q 0,-1.1484 -0.73828,-1.8867 -0.73828,-0.7383 -1.88672,-0.7383 H 3.6250002 q -1.14844,0 -1.88672,0.7383 -0.7382799,0.7383 -0.7382799,1.8867 v 5.25 q 0,1.1484 0.7382799,1.8867 0.73828,0.7383 1.88672,0.7383 H 124.375 q 1.14844,0 1.88672,-0.7383 Q 127,992.13556 127,990.98716 Z" transform="translate(0,-924.36216)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-heading">
    <g>
      <path d="m 123.37397,1043.8196 q -3.32374,0 -10.00899,-0.2527 -6.68525,-0.2528 -10.08453,-0.2528 -3.323751,0 -9.971231,0.2528 -6.64748,0.2527 -9.97122,0.2527 -1.81295,0 -2.79496,-1.4803 -0.98202,-1.4803 -0.98202,-3.2856 0,-2.2385 1.28417,-3.3216 1.28418,-1.0832 2.94605,-1.2276 1.66187,-0.1445 3.85251,-0.5055 2.19065,-0.3611 3.39929,-1.0832 2.4928,-1.5164 2.4928,-10.1094 l -0.0755,-28.23417 q 0,-1.51638 -0.0755,-2.23849 -0.98201,-0.28888 -3.77698,-0.28888 h -50.9892 q -2.87051,0 -3.85252,0.28888 -0.0755,0.72211 -0.0755,2.23849 l -0.0755,26.78997 q 0,10.2539 2.79496,11.8425 1.20864,0.7221 3.6259,0.9387 2.41727,0.2166 4.30576,0.2528 1.88849,0.036 3.39928,1.0831 1.51079,1.0471 1.51079,3.2856 0,1.8775 -0.94425,3.466 -0.94424,1.5887 -2.75719,1.5887 -3.55036,0 -10.53777,-0.2527 -6.98741,-0.2528 -10.46223,-0.2528 -3.2482,0 -9.66907,0.2528 -6.4208594,0.2527 -9.5935194,0.2527 -1.73741,0 -2.68165,-1.5164 -0.94425,-1.5165 -0.94425,-3.2495 0,-2.1663 1.17086,-3.2494 1.17087,-1.0832 2.71943,-1.2637 1.54856,-0.1806 3.5881294,-0.5416 2.03957,-0.3611 3.17266,-1.0832 2.49281,-1.6608 2.49281,-10.326 l -0.0755,-4.116 v -58.70691 q 0,-0.21662 0.0378,-1.87744 0.0378,-1.66083 0,-2.63568 -0.0378,-0.97485 -0.11331,-2.78012 -0.0755,-1.80517 -0.26439,-3.03277 -0.18885,-1.2276 -0.49101,-2.63568 -0.30216,-1.40807 -0.83093,-2.27462 -0.52878,-0.86655 -1.20864,-1.29977 -1.13309,-0.72211 -3.3992793,-0.86655 -2.2661901,-0.14444 -4.0036001,-0.14444 -1.7374099,0 -3.0971199,-1.01089 -1.3597101,-1.01099 -1.3597101,-3.24948 0,-1.87744 0.9064701,-3.46609 0.90648,-1.58865 2.71943,-1.58865 3.47482,0 10.4622293,0.25274 6.98741,0.25275 10.46223,0.25275 3.17266,0 9.55576,-0.25275 6.38309,-0.25274 9.55575,-0.25274 1.88849,0 2.83273,1.58865 0.94425,1.58865 0.94425,3.46609 0,2.16632 -1.28417,3.14117 -1.28418,0.97476 -2.90828,1.04703 -1.6241,0.0717 -3.73921,0.28878 -2.1151,0.21671 -3.2482,0.93882 -2.64388,1.51638 -2.64388,11.5536 l 0.0755,23.1073 q 0,1.51639 0.0755,2.31067 0.98201,0.21661 2.94604,0.21661 h 52.80216 q 1.88849,0 2.8705,-0.21661 0.0755,-0.79428 0.0755,-2.31067 l 0.0755,-23.1073 q 0,-10.03722 -2.64388,-11.5536 -1.35972,-0.79438 -4.41907,-0.90268 -3.05935,-0.10831 -4.98561,-0.93872 -1.92626,-0.83041 -1.92626,-3.5744 0,-1.87744 0.94425,-3.46609 0.94424,-1.58865 2.83273,-1.58865 3.32374,0 9.97122,0.25274 6.64748,0.25275 9.971231,0.25275 3.2482,0 9.7446,-0.25275 6.4964,-0.25274 9.7446,-0.25274 1.88849,0 2.83274,1.58865 0.94424,1.58865 0.94424,3.46609 0,2.16632 -1.32194,3.17721 -1.32194,1.01099 -3.02158,1.04712 -1.69964,0.0363 -3.89029,0.21661 -2.19065,0.18048 -3.32374,0.90259 -2.64389,1.66082 -2.64389,11.62587 l 0.0755,68.09425 q 0,8.593 2.56835,10.1093 1.20863,0.7222 3.47482,0.9749 2.26619,0.2527 4.04137,0.325 1.77518,0.072 3.13489,1.1192 1.35971,1.047 1.35971,3.2134 0,1.8775 -0.90647,3.466 -0.90648,1.5887 -2.71943,1.5887 z" transform="translate(0,-924.36216)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-link">
    <path d="M1520 1216q0-40-28-68l-208-208q-28-28-68-28-42 0-72 32 3 3 19 18.5t21.5 21.5 15 19 13 25.5 3.5 27.5q0 40-28 68t-68 28q-15 0-27.5-3.5t-25.5-13-19-15-21.5-21.5-18.5-19q-33 31-33 73 0 40 28 68l206 207q27 27 68 27 40 0 68-26l147-146q28-28 28-67zm-703-705q0-40-28-68l-206-207q-28-28-68-28-39 0-68 27l-147 146q-28 28-28 67 0 40 28 68l208 208q27 27 68 27 42 0 72-31-3-3-19-18.5t-21.5-21.5-15-19-13-25.5-3.5-27.5q0-40 28-68t68-28q15 0 27.5 3.5t25.5 13 19 15 21.5 21.5 18.5 19q33-31 33-73zm895 705q0 120-85 203l-147 146q-83 83-203 83-121 0-204-85l-206-207q-83-83-83-203 0-123 88-209l-88-88q-86 88-208 88-120 0-204-84l-208-208q-84-84-84-204t85-203l147-146q83-83 203-83 121 0 204 85l206 207q83 83 83 203 0 123-88 209l88 88q86-88 208-88 120 0 204 84l208 208q84 84 84 204z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-plus">
    <path d="M1600 736v192q0 40-28 68t-68 28h-416v416q0 40-28 68t-68 28h-192q-40 0-68-28t-28-68v-416h-416q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h416v-416q0-40 28-68t68-28h192q40 0 68 28t28 68v416h416q40 0 68 28t28 68z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-eraser">
    <path d="M832 1408l336-384h-768l-336 384h768zm1013-1077q15 34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38 0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38 0 69.5 20.5t47.5 54.5z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-remove">
    <path d="M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-caret-down">
    <path d="M1408 704q0 26-19 45l-448 448q-19 19-45 19t-45-19l-448-448q-19-19-19-45t19-45 45-19h896q26 0 45 19t19 45z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-home">
    <path d="M1472 992v480q0 26-19 45t-45 19h-384v-384h-256v384h-384q-26 0-45-19t-19-45v-480q0-1 .5-3t.5-3l575-474 575 474q1 2 1 6zm223-69l-62 74q-8 9-21 11h-3q-13 0-21-7l-692-577-692 577q-12 8-24 7-13-2-21-11l-62-74q-8-10-7-23.5t11-21.5l719-599q32-26 76-26t76 26l244 204v-195q0-14 9-23t23-9h192q14 0 23 9t9 23v408l219 182q10 8 11 21.5t-7 23.5z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-bug">
    <path d="M1696 960q0 26-19 45t-45 19h-224q0 171-67 290l208 209q19 19 19 45t-19 45q-18 19-45 19t-45-19l-198-197q-5 5-15 13t-42 28.5-65 36.5-82 29-97 13v-896h-128v896q-51 0-101.5-13.5t-87-33-66-39-43.5-32.5l-15-14-183 207q-20 21-48 21-24 0-43-16-19-18-20.5-44.5t15.5-46.5l202-227q-58-114-58-274h-224q-26 0-45-19t-19-45 19-45 45-19h224v-294l-173-173q-19-19-19-45t19-45 45-19 45 19l173 173h844l173-173q19-19 45-19t45 19 19 45-19 45l-173 173v294h224q26 0 45 19t19 45zm-480-576h-640q0-133 93.5-226.5t226.5-93.5 226.5 93.5 93.5 226.5z"/>
  </symbol>
  <symbol viewBox="0 0 24 24" id="icon-fit-to-screen">
    <path fill="none" d="M0 0h24v24H0z"/>
    <path d="M17 4h3c1.1 0 2 .9 2 2v2h-2V6h-3V4zM4 8V6h3V4H4c-1.1 0-2 .9-2 2v2h2zm16 8v2h-3v2h3c1.1 0 2-.9 2-2v-2h-2zM7 18H4v-2H2v2c0 1.1.9 2 2 2h3v-2zM18 8H6v8h12V8z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-fg">
    <g>
      <g transform="translate(0,-924.36216)">
        <rect width="48.159" height="33.711" x="-634.401" y="732.136" transform="matrix(0.70710678,-0.70710678,0.70710678,0.70710678,0,0)"/>
        <polygon points="19.092 13.435 18.385 12.728 13.435 7.778 12.727 7.071 10.605 9.192 16.971 15.557" transform="matrix(4.8159417,0,0,4.8159417,0.99999969,932.22665)"/>
        <path d="m 72.511918,1030.9824 c 7.098698,-7.0987 8.23526,-14.183 6.713423,-20.54 l -31.73224,-31.71783 c -5.663548,-0.83798 -12.155437,0.89095 -19.254135,7.98964 -17.024354,17.02439 3.404871,44.26819 -27.23896631,47.67299 30.64383731,17.0292 57.88761931,10.2194 71.51191831,-3.4048 z"/>
      </g>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-external-link">
    <path d="M1408 928v-480q0-26-19-45t-45-19h-480q-42 0-59 39-17 41 14 70l144 144-534 534q-19 19-19 45t19 45l102 102q19 19 45 19t45-19l534-534 144 144q18 19 45 19 12 0 25-5 39-17 39-59zm256-512v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/>
  </symbol>
  <symbol viewBox="0 0 576 512" id="icon-slower">
    <path d="M68.25 256h279.51c23.54 0 40.97-19.8 35.1-40.04C362.84 146.97 292.33 64 208.41 64h-.82c-83.91 0-154.43 82.97-174.44 151.96C27.27 236.2 44.71 256 68.25 256zm484.03-118.75l-48.65-34.75c-35.17-17.42-80.49 1.57-86.81 40.31-.54 3.32-.82 6.72-.82 10.19v71.22c-.03 13.88-4.6 27.18-13.27 38.44-12.42 16.11-31.25 25.34-51.68 25.34H18.6C8.33 288 0 296.33 0 306.6c0 8 5.12 15.11 12.71 17.64l98.29 22.1L66.17 424c-6.16 10.67 1.54 24 13.86 24h36.95c5.71 0 11-3.05 13.86-8l40.3-69.8c25.99 8.52 45.55 13.8 84.87 13.8s58.89-5.28 84.87-13.8l40.3 69.8c2.86 4.95 8.14 8 13.86 8h36.95c12.32 0 20.01-13.33 13.86-24l-47.21-81.76c21.25-8.42 40.36-21.78 54.81-40.53 14.08-18.28 22.47-39.4 25.29-61.7h40.62c31.29 0 56.65-25.36 56.65-56.65a56.7 56.7 0 0 0-23.73-46.11zM480 176c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16z"/>
  </symbol>
  <symbol viewBox="0 0 48 48" id="icon-undo">
    <g>
      <g>
        <path d="m 227,330 c 0,-0.945 0,-6 0,-6 l 11,9.5 -11,9.5 v -6 c -10,0 -14,9 -14,9 0,-8 6,-16 14,-16 z" transform="matrix(3.7795276,0,0,3.7795276,-2.5999995e-7,-1074.0897) matrix(-0.508,0,0,0.508,120.904,120.35622)"/>
      </g>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-strikethrough">
    <path d="M1760 896q14 0 23 9t9 23v64q0 14-9 23t-23 9h-1728q-14 0-23-9t-9-23v-64q0-14 9-23t23-9h1728zm-1277-64q-28-35-51-80-48-97-48-188 0-181 134-309 133-127 393-127 50 0 167 19 66 12 177 48 10 38 21 118 14 123 14 183 0 18-5 45l-12 3-84-6-14-2q-50-149-103-205-88-91-210-91-114 0-182 59-67 58-67 146 0 73 66 140t279 129q69 20 173 66 58 28 95 52h-743zm507 256h411q7 39 7 92 0 111-41 212-23 55-71 104-37 35-109 81-80 48-153 66-80 21-203 21-114 0-195-23l-140-40q-57-16-72-28-8-8-8-22v-13q0-108-2-156-1-30 0-68l2-37v-44l102-2q15 34 30 71t22.5 56 12.5 27q35 57 80 94 43 36 105 57 59 22 132 22 64 0 139-27 77-26 122-86 47-61 47-129 0-84-81-157-34-29-137-71z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-search">
    <path d="M1216 832q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 52-38 90t-90 38q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-pause">
    <path d="M1664 192v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45zm-896 0v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-bold">
    <path d="M747 1521q74 32 140 32 376 0 376-335 0-114-41-180-27-44-61.5-74t-67.5-46.5-80.5-25-84-10.5-94.5-2q-73 0-101 10 0 53-.5 159t-.5 158q0 8-1 67.5t-.5 96.5 4.5 83.5 12 66.5zm-14-746q42 7 109 7 82 0 143-13t110-44.5 74.5-89.5 25.5-142q0-70-29-122.5t-79-82-108-43.5-124-14q-50 0-130 13 0 50 4 151t4 152q0 27-.5 80t-.5 79q0 46 1 69zm-541 889l2-94q15-4 85-16t106-27q7-12 12.5-27t8.5-33.5 5.5-32.5 3-37.5.5-34v-65.5q0-982-22-1025-4-8-22-14.5t-44.5-11-49.5-7-48.5-4.5-30.5-3l-4-83q98-2 340-11.5t373-9.5q23 0 68.5.5t67.5.5q70 0 136.5 13t128.5 42 108 71 74 104.5 28 137.5q0 52-16.5 95.5t-39 72-64.5 57.5-73 45-84 40q154 35 256.5 134t102.5 248q0 100-35 179.5t-93.5 130.5-138 85.5-163.5 48.5-176 14q-44 0-132-3t-132-3q-106 0-307 11t-231 12z"/>
  </symbol>
  <symbol viewBox="0 0 16.933 16.933" id="icon-convert">
    <g>
      <path d="m 16.183572,290.33818 q 0,0.0517 -0.01032,0.0723 -0.661458,2.76987 -2.76987,4.4907 -2.108385,1.72082 -4.9402735,1.72082 -1.508945,0 -2.919703,-0.56843 -1.410759,-0.56846 -2.516638,-1.62264 l -1.333261,1.33324 q -0.196374,0.19637 -0.465085,0.19637 -0.268711,0 -0.465085,-0.19637 -0.196372,-0.19635 -0.196372,-0.46506 v -4.63021 q 0,-0.26871 0.196373,-0.46508 0.196374,-0.19637 0.465085,-0.19637 h 4.630208 q 0.268711,0 0.465085,0.19637 0.196374,0.19637 0.196374,0.46508 0,0.26872 -0.196374,0.46509 l -1.415944,1.41594 q 0.733822,0.68213 1.663991,1.05421 0.930169,0.37206 1.932701,0.37206 1.384935,0 2.5838155,-0.67181 1.198906,-0.67177 1.922356,-1.84999 0.113692,-0.17571 0.547794,-1.20925 0.08268,-0.2377 0.310038,-0.2377 h 1.984375 q 0.134356,0 0.232543,0.0982 0.09819,0.0982 0.09819,0.23255 z m 0.258392,-8.26823 v 4.6302 q 0,0.26872 -0.196374,0.46509 -0.196374,0.19637 -0.465085,0.19637 h -4.630208 q -0.268711,0 -0.465084,-0.19637 -0.196375,-0.19637 -0.196375,-0.46509 0,-0.2687 0.196375,-0.46507 l 1.426262,-1.42626 q -1.529609,-1.41595 -3.6070115,-1.41595 -1.384934,0 -2.583814,0.67181 -1.198907,0.67177 -1.922384,1.85002 -0.113665,0.17568 -0.547766,1.20921 -0.08268,0.2377 -0.310039,0.2377 h -2.056739 q -0.134355,0 -0.232542,-0.0982 -0.09819,-0.0982 -0.09819,-0.23255 v -0.0723 q 0.671804,-2.76986 2.790534,-4.4907 2.11873,-1.72082 4.960937,-1.72082 1.5089455,0 2.9352085,0.57362 1.426289,0.57359 2.532168,1.61748 l 1.343581,-1.33327 q 0.196374,-0.19637 0.465084,-0.19637 0.268711,0 0.465085,0.19637 0.196374,0.19638 0.196374,0.46509 z" transform="translate(0,-280.06667)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 17 17" id="icon-library">
    <path d="M1.7866,6.5 L15.9196,6.5 C16.8236,6.5 17.1906,5.336 16.4496,4.818 L11.5146,1.363 C9.9166,0.244 7.7896,0.244 6.1916,1.363 L1.2566,4.818 C0.5156,5.336 0.8826,6.5 1.7866,6.5"/>
    <polygon points="1.853 12.5 3.853 12.5 3.853 7.5 1.853 7.5"/>
    <polygon points="4.853 12.5 6.853 12.5 6.853 7.5 4.853 7.5"/>
    <polygon points="7.853 12.5 9.853 12.5 9.853 7.5 7.853 7.5"/>
    <polygon points="10.853 12.5 12.853 12.5 12.853 7.5 10.853 7.5"/>
    <polygon points="13.853 12.5 15.853 12.5 15.853 7.5 13.853 7.5"/>
    <polygon points=".853 16.5 16.853 16.5 16.853 15.5 .853 15.5"/>
    <polygon points="1.853 14.5 15.853 14.5 15.853 13.5 1.853 13.5"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-cog">
    <path d="M1152 896q0-106-75-181t-181-75-181 75-75 181 75 181 181 75 181-75 75-181zm512-109v222q0 12-8 23t-20 13l-185 28q-19 54-39 91 35 50 107 138 10 12 10 25t-9 23q-27 37-99 108t-94 71q-12 0-26-9l-138-108q-44 23-91 38-16 136-29 186-7 28-36 28h-222q-14 0-24.5-8.5t-11.5-21.5l-28-184q-49-16-90-37l-141 107q-10 9-25 9-14 0-25-11-126-114-165-168-7-10-7-23 0-12 8-23 15-21 51-66.5t54-70.5q-27-50-41-99l-183-27q-13-2-21-12.5t-8-23.5v-222q0-12 8-23t19-13l186-28q14-46 39-92-40-57-107-138-10-12-10-24 0-10 9-23 26-36 98.5-107.5t94.5-71.5q13 0 26 10l138 107q44-23 91-38 16-136 29-186 7-28 36-28h222q14 0 24.5 8.5t11.5 21.5l28 184q49 16 90 37l142-107q9-9 24-9 13 0 25 10 129 119 165 170 7 8 7 22 0 12-8 23-15 21-51 66.5t-54 70.5q26 50 41 98l183 28q13 2 21 12.5t8 23.5z"/>
  </symbol>
  <symbol viewBox="0 0 512 512" id="icon-reference-mode">
    <path d="M512 199.652c0 23.625-20.65 43.826-44.8 43.826h-99.851c16.34 17.048 18.346 49.766-6.299 70.944 14.288 22.829 2.147 53.017-16.45 62.315C353.574 425.878 322.654 448 272 448c-2.746 0-13.276-.203-16-.195-61.971.168-76.894-31.065-123.731-38.315C120.596 407.683 112 397.599 112 385.786V214.261l.002-.001c.011-18.366 10.607-35.889 28.464-43.845 28.886-12.994 95.413-49.038 107.534-77.323 7.797-18.194 21.384-29.084 40-29.092 34.222-.014 57.752 35.098 44.119 66.908-3.583 8.359-8.312 16.67-14.153 24.918H467.2c23.45 0 44.8 20.543 44.8 43.826zM96 200v192c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V200c0-13.255 10.745-24 24-24h48c13.255 0 24 10.745 24 24zM68 368c0-11.046-8.954-20-20-20s-20 8.954-20 20 8.954 20 20 20 20-8.954 20-20z"/>
  </symbol>
  <symbol viewBox="-50 0 1300 1200" id="icon-off">
    <path fill="currentColor" d="M513.94 0v693.97h172.12V0H513.94zM175.708 175.708C67.129 284.287 0 434.314 0 600c0 331.371 268.629 600 600 600s600-268.629 600-600c0-165.686-67.13-315.713-175.708-424.292l-120.85 120.85c77.66 77.658 125.684 184.952 125.684 303.442c0 236.981-192.146 429.126-429.126 429.126c-236.981 0-429.126-192.145-429.126-429.126c0-118.49 48.025-225.784 125.684-303.442l-120.85-120.85z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-justify-right">
    <g>
      <path d="m 127,1024.3622 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,1035.1903 1,1033.3622 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 0,-27.00004 0,9.00004 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -90,0 q -1.82812,0 -3.16406,-1.3359 Q 28,1008.1903 28,1006.3622 l 0,-9.00004 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 90,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 0,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -108,0 q -1.82812,0 -3.16406,-1.3359 Q 10,981.19026 10,979.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 108,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 0,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -81,0 q -1.82812,0 -3.16406,-1.3359 Q 37,954.19026 37,952.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 81,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z" transform="translate(0,-924.36216)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-caret-right">
    <path d="M1152 896q0 26-19 45l-448 448q-19 19-45 19t-45-19-19-45v-896q0-26 19-45t45-19 45 19l448 448q19 19 19 45z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-justify-full">
    <g>
      <path d="m 127,1024.3622 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,1035.1903 1,1033.3622 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 0,-27.00004 0,9.00004 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,1008.1903 1,1006.3622 l 0,-9.00004 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 0,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,981.19026 1,979.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z m 0,-27 0,9 q 0,1.8281 -1.33594,3.1641 -1.33593,1.3359 -3.16406,1.3359 l -117,0 q -1.82812,0 -3.16406,-1.3359 Q 1,954.19026 1,952.36216 l 0,-9 q 0,-1.8281 1.33594,-3.1641 1.33594,-1.3359 3.16406,-1.3359 l 117,0 q 1.82813,0 3.16406,1.3359 1.33594,1.336 1.33594,3.1641 z" transform="translate(0,-924.36216)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-hourglass">
    <path d="M1536 128q0 261-106.5 461.5t-266.5 306.5q160 106 266.5 306.5t106.5 461.5h96q14 0 23 9t9 23v64q0 14-9 23t-23 9h-1472q-14 0-23-9t-9-23v-64q0-14 9-23t23-9h96q0-261 106.5-461.5t266.5-306.5q-160-106-266.5-306.5t-106.5-461.5h-96q-14 0-23-9t-9-23v-64q0-14 9-23t23-9h1472q14 0 23 9t9 23v64q0 14-9 23t-23 9h-96zm-128 0h-1024q0 206 85 384h854q85-178 85-384zm-57 1216q-54-141-145.5-241.5t-194.5-142.5h-230q-103 42-194.5 142.5t-145.5 241.5h910z"/>
  </symbol>
  <symbol viewBox="0 -200 1000 1000" id="icon-star">
    <g>
      <path d="m 551.923,352.862 197.574,16.73 c 55.457,4.531 83.882,6.797 85.268,6.797 17.33,0 25.996,-7.493 25.996,-22.482 0,-5.926 -1.733,-10.544 -5.199,-13.855 -3.467,-3.312 -29.984,-20.827 -79.55,-52.546 L 609.635,180.323 716.22,-88.417 c 1.386,-2.7881 2.081,-6.9707 2.081,-12.548 0,-5.228 -1.907,-9.76 -5.721,-13.593 -3.811,-3.835 -7.972,-5.752 -12.476,-5.752 -4.161,0 -8.494,1.482 -13.001,4.444 -4.505,2.964 -28.941,23.615 -73.308,61.9578 L 466.134,74.7098 320.554,-51.8182 c -45.752,-39.7363 -70.796,-61.0836 -75.128,-64.0476 -4.334,-2.962 -8.58,-4.444 -12.738,-4.444 -4.853,0 -9.273,2.004 -13.259,6.013 -3.987,4.008 -5.98,8.453 -5.98,13.332 0,3.1369 9.88,29.6271 29.638,79.4718 l 79.028,201.816 -169.497,109.275 c -47.835,30.673 -73.3963,47.578 -76.6883,50.715 -3.294,3.137 -4.9404,7.668 -4.9404,13.594 0,15.336 8.8398,23.005 26.5166,23.005 1.3867,0 25.6491,-2.092 72.7901,-6.274 l 209.529,-17.776 47.315,202.339 c 12.131,52.633 19.671,81.563 22.617,86.791 2.945,5.229 8.405,7.842 16.377,7.842 8.32,0 13.866,-2.874 16.638,-8.626 2.773,-5.751 10.746,-37.035 23.917,-93.851 z" transform="matrix(1,0,0,-1,34.12485,564.762)"/>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-book">
    <path d="M1703 478q40 57 18 129l-275 906q-19 64-76.5 107.5t-122.5 43.5h-923q-77 0-148.5-53.5t-99.5-131.5q-24-67-2-127 0-4 3-27t4-37q1-8-3-21.5t-3-19.5q2-11 8-21t16.5-23.5 16.5-23.5q23-38 45-91.5t30-91.5q3-10 .5-30t-.5-28q3-11 17-28t17-23q21-36 42-92t25-90q1-9-2.5-32t.5-28q4-13 22-30.5t22-22.5q19-26 42.5-84.5t27.5-96.5q1-8-3-25.5t-2-26.5q2-8 9-18t18-23 17-21q8-12 16.5-30.5t15-35 16-36 19.5-32 26.5-23.5 36-11.5 47.5 5.5l-1 3q38-9 51-9h761q74 0 114 56t18 130l-274 906q-36 119-71.5 153.5t-128.5 34.5h-869q-27 0-38 15-11 16-1 43 24 70 144 70h923q29 0 56-15.5t35-41.5l300-987q7-22 5-57 38 15 59 43zm-1064 2q-4 13 2 22.5t20 9.5h608q13 0 25.5-9.5t16.5-22.5l21-64q4-13-2-22.5t-20-9.5h-608q-13 0-25.5 9.5t-16.5 22.5zm-83 256q-4 13 2 22.5t20 9.5h608q13 0 25.5-9.5t16.5-22.5l21-64q4-13-2-22.5t-20-9.5h-608q-13 0-25.5 9.5t-16.5 22.5z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-chevron-left">
    <path d="m 1395,364.99998 -531,531 L 1395,1427 q 19,19 19,45 0,26 -19,45 l -166,166 q -19,19 -45,19 -26,0 -45,-19 L 397,940.99998 q -19,-19 -19,-45 0,-26 19,-45 l 742,-742 q 19,-18.999999 45,-18.999999 26,0 45,18.999999 l 166,166 q 19,19 19,45 0,26 -19,45 z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-fts">
    <g id="layer1" transform="translate(6.2816136,0.20846979)">
      <g id="text189">
        <path id="path293" d="M 1.336354,0.37399976 H 59.45371 Q 55.982346,4.9651589 54.470623,7.596677 53.01489,10.228195 50.71931,16.051129 l -0.447918,1.119795 Q 46.576069,9.5563181 42.936735,7.3167283 39.353392,5.0771384 30.78696,5.0771384 l -3.191415,0.05599 -5.431005,-0.05599 -2.071621,-0.05599 V 31.22435 h 3.415374 V 8.1005847 l 1.623703,-0.05599 q 3.471364,-0.1679693 7.390647,-0.1679693 11.421908,0 14.277385,5.9349133 -2.743498,-2.631518 -5.990903,-3.527354 -3.191416,-0.9518259 -9.910185,-0.9518259 -2.407559,0 -5.990903,0.2799487 V 31.22435 h 8.454452 l 8.958359,-9.462267 V 45.221786 L 32.914571,35.927488 H 20.092919 V 64.14632 l 7.166687,7.278667 H -0.23135887 L 8.8949697,64.14632 V 40.07073 q -4.3112104,0 -7.5586157,3.247405 L 0.27254884,42.14235 Q 3.5199541,38.559007 8.8949697,38.559007 v -2.631519 q -1.1757846,-0.111979 -1.6796924,-0.111979 -5.2070463,0 -9.0143491,4.255221 L -2.191,39.174894 Q 0.32853859,31.896227 8.8949697,31.22435 V 7.596677 Z M 63.708931,3.7893743 Q 55.702397,13.139662 53.630777,20.922237 L 52.454992,20.13838 Q 54.582602,11.34799 62.701116,2.8375486 Z M 46.4081,23.721724 v 24.18757 L 44.952366,47.069448 V 22.881878 Z M 36.385935,40.630627 H 24.908037 v 23.963611 l 9.854195,12.205765 H 2.3441694 L 0.94442579,75.28828 H 31.626807 L 23.508293,65.266115 V 39.118904 h 11.253939 z"/>
      </g>
      <g id="text301">
        <path id="path296" d="m 114.10015,50.782996 q -0.50391,0.951826 -0.67188,1.287764 l -3.8073,6.71877 q -1.95964,3.583344 -3.63934,8.958359 l -0.11198,0.279949 -0.55989,-0.391928 -0.16797,-0.727867 q -1.62371,-6.382831 -4.64715,-8.84638 -2.967459,-2.463549 -9.126331,-2.463549 -2.519539,0 -5.039077,0.223959 h -0.671877 v 60.692887 l 6.60679,6.10288 H 66.676831 l 7.838564,-6.5508 V 60.357243 l -3.975272,-0.05599 q -5.766943,0 -8.230492,2.29558 -2.407559,2.23959 -2.855477,7.950544 H 57.99842 q 0.615888,-6.550801 3.359385,-9.126329 2.799487,-2.575528 9.182318,-2.575528 l 3.359385,0.05599 h 0.615887 v -2.743498 q -2.855477,-0.335939 -5.431005,-0.335939 -7.222677,0 -10.414093,2.967457 -3.191415,2.911467 -3.527354,9.910185 H 54.471066 Q 52.063507,60.91714 47.02443,51.342894 l -0.335938,-0.559898 z m 3.52735,3.527354 q -3.86329,4.927098 -8.11851,16.349006 l -0.22396,0.559898 -1.23178,-1.063806 0.16797,-0.503907 q 4.14324,-11.589878 8.00654,-16.125047 l 0.27994,-0.335939 z m -14.94926,8.734401 q -4.311213,-2.799488 -10.078157,-2.799488 -1.287764,0 -2.687507,0.16797 l 0.223959,56.269697 8.902369,10.52607 h -28.61076 l -1.287764,-1.51172 h 26.819088 l -7.502626,-8.56643 V 58.78953 l 3.023446,-0.05599 q 5.431006,0 7.670596,0.895836 2.295576,0.839846 3.527356,3.415375 z"/>
      </g>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-chevron-down">
    <path d="M1683 808l-742 741q-19 19-45 19t-45-19l-742-741q-19-19-19-45.5t19-45.5l166-165q19-19 45-19t45 19l531 531 531-531q19-19 45-19t45 19l166 165q19 19 19 45.5t-19 45.5z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-select-all"><g transform="translate(0,-924.36216)">
    <path d="m 117,1018.6479 v 7.5714 q 0,1.5379 -1.12388,2.6618 -1.12389,1.1239 -2.66183,1.1239 H 14.785714 q -1.537946,0 -2.66183,-1.1239 Q 11,1027.7572 11,1026.2193 v -7.5714 q 0,-1.538 1.123884,-2.6619 1.123884,-1.1239 2.66183,-1.1239 h 98.428576 q 1.53794,0 2.66183,1.1239 Q 117,1017.1099 117,1018.6479 Z M 94.285714,995.93357 v 7.57143 q 0,1.5379 -1.123884,2.6618 -1.123884,1.1239 -2.66183,1.1239 h -53 q -1.537946,0 -2.66183,-1.1239 -1.123884,-1.1239 -1.123884,-2.6618 v -7.57143 q 0,-1.53795 1.123884,-2.66183 1.123884,-1.12388 2.66183,-1.12388 h 53 q 1.537946,0 2.66183,1.12388 1.123884,1.12388 1.123884,2.66183 z m 15.142856,-22.71428 v 7.57142 q 0,1.53795 -1.12388,2.66183 -1.12389,1.12388 -2.66183,1.12388 H 22.357143 q -1.537947,0 -2.661831,-1.12388 -1.123883,-1.12388 -1.123883,-2.66183 v -7.57142 q 0,-1.53796 1.123883,-2.66184 1.123884,-1.12388 2.661831,-1.12388 h 83.285717 q 1.53794,0 2.66183,1.12388 1.12388,1.12388 1.12388,2.66184 z m -22.714284,-22.7143 v 7.57143 q 0,1.53795 -1.123884,2.66183 -1.123884,1.12389 -2.661831,1.12389 H 45.071429 q -1.537947,0 -2.661831,-1.12389 -1.123884,-1.12388 -1.123884,-2.66183 v -7.57143 q 0,-1.53794 1.123884,-2.66183 1.123884,-1.12387 2.661831,-1.12387 h 37.857142 q 1.537947,0 2.661831,1.12387 1.123884,1.12389 1.123884,2.66183 z"/>
    <path d="M 2.970371,927.33253 H 125.02963 V 1049.3918 H 2.970371 Z" style="fill:none;fill-opacity:1;fill-rule:evenodd;stroke:#30a82d;stroke-width:3.94074321;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:3.94074312, 11.82222935;stroke-dashoffset:0;stroke-opacity:1"/>
  </g>
</symbol>
  <symbol viewBox="0 0 48 48" id="icon-redo">
    <g>
      <g>
        <path d="m 227,330 c 0,-0.945 0,-6 0,-6 l 11,9.5 -11,9.5 v -6 c -10,0 -14,9 -14,9 0,-8 6,-16 14,-16 z" transform="matrix(-3.7795276,0,0,3.7795276,48,-1074.0897) matrix(-0.508,0,0,0.508,120.904,120.35622)"/>
      </g>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-auto-scroll">
    <path d="M1395 864q0 13-10 23l-466 466q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l50-50q10-10 23-10t23 10l393 393 393-393q10-10 23-10t23 10l50 50q10 10 10 23zm0-384q0 13-10 23l-466 466q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l50-50q10-10 23-10t23 10l393 393 393-393q10-10 23-10t23 10l50 50q10 10 10 23z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-arrows-h">
    <path d="M1792 896q0 26-19 45l-256 256q-19 19-45 19t-45-19-19-45v-128h-1024v128q0 26-19 45t-45 19-45-19l-256-256q-19-19-19-45t19-45l256-256q19-19 45-19t45 19 19 45v128h1024v-128q0-26 19-45t45-19 45 19l256 256q19 19 19 45z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-trash">
    <path d="M704 1376v-704q0-14-9-23t-23-9h-64q-14 0-23 9t-9 23v704q0 14 9 23t23 9h64q14 0 23-9t9-23zm256 0v-704q0-14-9-23t-23-9h-64q-14 0-23 9t-9 23v704q0 14 9 23t23 9h64q14 0 23-9t9-23zm256 0v-704q0-14-9-23t-23-9h-64q-14 0-23 9t-9 23v704q0 14 9 23t23 9h64q14 0 23-9t9-23zm-544-992h448l-48-117q-7-9-17-11h-317q-10 2-17 11zm928 32v64q0 14-9 23t-23 9h-96v948q0 83-47 143.5t-113 60.5h-832q-66 0-113-58.5t-47-141.5v-952h-96q-14 0-23-9t-9-23v-64q0-14 9-23t23-9h309l70-167q15-37 54-63t79-26h320q40 0 79 26t54 63l70 167h309q14 0 23 9t9 23z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-ul">
    <g>
      <g transform="translate(0,-924.36216)">
        <path d="m 124.77795,1016.5109 0,13.1337 q 0,0.8893 -0.64984,1.5392 -0.64984,0.6499 -1.53908,0.6499 l -83.180612,0 q -0.889337,0 -1.539177,-0.6499 -0.64984,-0.6499 -0.64984,-1.5392 l 0,-13.1337 q 0,-0.9577 0.615652,-1.5734 0.615653,-0.6156 1.573365,-0.6156 l 83.180612,0 q 0.88924,0 1.53908,0.6498 0.64984,0.6499 0.64984,1.5392 z"/>
        <path d="m 124.77795,981.48749 0,13.13382 q 0,0.88924 -0.64984,1.53908 -0.64984,0.64984 -1.53908,0.64984 l -83.180612,0 q -0.889337,0 -1.539177,-0.64984 -0.64984,-0.64984 -0.64984,-1.53908 l 0,-13.13382 q 0,-0.95772 0.615652,-1.57337 0.615653,-0.61556 1.573365,-0.61556 l 83.180612,0 q 0.88924,0 1.53908,0.64984 0.64984,0.64984 0.64984,1.53909 z"/>
        <path d="m 124.77795,946.46405 0,13.13382 q 0,0.88925 -0.64984,1.53909 -0.64984,0.64984 -1.53908,0.64984 l -83.180612,0 q -0.889337,0 -1.539177,-0.64984 -0.64984,-0.64984 -0.64984,-1.53909 l 0,-13.13382 q 0,-0.88925 0.64984,-1.53909 0.64984,-0.64984 1.539177,-0.64984 l 83.180612,0 q 0.88924,0 1.53908,0.64984 0.64984,0.64984 0.64984,1.53909 z"/>
        <path d="m 124.77795,946.46405 0,13.13382 q 0,0.88925 -0.64984,1.53909 -0.64984,0.64984 -1.53908,0.64984 l -83.180612,0 q -0.889337,0 -1.539177,-0.64984 -0.64984,-0.64984 -0.64984,-1.53909 l 0,-13.13382 q 0,-0.88925 0.64984,-1.53909 0.64984,-0.64984 1.539177,-0.64984 l 83.180612,0 q 0.88924,0 1.53908,0.64984 0.64984,0.64984 0.64984,1.53909 z"/>
        <path d="m 124.77795,946.46405 0,13.13382 q 0,0.88925 -0.64984,1.53909 -0.64984,0.64984 -1.53908,0.64984 l -83.180612,0 q -0.889337,0 -1.539177,-0.64984 -0.64984,-0.64984 -0.64984,-1.53909 l 0,-13.13382 q 0,-0.88925 0.64984,-1.53909 0.64984,-0.64984 1.539177,-0.64984 l 83.180612,0 q 0.88924,0 1.53908,0.64984 0.64984,0.64984 0.64984,1.53909 z"/>
        <circle cx="16.484" cy="953.031" r="11.093"/>
        <circle cx="16.484" cy="988.054" r="11.093"/>
        <circle cx="16.484" cy="1023.078" r="11.093"/>
      </g>
    </g>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-cogs">
    <path d="m 837.31525,895.50863 q 0,-104.17176 -68.77119,-177.8782 -68.77119,-73.70644 -165.9678,-73.70644 -97.19661,0 -165.9678,73.70644 -68.77118,73.70644 -68.77118,177.8782 0,104.17173 68.77118,177.87817 68.77119,73.7065 165.9678,73.7065 97.19661,0 165.9678,-73.7065 68.77119,-73.70644 68.77119,-177.87817 z M 1541.5322,1398.678 q 0,-51.1032 -34.8441,-88.4477 -34.8441,-37.3447 -82.5254,-37.3447 -47.6814,0 -82.5254,37.3447 -34.8441,37.3445 -34.8441,88.4477 0,52.0859 34.3856,88.9391 34.3856,36.8532 82.9839,36.8532 48.5983,0 82.9839,-36.8532 34.3856,-36.8532 34.3856,-88.9391 z m 0,-1006.33864 q 0,-51.10313 -34.8441,-88.44773 -34.8441,-37.34459 -82.5254,-37.34459 -47.6814,0 -82.5254,37.34459 -34.8441,37.3446 -34.8441,88.44773 0,52.08588 34.3856,88.93909 34.3856,36.85322 82.9839,36.85322 48.5983,0 82.9839,-36.85322 34.3856,-36.85321 34.3856,-88.93909 z m -352.1085,413.73879 0,181.80921 q 0,9.8275 -6.4186,19.16374 -6.4187,9.3361 -14.6713,10.3189 l -142.127,23.586 q -10.0865,34.3964 -29.3424,74.6892 31.1763,47.1721 82.5254,113.0165 6.4187,9.8276 6.4187,19.6551 0,11.7931 -6.4187,18.6723 -21.0898,29.4826 -75.6483,87.9564 -54.55846,58.4737 -71.98049,58.4737 -10.08644,0 -19.25593,-6.8792 l -105.44916,-88.4477 q -33.92711,18.6722 -70.60508,30.4653 -10.08644,106.1372 -21.08984,152.3265 -6.41864,23.5862 -27.50847,23.5862 l -170.55254,0 q -10.08644,0 -18.33898,-7.3707 -8.25254,-7.3707 -9.16949,-17.1981 l -21.08984,-150.3612 q -31.17627,-9.8275 -68.77118,-30.4654 l -108.2,87.4651 q -6.41865,6.8792 -18.33898,6.8792 -10.08644,0 -19.25593,-7.862 -132.04069,-130.7061 -132.04069,-157.2404 0,-8.8448 6.41865,-18.6723 9.16949,-13.7585 37.59491,-52.0858 28.42543,-38.3274 43.09661,-59.948 -21.08982,-43.2411 -32.09322,-80.5856 L 37.735581,1013.4389 q -9.169492,-0.9826 -15.588136,-9.3361 -6.418644,-8.35334 -6.418644,-19.16374 l 0,-181.80917 q 0,-9.82753 6.418644,-19.16368 6.418644,-9.33614 14.671187,-10.31889 L 178.94576,750.06125 q 10.08644,-34.39633 29.34237,-74.68918 -31.17628,-47.17212 -82.52543,-113.01654 -6.41864,-10.81028 -6.41864,-19.65505 0,-11.79303 6.41864,-19.65504 20.17288,-29.48259 75.18983,-87.46497 55.01695,-57.9824 72.43899,-57.9824 10.08644,0 19.25593,6.87926 l 105.44915,88.44772 q 31.17628,-17.68954 70.60508,-31.44808 10.08644,-106.13726 21.08984,-151.34388 6.41864,-23.58605 27.50847,-23.58605 l 170.55254,0 q 10.08644,0 18.33898,7.37064 8.25255,7.37064 9.16949,17.19817 l 21.08984,150.36112 q 31.17627,9.82754 68.77119,30.46534 l 108.19999,-87.46498 q 7.3356,-6.87926 18.33899,-6.87926 10.08644,0 19.25593,7.86202 132.04066,130.70608 132.04066,157.24039 0,8.84477 -6.4187,18.67231 -11.0033,15.72404 -38.5117,53.06862 -27.5086,37.3446 -41.2628,58.96515 21.0898,47.17212 31.1763,80.58571 l 139.3763,22.6033 q 9.1694,1.96551 15.5881,10.31891 6.4186,8.35339 6.4186,19.16367 z m 586.8475,523.80705 0,137.5855 q 0,15.724 -136.6254,30.4653 -11.0035,26.5343 -27.5085,51.1031 46.7643,111.051 46.7643,135.6198 0,3.931 -3.6678,6.8792 -111.8677,69.7755 -113.7016,69.7755 -7.3356,0 -42.1797,-46.1893 -34.8441,-46.1894 -47.6813,-66.8272 -18.339,1.9654 -27.5085,1.9654 -9.1695,0 -27.5085,-1.9654 -12.8372,20.6378 -47.6813,66.8272 -34.8441,46.1893 -42.1797,46.1893 -1.8339,0 -113.7017,-69.7755 -3.6678,-2.9482 -3.6678,-6.8792 0,-24.5688 46.7644,-135.6198 -16.505,-24.5688 -27.5085,-51.1031 -136.6254,-14.7413 -136.6254,-30.4653 l 0,-137.5855 q 0,-15.724 136.6254,-30.4652 11.9204,-28.4999 27.5085,-51.1032 -46.7644,-111.0511 -46.7644,-135.6199 0,-3.9309 3.6678,-6.8792 3.6678,-1.9656 32.0933,-19.655 28.4254,-17.6896 54.0999,-33.4136 25.6746,-15.724 27.5085,-15.724 7.3356,0 42.1797,45.698 34.8441,45.698 47.6813,66.3357 18.339,-1.9655 27.5085,-1.9655 9.1695,0 27.5085,1.9655 46.7644,-69.7755 84.3593,-110.0683 l 5.5017,-1.9654 q 3.6678,0 113.7016,68.7926 3.6678,2.9483 3.6678,6.8792 0,24.5688 -46.7643,135.6199 15.5881,22.6033 27.5085,51.1032 136.6254,14.7412 136.6254,30.4652 z m 0,-1006.33852 0,137.58535 q 0,15.72404 -136.6254,30.46533 -11.0035,26.53431 -27.5085,51.10312 46.7643,111.05104 46.7643,135.61984 0,3.93101 -3.6678,6.87928 -111.8677,69.77541 -113.7016,69.77541 -7.3356,0 -42.1797,-46.18936 -34.8441,-46.18937 -47.6813,-66.82717 -18.339,1.96551 -27.5085,1.96551 -9.1695,0 -27.5085,-1.96551 -12.8372,20.6378 -47.6813,66.82717 -34.8441,46.18936 -42.1797,46.18936 -1.8339,0 -113.7017,-69.77541 -3.6678,-2.94827 -3.6678,-6.87928 0,-24.5688 46.7644,-135.61984 -16.505,-24.56881 -27.5085,-51.10312 -136.6254,-14.74129 -136.6254,-30.46533 l 0,-137.58535 q 0,-15.72404 136.6254,-30.46532 11.9204,-28.49983 27.5085,-51.10313 -46.7644,-111.05103 -46.7644,-135.61984 0,-3.93102 3.6678,-6.879271 3.6678,-1.96551 32.0933,-19.655055 28.4254,-17.689544 54.0999,-33.413584 25.6746,-15.72404 27.5085,-15.72404 7.3356,0 42.1797,45.697991 34.8441,45.697999 47.6813,66.335799 18.339,-1.96551 27.5085,-1.96551 9.1695,0 27.5085,1.96551 46.7644,-69.775432 84.3593,-110.068284 l 5.5017,-1.965506 q 3.6678,0 113.7016,68.792679 3.6678,2.948251 3.6678,6.879271 0,24.56881 -46.7643,135.61984 15.5881,22.6033 27.5085,51.10313 136.6254,14.74128 136.6254,30.46532 z"/>
  </symbol>
  <symbol viewBox="0 0 16.933 25.4" id="icon-selection-handle">
    <path style="stroke-width:1.2" d="M 16.536458,0.396875 C 11.51054,0.56731735 5.4339008,1.2495971 2.22533,5.6177515 0.23433964,9.109249 4.3344224,12.191448 7.304374,13.107072 c 2.891776,1.028822 6.353465,1.716958 9.232084,1.424708 0,-4.711635 0,-9.4232699 0,-14.134905 z m -0.0036,14.500924 c 0,3.500733 0,7.001467 0,10.502201 0,-3.500734 0,-7.001468 0,-10.502201 z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-chevron-up">
    <path d="M1683 1331l-166 165q-19 19-45 19t-45-19l-531-531-531 531q-19 19-45 19t-45-19l-166-165q-19-19-19-45.5t19-45.5l742-741q19-19 45-19t45 19l742 741q19 19 19 45.5t-19 45.5z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-sort-amount-desc">
    <path d="M1216 1568v192q0 14-9 23t-23 9h-256q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h256q14 0 23 9t9 23zm-480-128q0 12-10 24l-319 319q-10 9-23 9-12 0-23-9l-320-320q-15-16-7-35 8-20 30-20h192v-1376q0-14 9-23t23-9h192q14 0 23 9t9 23v1376h192q14 0 23 9t9 23zm672-384v192q0 14-9 23t-23 9h-448q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h448q14 0 23 9t9 23zm192-512v192q0 14-9 23t-23 9h-640q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h640q14 0 23 9t9 23zm192-512v192q0 14-9 23t-23 9h-832q-14 0-23-9t-9-23v-192q0-14 9-23t23-9h832q14 0 23 9t9 23z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-close">
    <path d="M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"/>
  </symbol>
  <symbol viewBox="0 0 128 128" id="icon-insert-link"><g transform="translate(0,-924.36216)">
    <g transform="translate(0,-5.2934728)">
      <g transform="matrix(1.26,0,0,1.3012362,-13.737501,-318.60664)">
        <path d="m 56.142431,984.49997 0,0 c -0.009,-8.475 -7.645,-15.365 -17.024003,-15.365 l -10.402,0 c -9.281,0 -16.851,6.75 -17.02,15.093 l 0.005,0.281 c 0.004,8.474 7.64,15.365 17.02,15.365 l 10.401,0 c 2.086003,0 4.083003,-0.347 5.934003,-0.966 -2.541,-1.425 -4.678,-3.394 -6.210003,-5.728 l -10.125,0 c -5.386,0 -9.82,-3.487 -10.289,-7.912 l -0.042,0 0,-0.769 c 0.005,-4.781 4.641,-8.671 10.326,-8.671 l 10.401,0 c 5.386003,0 9.825003,3.478 10.289003,7.912 l 0.042,0 0.005,0.759 0,0.01 c -0.005,1.64 -0.558,3.168 -1.505,4.471 1.5,1.51 3.736,2.503 6.258,2.635 1.19,-2.053 1.889,-4.369 1.936,-6.834 l 0,-0.281 z"/>
        <path d="m 106.73343,973.67297 c -3.225,-2.925 -7.504999,-4.537 -12.060999,-4.537 l -10.401,0 c -9.379,0 -17.015,6.89 -17.02,15.365 l 0,0 0,0.057 c 0.014,2.549 0.717,4.94 1.94,7.049 2.508,-0.169 4.716,-1.2 6.183,-2.719 -0.9,-1.293 -1.43,-2.784 -1.43,-4.377 0,-0.01 0,-0.01 0,-0.01 0.005,-4.781 4.641,-8.671 10.326,-8.671 l 10.401,0 c 5.689999,0 10.325999,3.891 10.330999,8.671 0,4.791 -4.636,8.681 -10.330999,8.681 l -10.283,0 c -1.523,2.315 -3.638,4.266 -6.149,5.69 1.875,0.646 3.909,1.003 6.032,1.003 l 10.401,0 c 9.378999,0 17.014999,-6.891 17.023999,-15.365 10e-4,-4.087 -1.762,-7.931 -4.963,-10.837 z"/>
        <g>
          <path d="m 54.769431,969.13597 c -2.086,0 -4.087,0.347 -5.935,0.965 2.541,1.435 4.673,3.394 6.211,5.728 l 13.303,0 c 1.523,-2.315 3.638,-4.266 6.146,-5.69 -1.875,-0.647 -3.909,-1.003 -6.038,-1.003 l -13.687,0 z"/>
          <path d="m 85.480431,984.49997 c 0,-2.559 -0.703,-4.968 -1.936,-7.097 -2.508,0.169 -4.72,1.2 -6.188,2.719 0.9,1.294 1.425,2.785 1.43,4.378 l 0,0 c 0,4.791 -4.631,8.681 -10.326,8.681 l -13.691,0 c -5.69,0 -10.326,-3.891 -10.326,-8.681 l 0,0 c 0,-1.64 0.558,-3.168 1.5,-4.472 -1.5,-1.5 -3.736,-2.494 -6.253003,-2.625 -1.237,2.119 -1.94,4.538 -1.94,7.097 l 0,0 c 0,8.475 7.636003,15.375 17.024003,15.375 l 13.687,0 c 9.383,0 17.019,-6.899 17.019,-15.375 l 0,0 z"/>
        </g>
      </g>
      <path d="m 93,1011.8898 0,7.9091 q 0,1.6479 -1.15341,2.801 -1.1534,1.1535 -2.80113,1.1535 l -17.13637,0 0,17.1366 q 0,1.6475 -1.153401,2.8009 -1.153414,1.1535 -2.801139,1.1535 l -7.90909,0 q -1.647735,0 -2.801139,-1.1535 -1.153411,-1.1534 -1.153411,-2.8009 l 0,-17.1366 -17.13636,0 q -1.647725,0 -2.801135,-1.1535 Q 35,1021.4468 35,1019.7989 l 0,-7.9091 q 0,-1.6477 1.153415,-2.8011 1.15341,-1.1535 2.801135,-1.1535 l 17.13636,0 0,-17.13641 q 0,-1.64771 1.153411,-2.80112 1.153404,-1.15342 2.801139,-1.15342 l 7.90909,0 q 1.647725,0 2.801139,1.15342 1.153401,1.15341 1.153401,2.80112 l 0,17.13641 17.13637,0 q 1.64773,0 2.80113,1.1535 Q 93,1010.2421 93,1011.8898 Z"/>
    </g>
  </g>
</symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-user">
    <path d="M1600 1405q0 120-73 189.5t-194 69.5h-874q-121 0-194-69.5t-73-189.5q0-53 3.5-103.5t14-109 26.5-108.5 43-97.5 62-81 85.5-53.5 111.5-20q9 0 42 21.5t74.5 48 108 48 133.5 21.5 133.5-21.5 108-48 74.5-48 42-21.5q61 0 111.5 20t85.5 53.5 62 81 43 97.5 26.5 108.5 14 109 3.5 103.5zm-320-893q0 159-112.5 271.5t-271.5 112.5-271.5-112.5-112.5-271.5 112.5-271.5 271.5-112.5 271.5 112.5 112.5 271.5z"/>
  </symbol>
  <symbol viewBox="0 0 1792 1792" id="icon-angle-down">
    <path d="M1395 736q0 13-10 23l-466 466q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l50-50q10-10 23-10t23 10l393 393 393-393q10-10 23-10t23 10l50 50q10 10 10 23z"/>
  </symbol>
</svg>

<!-- }}} -->

<!-- main.js {{{ -->
    <script id="main_js">(function(){
    "use strict";
    var _iterator_symbol = (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") ? Symbol.iterator : "iterator-Symbol-5d0927e5554349048cf0e3762a228256";
    var _kwargs_symbol = (typeof Symbol === "function") ? Symbol("kwargs-object") : "kwargs-object-Symbol-5d0927e5554349048cf0e3762a228256";
    var _cond_temp, _expr_temp, _last_exception;
    var _object_counter = 0;
var _len;
function _bool(val) {
    return !!val;
};
if (!_bool.__argnames__) Object.defineProperties(_bool, {
    __argnames__ : {value: ["val"]},
    __module__ : {value: "__main__"}
});

function _print() {
    var parts;
    if (typeof console === "object") {
        parts = [];
        for (var i = 0; i < arguments.length; i++) {
            parts.push(_str(arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i]));
        }
        console.log(parts.join(" "));
    }
};
if (!_print.__module__) Object.defineProperties(_print, {
    __module__ : {value: "__main__"}
});

function _int(val, base) {
    var ans;
    if (typeof val === "number") {
        ans = val | 0;
    } else {
        ans = parseInt(val, base || 10);
    }
    if (isNaN(ans)) {
        throw new ValueError("Invalid literal for int with base " + (base || 10) + ": " + val);
    }
    return ans;
};
if (!_int.__argnames__) Object.defineProperties(_int, {
    __argnames__ : {value: ["val", "base"]},
    __module__ : {value: "__main__"}
});

function _float(val) {
    var ans;
    if (typeof val === "number") {
        ans = val;
    } else {
        ans = parseFloat(val);
    }
    if (isNaN(ans)) {
        throw new ValueError("Could not convert string to float: " + arguments[0]);
    }
    return ans;
};
if (!_float.__argnames__) Object.defineProperties(_float, {
    __argnames__ : {value: ["val"]},
    __module__ : {value: "__main__"}
});

function _arraylike_creator() {
    var names;
    names = "Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" ");
    if (typeof HTMLCollection === "function") {
        names = names.concat("HTMLCollection NodeList NamedNodeMap TouchList".split(" "));
    }
    return (function() {
        var _anonfunc = function (x) {
            if (Array.isArray(x) || typeof x === "string" || names.indexOf(Object.prototype.toString.call(x).slice(8, -1)) > -1) {
                return true;
            }
            return false;
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
};
if (!_arraylike_creator.__module__) Object.defineProperties(_arraylike_creator, {
    __module__ : {value: "__main__"}
});

function options_object(f) {
    return (function() {
        var _anonfunc = function () {
            if (typeof arguments[arguments.length - 1] === "object") {
                arguments[_bound_index(arguments.length - 1, arguments)][_kwargs_symbol] = true;
            }
            return f.apply(this, arguments);
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
};
if (!options_object.__argnames__) Object.defineProperties(options_object, {
    __argnames__ : {value: ["f"]},
    __module__ : {value: "__main__"}
});

function _id(x) {
    return x._object_id;
};
if (!_id.__argnames__) Object.defineProperties(_id, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _dir(item) {
    var arr;
    arr = _list_decorate([]);
    for (var i in item) {
        arr.push(i);
    }
    return arr;
};
if (!_dir.__argnames__) Object.defineProperties(_dir, {
    __argnames__ : {value: ["item"]},
    __module__ : {value: "__main__"}
});

function _ord(x) {
    var ans, second;
    ans = x.charCodeAt(0);
    if (55296 <= ans && ans <= 56319) {
        second = x.charCodeAt(1);
        if (56320 <= second && second <= 57343) {
            return (ans - 55296) * 1024 + second - 56320 + 65536;
        }
        throw new TypeError("string is missing the low surrogate char");
    }
    return ans;
};
if (!_ord.__argnames__) Object.defineProperties(_ord, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _chr(code) {
    if (code <= 65535) {
        return String.fromCharCode(code);
    }
    code -= 65536;
    return String.fromCharCode(55296 + (code >> 10), 56320 + (code & 1023));
};
if (!_chr.__argnames__) Object.defineProperties(_chr, {
    __argnames__ : {value: ["code"]},
    __module__ : {value: "__main__"}
});

function _callable(x) {
    return typeof x === "function";
};
if (!_callable.__argnames__) Object.defineProperties(_callable, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _bin(x) {
    var ans;
    if (typeof x !== "number" || x % 1 !== 0) {
        throw new TypeError("integer required");
    }
    ans = x.toString(2);
    if (ans[0] === "-") {
        ans = "-" + "0b" + ans.slice(1);
    } else {
        ans = "0b" + ans;
    }
    return ans;
};
if (!_bin.__argnames__) Object.defineProperties(_bin, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _hex(x) {
    var ans;
    if (typeof x !== "number" || x % 1 !== 0) {
        throw new TypeError("integer required");
    }
    ans = x.toString(16);
    if (ans[0] === "-") {
        ans = "-" + "0x" + ans.slice(1);
    } else {
        ans = "0x" + ans;
    }
    return ans;
};
if (!_hex.__argnames__) Object.defineProperties(_hex, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _enumerate(iterable) {
    var ans, iterator;
    ans = {"_i":-1};
    ans[_iterator_symbol] = (function() {
        var _anonfunc = function () {
            return this;
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    if (_arraylike(iterable)) {
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i < iterable.length) {
                    return {'done':false, 'value':[this._i, iterable[this._i]]};
                }
                return {'done':true};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    }
    if (typeof iterable[_iterator_symbol] === "function") {
        iterator = (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
        ans["_iterator"] = iterator;
        ans["next"] = (function() {
            var _anonfunc = function () {
                var r;
                r = this._iterator.next();
                if (r.done) {
                    return {'done':true};
                }
                this._i += 1;
                return {'done':false, 'value':[this._i, r.value]};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    }
    return _enumerate(Object.keys(iterable));
};
if (!_enumerate.__argnames__) Object.defineProperties(_enumerate, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

function _reversed(iterable) {
    var ans;
    if (_arraylike(iterable)) {
        ans = {"_i": iterable.length};
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i -= 1;
                if (this._i > -1) {
                    return {'done':false, 'value':iterable[this._i]};
                }
                return {'done':true};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        ans[_iterator_symbol] = (function() {
            var _anonfunc = function () {
                return this;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    }
    throw new TypeError("reversed() can only be called on arrays or strings");
};
if (!_reversed.__argnames__) Object.defineProperties(_reversed, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

function _iter(iterable) {
    var ans;
    if (typeof iterable[_iterator_symbol] === "function") {
        return (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
    }
    if (_arraylike(iterable)) {
        ans = {"_i":-1};
        ans[_iterator_symbol] = (function() {
            var _anonfunc = function () {
                return this;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i < iterable.length) {
                    return {'done':false, 'value':iterable[this._i]};
                }
                return {'done':true};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    }
    return _iter(Object.keys(iterable));
};
if (!_iter.__argnames__) Object.defineProperties(_iter, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

function _range_next(step, length) {
    var _unpack;
    this._i += step;
    this._idx += 1;
    if (this._idx >= length) {
        _unpack = [this.__i, -1];
        this._i = _unpack[0];
        this._idx = _unpack[1];
        return {'done':true};
    }
    return {'done':false, 'value':this._i};
};
if (!_range_next.__argnames__) Object.defineProperties(_range_next, {
    __argnames__ : {value: ["step", "length"]},
    __module__ : {value: "__main__"}
});

function _range(start, stop, step) {
    var length, ans;
    if (arguments.length <= 1) {
        stop = start || 0;
        start = 0;
    }
    step = arguments[2] || 1;
    length = Math.max(Math.ceil((stop - start) / step), 0);
    ans = {start:start, step:step, stop:stop};
    ans[_iterator_symbol] = (function() {
        var _anonfunc = function () {
            var it;
            it = {"_i": start - step, "_idx": -1};
            it.next = _range_next.bind(it, step, length);
            it[_iterator_symbol] = (function() {
                var _anonfunc = function () {
                    return this;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
            return it;
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans.count = (function() {
        var _anonfunc = function (val) {
            if (!this._cached) {
                this._cached = list(this);
            }
            return this._cached.count(val);
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans.index = (function() {
        var _anonfunc = function (val) {
            if (!this._cached) {
                this._cached = list(this);
            }
            return this._cached.index(val);
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans.__len__ = (function() {
        var _anonfunc = function () {
            return length;
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans.__repr__ = (function() {
        var _anonfunc = function () {
            return "range(" + _str.format("{}", start) + ", " + _str.format("{}", stop) + ", " + _str.format("{}", step) + ")";
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans.__str__ = ans.toString = ans.__repr__;
    if (typeof Proxy === "function") {
        ans = new Proxy(ans, (function(){
            var _d = {};
            _d["get"] = (function() {
                var _anonfunc = function (obj, prop) {
                    var iprop;
                    if (typeof prop === "string") {
                        iprop = parseInt(prop);
                        if (!isNaN(iprop)) {
                            prop = iprop;
                        }
                    }
                    if (typeof prop === "number") {
                        if (!obj._cached) {
                            obj._cached = list(obj);
                        }
                        return (_expr_temp = obj._cached)[(typeof prop === "number" && prop < 0) ? _expr_temp.length + prop : prop];
                    }
                    return obj[(typeof prop === "number" && prop < 0) ? obj.length + prop : prop];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["obj", "prop"]},
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
            return _d;
        }).call(this));
    }
    return ans;
};
if (!_range.__argnames__) Object.defineProperties(_range, {
    __argnames__ : {value: ["start", "stop", "step"]},
    __module__ : {value: "__main__"}
});

function _getattr(obj, name, defval) {
    var ret;
    try {
        ret = obj[(typeof name === "number" && name < 0) ? obj.length + name : name];
    } catch (_Exception) {
        _last_exception = _Exception;
        if (_Exception instanceof TypeError) {
            if (defval === undefined) {
                throw new AttributeError("The attribute " + name + " is not present");
            }
            return defval;
        } else {
            throw _Exception;
        }
    }
    if (ret === undefined && !(name in obj)) {
        if (defval === undefined) {
            throw new AttributeError("The attribute " + name + " is not present");
        }
        ret = defval;
    }
    return ret;
};
if (!_getattr.__argnames__) Object.defineProperties(_getattr, {
    __argnames__ : {value: ["obj", "name", "defval"]},
    __module__ : {value: "__main__"}
});

function _setattr(obj, name, value) {
    obj[(typeof name === "number" && name < 0) ? obj.length + name : name] = value;
};
if (!_setattr.__argnames__) Object.defineProperties(_setattr, {
    __argnames__ : {value: ["obj", "name", "value"]},
    __module__ : {value: "__main__"}
});

function _hasattr(obj, name) {
    return name in obj;
};
if (!_hasattr.__argnames__) Object.defineProperties(_hasattr, {
    __argnames__ : {value: ["obj", "name"]},
    __module__ : {value: "__main__"}
});

_len = (function() {
    var _anonfunc = function () {
        function len(obj) {
            if (_arraylike(obj)) {
                return obj.length;
            }
            if (typeof obj.__len__ === "function") {
                return obj.__len__();
            }
            if (obj instanceof Set || obj instanceof Map) {
                return obj.size;
            }
            return Object.keys(obj).length;
        };
        if (!len.__argnames__) Object.defineProperties(len, {
            __argnames__ : {value: ["obj"]},
            __module__ : {value: "__main__"}
        });

        function len5(obj) {
            if (_arraylike(obj)) {
                return obj.length;
            }
            if (typeof obj.__len__ === "function") {
                return obj.__len__();
            }
            return Object.keys(obj).length;
        };
        if (!len5.__argnames__) Object.defineProperties(len5, {
            __argnames__ : {value: ["obj"]},
            __module__ : {value: "__main__"}
        });

        return (typeof Set === "function" && typeof Map === "function") ? len : len5;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})()();
function _get_module(name) {
    return _modules[(typeof name === "number" && name < 0) ? _modules.length + name : name];
};
if (!_get_module.__argnames__) Object.defineProperties(_get_module, {
    __argnames__ : {value: ["name"]},
    __module__ : {value: "__main__"}
});

function _pow(x, y, z) {
    var ans;
    ans = Math.pow(x, y);
    if (z !== undefined) {
        ans %= z;
    }
    return ans;
};
if (!_pow.__argnames__) Object.defineProperties(_pow, {
    __argnames__ : {value: ["x", "y", "z"]},
    __module__ : {value: "__main__"}
});

function _type(x) {
    return x.constructor;
};
if (!_type.__argnames__) Object.defineProperties(_type, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _divmod(x, y) {
    var d;
    if (y === 0) {
        throw new ZeroDivisionError("integer division or modulo by zero");
    }
    d = Math.floor(x / y);
    return [d, x - d * y];
};
if (!_divmod.__argnames__) Object.defineProperties(_divmod, {
    __argnames__ : {value: ["x", "y"]},
    __module__ : {value: "__main__"}
});

function _max() {
    var kwargs = arguments[arguments.length-1];
    if (kwargs === null || typeof kwargs !== "object" || kwargs [_kwargs_symbol] !== true) kwargs = {};
    var args = Array.prototype.slice.call(arguments, 0);
    if (kwargs !== null && typeof kwargs === "object" && kwargs [_kwargs_symbol] === true) args.pop();
    var args, x;
    if (args.length === 0) {
        if (kwargs.defval !== undefined) {
            return kwargs.defval;
        }
        throw new TypeError("expected at least one argument");
    }
    if (args.length === 1) {
        args = args[0];
    }
    if (kwargs.key) {
        args = (function() {
            var _Iter = _Iterable(args), _Result = [], x;
            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                x = _Iter[_Index];
                _Result.push(kwargs.key(x));
            }
            _Result = _list_constructor(_Result);
            return _Result;
        })();
    }
    if (!Array.isArray(args)) {
        args = list(args);
    }
    if (args.length) {
        return this.apply(null, args);
    }
    if (kwargs.defval !== undefined) {
        return kwargs.defval;
    }
    throw new TypeError("expected at least one argument");
};
if (!_max.__handles_kwarg_interpolation__) Object.defineProperties(_max, {
    __handles_kwarg_interpolation__ : {value: true},
    __module__ : {value: "__main__"}
});

var abs = Math.abs, max = _max.bind(Math.max), min = _max.bind(Math.min), bool = _bool, type = _type;
var float = _float, int = _int, arraylike = _arraylike_creator(), _arraylike = arraylike;
var print = _print, id = _id, get_module = _get_module, pow = _pow, divmod = _divmod;
var dir = _dir, ord = _ord, chr = _chr, bin = _bin, hex = _hex, callable = _callable;
var enumerate = _enumerate, iter = _iter, reversed = _reversed, len = _len;
var range = _range, getattr = _getattr, setattr = _setattr, hasattr = _hasattr;function _equals(a, b) {
    var _unpack, akeys, bkeys, key;
    if (a === b) {
        return true;
    }
    if (a && typeof a.__eq__ === "function") {
        return a.__eq__(b);
    }
    if (b && typeof b.__eq__ === "function") {
        return b.__eq__(a);
    }
    if (_arraylike(a) && _arraylike(b)) {
        if ((a.length !== b.length && (typeof a.length !== "object" || _not_equals(a.length, b.length)))) {
            return false;
        }
        for (var i=0; i < a.length; i++) {
            if (!(((a[(typeof i === "number" && i < 0) ? a.length + i : i] === b[(typeof i === "number" && i < 0) ? b.length + i : i] || typeof a[(typeof i === "number" && i < 0) ? a.length + i : i] === "object" && _equals(a[(typeof i === "number" && i < 0) ? a.length + i : i], b[(typeof i === "number" && i < 0) ? b.length + i : i]))))) {
                return false;
            }
        }
        return true;
    }
    if (typeof a === "object" && typeof b === "object" && a !== null && b !== null && (a.constructor === Object && b.constructor === Object || Object.getPrototypeOf(a) === null && Object.getPrototypeOf(b) === null)) {
        _unpack = [Object.keys(a), Object.keys(b)];
        akeys = _unpack[0];
        bkeys = _unpack[1];
        if (akeys.length !== bkeys.length) {
            return false;
        }
        for (var j=0; j < akeys.length; j++) {
            key = akeys[(typeof j === "number" && j < 0) ? akeys.length + j : j];
            if (!(((a[(typeof key === "number" && key < 0) ? a.length + key : key] === b[(typeof key === "number" && key < 0) ? b.length + key : key] || typeof a[(typeof key === "number" && key < 0) ? a.length + key : key] === "object" && _equals(a[(typeof key === "number" && key < 0) ? a.length + key : key], b[(typeof key === "number" && key < 0) ? b.length + key : key]))))) {
                return false;
            }
        }
        return true;
    }
    return false;
};
if (!_equals.__argnames__) Object.defineProperties(_equals, {
    __argnames__ : {value: ["a", "b"]},
    __module__ : {value: "__main__"}
});

function _not_equals(a, b) {
    if (a === b) {
        return false;
    }
    if (a && typeof a.__ne__ === "function") {
        return a.__ne__(b);
    }
    if (b && typeof b.__ne__ === "function") {
        return b.__ne__(a);
    }
    return !_equals(a, b);
};
if (!_not_equals.__argnames__) Object.defineProperties(_not_equals, {
    __argnames__ : {value: ["a", "b"]},
    __module__ : {value: "__main__"}
});

var equals = _equals;
function _list_extend(iterable) {
    var start, iterator, result;
    if (Array.isArray(iterable) || typeof iterable === "string") {
        start = this.length;
        this.length += iterable.length;
        for (var i = 0; i < iterable.length; i++) {
            (_expr_temp = this)[_bound_index(start + i, _expr_temp)] = iterable[(typeof i === "number" && i < 0) ? iterable.length + i : i];
        }
    } else {
        iterator = (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
        result = iterator.next();
        while (!result.done) {
            this.push(result.value);
            result = iterator.next();
        }
    }
};
if (!_list_extend.__argnames__) Object.defineProperties(_list_extend, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

function _list_index(val, start, stop) {
    start = start || 0;
    if (start < 0) {
        start = this.length + start;
    }
    if (start < 0) {
        throw new ValueError(val + " is not in list");
    }
    if (stop === undefined) {
        stop = this.length;
    }
    if (stop < 0) {
        stop = this.length + stop;
    }
    for (var i = start; i < stop; i++) {
        if (((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === val || typeof (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === "object" && _equals((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i], val))) {
            return i;
        }
    }
    throw new ValueError(val + " is not in list");
};
if (!_list_index.__argnames__) Object.defineProperties(_list_index, {
    __argnames__ : {value: ["val", "start", "stop"]},
    __module__ : {value: "__main__"}
});

function _list_pop(index) {
    var ans;
    if (this.length === 0) {
        throw new IndexError("list is empty");
    }
    if (index === undefined) {
        index = -1;
    }
    ans = this.splice(index, 1);
    if (!ans.length) {
        throw new IndexError("pop index out of range");
    }
    return ans[0];
};
if (!_list_pop.__argnames__) Object.defineProperties(_list_pop, {
    __argnames__ : {value: ["index"]},
    __module__ : {value: "__main__"}
});

function _list_remove(value) {
    for (var i = 0; i < this.length; i++) {
        if (((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === value || typeof (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === "object" && _equals((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i], value))) {
            this.splice(i, 1);
            return;
        }
    }
    throw new ValueError(value + " not in list");
};
if (!_list_remove.__argnames__) Object.defineProperties(_list_remove, {
    __argnames__ : {value: ["value"]},
    __module__ : {value: "__main__"}
});

function _list_to_string() {
    return "[" + this.join(", ") + "]";
};
if (!_list_to_string.__module__) Object.defineProperties(_list_to_string, {
    __module__ : {value: "__main__"}
});

function _list_insert(index, val) {
    if (index < 0) {
        index += this.length;
    }
    index = min(this.length, max(index, 0));
    if (index === 0) {
        this.unshift(val);
        return;
    }
    for (var i = this.length; i > index; i--) {
        (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] = (_expr_temp = this)[_bound_index(i - 1, _expr_temp)];
    }
    (_expr_temp = this)[(typeof index === "number" && index < 0) ? _expr_temp.length + index : index] = val;
};
if (!_list_insert.__argnames__) Object.defineProperties(_list_insert, {
    __argnames__ : {value: ["index", "val"]},
    __module__ : {value: "__main__"}
});

function _list_copy() {
    return _list_constructor(this);
};
if (!_list_copy.__module__) Object.defineProperties(_list_copy, {
    __module__ : {value: "__main__"}
});

function _list_clear() {
    this.length = 0;
};
if (!_list_clear.__module__) Object.defineProperties(_list_clear, {
    __module__ : {value: "__main__"}
});

function _list_as_array() {
    return Array.prototype.slice.call(this);
};
if (!_list_as_array.__module__) Object.defineProperties(_list_as_array, {
    __module__ : {value: "__main__"}
});

function _list_count(value) {
    return this.reduce((function() {
        var _anonfunc = function (n, val) {
            return n + (val === value);
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["n", "val"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })(), 0);
};
if (!_list_count.__argnames__) Object.defineProperties(_list_count, {
    __argnames__ : {value: ["value"]},
    __module__ : {value: "__main__"}
});

function _list_sort_key(value) {
    var t;
    t = typeof value;
    if (t === "string" || t === "number") {
        return value;
    }
    return value.toString();
};
if (!_list_sort_key.__argnames__) Object.defineProperties(_list_sort_key, {
    __argnames__ : {value: ["value"]},
    __module__ : {value: "__main__"}
});

function _list_sort_cmp(a, b, ap, bp) {
    if (a < b) {
        return -1;
    }
    if (a > b) {
        return 1;
    }
    return ap - bp;
};
if (!_list_sort_cmp.__argnames__) Object.defineProperties(_list_sort_cmp, {
    __argnames__ : {value: ["a", "b", "ap", "bp"]},
    __module__ : {value: "__main__"}
});

function _list_sort() {
    var key = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? _list_sort.__defaults__.key : arguments[0];
    var reverse = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? _list_sort.__defaults__.reverse : arguments[1];
    var _kwargs_obj = arguments[arguments.length-1];
    if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
    if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "key")){
        key = _kwargs_obj.key;
    }
    if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "reverse")){
        reverse = _kwargs_obj.reverse;
    }
    var mult, keymap, posmap, k;
    key = key || _list_sort_key;
    mult = (reverse) ? -1 : 1;
    keymap = dict();
    posmap = dict();
    for (var i=0; i < this.length; i++) {
        k = (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
        keymap.set(k, key(k));
        posmap.set(k, i);
    }
    this.sort((function() {
        var _anonfunc = function (a, b) {
            return mult * _list_sort_cmp(keymap.get(a), keymap.get(b), posmap.get(a), posmap.get(b));
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })());
};
if (!_list_sort.__defaults__) Object.defineProperties(_list_sort, {
    __defaults__ : {value: {key:null, reverse:false}},
    __handles_kwarg_interpolation__ : {value: true},
    __argnames__ : {value: ["key", "reverse"]},
    __module__ : {value: "__main__"}
});

function _list_concat() {
    var ans;
    ans = Array.prototype.concat.apply(this, arguments);
    _list_decorate(ans);
    return ans;
};
if (!_list_concat.__module__) Object.defineProperties(_list_concat, {
    __module__ : {value: "__main__"}
});

function _list_slice() {
    var ans;
    ans = Array.prototype.slice.apply(this, arguments);
    _list_decorate(ans);
    return ans;
};
if (!_list_slice.__module__) Object.defineProperties(_list_slice, {
    __module__ : {value: "__main__"}
});

function _list_iterator(value) {
    var self;
    self = this;
    return (function(){
        var _d = {};
        _d["_i"] = -1;
        _d["_list"] = self;
        _d["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i >= this._list.length) {
                    return (function(){
                        var _d = {};
                        _d["done"] = true;
                        return _d;
                    }).call(this);
                }
                return (function(){
                    var _d = {};
                    _d["done"] = false;
                    _d["value"] = (_expr_temp = this._list)[_bound_index(this._i, _expr_temp)];
                    return _d;
                }).call(this);
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return _d;
    }).call(this);
};
if (!_list_iterator.__argnames__) Object.defineProperties(_list_iterator, {
    __argnames__ : {value: ["value"]},
    __module__ : {value: "__main__"}
});

function _list_len() {
    return this.length;
};
if (!_list_len.__module__) Object.defineProperties(_list_len, {
    __module__ : {value: "__main__"}
});

function _list_contains(val) {
    for (var i = 0; i < this.length; i++) {
        if (((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === val || typeof (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === "object" && _equals((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i], val))) {
            return true;
        }
    }
    return false;
};
if (!_list_contains.__argnames__) Object.defineProperties(_list_contains, {
    __argnames__ : {value: ["val"]},
    __module__ : {value: "__main__"}
});

function _list_eq(other) {
    if (!_arraylike(other)) {
        return false;
    }
    if ((this.length !== other.length && (typeof this.length !== "object" || _not_equals(this.length, other.length)))) {
        return false;
    }
    for (var i = 0; i < this.length; i++) {
        if (!((((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === other[(typeof i === "number" && i < 0) ? other.length + i : i] || typeof (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] === "object" && _equals((_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i], other[(typeof i === "number" && i < 0) ? other.length + i : i]))))) {
            return false;
        }
    }
    return true;
};
if (!_list_eq.__argnames__) Object.defineProperties(_list_eq, {
    __argnames__ : {value: ["other"]},
    __module__ : {value: "__main__"}
});

function _list_decorate(ans) {
    ans.append = Array.prototype.push;
    ans.toString = _list_to_string;
    ans.inspect = _list_to_string;
    ans.extend = _list_extend;
    ans.index = _list_index;
    ans.pypop = _list_pop;
    ans.remove = _list_remove;
    ans.insert = _list_insert;
    ans.copy = _list_copy;
    ans.clear = _list_clear;
    ans.count = _list_count;
    ans.concat = _list_concat;
    ans.pysort = _list_sort;
    ans.slice = _list_slice;
    ans.as_array = _list_as_array;
    ans.__len__ = _list_len;
    ans.__contains__ = _list_contains;
    ans.__eq__ = _list_eq;
    ans.constructor = _list_constructor;
    if (typeof ans[_iterator_symbol] !== "function") {
        ans[_iterator_symbol] = _list_iterator;
    }
    return ans;
};
if (!_list_decorate.__argnames__) Object.defineProperties(_list_decorate, {
    __argnames__ : {value: ["ans"]},
    __module__ : {value: "__main__"}
});

function _list_constructor(iterable) {
    var ans, iterator, result;
    if (iterable === undefined) {
        ans = [];
    } else if (_arraylike(iterable)) {
        ans = new Array(iterable.length);
        for (var i = 0; i < iterable.length; i++) {
            ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = iterable[(typeof i === "number" && i < 0) ? iterable.length + i : i];
        }
    } else if (typeof iterable[_iterator_symbol] === "function") {
        iterator = (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
        ans = _list_decorate([]);
        result = iterator.next();
        while (!result.done) {
            ans.push(result.value);
            result = iterator.next();
        }
    } else if (typeof iterable === "number") {
        ans = new Array(iterable);
    } else {
        ans = Object.keys(iterable);
    }
    return _list_decorate(ans);
};
if (!_list_constructor.__argnames__) Object.defineProperties(_list_constructor, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

_list_constructor.__name__ = "list";
var list = _list_constructor, list_wrap = _list_decorate;
function sorted() {
    var iterable = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
    var key = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? sorted.__defaults__.key : arguments[1];
    var reverse = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? sorted.__defaults__.reverse : arguments[2];
    var _kwargs_obj = arguments[arguments.length-1];
    if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
    if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "key")){
        key = _kwargs_obj.key;
    }
    if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "reverse")){
        reverse = _kwargs_obj.reverse;
    }
    var ans;
    ans = _list_constructor(iterable);
    ans.pysort(key, reverse);
    return ans;
};
if (!sorted.__defaults__) Object.defineProperties(sorted, {
    __defaults__ : {value: {key:null, reverse:false}},
    __handles_kwarg_interpolation__ : {value: true},
    __argnames__ : {value: ["iterable", "key", "reverse"]},
    __module__ : {value: "__main__"}
});

var _global_object_id = 0, _set_implementation;
function _set_keyfor(x) {
    var t, ans;
    t = typeof x;
    if (t === "string" || t === "number" || t === "boolean") {
        return "_" + t[0] + x;
    }
    if (x === null) {
        return "__!@#$0";
    }
    ans = x._hash_key_prop;
    if (ans === undefined) {
        ans = "_!@#$" + (++_global_object_id);
        Object.defineProperty(x, "_hash_key_prop", (function(){
            var _d = {};
            _d["value"] = ans;
            return _d;
        }).call(this));
    }
    return ans;
};
if (!_set_keyfor.__argnames__) Object.defineProperties(_set_keyfor, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _set_polyfill() {
    this._store = {};
    this.size = 0;
};
if (!_set_polyfill.__module__) Object.defineProperties(_set_polyfill, {
    __module__ : {value: "__main__"}
});

_set_polyfill.prototype.add = (function() {
    var _anonfunc = function (x) {
        var key;
        key = _set_keyfor(x);
        if (!Object.prototype.hasOwnProperty.call(this._store, key)) {
            this.size += 1;
            (_expr_temp = this._store)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = x;
        }
        return this;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set_polyfill.prototype.clear = (function() {
    var _anonfunc = function (x) {
        this._store = {};
        this.size = 0;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set_polyfill.prototype.delete = (function() {
    var _anonfunc = function (x) {
        var key;
        key = _set_keyfor(x);
        if (Object.prototype.hasOwnProperty.call(this._store, key)) {
            this.size -= 1;
            delete this._store[key];
            return true;
        }
        return false;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set_polyfill.prototype.has = (function() {
    var _anonfunc = function (x) {
        return Object.prototype.hasOwnProperty.call(this._store, _set_keyfor(x));
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set_polyfill.prototype.values = (function() {
    var _anonfunc = function (x) {
        var ans;
        ans = {'_keys': Object.keys(this._store), '_i':-1, '_s':this._store};
        ans[_iterator_symbol] = (function() {
            var _anonfunc = function () {
                return this;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i >= this._keys.length) {
                    return {'done': true};
                }
                return {'done':false, 'value':this._s[this._keys[this._i]]};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
if (typeof Set !== "function" || typeof Set.prototype.delete !== "function") {
    _set_implementation = _set_polyfill;
} else {
    _set_implementation = Set;
}
function _set(iterable) {
    var ans, s, iterator, result, keys;
    if (this instanceof _set) {
        this.jsset = new _set_implementation;
        ans = this;
        if (iterable === undefined) {
            return ans;
        }
        s = ans.jsset;
        if (_arraylike(iterable)) {
            for (var i = 0; i < iterable.length; i++) {
                s.add(iterable[(typeof i === "number" && i < 0) ? iterable.length + i : i]);
            }
        } else if (typeof iterable[_iterator_symbol] === "function") {
            iterator = (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
            result = iterator.next();
            while (!result.done) {
                s.add(result.value);
                result = iterator.next();
            }
        } else {
            keys = Object.keys(iterable);
            for (var j=0; j < keys.length; j++) {
                s.add(keys[(typeof j === "number" && j < 0) ? keys.length + j : j]);
            }
        }
        return ans;
    } else {
        return new _set(iterable);
    }
};
if (!_set.__argnames__) Object.defineProperties(_set, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

_set.prototype.__name__ = "set";
Object.defineProperties(_set.prototype, (function(){
    var _d = {};
    _d["length"] = (function(){
        var _d = {};
        _d["get"] = (function() {
            var _anonfunc = function () {
                return this.jsset.size;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return _d;
    }).call(this);
    _d["size"] = (function(){
        var _d = {};
        _d["get"] = (function() {
            var _anonfunc = function () {
                return this.jsset.size;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return _d;
    }).call(this);
    return _d;
}).call(this));
_set.prototype.__len__ = (function() {
    var _anonfunc = function () {
        return this.jsset.size;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.has = _set.prototype.__contains__ = (function() {
    var _anonfunc = function (x) {
        return this.jsset.has(x);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.add = (function() {
    var _anonfunc = function (x) {
        this.jsset.add(x);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.clear = (function() {
    var _anonfunc = function () {
        this.jsset.clear();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.copy = (function() {
    var _anonfunc = function () {
        return _set(this);
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.discard = (function() {
    var _anonfunc = function (x) {
        this.jsset.delete(x);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype[_iterator_symbol] = (function() {
    var _anonfunc = function () {
        return this.jsset.values();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.difference = (function() {
    var _anonfunc = function () {
        var ans, s, iterator, r, x, has;
        ans = new _set;
        s = ans.jsset;
        iterator = this.jsset.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            has = false;
            for (var i = 0; i < arguments.length; i++) {
                if (arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i].has(x)) {
                    has = true;
                    break;
                }
            }
            if (!has) {
                s.add(x);
            }
            r = iterator.next();
        }
        return ans;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.difference_update = (function() {
    var _anonfunc = function () {
        var s, remove, iterator, r, x;
        s = this.jsset;
        remove = [];
        iterator = s.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            for (var i = 0; i < arguments.length; i++) {
                if (arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i].has(x)) {
                    remove.push(x);
                    break;
                }
            }
            r = iterator.next();
        }
        for (var j = 0; j < remove.length; j++) {
            s.delete(remove[(typeof j === "number" && j < 0) ? remove.length + j : j]);
        }
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.intersection = (function() {
    var _anonfunc = function () {
        var ans, s, iterator, r, x, has;
        ans = new _set;
        s = ans.jsset;
        iterator = this.jsset.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            has = true;
            for (var i = 0; i < arguments.length; i++) {
                if (!arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i].has(x)) {
                    has = false;
                    break;
                }
            }
            if (has) {
                s.add(x);
            }
            r = iterator.next();
        }
        return ans;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.intersection_update = (function() {
    var _anonfunc = function () {
        var s, remove, iterator, r, x;
        s = this.jsset;
        remove = [];
        iterator = s.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            for (var i = 0; i < arguments.length; i++) {
                if (!arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i].has(x)) {
                    remove.push(x);
                    break;
                }
            }
            r = iterator.next();
        }
        for (var j = 0; j < remove.length; j++) {
            s.delete(remove[(typeof j === "number" && j < 0) ? remove.length + j : j]);
        }
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.isdisjoint = (function() {
    var _anonfunc = function (other) {
        var iterator, r, x;
        iterator = this.jsset.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            if (other.has(x)) {
                return false;
            }
            r = iterator.next();
        }
        return true;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.issubset = (function() {
    var _anonfunc = function (other) {
        var iterator, r, x;
        iterator = this.jsset.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            if (!other.has(x)) {
                return false;
            }
            r = iterator.next();
        }
        return true;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.issuperset = (function() {
    var _anonfunc = function (other) {
        var s, iterator, r, x;
        s = this.jsset;
        iterator = other.jsset.values();
        r = iterator.next();
        while (!r.done) {
            x = r.value;
            if (!s.has(x)) {
                return false;
            }
            r = iterator.next();
        }
        return true;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.pop = (function() {
    var _anonfunc = function () {
        var iterator, r;
        iterator = this.jsset.values();
        r = iterator.next();
        if (r.done) {
            throw new KeyError("pop from an empty set");
        }
        this.jsset.delete(r.value);
        return r.value;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.remove = (function() {
    var _anonfunc = function (x) {
        if (!this.jsset.delete(x)) {
            throw new KeyError(x.toString());
        }
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.symmetric_difference = (function() {
    var _anonfunc = function (other) {
        return this.union(other).difference(this.intersection(other));
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.symmetric_difference_update = (function() {
    var _anonfunc = function (other) {
        var common;
        common = this.intersection(other);
        this.update(other);
        this.difference_update(common);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.union = (function() {
    var _anonfunc = function () {
        var ans;
        ans = _set(this);
        ans.update.apply(ans, arguments);
        return ans;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.update = (function() {
    var _anonfunc = function () {
        var s, iterator, r;
        s = this.jsset;
        for (var i=0; i < arguments.length; i++) {
            iterator = arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i][_iterator_symbol]();
            r = iterator.next();
            while (!r.done) {
                s.add(r.value);
                r = iterator.next();
            }
        }
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.toString = _set.prototype.__repr__ = _set.prototype.__str__ = _set.prototype.inspect = (function() {
    var _anonfunc = function () {
        return "{" + list(this).join(", ") + "}";
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_set.prototype.__eq__ = (function() {
    var _anonfunc = function (other) {
        var iterator, r;
        if (!other instanceof this.constructor) {
            return false;
        }
        if (other.size !== this.size) {
            return false;
        }
        if (other.size === 0) {
            return true;
        }
        iterator = other[_iterator_symbol]();
        r = iterator.next();
        while (!r.done) {
            if (!this.has(r.value)) {
                return false;
            }
            r = iterator.next();
        }
        return true;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
function _set_wrap(x) {
    var ans;
    ans = new _set;
    ans.jsset = x;
    return ans;
};
if (!_set_wrap.__argnames__) Object.defineProperties(_set_wrap, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

var set = _set, set_wrap = _set_wrap;
var _dict_implementation;
function _dict_polyfill() {
    this._store = {};
    this.size = 0;
};
if (!_dict_polyfill.__module__) Object.defineProperties(_dict_polyfill, {
    __module__ : {value: "__main__"}
});

_dict_polyfill.prototype.set = (function() {
    var _anonfunc = function (x, value) {
        var key;
        key = _set_keyfor(x);
        if (!Object.prototype.hasOwnProperty.call(this._store, key)) {
            this.size += 1;
        }
        (_expr_temp = this._store)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = [x, value];
        return this;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x", "value"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.clear = (function() {
    var _anonfunc = function (x) {
        this._store = {};
        this.size = 0;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.delete = (function() {
    var _anonfunc = function (x) {
        var key;
        key = _set_keyfor(x);
        if (Object.prototype.hasOwnProperty.call(this._store, key)) {
            this.size -= 1;
            delete this._store[key];
            return true;
        }
        return false;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.has = (function() {
    var _anonfunc = function (x) {
        return Object.prototype.hasOwnProperty.call(this._store, _set_keyfor(x));
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.get = (function() {
    var _anonfunc = function (x) {
        try {
            return (_expr_temp = this._store)[_bound_index(_set_keyfor(x), _expr_temp)][1];
        } catch (_Exception) {
            _last_exception = _Exception;
            if (_Exception instanceof TypeError) {
                return undefined;
            } else {
                throw _Exception;
            }
        }
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.values = (function() {
    var _anonfunc = function (x) {
        var ans;
        ans = {'_keys': Object.keys(this._store), '_i':-1, '_s':this._store};
        ans[_iterator_symbol] = (function() {
            var _anonfunc = function () {
                return this;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i >= this._keys.length) {
                    return {'done': true};
                }
                return {'done':false, 'value':this._s[this._keys[this._i]][1]};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.keys = (function() {
    var _anonfunc = function (x) {
        var ans;
        ans = {'_keys': Object.keys(this._store), '_i':-1, '_s':this._store};
        ans[_iterator_symbol] = (function() {
            var _anonfunc = function () {
                return this;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i >= this._keys.length) {
                    return {'done': true};
                }
                return {'done':false, 'value':this._s[this._keys[this._i]][0]};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict_polyfill.prototype.entries = (function() {
    var _anonfunc = function (x) {
        var ans;
        ans = {'_keys': Object.keys(this._store), '_i':-1, '_s':this._store};
        ans[_iterator_symbol] = (function() {
            var _anonfunc = function () {
                return this;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        ans["next"] = (function() {
            var _anonfunc = function () {
                this._i += 1;
                if (this._i >= this._keys.length) {
                    return {'done': true};
                }
                return {'done':false, 'value':this._s[this._keys[this._i]]};
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
if (typeof Map !== "function" || typeof Map.prototype.delete !== "function") {
    _dict_implementation = _dict_polyfill;
} else {
    _dict_implementation = Map;
}
function _dict() {
    var iterable = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
    var kw = arguments[arguments.length-1];
    if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
    if (this instanceof _dict) {
        this.jsmap = new _dict_implementation;
        if (iterable !== undefined) {
            this.update(iterable);
        }
        this.update(kw);
        return this;
    } else {
        return _interpolate_kwargs_constructor.call(Object.create(_dict.prototype), false, _dict, [iterable].concat([_desugar_kwargs(kw)]));
    }
};
if (!_dict.__handles_kwarg_interpolation__) Object.defineProperties(_dict, {
    __handles_kwarg_interpolation__ : {value: true},
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

_dict.prototype.__name__ = "dict";
Object.defineProperties(_dict.prototype, (function(){
    var _d = {};
    _d["length"] = (function(){
        var _d = {};
        _d["get"] = (function() {
            var _anonfunc = function () {
                return this.jsmap.size;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return _d;
    }).call(this);
    _d["size"] = (function(){
        var _d = {};
        _d["get"] = (function() {
            var _anonfunc = function () {
                return this.jsmap.size;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
        return _d;
    }).call(this);
    return _d;
}).call(this));
_dict.prototype.__len__ = (function() {
    var _anonfunc = function () {
        return this.jsmap.size;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.has = _dict.prototype.__contains__ = (function() {
    var _anonfunc = function (x) {
        return this.jsmap.has(x);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["x"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.set = _dict.prototype.__setitem__ = (function() {
    var _anonfunc = function (key, value) {
        this.jsmap.set(key, value);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["key", "value"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.__delitem__ = (function() {
    var _anonfunc = function (key) {
        this.jsmap.delete(key);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["key"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.clear = (function() {
    var _anonfunc = function () {
        this.jsmap.clear();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.copy = (function() {
    var _anonfunc = function () {
        return _dict(this);
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.keys = (function() {
    var _anonfunc = function () {
        return this.jsmap.keys();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.values = (function() {
    var _anonfunc = function () {
        return this.jsmap.values();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.items = _dict.prototype.entries = (function() {
    var _anonfunc = function () {
        return this.jsmap.entries();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype[_iterator_symbol] = (function() {
    var _anonfunc = function () {
        return this.jsmap.keys();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.__getitem__ = (function() {
    var _anonfunc = function (key) {
        var ans;
        ans = this.jsmap.get(key);
        if (ans === undefined && !this.jsmap.has(key)) {
            throw new KeyError(key + "");
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["key"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.get = (function() {
    var _anonfunc = function (key, defval) {
        var ans;
        ans = this.jsmap.get(key);
        if (ans === undefined && !this.jsmap.has(key)) {
            return (defval === undefined) ? null : defval;
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["key", "defval"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.set_default = _dict.prototype.setdefault = (function() {
    var _anonfunc = function (key, defval) {
        var j;
        j = this.jsmap;
        if (!j.has(key)) {
            j.set(key, defval);
            return defval;
        }
        return j.get(key);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["key", "defval"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.fromkeys = _dict.prototype.fromkeys = (function() {
    var _anonfunc = function () {
        var iterable = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
        var value = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? _anonfunc.__defaults__.value : arguments[1];
        var _kwargs_obj = arguments[arguments.length-1];
        if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
        if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "value")){
            value = _kwargs_obj.value;
        }
        var ans, iterator, r;
        ans = _dict();
        iterator = iter(iterable);
        r = iterator.next();
        while (!r.done) {
            ans.set(r.value, value);
            r = iterator.next();
        }
        return ans;
    };
    if (!_anonfunc.__defaults__) Object.defineProperties(_anonfunc, {
        __defaults__ : {value: {value:null}},
        __handles_kwarg_interpolation__ : {value: true},
        __argnames__ : {value: ["iterable", "value"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.pop = (function() {
    var _anonfunc = function (key, defval) {
        var ans;
        ans = this.jsmap.get(key);
        if (ans === undefined && !this.jsmap.has(key)) {
            if (defval === undefined) {
                throw new KeyError(key);
            }
            return defval;
        }
        this.jsmap.delete(key);
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["key", "defval"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.popitem = (function() {
    var _anonfunc = function () {
        var last, e, r;
        last = null;
        e = this.jsmap.entries();
        while (true) {
            r = e.next();
            if (r.done) {
                if (last === null) {
                    throw new KeyError("dict is empty");
                }
                this.jsmap.delete(last.value[0]);
                return last.value;
            }
            last = r;
        }
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.update = (function() {
    var _anonfunc = function () {
        var m, iterable, iterator, result, keys;
        if (arguments.length === 0) {
            return;
        }
        m = this.jsmap;
        iterable = arguments[0];
        if (Array.isArray(iterable)) {
            for (var i = 0; i < iterable.length; i++) {
                m.set(iterable[(typeof i === "number" && i < 0) ? iterable.length + i : i][0], iterable[(typeof i === "number" && i < 0) ? iterable.length + i : i][1]);
            }
        } else if (iterable instanceof _dict) {
            iterator = iterable.items();
            result = iterator.next();
            while (!result.done) {
                m.set(result.value[0], result.value[1]);
                result = iterator.next();
            }
        } else if (typeof Map === "function" && iterable instanceof Map) {
            iterator = iterable.entries();
            result = iterator.next();
            while (!result.done) {
                m.set(result.value[0], result.value[1]);
                result = iterator.next();
            }
        } else if (typeof iterable[_iterator_symbol] === "function") {
            iterator = iterable[_iterator_symbol]();
            result = iterator.next();
            while (!result.done) {
                m.set(result.value[0], result.value[1]);
                result = iterator.next();
            }
        } else {
            keys = Object.keys(iterable);
            for (var j=0; j < keys.length; j++) {
                if (keys[(typeof j === "number" && j < 0) ? keys.length + j : j] !== _iterator_symbol) {
                    m.set(keys[(typeof j === "number" && j < 0) ? keys.length + j : j], iterable[_bound_index(keys[(typeof j === "number" && j < 0) ? keys.length + j : j], iterable)]);
                }
            }
        }
        if (arguments.length > 1) {
            _dict.prototype.update.call(this, arguments[1]);
        }
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.toString = _dict.prototype.inspect = _dict.prototype.__str__ = _dict.prototype.__repr__ = (function() {
    var _anonfunc = function () {
        var entries, iterator, r;
        entries = [];
        iterator = this.jsmap.entries();
        r = iterator.next();
        while (!r.done) {
            entries.push(_repr(r.value[0]) + ": " + _repr(r.value[1]));
            r = iterator.next();
        }
        return "{" + entries.join(", ") + "}";
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.__eq__ = (function() {
    var _anonfunc = function (other) {
        var iterator, r, x;
        if (!(other instanceof this.constructor)) {
            return false;
        }
        if (other.size !== this.size) {
            return false;
        }
        if (other.size === 0) {
            return true;
        }
        iterator = other.items();
        r = iterator.next();
        while (!r.done) {
            x = this.jsmap.get(r.value[0]);
            if (x === undefined && !this.jsmap.has(r.value[0]) || x !== r.value[1]) {
                return false;
            }
            r = iterator.next();
        }
        return true;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_dict.prototype.as_object = (function() {
    var _anonfunc = function (other) {
        var ans, iterator, r;
        ans = {};
        iterator = this.jsmap.entries();
        r = iterator.next();
        while (!r.done) {
            ans[_bound_index(r.value[0], ans)] = r.value[1];
            r = iterator.next();
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["other"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
function _dict_wrap(x) {
    var ans;
    ans = new _dict;
    ans.jsmap = x;
    return ans;
};
if (!_dict_wrap.__argnames__) Object.defineProperties(_dict_wrap, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

var dict = _dict, dict_wrap = _dict_wrap;// }}}
var NameError;
NameError = ReferenceError;
function Exception() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    Exception.prototype.__init__.apply(this, arguments);
}
_extends(Exception, Error);
Exception.prototype.__init__ = function __init__(message) {
    var self = this;
    self.message = message;
    self.stack = (new Error).stack;
    self.name = self.constructor.name;
};
if (!Exception.prototype.__init__.__argnames__) Object.defineProperties(Exception.prototype.__init__, {
    __argnames__ : {value: ["message"]},
    __module__ : {value: "__main__"}
});
Exception.__argnames__ = Exception.prototype.__init__.__argnames__;
Exception.__handles_kwarg_interpolation__ = Exception.prototype.__init__.__handles_kwarg_interpolation__;
Exception.prototype.__repr__ = function __repr__() {
    var self = this;
    return self.name + ": " + self.message;
};
if (!Exception.prototype.__repr__.__module__) Object.defineProperties(Exception.prototype.__repr__, {
    __module__ : {value: "__main__"}
});
Exception.prototype.__str__ = function __str__ () {
    if(Error.prototype.__str__) return Error.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(Exception.prototype, "__bases__", {value: [Error]});

function AttributeError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    AttributeError.prototype.__init__.apply(this, arguments);
}
_extends(AttributeError, Exception);
AttributeError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
AttributeError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
AttributeError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(AttributeError.prototype, "__bases__", {value: [Exception]});


function IndexError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    IndexError.prototype.__init__.apply(this, arguments);
}
_extends(IndexError, Exception);
IndexError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
IndexError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
IndexError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(IndexError.prototype, "__bases__", {value: [Exception]});


function KeyError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    KeyError.prototype.__init__.apply(this, arguments);
}
_extends(KeyError, Exception);
KeyError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
KeyError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
KeyError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(KeyError.prototype, "__bases__", {value: [Exception]});


function ValueError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    ValueError.prototype.__init__.apply(this, arguments);
}
_extends(ValueError, Exception);
ValueError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
ValueError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
ValueError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(ValueError.prototype, "__bases__", {value: [Exception]});


function UnicodeDecodeError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    UnicodeDecodeError.prototype.__init__.apply(this, arguments);
}
_extends(UnicodeDecodeError, Exception);
UnicodeDecodeError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
UnicodeDecodeError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
UnicodeDecodeError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(UnicodeDecodeError.prototype, "__bases__", {value: [Exception]});


function AssertionError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    AssertionError.prototype.__init__.apply(this, arguments);
}
_extends(AssertionError, Exception);
AssertionError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
AssertionError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
AssertionError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(AssertionError.prototype, "__bases__", {value: [Exception]});


function ZeroDivisionError() {
    if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
    ZeroDivisionError.prototype.__init__.apply(this, arguments);
}
_extends(ZeroDivisionError, Exception);
ZeroDivisionError.prototype.__init__ = function __init__ () {
    Exception.prototype.__init__ && Exception.prototype.__init__.apply(this, arguments);
};
ZeroDivisionError.prototype.__repr__ = function __repr__ () {
    if(Exception.prototype.__repr__) return Exception.prototype.__repr__.call(this);
    return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
};
ZeroDivisionError.prototype.__str__ = function __str__ () {
    if(Exception.prototype.__str__) return Exception.prototype.__str__.call(this);
return this.__repr__();
};
Object.defineProperty(ZeroDivisionError.prototype, "__bases__", {value: [Exception]});

var _in, _desugar_kwargs, _exists;
function _eslice(arr, step, start, end) {
    var is_string;
    if (typeof arr === "string" || arr instanceof String) {
        is_string = true;
        arr = arr.split("");
    }
    if (step < 0) {
        step = -step;
        arr = arr.slice().reverse();
        if (typeof start !== "undefined") {
            start = arr.length - start - 1;
        }
        if (typeof end !== "undefined") {
            end = arr.length - end - 1;
        }
    }
    if (typeof start === "undefined") {
        start = 0;
    }
    if (typeof end === "undefined") {
        end = arr.length;
    }
    arr = arr.slice(start, end).filter((function() {
        var _anonfunc = function (e, i) {
            return i % step === 0;
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["e", "i"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })());
    if (is_string) {
        arr = arr.join("");
    }
    return arr;
};
if (!_eslice.__argnames__) Object.defineProperties(_eslice, {
    __argnames__ : {value: ["arr", "step", "start", "end"]},
    __module__ : {value: "__main__"}
});

function _delslice(arr, step, start, end) {
    var is_string, _unpack, indices;
    if (typeof arr === "string" || arr instanceof String) {
        is_string = true;
        arr = arr.split("");
    }
    if (step < 0) {
        if (typeof start === "undefined") {
            start = arr.length;
        }
        if (typeof end === "undefined") {
            end = 0;
        }
        _unpack = [end, start, -step];
        start = _unpack[0];
        end = _unpack[1];
        step = _unpack[2];
    }
    if (typeof start === "undefined") {
        start = 0;
    }
    if (typeof end === "undefined") {
        end = arr.length;
    }
    if (step === 1) {
        arr.splice(start, end - start);
    } else {
        if (end > start) {
            indices = [];
            for (var i = start; i < end; i += step) {
                indices.push(i);
            }
            for (var i = indices.length - 1; i >= 0; i--) {
                arr.splice(indices[(typeof i === "number" && i < 0) ? indices.length + i : i], 1);
            }
        }
    }
    if (is_string) {
        arr = arr.join("");
    }
    return arr;
};
if (!_delslice.__argnames__) Object.defineProperties(_delslice, {
    __argnames__ : {value: ["arr", "step", "start", "end"]},
    __module__ : {value: "__main__"}
});

function _flatten(arr) {
    var ans, value;
    ans = _list_decorate([]);
    for (var i=0; i < arr.length; i++) {
        value = arr[(typeof i === "number" && i < 0) ? arr.length + i : i];
        if (Array.isArray(value)) {
            ans = ans.concat(_flatten(value));
        } else {
            ans.push(value);
        }
    }
    return ans;
};
if (!_flatten.__argnames__) Object.defineProperties(_flatten, {
    __argnames__ : {value: ["arr"]},
    __module__ : {value: "__main__"}
});

function _unpack_asarray(num, iterable) {
    var ans, iterator, result;
    if (_arraylike(iterable)) {
        return iterable;
    }
    ans = [];
    if (typeof iterable[_iterator_symbol] === "function") {
        iterator = (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
        result = iterator.next();
        while (!result.done && ans.length < num) {
            ans.push(result.value);
            result = iterator.next();
        }
    }
    return ans;
};
if (!_unpack_asarray.__argnames__) Object.defineProperties(_unpack_asarray, {
    __argnames__ : {value: ["num", "iterable"]},
    __module__ : {value: "__main__"}
});

function _extends(child, parent) {
    child.prototype = Object.create(parent.prototype);
    child.prototype.constructor = child;
};
if (!_extends.__argnames__) Object.defineProperties(_extends, {
    __argnames__ : {value: ["child", "parent"]},
    __module__ : {value: "__main__"}
});

_in = (function() {
    var _anonfunc = function () {
        if (typeof Map === "function" && typeof Set === "function") {
            return (function() {
                var _anonfunc = function (val, arr) {
                    if (typeof arr === "string") {
                        return arr.indexOf(val) !== -1;
                    }
                    if (typeof arr.__contains__ === "function") {
                        return arr.__contains__(val);
                    }
                    if (arr instanceof Map || arr instanceof Set) {
                        return arr.has(val);
                    }
                    if (_arraylike(arr)) {
                        return _list_contains.call(arr, val);
                    }
                    return Object.prototype.hasOwnProperty.call(arr, val);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["val", "arr"]},
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
        }
        return (function() {
            var _anonfunc = function (val, arr) {
                if (typeof arr === "string") {
                    return arr.indexOf(val) !== -1;
                }
                if (typeof arr.__contains__ === "function") {
                    return arr.__contains__(val);
                }
                if (_arraylike(arr)) {
                    return _list_contains.call(arr, val);
                }
                return Object.prototype.hasOwnProperty.call(arr, val);
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["val", "arr"]},
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})()();
function _Iterable(iterable) {
    var iterator, ans, result;
    if (_arraylike(iterable)) {
        return iterable;
    }
    if (typeof iterable[_iterator_symbol] === "function") {
        iterator = (typeof Map === "function" && iterable instanceof Map) ? iterable.keys() : iterable[_iterator_symbol]();
        ans = _list_decorate([]);
        result = iterator.next();
        while (!result.done) {
            ans.push(result.value);
            result = iterator.next();
        }
        return ans;
    }
    return Object.keys(iterable);
};
if (!_Iterable.__argnames__) Object.defineProperties(_Iterable, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

_desugar_kwargs = (function() {
    var _anonfunc = function () {
        if (typeof Object.assign === "function") {
            return (function() {
                var _anonfunc = function () {
                    var ans;
                    ans = Object.create(null);
                    ans[_kwargs_symbol] = true;
                    for (var i = 0; i < arguments.length; i++) {
                        Object.assign(ans, arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i]);
                    }
                    return ans;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
        }
        return (function() {
            var _anonfunc = function () {
                var ans, keys;
                ans = Object.create(null);
                ans[_kwargs_symbol] = true;
                for (var i = 0; i < arguments.length; i++) {
                    keys = Object.keys(arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i]);
                    for (var j = 0; j < keys.length; j++) {
                        ans[_bound_index(keys[(typeof j === "number" && j < 0) ? keys.length + j : j], ans)] = (_expr_temp = arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i])[_bound_index(keys[(typeof j === "number" && j < 0) ? keys.length + j : j], _expr_temp)];
                    }
                }
                return ans;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})()();
function _interpolate_kwargs(f, supplied_args) {
    var has_prop, kwobj, args, prop;
    if (!f.__argnames__) {
        return f.apply(this, supplied_args);
    }
    has_prop = Object.prototype.hasOwnProperty;
    kwobj = supplied_args.pop();
    if (f.__handles_kwarg_interpolation__) {
        args = new Array(Math.max(supplied_args.length, f.__argnames__.length) + 1);
        args[args.length-1] = kwobj;
        for (var i = 0; i < args.length - 1; i++) {
            if (i < f.__argnames__.length) {
                prop = (_expr_temp = f.__argnames__)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                if (has_prop.call(kwobj, prop)) {
                    args[(typeof i === "number" && i < 0) ? args.length + i : i] = kwobj[(typeof prop === "number" && prop < 0) ? kwobj.length + prop : prop];
                    delete kwobj[prop];
                } else if (i < supplied_args.length) {
                    args[(typeof i === "number" && i < 0) ? args.length + i : i] = supplied_args[(typeof i === "number" && i < 0) ? supplied_args.length + i : i];
                }
            } else {
                args[(typeof i === "number" && i < 0) ? args.length + i : i] = supplied_args[(typeof i === "number" && i < 0) ? supplied_args.length + i : i];
            }
        }
        return f.apply(this, args);
    }
    for (var i = 0; i < f.__argnames__.length; i++) {
        prop = (_expr_temp = f.__argnames__)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
        if (has_prop.call(kwobj, prop)) {
            supplied_args[(typeof i === "number" && i < 0) ? supplied_args.length + i : i] = kwobj[(typeof prop === "number" && prop < 0) ? kwobj.length + prop : prop];
        }
    }
    return f.apply(this, supplied_args);
};
if (!_interpolate_kwargs.__argnames__) Object.defineProperties(_interpolate_kwargs, {
    __argnames__ : {value: ["f", "supplied_args"]},
    __module__ : {value: "__main__"}
});

function _interpolate_kwargs_constructor(apply, f, supplied_args) {
    if (apply) {
        f.apply(this, supplied_args);
    } else {
        _interpolate_kwargs.call(this, f, supplied_args);
    }
    return this;
};
if (!_interpolate_kwargs_constructor.__argnames__) Object.defineProperties(_interpolate_kwargs_constructor, {
    __argnames__ : {value: ["apply", "f", "supplied_args"]},
    __module__ : {value: "__main__"}
});

function _getitem(obj, key) {
    if (obj.__getitem__) {
        return obj.__getitem__(key);
    }
    if (typeof key === "number" && key < 0) {
        key += obj.length;
    }
    return obj[(typeof key === "number" && key < 0) ? obj.length + key : key];
};
if (!_getitem.__argnames__) Object.defineProperties(_getitem, {
    __argnames__ : {value: ["obj", "key"]},
    __module__ : {value: "__main__"}
});

function _setitem(obj, key, val) {
    if (obj.__setitem__) {
        obj.__setitem__(key, val);
    } else {
        if (typeof key === "number" && key < 0) {
            key += obj.length;
        }
        obj[(typeof key === "number" && key < 0) ? obj.length + key : key] = val;
    }
    return val;
};
if (!_setitem.__argnames__) Object.defineProperties(_setitem, {
    __argnames__ : {value: ["obj", "key", "val"]},
    __module__ : {value: "__main__"}
});

function _delitem(obj, key) {
    if (obj.__delitem__) {
        obj.__delitem__(key);
    } else if (typeof obj.splice === "function") {
        obj.splice(key, 1);
    } else {
        if (typeof key === "number" && key < 0) {
            key += obj.length;
        }
        delete obj[key];
    }
};
if (!_delitem.__argnames__) Object.defineProperties(_delitem, {
    __argnames__ : {value: ["obj", "key"]},
    __module__ : {value: "__main__"}
});

function _bound_index(idx, arr) {
    if (typeof idx === "number" && idx < 0) {
        idx += arr.length;
    }
    return idx;
};
if (!_bound_index.__argnames__) Object.defineProperties(_bound_index, {
    __argnames__ : {value: ["idx", "arr"]},
    __module__ : {value: "__main__"}
});

function _splice(arr, val, start, end) {
    start = start || 0;
    if (start < 0) {
        start += arr.length;
    }
    if (end === undefined) {
        end = arr.length;
    }
    if (end < 0) {
        end += arr.length;
    }
    Array.prototype.splice.apply(arr, [start, end - start].concat(val));
};
if (!_splice.__argnames__) Object.defineProperties(_splice, {
    __argnames__ : {value: ["arr", "val", "start", "end"]},
    __module__ : {value: "__main__"}
});

_exists = (function(){
    var _d = {};
    _d["n"] = (function() {
        var _anonfunc = function (expr) {
            return expr !== undefined && expr !== null;
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["expr"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    _d["d"] = (function() {
        var _anonfunc = function (expr) {
            if (expr === undefined || expr === null) {
                return Object.create(null);
            }
            return expr;
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["expr"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    _d["c"] = (function() {
        var _anonfunc = function (expr) {
            if (typeof expr === "function") {
                return expr;
            }
            return (function() {
                var _anonfunc = function () {
                    return undefined;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["expr"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    _d["g"] = (function() {
        var _anonfunc = function (expr) {
            if (expr === undefined || expr === null || typeof expr.__getitem__ !== "function") {
                return (function(){
                    var _d = {};
                    _d["__getitem__"] = (function() {
                        var _anonfunc = function () {
                            return undefined;
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "__main__"}
                        });
                        return _anonfunc;
                    })();
                    return _d;
                }).call(this);
            }
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["expr"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    _d["e"] = (function() {
        var _anonfunc = function (expr, alt) {
            return (expr === undefined || expr === null) ? alt : expr;
        };
        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
            __argnames__ : {value: ["expr", "alt"]},
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    return _d;
}).call(this);
function _mixin() {
    var seen, resolved_props, p, target, props, name;
    seen = Object.create(null);
    seen.__argnames__ = seen.__handles_kwarg_interpolation__ = seen.__init__ = seen.__annotations__ = seen.__doc__ = seen.__bind_methods__ = seen.__bases__ = seen.constructor = seen.__class__ = true;
    resolved_props = {};
    p = target = arguments[0].prototype;
    while (p && p !== Object.prototype) {
        props = Object.getOwnPropertyNames(p);
        for (var i = 0; i < props.length; i++) {
            seen[_bound_index(props[(typeof i === "number" && i < 0) ? props.length + i : i], seen)] = true;
        }
        p = Object.getPrototypeOf(p);
    }
    for (var c = 1; c < arguments.length; c++) {
        p = arguments[(typeof c === "number" && c < 0) ? arguments.length + c : c].prototype;
        while (p && p !== Object.prototype) {
            props = Object.getOwnPropertyNames(p);
            for (var i = 0; i < props.length; i++) {
                name = props[(typeof i === "number" && i < 0) ? props.length + i : i];
                if (seen[(typeof name === "number" && name < 0) ? seen.length + name : name]) {
                    continue;
                }
                seen[(typeof name === "number" && name < 0) ? seen.length + name : name] = true;
                resolved_props[(typeof name === "number" && name < 0) ? resolved_props.length + name : name] = Object.getOwnPropertyDescriptor(p, name);
            }
            p = Object.getPrototypeOf(p);
        }
    }
    Object.defineProperties(target, resolved_props);
};
if (!_mixin.__module__) Object.defineProperties(_mixin, {
    __module__ : {value: "__main__"}
});

function _instanceof() {
    var obj, bases, q, cls, p;
    obj = arguments[0];
    bases = "";
    if (obj && obj.constructor && obj.constructor.prototype) {
        bases = obj.constructor.prototype.__bases__ || "";
    }
    for (var i = 1; i < arguments.length; i++) {
        q = arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i];
        if (obj instanceof q) {
            return true;
        }
        if ((q === Array || q === _list_constructor) && Array.isArray(obj)) {
            return true;
        }
        if (q === _str && (typeof obj === "string" || obj instanceof String)) {
            return true;
        }
        if (q === _int && typeof obj === "number" && Number.isInteger(obj)) {
            return true;
        }
        if (q === _float && typeof obj === "number" && !Number.isInteger(obj)) {
            return true;
        }
        if (bases.length > 1) {
            for (var c = 1; c < bases.length; c++) {
                cls = bases[(typeof c === "number" && c < 0) ? bases.length + c : c];
                while (cls) {
                    if (q === cls) {
                        return true;
                    }
                    p = Object.getPrototypeOf(cls.prototype);
                    if (!p) {
                        break;
                    }
                    cls = p.constructor;
                }
            }
        }
    }
    return false;
};
if (!_instanceof.__module__) Object.defineProperties(_instanceof, {
    __module__ : {value: "__main__"}
});
function sum(iterable, start) {
    var ans, iterator, r;
    if (Array.isArray(iterable)) {
        return iterable.reduce((function() {
            var _anonfunc = function (prev, cur) {
                return prev + cur;
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["prev", "cur"]},
                __module__ : {value: "__main__"}
            });
            return _anonfunc;
        })(), start || 0);
    }
    ans = start || 0;
    iterator = iter(iterable);
    r = iterator.next();
    while (!r.done) {
        ans += r.value;
        r = iterator.next();
    }
    return ans;
};
if (!sum.__argnames__) Object.defineProperties(sum, {
    __argnames__ : {value: ["iterable", "start"]},
    __module__ : {value: "__main__"}
});

function map() {
    var iterators, func, args, ans;
    iterators = new Array(arguments.length - 1);
    func = arguments[0];
    args = new Array(arguments.length - 1);
    for (var i = 1; i < arguments.length; i++) {
        iterators[_bound_index(i - 1, iterators)] = iter(arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i]);
    }
    ans = {'_func':func, '_iterators':iterators, '_args':args};
    ans[_iterator_symbol] = (function() {
        var _anonfunc = function () {
            return this;
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans["next"] = (function() {
        var _anonfunc = function () {
            var r;
            for (var i = 0; i < this._iterators.length; i++) {
                r = (_expr_temp = this._iterators)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i].next();
                if (r.done) {
                    return {'done':true};
                }
                (_expr_temp = this._args)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] = r.value;
            }
            return {'done':false, 'value':this._func.apply(undefined, this._args)};
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    return ans;
};
if (!map.__module__) Object.defineProperties(map, {
    __module__ : {value: "__main__"}
});

function filter(func_or_none, iterable) {
    var func, ans;
    func = (func_or_none === null) ? _bool : func_or_none;
    ans = {'_func':func, '_iterator':_iter(iterable)};
    ans[_iterator_symbol] = (function() {
        var _anonfunc = function () {
            return this;
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans["next"] = (function() {
        var _anonfunc = function () {
            var r;
            r = this._iterator.next();
            while (!r.done) {
                if (this._func(r.value)) {
                    return r;
                }
                r = this._iterator.next();
            }
            return {'done':true};
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    return ans;
};
if (!filter.__argnames__) Object.defineProperties(filter, {
    __argnames__ : {value: ["func_or_none", "iterable"]},
    __module__ : {value: "__main__"}
});

function zip() {
    var iterators, ans;
    iterators = new Array(arguments.length);
    for (var i = 0; i < arguments.length; i++) {
        iterators[(typeof i === "number" && i < 0) ? iterators.length + i : i] = iter(arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i]);
    }
    ans = {'_iterators':iterators};
    ans[_iterator_symbol] = (function() {
        var _anonfunc = function () {
            return this;
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    ans["next"] = (function() {
        var _anonfunc = function () {
            var args, r;
            args = new Array(this._iterators.length);
            for (var i = 0; i < this._iterators.length; i++) {
                r = (_expr_temp = this._iterators)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i].next();
                if (r.done) {
                    return {'done':true};
                }
                args[(typeof i === "number" && i < 0) ? args.length + i : i] = r.value;
            }
            return {'done':false, 'value':args};
        };
        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
            __module__ : {value: "__main__"}
        });
        return _anonfunc;
    })();
    return ans;
};
if (!zip.__module__) Object.defineProperties(zip, {
    __module__ : {value: "__main__"}
});

function any(iterable) {
    var i;
    var _Iter0 = _Iterable(iterable);
    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
        i = _Iter0[_Index0];
        if (i) {
            return true;
        }
    }
    return false;
};
if (!any.__argnames__) Object.defineProperties(any, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});

function all(iterable) {
    var i;
    var _Iter1 = _Iterable(iterable);
    for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
        i = _Iter1[_Index1];
        if (!i) {
            return false;
        }
    }
    return true;
};
if (!all.__argnames__) Object.defineProperties(all, {
    __argnames__ : {value: ["iterable"]},
    __module__ : {value: "__main__"}
});
var decimal_sep, define_str_func, _unpack, _orig_split, _orig_replace;
decimal_sep = 1.1.toLocaleString()[1];
function _repr_js_builtin(x, as_array) {
    var ans, b, keys, key;
    ans = [];
    b = "{}";
    if (as_array) {
        b = "[]";
        for (var i = 0; i < x.length; i++) {
            ans.push(_repr(x[(typeof i === "number" && i < 0) ? x.length + i : i]));
        }
    } else {
        keys = Object.keys(x);
        for (var k = 0; k < keys.length; k++) {
            key = keys[(typeof k === "number" && k < 0) ? keys.length + k : k];
            ans.push(JSON.stringify(key) + ":" + _repr(x[(typeof key === "number" && key < 0) ? x.length + key : key]));
        }
    }
    return b[0] + ans.join(", ") + b[1];
};
if (!_repr_js_builtin.__argnames__) Object.defineProperties(_repr_js_builtin, {
    __argnames__ : {value: ["x", "as_array"]},
    __module__ : {value: "__main__"}
});

function _html_element_to_string(elem) {
    var attrs, val, attr, ans;
    attrs = [];
    var _Iter0 = _Iterable(elem.attributes);
    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
        attr = _Iter0[_Index0];
        if (attr.specified) {
            val = attr.value;
            if (val.length > 10) {
                val = val.slice(0, 15) + "...";
            }
            val = JSON.stringify(val);
            attrs.push("" + _str.format("{}", attr.name) + "=" + _str.format("{}", val) + "");
        }
    }
    attrs = (attrs.length) ? " " + attrs.join(" ") : "";
    ans = "<" + _str.format("{}", elem.tagName) + "" + _str.format("{}", attrs) + ">";
    return ans;
};
if (!_html_element_to_string.__argnames__) Object.defineProperties(_html_element_to_string, {
    __argnames__ : {value: ["elem"]},
    __module__ : {value: "__main__"}
});

function _repr(x) {
    var ans, name;
    if (x === null) {
        return "None";
    }
    if (x === undefined) {
        return "undefined";
    }
    ans = x;
    if (typeof x.__repr__ === "function") {
        ans = x.__repr__();
    } else if (x === true || x === false) {
        ans = (x) ? "True" : "False";
    } else if (Array.isArray(x)) {
        ans = _repr_js_builtin(x, true);
    } else if (typeof x === "function") {
        ans = x.toString();
    } else if (typeof x === "object" && !x.toString) {
        ans = _repr_js_builtin(x);
    } else {
        name = Object.prototype.toString.call(x).slice(8, -1);
        if (_not_equals("Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".indexOf(name), -1)) {
            return name + "([" + x.map((function() {
                var _anonfunc = function (i) {
                    return str.format("0x{:02x}", i);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["i"]},
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })()).join(", ") + "])";
        }
        if (typeof HTMLElement !== "undefined" && x instanceof HTMLElement) {
            ans = _html_element_to_string(x);
        } else {
            ans = (typeof x.toString === "function") ? x.toString() : x;
        }
        if (ans === "[object Object]") {
            return _repr_js_builtin(x);
        }
        try {
            ans = JSON.stringify(x);
        } catch (_Exception) {
            _last_exception = _Exception;
            {
            } 
        }
    }
    return ans + "";
};
if (!_repr.__argnames__) Object.defineProperties(_repr, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

function _str(x) {
    var ans, name;
    if (x === null) {
        return "None";
    }
    if (x === undefined) {
        return "undefined";
    }
    ans = x;
    if (typeof x.__str__ === "function") {
        ans = x.__str__();
    } else if (typeof x.__repr__ === "function") {
        ans = x.__repr__();
    } else if (x === true || x === false) {
        ans = (x) ? "True" : "False";
    } else if (Array.isArray(x)) {
        ans = _repr_js_builtin(x, true);
    } else if (typeof x.toString === "function") {
        name = Object.prototype.toString.call(x).slice(8, -1);
        if (_not_equals("Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".indexOf(name), -1)) {
            return name + "([" + x.map((function() {
                var _anonfunc = function (i) {
                    return str.format("0x{:02x}", i);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["i"]},
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })()).join(", ") + "])";
        }
        if (typeof HTMLElement !== "undefined" && x instanceof HTMLElement) {
            ans = _html_element_to_string(x);
        } else {
            ans = x.toString();
        }
        if (ans === "[object Object]") {
            ans = _repr_js_builtin(x);
        }
    } else if (typeof x === "object" && !x.toString) {
        ans = _repr_js_builtin(x);
    }
    return ans + "";
};
if (!_str.__argnames__) Object.defineProperties(_str, {
    __argnames__ : {value: ["x"]},
    __module__ : {value: "__main__"}
});

define_str_func = (function() {
    var _anonfunc = function (name, func) {
        var f;
        (_expr_temp = _str.prototype)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = func;
        _str[(typeof name === "number" && name < 0) ? _str.length + name : name] = f = func.call.bind(func);
        if (func.__argnames__) {
            Object.defineProperty(f, "__argnames__", (function(){
                var _d = {};
                _d["value"] = ['string'].concat(func.__argnames__);
                return _d;
            }).call(this));
        }
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["name", "func"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_unpack = [String.prototype.split.call.bind(String.prototype.split), String.prototype.replace.call.bind(String.prototype.replace)];
_orig_split = _unpack[0];
_orig_replace = _unpack[1];
define_str_func("format", (function() {
    var _anonfunc = function () {
        var template, args, kwargs, explicit, implicit, idx, split, ans, pos, in_brace, markup, ch;
        template = this;
        if (template === undefined) {
            throw new TypeError("Template is required");
        }
        args = Array.prototype.slice.call(arguments);
        kwargs = {};
        if (args[args.length-1] && args[args.length-1][_kwargs_symbol] !== undefined) {
            kwargs = args[args.length-1];
            args = args.slice(0, -1);
        }
        explicit = implicit = false;
        idx = 0;
        split = _orig_split;
        if (_str.format._template_resolve_pat === undefined) {
            _str.format._template_resolve_pat = /[.\[]/;
        }
        function resolve(arg, object) {
            var _unpack, first, key, rest, ans;
            if (!arg) {
                return object;
            }
            _unpack = [arg[0], arg.slice(1)];
            first = _unpack[0];
            arg = _unpack[1];
            key = split(arg, _str.format._template_resolve_pat, 1)[0];
            rest = arg.slice(key.length);
            ans = (first === "[") ? object[_bound_index(key.slice(0, -1), object)] : getattr(object, key);
            if (ans === undefined) {
                throw new KeyError((first === "[") ? key.slice(0, -1) : key);
            }
            return resolve(rest, ans);
        };
        if (!resolve.__argnames__) Object.defineProperties(resolve, {
            __argnames__ : {value: ["arg", "object"]},
            __module__ : {value: "__main__"}
        });

        function resolve_format_spec(format_spec) {
            if (_str.format._template_resolve_fs_pat === undefined) {
                _str.format._template_resolve_fs_pat = /[{]([a-zA-Z0-9_]+)[}]/g;
            }
            return format_spec.replace(_str.format._template_resolve_fs_pat, (function() {
                var _anonfunc = function (match, key) {
                    if (!Object.prototype.hasOwnProperty.call(kwargs, key)) {
                        return "";
                    }
                    return "" + kwargs[(typeof key === "number" && key < 0) ? kwargs.length + key : key];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["match", "key"]},
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })());
        };
        if (!resolve_format_spec.__argnames__) Object.defineProperties(resolve_format_spec, {
            __argnames__ : {value: ["format_spec"]},
            __module__ : {value: "__main__"}
        });

        function set_comma(ans, comma) {
            var sep;
            if (comma !== ",") {
                sep = 1234;
                sep = sep.toLocaleString(undefined, {useGrouping: true})[1];
                ans = str.replace(ans, sep, comma);
            }
            return ans;
        };
        if (!set_comma.__argnames__) Object.defineProperties(set_comma, {
            __argnames__ : {value: ["ans", "comma"]},
            __module__ : {value: "__main__"}
        });

        function safe_comma(value, comma) {
            try {
                return set_comma(value.toLocaleString(undefined, {useGrouping: true}), comma);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    return value.toString(10);
                } 
            }
        };
        if (!safe_comma.__argnames__) Object.defineProperties(safe_comma, {
            __argnames__ : {value: ["value", "comma"]},
            __module__ : {value: "__main__"}
        });

        function safe_fixed(value, precision, comma) {
            if (!comma) {
                return value.toFixed(precision);
            }
            try {
                return set_comma(value.toLocaleString(undefined, {useGrouping: true, minimumFractionDigits: precision, maximumFractionDigits: precision}), comma);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    return value.toFixed(precision);
                } 
            }
        };
        if (!safe_fixed.__argnames__) Object.defineProperties(safe_fixed, {
            __argnames__ : {value: ["value", "precision", "comma"]},
            __module__ : {value: "__main__"}
        });

        function apply_formatting(value, format_spec) {
            var _unpack, fill, align, sign, fhash, zeropad, width, comma, precision, ftype, is_numeric, is_int, lftype, code, prec, exp, nval, is_positive, left, right;
            if (format_spec.indexOf("{") !== -1) {
                format_spec = resolve_format_spec(format_spec);
            }
            if (_str.format._template_format_pat === undefined) {
                _str.format._template_format_pat = /([^{}](?=[<>=^]))?([<>=^])?([-+\x20])?(\#)?(0)?(\d+)?([,_])?(?:\.(\d+))?([bcdeEfFgGnosxX%])?/;
            }
            try {
                _unpack = format_spec.match(_str.format._template_format_pat).slice(1);
_unpack = _unpack_asarray(9, _unpack);
                fill = _unpack[0];
                align = _unpack[1];
                sign = _unpack[2];
                fhash = _unpack[3];
                zeropad = _unpack[4];
                width = _unpack[5];
                comma = _unpack[6];
                precision = _unpack[7];
                ftype = _unpack[8];
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof TypeError) {
                    return value;
                } else {
                    throw _Exception;
                }
            }
            if (zeropad) {
                fill = fill || "0";
                align = align || "=";
            } else {
                fill = fill || " ";
                align = align || ">";
            }
            is_numeric = Number(value) === value;
            is_int = is_numeric && value % 1 === 0;
            precision = parseInt(precision, 10);
            lftype = (ftype || "").toLowerCase();
            if (ftype === "n") {
                is_numeric = true;
                if (is_int) {
                    if (comma) {
                        throw new ValueError("Cannot specify ',' with 'n'");
                    }
                    value = parseInt(value, 10).toLocaleString();
                } else {
                    value = parseFloat(value).toLocaleString();
                }
            } else if (['b', 'c', 'd', 'o', 'x'].indexOf(lftype) !== -1) {
                value = parseInt(value, 10);
                is_numeric = true;
                if (!isNaN(value)) {
                    if (ftype === "b") {
                        value = (value >>> 0).toString(2);
                        if (fhash) {
                            value = "0b" + value;
                        }
                    } else if (ftype === "c") {
                        if (value > 65535) {
                            code = value - 65536;
                            value = String.fromCharCode(55296 + (code >> 10), 56320 + (code & 1023));
                        } else {
                            value = String.fromCharCode(value);
                        }
                    } else if (ftype === "d") {
                        if (comma) {
                            value = safe_comma(value, comma);
                        } else {
                            value = value.toString(10);
                        }
                    } else if (ftype === "o") {
                        value = value.toString(8);
                        if (fhash) {
                            value = "0o" + value;
                        }
                    } else if (lftype === "x") {
                        value = value.toString(16);
                        value = (ftype === "x") ? value.toLowerCase() : value.toUpperCase();
                        if (fhash) {
                            value = "0x" + value;
                        }
                    }
                }
            } else if (['e','f','g','%'].indexOf(lftype) !== -1) {
                is_numeric = true;
                value = parseFloat(value);
                prec = (isNaN(precision)) ? 6 : precision;
                if (lftype === "e") {
                    value = value.toExponential(prec);
                    value = (ftype === "E") ? value.toUpperCase() : value.toLowerCase();
                } else if (lftype === "f") {
                    value = safe_fixed(value, prec, comma);
                    value = (ftype === "F") ? value.toUpperCase() : value.toLowerCase();
                } else if (lftype === "%") {
                    value *= 100;
                    value = safe_fixed(value, prec, comma) + "%";
                } else if (lftype === "g") {
                    prec = max(1, prec);
                    exp = parseInt(split(value.toExponential(prec - 1).toLowerCase(), "e")[1], 10);
                    if (-4 <= exp && exp < prec) {
                        value = safe_fixed(value, prec - 1 - exp, comma);
                    } else {
                        value = value.toExponential(prec - 1);
                    }
                    value = value.replace(/0+$/g, "");
                    if (value[value.length-1] === decimal_sep) {
                        value = value.slice(0, -1);
                    }
                    if (ftype === "G") {
                        value = value.toUpperCase();
                    }
                }
            } else {
                if (comma) {
                    value = parseInt(value, 10);
                    if (isNaN(value)) {
                        throw new ValueError("Must use numbers with , or _");
                    }
                    value = safe_comma(value, comma);
                }
                value += "";
                if (!isNaN(precision)) {
                    value = value.slice(0, precision);
                }
            }
            value += "";
            if (is_numeric && sign) {
                nval = Number(value);
                is_positive = !isNaN(nval) && nval >= 0;
                if (is_positive && (sign === " " || sign === "+")) {
                    value = sign + value;
                }
            }
            function repeat(char, num) {
                return (new Array(num+1)).join(char);
            };
            if (!repeat.__argnames__) Object.defineProperties(repeat, {
                __argnames__ : {value: ["char", "num"]},
                __module__ : {value: "__main__"}
            });

            if (is_numeric && width && width[0] === "0") {
                width = width.slice(1);
                _unpack = ["0", "="];
                fill = _unpack[0];
                align = _unpack[1];
            }
            width = parseInt(width || "-1", 10);
            if (isNaN(width)) {
                throw new ValueError("Invalid width specification: " + width);
            }
            if (fill && value.length < width) {
                if (align === "<") {
                    value = value + repeat(fill, width - value.length);
                } else if (align === ">") {
                    value = repeat(fill, width - value.length) + value;
                } else if (align === "^") {
                    left = Math.floor((width - value.length) / 2);
                    right = width - left - value.length;
                    value = repeat(fill, left) + value + repeat(fill, right);
                } else if (align === "=") {
                    if (_in(value[0], "+- ")) {
                        value = value[0] + repeat(fill, width - value.length) + value.slice(1);
                    } else {
                        value = repeat(fill, width - value.length) + value;
                    }
                } else {
                    throw new ValueError("Unrecognized alignment: " + align);
                }
            }
            return value;
        };
        if (!apply_formatting.__argnames__) Object.defineProperties(apply_formatting, {
            __argnames__ : {value: ["value", "format_spec"]},
            __module__ : {value: "__main__"}
        });

        function parse_markup(markup) {
            var key, transformer, format_spec, pos, state, ch;
            key = transformer = format_spec = "";
            pos = 0;
            state = 0;
            while (pos < markup.length) {
                ch = markup[(typeof pos === "number" && pos < 0) ? markup.length + pos : pos];
                if (state === 0) {
                    if (ch === "!") {
                        state = 1;
                    } else if (ch === ":") {
                        state = 2;
                    } else {
                        key += ch;
                    }
                } else if (state === 1) {
                    if (ch === ":") {
                        state = 2;
                    } else {
                        transformer += ch;
                    }
                } else {
                    format_spec += ch;
                }
                pos += 1;
            }
            return [key, transformer, format_spec];
        };
        if (!parse_markup.__argnames__) Object.defineProperties(parse_markup, {
            __argnames__ : {value: ["markup"]},
            __module__ : {value: "__main__"}
        });

        function render_markup(markup) {
            var _unpack, key, transformer, format_spec, ends_with_equal, lkey, nvalue, object, ans;
            _unpack = parse_markup(markup);
_unpack = _unpack_asarray(3, _unpack);
            key = _unpack[0];
            transformer = _unpack[1];
            format_spec = _unpack[2];
            if (transformer && ['a', 'r', 's'].indexOf(transformer) === -1) {
                throw new ValueError("Unknown conversion specifier: " + transformer);
            }
            ends_with_equal = key.endsWith("=");
            if (ends_with_equal) {
                key = key.slice(0, -1);
            }
            lkey = key.length && split(key, /[.\[]/, 1)[0];
            if (lkey) {
                explicit = true;
                if (implicit) {
                    throw new ValueError("cannot switch from automatic field numbering to manual field specification");
                }
                nvalue = parseInt(lkey);
                object = (isNaN(nvalue)) ? kwargs[(typeof lkey === "number" && lkey < 0) ? kwargs.length + lkey : lkey] : args[(typeof nvalue === "number" && nvalue < 0) ? args.length + nvalue : nvalue];
                if (object === undefined) {
                    if (isNaN(nvalue)) {
                        throw new KeyError(lkey);
                    }
                    throw new IndexError(lkey);
                }
                object = resolve(key.slice(lkey.length), object);
            } else {
                implicit = true;
                if (explicit) {
                    throw new ValueError("cannot switch from manual field specification to automatic field numbering");
                }
                if (idx >= args.length) {
                    throw new IndexError("Not enough arguments to match template: " + template);
                }
                object = args[(typeof idx === "number" && idx < 0) ? args.length + idx : idx];
                idx += 1;
            }
            if (typeof object === "function") {
                object = object();
            }
            ans = "" + object;
            if (format_spec) {
                ans = apply_formatting(ans, format_spec);
            }
            if (ends_with_equal) {
                ans = "" + _str.format("{}", key) + "=" + _str.format("{}", ans) + "";
            }
            return ans;
        };
        if (!render_markup.__argnames__) Object.defineProperties(render_markup, {
            __argnames__ : {value: ["markup"]},
            __module__ : {value: "__main__"}
        });

        ans = "";
        pos = 0;
        in_brace = 0;
        markup = "";
        while (pos < template.length) {
            ch = template[(typeof pos === "number" && pos < 0) ? template.length + pos : pos];
            if (in_brace) {
                if (ch === "{") {
                    in_brace += 1;
                    markup += "{";
                } else if (ch === "}") {
                    in_brace -= 1;
                    if (in_brace > 0) {
                        markup += "}";
                    } else {
                        ans += render_markup(markup);
                    }
                } else {
                    markup += ch;
                }
            } else {
                if (ch === "{") {
                    if (template[_bound_index(pos + 1, template)] === "{") {
                        pos += 1;
                        ans += "{";
                    } else {
                        in_brace = 1;
                        markup = "";
                    }
                } else {
                    ans += ch;
                    if (ch === "}" && template[_bound_index(pos + 1, template)] === "}") {
                        pos += 1;
                    }
                }
            }
            pos += 1;
        }
        if (in_brace) {
            throw new ValueError("expected '}' before end of string");
        }
        return ans;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("capitalize", (function() {
    var _anonfunc = function () {
        var string;
        string = this;
        if (string) {
            string = string[0].toUpperCase() + string.slice(1).toLowerCase();
        }
        return string;
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("center", (function() {
    var _anonfunc = function (width, fill) {
        var left, right;
        left = Math.floor((width - this.length) / 2);
        right = width - left - this.length;
        fill = fill || " ";
        return new Array(left+1).join(fill) + this + new Array(right+1).join(fill);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["width", "fill"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("count", (function() {
    var _anonfunc = function (needle, start, end) {
        var string, _unpack, pos, step, ans;
        string = this;
        start = start || 0;
        end = end || string.length;
        if (start < 0 || end < 0) {
            string = string.slice(start, end);
            _unpack = [0, string.length];
            start = _unpack[0];
            end = _unpack[1];
        }
        pos = start;
        step = needle.length;
        if (!step) {
            return 0;
        }
        ans = 0;
        while (pos !== -1) {
            pos = string.indexOf(needle, pos);
            if (pos !== -1) {
                ans += 1;
                pos += step;
            }
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["needle", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("endswith", (function() {
    var _anonfunc = function (suffixes, start, end) {
        var string, q;
        string = this;
        start = start || 0;
        if (typeof suffixes === "string") {
            suffixes = [suffixes];
        }
        if (end !== undefined) {
            string = string.slice(0, end);
        }
        for (var i = 0; i < suffixes.length; i++) {
            q = suffixes[(typeof i === "number" && i < 0) ? suffixes.length + i : i];
            if (string.indexOf(q, Math.max(start, string.length - q.length)) !== -1) {
                return true;
            }
        }
        return false;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["suffixes", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("startswith", (function() {
    var _anonfunc = function (prefixes, start, end) {
        var prefix;
        start = start || 0;
        if (typeof prefixes === "string") {
            prefixes = [prefixes];
        }
        for (var i = 0; i < prefixes.length; i++) {
            prefix = prefixes[(typeof i === "number" && i < 0) ? prefixes.length + i : i];
            end = (end === undefined) ? this.length : end;
            if (end - start >= prefix.length && prefix === this.slice(start, start + prefix.length)) {
                return true;
            }
        }
        return false;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["prefixes", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("find", (function() {
    var _anonfunc = function (needle, start, end) {
        var ans;
        while (start < 0) {
            start += this.length;
        }
        ans = this.indexOf(needle, start);
        if (end !== undefined && ans !== -1) {
            while (end < 0) {
                end += this.length;
            }
            if (ans >= end - needle.length) {
                return -1;
            }
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["needle", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("rfind", (function() {
    var _anonfunc = function (needle, start, end) {
        var ans;
        while (end < 0) {
            end += this.length;
        }
        ans = this.lastIndexOf(needle, end - 1);
        if (start !== undefined && ans !== -1) {
            while (start < 0) {
                start += this.length;
            }
            if (ans < start) {
                return -1;
            }
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["needle", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("index", (function() {
    var _anonfunc = function (needle, start, end) {
        var ans;
        ans = _str.prototype.find.apply(this, arguments);
        if (ans === -1) {
            throw new ValueError("substring not found");
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["needle", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("rindex", (function() {
    var _anonfunc = function (needle, start, end) {
        var ans;
        ans = _str.prototype.rfind.apply(this, arguments);
        if (ans === -1) {
            throw new ValueError("substring not found");
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["needle", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("islower", (function() {
    var _anonfunc = function () {
        return this.length > 0 && this.toLowerCase() === this.toString();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("isupper", (function() {
    var _anonfunc = function () {
        return this.length > 0 && this.toUpperCase() === this.toString();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("isspace", (function() {
    var _anonfunc = function () {
        return this.length > 0 && /^\s+$/.test(this);
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("join", (function() {
    var _anonfunc = function (iterable) {
        var ans, r;
        if (Array.isArray(iterable)) {
            return iterable.join(this);
        }
        ans = "";
        r = iterable.next();
        while (!r.done) {
            if (ans) {
                ans += this;
            }
            ans += r.value;
            r = iterable.next();
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["iterable"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("ljust", (function() {
    var _anonfunc = function (width, fill) {
        var string;
        string = this;
        if (width > string.length) {
            fill = fill || " ";
            string += new Array(width - string.length + 1).join(fill);
        }
        return string;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["width", "fill"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("rjust", (function() {
    var _anonfunc = function (width, fill) {
        var string;
        string = this;
        if (width > string.length) {
            fill = fill || " ";
            string = new Array(width - string.length + 1).join(fill) + string;
        }
        return string;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["width", "fill"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("lower", (function() {
    var _anonfunc = function () {
        return this.toLowerCase();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("upper", (function() {
    var _anonfunc = function () {
        return this.toUpperCase();
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("lstrip", (function() {
    var _anonfunc = function (chars) {
        var string, pos;
        string = this;
        pos = 0;
        chars = chars || _str.whitespace;
        while (chars.indexOf(string[(typeof pos === "number" && pos < 0) ? string.length + pos : pos]) !== -1) {
            pos += 1;
        }
        if (pos) {
            string = string.slice(pos);
        }
        return string;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["chars"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("rstrip", (function() {
    var _anonfunc = function (chars) {
        var string, pos;
        string = this;
        pos = string.length - 1;
        chars = chars || _str.whitespace;
        while (chars.indexOf(string[(typeof pos === "number" && pos < 0) ? string.length + pos : pos]) !== -1) {
            pos -= 1;
        }
        if (pos < string.length - 1) {
            string = string.slice(0, pos + 1);
        }
        return string;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["chars"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("strip", (function() {
    var _anonfunc = function (chars) {
        return _str.prototype.lstrip.call(_str.prototype.rstrip.call(this, chars), chars);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["chars"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("partition", (function() {
    var _anonfunc = function (sep) {
        var idx;
        idx = this.indexOf(sep);
        if (idx === -1) {
            return [this, "", ""];
        }
        return [this.slice(0, idx), sep, this.slice(idx + sep.length)];
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["sep"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("rpartition", (function() {
    var _anonfunc = function (sep) {
        var idx;
        idx = this.lastIndexOf(sep);
        if (idx === -1) {
            return ["", "", this];
        }
        return [this.slice(0, idx), sep, this.slice(idx + sep.length)];
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["sep"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("replace", (function() {
    var _anonfunc = function (old, repl, count) {
        var string, pos, idx;
        string = this;
        if (count === 1) {
            return _orig_replace(string, old, repl);
        }
        if (count < 1) {
            return string;
        }
        count = count || Number.MAX_VALUE;
        pos = 0;
        while (count > 0) {
            count -= 1;
            idx = string.indexOf(old, pos);
            if (idx === -1) {
                break;
            }
            pos = idx + repl.length;
            string = string.slice(0, idx) + repl + string.slice(idx + old.length);
        }
        return string;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["old", "repl", "count"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("split", (function() {
    var _anonfunc = function (sep, maxsplit) {
        var split, ans, extra, parts;
        if (maxsplit === 0) {
            return _list_decorate([ this ]);
        }
        split = _orig_split;
        if (sep === undefined || sep === null) {
            if (maxsplit > 0) {
                ans = split(this, /(\s+)/);
                extra = "";
                parts = [];
                for (var i = 0; i < ans.length; i++) {
                    if (parts.length >= maxsplit + 1) {
                        extra += ans[(typeof i === "number" && i < 0) ? ans.length + i : i];
                    } else if (i % 2 === 0) {
                        parts.push(ans[(typeof i === "number" && i < 0) ? ans.length + i : i]);
                    }
                }
                parts[parts.length-1] += extra;
                ans = parts;
            } else {
                ans = split(this, /\s+/);
            }
        } else {
            if (sep === "") {
                throw new ValueError("empty separator");
            }
            ans = split(this, sep);
            if (maxsplit > 0 && ans.length > maxsplit) {
                extra = ans.slice(maxsplit).join(sep);
                ans = ans.slice(0, maxsplit);
                ans.push(extra);
            }
        }
        return _list_decorate(ans);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["sep", "maxsplit"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("rsplit", (function() {
    var _anonfunc = function (sep, maxsplit) {
        var split, ans, is_space, pos, current, spc, ch, end, idx;
        if (!maxsplit) {
            return _str.prototype.split.call(this, sep);
        }
        split = _orig_split;
        if (sep === undefined || sep === null) {
            if (maxsplit > 0) {
                ans = [];
                is_space = /\s/;
                pos = this.length - 1;
                current = "";
                while (pos > -1 && maxsplit > 0) {
                    spc = false;
                    ch = (_expr_temp = this)[(typeof pos === "number" && pos < 0) ? _expr_temp.length + pos : pos];
                    while (pos > -1 && is_space.test(ch)) {
                        spc = true;
                        ch = this[--pos];
                    }
                    if (spc) {
                        if (current) {
                            ans.push(current);
                            maxsplit -= 1;
                        }
                        current = ch;
                    } else {
                        current += ch;
                    }
                    pos -= 1;
                }
                ans.push(this.slice(0, pos + 1) + current);
                ans.reverse();
            } else {
                ans = split(this, /\s+/);
            }
        } else {
            if (sep === "") {
                throw new ValueError("empty separator");
            }
            ans = [];
            pos = end = this.length;
            while (pos > -1 && maxsplit > 0) {
                maxsplit -= 1;
                idx = this.lastIndexOf(sep, pos);
                if (idx === -1) {
                    break;
                }
                ans.push(this.slice(idx + sep.length, end));
                pos = idx - 1;
                end = idx;
            }
            ans.push(this.slice(0, end));
            ans.reverse();
        }
        return _list_decorate(ans);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["sep", "maxsplit"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("splitlines", (function() {
    var _anonfunc = function (keepends) {
        var split, parts, ans;
        split = _orig_split;
        if (keepends) {
            parts = split(this, /((?:\r?\n)|\r)/);
            ans = [];
            for (var i = 0; i < parts.length; i++) {
                if (i % 2 === 0) {
                    ans.push(parts[(typeof i === "number" && i < 0) ? parts.length + i : i]);
                } else {
                    ans[ans.length-1] += parts[(typeof i === "number" && i < 0) ? parts.length + i : i];
                }
            }
        } else {
            ans = split(this, /(?:\r?\n)|\r/);
        }
        return _list_decorate(ans);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["keepends"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("swapcase", (function() {
    var _anonfunc = function () {
        var ans, a, b;
        ans = new Array(this.length);
        for (var i = 0; i < ans.length; i++) {
            a = (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
            b = a.toLowerCase();
            if (a === b) {
                b = a.toUpperCase();
            }
            ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = b;
        }
        return ans.join("");
    };
    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
define_str_func("zfill", (function() {
    var _anonfunc = function (width) {
        var string;
        string = this;
        if (width > string.length) {
            string = new Array(width - string.length + 1).join("0") + string;
        }
        return string;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["width"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})());
_str.uchrs = (function() {
    var _anonfunc = function (string, with_positions) {
        return (function(){
            var _d = {};
            _d["_string"] = string;
            _d["_pos"] = 0;
            _d[_iterator_symbol] = (function() {
                var _anonfunc = function () {
                    return this;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
            _d["next"] = (function() {
                var _anonfunc = function () {
                    var length, pos, value, ans, extra;
                    length = this._string.length;
                    if (this._pos >= length) {
                        return (function(){
                            var _d = {};
                            _d["done"] = true;
                            return _d;
                        }).call(this);
                    }
                    pos = this._pos;
                    value = this._string.charCodeAt(this._pos++);
                    ans = "\ufffd";
                    if (55296 <= value && value <= 56319) {
                        if (this._pos < length) {
                            extra = this._string.charCodeAt(this._pos++);
                            if ((extra & 56320) === 56320) {
                                ans = String.fromCharCode(value, extra);
                            }
                        }
                    } else if ((value & 56320) !== 56320) {
                        ans = String.fromCharCode(value);
                    }
                    if (with_positions) {
                        return (function(){
                            var _d = {};
                            _d["done"] = false;
                            _d["value"] = _list_decorate([ pos, ans ]);
                            return _d;
                        }).call(this);
                    } else {
                        return (function(){
                            var _d = {};
                            _d["done"] = false;
                            _d["value"] = ans;
                            return _d;
                        }).call(this);
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "__main__"}
                });
                return _anonfunc;
            })();
            return _d;
        }).call(this);
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["string", "with_positions"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_str.uslice = (function() {
    var _anonfunc = function (string, start, end) {
        var items, iterator, r;
        items = [];
        iterator = _str.uchrs(string);
        r = iterator.next();
        while (!r.done) {
            items.push(r.value);
            r = iterator.next();
        }
        return items.slice(start || 0, (end === undefined) ? items.length : end).join("");
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["string", "start", "end"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_str.ulen = (function() {
    var _anonfunc = function (string) {
        var iterator, r, ans;
        iterator = _str.uchrs(string);
        r = iterator.next();
        ans = 0;
        while (!r.done) {
            r = iterator.next();
            ans += 1;
        }
        return ans;
    };
    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
        __argnames__ : {value: ["string"]},
        __module__ : {value: "__main__"}
    });
    return _anonfunc;
})();
_str.ascii_lowercase = "abcdefghijklmnopqrstuvwxyz";
_str.ascii_uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
_str.ascii_letters = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
_str.digits = "0123456789";
_str.punctuation = "!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~";
_str.printable = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~ \t\n\r\u000b\f";
_str.whitespace = " \t\n\r\u000b\f";
define_str_func = undefined;
var str = _str, repr = _repr;;
    var _modules = {};
    _modules.pythonize = {};
    _modules.initialize = {};
    _modules.gettext = {};
    _modules.ajax = {};
    _modules.autoreload = {};
    _modules.book_list = {};
    _modules["book_list.globals"] = {};
    _modules.traceback = {};
    _modules.elementmaker = {};
    _modules.dom = {};
    _modules["book_list.theme"] = {};
    _modules.popups = {};
    _modules.encodings = {};
    _modules.utils = {};
    _modules.widgets = {};
    _modules.modals = {};
    _modules.uuid = {};
    _modules.session = {};
    _modules["book_list.constants"] = {};
    _modules["book_list.cover_grid"] = {};
    _modules.lru_cache = {};
    _modules["book_list.library_data"] = {};
    _modules["book_list.router"] = {};
    _modules["book_list.top_bar"] = {};
    _modules["book_list.ui"] = {};
    _modules["book_list.home"] = {};
    _modules.read_book = {};
    _modules.aes = {};
    _modules["read_book.globals"] = {};
    _modules["read_book.viewport"] = {};
    _modules["read_book.cfi"] = {};
    _modules["read_book.annotations"] = {};
    _modules["read_book.db"] = {};
    _modules["read_book.tts"] = {};
    _modules.fs_images = {};
    _modules.iframe_comm = {};
    _modules.range_utils = {};
    _modules["read_book.anchor_visibility"] = {};
    _modules["read_book.extract"] = {};
    _modules["read_book.find"] = {};
    _modules["read_book.settings"] = {};
    _modules["read_book.flow_mode"] = {};
    _modules["read_book.resources"] = {};
    _modules["read_book.footnotes"] = {};
    _modules["read_book.touch"] = {};
    _modules["read_book.gestures"] = {};
    _modules.complete = {};
    _modules["read_book.highlights"] = {};
    _modules["read_book.shortcuts"] = {};
    _modules["read_book.hints"] = {};
    _modules["read_book.mathjax"] = {};
    _modules["read_book.paged_mode"] = {};
    _modules["read_book.referencing"] = {};
    _modules["read_book.smil"] = {};
    _modules["read_book.toc"] = {};
    _modules.select = {};
    _modules["read_book.iframe"] = {};
    _modules["book_list.item_list"] = {};
    _modules["read_book.bookmarks"] = {};
    _modules["read_book.content_popup"] = {};
    _modules["read_book.prefs"] = {};
    _modules["read_book.prefs.utils"] = {};
    _modules["read_book.prefs.head_foot"] = {};
    _modules["read_book.goto"] = {};
    _modules["read_book.open_book"] = {};
    _modules.file_uploads = {};
    _modules["book_list.add"] = {};
    _modules["book_list.delete_book"] = {};
    _modules["book_list.details_list"] = {};
    _modules.date = {};
    _modules["book_list.custom_list"] = {};
    _modules["book_list.prefs"] = {};
    _modules["book_list.search"] = {};
    _modules["book_list.views"] = {};
    _modules["book_list.book_details"] = {};
    _modules["read_book.profiles"] = {};
    _modules["read_book.prefs.font_size"] = {};
    _modules["read_book.prefs.colors"] = {};
    _modules["read_book.prefs.fonts"] = {};
    _modules["read_book.prefs.keyboard"] = {};
    _modules["read_book.prefs.layout"] = {};
    _modules["read_book.prefs.misc"] = {};
    _modules["read_book.prefs.scrolling"] = {};
    _modules["read_book.selection_bar"] = {};
    _modules["read_book.prefs.selection"] = {};
    _modules["read_book.prefs.touch"] = {};
    _modules.viewer = {};
    _modules["viewer.constants"] = {};
    _modules["read_book.prefs.user_stylesheet"] = {};
    _modules["read_book.prefs.main"] = {};
    _modules["read_book.word_actions"] = {};
    _modules["read_book.overlay"] = {};
    _modules["read_book.read_aloud"] = {};
    _modules["read_book.read_audio_ebook"] = {};
    _modules["read_book.scrollbar"] = {};
    _modules["read_book.search_worker"] = {};
    _modules.worker = {};
    _modules["read_book.search"] = {};
    _modules["read_book.timers"] = {};
    _modules["read_book.view"] = {};
    _modules.image_popup = {};
    _modules["read_book.ui"] = {};
    _modules["book_list.local_books"] = {};
    _modules["book_list.comments_editor"] = {};
    _modules["book_list.edit_metadata"] = {};
    _modules["book_list.conversion_widgets"] = {};
    _modules["book_list.convert_book"] = {};
    _modules["book_list.fts"] = {};
    _modules["book_list.show_note"] = {};
    _modules["book_list.main"] = {};

    (function(){
        var __name__ = "pythonize";
        function strings() {
            var string_funcs, exclude, name;
            string_funcs = set("capitalize strip lstrip rstrip islower isupper isspace lower upper swapcase center count endswith startswith find rfind index rindex format join ljust rjust partition rpartition replace split rsplit splitlines zfill".split(" "));
            if (!arguments.length) {
                exclude = (function(){
                    var s = _set();
                    s.jsset.add("split");
                    s.jsset.add("replace");
                    return s;
                })();
            } else if (arguments[0]) {
                exclude = Array.prototype.slice.call(arguments);
            } else {
                exclude = null;
            }
            if (exclude) {
                string_funcs = string_funcs.difference(set(exclude));
            }
            var _Iter0 = _Iterable(string_funcs);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                name = _Iter0[_Index0];
                (_expr_temp = String.prototype)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = (_expr_temp = _str.prototype)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            }
        };
        if (!strings.__module__) Object.defineProperties(strings, {
            __module__ : {value: "pythonize"}
        });

        _modules.pythonize.strings = strings;
    })();

    (function(){
        var __name__ = "initialize";
        var strings = _modules.pythonize.strings;

        strings();
    })();

    (function(){
        var __name__ = "gettext";
        var Jed, plural_forms_parser, _gettext, _ngettext, has_prop, empty_translation_data;
        Jed = {};
        
  Jed.PF = {};

  Jed.PF.parse = function ( p ) {
    var plural_str = Jed.PF.extractPluralExpr( p );
    return Jed.PF.parser.parse.call(Jed.PF.parser, plural_str);
  };

  Jed.PF.compile = function ( p ) {
    // Handle trues and falses as 0 and 1
    function imply( val ) {
      return (val === true ? 1 : val ? val : 0);
    }

    var ast = Jed.PF.parse( p );
    return function ( n ) {
      return imply( Jed.PF.interpreter( ast )( n ) );
    };
  };

  Jed.PF.interpreter = function ( ast ) {
    return function ( n ) {
      var res;
      switch ( ast.type ) {
        case 'GROUP':
          return Jed.PF.interpreter( ast.expr )( n );
        case 'TERNARY':
          if ( Jed.PF.interpreter( ast.expr )( n ) ) {
            return Jed.PF.interpreter( ast.truthy )( n );
          }
          return Jed.PF.interpreter( ast.falsey )( n );
        case 'OR':
          return Jed.PF.interpreter( ast.left )( n ) || Jed.PF.interpreter( ast.right )( n );
        case 'AND':
          return Jed.PF.interpreter( ast.left )( n ) && Jed.PF.interpreter( ast.right )( n );
        case 'LT':
          return Jed.PF.interpreter( ast.left )( n ) < Jed.PF.interpreter( ast.right )( n );
        case 'GT':
          return Jed.PF.interpreter( ast.left )( n ) > Jed.PF.interpreter( ast.right )( n );
        case 'LTE':
          return Jed.PF.interpreter( ast.left )( n ) <= Jed.PF.interpreter( ast.right )( n );
        case 'GTE':
          return Jed.PF.interpreter( ast.left )( n ) >= Jed.PF.interpreter( ast.right )( n );
        case 'EQ':
          return Jed.PF.interpreter( ast.left )( n ) == Jed.PF.interpreter( ast.right )( n );
        case 'NEQ':
          return Jed.PF.interpreter( ast.left )( n ) != Jed.PF.interpreter( ast.right )( n );
        case 'MOD':
          return Jed.PF.interpreter( ast.left )( n ) % Jed.PF.interpreter( ast.right )( n );
        case 'VAR':
          return n;
        case 'NUM':
          return ast.val;
        default:
          throw new Error("Invalid Token found.");
      }
    };
  };

  Jed.PF.extractPluralExpr = function ( p ) {
    // trim first
    p = p.replace(/^\s\s*/, '').replace(/\s\s*$/, '');

    if (! /;\s*$/.test(p)) {
      p = p.concat(';');
    }

    var nplurals_re = /nplurals\=(\d+);/,
        plural_re = /plural\=(.*);/,
        nplurals_matches = p.match( nplurals_re ),
        res = {},
        plural_matches;

    // Find the nplurals number
    if ( nplurals_matches.length > 1 ) {
      res.nplurals = nplurals_matches[1];
    }
    else {
      throw new Error('nplurals not found in plural_forms string: ' + p );
    }

    // remove that data to get to the formula
    p = p.replace( nplurals_re, "" );
    plural_matches = p.match( plural_re );

    if (!( plural_matches && plural_matches.length > 1 ) ) {
      throw new Error('`plural` expression not found: ' + p);
    }
    return plural_matches[ 1 ];
  };

  /* Jison generated parser */
  Jed.PF.parser = (function(){

var parser = {trace: function trace() { },
yy: {},
symbols_: {"error":2,"expressions":3,"e":4,"EOF":5,"?":6,":":7,"||":8,"&&":9,"<":10,"<=":11,">":12,">=":13,"!=":14,"==":15,"%":16,"(":17,")":18,"n":19,"NUMBER":20,"$accept":0,"$end":1},
terminals_: {2:"error",5:"EOF",6:"?",7:":",8:"||",9:"&&",10:"<",11:"<=",12:">",13:">=",14:"!=",15:"==",16:"%",17:"(",18:")",19:"n",20:"NUMBER"},
productions_: [0,[3,2],[4,5],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,1],[4,1]],
performAction: function anonymous(yytext,yyleng,yylineno,yy,yystate,$$,_$) {

var $0 = $$.length - 1;
switch (yystate) {
case 1: return { type : 'GROUP', expr: $$[$0-1] };
case 2:this.$ = { type: 'TERNARY', expr: $$[$0-4], truthy : $$[$0-2], falsey: $$[$0] };
break;
case 3:this.$ = { type: "OR", left: $$[$0-2], right: $$[$0] };
break;
case 4:this.$ = { type: "AND", left: $$[$0-2], right: $$[$0] };
break;
case 5:this.$ = { type: 'LT', left: $$[$0-2], right: $$[$0] };
break;
case 6:this.$ = { type: 'LTE', left: $$[$0-2], right: $$[$0] };
break;
case 7:this.$ = { type: 'GT', left: $$[$0-2], right: $$[$0] };
break;
case 8:this.$ = { type: 'GTE', left: $$[$0-2], right: $$[$0] };
break;
case 9:this.$ = { type: 'NEQ', left: $$[$0-2], right: $$[$0] };
break;
case 10:this.$ = { type: 'EQ', left: $$[$0-2], right: $$[$0] };
break;
case 11:this.$ = { type: 'MOD', left: $$[$0-2], right: $$[$0] };
break;
case 12:this.$ = { type: 'GROUP', expr: $$[$0-1] };
break;
case 13:this.$ = { type: 'VAR' };
break;
case 14:this.$ = { type: 'NUM', val: Number(yytext) };
break;
}
},
table: [{3:1,4:2,17:[1,3],19:[1,4],20:[1,5]},{1:[3]},{5:[1,6],6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{4:17,17:[1,3],19:[1,4],20:[1,5]},{5:[2,13],6:[2,13],7:[2,13],8:[2,13],9:[2,13],10:[2,13],11:[2,13],12:[2,13],13:[2,13],14:[2,13],15:[2,13],16:[2,13],18:[2,13]},{5:[2,14],6:[2,14],7:[2,14],8:[2,14],9:[2,14],10:[2,14],11:[2,14],12:[2,14],13:[2,14],14:[2,14],15:[2,14],16:[2,14],18:[2,14]},{1:[2,1]},{4:18,17:[1,3],19:[1,4],20:[1,5]},{4:19,17:[1,3],19:[1,4],20:[1,5]},{4:20,17:[1,3],19:[1,4],20:[1,5]},{4:21,17:[1,3],19:[1,4],20:[1,5]},{4:22,17:[1,3],19:[1,4],20:[1,5]},{4:23,17:[1,3],19:[1,4],20:[1,5]},{4:24,17:[1,3],19:[1,4],20:[1,5]},{4:25,17:[1,3],19:[1,4],20:[1,5]},{4:26,17:[1,3],19:[1,4],20:[1,5]},{4:27,17:[1,3],19:[1,4],20:[1,5]},{6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[1,28]},{6:[1,7],7:[1,29],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{5:[2,3],6:[2,3],7:[2,3],8:[2,3],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,3]},{5:[2,4],6:[2,4],7:[2,4],8:[2,4],9:[2,4],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,4]},{5:[2,5],6:[2,5],7:[2,5],8:[2,5],9:[2,5],10:[2,5],11:[2,5],12:[2,5],13:[2,5],14:[2,5],15:[2,5],16:[1,16],18:[2,5]},{5:[2,6],6:[2,6],7:[2,6],8:[2,6],9:[2,6],10:[2,6],11:[2,6],12:[2,6],13:[2,6],14:[2,6],15:[2,6],16:[1,16],18:[2,6]},{5:[2,7],6:[2,7],7:[2,7],8:[2,7],9:[2,7],10:[2,7],11:[2,7],12:[2,7],13:[2,7],14:[2,7],15:[2,7],16:[1,16],18:[2,7]},{5:[2,8],6:[2,8],7:[2,8],8:[2,8],9:[2,8],10:[2,8],11:[2,8],12:[2,8],13:[2,8],14:[2,8],15:[2,8],16:[1,16],18:[2,8]},{5:[2,9],6:[2,9],7:[2,9],8:[2,9],9:[2,9],10:[2,9],11:[2,9],12:[2,9],13:[2,9],14:[2,9],15:[2,9],16:[1,16],18:[2,9]},{5:[2,10],6:[2,10],7:[2,10],8:[2,10],9:[2,10],10:[2,10],11:[2,10],12:[2,10],13:[2,10],14:[2,10],15:[2,10],16:[1,16],18:[2,10]},{5:[2,11],6:[2,11],7:[2,11],8:[2,11],9:[2,11],10:[2,11],11:[2,11],12:[2,11],13:[2,11],14:[2,11],15:[2,11],16:[2,11],18:[2,11]},{5:[2,12],6:[2,12],7:[2,12],8:[2,12],9:[2,12],10:[2,12],11:[2,12],12:[2,12],13:[2,12],14:[2,12],15:[2,12],16:[2,12],18:[2,12]},{4:30,17:[1,3],19:[1,4],20:[1,5]},{5:[2,2],6:[1,7],7:[2,2],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,2]}],
defaultActions: {6:[2,1]},
parseError: function parseError(str, hash) {
    throw new Error(str);
},
parse: function parse(input) {
    var self = this,
        stack = [0],
        vstack = [null], // semantic value stack
        lstack = [], // location stack
        table = this.table,
        yytext = '',
        yylineno = 0,
        yyleng = 0,
        recovering = 0,
        TERROR = 2,
        EOF = 1;

    //this.reductionCount = this.shiftCount = 0;

    this.lexer.setInput(input);
    this.lexer.yy = this.yy;
    this.yy.lexer = this.lexer;
    if (typeof this.lexer.yylloc == 'undefined')
        this.lexer.yylloc = {};
    var yyloc = this.lexer.yylloc;
    lstack.push(yyloc);

    if (typeof this.yy.parseError === 'function')
        this.parseError = this.yy.parseError;

    function popStack (n) {
        stack.length = stack.length - 2*n;
        vstack.length = vstack.length - n;
        lstack.length = lstack.length - n;
    }

    function lex() {
        var token;
        token = self.lexer.lex() || 1; // $end = 1
        // if token isn't its numeric value, convert
        if (typeof token !== 'number') {
            token = self.symbols_[token] || token;
        }
        return token;
    }

    var symbol, preErrorSymbol, state, action, a, r, yyval={},p,len,newState, expected, errStr;
    while (true) {
        // retreive state number from top of stack
        state = stack[stack.length-1];

        // use default actions if available
        if (this.defaultActions[state]) {
            action = this.defaultActions[state];
        } else {
            if (symbol === null || symbol === undefined)
                symbol = lex();
            // read action for current state and first input
            action = table[state] && table[state][symbol];
        }

        // handle parse error
        _handle_error:
        if (typeof action === 'undefined' || !action.length || !action[0]) {

            if (!recovering) {
                // Report error
                expected = [];
                for (p in table[state]) if (this.terminals_[p] && p > 2) {
                    expected.push("'"+this.terminals_[p]+"'");
                }
                errStr = '';
                if (this.lexer.showPosition) {
                    errStr = 'Parse error on line '+(yylineno+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+expected.join(', ') + ", got '" + this.terminals_[symbol]+ "'";
                } else {
                    errStr = 'Parse error on line '+(yylineno+1)+": Unexpected " +
                                  (symbol == 1 /*EOF*/ ? "end of input" :
                                              ("'"+(this.terminals_[symbol] || symbol)+"'"));
                }
                this.parseError(errStr,
                    {text: this.lexer.match, token: this.terminals_[symbol] || symbol, line: this.lexer.yylineno, loc: yyloc, expected: expected});
            }

            // just recovered from another error
            if (recovering == 3) {
                if (symbol == EOF) {
                    throw new Error(errStr || 'Parsing halted.');
                }

                // discard current lookahead and grab another
                yyleng = this.lexer.yyleng;
                yytext = this.lexer.yytext;
                yylineno = this.lexer.yylineno;
                yyloc = this.lexer.yylloc;
                symbol = lex();
            }

            // try to recover from error
            while (1) {
                // check for error recovery rule in this state
                if ((TERROR.toString()) in table[state]) {
                    break;
                }
                if (state === 0) {
                    throw new Error(errStr || 'Parsing halted.');
                }
                popStack(1);
                state = stack[stack.length-1];
            }

            preErrorSymbol = symbol; // save the lookahead token
            symbol = TERROR;         // insert generic error symbol as new lookahead
            state = stack[stack.length-1];
            action = table[state] && table[state][TERROR];
            recovering = 3; // allow 3 real symbols to be shifted before reporting a new error
        }

        // this shouldn't happen, unless resolve defaults are off
        if (action[0] instanceof Array && action.length > 1) {
            throw new Error('Parse Error: multiple actions possible at state: '+state+', token: '+symbol);
        }

        switch (action[0]) {

            case 1: // shift
                //this.shiftCount++;

                stack.push(symbol);
                vstack.push(this.lexer.yytext);
                lstack.push(this.lexer.yylloc);
                stack.push(action[1]); // push state
                symbol = null;
                if (!preErrorSymbol) { // normal execution/no error
                    yyleng = this.lexer.yyleng;
                    yytext = this.lexer.yytext;
                    yylineno = this.lexer.yylineno;
                    yyloc = this.lexer.yylloc;
                    if (recovering > 0)
                        recovering--;
                } else { // error just occurred, resume old lookahead f/ before error
                    symbol = preErrorSymbol;
                    preErrorSymbol = null;
                }
                break;

            case 2: // reduce
                //this.reductionCount++;

                len = this.productions_[action[1]][1];

                // perform semantic action
                yyval.$ = vstack[vstack.length-len]; // default to $$ = $1
                // default location, uses first token for firsts, last for lasts
                yyval._$ = {
                    first_line: lstack[lstack.length-(len||1)].first_line,
                    last_line: lstack[lstack.length-1].last_line,
                    first_column: lstack[lstack.length-(len||1)].first_column,
                    last_column: lstack[lstack.length-1].last_column
                };
                r = this.performAction.call(yyval, yytext, yyleng, yylineno, this.yy, action[1], vstack, lstack);

                if (typeof r !== 'undefined') {
                    return r;
                }

                // pop off stack
                if (len) {
                    stack = stack.slice(0,-1*len*2);
                    vstack = vstack.slice(0, -1*len);
                    lstack = lstack.slice(0, -1*len);
                }

                stack.push(this.productions_[action[1]][0]);    // push nonterminal (reduce)
                vstack.push(yyval.$);
                lstack.push(yyval._$);
                // goto new state = table[STATE][NONTERMINAL]
                newState = table[stack[stack.length-2]][stack[stack.length-1]];
                stack.push(newState);
                break;

            case 3: // accept
                return true;
        }

    }

    return true;
}};/* Jison generated lexer */
var lexer = (function(){

var lexer = ({EOF:1,
parseError:function parseError(str, hash) {
        if (this.yy.parseError) {
            this.yy.parseError(str, hash);
        } else {
            throw new Error(str);
        }
    },
setInput:function (input) {
        this._input = input;
        this._more = this._less = this.done = false;
        this.yylineno = this.yyleng = 0;
        this.yytext = this.matched = this.match = '';
        this.conditionStack = ['INITIAL'];
        this.yylloc = {first_line:1,first_column:0,last_line:1,last_column:0};
        return this;
    },
input:function () {
        var ch = this._input[0];
        this.yytext+=ch;
        this.yyleng++;
        this.match+=ch;
        this.matched+=ch;
        var lines = ch.match(/\n/);
        if (lines) this.yylineno++;
        this._input = this._input.slice(1);
        return ch;
    },
unput:function (ch) {
        this._input = ch + this._input;
        return this;
    },
more:function () {
        this._more = true;
        return this;
    },
pastInput:function () {
        var past = this.matched.substr(0, this.matched.length - this.match.length);
        return (past.length > 20 ? '...':'') + past.substr(-20).replace(/\n/g, "");
    },
upcomingInput:function () {
        var next = this.match;
        if (next.length < 20) {
            next += this._input.substr(0, 20-next.length);
        }
        return (next.substr(0,20)+(next.length > 20 ? '...':'')).replace(/\n/g, "");
    },
showPosition:function () {
        var pre = this.pastInput();
        var c = new Array(pre.length + 1).join("-");
        return pre + this.upcomingInput() + "\n" + c+"^";
    },
next:function () {
        if (this.done) {
            return this.EOF;
        }
        if (!this._input) this.done = true;

        var token,
            match,
            col,
            lines;
        if (!this._more) {
            this.yytext = '';
            this.match = '';
        }
        var rules = this._currentRules();
        for (var i=0;i < rules.length; i++) {
            match = this._input.match(this.rules[rules[i]]);
            if (match) {
                lines = match[0].match(/\n.*/g);
                if (lines) this.yylineno += lines.length;
                this.yylloc = {first_line: this.yylloc.last_line,
                               last_line: this.yylineno+1,
                               first_column: this.yylloc.last_column,
                               last_column: lines ? lines[lines.length-1].length-1 : this.yylloc.last_column + match[0].length};
                this.yytext += match[0];
                this.match += match[0];
                this.matches = match;
                this.yyleng = this.yytext.length;
                this._more = false;
                this._input = this._input.slice(match[0].length);
                this.matched += match[0];
                token = this.performAction.call(this, this.yy, this, rules[i],this.conditionStack[this.conditionStack.length-1]);
                if (token) return token;
                else return;
            }
        }
        if (this._input === "") {
            return this.EOF;
        } else {
            this.parseError('Lexical error on line '+(this.yylineno+1)+'. Unrecognized text.\n'+this.showPosition(),
                    {text: "", token: null, line: this.yylineno});
        }
    },
lex:function lex() {
        var r = this.next();
        if (typeof r !== 'undefined') {
            return r;
        } else {
            return this.lex();
        }
    },
begin:function begin(condition) {
        this.conditionStack.push(condition);
    },
popState:function popState() {
        return this.conditionStack.pop();
    },
_currentRules:function _currentRules() {
        return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules;
    },
topState:function () {
        return this.conditionStack[this.conditionStack.length-2];
    },
pushState:function begin(condition) {
        this.begin(condition);
    }});
lexer.performAction = function anonymous(yy,yy_,$avoiding_name_collisions,YY_START) {

var YYSTATE=YY_START;
switch($avoiding_name_collisions) {
case 0:/* skip whitespace */
break;
case 1:return 20
break;
case 2:return 19
break;
case 3:return 8
break;
case 4:return 9
break;
case 5:return 6
break;
case 6:return 7
break;
case 7:return 11
break;
case 8:return 13
break;
case 9:return 10
break;
case 10:return 12
break;
case 11:return 14
break;
case 12:return 15
break;
case 13:return 16
break;
case 14:return 17
break;
case 15:return 18
break;
case 16:return 5
break;
case 17:return 'INVALID'
break;
}
};
lexer.rules = [/^\s+/,/^[0-9]+(\.[0-9]+)?\b/,/^n\b/,/^\|\|/,/^&&/,/^\?/,/^:/,/^<=/,/^>=/,/^</,/^>/,/^!=/,/^==/,/^%/,/^\(/,/^\)/,/^$/,/^./];
lexer.conditions = {"INITIAL":{"rules":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],"inclusive":true}};return lexer;})()
parser.lexer = lexer;
return parser;
})();
;
        plural_forms_parser = Jed.PF;
        function _get_plural_forms_function(plural_forms_string) {
            return plural_forms_parser.compile(plural_forms_string || "nplurals=2; plural=(n != 1);");
        };
        if (!_get_plural_forms_function.__argnames__) Object.defineProperties(_get_plural_forms_function, {
            __argnames__ : {value: ["plural_forms_string"]},
            __module__ : {value: "gettext"}
        });

        _gettext = (function() {
            var _anonfunc = function (text) {
                return text;
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["text"]},
                __module__ : {value: "gettext"}
            });
            return _anonfunc;
        })();
        _ngettext = (function() {
            var _anonfunc = function (text, plural, n) {
                return (n === 1) ? text : plural;
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["text", "plural", "n"]},
                __module__ : {value: "gettext"}
            });
            return _anonfunc;
        })();
        function gettext(text) {
            return _gettext(text);
        };
        if (!gettext.__argnames__) Object.defineProperties(gettext, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "gettext"}
        });

        function ngettext(text, plural, n) {
            return _ngettext(text, plural, n);
        };
        if (!ngettext.__argnames__) Object.defineProperties(ngettext, {
            __argnames__ : {value: ["text", "plural", "n"]},
            __module__ : {value: "gettext"}
        });

        function install(translation_data) {
            var t, func;
            t = new Translations(translation_data);
            t.install();
            var _Iter0 = _Iterable(register_callback.install_callbacks);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                func = _Iter0[_Index0];
                try {
                    func(t);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                    } 
                }
            }
            return t;
        };
        if (!install.__argnames__) Object.defineProperties(install, {
            __argnames__ : {value: ["translation_data"]},
            __module__ : {value: "gettext"}
        });

        has_prop = Object.prototype.hasOwnProperty.call.bind(Object.prototype.hasOwnProperty);
        function register_callback(func) {
            register_callback.install_callbacks.push(func);
        };
        if (!register_callback.__argnames__) Object.defineProperties(register_callback, {
            __argnames__ : {value: ["func"]},
            __module__ : {value: "gettext"}
        });

        register_callback.install_callbacks = [];
        empty_translation_data = (function(){
            var _d = {};
            _d["entries"] = {};
            return _d;
        }).call(this);
        function Translations() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Translations.prototype.__init__.apply(this, arguments);
        }
        Translations.prototype.__init__ = function __init__(translation_data) {
            var self = this;
            var func;
            translation_data = translation_data || empty_translation_data;
            func = _get_plural_forms_function(translation_data.plural_forms);
            self.translations = _list_decorate([ _list_decorate([ translation_data, func ]) ]);
            self.language = translation_data["language"];
        };
        if (!Translations.prototype.__init__.__argnames__) Object.defineProperties(Translations.prototype.__init__, {
            __argnames__ : {value: ["translation_data"]},
            __module__ : {value: "gettext"}
        });
        Translations.__argnames__ = Translations.prototype.__init__.__argnames__;
        Translations.__handles_kwarg_interpolation__ = Translations.prototype.__init__.__handles_kwarg_interpolation__;
        Translations.prototype.add_fallback = function add_fallback(fallback) {
            var self = this;
            var func;
            fallback = fallback || empty_translation_data;
            func = _get_plural_forms_function(fallback.plural_forms);
            self.translations.push(_list_decorate([ fallback, func ]));
        };
        if (!Translations.prototype.add_fallback.__argnames__) Object.defineProperties(Translations.prototype.add_fallback, {
            __argnames__ : {value: ["fallback"]},
            __module__ : {value: "gettext"}
        });
        Translations.prototype.gettext = function gettext(text) {
            var self = this;
            var m, t;
            var _Iter1 = _Iterable(self.translations);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                t = _Iter1[_Index1];
                m = t[0].entries;
                if (has_prop(m, text)) {
                    return m[(typeof text === "number" && text < 0) ? m.length + text : text][0];
                }
            }
            return text;
        };
        if (!Translations.prototype.gettext.__argnames__) Object.defineProperties(Translations.prototype.gettext, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "gettext"}
        });
        Translations.prototype.ngettext = function ngettext(text, plural, n) {
            var self = this;
            var m, idx, t;
            var _Iter2 = _Iterable(self.translations);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                t = _Iter2[_Index2];
                m = t[0].entries;
                if (has_prop(m, text)) {
                    idx = t[1](n);
                    return (_expr_temp = m[(typeof text === "number" && text < 0) ? m.length + text : text])[(typeof idx === "number" && idx < 0) ? _expr_temp.length + idx : idx] || ((n === 1) ? text : plural);
                }
            }
            return (n === 1) ? text : plural;
        };
        if (!Translations.prototype.ngettext.__argnames__) Object.defineProperties(Translations.prototype.ngettext, {
            __argnames__ : {value: ["text", "plural", "n"]},
            __module__ : {value: "gettext"}
        });
        Translations.prototype.install = function install() {
            var self = this;
            _gettext = (function() {
                var _anonfunc = function () {
                    return self.gettext.apply(self, arguments);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "gettext"}
                });
                return _anonfunc;
            })();
            _ngettext = (function() {
                var _anonfunc = function () {
                    return self.ngettext.apply(self, arguments);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "gettext"}
                });
                return _anonfunc;
            })();
        };
        if (!Translations.prototype.install.__module__) Object.defineProperties(Translations.prototype.install, {
            __module__ : {value: "gettext"}
        });
        Translations.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Translations.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Translations.prototype, "__bases__", {value: []});

        _modules.gettext.Jed = Jed;
        _modules.gettext.plural_forms_parser = plural_forms_parser;
        _modules.gettext._gettext = _gettext;
        _modules.gettext._ngettext = _ngettext;
        _modules.gettext.has_prop = has_prop;
        _modules.gettext.empty_translation_data = empty_translation_data;
        _modules.gettext._get_plural_forms_function = _get_plural_forms_function;
        _modules.gettext.gettext = gettext;
        _modules.gettext.ngettext = ngettext;
        _modules.gettext.install = install;
        _modules.gettext.register_callback = register_callback;
        _modules.gettext.Translations = Translations;
    })();

    (function(){
        var __name__ = "ajax";
        var default_timeout;
        var _ = _modules.gettext.gettext;

        default_timeout = 60;
        function set_default_timeout(val) {
            default_timeout = val;
        };
        if (!set_default_timeout.__argnames__) Object.defineProperties(set_default_timeout, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "ajax"}
        });

        function encode_query_component(x) {
            var ans;
            ans = encodeURIComponent(x);
            ans = ans.replace(/%2[fF]/g, "/");
            ans = ans.replace(/%40/g, "@");
            ans = ans.replace(/%5[bB]/g, "[");
            ans = ans.replace(/%5[dD]/g, "]");
            ans = ans.replace(/%5[eE]/g, "^");
            ans = ans.replace(/%3[aA]/g, ":");
            return ans;
        };
        if (!encode_query_component.__argnames__) Object.defineProperties(encode_query_component, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "ajax"}
        });

        function encode_query(query, qchar) {
            var keys, ans, val, k;
            if (!query) {
                return "";
            }
            qchar = qchar || "?";
            keys = Object.keys(query).sort();
            ans = "";
            if (keys.length) {
                var _Iter0 = _Iterable(keys);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    k = _Iter0[_Index0];
                    val = query[(typeof k === "number" && k < 0) ? query.length + k : k];
                    if (val === undefined || val === null || val === "") {
                        continue;
                    }
                    ans += qchar + encodeURIComponent(k) + "=" + encode_query_component(val.toString());
                    qchar = "&";
                }
            }
            return ans;
        };
        if (!encode_query.__argnames__) Object.defineProperties(encode_query, {
            __argnames__ : {value: ["query", "qchar"]},
            __module__ : {value: "ajax"}
        });

        function absolute_path(path) {
            var slash;
            if (path[0] !== "/") {
                slash = ((_expr_temp = window.location.pathname)[_expr_temp.length-1] === "/") ? "" : "/";
                path = window.location.pathname + slash + path;
            }
            return path;
        };
        if (!absolute_path.__argnames__) Object.defineProperties(absolute_path, {
            __argnames__ : {value: ["path"]},
            __module__ : {value: "ajax"}
        });

        function workaround_qt_bug() {
            var xhr = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var end_type = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var ok_code = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? workaround_qt_bug.__defaults__.ok_code : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "ok_code")){
                ok_code = _kwargs_obj.ok_code;
            }
            if (end_type === "error" && xhr.status === ok_code && window.navigator.userAgent.indexOf("calibre-viewer") === 0) {
                end_type = "load";
            }
            return end_type;
        };
        if (!workaround_qt_bug.__defaults__) Object.defineProperties(workaround_qt_bug, {
            __defaults__ : {value: {ok_code:200}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["xhr", "end_type", "ok_code"]},
            __module__ : {value: "ajax"}
        });

        function ajax() {
            var path = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var on_complete = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var on_progress = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.on_progress : arguments[2];
            var bypass_cache = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.bypass_cache : arguments[3];
            var method = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.method : arguments[4];
            var query = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.query : arguments[5];
            var timeout = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.timeout : arguments[6];
            var ok_code = (arguments[7] === undefined || ( 7 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.ok_code : arguments[7];
            var progress_totals_needed = (arguments[8] === undefined || ( 8 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax.__defaults__.progress_totals_needed : arguments[8];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_progress")){
                on_progress = _kwargs_obj.on_progress;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "bypass_cache")){
                bypass_cache = _kwargs_obj.bypass_cache;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "method")){
                method = _kwargs_obj.method;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "query")){
                query = _kwargs_obj.query;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "timeout")){
                timeout = _kwargs_obj.timeout;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "ok_code")){
                ok_code = _kwargs_obj.ok_code;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "progress_totals_needed")){
                progress_totals_needed = _kwargs_obj.progress_totals_needed;
            }
            var xhr, eq, has_query;
            if (timeout === null) {
                timeout = default_timeout;
            }
            query = query || Object.create(null);
            xhr = new XMLHttpRequest;
            eq = encode_query(query);
            has_query = eq.length > 0;
            path = absolute_path(path) + eq;
            if (bypass_cache) {
                path += ((has_query) ? "&" : "?") + (new Date).getTime();
            }
            xhr.request_path = path;
            xhr.error_html = "";
            function set_error(event, is_network_error) {
                var rtext;
                if (is_network_error) {
                    xhr.error_html = str.format(_("Failed to communicate with \"{}\", network error. Is the server running and accessible?"), xhr.request_path);
                } else if (event === "timeout") {
                    xhr.error_html = str.format(_("Failed to communicate with \"{}\", timed out after: {} seconds"), xhr.request_path, timeout);
                } else if (event === "abort") {
                    xhr.error_html = str.format(_("Failed to communicate with \"{}\", aborted"), xhr.request_path);
                } else {
                    try {
                        rtext = xhr.responseText || "";
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            rtext = "";
                        } 
                    }
                    xhr.error_html = str.format(_("Failed to communicate with \"{}\", with status: [{} ({})] {}<br><br>{}"), xhr.request_path, xhr.status, event, xhr.statusText, rtext.slice(0, 200));
                }
            };
            if (!set_error.__argnames__) Object.defineProperties(set_error, {
                __argnames__ : {value: ["event", "is_network_error"]},
                __module__ : {value: "ajax"}
            });

            function progress_callback(ev) {
                var ul;
                if (ev.lengthComputable) {
                    on_progress(ev.loaded, ev.total, xhr);
                } else if (ev.loaded) {
                    if (!progress_totals_needed) {
                        on_progress(ev.loaded, undefined, xhr);
                        return;
                    }
                    ul = xhr.getResponseHeader("Calibre-Uncompressed-Length");
                    if (ul) {
                        try {
                            ul = int(ul);
                        } catch (_Exception) {
                            _last_exception = _Exception;
                            if (_Exception instanceof Error) {
                                return;
                            } else {
                                throw _Exception;
                            }
                        }
                        on_progress(ev.loaded, ul, xhr);
                    }
                }
            };
            if (!progress_callback.__argnames__) Object.defineProperties(progress_callback, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "ajax"}
            });

            function complete_callback(end_type, ev) {
                var is_network_error;
                is_network_error = (end_type === "error") ? ev : false;
                if (xhr.status !== ok_code && end_type === "load") {
                    end_type = "error";
                }
                end_type = workaround_qt_bug(xhr, end_type, ok_code);
                if (end_type !== "load") {
                    set_error(end_type, is_network_error);
                }
                on_complete(end_type, xhr, ev);
            };
            if (!complete_callback.__argnames__) Object.defineProperties(complete_callback, {
                __argnames__ : {value: ["end_type", "ev"]},
                __module__ : {value: "ajax"}
            });

            if (on_progress) {
                xhr.addEventListener("progress", progress_callback);
            }
            xhr.addEventListener("abort", (function() {
                var _anonfunc = function (ev) {
                    complete_callback("abort", ev);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "ajax"}
                });
                return _anonfunc;
            })());
            xhr.addEventListener("error", (function() {
                var _anonfunc = function (ev) {
                    complete_callback("error", ev);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "ajax"}
                });
                return _anonfunc;
            })());
            xhr.addEventListener("load", (function() {
                var _anonfunc = function (ev) {
                    complete_callback("load", ev);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "ajax"}
                });
                return _anonfunc;
            })());
            xhr.addEventListener("timeout", (function() {
                var _anonfunc = function (ev) {
                    complete_callback("timeout", ev);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "ajax"}
                });
                return _anonfunc;
            })());
            xhr.open(method, path);
            xhr.timeout = timeout * 1e3;
            return xhr;
        };
        if (!ajax.__defaults__) Object.defineProperties(ajax, {
            __defaults__ : {value: {on_progress:null, bypass_cache:true, method:"GET", query:null, timeout:null, ok_code:200, progress_totals_needed:true}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["path", "on_complete", "on_progress", "bypass_cache", "method", "query", "timeout", "ok_code", "progress_totals_needed"]},
            __module__ : {value: "ajax"}
        });

        function ajax_send() {
            var path = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var data = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var on_complete = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var on_progress = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_send.__defaults__.on_progress : arguments[3];
            var query = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_send.__defaults__.query : arguments[4];
            var timeout = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_send.__defaults__.timeout : arguments[5];
            var ok_code = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_send.__defaults__.ok_code : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_progress")){
                on_progress = _kwargs_obj.on_progress;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "query")){
                query = _kwargs_obj.query;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "timeout")){
                timeout = _kwargs_obj.timeout;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "ok_code")){
                ok_code = _kwargs_obj.ok_code;
            }
            var xhr;
            xhr = ajax(path, on_complete, on_progress, false, "POST", query, timeout, ok_code);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.send(JSON.stringify(data));
            return xhr;
        };
        if (!ajax_send.__defaults__) Object.defineProperties(ajax_send, {
            __defaults__ : {value: {on_progress:null, query:null, timeout:null, ok_code:200}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["path", "data", "on_complete", "on_progress", "query", "timeout", "ok_code"]},
            __module__ : {value: "ajax"}
        });

        function ajax_send_file() {
            var path = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var file = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var on_complete = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var on_progress = ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[3];
            var timeout = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_send_file.__defaults__.timeout : arguments[4];
            var ok_code = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_send_file.__defaults__.ok_code : arguments[5];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "timeout")){
                timeout = _kwargs_obj.timeout;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "ok_code")){
                ok_code = _kwargs_obj.ok_code;
            }
            var xhr;
            xhr = ajax(path, on_complete, on_progress, false, "POST", timeout, ok_code);
            if (file.type) {
                xhr.overrideMimeType(file.type);
            }
            xhr.send(file);
            return xhr;
        };
        if (!ajax_send_file.__defaults__) Object.defineProperties(ajax_send_file, {
            __defaults__ : {value: {timeout:null, ok_code:200}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["path", "file", "on_complete", "on_progress", "timeout", "ok_code"]},
            __module__ : {value: "ajax"}
        });

        function console_print() {
            var args = Array.prototype.slice.call(arguments, 0);
            if (arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) args.pop();
            var data, xhr;
            _print.apply(this, args);
            data = " ".join(map(str, args)) + "\n";
            xhr = _interpolate_kwargs.call(this, ajax, ["console-print", (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "ajax"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({method: "POST", progress_totals_needed: false})]));
            xhr.send(data);
        };
        if (!console_print.__handles_kwarg_interpolation__) Object.defineProperties(console_print, {
            __handles_kwarg_interpolation__ : {value: true},
            __module__ : {value: "ajax"}
        });

        _modules.ajax.default_timeout = default_timeout;
        _modules.ajax.set_default_timeout = set_default_timeout;
        _modules.ajax.encode_query_component = encode_query_component;
        _modules.ajax.encode_query = encode_query;
        _modules.ajax.absolute_path = absolute_path;
        _modules.ajax.workaround_qt_bug = workaround_qt_bug;
        _modules.ajax.ajax = ajax;
        _modules.ajax.ajax_send = ajax_send;
        _modules.ajax.ajax_send_file = ajax_send_file;
        _modules.ajax.console_print = console_print;
    })();

    (function(){
        var __name__ = "autoreload";
        var MAX_RETRIES;
        MAX_RETRIES = 10;
        function Watcher() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Watcher.prototype.__bind_methods__.call(this);
            Watcher.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Watcher.prototype, "__bind_methods__", {value: function () {
            this.reconnect = Watcher.prototype.reconnect.bind(this);
            this.reload_app = Watcher.prototype.reload_app.bind(this);
        }});
        Watcher.prototype.__init__ = function __init__(autoreload_port) {
            var self = this;
            var host;
            host = document.location.host.split(":")[0];
            self.url = "ws://" + host + ":" + autoreload_port;
            self.retries = 0;
            self.interval = 100;
            self.disable = false;
            self.opened_at_least_once = false;
            self.reconnect();
        };
        if (!Watcher.prototype.__init__.__argnames__) Object.defineProperties(Watcher.prototype.__init__, {
            __argnames__ : {value: ["autoreload_port"]},
            __module__ : {value: "autoreload"}
        });
        Watcher.__argnames__ = Watcher.prototype.__init__.__argnames__;
        Watcher.__handles_kwarg_interpolation__ = Watcher.prototype.__init__.__handles_kwarg_interpolation__;
        Watcher.prototype.reconnect = function reconnect() {
            var self = this;
            try {
                self.ws = new WebSocket(self.url);
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof DOMException) {
                    var e = _Exception;
                    if ((e.name === "SecurityError" || typeof e.name === "object" && _equals(e.name, "SecurityError"))) {
                        console.log("Not allowed to connect to auto-reload watcher, probably because using a self-signed, or otherwise invalid SSL certificate");
                        return;
                    }
                    throw _Exception;
                } else {
                    throw _Exception;
                }
            }
            self.ws.onopen = (function() {
                var _anonfunc = function (event) {
                    self.retries = 0;
                    self.opened_at_least_once = true;
                    self.interval = 100;
                    print("Connected to reloading WebSocket server at: " + self.url);
                    window.addEventListener("beforeunload", (function() {
                        var _anonfunc = function (event) {
                            print("Shutting down connection to reload server, before page unload");
                            self.disable = true;
                            self.ws.close();
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["event"]},
                            __module__ : {value: "autoreload"}
                        });
                        return _anonfunc;
                    })());
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "autoreload"}
                });
                return _anonfunc;
            })();
            self.ws.onmessage = (function() {
                var _anonfunc = function (event) {
                    if (event.data !== "ping") {
                        print("Received mesasge from reload server: " + event.data);
                    }
                    if (event.data === "reload") {
                        self.reload_app();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "autoreload"}
                });
                return _anonfunc;
            })();
            self.ws.onclose = (function() {
                var _anonfunc = function (event) {
                    if (self.disable || !self.opened_at_least_once) {
                        return;
                    }
                    print("Connection to reload server closed with code: " + event.code + " and reason: " + event.reason);
                    self.retries += 1;
                    if (self.retries < MAX_RETRIES) {
                        setTimeout(self.reconnect, self.interval);
                    } else {
                        self.reload_app();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "autoreload"}
                });
                return _anonfunc;
            })();
        };
        if (!Watcher.prototype.reconnect.__module__) Object.defineProperties(Watcher.prototype.reconnect, {
            __module__ : {value: "autoreload"}
        });
        Watcher.prototype.reload_app = function reload_app() {
            var self = this;
            window.location.reload(true);
        };
        if (!Watcher.prototype.reload_app.__module__) Object.defineProperties(Watcher.prototype.reload_app, {
            __module__ : {value: "autoreload"}
        });
        Watcher.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Watcher.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Watcher.prototype, "__bases__", {value: []});

        function create_auto_reload_watcher(autoreload_port) {
            if (!create_auto_reload_watcher.watcher) {
                create_auto_reload_watcher.watcher = new Watcher(autoreload_port);
            }
            return create_auto_reload_watcher.watcher;
        };
        if (!create_auto_reload_watcher.__argnames__) Object.defineProperties(create_auto_reload_watcher, {
            __argnames__ : {value: ["autoreload_port"]},
            __module__ : {value: "autoreload"}
        });

        _modules.autoreload.MAX_RETRIES = MAX_RETRIES;
        _modules.autoreload.Watcher = Watcher;
        _modules.autoreload.create_auto_reload_watcher = create_auto_reload_watcher;
    })();

    (function(){
        var __name__ = "book_list";

    })();

    (function(){
        var __name__ = "book_list.globals";
        var session_data;
        session_data = null;
        function set_session_data(sd) {
            session_data = sd;
            return session_data;
        };
        if (!set_session_data.__argnames__) Object.defineProperties(set_session_data, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "book_list.globals"}
        });

        function get_session_data() {
            return session_data;
        };
        if (!get_session_data.__module__) Object.defineProperties(get_session_data, {
            __module__ : {value: "book_list.globals"}
        });

        function main_js(newval) {
            if (newval !== undefined) {
                main_js.ans = newval;
            }
            return main_js.ans;
        };
        if (!main_js.__argnames__) Object.defineProperties(main_js, {
            __argnames__ : {value: ["newval"]},
            __module__ : {value: "book_list.globals"}
        });

        function get_current_query(newval) {
            if (newval) {
                get_current_query.ans = newval;
            }
            return get_current_query.ans;
        };
        if (!get_current_query.__argnames__) Object.defineProperties(get_current_query, {
            __argnames__ : {value: ["newval"]},
            __module__ : {value: "book_list.globals"}
        });

        function get_db(db) {
            if (db) {
                get_db.db = db;
            }
            return get_db.db;
        };
        if (!get_db.__argnames__) Object.defineProperties(get_db, {
            __argnames__ : {value: ["db"]},
            __module__ : {value: "book_list.globals"}
        });

        function get_translations(val) {
            if (val) {
                get_translations.ans = val;
            }
            return get_translations.ans;
        };
        if (!get_translations.__argnames__) Object.defineProperties(get_translations, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.globals"}
        });

        function book_whose_metadata_is_being_edited() {
            var set_book_id = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? book_whose_metadata_is_being_edited.__defaults__.set_book_id : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "set_book_id")){
                set_book_id = _kwargs_obj.set_book_id;
            }
            if (typeof set_book_id === "number") {
                book_whose_metadata_is_being_edited.ans = set_book_id;
            } else if (set_book_id === null) {
                book_whose_metadata_is_being_edited.ans = null;
            }
            return book_whose_metadata_is_being_edited.ans;
        };
        if (!book_whose_metadata_is_being_edited.__defaults__) Object.defineProperties(book_whose_metadata_is_being_edited, {
            __defaults__ : {value: {set_book_id:""}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["set_book_id"]},
            __module__ : {value: "book_list.globals"}
        });

        _modules["book_list.globals"].session_data = session_data;
        _modules["book_list.globals"].set_session_data = set_session_data;
        _modules["book_list.globals"].get_session_data = get_session_data;
        _modules["book_list.globals"].main_js = main_js;
        _modules["book_list.globals"].get_current_query = get_current_query;
        _modules["book_list.globals"].get_db = get_db;
        _modules["book_list.globals"].get_translations = get_translations;
        _modules["book_list.globals"].book_whose_metadata_is_being_edited = book_whose_metadata_is_being_edited;
    })();

    (function(){
        var __name__ = "traceback";
        function _get_internal_traceback(err) {
            var lines, final_lines, found_sentinel, sline, _unpack, i, line;
            if (_instanceof(err, Exception) && err.stack) {
                lines = _str.splitlines(err.stack);
                final_lines = [];
                found_sentinel = false;
                var _Iter0 = _Iterable(enumerate(lines));
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    _unpack = _Iter0[_Index0];
                    i = _unpack[0];
                    line = _unpack[1];
                    sline = _str.strip(line);
                    if (i === 0) {
                        final_lines.push(line);
                        continue;
                    }
                    if (found_sentinel) {
                        final_lines.push(line);
                        continue;
                    }
                    if (sline.startsWith("at new " + err.name) || sline.startsWith(err.name + "@")) {
                        found_sentinel = true;
                    }
                }
                return final_lines.join("\n");
            }
            return err && err.stack;
        };
        if (!_get_internal_traceback.__argnames__) Object.defineProperties(_get_internal_traceback, {
            __argnames__ : {value: ["err"]},
            __module__ : {value: "traceback"}
        });

        function format_exception(exc, limit) {
            var tb, lines, e;
            if (typeof exc === "undefined") {
                exc = _last_exception;
            }
            if (!(_instanceof(exc, Error))) {
                if (exc && exc.toString) {
                    return _list_decorate([ exc.toString() ]);
                }
                return _list_decorate([]);
            }
            tb = _get_internal_traceback(exc);
            if (tb) {
                lines = _str.splitlines(tb);
                e = lines[0];
                lines = lines.slice(1);
                if (limit) {
                    lines = (limit > 0) ? lines.slice(0, limit + 1) : lines.slice(limit);
                }
                lines.reverse();
                lines.push(e);
                lines.insert(0, "Traceback (most recent call last):");
                return (function() {
                    var _Iter = _Iterable(lines), _Result = [], l;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        l = _Iter[_Index];
                        _Result.push(l + "\n");
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })();
            }
            return _list_decorate([ exc.toString() ]);
        };
        if (!format_exception.__argnames__) Object.defineProperties(format_exception, {
            __argnames__ : {value: ["exc", "limit"]},
            __module__ : {value: "traceback"}
        });

        function format_exc(limit) {
            return format_exception(_last_exception, limit).join("");
        };
        if (!format_exc.__argnames__) Object.defineProperties(format_exc, {
            __argnames__ : {value: ["limit"]},
            __module__ : {value: "traceback"}
        });

        function print_exc(limit) {
            print(format_exc(limit));
        };
        if (!print_exc.__argnames__) Object.defineProperties(print_exc, {
            __argnames__ : {value: ["limit"]},
            __module__ : {value: "traceback"}
        });

        function format_stack(limit) {
            var stack, lines;
            stack = (new Error).stack;
            if (!stack) {
                return _list_decorate([]);
            }
            lines = str.splitlines(stack).slice(2);
            lines.reverse();
            if (limit) {
                lines = (limit > 0) ? lines.slice(0, limit + 1) : lines.slice(limit);
            }
            return (function() {
                var _Iter = _Iterable(lines), _Result = [], l;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    l = _Iter[_Index];
                    _Result.push(l + "\n");
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!format_stack.__argnames__) Object.defineProperties(format_stack, {
            __argnames__ : {value: ["limit"]},
            __module__ : {value: "traceback"}
        });

        function print_stack(limit) {
            print(format_stack(limit).join(""));
        };
        if (!print_stack.__argnames__) Object.defineProperties(print_stack, {
            __argnames__ : {value: ["limit"]},
            __module__ : {value: "traceback"}
        });

        _modules.traceback._get_internal_traceback = _get_internal_traceback;
        _modules.traceback.format_exception = format_exception;
        _modules.traceback.format_exc = format_exc;
        _modules.traceback.print_exc = print_exc;
        _modules.traceback.format_stack = format_stack;
        _modules.traceback.print_stack = print_stack;
    })();

    (function(){
        var __name__ = "elementmaker";
        var html_elements, mathml_elements, svg_elements, html5_tags, E;
        html_elements = (function(){
            var s = _set();
            s.jsset.add("a");
            s.jsset.add("abbr");
            s.jsset.add("acronym");
            s.jsset.add("address");
            s.jsset.add("area");
            s.jsset.add("article");
            s.jsset.add("aside");
            s.jsset.add("audio");
            s.jsset.add("b");
            s.jsset.add("base");
            s.jsset.add("big");
            s.jsset.add("body");
            s.jsset.add("blockquote");
            s.jsset.add("br");
            s.jsset.add("button");
            s.jsset.add("canvas");
            s.jsset.add("caption");
            s.jsset.add("center");
            s.jsset.add("cite");
            s.jsset.add("code");
            s.jsset.add("col");
            s.jsset.add("colgroup");
            s.jsset.add("command");
            s.jsset.add("datagrid");
            s.jsset.add("datalist");
            s.jsset.add("dd");
            s.jsset.add("del");
            s.jsset.add("details");
            s.jsset.add("dfn");
            s.jsset.add("dialog");
            s.jsset.add("dir");
            s.jsset.add("div");
            s.jsset.add("dl");
            s.jsset.add("dt");
            s.jsset.add("em");
            s.jsset.add("event-source");
            s.jsset.add("fieldset");
            s.jsset.add("figcaption");
            s.jsset.add("figure");
            s.jsset.add("footer");
            s.jsset.add("font");
            s.jsset.add("form");
            s.jsset.add("header");
            s.jsset.add("h1");
            s.jsset.add("h2");
            s.jsset.add("h3");
            s.jsset.add("h4");
            s.jsset.add("h5");
            s.jsset.add("h6");
            s.jsset.add("hr");
            s.jsset.add("head");
            s.jsset.add("i");
            s.jsset.add("iframe");
            s.jsset.add("img");
            s.jsset.add("input");
            s.jsset.add("ins");
            s.jsset.add("keygen");
            s.jsset.add("kbd");
            s.jsset.add("label");
            s.jsset.add("legend");
            s.jsset.add("li");
            s.jsset.add("m");
            s.jsset.add("map");
            s.jsset.add("menu");
            s.jsset.add("meter");
            s.jsset.add("multicol");
            s.jsset.add("nav");
            s.jsset.add("nextid");
            s.jsset.add("ol");
            s.jsset.add("output");
            s.jsset.add("optgroup");
            s.jsset.add("option");
            s.jsset.add("p");
            s.jsset.add("pre");
            s.jsset.add("progress");
            s.jsset.add("q");
            s.jsset.add("s");
            s.jsset.add("samp");
            s.jsset.add("script");
            s.jsset.add("section");
            s.jsset.add("select");
            s.jsset.add("small");
            s.jsset.add("sound");
            s.jsset.add("source");
            s.jsset.add("spacer");
            s.jsset.add("span");
            s.jsset.add("strike");
            s.jsset.add("strong");
            s.jsset.add("style");
            s.jsset.add("sub");
            s.jsset.add("sup");
            s.jsset.add("table");
            s.jsset.add("tbody");
            s.jsset.add("td");
            s.jsset.add("textarea");
            s.jsset.add("time");
            s.jsset.add("tfoot");
            s.jsset.add("th");
            s.jsset.add("thead");
            s.jsset.add("tr");
            s.jsset.add("tt");
            s.jsset.add("u");
            s.jsset.add("ul");
            s.jsset.add("var");
            s.jsset.add("video");
            return s;
        })();
        mathml_elements = (function(){
            var s = _set();
            s.jsset.add("maction");
            s.jsset.add("math");
            s.jsset.add("merror");
            s.jsset.add("mfrac");
            s.jsset.add("mi");
            s.jsset.add("mmultiscripts");
            s.jsset.add("mn");
            s.jsset.add("mo");
            s.jsset.add("mover");
            s.jsset.add("mpadded");
            s.jsset.add("mphantom");
            s.jsset.add("mprescripts");
            s.jsset.add("mroot");
            s.jsset.add("mrow");
            s.jsset.add("mspace");
            s.jsset.add("msqrt");
            s.jsset.add("mstyle");
            s.jsset.add("msub");
            s.jsset.add("msubsup");
            s.jsset.add("msup");
            s.jsset.add("mtable");
            s.jsset.add("mtd");
            s.jsset.add("mtext");
            s.jsset.add("mtr");
            s.jsset.add("munder");
            s.jsset.add("munderover");
            s.jsset.add("none");
            return s;
        })();
        svg_elements = (function(){
            var s = _set();
            s.jsset.add("a");
            s.jsset.add("animate");
            s.jsset.add("animateColor");
            s.jsset.add("animateMotion");
            s.jsset.add("animateTransform");
            s.jsset.add("clipPath");
            s.jsset.add("circle");
            s.jsset.add("defs");
            s.jsset.add("desc");
            s.jsset.add("ellipse");
            s.jsset.add("font-face");
            s.jsset.add("font-face-name");
            s.jsset.add("font-face-src");
            s.jsset.add("g");
            s.jsset.add("glyph");
            s.jsset.add("hkern");
            s.jsset.add("linearGradient");
            s.jsset.add("line");
            s.jsset.add("marker");
            s.jsset.add("metadata");
            s.jsset.add("missing-glyph");
            s.jsset.add("mpath");
            s.jsset.add("path");
            s.jsset.add("polygon");
            s.jsset.add("polyline");
            s.jsset.add("radialGradient");
            s.jsset.add("rect");
            s.jsset.add("set");
            s.jsset.add("stop");
            s.jsset.add("svg");
            s.jsset.add("switch");
            s.jsset.add("text");
            s.jsset.add("title");
            s.jsset.add("tspan");
            s.jsset.add("use");
            return s;
        })();
        html5_tags = html_elements.union(mathml_elements).union(svg_elements);
        function _makeelement() {
            var tag = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kwargs = arguments[arguments.length-1];
            if (kwargs === null || typeof kwargs !== "object" || kwargs [_kwargs_symbol] !== true) kwargs = {};
            var args = Array.prototype.slice.call(arguments, 1);
            if (kwargs !== null && typeof kwargs === "object" && kwargs [_kwargs_symbol] === true) args.pop();
            var ans, vattr, val, attr, arg;
            ans = this.createElement(tag);
            var _Iter0 = _Iterable(kwargs);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                attr = _Iter0[_Index0];
                vattr = str.replace(str.rstrip(attr, "_"), "_", "-");
                val = kwargs[(typeof attr === "number" && attr < 0) ? kwargs.length + attr : attr];
                if (callable(val)) {
                    if (str.startswith(attr, "on")) {
                        attr = attr.slice(2);
                    }
                    ans.addEventListener(attr, val);
                } else if (val === true) {
                    ans.setAttribute(vattr, vattr);
                } else if (typeof val === "string") {
                    ans.setAttribute(vattr, val);
                }
            }
            var _Iter1 = _Iterable(args);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                arg = _Iter1[_Index1];
                if (typeof arg === "string") {
                    arg = this.createTextNode(arg);
                }
                ans.appendChild(arg);
            }
            return ans;
        };
        if (!_makeelement.__handles_kwarg_interpolation__) Object.defineProperties(_makeelement, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["tag"]},
            __module__ : {value: "elementmaker"}
        });

        function maker_for_document(document) {
            var E;
            E = _makeelement.bind(document);
            Object.defineProperties(E, (function() {
                var _Iter = _Iterable(html5_tags), _Result = {}, tag;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    tag = _Iter[_Index];
                    _Result[tag] = ((function(){
                        var _d = {};
                        _d["value"] = _makeelement.bind(document, tag);
                        return _d;
                    }).call(this));
                }
                return _Result;
            })());
            return E;
        };
        if (!maker_for_document.__argnames__) Object.defineProperties(maker_for_document, {
            __argnames__ : {value: ["document"]},
            __module__ : {value: "elementmaker"}
        });

        if (typeof document === "undefined") {
            E = maker_for_document((function(){
                var _d = {};
                _d["createTextNode"] = (function() {
                    var _anonfunc = function (value) {
                        return value;
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["value"]},
                        __module__ : {value: "elementmaker"}
                    });
                    return _anonfunc;
                })();
                _d["createElement"] = (function() {
                    var _anonfunc = function (name) {
                        return (function(){
                            var _d = {};
                            _d["name"] = name;
                            _d["children"] = _list_decorate([]);
                            _d["attributes"] = {};
                            _d["setAttribute"] = (function() {
                                var _anonfunc = function (name, val) {
                                    (_expr_temp = this.attributes)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = val;
                                };
                                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                    __argnames__ : {value: ["name", "val"]},
                                    __module__ : {value: "elementmaker"}
                                });
                                return _anonfunc;
                            })();
                            _d["appendChild"] = (function() {
                                var _anonfunc = function (child) {
                                    this.children.push(child);
                                };
                                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                    __argnames__ : {value: ["child"]},
                                    __module__ : {value: "elementmaker"}
                                });
                                return _anonfunc;
                            })();
                            return _d;
                        }).call(this);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "elementmaker"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this));
        } else {
            E = maker_for_document(document);
        }
        _modules.elementmaker.html_elements = html_elements;
        _modules.elementmaker.mathml_elements = mathml_elements;
        _modules.elementmaker.svg_elements = svg_elements;
        _modules.elementmaker.html5_tags = html5_tags;
        _modules.elementmaker.E = E;
        _modules.elementmaker._makeelement = _makeelement;
        _modules.elementmaker.maker_for_document = maker_for_document;
    })();

    (function(){
        var __name__ = "dom";
        var simple_vendor_prefixes, extra_css, add_extra_css;
        simple_vendor_prefixes = (function(){
            var _d = Object.create(null);
            _d["animation"] = ['webkit', 'moz', 'o'];
            _d["animation-name"] = ['webkit', 'moz', 'o'];
            _d["animation-duration"] = ['webkit', 'moz', 'o'];
            _d["animation-timing-function"] = ['webkit', 'moz', 'o'];
            _d["animation-delay"] = ['webkit', 'moz', 'o'];
            _d["animation-iteration-count"] = ['webkit', 'moz', 'o'];
            _d["animation-direction"] = ['webkit', 'moz', 'o'];
            _d["animation-fill-mode"] = ['webkit', 'moz', 'o'];
            _d["animation-play-state"] = ['webkit', 'moz', 'o'];
            _d["hyphens"] = ['webkit', 'moz', 'ms'];
            _d["transform"] = ['webkit', 'ms', 'moz', 'o'];
            _d["transform-origin"] = ['webkit', 'ms', 'moz', 'o'];
            _d["transition"] = ['webkit', 'moz', 'o'];
            _d["filter"] = ['webkit'];
            _d["user-select"] = ['webkit', 'moz', 'ms'];
            _d["break-before"] = ['webkit-column'];
            _d["break-after"] = ['webkit-column'];
            _d["break-inside"] = ['webkit-column'];
            _d["column-gap"] = ['webkit', 'moz'];
            _d["column-width"] = ['webkit', 'moz'];
            _d["column-rule"] = ['webkit', 'moz'];
            _d["column-fill"] = ['moz'];
            return _d;
        }).call(this);
        function set_css() {
            var elem = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            var s, _unpack, name, val, prefixes, prefix, prop;
            if (typeof elem === "string") {
                elem = document.querySelector(elem);
            }
            s = elem.style;
            if (s) {
                var _Iter0 = _Iterable(kw);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    prop = _Iter0[_Index0];
                    _unpack = [str.replace(str.rstrip(prop, "_"), "_", "-"), kw[(typeof prop === "number" && prop < 0) ? kw.length + prop : prop]];
                    name = _unpack[0];
                    val = _unpack[1];
                    if (val === null || val === undefined) {
                        s.removeProperty(name);
                    } else {
                        s.setProperty(name, val);
                    }
                    prefixes = simple_vendor_prefixes[(typeof name === "number" && name < 0) ? simple_vendor_prefixes.length + name : name];
                    if (prefixes) {
                        var _Iter1 = _Iterable(prefixes);
                        for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                            prefix = _Iter1[_Index1];
                            if (val === null || val === undefined) {
                                s.removeProperty("-" + prefix + "-" + name);
                            } else {
                                s.setProperty("-" + prefix + "-" + name, val);
                            }
                        }
                    }
                }
            }
            return elem;
        };
        if (!set_css.__handles_kwarg_interpolation__) Object.defineProperties(set_css, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "dom"}
        });

        function set_important_css() {
            var elem = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            var s, _unpack, name, val, prefixes, prefix, prop;
            if (typeof elem === "string") {
                elem = document.querySelector(elem);
            }
            s = elem.style;
            if (s) {
                var _Iter2 = _Iterable(kw);
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    prop = _Iter2[_Index2];
                    _unpack = [str.replace(str.rstrip(prop, "_"), "_", "-"), kw[(typeof prop === "number" && prop < 0) ? kw.length + prop : prop]];
                    name = _unpack[0];
                    val = _unpack[1];
                    if (val === null || val === undefined) {
                        s.removeProperty(name);
                    } else {
                        s.setProperty(name, val, "important");
                    }
                    prefixes = simple_vendor_prefixes[(typeof name === "number" && name < 0) ? simple_vendor_prefixes.length + name : name];
                    if (prefixes) {
                        var _Iter3 = _Iterable(prefixes);
                        for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                            prefix = _Iter3[_Index3];
                            if (val === null || val === undefined) {
                                s.removeProperty("-" + prefix + "-" + name);
                            } else {
                                s.setProperty("-" + prefix + "-" + name, val, "important");
                            }
                        }
                    }
                }
            }
            return elem;
        };
        if (!set_important_css.__handles_kwarg_interpolation__) Object.defineProperties(set_important_css, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "dom"}
        });

        function build_rule() {
            var selector = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            var ans, _unpack, name, val, prefixes, prefix, prop;
            ans = [selector + " { "];
            var _Iter4 = _Iterable(kw);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                prop = _Iter4[_Index4];
                _unpack = [str.replace(str.rstrip(prop, "_"), "_", "-"), kw[(typeof prop === "number" && prop < 0) ? kw.length + prop : prop]];
                name = _unpack[0];
                val = _unpack[1];
                ans.push(name + ":" + val + ";");
                prefixes = simple_vendor_prefixes[(typeof name === "number" && name < 0) ? simple_vendor_prefixes.length + name : name];
                if (prefixes) {
                    var _Iter5 = _Iterable(prefixes);
                    for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                        prefix = _Iter5[_Index5];
                        ans.push("-" + prefix + "-" + name + ":" + val + ";");
                    }
                }
            }
            ans.push("}");
            return ans.join("\n") + "\n";
        };
        if (!build_rule.__handles_kwarg_interpolation__) Object.defineProperties(build_rule, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["selector"]},
            __module__ : {value: "dom"}
        });

        function clear() {
            var node;
            for (var i = 0; i < arguments.length; i++) {
                node = arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i];
                while (node.firstChild) {
                    node.removeChild(node.firstChild);
                }
            }
        };
        if (!clear.__module__) Object.defineProperties(clear, {
            __module__ : {value: "dom"}
        });

        function remove_all_attributes() {
            var node;
            for (var i = 0; i < arguments.length; i++) {
                node = arguments[(typeof i === "number" && i < 0) ? arguments.length + i : i];
                while (node.attributes.length > 0) {
                    node.removeAttributeNode(node.attributes[0]);
                }
            }
        };
        if (!remove_all_attributes.__module__) Object.defineProperties(remove_all_attributes, {
            __module__ : {value: "dom"}
        });

        function create_keyframes() {
            var animation_name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var frames = Array.prototype.slice.call(arguments, 1);
            if (arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) frames.pop();
            var ans, frame, prefix;
            ans = [];
            var _Iter6 = _Iterable(_list_decorate([ "-webkit-", "-moz-", "-o-", "" ]));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                prefix = _Iter6[_Index6];
                ans.push("@" + prefix + "keyframes " + animation_name + " {");
                var _Iter7 = _Iterable(frames);
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    frame = _Iter7[_Index7];
                    ans.push(frame);
                }
                ans.push("}");
            }
            return ans.join("\n") + "\n";
        };
        if (!create_keyframes.__handles_kwarg_interpolation__) Object.defineProperties(create_keyframes, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["animation_name"]},
            __module__ : {value: "dom"}
        });

        function change_icon_image(icon_element, new_name, tooltip) {
            var x, tt;
            if (new_name) {
                icon_element.firstChild.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "#icon-" + new_name);
            } else {
                icon_element.firstChild.removeAttributeNS("http://www.w3.org/1999/xlink", "xlink:href");
            }
            if ((typeof tooltip !== "undefined" && tooltip !== null)) {
                x = icon_element.getElementsByTagNameNS("http://www.w3.org/2000/svg", "title");
                if (!x.length) {
                    tt = document.createElementNS("http://www.w3.org/2000/svg", "title");
                    icon_element.appendChild(tt);
                    x = [tt];
                }
                x[0].textContent = tooltip;
            }
        };
        if (!change_icon_image.__argnames__) Object.defineProperties(change_icon_image, {
            __argnames__ : {value: ["icon_element", "new_name", "tooltip"]},
            __module__ : {value: "dom"}
        });

        function svgicon(name, height, width, tooltip) {
            var ans, u, tt;
            ans = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            ans.setAttribute("style", "fill: currentColor; height: {}; width: {}; vertical-align: text-top".format((typeof height !== "undefined" && height !== null ? height : "2ex"), (typeof width !== "undefined" && width !== null ? width : "2ex")));
            u = document.createElementNS("http://www.w3.org/2000/svg", "use");
            ans.appendChild(u);
            if (name) {
                ans.firstChild.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "#icon-" + name);
            }
            if (tooltip) {
                tt = document.createElementNS("http://www.w3.org/2000/svg", "title");
                tt.textContent = tooltip;
                ans.appendChild(tt);
            }
            return ans;
        };
        if (!svgicon.__argnames__) Object.defineProperties(svgicon, {
            __argnames__ : {value: ["name", "height", "width", "tooltip"]},
            __module__ : {value: "dom"}
        });

        function element(elem_id, child_selector) {
            var ans;
            ans = (elem_id) ? document.getElementById(elem_id) : document.body;
            if (child_selector) {
                ans = ans.querySelector(child_selector);
            }
            return ans;
        };
        if (!element.__argnames__) Object.defineProperties(element, {
            __argnames__ : {value: ["elem_id", "child_selector"]},
            __module__ : {value: "dom"}
        });

        function selector() {
            var id_selector = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var args = Array.prototype.slice.call(arguments, 1);
            if (arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) args.pop();
            var ans, x;
            ans = "#" + id_selector;
            var _Iter8 = _Iterable(args);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                x = _Iter8[_Index8];
                ans += " " + x;
            }
            return ans;
        };
        if (!selector.__handles_kwarg_interpolation__) Object.defineProperties(selector, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["id_selector"]},
            __module__ : {value: "dom"}
        });

        function rule() {
            var id_selector = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            var args = Array.prototype.slice.call(arguments, 1);
            if (kw !== null && typeof kw === "object" && kw [_kwargs_symbol] === true) args.pop();
            return _interpolate_kwargs.call(this, build_rule, [selector.apply(this, [id_selector].concat(args))].concat([_desugar_kwargs(kw)]));
        };
        if (!rule.__handles_kwarg_interpolation__) Object.defineProperties(rule, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["id_selector"]},
            __module__ : {value: "dom"}
        });

        function unique_id(prefix) {
            var num;
            prefix = prefix || "auto-id";
            (_expr_temp = unique_id.counts)[(typeof prefix === "number" && prefix < 0) ? _expr_temp.length + prefix : prefix] = num = ((_expr_temp = unique_id.counts)[(typeof prefix === "number" && prefix < 0) ? _expr_temp.length + prefix : prefix] || 0) + 1;
            return prefix + "-" + num;
        };
        if (!unique_id.__argnames__) Object.defineProperties(unique_id, {
            __argnames__ : {value: ["prefix"]},
            __module__ : {value: "dom"}
        });

        unique_id.counts = Object.create(null);
        function ensure_id(w, prefix) {
            var ans;
            ans = w.getAttribute("id");
            if (!ans) {
                ans = unique_id(prefix);
                w.setAttribute("id", ans);
            }
            return ans;
        };
        if (!ensure_id.__argnames__) Object.defineProperties(ensure_id, {
            __argnames__ : {value: ["w", "prefix"]},
            __module__ : {value: "dom"}
        });

        extra_css = [];
        add_extra_css = extra_css.push.bind(extra_css);
        function get_widget_css() {
            var ans, func;
            ans = [];
            var _Iter9 = _Iterable(extra_css);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                func = _Iter9[_Index9];
                ans.push(func());
            }
            return ans.join("\n");
        };
        if (!get_widget_css.__module__) Object.defineProperties(get_widget_css, {
            __module__ : {value: "dom"}
        });

        function set_radio_group_value(parent, name, val) {
            var changed, inp;
            changed = false;
            var _Iter10 = _Iterable(parent.querySelectorAll("input[name=" + _str.format("{}", name) + "]"));
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                inp = _Iter10[_Index10];
                inp.checked = inp.value === val;
                changed = true;
            }
            if (!changed) {
                throw new KeyError("No radio group with name=" + _str.format("{}", name) + " found");
            }
        };
        if (!set_radio_group_value.__argnames__) Object.defineProperties(set_radio_group_value, {
            __argnames__ : {value: ["parent", "name", "val"]},
            __module__ : {value: "dom"}
        });

        _modules.dom.simple_vendor_prefixes = simple_vendor_prefixes;
        _modules.dom.extra_css = extra_css;
        _modules.dom.add_extra_css = add_extra_css;
        _modules.dom.set_css = set_css;
        _modules.dom.set_important_css = set_important_css;
        _modules.dom.build_rule = build_rule;
        _modules.dom.clear = clear;
        _modules.dom.remove_all_attributes = remove_all_attributes;
        _modules.dom.create_keyframes = create_keyframes;
        _modules.dom.change_icon_image = change_icon_image;
        _modules.dom.svgicon = svgicon;
        _modules.dom.element = element;
        _modules.dom.selector = selector;
        _modules.dom.rule = rule;
        _modules.dom.unique_id = unique_id;
        _modules.dom.ensure_id = ensure_id;
        _modules.dom.get_widget_css = get_widget_css;
        _modules.dom.set_radio_group_value = set_radio_group_value;
    })();

    (function(){
        var __name__ = "book_list.theme";
        var DARK, LIGHT, LIGHT_DARKER, LIGHT_GRADIENT, DT_DARK, DT_DARK_DARKER, DT_DARK_LIGHTER, DT_DARK_LIGTHER_CONTRAST, DT_LIGHT, DARK_GRADIENT, DEFAULT_COLORS, DEFAULT_SIZES, DEFAULT_FONTS;
        DARK = "#39322B";
        LIGHT = "#F6F3E9";
        LIGHT_DARKER = "#b6b3a8";
        LIGHT_GRADIENT = "linear-gradient(to bottom, {}, {})".format(LIGHT, LIGHT_DARKER);
        DT_DARK = "#2d2d2d";
        DT_DARK_DARKER = "black";
        DT_DARK_LIGHTER = "#777";
        DT_DARK_LIGTHER_CONTRAST = "#1d1d1d";
        DT_LIGHT = "#ddd";
        DARK_GRADIENT = "linear-gradient(to bottom, {}, {})".format(DT_DARK_LIGHTER, DT_DARK);
        function c(light, dark) {
            return (function(){
                var _d = Object.create(null);
                _d["light"] = light;
                _d["dark"] = dark || light;
                return _d;
            }).call(this);
        };
        if (!c.__argnames__) Object.defineProperties(c, {
            __argnames__ : {value: ["light", "dark"]},
            __module__ : {value: "book_list.theme"}
        });

        DEFAULT_COLORS = (function(){
            var _d = Object.create(null);
            _d["window-background"] = c(LIGHT, DT_DARK);
            _d["window-background2"] = c(LIGHT_DARKER, DT_DARK_LIGHTER);
            _d["window-foreground"] = c(DARK, DT_LIGHT);
            _d["window-error-foreground"] = c("red", "#C40233");
            _d["window-hover-foreground"] = c("red", "#C40233");
            _d["link-foreground"] = c("blue", "#6cb4ee");
            _d["faded-text"] = c("#666", "#7f7f7f");
            _d["bar-background"] = c(DARK, DT_DARK_LIGHTER);
            _d["bar-foreground"] = c(LIGHT, DT_DARK_LIGTHER_CONTRAST);
            _d["bar-highlight"] = c("yellow");
            _d["heart"] = c("#B92111");
            _d["list-hover-background"] = c(DARK, DT_DARK_LIGHTER);
            _d["list-hover-foreground"] = c(LIGHT, DT_DARK_LIGTHER_CONTRAST);
            _d["tree-highlight-item"] = c(LIGHT_DARKER, DT_DARK_LIGHTER);
            _d["button-start"] = c(DARK, DT_LIGHT);
            _d["button-end"] = c("#49423B", "#666");
            _d["button-text"] = c(LIGHT, DT_DARK);
            _d["dialog-background"] = c(LIGHT, DT_DARK);
            _d["dialog-background-image"] = c(LIGHT_GRADIENT, DARK_GRADIENT);
            _d["dialog-foreground"] = c(DARK, DT_LIGHT);
            _d["input-background"] = c("field", DT_DARK_DARKER);
            _d["input-foreground"] = c("fieldtext", DT_LIGHT);
            _d["input-focus-outline-color"] = c("#4D90FE", DT_LIGHT);
            return _d;
        }).call(this);
        DEFAULT_SIZES = (function(){
            var _d = Object.create(null);
            _d["title"] = "1.4rem";
            _d["item-list-title"] = "1.1rem";
            _d["item-list-subtitle"] = "0.8rem";
            return _d;
        }).call(this);
        DEFAULT_FONTS = (function(){
            var _d = Object.create(null);
            _d["main"] = "sans-serif";
            return _d;
        }).call(this);
        function set_ui_colors(is_dark_theme) {
            var attr, s, val, k;
            attr = (is_dark_theme) ? "dark" : "light";
            s = document.documentElement.style;
            var _Iter0 = _Iterable(DEFAULT_COLORS);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                k = _Iter0[_Index0];
                val = (_expr_temp = DEFAULT_COLORS[(typeof k === "number" && k < 0) ? DEFAULT_COLORS.length + k : k])[(typeof attr === "number" && attr < 0) ? _expr_temp.length + attr : attr];
                s.setProperty("--calibre-color-" + k, val);
            }
            get_color_as_rgba.cache = Object.create(null);
            cached_color_to_rgba.cache = Object.create(null);
            document.documentElement.style.colorScheme = (is_dark_theme) ? "dark" : "light";
        };
        if (!set_ui_colors.__argnames__) Object.defineProperties(set_ui_colors, {
            __argnames__ : {value: ["is_dark_theme"]},
            __module__ : {value: "book_list.theme"}
        });

        function browser_in_dark_mode() {
            return window.matchMedia("(prefers-color-scheme: dark)").matches;
        };
        if (!browser_in_dark_mode.__module__) Object.defineProperties(browser_in_dark_mode, {
            __module__ : {value: "book_list.theme"}
        });

        function color_scheme() {
            return (browser_in_dark_mode() || document.documentElement.style.colorScheme === "dark") ? "dark" : "light";
        };
        if (!color_scheme.__module__) Object.defineProperties(color_scheme, {
            __module__ : {value: "book_list.theme"}
        });

        function css_for_variables() {
            var input_css, is_dark_theme, attr, ans, val, k;
            input_css = "\n        input, textarea {\n            color: var(--calibre-color-input-foreground);             background-color: var(--calibre-color-input-background);         }\n        input:focus, textarea:focus {\n            outline-color: var(--calibre-color-input-focus-outline-color);         }\n    ";
            is_dark_theme = browser_in_dark_mode();
            attr = (is_dark_theme) ? "dark" : "light";
            ans = [];
            var _Iter1 = _Iterable(DEFAULT_COLORS);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                k = _Iter1[_Index1];
                val = (_expr_temp = DEFAULT_COLORS[(typeof k === "number" && k < 0) ? DEFAULT_COLORS.length + k : k])[(typeof attr === "number" && attr < 0) ? _expr_temp.length + attr : attr];
                ans.push("--calibre-color-" + _str.format("{}", k) + ": " + _str.format("{}", val) + ";");
            }
            return ":root { color-scheme: " + _str.format("{}", attr) + "; " + ans.join("\n") + "}\n\n" + input_css;
        };
        if (!css_for_variables.__module__) Object.defineProperties(css_for_variables, {
            __module__ : {value: "book_list.theme"}
        });

        function get_color(name) {
            return "var(--calibre-color-" + _str.format("{}", name) + ")";
        };
        if (!get_color.__argnames__) Object.defineProperties(get_color, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.theme"}
        });

        function color_to_rgba(color) {
            var cvs, ctx;
            cvs = document.createElement("canvas");
            cvs.height = 1;
            cvs.width = 1;
            if (color.startsWith("var(")) {
                color = window.getComputedStyle(document.documentElement).getPropertyValue(color.slice(4, -1));
            }
            ctx = cvs.getContext("2d");
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 1, 1);
            return ctx.getImageData(0, 0, 1, 1).data;
        };
        if (!color_to_rgba.__argnames__) Object.defineProperties(color_to_rgba, {
            __argnames__ : {value: ["color"]},
            __module__ : {value: "book_list.theme"}
        });

        function cached_color_to_rgba(color) {
            var cache;
            cache = cached_color_to_rgba.cache;
            if (!cache[(typeof color === "number" && color < 0) ? cache.length + color : color]) {
                cache[(typeof color === "number" && color < 0) ? cache.length + color : color] = color_to_rgba(color);
            }
            return cache[(typeof color === "number" && color < 0) ? cache.length + color : color];
        };
        if (!cached_color_to_rgba.__argnames__) Object.defineProperties(cached_color_to_rgba, {
            __argnames__ : {value: ["color"]},
            __module__ : {value: "book_list.theme"}
        });

        cached_color_to_rgba.cache = Object.create(null);
        function get_color_as_rgba(name) {
            var cache;
            cache = get_color_as_rgba.cache;
            if (!cache[(typeof name === "number" && name < 0) ? cache.length + name : name]) {
                cache[(typeof name === "number" && name < 0) ? cache.length + name : name] = color_to_rgba(get_color(name));
            }
            return cache[(typeof name === "number" && name < 0) ? cache.length + name : name];
        };
        if (!get_color_as_rgba.__argnames__) Object.defineProperties(get_color_as_rgba, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.theme"}
        });

        get_color_as_rgba.cache = Object.create(null);
        function get_font_size(name) {
            return DEFAULT_SIZES[(typeof name === "number" && name < 0) ? DEFAULT_SIZES.length + name : name];
        };
        if (!get_font_size.__argnames__) Object.defineProperties(get_font_size, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.theme"}
        });

        function get_font_family(name) {
            name = name || "main";
            return DEFAULT_FONTS[(typeof name === "number" && name < 0) ? DEFAULT_FONTS.length + name : name];
        };
        if (!get_font_family.__argnames__) Object.defineProperties(get_font_family, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.theme"}
        });

        _modules["book_list.theme"].DARK = DARK;
        _modules["book_list.theme"].LIGHT = LIGHT;
        _modules["book_list.theme"].LIGHT_DARKER = LIGHT_DARKER;
        _modules["book_list.theme"].LIGHT_GRADIENT = LIGHT_GRADIENT;
        _modules["book_list.theme"].DT_DARK = DT_DARK;
        _modules["book_list.theme"].DT_DARK_DARKER = DT_DARK_DARKER;
        _modules["book_list.theme"].DT_DARK_LIGHTER = DT_DARK_LIGHTER;
        _modules["book_list.theme"].DT_DARK_LIGTHER_CONTRAST = DT_DARK_LIGTHER_CONTRAST;
        _modules["book_list.theme"].DT_LIGHT = DT_LIGHT;
        _modules["book_list.theme"].DARK_GRADIENT = DARK_GRADIENT;
        _modules["book_list.theme"].DEFAULT_COLORS = DEFAULT_COLORS;
        _modules["book_list.theme"].DEFAULT_SIZES = DEFAULT_SIZES;
        _modules["book_list.theme"].DEFAULT_FONTS = DEFAULT_FONTS;
        _modules["book_list.theme"].c = c;
        _modules["book_list.theme"].set_ui_colors = set_ui_colors;
        _modules["book_list.theme"].browser_in_dark_mode = browser_in_dark_mode;
        _modules["book_list.theme"].color_scheme = color_scheme;
        _modules["book_list.theme"].css_for_variables = css_for_variables;
        _modules["book_list.theme"].get_color = get_color;
        _modules["book_list.theme"].color_to_rgba = color_to_rgba;
        _modules["book_list.theme"].cached_color_to_rgba = cached_color_to_rgba;
        _modules["book_list.theme"].get_color_as_rgba = get_color_as_rgba;
        _modules["book_list.theme"].get_font_size = get_font_size;
        _modules["book_list.theme"].get_font_family = get_font_family;
    })();

    (function(){
        var __name__ = "popups";
        var MODAL_Z_INDEX, POPUP_Z_INDEX, popup_count, shown_popups, associated_widgets;
        var get_color = _modules["book_list.theme"].get_color;

        var set_css = _modules.dom.set_css;
        var ensure_id = _modules.dom.ensure_id;
        var clear = _modules.dom.clear;
        var build_rule = _modules.dom.build_rule;
        var add_extra_css = _modules.dom.add_extra_css;

        var E = _modules.elementmaker.E;

        MODAL_Z_INDEX = 1e3;
        POPUP_Z_INDEX = MODAL_Z_INDEX + 1;
        popup_count = 0;
        shown_popups = set();
        associated_widgets = Object.create(null);
        function element_contains_click_event(element, event) {
            var r;
            r = element.getBoundingClientRect();
            return r.left <= (_cond_temp = event.clientX) && _cond_temp <= r.right && r.top <= (_cond_temp = event.clientY) && _cond_temp <= r.bottom;
        };
        if (!element_contains_click_event.__argnames__) Object.defineProperties(element_contains_click_event, {
            __argnames__ : {value: ["element", "event"]},
            __module__ : {value: "popups"}
        });

        function click_in_popup(event) {
            var popup, w, widget, wid, popup_id;
            var _Iter0 = _Iterable(shown_popups);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                popup_id = _Iter0[_Index0];
                popup = document.getElementById(popup_id);
                if (popup && element_contains_click_event(popup, event)) {
                    return true;
                }
                w = associated_widgets[(typeof popup_id === "number" && popup_id < 0) ? associated_widgets.length + popup_id : popup_id];
                if (w && w.length) {
                    var _Iter1 = _Iterable(w);
                    for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                        wid = _Iter1[_Index1];
                        widget = document.getElementById(wid);
                        if (widget && element_contains_click_event(widget, event)) {
                            return true;
                        }
                    }
                }
            }
            return false;
        };
        if (!click_in_popup.__argnames__) Object.defineProperties(click_in_popup, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "popups"}
        });

        function filter_clicks(event) {
            var popup_id;
            if (shown_popups.length) {
                if (!click_in_popup(event)) {
                    var _Iter2 = _Iterable(shown_popups);
                    for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                        popup_id = _Iter2[_Index2];
                        hide_popup(popup_id);
                    }
                    shown_popups.clear();
                    [event.stopPropagation(), event.preventDefault()];
                }
            }
        };
        if (!filter_clicks.__argnames__) Object.defineProperties(filter_clicks, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "popups"}
        });

        function install_event_filters() {
            window.addEventListener("click", filter_clicks, true);
        };
        if (!install_event_filters.__module__) Object.defineProperties(install_event_filters, {
            __module__ : {value: "popups"}
        });

        function create_popup(parent, idprefix) {
            var pid, div;
            popup_count += 1;
            pid = (idprefix || "popup") + "-" + popup_count;
            div = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: pid, style: "display: none; position: fixed; z-index: {}".format(POPUP_Z_INDEX)})]);
            parent = parent || document.body;
            parent.appendChild(div);
            return div;
        };
        if (!create_popup.__argnames__) Object.defineProperties(create_popup, {
            __argnames__ : {value: ["parent", "idprefix"]},
            __module__ : {value: "popups"}
        });

        function show_popup() {
            var popup_id = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var associated_widget_ids = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_popup.__defaults__.associated_widget_ids : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "associated_widget_ids")){
                associated_widget_ids = _kwargs_obj.associated_widget_ids;
            }
            var elem;
            elem = document.getElementById(popup_id);
            elem.style.display = "block";
            shown_popups.add(popup_id);
            associated_widgets[(typeof popup_id === "number" && popup_id < 0) ? associated_widgets.length + popup_id : popup_id] = associated_widget_ids;
        };
        if (!show_popup.__defaults__) Object.defineProperties(show_popup, {
            __defaults__ : {value: {associated_widget_ids:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["popup_id", "associated_widget_ids"]},
            __module__ : {value: "popups"}
        });

        function hide_popup(popup_id) {
            var elem;
            elem = document.getElementById(popup_id);
            if (elem) {
                elem.style.display = "none";
            }
            delete associated_widgets[popup_id];
        };
        if (!hide_popup.__argnames__) Object.defineProperties(hide_popup, {
            __argnames__ : {value: ["popup_id"]},
            __module__ : {value: "popups"}
        });

        function CompletionPopup() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            CompletionPopup.prototype.__bind_methods__.call(this);
            CompletionPopup.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(CompletionPopup.prototype, "__bind_methods__", {value: function () {
            this.set_all_items = CompletionPopup.prototype.set_all_items.bind(this);
            this.add_associated_widget = CompletionPopup.prototype.add_associated_widget.bind(this);
            this.popup = CompletionPopup.prototype.popup.bind(this);
            this.show_at_widget = CompletionPopup.prototype.show_at_widget.bind(this);
            this.set_query = CompletionPopup.prototype.set_query.bind(this);
            this.hide = CompletionPopup.prototype.hide.bind(this);
            this.handle_keydown = CompletionPopup.prototype.handle_keydown.bind(this);
            this.move_highlight = CompletionPopup.prototype.move_highlight.bind(this);
            this._show_at = CompletionPopup.prototype._show_at.bind(this);
            this._apply_query = CompletionPopup.prototype._apply_query.bind(this);
            this._render_matches = CompletionPopup.prototype._render_matches.bind(this);
            this.onmouseenter = CompletionPopup.prototype.onmouseenter.bind(this);
            this.onclick = CompletionPopup.prototype.onclick.bind(this);
        }});
        Object.defineProperties(CompletionPopup.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.container_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_item": {
                "enumerable": true, 
                "get": function current_item() {
                    var self = this;
                    var c;
                    c = self.container;
                    return c.querySelector("div.{} > div.{}".format(self.CLASS, self.CURRENT_ITEM_CLASS));
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_text": {
                "enumerable": true, 
                "get": function current_text() {
                    var self = this;
                    return _exists.d(self.current_item).textContent;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        CompletionPopup.prototype.__init__ = function __init__() {
            var self = this;
            var parent = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.parent : arguments[0];
            var max_items = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.max_items : arguments[1];
            var onselect = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.onselect : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "parent")){
                parent = _kwargs_obj.parent;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "max_items")){
                max_items = _kwargs_obj.max_items;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "onselect")){
                onselect = _kwargs_obj.onselect;
            }
            var c, _unpack;
            self.max_items = max_items;
            c = create_popup(parent);
            _interpolate_kwargs.call(this, set_css, [c].concat([_desugar_kwargs({user_select: "none"})]));
            self.container_id = c.getAttribute("id");
            self.onselect = onselect;
            self.items = _list_decorate([]);
            self.matches = _list_decorate([]);
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: self.CLASS})]));
            self.associated_widget_ids = set();
            _unpack = ["", false];
            self.current_query = _unpack[0];
            self.is_upwards = _unpack[1];
            self.applied_query = self.current_query;
        };
        if (!CompletionPopup.prototype.__init__.__defaults__) Object.defineProperties(CompletionPopup.prototype.__init__, {
            __defaults__ : {value: {parent:null, max_items:25, onselect:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["parent", "max_items", "onselect"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.__argnames__ = CompletionPopup.prototype.__init__.__argnames__;
        CompletionPopup.__handles_kwarg_interpolation__ = CompletionPopup.prototype.__init__.__handles_kwarg_interpolation__;
        CompletionPopup.prototype.set_all_items = function set_all_items(items) {
            var self = this;
            self.items = list(items);
            self.matches = _list_decorate([]);
            self.applied_query = null;
        };
        if (!CompletionPopup.prototype.set_all_items.__argnames__) Object.defineProperties(CompletionPopup.prototype.set_all_items, {
            __argnames__ : {value: ["items"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.add_associated_widget = function add_associated_widget(widget_or_id) {
            var self = this;
            if (typeof widget_or_id !== "string") {
                widget_or_id = ensure_id(widget_or_id);
            }
            self.associated_widget_ids.add(widget_or_id);
        };
        if (!CompletionPopup.prototype.add_associated_widget.__argnames__) Object.defineProperties(CompletionPopup.prototype.add_associated_widget, {
            __argnames__ : {value: ["widget_or_id"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.popup = function popup(widget) {
            var self = this;
            if (!self.is_visible) {
                if (self.applied_query !== self.current_query) {
                    self._apply_query();
                }
                if (self.matches.length) {
                    self.show_at_widget(widget);
                }
            }
        };
        if (!CompletionPopup.prototype.popup.__argnames__) Object.defineProperties(CompletionPopup.prototype.popup, {
            __argnames__ : {value: ["widget"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.show_at_widget = function show_at_widget(w) {
            var self = this;
            var br, _unpack, y, upwards;
            br = w.getBoundingClientRect();
            if (br.top > window.innerHeight - br.bottom) {
                _unpack = [br.top, true];
                y = _unpack[0];
                upwards = _unpack[1];
            } else {
                _unpack = [br.bottom, false];
                y = _unpack[0];
                upwards = _unpack[1];
            }
            self._show_at(br.left, y, br.width, upwards);
        };
        if (!CompletionPopup.prototype.show_at_widget.__argnames__) Object.defineProperties(CompletionPopup.prototype.show_at_widget, {
            __argnames__ : {value: ["w"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.set_query = function set_query(query) {
            var self = this;
            self.current_query = query;
            if (self.is_visible && self.applied_query !== self.current_query) {
                self._apply_query();
                if (!self.matches.length) {
                    self.hide();
                }
            }
        };
        if (!CompletionPopup.prototype.set_query.__argnames__) Object.defineProperties(CompletionPopup.prototype.set_query, {
            __argnames__ : {value: ["query"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.hide = function hide() {
            var self = this;
            var c;
            self.container.style.display = "none";
            c = self.current_item;
            if (c) {
                c.classList.remove(self.CURRENT_ITEM_CLASS);
            }
        };
        if (!CompletionPopup.prototype.hide.__module__) Object.defineProperties(CompletionPopup.prototype.hide, {
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.handle_keydown = function handle_keydown(event) {
            var self = this;
            var key;
            key = event.key;
            if (key === "Escape" || key === "Esc") {
                self.hide();
                return true;
            }
            if (key === "ArrowUp") {
                self.move_highlight(true);
                return true;
            }
            if (key === "ArrowDown") {
                self.move_highlight(false);
                return true;
            }
            return false;
        };
        if (!CompletionPopup.prototype.handle_keydown.__argnames__) Object.defineProperties(CompletionPopup.prototype.handle_keydown, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.move_highlight = function move_highlight() {
            var self = this;
            var up = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? move_highlight.__defaults__.up : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "up")){
                up = _kwargs_obj.up;
            }
            var ans, div, c;
            if (up === null) {
                up = self.is_upwards;
            }
            ans = null;
            div = self.current_item;
            if (div) {
                div.classList.remove(self.CURRENT_ITEM_CLASS);
                ans = (up) ? div.previousSibling : div.nextSibling;
            }
            if (!ans) {
                c = self.container.firstChild;
                ans = (up) ? c.lastChild : c.firstChild;
            }
            if (ans) {
                ans.classList.add(self.CURRENT_ITEM_CLASS);
            }
        };
        if (!CompletionPopup.prototype.move_highlight.__defaults__) Object.defineProperties(CompletionPopup.prototype.move_highlight, {
            __defaults__ : {value: {up:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["up"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype._show_at = function _show_at(x, y, width, upwards) {
            var self = this;
            var c, cs;
            self.is_upwards = upwards;
            c = self.container;
            cs = c.style;
            cs.left = x + "px";
            cs.top = (upwards) ? "auto" : y + "px";
            cs.bottom = (upwards) ? window.innerHeight - y + "px" : "auto";
            cs.width = width + "px";
            cs.maxHeight = ((upwards) ? y : window.innerHeight - y) - 10 + "px";
            show_popup(self.container_id, self.associated_widget_ids);
        };
        if (!CompletionPopup.prototype._show_at.__argnames__) Object.defineProperties(CompletionPopup.prototype._show_at, {
            __argnames__ : {value: ["x", "y", "width", "upwards"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype._apply_query = function _apply_query() {
            var self = this;
            var q, i;
            q = self.current_query.toLowerCase();
            self.matches.clear();
            self.applied_query = self.current_query;
            if (!q) {
                self.matches = list(self.items.slice(0, self.max_items + 1));
            } else {
                i = 0;
                while (self.matches.length < self.max_items && i < self.items.length) {
                    if ((_expr_temp = self.items)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i].toLowerCase().startswith(q)) {
                        self.matches.push((_expr_temp = self.items)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i]);
                    }
                    i += 1;
                }
            }
            self._render_matches();
        };
        if (!CompletionPopup.prototype._apply_query.__module__) Object.defineProperties(CompletionPopup.prototype._apply_query, {
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype._render_matches = function _render_matches() {
            var self = this;
            var c, items, m;
            c = self.container;
            clear(c.firstChild);
            items = self.matches;
            if (self.is_upwards) {
                items = reversed(items);
            }
            var _Iter3 = _Iterable(items);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                m = _Iter3[_Index3];
                c.firstChild.appendChild(_interpolate_kwargs.call(E, E.div, [m].concat([_desugar_kwargs({onmouseenter: self.onmouseenter, onclick: self.onclick})])));
            }
        };
        if (!CompletionPopup.prototype._render_matches.__module__) Object.defineProperties(CompletionPopup.prototype._render_matches, {
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.onmouseenter = function onmouseenter(event) {
            var self = this;
            var div;
            div = self.current_item;
            if (div) {
                div.classList.remove(self.CURRENT_ITEM_CLASS);
            }
            event.currentTarget.classList.add(self.CURRENT_ITEM_CLASS);
        };
        if (!CompletionPopup.prototype.onmouseenter.__argnames__) Object.defineProperties(CompletionPopup.prototype.onmouseenter, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.onclick = function onclick(event) {
            var self = this;
            self.onmouseenter(event);
            try {
                if (self.onselect) {
                    self.onselect(self.current_text);
                }
            } finally {
                self.hide();
            }
        };
        if (!CompletionPopup.prototype.onclick.__argnames__) Object.defineProperties(CompletionPopup.prototype.onclick, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "popups"}
        });
        CompletionPopup.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        CompletionPopup.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(CompletionPopup.prototype, "__bases__", {value: []});
        CompletionPopup.prototype.CLASS = "popup-completion-items";
        CompletionPopup.prototype.CURRENT_ITEM_CLASS = "popup-completion-current-item";
        
        
        
        

        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "div." + CompletionPopup.prototype.CLASS;
                style = _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({overflow: "hidden", text_align: "left", background_color: get_color("window-background"), border: "solid 1px " + get_color("window-foreground")})]));
                sel += " > div";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({cursor: "pointer", padding: "1ex 1rem", white_space: "nowrap", text_overflow: "ellipsis", overflow: "hidden"})]));
                sel += "." + CompletionPopup.prototype.CURRENT_ITEM_CLASS;
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({color: get_color("list-hover-foreground"), background_color: get_color("list-hover-background")})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "popups"}
            });
            return _anonfunc;
        })());
        _modules.popups.MODAL_Z_INDEX = MODAL_Z_INDEX;
        _modules.popups.POPUP_Z_INDEX = POPUP_Z_INDEX;
        _modules.popups.popup_count = popup_count;
        _modules.popups.shown_popups = shown_popups;
        _modules.popups.associated_widgets = associated_widgets;
        _modules.popups.element_contains_click_event = element_contains_click_event;
        _modules.popups.click_in_popup = click_in_popup;
        _modules.popups.filter_clicks = filter_clicks;
        _modules.popups.install_event_filters = install_event_filters;
        _modules.popups.create_popup = create_popup;
        _modules.popups.show_popup = show_popup;
        _modules.popups.hide_popup = hide_popup;
        _modules.popups.CompletionPopup = CompletionPopup;
    })();

    (function(){
        var __name__ = "encodings";
        var utf8_decoder_table, _u8enc, utf8_encode;
        function base64encode(bytes, altchars, pad_char) {
            var l, remainder, main_length, encodings, ans, chunk;
            l = bytes.length;
            remainder = l % 3;
            main_length = l - remainder;
            encodings = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789" + (altchars || "+/");
            pad_char = (pad_char === undefined) ? "=" : pad_char;
            ans = [];
            for (var i = 0; i < main_length; i += 3) {
                chunk = bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i] << 16 | bytes[_bound_index(i + 1, bytes)] << 8 | bytes[_bound_index(i + 2, bytes)];
                ans.push(encodings[_bound_index((chunk & 16515072) >> 18, encodings)], encodings[_bound_index((chunk & 258048) >> 12, encodings)], encodings[_bound_index((chunk & 4032) >> 6, encodings)], encodings[_bound_index(chunk & 63, encodings)]);
            }
            if (remainder === 1) {
                chunk = bytes[(typeof main_length === "number" && main_length < 0) ? bytes.length + main_length : main_length];
                ans.push(encodings[_bound_index((chunk & 252) >> 2, encodings)], encodings[_bound_index((chunk & 3) << 4, encodings)], pad_char, pad_char);
            } else if (remainder === 2) {
                chunk = bytes[(typeof main_length === "number" && main_length < 0) ? bytes.length + main_length : main_length] << 8 | bytes[_bound_index(main_length + 1, bytes)];
                ans.push(encodings[_bound_index((chunk & 64512) >> 10, encodings)], encodings[_bound_index((chunk & 1008) >> 4, encodings)], encodings[_bound_index((chunk & 15) << 2, encodings)], pad_char);
            }
            return ans.join("");
        };
        if (!base64encode.__argnames__) Object.defineProperties(base64encode, {
            __argnames__ : {value: ["bytes", "altchars", "pad_char"]},
            __module__ : {value: "encodings"}
        });

        function base64decode(string) {
            var chars, ans, i;
            if (typeof window !== "undefined") {
                chars = window.atob(string);
            } else {
                chars = new Buffer(string, "base64").toString("binary");
            }
            ans = new Uint8Array(chars.length);
            for (var _Index0 = 0; _Index0 < ans.length; _Index0++) {
                i = _Index0;
                ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = chars.charCodeAt(i);
            }
            return ans;
        };
        if (!base64decode.__argnames__) Object.defineProperties(base64decode, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "encodings"}
        });

        function urlsafe_b64encode(bytes, pad_char) {
            return base64encode(bytes, "-_", pad_char);
        };
        if (!urlsafe_b64encode.__argnames__) Object.defineProperties(urlsafe_b64encode, {
            __argnames__ : {value: ["bytes", "pad_char"]},
            __module__ : {value: "encodings"}
        });

        function urlsafe_b64decode(string) {
            string = String.prototype.replace.call(string, /[_-]/g, (function() {
                var _anonfunc = function (m) {
                    return (m === "-") ? "+" : "/";
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["m"]},
                    __module__ : {value: "encodings"}
                });
                return _anonfunc;
            })());
            return base64decode(string);
        };
        if (!urlsafe_b64decode.__argnames__) Object.defineProperties(urlsafe_b64decode, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "encodings"}
        });

        function hexlify(bytes) {
            var ans, x;
            ans = [];
            for (var i = 0; i < bytes.length; i++) {
                x = bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i].toString(16);
                if (x.length === 1) {
                    x = "0" + x;
                }
                ans.push(x);
            }
            return ans.join("");
        };
        if (!hexlify.__argnames__) Object.defineProperties(hexlify, {
            __argnames__ : {value: ["bytes"]},
            __module__ : {value: "encodings"}
        });

        function unhexlify(string) {
            var num, ans, x;
            num = Math.floor(string.length / 2);
            if (num * 2 !== string.length) {
                throw new ValueError("string length is not a multiple of two");
            }
            ans = new Uint8Array(num);
            for (var i = 0; i < num; i++) {
                x = parseInt(string.slice(i * 2, i * 2 + 2), 16);
                if (isNaN(x)) {
                    throw new ValueError("string is not hex-encoded");
                }
                ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = x;
            }
            return ans;
        };
        if (!unhexlify.__argnames__) Object.defineProperties(unhexlify, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "encodings"}
        });

        utf8_decoder_table = [
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, // 00..1f
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, // 20..3f
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, // 40..5f
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, // 60..7f
  1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9, // 80..9f
  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7, // a0..bf
  8,8,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, // c0..df
  0xa,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x4,0x3,0x3, // e0..ef
  0xb,0x6,0x6,0x6,0x5,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8, // f0..ff
  0x0,0x1,0x2,0x3,0x5,0x8,0x7,0x1,0x1,0x1,0x4,0x6,0x1,0x1,0x1,0x1, // s0..s0
  1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1,1,1,1,1, // s1..s2
  1,2,1,1,1,1,1,2,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1, // s3..s4
  1,2,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,3,1,3,1,1,1,1,1,1, // s5..s6
  1,3,1,1,1,1,1,3,1,3,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1, // s7..s8
];
        function _from_code_point(x) {
            if (x <= 65535) {
                return String.fromCharCode(x);
            }
            x -= 65536;
            return String.fromCharCode((x >> 10) + 55296, x % 1024 + 56320);
        };
        if (!_from_code_point.__argnames__) Object.defineProperties(_from_code_point, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "encodings"}
        });

        function utf8_decode(bytes, errors, replacement) {
            var state, ans, byte, typ, codep;
            state = 0;
            ans = [];
            for (var i = 0, l = bytes.length; i < l; i++) {
                byte = bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i];
                typ = utf8_decoder_table[(typeof byte === "number" && byte < 0) ? utf8_decoder_table.length + byte : byte];
                codep = (state !== 0) ? byte & 63 | codep << 6 : 255 >> typ & byte;
                state = utf8_decoder_table[_bound_index(256 + state * 16 + typ, utf8_decoder_table)];
                if (state === 0) {
                    ans.push(_from_code_point(codep));
                } else if (state === 1) {
                    if (!errors || errors === "strict") {
                        throw new UnicodeDecodeError(str.format("The byte 0x{:02x} at position {} is not valid UTF-8", byte, i));
                    } else if (errors === "replace") {
                        ans.push(replacement || "?");
                    }
                }
            }
            return ans.join("");
        };
        if (!utf8_decode.__argnames__) Object.defineProperties(utf8_decode, {
            __argnames__ : {value: ["bytes", "errors", "replacement"]},
            __module__ : {value: "encodings"}
        });

        function utf8_encode_js(string) {
            var escstr, ans, ch, i;
            escstr = encodeURIComponent(string);
            ans = [];
            for (var i = 0; i < escstr.length; i++) {
                ch = escstr[(typeof i === "number" && i < 0) ? escstr.length + i : i];
                if (ch === "%") {
                    ans.push(parseInt(escstr.slice(i + 1, i + 3), 16));
                    i += 2;
                } else {
                    ans.push(ch.charCodeAt(0));
                }
            }
            return new Uint8Array(ans);
        };
        if (!utf8_encode_js.__argnames__) Object.defineProperties(utf8_encode_js, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "encodings"}
        });

        if (typeof TextEncoder === "function") {
            _u8enc = new TextEncoder("utf-8");
            utf8_encode = _u8enc.encode.bind(_u8enc);
            _u8enc = undefined;
        } else {
            utf8_encode = utf8_encode_js;
        }
        function utf8_encode_native(string) {
            return _u8enc.encode(string);
        };
        if (!utf8_encode_native.__argnames__) Object.defineProperties(utf8_encode_native, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "encodings"}
        });

        _modules.encodings.utf8_decoder_table = utf8_decoder_table;
        _modules.encodings._u8enc = _u8enc;
        _modules.encodings.utf8_encode = utf8_encode;
        _modules.encodings.base64encode = base64encode;
        _modules.encodings.base64decode = base64decode;
        _modules.encodings.urlsafe_b64encode = urlsafe_b64encode;
        _modules.encodings.urlsafe_b64decode = urlsafe_b64decode;
        _modules.encodings.hexlify = hexlify;
        _modules.encodings.unhexlify = unhexlify;
        _modules.encodings._from_code_point = _from_code_point;
        _modules.encodings.utf8_decode = utf8_decode;
        _modules.encodings.utf8_encode_js = utf8_encode_js;
        _modules.encodings.utf8_encode_native = utf8_encode_native;
    })();

    (function(){
        var __name__ = "utils";
        var is_ios, ios_major_version, v, copy_hash, _roman, _data_ns;
        var encode_query = _modules.ajax.encode_query;

        var hexlify = _modules.encodings.hexlify;

        var get_font_family = _modules["book_list.theme"].get_font_family;

        is_ios = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
        ios_major_version = 0;
        if (!is_ios && !!navigator.platform && (typeof window !== "undefined" && window !== null) && window.navigator.platform === "MacIntel" && window.navigator.maxTouchPoints > 1) {
            is_ios = true;
        }
        if (is_ios) {
            v = navigator.appVersion.match(/OS (\d+)/);
            if (v && v[1]) {
                ios_major_version = parseInt(v[1], 10) || 0;
            }
        }
        function default_context_menu_should_be_allowed(evt) {
            if (evt.target && evt.target.tagName && _in(evt.target.tagName.toLowerCase(), ["input", 
            "textarea"])) {
                return true;
            }
            return false;
        };
        if (!default_context_menu_should_be_allowed.__argnames__) Object.defineProperties(default_context_menu_should_be_allowed, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "utils"}
        });

        function debounce() {
            var func = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var wait = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var immediate = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? debounce.__defaults__.immediate : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "immediate")){
                immediate = _kwargs_obj.immediate;
            }
            var timeout;
            timeout = null;
            return (function() {
                var _anonfunc = function debounce_inner() {
                    var _unpack, context, args, call_now;
                    _unpack = [this, arguments];
                    context = _unpack[0];
                    args = _unpack[1];
                    function later() {
                        timeout = null;
                        if (!immediate) {
                            func.apply(context, args);
                        }
                    };
                    if (!later.__module__) Object.defineProperties(later, {
                        __module__ : {value: "utils"}
                    });

                    call_now = immediate && !timeout;
                    window.clearTimeout(timeout);
                    timeout = window.setTimeout(later, wait);
                    if (call_now) {
                        func.apply(context, args);
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "utils"}
                });
                return _anonfunc;
            })();
        };
        if (!debounce.__defaults__) Object.defineProperties(debounce, {
            __defaults__ : {value: {immediate:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["func", "wait", "immediate"]},
            __module__ : {value: "utils"}
        });

        if (Object.assign) {
            copy_hash = (function() {
                var _anonfunc = function (obj) {
                    return Object.assign(Object.create(null), obj);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["obj"]},
                    __module__ : {value: "utils"}
                });
                return _anonfunc;
            })();
        } else {
            copy_hash = (function() {
                var _anonfunc = function (obj) {
                    return (function() {
                        var _Iter = _Iterable(Object.keys(obj)), _Result = Object.create(null), k;
                        for (var _Index = 0; _Index < _Iter.length; _Index++) {
                            k = _Iter[_Index];
                            _Result[k] = (obj[(typeof k === "number" && k < 0) ? obj.length + k : k]);
                        }
                        return _Result;
                    })();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["obj"]},
                    __module__ : {value: "utils"}
                });
                return _anonfunc;
            })();
        }
        function parse_url_params() {
            var url = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? parse_url_params.__defaults__.url : arguments[0];
            var allow_multiple = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? parse_url_params.__defaults__.allow_multiple : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "url")){
                url = _kwargs_obj.url;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "allow_multiple")){
                allow_multiple = _kwargs_obj.allow_multiple;
            }
            var cache, qs, ans, q, pairs, _unpack, key, val, pair;
            cache = parse_url_params.cache;
            url = url || window.location.href;
            if (cache[(typeof url === "number" && url < 0) ? cache.length + url : url]) {
                return copy_hash((_expr_temp = parse_url_params.cache)[(typeof url === "number" && url < 0) ? _expr_temp.length + url : url]);
            }
            qs = url.indexOf("#");
            ans = Object.create(null);
            if (qs < 0) {
                cache[(typeof url === "number" && url < 0) ? cache.length + url : url] = ans;
                return copy_hash(ans);
            }
            q = url.slice(qs + 1, url.length + 1);
            if (!q) {
                cache[(typeof url === "number" && url < 0) ? cache.length + url : url] = ans;
                return copy_hash(ans);
            }
            pairs = q.replace(/\+/g, " ").split("&");
            var _Iter0 = _Iterable(pairs);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                pair = _Iter0[_Index0];
                _unpack = _eslice(pair.partition("="), 2);
_unpack = _unpack_asarray(2, _unpack);
                key = _unpack[0];
                val = _unpack[1];
                _unpack = [decodeURIComponent(key), decodeURIComponent(val)];
                key = _unpack[0];
                val = _unpack[1];
                if (allow_multiple) {
                    if (ans[(typeof key === "number" && key < 0) ? ans.length + key : key] === undefined) {
                        ans[(typeof key === "number" && key < 0) ? ans.length + key : key] = [];
                    }
                    ans[(typeof key === "number" && key < 0) ? ans.length + key : key].append(val);
                } else {
                    ans[(typeof key === "number" && key < 0) ? ans.length + key : key] = val;
                }
            }
            cache[(typeof url === "number" && url < 0) ? cache.length + url : url] = ans;
            return copy_hash(ans);
        };
        if (!parse_url_params.__defaults__) Object.defineProperties(parse_url_params, {
            __defaults__ : {value: {url:null, allow_multiple:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["url", "allow_multiple"]},
            __module__ : {value: "utils"}
        });

        parse_url_params.cache = Object.create(null);
        function encode_query_with_path(query, path) {
            path = path || window.location.pathname;
            return path + encode_query(query, "#");
        };
        if (!encode_query_with_path.__argnames__) Object.defineProperties(encode_query_with_path, {
            __argnames__ : {value: ["query", "path"]},
            __module__ : {value: "utils"}
        });

        function full_screen_supported(elem) {
            elem = elem || document.documentElement;
            if (elem.requestFullScreen || elem.webkitRequestFullScreen || elem.mozRequestFullScreen) {
                return true;
            }
            return false;
        };
        if (!full_screen_supported.__argnames__) Object.defineProperties(full_screen_supported, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "utils"}
        });

        function request_full_screen(elem) {
            var options;
            elem = elem || document.documentElement;
            options = (function(){
                var _d = Object.create(null);
                _d["navigationUI"] = "hide";
                return _d;
            }).call(this);
            if (elem.requestFullScreen) {
                elem.requestFullScreen(options);
            } else if (elem.webkitRequestFullScreen) {
                elem.webkitRequestFullScreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            }
        };
        if (!request_full_screen.__argnames__) Object.defineProperties(request_full_screen, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "utils"}
        });

        function full_screen_element() {
            return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        };
        if (!full_screen_element.__module__) Object.defineProperties(full_screen_element, {
            __module__ : {value: "utils"}
        });

        _roman = list(zip(_list_decorate([ 1e3, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1 ]), _list_decorate([ "M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I" ])));
        function roman(num) {
            var result, _unpack, d, r;
            if (num <= 0 || num >= 4e3 || int(num) !== num) {
                return num + "";
            }
            result = _list_decorate([]);
            var _Iter1 = _Iterable(_roman);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                _unpack = _Iter1[_Index1];
                d = _unpack[0];
                r = _unpack[1];
                while (num >= d) {
                    result.append(r);
                    num -= d;
                }
            }
            return result.join("");
        };
        if (!roman.__argnames__) Object.defineProperties(roman, {
            __argnames__ : {value: ["num"]},
            __module__ : {value: "utils"}
        });

        function fmt_sidx() {
            var val = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var fmt = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? fmt_sidx.__defaults__.fmt : arguments[1];
            var use_roman = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? fmt_sidx.__defaults__.use_roman : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "fmt")){
                fmt = _kwargs_obj.fmt;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "use_roman")){
                use_roman = _kwargs_obj.use_roman;
            }
            if (val === undefined || val === null || val === "") {
                return "1";
            }
            if (int(val) === float(val)) {
                if (use_roman) {
                    return roman(val);
                }
                return int(val) + "";
            }
            return fmt.format(float(val));
        };
        if (!fmt_sidx.__defaults__) Object.defineProperties(fmt_sidx, {
            __defaults__ : {value: {fmt:"{:.2f}", use_roman:true}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["val", "fmt", "use_roman"]},
            __module__ : {value: "utils"}
        });

        function rating_to_stars() {
            var value = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var allow_half_stars = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? rating_to_stars.__defaults__.allow_half_stars : arguments[1];
            var star = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? rating_to_stars.__defaults__.star : arguments[2];
            var half = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? rating_to_stars.__defaults__.half : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "allow_half_stars")){
                allow_half_stars = _kwargs_obj.allow_half_stars;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "star")){
                star = _kwargs_obj.star;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "half")){
                half = _kwargs_obj.half;
            }
            var r, ans;
            r = max(0, min(int(value || 0), 10));
            if (allow_half_stars) {
                ans = star.repeat(Math.floor(r / 2));
                if (r % 2) {
                    ans += half;
                }
            } else {
                ans = star.repeat(int(r / 2));
            }
            return ans;
        };
        if (!rating_to_stars.__defaults__) Object.defineProperties(rating_to_stars, {
            __defaults__ : {value: {allow_half_stars:false, star:"", half:""}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["value", "allow_half_stars", "star", "half"]},
            __module__ : {value: "utils"}
        });

        function human_readable() {
            var size = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var sep = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? human_readable.__defaults__.sep : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "sep")){
                sep = _kwargs_obj.sep;
            }
            var _unpack, divisor, suffix, i, candidate, pos;
            _unpack = [1, "B"];
            divisor = _unpack[0];
            suffix = _unpack[1];
            var _Iter2 = _Iterable(enumerate(["B", "KB", "MB", "GB", "TB", "PB", "EB"]));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                _unpack = _Iter2[_Index2];
                i = _unpack[0];
                candidate = _unpack[1];
                if (size < 1 << (i + 1) * 10) {
                    _unpack = [1 << i * 10, candidate];
                    divisor = _unpack[0];
                    suffix = _unpack[1];
                    break;
                }
            }
            size = float(size) / divisor + "";
            pos = size.find(".");
            if (pos > -1) {
                size = size.slice(0, pos + 2);
            }
            if (size.endswith(".0")) {
                size = size.slice(0, -2);
            }
            return size + sep + suffix;
        };
        if (!human_readable.__defaults__) Object.defineProperties(human_readable, {
            __defaults__ : {value: {sep:" "}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["size", "sep"]},
            __module__ : {value: "utils"}
        });

        function document_height() {
            var html;
            html = document.documentElement;
            return max(document.body.scrollHeight, document.body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
        };
        if (!document_height.__module__) Object.defineProperties(document_height, {
            __module__ : {value: "utils"}
        });

        function document_width() {
            var html;
            html = document.documentElement;
            return max(document.body.scrollWidth, document.body.offsetWidth, html.clientWidth, html.scrollWidth, html.offsetWidth);
        };
        if (!document_width.__module__) Object.defineProperties(document_width, {
            __module__ : {value: "utils"}
        });

        _data_ns = null;
        function data_ns(name) {
            var rand;
            if (_data_ns === null) {
                rand = new Uint8Array(12);
                window.crypto.getRandomValues(rand);
                _data_ns = "data-" + hexlify(rand) + "-";
            }
            return _data_ns + name;
        };
        if (!data_ns.__argnames__) Object.defineProperties(data_ns, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "utils"}
        });

        function get_elem_data(elem, name, defval) {
            var ans;
            ans = elem.getAttribute(data_ns(name));
            if (ans === null) {
                return (typeof defval !== "undefined" && defval !== null ? defval : null);
            }
            return JSON.parse(ans);
        };
        if (!get_elem_data.__argnames__) Object.defineProperties(get_elem_data, {
            __argnames__ : {value: ["elem", "name", "defval"]},
            __module__ : {value: "utils"}
        });

        function set_elem_data(elem, name, val) {
            elem.setAttribute(data_ns(name), JSON.stringify(val));
        };
        if (!set_elem_data.__argnames__) Object.defineProperties(set_elem_data, {
            __argnames__ : {value: ["elem", "name", "val"]},
            __module__ : {value: "utils"}
        });

        function username_key(username) {
            return ((username) ? "u" : "n") + username;
        };
        if (!username_key.__argnames__) Object.defineProperties(username_key, {
            __argnames__ : {value: ["username"]},
            __module__ : {value: "utils"}
        });

        function html_escape(text) {
            var repl;
            repl = (function(){
                var _d = Object.create(null);
                _d["&"] = "&amp;";
                _d["\""] = "&quot;";
                _d["<"] = "&lt;";
                _d[">"] = "&gt;";
                return _d;
            }).call(this);
            return String.prototype.replace.call(text, /[&"<>]/g, (function() {
                var _anonfunc = function (c) {
                    return repl[(typeof c === "number" && c < 0) ? repl.length + c : c];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["c"]},
                    __module__ : {value: "utils"}
                });
                return _anonfunc;
            })());
        };
        if (!html_escape.__argnames__) Object.defineProperties(html_escape, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "utils"}
        });

        function uniq(vals) {
            var ans, seen, x;
            ans = [];
            seen = Object.create(null);
            var _Iter3 = _Iterable(vals);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                x = _Iter3[_Index3];
                if (!seen[(typeof x === "number" && x < 0) ? seen.length + x : x]) {
                    seen[(typeof x === "number" && x < 0) ? seen.length + x : x] = true;
                    ans.push(x);
                }
            }
            return ans;
        };
        if (!uniq.__argnames__) Object.defineProperties(uniq, {
            __argnames__ : {value: ["vals"]},
            __module__ : {value: "utils"}
        });

        function conditional_timeout(elem_id, timeout, func) {
            function ct_impl() {
                var elem;
                elem = document.getElementById(elem_id);
                if (elem) {
                    func.call(elem);
                }
            };
            if (!ct_impl.__module__) Object.defineProperties(ct_impl, {
                __module__ : {value: "utils"}
            });

            window.setTimeout(ct_impl, timeout);
        };
        if (!conditional_timeout.__argnames__) Object.defineProperties(conditional_timeout, {
            __argnames__ : {value: ["elem_id", "timeout", "func"]},
            __module__ : {value: "utils"}
        });

        function simple_markup(html) {
            var div;
            html = (html || "").replace(/\uffff/g, "").replace(/<\s*(\/?[a-zA-Z1-6]+)[^>]*>/g, (function() {
                var _anonfunc = function (match, tag) {
                    var is_closing;
                    tag = tag.toLowerCase();
                    is_closing = (tag[0] === "/") ? "/" : "";
                    if (is_closing) {
                        tag = tag.slice(1);
                    }
                    if (simple_markup.allowed_tags.indexOf(tag) < 0) {
                        tag = "span";
                    }
                    return "\uffff" + _str.format("{}", is_closing) + "" + _str.format("{}", tag) + "\uffff";
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["match", "tag"]},
                    __module__ : {value: "utils"}
                });
                return _anonfunc;
            })());
            div = document.createElement("b");
            div.textContent = html;
            html = div.innerHTML;
            return html.replace(/\uffff(\/?[a-z1-6]+)\uffff/g, "<$1>");
        };
        if (!simple_markup.__argnames__) Object.defineProperties(simple_markup, {
            __argnames__ : {value: ["html"]},
            __module__ : {value: "utils"}
        });

        simple_markup.allowed_tags = 'a|b|i|br|hr|h1|h2|h3|h4|h5|h6|div|em|strong|span'.split('|');
        function safe_set_inner_html(elem, html) {
            elem.innerHTML = simple_markup(html);
            return elem;
        };
        if (!safe_set_inner_html.__argnames__) Object.defineProperties(safe_set_inner_html, {
            __argnames__ : {value: ["elem", "html"]},
            __module__ : {value: "utils"}
        });

        function sandboxed_html(html, style, sandbox) {
            var ans, css, final_html;
            ans = document.createElement("iframe");
            ans.setAttribute("sandbox", sandbox || "");
            ans.setAttribute("seamless", "");
            ans.style.width = "100%";
            html = html || "";
            css = "html, body { margin: 0; padding: 0; font-family: __FONT__ } p:first-child { margin-top: 0; padding-top: 0; -webkit-margin-before: 0 }".replace("__FONT__", get_font_family());
            css += style || "";
            final_html = "<!DOCTYPE html><html><head><style>" + _str.format("{}", css) + "</style></head><body>" + _str.format("{}", html) + "</body></html>";
            ans.srcdoc = final_html;
            return ans;
        };
        if (!sandboxed_html.__argnames__) Object.defineProperties(sandboxed_html, {
            __argnames__ : {value: ["html", "style", "sandbox"]},
            __module__ : {value: "utils"}
        });

        _modules.utils.is_ios = is_ios;
        _modules.utils.ios_major_version = ios_major_version;
        _modules.utils.v = v;
        _modules.utils.copy_hash = copy_hash;
        _modules.utils._roman = _roman;
        _modules.utils._data_ns = _data_ns;
        _modules.utils.default_context_menu_should_be_allowed = default_context_menu_should_be_allowed;
        _modules.utils.debounce = debounce;
        _modules.utils.parse_url_params = parse_url_params;
        _modules.utils.encode_query_with_path = encode_query_with_path;
        _modules.utils.full_screen_supported = full_screen_supported;
        _modules.utils.request_full_screen = request_full_screen;
        _modules.utils.full_screen_element = full_screen_element;
        _modules.utils.roman = roman;
        _modules.utils.fmt_sidx = fmt_sidx;
        _modules.utils.rating_to_stars = rating_to_stars;
        _modules.utils.human_readable = human_readable;
        _modules.utils.document_height = document_height;
        _modules.utils.document_width = document_width;
        _modules.utils.data_ns = data_ns;
        _modules.utils.get_elem_data = get_elem_data;
        _modules.utils.set_elem_data = set_elem_data;
        _modules.utils.username_key = username_key;
        _modules.utils.html_escape = html_escape;
        _modules.utils.uniq = uniq;
        _modules.utils.conditional_timeout = conditional_timeout;
        _modules.utils.simple_markup = simple_markup;
        _modules.utils.safe_set_inner_html = safe_set_inner_html;
        _modules.utils.sandboxed_html = sandboxed_html;
    })();

    (function(){
        var __name__ = "widgets";
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;
        var create_keyframes = _modules.dom.create_keyframes;
        var set_css = _modules.dom.set_css;
        var change_icon_image = _modules.dom.change_icon_image;
        var add_extra_css = _modules.dom.add_extra_css;
        var ensure_id = _modules.dom.ensure_id;

        var E = _modules.elementmaker.E;

        var get_color = _modules["book_list.theme"].get_color;

        function create_button() {
            var text = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var icon = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_button.__defaults__.icon : arguments[1];
            var action = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_button.__defaults__.action : arguments[2];
            var tooltip = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_button.__defaults__.tooltip : arguments[3];
            var highlight = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_button.__defaults__.highlight : arguments[4];
            var download_filename = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_button.__defaults__.download_filename : arguments[5];
            var class_ = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_button.__defaults__.class_ : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "icon")){
                icon = _kwargs_obj.icon;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "action")){
                action = _kwargs_obj.action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "highlight")){
                highlight = _kwargs_obj.highlight;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "download_filename")){
                download_filename = _kwargs_obj.download_filename;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "class_")){
                class_ = _kwargs_obj.class_;
            }
            var ic, ans;
            ic = "";
            if (icon) {
                ic = svgicon(icon);
                text = "" + text;
            }
            ans = _interpolate_kwargs.call(E, E.a, [ic, E.span(text)].concat([_desugar_kwargs({class_: "calibre-push-button " + class_, href: "javascript: void(0)", role: "button", title: tooltip || ""})]));
            if (download_filename && "download" in ans) {
                ans.setAttribute("download", download_filename);
            }
            if (action !== null) {
                if (typeof action === "string") {
                    ans.setAttribute("href", action);
                } else {
                    ans.addEventListener("click", (function() {
                        var _anonfunc = function (event) {
                            [event.preventDefault(), action(event)];
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["event"]},
                            __module__ : {value: "widgets"}
                        });
                        return _anonfunc;
                    })());
                }
            }
            if (highlight) {
                _interpolate_kwargs.call(this, set_css, [ans].concat([_desugar_kwargs({font_size: "larger", font_weight: "bold"})]));
            }
            return ans;
        };
        if (!create_button.__defaults__) Object.defineProperties(create_button, {
            __defaults__ : {value: {icon:null, action:null, tooltip:null, highlight:false, download_filename:null, class_:""}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["text", "icon", "action", "tooltip", "highlight", "download_filename", "class_"]},
            __module__ : {value: "widgets"}
        });

        create_button.style = _interpolate_kwargs.call(this, build_rule, ["a.calibre-push-button"].concat([_desugar_kwargs({border_radius: "1em", background_clip: "padding-box", background_color: get_color("button-start"), background_image: "linear-gradient(to bottom, {}, {})".format(get_color("button-start"), get_color("button-end")), padding: "0.5ex 1em", color: get_color("button-text"), cursor: "pointer", font_size: "inherit", display: "inline-flex", align_items: "center", user_select: "none", box_shadow: "0px 2px 1px rgba(50, 50, 50, 0.75)", white_space: "nowrap"})]));
        create_button.style += _interpolate_kwargs.call(this, build_rule, ["a.calibre-push-button:hover"].concat([_desugar_kwargs({transform: "scale(1.05)"})]));
        create_button.style += _interpolate_kwargs.call(this, build_rule, ["a.calibre-push-button:active"].concat([_desugar_kwargs({transform: "scale(1.1)"})]));
        create_button.style += _interpolate_kwargs.call(this, build_rule, ["a.calibre-push-button:visited"].concat([_desugar_kwargs({color: get_color("button-text")})]));
        function create_spinner(height, width) {
            var ans;
            ans = svgicon("cog", height, width);
            ans.classList.add("spin");
            return ans;
        };
        if (!create_spinner.__argnames__) Object.defineProperties(create_spinner, {
            __argnames__ : {value: ["height", "width"]},
            __module__ : {value: "widgets"}
        });

        create_spinner.style = _interpolate_kwargs.call(this, build_rule, [".spin"].concat([_desugar_kwargs({animation: "spin 2s infinite linear"})]));
        create_spinner.style += create_keyframes("spin", "from { transform: rotate(0deg); } to { transform: rotate(359deg);}");
        function Breadcrumbs() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Breadcrumbs.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperties(Breadcrumbs.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.container_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        Breadcrumbs.prototype.__init__ = function __init__(container) {
            var self = this;
            self.container_id = ensure_id(container, "calibre-breadcrumbs-");
            container.classList.add("calibre-breadcrumbs");
            clear(container);
        };
        if (!Breadcrumbs.prototype.__init__.__argnames__) Object.defineProperties(Breadcrumbs.prototype.__init__, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "widgets"}
        });
        Breadcrumbs.__argnames__ = Breadcrumbs.prototype.__init__.__argnames__;
        Breadcrumbs.__handles_kwarg_interpolation__ = Breadcrumbs.prototype.__init__.__handles_kwarg_interpolation__;
        Breadcrumbs.prototype.reset = function reset() {
            var self = this;
            clear(self.container);
        };
        if (!Breadcrumbs.prototype.reset.__module__) Object.defineProperties(Breadcrumbs.prototype.reset, {
            __module__ : {value: "widgets"}
        });
        Breadcrumbs.prototype.add_crumb = function add_crumb(callback) {
            var self = this;
            var li;
            li = E.li();
            if (callback) {
                li.addEventListener("click", callback);
            }
            self.container.appendChild(li);
            return li;
        };
        if (!Breadcrumbs.prototype.add_crumb.__argnames__) Object.defineProperties(Breadcrumbs.prototype.add_crumb, {
            __argnames__ : {value: ["callback"]},
            __module__ : {value: "widgets"}
        });
        Breadcrumbs.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Breadcrumbs.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Breadcrumbs.prototype, "__bases__", {value: []});
        Breadcrumbs.prototype.STYLE_RULES = _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs"].concat([_desugar_kwargs({user_select: "none", white_space: "nowrap", background_color: get_color("window-background2"), z_index: "-1", border_radius: "10px", margin: "1ex 1em", margin_bottom: "0"})]));
        Breadcrumbs.prototype.STYLE_RULES += _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs > li"].concat([_desugar_kwargs({cursor: "pointer", display: "inline-block", line_height: "26px", margin: "0 9px 0 -10px", padding: "0.5ex 1rem", position: "relative"})]));
        Breadcrumbs.prototype.STYLE_RULES += _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs > li:hover"].concat([_desugar_kwargs({color: get_color("window-hover-foreground")})]));
        Breadcrumbs.prototype.STYLE_RULES += _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs > li:active"].concat([_desugar_kwargs({color: get_color("window-hover-foreground"), transform: "scale(1.5)"})]));
        Breadcrumbs.prototype.STYLE_RULES += _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs > li:before, .calibre-breadcrumbs > li:after"].concat([_desugar_kwargs({border_right: "2px solid currentColor", content: "\"\"", display: "block", height: "50%", position: "absolute", left: "0", top: "0", right: "0", transform: "skewX(45deg)"})]));
        Breadcrumbs.prototype.STYLE_RULES += _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs > li:after"].concat([_desugar_kwargs({bottom: "0", top: "auto", transform: "skewX(-45deg)"})]));
        Breadcrumbs.prototype.STYLE_RULES += _interpolate_kwargs.call(this, build_rule, [".calibre-breadcrumbs > li:last-of-type:before, .calibre-breadcrumbs > li:last-of-type:after"].concat([_desugar_kwargs({display: "none"})]));
        

        function create_tree(root, populate_data, onclick) {
            var container;
            container = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-tree"})]);
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({overflow: "auto"})]));
            function toggle_node(li) {
                if (li.dataset.treeState === "closed") {
                    li.dataset.treeState = "open";
                    li.lastChild.style.display = "block";
                    change_icon_image(li.firstChild.firstChild, "caret-down");
                } else {
                    li.dataset.treeState = "closed";
                    li.lastChild.style.display = "none";
                    change_icon_image(li.firstChild.firstChild, "caret-right");
                }
            };
            if (!toggle_node.__argnames__) Object.defineProperties(toggle_node, {
                __argnames__ : {value: ["li"]},
                __module__ : {value: "widgets"}
            });

            function bullet(icon) {
                var ans;
                ans = svgicon(icon, "2ex", "2ex");
                ans.style.minWidth = "2ex";
                ans.style.minHeight = "2ex";
                return ans;
            };
            if (!bullet.__argnames__) Object.defineProperties(bullet, {
                __argnames__ : {value: ["icon"]},
                __module__ : {value: "widgets"}
            });

            function process_node(node, parent_container, level) {
                var ul, icon, li, child;
                if (_exists.d(node.children).length) {
                    ul = E.div();
                    parent_container.appendChild(ul);
                    var _Iter0 = _Iterable(node.children);
                    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                        child = _Iter0[_Index0];
                        icon = (_exists.d(child.children).length) ? "caret-right" : null;
                        li = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [bullet(icon), E.span(""), _interpolate_kwargs.call(E, E.a, [_desugar_kwargs({href: "javascript: void(0)", class_: "simple-link tree-item-title", onclick: (function() {
                            var _anonfunc = function (event) {
                                if (onclick) {
                                    if (event.button === 0) {
                                        [event.preventDefault(), event.stopPropagation()];
                                    }
                                    onclick(event, event.currentTarget.parentNode.parentNode);
                                }
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["event"]},
                                __module__ : {value: "widgets"}
                            });
                            return _anonfunc;
                        })()})])].concat([_desugar_kwargs({style: "display:flex; align-items: center"})])), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:none", data_tree_subtree_container: "1"})])].concat([_desugar_kwargs({style: "display:flex; flex-direction:column; margin: 1ex 1em; margin-left: {}em".format(level + 1), data_tree_state: "closed"})]));
                        ul.appendChild(li);
                        populate_data(child, li, li.firstChild.lastChild);
                        if (icon) {
                            _interpolate_kwargs.call(this, set_css, [li.firstChild.firstChild].concat([_desugar_kwargs({cursor: "pointer"})]));
                            li.firstChild.firstChild.addEventListener("click", (function() {
                                var _anonfunc = function (event) {
                                    toggle_node(event.currentTarget.parentNode.parentNode);
                                };
                                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                    __argnames__ : {value: ["event"]},
                                    __module__ : {value: "widgets"}
                                });
                                return _anonfunc;
                            })());
                            process_node(child, li.lastChild, level + 1);
                        }
                    }
                }
            };
            if (!process_node.__argnames__) Object.defineProperties(process_node, {
                __argnames__ : {value: ["node", "parent_container", "level"]},
                __module__ : {value: "widgets"}
            });

            if (root) {
                process_node(root, container, 0);
            }
            return container;
        };
        if (!create_tree.__argnames__) Object.defineProperties(create_tree, {
            __argnames__ : {value: ["root", "populate_data", "onclick"]},
            __module__ : {value: "widgets"}
        });

        function find_text_in_tree(container, q) {
            var last_match, lm, before, seen, ans, a;
            q = q.lower();
            last_match = container.querySelector("a[data-tree-last-match]");
            if (last_match) {
                last_match.parentNode.style.backgroundColor = "transparent";
                last_match.parentNode.style.borderRadius = "0";
                lm = last_match.getAttribute("data-tree-last-match");
                last_match.removeAttribute("data-tree-last-match");
                if (lm !== q) {
                    last_match = null;
                }
            }
            if (!q) {
                return;
            }
            before = _list_decorate([]);
            seen = false;
            ans = null;
            var _Iter1 = _Iterable(container.querySelectorAll("a.tree-item-title"));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                a = _Iter1[_Index1];
                if (a === last_match) {
                    seen = true;
                } else {
                    if (_not_equals(a.textContent.lower().indexOf(q), -1)) {
                        if (seen) {
                            ans = a;
                            break;
                        }
                        if (last_match === null) {
                            ans = a;
                            break;
                        }
                        before.push(a);
                    }
                }
            }
            if (!ans && before.length) {
                ans = before[0];
            }
            ans = ans || last_match;
            if (ans) {
                ans.dataset.treeLastMatch = q;
            }
            if (ans) {
                ans.parentNode.style.backgroundColor = get_color("tree-highlight-item");
                ans.parentNode.style.borderRadius = "5px";
                ans = ans.parentNode.parentNode;
            }
            return ans;
        };
        if (!find_text_in_tree.__argnames__) Object.defineProperties(find_text_in_tree, {
            __argnames__ : {value: ["container", "q"]},
            __module__ : {value: "widgets"}
        });

        function scroll_tree_item_into_view(item) {
            var p;
            p = _exists.d(item.parentNode).parentNode;
            while (p && p.getAttribute("data-tree-subtree-container")) {
                p.style.display = "block";
                p = _exists.d(_exists.d(p.parentNode).parentNode).parentNode;
            }
            item.scrollIntoView();
        };
        if (!scroll_tree_item_into_view.__argnames__) Object.defineProperties(scroll_tree_item_into_view, {
            __argnames__ : {value: ["item"]},
            __module__ : {value: "widgets"}
        });

        add_extra_css((function() {
            var _anonfunc = function () {
                var ans;
                ans = "a, button:focus { outline: none }; a, button::-moz-focus-inner { border: 0 }\n";
                ans += ".simple-link { cursor: pointer } .simple-link:hover { color: HC } .simple-link:active { transform: scale(1.5) }\n".replace("HC", get_color("window-hover-foreground"));
                ans += ".blue-link { cursor: pointer; color: COL } .blue-link:visited { color: COL} .blue-link:hover { color: HC } .blue-link:active { transform: scale(1.5) }\n".replace("HC", get_color("window-hover-foreground")).replace(/COL/g, get_color("link-foreground"));
                ans += create_button.style + "\n";
                ans += create_button.style + "\n";
                ans += create_spinner.style + "\n";
                ans += Breadcrumbs.prototype.STYLE_RULES + "\n";
                ans += "\n        select, textarea, input[type=\"text\"], input[type=\"password\"],\n        input[type=\"datetime\"], input[type=\"datetime-local\"],\n        input[type=\"date\"], input[type=\"month\"], input[type=\"time\"],\n        input[type=\"week\"], input[type=\"number\"], input[type=\"email\"],\n        input[type=\"url\"], input[type=\"search\"] { font-size: 1em }\n    ";
                return ans;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "widgets"}
            });
            return _anonfunc;
        })());
        function enable_escape_key(container, action) {
            container.setAttribute("tabindex", "0");
            container.addEventListener("keydown", (function() {
                var _anonfunc = function (ev) {
                    if (ev.key === "Escape") {
                        [ev.stopPropagation(), ev.preventDefault()];
                        action();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "widgets"}
                });
                return _anonfunc;
            })(), (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.focus();
        };
        if (!enable_escape_key.__argnames__) Object.defineProperties(enable_escape_key, {
            __argnames__ : {value: ["container", "action"]},
            __module__ : {value: "widgets"}
        });

        _modules.widgets.create_button = create_button;
        _modules.widgets.create_spinner = create_spinner;
        _modules.widgets.Breadcrumbs = Breadcrumbs;
        _modules.widgets.create_tree = create_tree;
        _modules.widgets.find_text_in_tree = find_text_in_tree;
        _modules.widgets.scroll_tree_item_into_view = scroll_tree_item_into_view;
        _modules.widgets.enable_escape_key = enable_escape_key;
    })();

    (function(){
        var __name__ = "modals";
        var modal_container, modal_count;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ajax = _modules.ajax.ajax;
        var ajax_send = _modules.ajax.ajax_send;

        var get_color = _modules["book_list.theme"].get_color;
        var get_font_size = _modules["book_list.theme"].get_font_size;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var MODAL_Z_INDEX = _modules.popups.MODAL_Z_INDEX;

        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        modal_container = null;
        modal_count = 0;
        add_extra_css((function() {
            var _anonfunc = function () {
                var style;
                style = _interpolate_kwargs.call(this, build_rule, ["#modal-container > div > a:hover"].concat([_desugar_kwargs({color: get_color("dialog-foreground") + " !important", background_color: get_color("dialog-background") + " !important"})]));
                style += _interpolate_kwargs.call(this, build_rule, [".button-box"].concat([_desugar_kwargs({display: "flex", justify_content: "flex-end", padding: "1rem 0rem", overflow: "hidden"})]));
                style += _interpolate_kwargs.call(this, build_rule, [".button-box .calibre-push-button"].concat([_desugar_kwargs({transform_origin: "right"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "modals"}
            });
            return _anonfunc;
        })());
        function Modal() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Modal.prototype.__init__.apply(this, arguments);
        }
        Modal.prototype.__init__ = function __init__(create_func, on_close, show_close, onkeydown) {
            var self = this;
            var _unpack;
            _unpack = [create_func, on_close, show_close];
            self.create_func = _unpack[0];
            self.on_close = _unpack[1];
            self.show_close = _unpack[2];
            self.onkeydown = onkeydown;
            modal_count += 1;
            self.id = modal_count;
        };
        if (!Modal.prototype.__init__.__argnames__) Object.defineProperties(Modal.prototype.__init__, {
            __argnames__ : {value: ["create_func", "on_close", "show_close", "onkeydown"]},
            __module__ : {value: "modals"}
        });
        Modal.__argnames__ = Modal.prototype.__init__.__argnames__;
        Modal.__handles_kwarg_interpolation__ = Modal.prototype.__init__.__handles_kwarg_interpolation__;
        Modal.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Modal.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Modal.prototype, "__bases__", {value: []});

        function ModalContainer() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ModalContainer.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperties(ModalContainer.prototype,  {
            "modal_container": {
                "enumerable": true, 
                "get": function modal_container() {
                    var self = this;
                    return document.getElementById("modal-container");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ModalContainer.prototype.__init__ = function __init__() {
            var self = this;
            var div;
            div = _interpolate_kwargs.call(E, E.div, [E.div(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "modal_height_container"})]), _interpolate_kwargs.call(E, E.a, [svgicon("close")].concat([_desugar_kwargs({title: _("Close"), onclick: self.close_current_modal.bind(self)})])))].concat([_desugar_kwargs({id: "modal-container", tabindex: "0"})]));
            div.addEventListener("keydown", self.onkeydown.bind(self), (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            document.body.appendChild(div);
            _interpolate_kwargs.call(this, set_css, [div].concat([_desugar_kwargs({position: "fixed", top: "0", right: "0", bottom: "0", left: "0", background_color: "rgba(0,0,0,0.8)", z_index: MODAL_Z_INDEX + "", display: "none", user_select: "none", justify_content: "center", align_items: "center"})]));
            _interpolate_kwargs.call(this, set_css, [div.firstChild, get_color("dialog-background"), get_color("dialog-background2")].concat([_desugar_kwargs({position: "relative", display: "inline-block", min_width: "25vw", max_width: "70vw", border_radius: "1em", padding: "1em 2em", margin_right: "1em", margin_left: "1em", background: get_color("dialog-background"), color: get_color("dialog-foreground"), background_image: get_color("dialog-background-image")})]));
            _interpolate_kwargs.call(this, set_css, [div.firstChild.lastChild].concat([_desugar_kwargs({font_size: "1.5em", line_height: "100%", cursor: "pointer", position: "absolute", right: "-0.5em", top: "-0.5em", width: "1em", height: "1em", background_color: get_color("window-foreground"), color: get_color("window-background"), display: "inline-box", border_radius: "50%", padding: "4px", text_align: "center", box_shadow: "1px 1px 3px black"})]));
            _interpolate_kwargs.call(this, set_css, [div.firstChild.firstChild].concat([_desugar_kwargs({user_select: "text", max_height: "60vh", overflow: "auto", padding: "1px"})]));
            self.modals = [];
            self.current_modal = null;
            self.hide = self.close_current_modal.bind(self);
        };
        if (!ModalContainer.prototype.__init__.__module__) Object.defineProperties(ModalContainer.prototype.__init__, {
            __module__ : {value: "modals"}
        });
        ModalContainer.__argnames__ = ModalContainer.prototype.__init__.__argnames__;
        ModalContainer.__handles_kwarg_interpolation__ = ModalContainer.prototype.__init__.__handles_kwarg_interpolation__;
        ModalContainer.prototype.show_modal = function show_modal() {
            var self = this;
            var create_func = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var on_close = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_modal.__defaults__.on_close : arguments[1];
            var show_close = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_modal.__defaults__.show_close : arguments[2];
            var onkeydown = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_modal.__defaults__.onkeydown : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "show_close")){
                show_close = _kwargs_obj.show_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "onkeydown")){
                onkeydown = _kwargs_obj.onkeydown;
            }
            var modal_id;
            self.modals.push(new Modal(create_func, on_close, show_close, onkeydown));
            modal_id = (_expr_temp = self.modals)[_expr_temp.length-1].id;
            self.update();
            window.setTimeout((function() {
                var _anonfunc = function () {
                    self.modal_container.focus();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "modals"}
                });
                return _anonfunc;
            })(), 0);
            return modal_id;
        };
        if (!ModalContainer.prototype.show_modal.__defaults__) Object.defineProperties(ModalContainer.prototype.show_modal, {
            __defaults__ : {value: {on_close:null, show_close:true, onkeydown:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["create_func", "on_close", "show_close", "onkeydown"]},
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.hide_modal = function hide_modal(modal_id) {
            var self = this;
            var doomed_modal, _unpack, i, modal;
            if (self.current_modal !== null && self.current_modal.id === modal_id) {
                self.clear_current_modal();
            } else {
                doomed_modal = null;
                var _Iter0 = _Iterable(enumerate(self.modals));
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    _unpack = _Iter0[_Index0];
                    i = _unpack[0];
                    modal = _unpack[1];
                    if (modal.id === modal_id) {
                        doomed_modal = i;
                        break;
                    }
                }
                if (doomed_modal !== null) {
                    self.modals.splice(doomed_modal, 1);
                }
            }
        };
        if (!ModalContainer.prototype.hide_modal.__argnames__) Object.defineProperties(ModalContainer.prototype.hide_modal, {
            __argnames__ : {value: ["modal_id"]},
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.update = function update() {
            var self = this;
            var c;
            if (self.current_modal === null && self.modals) {
                self.current_modal = self.modals.shift();
                c = self.modal_container;
                try {
                    self.current_modal.create_func(c.firstChild.firstChild, self.hide);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        self.current_modal = null;
                        throw _Exception;
                    } 
                }
                if (c.style.display === "none") {
                    c.style.display = "flex";
                }
                c.firstChild.lastChild.style.visibility = (self.current_modal.show_close) ? "visible" : "hidden";
            }
        };
        if (!ModalContainer.prototype.update.__module__) Object.defineProperties(ModalContainer.prototype.update, {
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.clear_current_modal = function clear_current_modal() {
            var self = this;
            var c;
            self.current_modal = null;
            c = self.modal_container;
            clear(c.firstChild.firstChild);
            if (self.modals.length === 0) {
                _interpolate_kwargs.call(this, set_css, [c].concat([_desugar_kwargs({display: "none"})]));
            } else {
                self.update();
            }
        };
        if (!ModalContainer.prototype.clear_current_modal.__module__) Object.defineProperties(ModalContainer.prototype.clear_current_modal, {
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.close_current_modal = function close_current_modal(event) {
            var self = this;
            if (self.current_modal !== null) {
                if (self.current_modal.on_close !== null && self.current_modal.on_close(event) === true) {
                    return;
                }
                self.clear_current_modal();
            }
        };
        if (!ModalContainer.prototype.close_current_modal.__argnames__) Object.defineProperties(ModalContainer.prototype.close_current_modal, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.close_all_modals = function close_all_modals() {
            var self = this;
            while (self.current_modal !== null) {
                self.close_current_modal();
            }
        };
        if (!ModalContainer.prototype.close_all_modals.__module__) Object.defineProperties(ModalContainer.prototype.close_all_modals, {
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.onkeydown = function onkeydown(event) {
            var self = this;
            if (self.current_modal !== null && self.current_modal.onkeydown) {
                return self.current_modal.onkeydown(event, self.clear_current_modal.bind(self));
            }
            if ((event.key === "Escape" || event.key === "Esc") && !event.altKey && !event.ctrlKey && !event.metaKey && !event.shiftKey) {
                [event.preventDefault(), event.stopPropagation()];
                self.close_current_modal(event);
            }
        };
        if (!ModalContainer.prototype.onkeydown.__argnames__) Object.defineProperties(ModalContainer.prototype.onkeydown, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "modals"}
        });
        ModalContainer.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ModalContainer.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ModalContainer.prototype, "__bases__", {value: []});
        

        function create_simple_dialog_markup(title, msg, details, icon, prefix, icon_color, parent) {
            var show_details, is_html_msg, html_container, details_container;
            details = details || "";
            show_details = _interpolate_kwargs.call(E, E.a, [_("Show details")].concat([_desugar_kwargs({class_: "blue-link", style: "padding-top:1em; display:inline-block; margin-left: auto"})]));
            show_details.addEventListener("click", (function() {
                var _anonfunc = function () {
                    show_details.style.display = "none";
                    show_details.nextSibling.style.display = "block";
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "modals"}
                });
                return _anonfunc;
            })());
            is_html_msg = /<[a-zA-Z]/.test(msg);
            html_container = E.div();
            if (is_html_msg) {
                safe_set_inner_html(html_container, msg);
            }
            details_container = E.span();
            if (/<[a-zA-Z]/.test(details)) {
                safe_set_inner_html(details_container, details);
            } else {
                details_container.textContent = details;
            }
            if (prefix) {
                prefix = _interpolate_kwargs.call(E, E.span, [" " + prefix + " "].concat([_desugar_kwargs({style: "white-space:pre; font-variant: small-caps"})]));
            } else {
                prefix = "";
            }
            parent.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.h2, [_interpolate_kwargs.call(E, E.span, [svgicon(icon)].concat([_desugar_kwargs({style: "color:" + _str.format("{}", icon_color) + ""})])), prefix, title].concat([_desugar_kwargs({style: "font-weight: bold; font-size: " + get_font_size("title")})])), _interpolate_kwargs.call(E, E.div, [(is_html_msg) ? html_container : msg].concat([_desugar_kwargs({style: "padding-top: 1em; margin-top: 1em; border-top: 1px solid currentColor"})])), _interpolate_kwargs.call(E, E.div, [show_details, _interpolate_kwargs.call(E, E.div, [details_container].concat([_desugar_kwargs({style: "display:none; white-space:pre-wrap; font-size: smaller; margin-top: 1em; border-top: solid 1px currentColor; padding-top: 1em"})]))].concat([_desugar_kwargs({style: "display: " + ((details) ? "block" : "none")})]))].concat([_desugar_kwargs({style: "max-width:40em; text-align: left"})])));
        };
        if (!create_simple_dialog_markup.__argnames__) Object.defineProperties(create_simple_dialog_markup, {
            __argnames__ : {value: ["title", "msg", "details", "icon", "prefix", "icon_color", "parent"]},
            __module__ : {value: "modals"}
        });

        function create_simple_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var msg = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var details = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var icon = ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[3];
            var prefix = ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[4];
            var on_close = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_dialog.__defaults__.on_close : arguments[5];
            var icon_color = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_dialog.__defaults__.icon_color : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "icon_color")){
                icon_color = _kwargs_obj.icon_color;
            }
            _interpolate_kwargs.call(this, show_modal, [create_simple_dialog_markup.bind(null, title, msg, details, icon, prefix, icon_color)].concat([_desugar_kwargs({on_close: on_close})]));
        };
        if (!create_simple_dialog.__defaults__) Object.defineProperties(create_simple_dialog, {
            __defaults__ : {value: {on_close:null, icon_color:"red"}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "msg", "details", "icon", "prefix", "on_close", "icon_color"]},
            __module__ : {value: "modals"}
        });

        function create_custom_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var content_generator_func = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var on_close = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_custom_dialog.__defaults__.on_close : arguments[2];
            var onkeydown = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_custom_dialog.__defaults__.onkeydown : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "onkeydown")){
                onkeydown = _kwargs_obj.onkeydown;
            }
            function create_func(parent, close_modal) {
                var content_div;
                content_div = E.div();
                parent.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.h2, [title].concat([_desugar_kwargs({style: "font-weight: bold; font-size: " + get_font_size("title")})])), _interpolate_kwargs.call(E, E.div, [content_div].concat([_desugar_kwargs({style: "padding-top: 1em; margin-top: 1em; border-top: 1px solid currentColor"})]))].concat([_desugar_kwargs({style: "max-width:60em; text-align: left"})])));
                content_generator_func(content_div, close_modal);
            };
            if (!create_func.__argnames__) Object.defineProperties(create_func, {
                __argnames__ : {value: ["parent", "close_modal"]},
                __module__ : {value: "modals"}
            });

            _interpolate_kwargs.call(this, show_modal, [create_func].concat([_desugar_kwargs({on_close: on_close, onkeydown: onkeydown})]));
        };
        if (!create_custom_dialog.__defaults__) Object.defineProperties(create_custom_dialog, {
            __defaults__ : {value: {on_close:null, onkeydown:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "content_generator_func", "on_close", "onkeydown"]},
            __module__ : {value: "modals"}
        });

        function get_text_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var callback = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var initial_text = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? get_text_dialog.__defaults__.initial_text : arguments[2];
            var msg = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? get_text_dialog.__defaults__.msg : arguments[3];
            var rows = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? get_text_dialog.__defaults__.rows : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "initial_text")){
                initial_text = _kwargs_obj.initial_text;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "msg")){
                msg = _kwargs_obj.msg;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "rows")){
                rows = _kwargs_obj.rows;
            }
            var called, cid;
            called = Object.create(null);
            cid = unique_id();
            function keyaction(ok, close_modal) {
                var text;
                if (called.done) {
                    return;
                }
                called.done = true;
                text = document.getElementById(cid).value || "";
                if (close_modal) {
                    close_modal();
                }
                callback(ok, text);
            };
            if (!keyaction.__argnames__) Object.defineProperties(keyaction, {
                __argnames__ : {value: ["ok", "close_modal"]},
                __module__ : {value: "modals"}
            });

            function on_keydown(event, close_modal) {
                if (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) {
                    return;
                }
                if (event.key === "Escape" || event.key === "Esc") {
                    [event.preventDefault(), event.stopPropagation()];
                    keyaction(false, close_modal);
                }
            };
            if (!on_keydown.__argnames__) Object.defineProperties(on_keydown, {
                __argnames__ : {value: ["event", "close_modal"]},
                __module__ : {value: "modals"}
            });

            _interpolate_kwargs.call(this, create_custom_dialog, [title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    parent.appendChild(E.div(_interpolate_kwargs.call(E, E.textarea, [initial_text || ""].concat([_desugar_kwargs({placeholder: msg || "", id: cid, rows: rows + "", style: "min-width: min(40rem, 60vw)"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("OK"), "check", keyaction.bind(null, true, close_modal)].concat([_desugar_kwargs({highlight: true})])), "", create_button(_("Cancel"), "close", keyaction.bind(null, false, close_modal))].concat([_desugar_kwargs({class_: "button-box"})]))));
                    window.setTimeout((function() {
                        var _anonfunc = function () {
                            parent.querySelector("textarea").focus();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "modals"}
                        });
                        return _anonfunc;
                    })(), 10);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "modals"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({on_close: keyaction.bind(null, false, null), onkeydown: on_keydown})]));
        };
        if (!get_text_dialog.__defaults__) Object.defineProperties(get_text_dialog, {
            __defaults__ : {value: {initial_text:null, msg:null, rows:12}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "callback", "initial_text", "msg", "rows"]},
            __module__ : {value: "modals"}
        });

        function question_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var msg = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var callback = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var yes_text = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? question_dialog.__defaults__.yes_text : arguments[3];
            var no_text = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? question_dialog.__defaults__.no_text : arguments[4];
            var skip_dialog_name = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? question_dialog.__defaults__.skip_dialog_name : arguments[5];
            var skip_dialog_msg = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? question_dialog.__defaults__.skip_dialog_msg : arguments[6];
            var skip_dialog_skipped_value = (arguments[7] === undefined || ( 7 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? question_dialog.__defaults__.skip_dialog_skipped_value : arguments[7];
            var skip_dialog_skip_precheck = (arguments[8] === undefined || ( 8 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? question_dialog.__defaults__.skip_dialog_skip_precheck : arguments[8];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "yes_text")){
                yes_text = _kwargs_obj.yes_text;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "no_text")){
                no_text = _kwargs_obj.no_text;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "skip_dialog_name")){
                skip_dialog_name = _kwargs_obj.skip_dialog_name;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "skip_dialog_msg")){
                skip_dialog_msg = _kwargs_obj.skip_dialog_msg;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "skip_dialog_skipped_value")){
                skip_dialog_skipped_value = _kwargs_obj.skip_dialog_skipped_value;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "skip_dialog_skip_precheck")){
                skip_dialog_skip_precheck = _kwargs_obj.skip_dialog_skip_precheck;
            }
            var called, skip_box, sd, skipped_dialogs;
            yes_text = yes_text || _("Yes");
            no_text = no_text || _("No");
            called = Object.create(null);
            function keyaction(yes, close_modal) {
                var sd, skipped_dialogs;
                if (called.done) {
                    return;
                }
                called.done = true;
                if (skip_dialog_name) {
                    if (!skip_box.querySelector("input").checked) {
                        sd = get_session_data();
                        skipped_dialogs = Object.assign({}, sd.get("skipped_dialogs", {}));
                        skipped_dialogs[(typeof skip_dialog_name === "number" && skip_dialog_name < 0) ? skipped_dialogs.length + skip_dialog_name : skip_dialog_name] = (new Date).toISOString();
                        sd.set("skipped_dialogs", skipped_dialogs);
                    }
                }
                if (close_modal) {
                    close_modal();
                }
                callback(yes);
            };
            if (!keyaction.__argnames__) Object.defineProperties(keyaction, {
                __argnames__ : {value: ["yes", "close_modal"]},
                __module__ : {value: "modals"}
            });

            function on_keydown(event, close_modal) {
                if (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) {
                    return;
                }
                if (event.key === "Escape" || event.key === "Esc") {
                    [event.preventDefault(), event.stopPropagation()];
                    keyaction(false, close_modal);
                }
                if (event.key === "Enter" || event.key === "Return" || event.key === "Space") {
                    [event.preventDefault(), event.stopPropagation()];
                    keyaction(true, close_modal);
                }
            };
            if (!on_keydown.__argnames__) Object.defineProperties(on_keydown, {
                __argnames__ : {value: ["event", "close_modal"]},
                __module__ : {value: "modals"}
            });

            skip_box = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 2ex;"})]);
            if (skip_dialog_name) {
                sd = get_session_data();
                skipped_dialogs = sd.get("skipped_dialogs", {});
                if (skipped_dialogs[(typeof skip_dialog_name === "number" && skip_dialog_name < 0) ? skipped_dialogs.length + skip_dialog_name : skip_dialog_name]) {
                    return callback(skip_dialog_skipped_value);
                }
                skip_dialog_msg = skip_dialog_msg || _("Show this confirmation again");
                skip_box.appendChild(E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: "skip_dialog"})]), "", skip_dialog_msg));
                if (skip_dialog_skip_precheck) {
                    skip_box.querySelector("input").checked = true;
                }
            } else {
                skip_box.style.display = "none";
            }
            _interpolate_kwargs.call(this, create_custom_dialog, [title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    parent.appendChild(E.div(E.div(msg), skip_box, _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [yes_text, "check", keyaction.bind(null, true, close_modal)].concat([_desugar_kwargs({highlight: true})])), "", create_button(no_text, "close", keyaction.bind(null, false, close_modal))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "modals"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({on_close: keyaction.bind(null, false, null), onkeydown: on_keydown})]));
        };
        if (!question_dialog.__defaults__) Object.defineProperties(question_dialog, {
            __defaults__ : {value: {yes_text:null, no_text:null, skip_dialog_name:null, skip_dialog_msg:null, skip_dialog_skipped_value:true, skip_dialog_skip_precheck:true}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "msg", "callback", "yes_text", "no_text", "skip_dialog_name", "skip_dialog_msg", "skip_dialog_skipped_value", "skip_dialog_skip_precheck"]},
            __module__ : {value: "modals"}
        });

        function create_progress_dialog(msg, on_close) {
            var _unpack, pbar, msg_div, show_close, modal_id;
            msg = msg || _("Loading, please wait...");
            _unpack = [_interpolate_kwargs.call(E, E.progress, [_desugar_kwargs({style: "display:inline-block"})]), 
            _interpolate_kwargs.call(E, E.div, [msg].concat([_desugar_kwargs({style: "text-align:center; padding-top:1ex"})]))];
            pbar = _unpack[0];
            msg_div = _unpack[1];
            function create_func(parent) {
                parent.appendChild(_interpolate_kwargs.call(E, E.div, [pbar, msg_div].concat([_desugar_kwargs({style: "text-align: center"})])));
            };
            if (!create_func.__argnames__) Object.defineProperties(create_func, {
                __argnames__ : {value: ["parent"]},
                __module__ : {value: "modals"}
            });

            show_close = on_close !== null;
            modal_id = show_modal(create_func, on_close, show_close);
            return (function(){
                var _d = Object.create(null);
                _d["close"] = (function() {
                    var _anonfunc = function () {
                        modal_container.hide_modal(modal_id);
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "modals"}
                    });
                    return _anonfunc;
                })();
                _d["update_progress"] = (function() {
                    var _anonfunc = function (amount, total) {
                        var _unpack;
                        _unpack = [total, amount];
                        pbar.max = _unpack[0];
                        pbar.value = _unpack[1];
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["amount", "total"]},
                        __module__ : {value: "modals"}
                    });
                    return _anonfunc;
                })();
                _d["set_msg"] = (function() {
                    var _anonfunc = function (new_msg) {
                        safe_set_inner_html(msg_div, new_msg);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["new_msg"]},
                        __module__ : {value: "modals"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
        };
        if (!create_progress_dialog.__argnames__) Object.defineProperties(create_progress_dialog, {
            __argnames__ : {value: ["msg", "on_close"]},
            __module__ : {value: "modals"}
        });

        function create_modal_container() {
            if (modal_container === null) {
                modal_container = new ModalContainer;
            }
            return modal_container;
        };
        if (!create_modal_container.__module__) Object.defineProperties(create_modal_container, {
            __module__ : {value: "modals"}
        });

        function show_modal() {
            var create_func = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var on_close = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_modal.__defaults__.on_close : arguments[1];
            var show_close = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_modal.__defaults__.show_close : arguments[2];
            var onkeydown = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_modal.__defaults__.onkeydown : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "show_close")){
                show_close = _kwargs_obj.show_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "onkeydown")){
                onkeydown = _kwargs_obj.onkeydown;
            }
            return modal_container.show_modal(create_func, on_close, show_close, onkeydown);
        };
        if (!show_modal.__defaults__) Object.defineProperties(show_modal, {
            __defaults__ : {value: {on_close:null, show_close:true, onkeydown:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["create_func", "on_close", "show_close", "onkeydown"]},
            __module__ : {value: "modals"}
        });

        function close_all_modals() {
            return modal_container.close_all_modals();
        };
        if (!close_all_modals.__module__) Object.defineProperties(close_all_modals, {
            __module__ : {value: "modals"}
        });

        function error_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var msg = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var details = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? error_dialog.__defaults__.details : arguments[2];
            var on_close = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? error_dialog.__defaults__.on_close : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "details")){
                details = _kwargs_obj.details;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            create_simple_dialog(title, msg, details, "bug", _("Error:"), on_close);
        };
        if (!error_dialog.__defaults__) Object.defineProperties(error_dialog, {
            __defaults__ : {value: {details:null, on_close:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "msg", "details", "on_close"]},
            __module__ : {value: "modals"}
        });

        function warning_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var msg = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var details = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? warning_dialog.__defaults__.details : arguments[2];
            var on_close = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? warning_dialog.__defaults__.on_close : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "details")){
                details = _kwargs_obj.details;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            create_simple_dialog(title, msg, details, "warning", _("Warning:"), on_close);
        };
        if (!warning_dialog.__defaults__) Object.defineProperties(warning_dialog, {
            __defaults__ : {value: {details:null, on_close:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "msg", "details", "on_close"]},
            __module__ : {value: "modals"}
        });

        function info_dialog() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var msg = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var details = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? info_dialog.__defaults__.details : arguments[2];
            var on_close = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? info_dialog.__defaults__.on_close : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "details")){
                details = _kwargs_obj.details;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            _interpolate_kwargs.call(this, create_simple_dialog, [title, msg, details, "check", "", on_close].concat([_desugar_kwargs({icon_color: "green"})]));
        };
        if (!info_dialog.__defaults__) Object.defineProperties(info_dialog, {
            __defaults__ : {value: {details:null, on_close:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "msg", "details", "on_close"]},
            __module__ : {value: "modals"}
        });

        function progress_dialog() {
            var msg = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var on_close = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? progress_dialog.__defaults__.on_close : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            return create_progress_dialog(msg, on_close);
        };
        if (!progress_dialog.__defaults__) Object.defineProperties(progress_dialog, {
            __defaults__ : {value: {on_close:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["msg", "on_close"]},
            __module__ : {value: "modals"}
        });

        function ajax_progress_dialog() {
            var path = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var on_complete = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var msg = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var extra_data_for_callback = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? ajax_progress_dialog.__defaults__.extra_data_for_callback : arguments[3];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            if (Object.prototype.hasOwnProperty.call(kw, "extra_data_for_callback")){
                extra_data_for_callback = kw.extra_data_for_callback;
                delete kw.extra_data_for_callback;
            }
            var pd, xhr;
            pd = null;
            function on_complete_callback(event_type, xhr, ev) {
                pd.close();
                pd = undefined;
                return on_complete(event_type, xhr, ev);
            };
            if (!on_complete_callback.__argnames__) Object.defineProperties(on_complete_callback, {
                __argnames__ : {value: ["event_type", "xhr", "ev"]},
                __module__ : {value: "modals"}
            });

            function on_progress_callback(loaded, total, xhr) {
                pd.update_progress(loaded, total);
            };
            if (!on_progress_callback.__argnames__) Object.defineProperties(on_progress_callback, {
                __argnames__ : {value: ["loaded", "total", "xhr"]},
                __module__ : {value: "modals"}
            });

            xhr = _interpolate_kwargs.call(this, ajax, [path, on_complete_callback].concat([_desugar_kwargs(kw, {on_progress: on_progress_callback})]));
            xhr.extra_data_for_callback = extra_data_for_callback;
            pd = progress_dialog(msg, xhr.abort.bind(xhr));
            xhr.send();
            return [xhr, pd];
        };
        if (!ajax_progress_dialog.__defaults__) Object.defineProperties(ajax_progress_dialog, {
            __defaults__ : {value: {extra_data_for_callback:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["path", "on_complete", "msg", "extra_data_for_callback"]},
            __module__ : {value: "modals"}
        });

        function ajax_send_progress_dialog() {
            var path = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var data = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var on_complete = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var msg = ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[3];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            var pd, xhr;
            pd = null;
            function on_complete_callback(event_type, xhr, ev) {
                pd.close();
                pd = undefined;
                return on_complete(event_type, xhr, ev);
            };
            if (!on_complete_callback.__argnames__) Object.defineProperties(on_complete_callback, {
                __argnames__ : {value: ["event_type", "xhr", "ev"]},
                __module__ : {value: "modals"}
            });

            function on_progress_callback(loaded, total, xhr) {
                pd.update_progress(loaded, total);
            };
            if (!on_progress_callback.__argnames__) Object.defineProperties(on_progress_callback, {
                __argnames__ : {value: ["loaded", "total", "xhr"]},
                __module__ : {value: "modals"}
            });

            xhr = _interpolate_kwargs.call(this, ajax_send, [path, data, on_complete_callback].concat([_desugar_kwargs(kw, {on_progress: on_progress_callback})]));
            pd = progress_dialog(msg, xhr.abort.bind(xhr));
            return [xhr, pd];
        };
        if (!ajax_send_progress_dialog.__handles_kwarg_interpolation__) Object.defineProperties(ajax_send_progress_dialog, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["path", "data", "on_complete", "msg"]},
            __module__ : {value: "modals"}
        });

        _modules.modals.modal_container = modal_container;
        _modules.modals.modal_count = modal_count;
        _modules.modals.Modal = Modal;
        _modules.modals.ModalContainer = ModalContainer;
        _modules.modals.create_simple_dialog_markup = create_simple_dialog_markup;
        _modules.modals.create_simple_dialog = create_simple_dialog;
        _modules.modals.create_custom_dialog = create_custom_dialog;
        _modules.modals.get_text_dialog = get_text_dialog;
        _modules.modals.question_dialog = question_dialog;
        _modules.modals.create_progress_dialog = create_progress_dialog;
        _modules.modals.create_modal_container = create_modal_container;
        _modules.modals.show_modal = show_modal;
        _modules.modals.close_all_modals = close_all_modals;
        _modules.modals.error_dialog = error_dialog;
        _modules.modals.warning_dialog = warning_dialog;
        _modules.modals.info_dialog = info_dialog;
        _modules.modals.progress_dialog = progress_dialog;
        _modules.modals.ajax_progress_dialog = ajax_progress_dialog;
        _modules.modals.ajax_send_progress_dialog = ajax_send_progress_dialog;
    })();

    (function(){
        var __name__ = "uuid";
        var RFC_4122, random_bytes;
        var hexlify = _modules.encodings.hexlify;
        var urlsafe_b64decode = _modules.encodings.urlsafe_b64decode;
        var urlsafe_b64encode = _modules.encodings.urlsafe_b64encode;

        RFC_4122 = 1;
        if (typeof crypto === "object" && crypto.getRandomValues) {
            random_bytes = (function() {
                var _anonfunc = function (num) {
                    var ans;
                    ans = new Uint8Array(num || 16);
                    crypto.getRandomValues(ans);
                    return ans;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["num"]},
                    __module__ : {value: "uuid"}
                });
                return _anonfunc;
            })();
        } else {
            random_bytes = (function() {
                var _anonfunc = function (num) {
                    var ans, i;
                    ans = new Uint8Array(num || 16);
                    for (var _Index0 = 0; _Index0 < ans.length; _Index0++) {
                        i = _Index0;
                        ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = Math.floor(Math.random() * 256);
                    }
                    return ans;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["num"]},
                    __module__ : {value: "uuid"}
                });
                return _anonfunc;
            })();
        }
        function uuid4_bytes() {
            var data;
            data = random_bytes();
            data[6] = 64 | data[6] & 15;
            data[8] = (data[8] >> 4 & 3 | 8) << 4 | data[8] & 15;
            return data;
        };
        if (!uuid4_bytes.__module__) Object.defineProperties(uuid4_bytes, {
            __module__ : {value: "uuid"}
        });

        function as_str() {
            var h;
            h = this.hex;
            return h.slice(0, 8) + "-" + h.slice(8, 12) + "-" + h.slice(12, 16) + "-" + h.slice(16, 20) + "-" + h.slice(20);
        };
        if (!as_str.__module__) Object.defineProperties(as_str, {
            __module__ : {value: "uuid"}
        });

        function uuid4() {
            var b;
            b = uuid4_bytes();
            return (function(){
                var _d = Object.create(null);
                _d["hex"] = hexlify(b);
                _d["bytes"] = b;
                _d["variant"] = RFC_4122;
                _d["version"] = 4;
                _d["__str__"] = as_str;
                _d["toString"] = as_str;
                return _d;
            }).call(this);
        };
        if (!uuid4.__module__) Object.defineProperties(uuid4, {
            __module__ : {value: "uuid"}
        });

        function num_to_string(numbers, alphabet, pad_to_length) {
            var ans, alphabet_len, x, number;
            ans = [];
            alphabet_len = alphabet.length;
            numbers = Array.prototype.slice.call(numbers);
            for (var i = 0; i < numbers.length - 1; i++) {
                x = divmod(numbers[(typeof i === "number" && i < 0) ? numbers.length + i : i], alphabet_len);
                numbers[(typeof i === "number" && i < 0) ? numbers.length + i : i] = x[0];
                numbers[_bound_index(i + 1, numbers)] += x[1];
            }
            for (var i = 0; i < numbers.length; i++) {
                number = numbers[(typeof i === "number" && i < 0) ? numbers.length + i : i];
                while (number) {
                    x = divmod(number, alphabet_len);
                    number = x[0];
                    ans.push(alphabet[_bound_index(x[1], alphabet)]);
                }
            }
            if (pad_to_length && pad_to_length > ans.length) {
                ans.push(alphabet[0].repeat(pad_to_length - ans.length));
            }
            return ans.join("");
        };
        if (!num_to_string.__argnames__) Object.defineProperties(num_to_string, {
            __argnames__ : {value: ["numbers", "alphabet", "pad_to_length"]},
            __module__ : {value: "uuid"}
        });

        function short_uuid() {
            return urlsafe_b64encode(random_bytes(), "");
        };
        if (!short_uuid.__module__) Object.defineProperties(short_uuid, {
            __module__ : {value: "uuid"}
        });

        function short_uuid4() {
            return urlsafe_b64encode(uuid4_bytes(), "");
        };
        if (!short_uuid4.__module__) Object.defineProperties(short_uuid4, {
            __module__ : {value: "uuid"}
        });

        function decode_short_uuid(val) {
            return urlsafe_b64decode(val + "==");
        };
        if (!decode_short_uuid.__argnames__) Object.defineProperties(decode_short_uuid, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "uuid"}
        });

        _modules.uuid.RFC_4122 = RFC_4122;
        _modules.uuid.random_bytes = random_bytes;
        _modules.uuid.uuid4_bytes = uuid4_bytes;
        _modules.uuid.as_str = as_str;
        _modules.uuid.uuid4 = uuid4;
        _modules.uuid.num_to_string = num_to_string;
        _modules.uuid.short_uuid = short_uuid;
        _modules.uuid.short_uuid4 = short_uuid4;
        _modules.uuid.decode_short_uuid = decode_short_uuid;
    })();

    (function(){
        var __name__ = "session";
        var all_settings, defaults, x, standalone_reader_defaults, default_interface_data;
        var short_uuid = _modules.uuid.short_uuid;

        var ajax_send = _modules.ajax.ajax_send;

        all_settings = (function(){
            var _d = Object.create(null);
            _d["copy_to_library_dupes"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "add;overwrite";
                _d["category"] = "book_list";
                return _d;
            }).call(this);
            _d["last_sort_order"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "book_list";
                return _d;
            }).call(this);
            _d["show_all_metadata"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "book_list";
                return _d;
            }).call(this);
            _d["sort"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "timestamp.desc";
                _d["category"] = "book_list";
                return _d;
            }).call(this);
            _d["view_mode"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "cover_grid";
                _d["category"] = "book_list";
                return _d;
            }).call(this);
            _d["fts_related_words"] = (function(){
                var _d = Object.create(null);
                _d["default"] = true;
                _d["category"] = "book_list";
                return _d;
            }).call(this);
            _d["and_search_terms"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "tag_browser";
                return _d;
            }).call(this);
            _d["collapse_at"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 25;
                _d["category"] = "tag_browser";
                return _d;
            }).call(this);
            _d["dont_collapse"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "";
                _d["category"] = "tag_browser";
                return _d;
            }).call(this);
            _d["hide_empty_categories"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "no";
                _d["category"] = "tag_browser";
                return _d;
            }).call(this);
            _d["partition_method"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "first letter";
                _d["category"] = "tag_browser";
                return _d;
            }).call(this);
            _d["sort_tags_by"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "name";
                _d["category"] = "tag_browser";
                return _d;
            }).call(this);
            _d["background_image_fade"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 0;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["background_image_style"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "scaled";
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["background_image"] = (function(){
                var _d = Object.create(null);
                _d["default"] = null;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["base_font_size"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 16;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["book_scrollbar"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["columns_per_screen"] = (function(){
                var _d = Object.create(null);
                _d["default"] = (function(){
                    var _d = Object.create(null);
                    _d["portrait"] = 0;
                    _d["landscape"] = 0;
                    return _d;
                }).call(this);
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["controls_help_shown_count"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 0;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                _d["disallowed_in_profile"] = true;
                return _d;
            }).call(this);
            _d["controls_help_shown_count_rtl_page_progression"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 0;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                _d["disallowed_in_profile"] = true;
                return _d;
            }).call(this);
            _d["cover_preserve_aspect_ratio"] = (function(){
                var _d = Object.create(null);
                _d["default"] = true;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["current_color_scheme"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "system";
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["footer"] = (function(){
                var _d = Object.create(null);
                _d["default"] = (function(){
                    var _d = Object.create(null);
                    _d["left"] = "menu-icon-on-hover";
                    _d["right"] = "progress";
                    return _d;
                }).call(this);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["header"] = (function(){
                var _d = Object.create(null);
                _d["default"] = (function(){
                    var _d = Object.create(null);
                    _d["right"] = "menu-icon-on-hover";
                    return _d;
                }).call(this);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["controls_footer"] = (function(){
                var _d = Object.create(null);
                _d["default"] = (function(){
                    var _d = Object.create(null);
                    _d["right"] = "progress";
                    return _d;
                }).call(this);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["left-margin"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["right-margin"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["hide_tooltips"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["keyboard_shortcuts"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["lines_per_sec_auto"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 1;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["lines_per_sec_smooth"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 20;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["margin_bottom"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 20;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["margin_left"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 20;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["margin_right"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 20;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["margin_top"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 20;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["max_text_height"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 0;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["max_text_width"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 0;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["override_book_colors"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "never";
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["paged_margin_clicks_scroll_by_screen"] = (function(){
                var _d = Object.create(null);
                _d["default"] = true;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["paged_wheel_scrolls_by_screen"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["paged_wheel_section_jumps"] = (function(){
                var _d = Object.create(null);
                _d["default"] = true;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["paged_pixel_scroll_threshold"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 60;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["read_mode"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "paged";
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["scroll_auto_boundary_delay"] = (function(){
                var _d = Object.create(null);
                _d["default"] = 5;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["scroll_stop_boundaries"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["standalone_font_settings"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["standalone_misc_settings"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["standalone_recently_opened"] = (function(){
                var _d = Object.create(null);
                _d["default"] = [];
                _d["category"] = "read_book";
                _d["is_local"] = true;
                _d["disallowed_in_profile"] = true;
                return _d;
            }).call(this);
            _d["user_color_schemes"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["user_stylesheet"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "";
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["word_actions"] = (function(){
                var _d = Object.create(null);
                _d["default"] = [];
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["highlight_style"] = (function(){
                var _d = Object.create(null);
                _d["default"] = null;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["highlights_export_format"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "text";
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["custom_highlight_styles"] = (function(){
                var _d = Object.create(null);
                _d["default"] = [];
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["show_selection_bar"] = (function(){
                var _d = Object.create(null);
                _d["default"] = true;
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["net_search_url"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "https://google.com/search?q={q}";
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["selection_bar_actions"] = (function(){
                var _d = Object.create(null);
                _d["default"] = ['copy', 'lookup', 'highlight', 'remove_highlight', 'search_net', 'clear'];
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["selection_bar_quick_highlights"] = (function(){
                var _d = Object.create(null);
                _d["default"] = [];
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["skipped_dialogs"] = (function(){
                var _d = Object.create(null);
                _d["default"] = {};
                _d["category"] = "read_book";
                _d["is_local"] = true;
                _d["disallowed_in_profile"] = true;
                return _d;
            }).call(this);
            _d["tts"] = (function(){
                var _d = Object.create(null);
                _d["default"] = {};
                _d["category"] = "read_book";
                _d["is_local"] = true;
                _d["disallowed_in_profile"] = true;
                return _d;
            }).call(this);
            _d["tts_backend"] = (function(){
                var _d = Object.create(null);
                _d["default"] = {};
                _d["category"] = "read_book";
                _d["is_local"] = true;
                _d["disallowed_in_profile"] = true;
                return _d;
            }).call(this);
            _d["fullscreen_when_opening"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "auto";
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["book_search_mode"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "contains";
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["book_search_case_sensitive"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["reverse_page_turn_zones"] = (function(){
                var _d = Object.create(null);
                _d["default"] = false;
                _d["category"] = "read_book";
                _d["is_local"] = true;
                return _d;
            }).call(this);
            _d["gesture_overrides"] = (function(){
                var _d = Object.create(null);
                _d["default"] = Object.create(null);
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["cite_text_template"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "[{text}]({url})";
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            _d["cite_hl_template"] = (function(){
                var _d = Object.create(null);
                _d["default"] = "[{text}]({url})";
                _d["category"] = "read_book";
                return _d;
            }).call(this);
            return _d;
        }).call(this);
        defaults = Object.create(null);
        var _Iter0 = _Iterable(Object.entries(all_settings));
        for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
            x = _Iter0[_Index0];
            defaults[_bound_index(x[0], defaults)] = x[1].default;
        }
        function session_defaults() {
            return defaults;
        };
        if (!session_defaults.__module__) Object.defineProperties(session_defaults, {
            __module__ : {value: "session"}
        });

        function storage_available(which) {
            var storage, x;
            which = which || "localStorage";
            try {
                storage = window[(typeof which === "number" && which < 0) ? window.length + which : which];
                x = "__storage__test__";
                storage.setItem(x, x);
                storage.removeItem(x);
                return true;
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    return false;
                } 
            }
        };
        if (!storage_available.__argnames__) Object.defineProperties(storage_available, {
            __argnames__ : {value: ["which"]},
            __module__ : {value: "session"}
        });

        function FakeStorage() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            FakeStorage.prototype.__bind_methods__.call(this);
            FakeStorage.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(FakeStorage.prototype, "__bind_methods__", {value: function () {
            this.getItem = FakeStorage.prototype.getItem.bind(this);
            this.setItem = FakeStorage.prototype.setItem.bind(this);
            this.clear = FakeStorage.prototype.clear.bind(this);
        }});
        FakeStorage.prototype.__init__ = function __init__() {
            var self = this;
            self.data = Object.create(null);
        };
        if (!FakeStorage.prototype.__init__.__module__) Object.defineProperties(FakeStorage.prototype.__init__, {
            __module__ : {value: "session"}
        });
        FakeStorage.__argnames__ = FakeStorage.prototype.__init__.__argnames__;
        FakeStorage.__handles_kwarg_interpolation__ = FakeStorage.prototype.__init__.__handles_kwarg_interpolation__;
        FakeStorage.prototype.getItem = function getItem(key) {
            var self = this;
            return (_expr_temp = self.data)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
        };
        if (!FakeStorage.prototype.getItem.__argnames__) Object.defineProperties(FakeStorage.prototype.getItem, {
            __argnames__ : {value: ["key"]},
            __module__ : {value: "session"}
        });
        FakeStorage.prototype.setItem = function setItem(key, value) {
            var self = this;
            if (typeof value !== "string") {
                value = JSON.stringify(value);
            }
            (_expr_temp = self.data)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = value;
        };
        if (!FakeStorage.prototype.setItem.__argnames__) Object.defineProperties(FakeStorage.prototype.setItem, {
            __argnames__ : {value: ["key", "value"]},
            __module__ : {value: "session"}
        });
        FakeStorage.prototype.clear = function clear() {
            var self = this;
            self.data = Object.create(null);
        };
        if (!FakeStorage.prototype.clear.__module__) Object.defineProperties(FakeStorage.prototype.clear, {
            __module__ : {value: "session"}
        });
        FakeStorage.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        FakeStorage.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(FakeStorage.prototype, "__bases__", {value: []});

        function get_session_storage() {
            if (!get_session_storage.ans) {
                if (storage_available("localStorage")) {
                    get_session_storage.ans = window.localStorage;
                } else if (storage_available("sessionStorage")) {
                    get_session_storage.ans = window.sessionStorage;
                    console.error("localStorage not available using sessionStorage instead");
                } else {
                    get_session_storage.ans = new FakeStorage;
                    console.error("sessionStorage and localStorage not available using a temp cache instead");
                }
            }
            return get_session_storage.ans;
        };
        if (!get_session_storage.__module__) Object.defineProperties(get_session_storage, {
            __module__ : {value: "session"}
        });

        function SessionData() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            SessionData.prototype.__bind_methods__.call(this);
            SessionData.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(SessionData.prototype, "__bind_methods__", {value: function () {
            this.get = SessionData.prototype.get.bind(this);
            this.set = SessionData.prototype.set.bind(this);
            this.set_bulk = SessionData.prototype.set_bulk.bind(this);
            this.clear = SessionData.prototype.clear.bind(this);
        }});
        SessionData.prototype.__init__ = function __init__() {
            var self = this;
            var global_prefix = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.global_prefix : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "global_prefix")){
                global_prefix = _kwargs_obj.global_prefix;
            }
            self.global_prefix = global_prefix || "calibre-session-";
            self.storage = get_session_storage();
            self.overflow_storage = Object.create(null);
            self.has_overflow = false;
        };
        if (!SessionData.prototype.__init__.__defaults__) Object.defineProperties(SessionData.prototype.__init__, {
            __defaults__ : {value: {global_prefix:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["global_prefix"]},
            __module__ : {value: "session"}
        });
        SessionData.__argnames__ = SessionData.prototype.__init__.__argnames__;
        SessionData.__handles_kwarg_interpolation__ = SessionData.prototype.__init__.__handles_kwarg_interpolation__;
        SessionData.prototype.get = function get(key, defval) {
            var self = this;
            var ans;
            key = self.global_prefix + key;
            if (self.has_overflow) {
                ans = (_expr_temp = self.overflow_storage)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
                if (ans === undefined) {
                    ans = self.storage.getItem(key);
                }
            } else {
                ans = self.storage.getItem(key);
            }
            if (ans === undefined || ans === null) {
                if (defval === undefined) {
                    defval = null;
                }
                return defval;
            }
            try {
                return JSON.parse(ans);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    if (defval === undefined) {
                        defval = null;
                    }
                    return defval;
                } 
            }
        };
        if (!SessionData.prototype.get.__argnames__) Object.defineProperties(SessionData.prototype.get, {
            __argnames__ : {value: ["key", "defval"]},
            __module__ : {value: "session"}
        });
        SessionData.prototype.set = function set(key, value) {
            var self = this;
            key = self.global_prefix + key;
            if (value === null) {
                self.storage.removeItem(key);
                delete self.overflow_storage[key];
                return true;
            }
            value = JSON.stringify(value);
            try {
                self.storage.setItem(key, value);
                delete self.overflow_storage[key];
                return true;
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    (_expr_temp = self.overflow_storage)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = value;
                    self.has_overflow = true;
                    console.error("session storage has overflowed, using a temp cache instead");
                } 
            }
            return false;
        };
        if (!SessionData.prototype.set.__argnames__) Object.defineProperties(SessionData.prototype.set, {
            __argnames__ : {value: ["key", "value"]},
            __module__ : {value: "session"}
        });
        SessionData.prototype.set_bulk = function set_bulk(changes) {
            var self = this;
            var key;
            var _Iter1 = _Iterable(Object.keys(changes));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                key = _Iter1[_Index1];
                self.set(key, changes[(typeof key === "number" && key < 0) ? changes.length + key : key]);
            }
        };
        if (!SessionData.prototype.set_bulk.__argnames__) Object.defineProperties(SessionData.prototype.set_bulk, {
            __argnames__ : {value: ["changes"]},
            __module__ : {value: "session"}
        });
        SessionData.prototype.clear = function clear() {
            var self = this;
            self.storage.clear();
            self.overflow_storage = Object.create(null);
            self.has_overflow = false;
        };
        if (!SessionData.prototype.clear.__module__) Object.defineProperties(SessionData.prototype.clear, {
            __module__ : {value: "session"}
        });
        SessionData.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        SessionData.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(SessionData.prototype, "__bases__", {value: []});

        function local_storage() {
            if (!local_storage.storage) {
                local_storage.storage = new SessionData("calibre-local-");
            }
            return local_storage.storage;
        };
        if (!local_storage.__module__) Object.defineProperties(local_storage, {
            __module__ : {value: "session"}
        });

        function get_device_uuid() {
            var s, ans;
            if (!get_device_uuid.ans) {
                s = local_storage();
                ans = s.get("device_uuid");
                if (!ans) {
                    ans = short_uuid();
                    s.set("device_uuid", ans);
                }
                get_device_uuid.ans = ans;
            }
            return get_device_uuid.ans;
        };
        if (!get_device_uuid.__module__) Object.defineProperties(get_device_uuid, {
            __module__ : {value: "session"}
        });

        function deep_eq(a, b) {
            var i, ka, key;
            if (a === b) {
                return true;
            }
            if (Array.isArray(a) && Array.isArray(b)) {
                if (a.length !== b.length) {
                    return false;
                }
                for (var _Index2 = 0; _Index2 < a.length; _Index2++) {
                    i = _Index2;
                    if (!deep_eq(a[(typeof i === "number" && i < 0) ? a.length + i : i], b[(typeof i === "number" && i < 0) ? b.length + i : i])) {
                        return false;
                    }
                }
                return true;
            }
            if (a === null || b === null || a === undefined || b === undefined) {
                return false;
            }
            if (typeof a !== "object" || typeof b !== "object") {
                return false;
            }
            ka = Object.keys(a);
            if (ka.length !== Object.keys(b).length) {
                return false;
            }
            var _Iter3 = _Iterable(ka);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                key = _Iter3[_Index3];
                if (!deep_eq(a[(typeof key === "number" && key < 0) ? a.length + key : key], b[(typeof key === "number" && key < 0) ? b.length + key : key])) {
                    return false;
                }
            }
            return true;
        };
        if (!deep_eq.__argnames__) Object.defineProperties(deep_eq, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "session"}
        });

        function setting_val_is_default(setting_name, curval) {
            var defval;
            defval = defaults[(typeof setting_name === "number" && setting_name < 0) ? defaults.length + setting_name : setting_name];
            return deep_eq(defval, curval);
        };
        if (!setting_val_is_default.__argnames__) Object.defineProperties(setting_val_is_default, {
            __argnames__ : {value: ["setting_name", "curval"]},
            __module__ : {value: "session"}
        });

        function get_subset_of_settings(sd, filter_func) {
            var ans, curval, metadata, is_set, setting_name;
            ans = Object.create(null);
            var _Iter4 = _Iterable(Object.keys(all_settings));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                setting_name = _Iter4[_Index4];
                curval = sd.get(setting_name, ans);
                metadata = all_settings[(typeof setting_name === "number" && setting_name < 0) ? all_settings.length + setting_name : setting_name];
                is_set = curval !== ans;
                if (filter_func(setting_name, metadata, is_set, curval)) {
                    ans[(typeof setting_name === "number" && setting_name < 0) ? ans.length + setting_name : setting_name] = window.structuredClone((is_set) ? curval : metadata.default);
                }
            }
            return ans;
        };
        if (!get_subset_of_settings.__argnames__) Object.defineProperties(get_subset_of_settings, {
            __argnames__ : {value: ["sd", "filter_func"]},
            __module__ : {value: "session"}
        });

        function apply_profile(sd, profile, filter_func) {
            var changes, metadata, curval, is_set, newval, setting_name;
            changes = Object.create(null);
            var _Iter5 = _Iterable(Object.keys(all_settings));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                setting_name = _Iter5[_Index5];
                metadata = all_settings[(typeof setting_name === "number" && setting_name < 0) ? all_settings.length + setting_name : setting_name];
                curval = sd.get(setting_name, changes);
                is_set = curval !== changes;
                if (filter_func(setting_name, metadata, is_set, curval)) {
                    newval = null;
                    if (Object.prototype.hasOwnProperty.call(profile, setting_name)) {
                        newval = profile[(typeof setting_name === "number" && setting_name < 0) ? profile.length + setting_name : setting_name];
                        if (deep_eq(newval, metadata.default)) {
                            newval = null;
                        }
                    }
                    changes[(typeof setting_name === "number" && setting_name < 0) ? changes.length + setting_name : setting_name] = window.structuredClone(newval);
                }
            }
            sd.set_bulk(changes);
            return changes;
        };
        if (!apply_profile.__argnames__) Object.defineProperties(apply_profile, {
            __argnames__ : {value: ["sd", "profile", "filter_func"]},
            __module__ : {value: "session"}
        });

        standalone_reader_defaults = (function(){
            var _d = Object.create(null);
            _d["remember_window_geometry"] = false;
            _d["remember_last_read"] = true;
            _d["show_actions_toolbar"] = false;
            _d["show_actions_toolbar_in_fullscreen"] = false;
            _d["save_annotations_in_ebook"] = true;
            _d["sync_annots_user"] = "";
            _d["singleinstance"] = false;
            _d["auto_hide_mouse"] = true;
            _d["restore_docks"] = true;
            return _d;
        }).call(this);
        function settings_for_reader_profile(sd) {
            var margin_text_settings;
            margin_text_settings = (function(){
                var _d = Object.create(null);
                _d["footer"] = true;
                _d["header"] = true;
                _d["controls_footer"] = true;
                _d["left-margin"] = true;
                _d["right-margin"] = true;
                return _d;
            }).call(this);
            function filter_func(setting_name, metadata, is_set, curval) {
                var x, key;
                if (margin_text_settings[(typeof setting_name === "number" && setting_name < 0) ? margin_text_settings.length + setting_name : setting_name]) {
                    curval = window.structuredClone(curval);
                    var _Iter6 = _Iterable(['left', 'right', 'middle']);
                    for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                        x = _Iter6[_Index6];
                        if (curval[(typeof x === "number" && x < 0) ? curval.length + x : x] === "empty") {
                            delete curval[x];
                        }
                    }
                } else if (setting_name === "standalone_misc_settings") {
                    curval = window.structuredClone(curval);
                    var _Iter7 = _Iterable(Object.keys(curval));
                    for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                        key = _Iter7[_Index7];
                        if (curval[(typeof key === "number" && key < 0) ? curval.length + key : key] === standalone_reader_defaults[(typeof key === "number" && key < 0) ? standalone_reader_defaults.length + key : key]) {
                            delete curval[key];
                        }
                    }
                }
                if (!is_set || metadata.category !== "read_book" || metadata.disallowed_in_profile || deep_eq(curval, metadata.default)) {
                    return false;
                }
                return true;
            };
            if (!filter_func.__argnames__) Object.defineProperties(filter_func, {
                __argnames__ : {value: ["setting_name", "metadata", "is_set", "curval"]},
                __module__ : {value: "session"}
            });

            return get_subset_of_settings(sd, filter_func);
        };
        if (!settings_for_reader_profile.__argnames__) Object.defineProperties(settings_for_reader_profile, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "session"}
        });

        function apply_reader_profile(sd, profile) {
            function filter_func(setting_name, metadata, is_set, curval) {
                return metadata.category === "read_book" && !metadata.disallowed_in_profile;
            };
            if (!filter_func.__argnames__) Object.defineProperties(filter_func, {
                __argnames__ : {value: ["setting_name", "metadata", "is_set", "curval"]},
                __module__ : {value: "session"}
            });

            apply_profile(sd, profile, filter_func);
        };
        if (!apply_reader_profile.__argnames__) Object.defineProperties(apply_reader_profile, {
            __argnames__ : {value: ["sd", "profile"]},
            __module__ : {value: "session"}
        });

        default_interface_data = (function(){
            var _d = Object.create(null);
            _d["username"] = null;
            _d["output_format"] = "EPUB";
            _d["input_formats"] = (function(){
                var s = _set();
                s.jsset.add("EPUB");
                s.jsset.add("MOBI");
                s.jsset.add("AZW3");
                return s;
            })();
            _d["gui_pubdate_display_format"] = "MMM yyyy";
            _d["gui_timestamp_display_format"] = "dd MMM yyyy";
            _d["gui_last_modified_display_format"] = "dd MMM yyyy";
            _d["use_roman_numerals_for_series_number"] = true;
            _d["default_library_id"] = null;
            _d["default_book_list_mode"] = session_defaults().view_mode;
            _d["library_map"] = null;
            _d["search_the_net_urls"] = _list_decorate([]);
            _d["donate_link"] = "https://calibre-ebook.com/donate";
            _d["icon_map"] = Object.create(null);
            _d["icon_path"] = "";
            _d["custom_list_template"] = null;
            _d["num_per_page"] = 50;
            _d["lang_code_for_user_manual"] = "";
            return _d;
        }).call(this);
        function get_interface_data() {
            var ans, k;
            if (!get_interface_data.storage) {
                get_interface_data.storage = new SessionData("calibre-interface-data-");
            }
            ans = get_interface_data.storage.get("current");
            if (ans) {
                ans.is_default = false;
            } else {
                ans = (function(){
                    var _d = Object.create(null);
                    _d["is_default"] = true;
                    return _d;
                }).call(this);
                var _Iter8 = _Iterable(default_interface_data);
                for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                    k = _Iter8[_Index8];
                    ans[(typeof k === "number" && k < 0) ? ans.length + k : k] = default_interface_data[(typeof k === "number" && k < 0) ? default_interface_data.length + k : k];
                }
            }
            return ans;
        };
        if (!get_interface_data.__module__) Object.defineProperties(get_interface_data, {
            __module__ : {value: "session"}
        });

        function update_interface_data(new_data) {
            var data, nval, k;
            data = get_interface_data();
            var _Iter9 = _Iterable(default_interface_data);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                k = _Iter9[_Index9];
                nval = new_data[(typeof k === "number" && k < 0) ? new_data.length + k : k];
                if (k !== undefined) {
                    data[(typeof k === "number" && k < 0) ? data.length + k : k] = nval;
                }
            }
            if (!get_interface_data.storage) {
                get_interface_data.storage = new SessionData("calibre-interface-data-");
            }
            get_interface_data.storage.set("current", data);
        };
        if (!update_interface_data.__argnames__) Object.defineProperties(update_interface_data, {
            __argnames__ : {value: ["new_data"]},
            __module__ : {value: "session"}
        });

        function get_translations(newval) {
            if (!get_translations.storage) {
                get_translations.storage = new SessionData("calibre-translations-");
            }
            if ((typeof newval !== "undefined" && newval !== null)) {
                get_translations.storage.set("current", newval);
            } else {
                return get_translations.storage.get("current");
            }
        };
        if (!get_translations.__argnames__) Object.defineProperties(get_translations, {
            __argnames__ : {value: ["newval"]},
            __module__ : {value: "session"}
        });

        function is_setting_local(name) {
            var m;
            m = all_settings[(typeof name === "number" && name < 0) ? all_settings.length + name : name];
            return (m) ? m.is_local : true;
        };
        if (!is_setting_local.__argnames__) Object.defineProperties(is_setting_local, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "session"}
        });

        function UserSessionData() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            UserSessionData.prototype.__bind_methods__.call(this);
            UserSessionData.prototype.__init__.apply(this, arguments);
        }
        _extends(UserSessionData, SessionData);
        Object.defineProperty(UserSessionData.prototype, "__bind_methods__", {value: function () {
            SessionData.prototype.__bind_methods__ && SessionData.prototype.__bind_methods__.call(this);
            this.defval = UserSessionData.prototype.defval.bind(this);
            this.get = UserSessionData.prototype.get.bind(this);
            this.get_library_option = UserSessionData.prototype.get_library_option.bind(this);
            this.set = UserSessionData.prototype.set.bind(this);
            this.set_library_option = UserSessionData.prototype.set_library_option.bind(this);
            this.push_to_server = UserSessionData.prototype.push_to_server.bind(this);
        }});
        UserSessionData.prototype.__init__ = function __init__(username, saved_data) {
            var self = this;
            var key;
            self.prefix = (username || "") + "-";
            self.has_user = bool(username);
            self.username = username;
            SessionData.prototype.__init__.call(self);
            self.echo_changes = false;
            self.changes = Object.create(null);
            self.has_changes = false;
            self.push_timer_id = null;
            if (saved_data) {
                var _Iter10 = _Iterable(saved_data);
                for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                    key = _Iter10[_Index10];
                    if (!is_setting_local(key)) {
                        self.set(key, saved_data[(typeof key === "number" && key < 0) ? saved_data.length + key : key]);
                    }
                }
            }
            self.echo_changes = true;
        };
        if (!UserSessionData.prototype.__init__.__argnames__) Object.defineProperties(UserSessionData.prototype.__init__, {
            __argnames__ : {value: ["username", "saved_data"]},
            __module__ : {value: "session"}
        });
        UserSessionData.__argnames__ = UserSessionData.prototype.__init__.__argnames__;
        UserSessionData.__handles_kwarg_interpolation__ = UserSessionData.prototype.__init__.__handles_kwarg_interpolation__;
        UserSessionData.prototype.defval = function defval(key) {
            var self = this;
            var ans;
            ans = (_expr_temp = session_defaults())[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
            if (ans) {
                ans = window.structuredClone(ans);
            }
            return ans;
        };
        if (!UserSessionData.prototype.defval.__argnames__) Object.defineProperties(UserSessionData.prototype.defval, {
            __argnames__ : {value: ["key"]},
            __module__ : {value: "session"}
        });
        UserSessionData.prototype.get = function get(key, defval) {
            var self = this;
            if (defval === undefined) {
                defval = self.defval(key);
            }
            return SessionData.prototype.get.call(self, self.prefix + key, defval);
        };
        if (!UserSessionData.prototype.get.__argnames__) Object.defineProperties(UserSessionData.prototype.get, {
            __argnames__ : {value: ["key", "defval"]},
            __module__ : {value: "session"}
        });
        UserSessionData.prototype.get_library_option = function get_library_option(library_id, key, defval) {
            var self = this;
            var lkey;
            if (!library_id) {
                return self.get(key, defval);
            }
            lkey = key + "-||-" + library_id;
            if (defval === undefined) {
                defval = self.defval(key);
            }
            return self.get(lkey, defval);
        };
        if (!UserSessionData.prototype.get_library_option.__argnames__) Object.defineProperties(UserSessionData.prototype.get_library_option, {
            __argnames__ : {value: ["library_id", "key", "defval"]},
            __module__ : {value: "session"}
        });
        UserSessionData.prototype.set = function set(key, value) {
            var self = this;
            if (self.echo_changes && self.has_user && !is_setting_local(key)) {
                (_expr_temp = self.changes)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = value;
                self.has_changes = true;
                if (self.push_timer_id !== null) {
                    clearTimeout(self.push_timer_id);
                }
                self.push_timer_id = setTimeout(self.push_to_server.bind(self), 1e3);
            }
            return SessionData.prototype.set.call(self, self.prefix + key, value);
        };
        if (!UserSessionData.prototype.set.__argnames__) Object.defineProperties(UserSessionData.prototype.set, {
            __argnames__ : {value: ["key", "value"]},
            __module__ : {value: "session"}
        });
        UserSessionData.prototype.set_library_option = function set_library_option(library_id, key, value) {
            var self = this;
            if (library_id) {
                key = key + "-||-" + library_id;
            }
            return self.set(key, value);
        };
        if (!UserSessionData.prototype.set_library_option.__argnames__) Object.defineProperties(UserSessionData.prototype.set_library_option, {
            __argnames__ : {value: ["library_id", "key", "value"]},
            __module__ : {value: "session"}
        });
        UserSessionData.prototype.push_to_server = function push_to_server() {
            var self = this;
            if (self.has_changes) {
                ajax_send("interface-data/set-session-data", self.changes, (function() {
                    var _anonfunc = function (end_type, xhr, ev) {
                        if (end_type !== "load") {
                            console.error("Failed to send session data to server: " + xhr.error_html);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["end_type", "xhr", "ev"]},
                        __module__ : {value: "session"}
                    });
                    return _anonfunc;
                })());
                self.changes = Object.create(null);
                self.has_changes = false;
            }
        };
        if (!UserSessionData.prototype.push_to_server.__module__) Object.defineProperties(UserSessionData.prototype.push_to_server, {
            __module__ : {value: "session"}
        });
        UserSessionData.prototype.__repr__ = function __repr__ () {
            if(SessionData.prototype.__repr__) return SessionData.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        UserSessionData.prototype.__str__ = function __str__ () {
            if(SessionData.prototype.__str__) return SessionData.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(UserSessionData.prototype, "__bases__", {value: [SessionData]});

        _modules.session.all_settings = all_settings;
        _modules.session.defaults = defaults;
        _modules.session.x = x;
        _modules.session.standalone_reader_defaults = standalone_reader_defaults;
        _modules.session.default_interface_data = default_interface_data;
        _modules.session.session_defaults = session_defaults;
        _modules.session.storage_available = storage_available;
        _modules.session.FakeStorage = FakeStorage;
        _modules.session.get_session_storage = get_session_storage;
        _modules.session.SessionData = SessionData;
        _modules.session.local_storage = local_storage;
        _modules.session.get_device_uuid = get_device_uuid;
        _modules.session.deep_eq = deep_eq;
        _modules.session.setting_val_is_default = setting_val_is_default;
        _modules.session.get_subset_of_settings = get_subset_of_settings;
        _modules.session.apply_profile = apply_profile;
        _modules.session.settings_for_reader_profile = settings_for_reader_profile;
        _modules.session.apply_reader_profile = apply_reader_profile;
        _modules.session.get_interface_data = get_interface_data;
        _modules.session.update_interface_data = update_interface_data;
        _modules.session.get_translations = get_translations;
        _modules.session.is_setting_local = is_setting_local;
        _modules.session.UserSessionData = UserSessionData;
    })();

    (function(){
        var __name__ = "book_list.constants";
        var book_list_container_id, read_book_container_id, INIT_ENDPOINT;
        book_list_container_id = "book-list-container";
        read_book_container_id = "read-book-container";
        INIT_ENDPOINT = "interface-data/init";
        _modules["book_list.constants"].book_list_container_id = book_list_container_id;
        _modules["book_list.constants"].read_book_container_id = read_book_container_id;
        _modules["book_list.constants"].INIT_ENDPOINT = INIT_ENDPOINT;
    })();

    (function(){
        var __name__ = "book_list.cover_grid";
        var COVER_GRID_CLASS, THUMBNAIL_MAX_WIDTH, THUMBNAIL_MAX_HEIGHT, THUMBNAIL_MIN_WIDTH, THUMBNAIL_MIN_HEIGHT, BORDER_RADIUS;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var build_rule = _modules.dom.build_rule;

        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        COVER_GRID_CLASS = "book-list-cover-grid";
        THUMBNAIL_MAX_WIDTH = 3 * 100;
        THUMBNAIL_MAX_HEIGHT = 4 * 100;
        THUMBNAIL_MIN_WIDTH = 3 * 35;
        THUMBNAIL_MIN_HEIGHT = 4 * 35;
        BORDER_RADIUS = 10;
        function description() {
            return _("A grid of book covers");
        };
        if (!description.__module__) Object.defineProperties(description, {
            __module__ : {value: "book_list.cover_grid"}
        });

        function cover_grid_css() {
            var sel, _unpack, margin, margin_unit, ans, mq, dim;
            sel = "." + COVER_GRID_CLASS;
            _unpack = [10, "px"];
            margin = _unpack[0];
            margin_unit = _unpack[1];
            ans = _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({display: "flex", flex_wrap: "wrap", justify_content: "space-around", align_items: "flex-end", align_content: "flex-start", user_select: "none", overflow: "hidden", margin_top: "" + _str.format("{}", margin / 2) + "" + _str.format("{}", margin_unit) + ""})]));
            sel += " > a";
            ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin: "" + _str.format("{}", margin) + "" + _str.format("{}", margin_unit) + "", display: "flex", align_content: "flex-end", align_items: "center", justify_content: "space-around", max_width: THUMBNAIL_MAX_WIDTH + "px", max_height: THUMBNAIL_MAX_HEIGHT + "px", cursor: "pointer", min_width: THUMBNAIL_MIN_WIDTH + "px", min_height: THUMBNAIL_MIN_HEIGHT + "px"})]));
            mq = "@media all and (orientation: {orient}) {{ {sel} {{ width: 21{dim}; height: 28{dim} }} }}\n";
            var _Iter0 = _Iterable(_list_decorate([ "vw", "vh" ]));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                dim = _Iter0[_Index0];
                ans += _interpolate_kwargs.call(mq, mq.format, [_desugar_kwargs({sel: sel, dim: dim, orient: (dim === "vw") ? "portrait" : "landscape"})]);
            }
            ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + ":hover"].concat([_desugar_kwargs({transform: "scale(1.2)"})]));
            ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + ":active"].concat([_desugar_kwargs({transform: "scale(2)"})]));
            ans += _interpolate_kwargs.call(this, build_rule, [sel + ".cover-grid-filler"].concat([_desugar_kwargs({height: "0", max_height: "0", min_height: "0"})]));
            ans += _interpolate_kwargs.call(this, build_rule, [sel + " > div"].concat([_desugar_kwargs({position: "relative", top: "-50%", transform: "translateY(50%)", margin: "0"})]));
            sel += " > img";
            ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({max_width: "100%", max_height: "100%", display: "block", width: "auto", height: "auto", border_radius: BORDER_RADIUS + "px"})]));
            return ans;
        };
        if (!cover_grid_css.__module__) Object.defineProperties(cover_grid_css, {
            __module__ : {value: "book_list.cover_grid"}
        });

        function init(container) {
            var i;
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: COVER_GRID_CLASS})]));
            for (var _Index1 = 0; _Index1 < 12; _Index1++) {
                i = _Index1;
                container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "cover-grid-filler"})]));
            }
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.cover_grid"}
        });

        function on_img_load(img, load_type) {
            var div;
            div = img.parentNode;
            if (!div) {
                return;
            }
            if (load_type !== "load") {
                clear(div);
                div.appendChild(E.div(_interpolate_kwargs.call(E, E.h2, [img.dataset.title].concat([_desugar_kwargs({style: "text-align:center; font-size:larger; font-weight: bold"})])), _interpolate_kwargs.call(E, E.div, [_("by")].concat([_desugar_kwargs({style: "text-align: center"})])), _interpolate_kwargs.call(E, E.h2, [img.dataset.authors].concat([_desugar_kwargs({style: "text-align:center; font-size:larger; font-weight: bold"})]))));
                _interpolate_kwargs.call(this, set_css, [div].concat([_desugar_kwargs({border: "dashed 1px currentColor", border_radius: BORDER_RADIUS + "px"})]));
            }
        };
        if (!on_img_load.__argnames__) Object.defineProperties(on_img_load, {
            __argnames__ : {value: ["img", "load_type"]},
            __module__ : {value: "book_list.cover_grid"}
        });

        function create_item(book_id, metadata, create_image, show_book_details, href) {
            var authors, img, tooltip, _unpack, ans;
            authors = (metadata.authors) ? metadata.authors.join(" & ") : _("Unknown");
            img = create_image(book_id, THUMBNAIL_MAX_WIDTH, THUMBNAIL_MAX_HEIGHT, on_img_load);
            tooltip = _("{} by {}").format(metadata.title, authors);
            img.setAttribute("alt", tooltip);
            _unpack = [metadata.title, authors];
            img.dataset.title = _unpack[0];
            img.dataset.authors = _unpack[1];
            ans = _interpolate_kwargs.call(E, E.a, [img].concat([_desugar_kwargs({onclick: show_book_details, title: tooltip, href: href})]));
            return ans;
        };
        if (!create_item.__argnames__) Object.defineProperties(create_item, {
            __argnames__ : {value: ["book_id", "metadata", "create_image", "show_book_details", "href"]},
            __module__ : {value: "book_list.cover_grid"}
        });

        function append_item(container, item) {
            var first_filler;
            first_filler = container.lastChild.querySelector(".cover-grid-filler");
            container.lastChild.insertBefore(item, first_filler);
        };
        if (!append_item.__argnames__) Object.defineProperties(append_item, {
            __argnames__ : {value: ["container", "item"]},
            __module__ : {value: "book_list.cover_grid"}
        });

        _modules["book_list.cover_grid"].COVER_GRID_CLASS = COVER_GRID_CLASS;
        _modules["book_list.cover_grid"].THUMBNAIL_MAX_WIDTH = THUMBNAIL_MAX_WIDTH;
        _modules["book_list.cover_grid"].THUMBNAIL_MAX_HEIGHT = THUMBNAIL_MAX_HEIGHT;
        _modules["book_list.cover_grid"].THUMBNAIL_MIN_WIDTH = THUMBNAIL_MIN_WIDTH;
        _modules["book_list.cover_grid"].THUMBNAIL_MIN_HEIGHT = THUMBNAIL_MIN_HEIGHT;
        _modules["book_list.cover_grid"].BORDER_RADIUS = BORDER_RADIUS;
        _modules["book_list.cover_grid"].description = description;
        _modules["book_list.cover_grid"].cover_grid_css = cover_grid_css;
        _modules["book_list.cover_grid"].init = init;
        _modules["book_list.cover_grid"].on_img_load = on_img_load;
        _modules["book_list.cover_grid"].create_item = create_item;
        _modules["book_list.cover_grid"].append_item = append_item;
    })();

    (function(){
        var __name__ = "lru_cache";
        function lru_node(key, val) {
            return (function(){
                var _d = Object.create(null);
                _d["key"] = key;
                _d["val"] = val;
                _d["prev"] = null;
                _d["next"] = null;
                return _d;
            }).call(this);
        };
        if (!lru_node.__argnames__) Object.defineProperties(lru_node, {
            __argnames__ : {value: ["key", "val"]},
            __module__ : {value: "lru_cache"}
        });

        function LRUCache() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            LRUCache.prototype.__bind_methods__.call(this);
            LRUCache.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(LRUCache.prototype, "__bind_methods__", {value: function () {
            this.set_head = LRUCache.prototype.set_head.bind(this);
            this.pop = LRUCache.prototype.pop.bind(this);
            this.set = LRUCache.prototype.set.bind(this);
            this.get = LRUCache.prototype.get.bind(this);
            this.clear = LRUCache.prototype.clear.bind(this);
        }});
        LRUCache.prototype.__init__ = function __init__(size) {
            var self = this;
            self.limit = 200;
            self.clear(size);
        };
        if (!LRUCache.prototype.__init__.__argnames__) Object.defineProperties(LRUCache.prototype.__init__, {
            __argnames__ : {value: ["size"]},
            __module__ : {value: "lru_cache"}
        });
        LRUCache.__argnames__ = LRUCache.prototype.__init__.__argnames__;
        LRUCache.__handles_kwarg_interpolation__ = LRUCache.prototype.__init__.__handles_kwarg_interpolation__;
        LRUCache.prototype.set_head = function set_head(node) {
            var self = this;
            node.next = self.head;
            node.prev = null;
            if (self.head !== null) {
                self.head.prev = node;
            }
            self.head = node;
            if (self.tail === null) {
                self.tail = node;
            }
            self.size += 1;
            (_expr_temp = self.map)[_bound_index(node.key, _expr_temp)] = node;
        };
        if (!LRUCache.prototype.set_head.__argnames__) Object.defineProperties(LRUCache.prototype.set_head, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "lru_cache"}
        });
        LRUCache.prototype.pop = function pop(key) {
            var self = this;
            var node;
            node = (_expr_temp = self.map)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
            if (!node) {
                return;
            }
            if (node.prev !== null) {
                node.prev.next = node.next;
            } else {
                self.head = node.next;
            }
            if (node.next !== null) {
                node.next.prev = node.prev;
            } else {
                self.tail = node.prev;
            }
            delete self.map[key];
            self.size -= 1;
        };
        if (!LRUCache.prototype.pop.__argnames__) Object.defineProperties(LRUCache.prototype.pop, {
            __argnames__ : {value: ["key"]},
            __module__ : {value: "lru_cache"}
        });
        LRUCache.prototype.set = function set(key, val) {
            var self = this;
            var node, existing;
            node = lru_node(key, val);
            existing = (_expr_temp = self.map)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
            if (existing) {
                existing.value = node.value;
                self.pop(node.key);
            } else if (self.size > self.limit) {
                delete self.map[self.tail.key];
                self.size -= 1;
                self.tail = self.tail.prev;
                self.tail.next = null;
            }
            self.set_head(node);
        };
        if (!LRUCache.prototype.set.__argnames__) Object.defineProperties(LRUCache.prototype.set, {
            __argnames__ : {value: ["key", "val"]},
            __module__ : {value: "lru_cache"}
        });
        LRUCache.prototype.get = function get(key, defval) {
            var self = this;
            var existing, val, node;
            existing = (_expr_temp = self.map)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
            if (!existing) {
                return (defval === undefined) ? null : defval;
            }
            val = existing.value;
            node = lru_node(key, val);
            self.pop(key);
            self.set_head(node);
            return val;
        };
        if (!LRUCache.prototype.get.__argnames__) Object.defineProperties(LRUCache.prototype.get, {
            __argnames__ : {value: ["key", "defval"]},
            __module__ : {value: "lru_cache"}
        });
        LRUCache.prototype.clear = function clear(size) {
            var self = this;
            self.size = 0;
            self.map = Object.create(null);
            self.head = self.tail = null;
            if (typeof size === "number") {
                self.limit = size;
            }
        };
        if (!LRUCache.prototype.clear.__argnames__) Object.defineProperties(LRUCache.prototype.clear, {
            __argnames__ : {value: ["size"]},
            __module__ : {value: "lru_cache"}
        });
        LRUCache.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        LRUCache.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(LRUCache.prototype, "__bases__", {value: []});

        _modules.lru_cache.lru_node = lru_node;
        _modules.lru_cache.LRUCache = LRUCache;
    })();

    (function(){
        var __name__ = "book_list.library_data";
        var load_status, library_data, thumbnail_cache;
        var _ = _modules.gettext.gettext;

        var absolute_path = _modules.ajax.absolute_path;
        var ajax = _modules.ajax.ajax;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var LRUCache = _modules.lru_cache.LRUCache;

        var get_interface_data = _modules.session.get_interface_data;

        var parse_url_params = _modules.utils.parse_url_params;

        load_status = (function(){
            var _d = Object.create(null);
            _d["loading"] = true;
            _d["ok"] = false;
            _d["error_html"] = null;
            _d["current_fetch"] = null;
            _d["http_error_code"] = 0;
            return _d;
        }).call(this);
        library_data = (function(){
            var _d = Object.create(null);
            _d["metadata"] = Object.create(null);
            _d["previous_book_ids"] = [];
            _d["force_refresh"] = false;
            _d["bools_are_tristate"] = true;
            return _d;
        }).call(this);
        function current_library_id() {
            var q;
            q = parse_url_params();
            return q.library_id || get_interface_data().default_library_id;
        };
        if (!current_library_id.__module__) Object.defineProperties(current_library_id, {
            __module__ : {value: "book_list.library_data"}
        });

        function all_libraries() {
            var interface_data, lids;
            interface_data = get_interface_data();
            lids = _interpolate_kwargs.call(this, sorted, [interface_data.library_map].concat([_desugar_kwargs({key: (function() {
                var _anonfunc = function (x) {
                    return (_expr_temp = interface_data.library_map)[(typeof x === "number" && x < 0) ? _expr_temp.length + x : x];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x"]},
                    __module__ : {value: "book_list.library_data"}
                });
                return _anonfunc;
            })()})]));
            return (function() {
                var _Iter = _Iterable(lids), _Result = [], lid;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    lid = _Iter[_Index];
                    _Result.push([lid, (_expr_temp = interface_data.library_map)[(typeof lid === "number" && lid < 0) ? _expr_temp.length + lid : lid]]);
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!all_libraries.__module__) Object.defineProperties(all_libraries, {
            __module__ : {value: "book_list.library_data"}
        });

        function current_virtual_library() {
            var q;
            q = parse_url_params();
            return q.vl || "";
        };
        if (!current_virtual_library.__module__) Object.defineProperties(current_virtual_library, {
            __module__ : {value: "book_list.library_data"}
        });

        function last_virtual_library_for(library_id) {
            if (last_virtual_library_for.library_id === library_id) {
                return last_virtual_library_for.vl || "";
            }
            return "";
        };
        if (!last_virtual_library_for.__argnames__) Object.defineProperties(last_virtual_library_for, {
            __argnames__ : {value: ["library_id"]},
            __module__ : {value: "book_list.library_data"}
        });

        function url_books_query(sd) {
            var q, lid;
            q = parse_url_params();
            sd = sd || get_session_data();
            lid = current_library_id();
            return (function(){
                var _d = Object.create(null);
                _d["library_id"] = lid;
                _d["sort"] = q.sort || sd.get_library_option(lid, "sort");
                _d["search"] = q.search;
                _d["vl"] = current_virtual_library();
                return _d;
            }).call(this);
        };
        if (!url_books_query.__argnames__) Object.defineProperties(url_books_query, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "book_list.library_data"}
        });

        function loaded_books_query() {
            var sr, sort;
            sr = library_data.search_result;
            sort = null;
            if (sr) {
                sort = (function() {
                    var _Iter = _Iterable(zip(sr.sort.split(","), sr.sort_order.split(","))), _Result = [], s, o;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        _unpack = _Iter[_Index];
                        s = _unpack[0];
                        o = _unpack[1];
                        _Result.push(s + "." + o);
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })().join(",");
            }
            return (function(){
                var _d = Object.create(null);
                _d["library_id"] = (sr) ? sr.library_id : null;
                _d["sort"] = sort;
                _d["search"] = (typeof sr !== "undefined" && sr !== null ? sr : Object.create(null)).query;
                _d["vl"] = (typeof sr !== "undefined" && sr !== null ? sr : Object.create(null)).vl;
                return _d;
            }).call(this);
        };
        if (!loaded_books_query.__module__) Object.defineProperties(loaded_books_query, {
            __module__ : {value: "book_list.library_data"}
        });

        function current_sorted_field() {
            var sort, csf, csfo;
            if (library_data.search_result) {
                return [library_data.search_result.sort, library_data.search_result.sort_order];
            }
            sort = url_books_query().sort.partition(",")[0];
            csf = sort.partition(".")[0];
            csfo = sort.partition(".")[2] || "asc";
            return [csf, csfo];
        };
        if (!current_sorted_field.__module__) Object.defineProperties(current_sorted_field, {
            __module__ : {value: "book_list.library_data"}
        });

        function all_virtual_libraries() {
            return library_data.virtual_libraries || Object.create(null);
        };
        if (!all_virtual_libraries.__module__) Object.defineProperties(all_virtual_libraries, {
            __module__ : {value: "book_list.library_data"}
        });

        function update_library_data(data) {
            var key, sr;
            load_status.loading = false;
            load_status.ok = true;
            load_status.error_html = null;
            load_status.http_error_code = 0;
            library_data.previous_book_ids = [];
            if (library_data.for_library !== current_library_id()) {
                library_data.field_names = Object.create(null);
            }
            library_data.for_library = current_library_id();
            var _Iter0 = _Iterable("search_result sortable_fields field_metadata metadata virtual_libraries book_display_fields bools_are_tristate book_details_vertical_categories fts_enabled fields_that_support_notes".split(" "));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                key = _Iter0[_Index0];
                library_data[(typeof key === "number" && key < 0) ? library_data.length + key : key] = data[(typeof key === "number" && key < 0) ? data.length + key : key];
            }
            sr = library_data.search_result;
            if (sr) {
                last_virtual_library_for.library_id = sr.library_id;
                last_virtual_library_for.vl = sr.vl;
            } else {
                last_virtual_library_for.library_id = null;
                last_virtual_library_for.vl = null;
            }
        };
        if (!update_library_data.__argnames__) Object.defineProperties(update_library_data, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.library_data"}
        });

        function add_more_books(data) {
            var key, sr;
            var _Iter1 = _Iterable(data.metadata);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                key = _Iter1[_Index1];
                (_expr_temp = library_data.metadata)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = (_expr_temp = data.metadata)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
            }
            sr = library_data.search_result;
            if (sr && sr.book_ids && sr.book_ids.length > 0) {
                library_data.previous_book_ids = library_data.previous_book_ids.concat(sr.book_ids);
            }
            library_data.search_result = data.search_result;
        };
        if (!add_more_books.__argnames__) Object.defineProperties(add_more_books, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.library_data"}
        });

        function current_book_ids() {
            return library_data.previous_book_ids.concat(library_data.search_result.book_ids);
        };
        if (!current_book_ids.__module__) Object.defineProperties(current_book_ids, {
            __module__ : {value: "book_list.library_data"}
        });

        function remove_from_array(array, item) {
            var idx;
            while (true) {
                idx = array.indexOf(item);
                if (idx < 0) {
                    break;
                }
                array.splice(idx, 1);
            }
        };
        if (!remove_from_array.__argnames__) Object.defineProperties(remove_from_array, {
            __argnames__ : {value: ["array", "item"]},
            __module__ : {value: "book_list.library_data"}
        });

        function remove_book(book_id) {
            book_id = int(book_id);
            if (library_data.previous_book_ids) {
                remove_from_array(library_data.previous_book_ids, book_id);
            }
            if (_exists.d(library_data.search_result).book_ids) {
                remove_from_array(library_data.search_result.book_ids, book_id);
            }
        };
        if (!remove_book.__argnames__) Object.defineProperties(remove_book, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.library_data"}
        });

        function book_after(book_id, delta) {
            var ids, idx, new_idx;
            if (!delta) {
                delta = 1;
            }
            ids = current_book_ids();
            idx = ids.indexOf(int(book_id));
            if (idx > -1) {
                new_idx = (idx + ids.length + delta) % ids.length;
                return ids[(typeof new_idx === "number" && new_idx < 0) ? ids.length + new_idx : new_idx];
            }
        };
        if (!book_after.__argnames__) Object.defineProperties(book_after, {
            __argnames__ : {value: ["book_id", "delta"]},
            __module__ : {value: "book_list.library_data"}
        });

        function on_data_loaded(end_type, xhr, ev) {
            var data, sd, q;
            load_status.current_fetch = null;
            function bad_load(msg) {
                load_status.ok = false;
                load_status.loading = false;
                load_status.error_html = msg || xhr.error_html;
                load_status.http_error_code = xhr.status;
            };
            if (!bad_load.__argnames__) Object.defineProperties(bad_load, {
                __argnames__ : {value: ["msg"]},
                __module__ : {value: "book_list.library_data"}
            });

            if (end_type === "load") {
                data = JSON.parse(xhr.responseText);
                if (data.bad_restriction) {
                    bad_load(_("The library restriction for the current user is invalid: {}").format(data.bad_restriction));
                } else {
                    update_library_data(data);
                    sd = get_session_data();
                    q = loaded_books_query();
                    sd.set_library_option(q.library_id, "sort", q.sort);
                }
            } else if (end_type === "abort") {
            } else {
                bad_load();
            }
        };
        if (!on_data_loaded.__argnames__) Object.defineProperties(on_data_loaded, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.library_data"}
        });

        function fetch_init_data() {
            var query;
            if (load_status.current_fetch) {
                load_status.current_fetch.abort();
            }
            query = url_books_query();
            load_status.loading = true;
            load_status.ok = false;
            load_status.error_html = null;
            load_status.http_error_code = 0;
            load_status.current_fetch = _interpolate_kwargs.call(this, ajax, ["interface-data/books-init", on_data_loaded].concat([_desugar_kwargs({query: query})]));
            load_status.current_fetch.send();
        };
        if (!fetch_init_data.__module__) Object.defineProperties(fetch_init_data, {
            __module__ : {value: "book_list.library_data"}
        });

        function field_names_received(library_id, field, proceed, end_type, xhr, event) {
            var names;
            if (library_id !== current_library_id()) {
                return;
            }
            if (end_type !== "load") {
                if (end_type !== "abort") {
                    proceed(false, field, xhr.error_html);
                }
                return;
            }
            try {
                names = JSON.parse(xhr.responseText);
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof Error) {
                    var traceback = _modules.traceback;

                    traceback.print_exc();
                    proceed(false, field, "Invalid JSON from server");
                    return;
                } else {
                    throw _Exception;
                }
            }
            (_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] = (function(){
                var _d = Object.create(null);
                _d["loading"] = false;
                _d["loaded"] = true;
                _d["last_updated_at"] = Date.now();
                _d["names"] = names;
                return _d;
            }).call(this);
            proceed(true, field, names);
        };
        if (!field_names_received.__argnames__) Object.defineProperties(field_names_received, {
            __argnames__ : {value: ["library_id", "field", "proceed", "end_type", "xhr", "event"]},
            __module__ : {value: "book_list.library_data"}
        });

        function field_names_for(field, proceed) {
            if ((_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] && (_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field].loaded) {
                proceed(true, field, (_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field].names);
            }
            if (!(_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] || !(_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field].loading && Date.now() - (_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field].last_updated_at > 3600 * 1e3) {
                _interpolate_kwargs.call(this, ajax, ["interface-data/field-names/" + _str.format("{}", encodeURIComponent(field)) + "", field_names_received.bind(null, current_library_id(), field, proceed)].concat([_desugar_kwargs({query: (function(){
                    var _d = Object.create(null);
                    _d["library_id"] = current_library_id();
                    return _d;
                }).call(this)})])).send();
                if (!(_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field]) {
                    (_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] = (function(){
                        var _d = Object.create(null);
                        _d["last_updated_at"] = 0;
                        _d["loaded"] = false;
                        _d["names"] = [];
                        return _d;
                    }).call(this);
                }
                (_expr_temp = library_data.field_names)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field].loading = true;
            }
        };
        if (!field_names_for.__argnames__) Object.defineProperties(field_names_for, {
            __argnames__ : {value: ["field", "proceed"]},
            __module__ : {value: "book_list.library_data"}
        });

        function thumbnail_url(book_id, width, height) {
            var query, prefix, lid;
            query = "sz=" + _str.format("{}", Math.ceil(width * window.devicePixelRatio)) + "x" + _str.format("{}", Math.ceil(height * window.devicePixelRatio)) + "";
            prefix = "get/thumb/" + _str.format("{}", book_id) + "";
            lid = loaded_books_query().library_id || current_library_id();
            if (lid) {
                prefix += "/" + _str.format("{}", lid) + "";
            }
            return absolute_path("" + _str.format("{}", prefix) + "?" + _str.format("{}", query) + "");
        };
        if (!thumbnail_url.__argnames__) Object.defineProperties(thumbnail_url, {
            __argnames__ : {value: ["book_id", "width", "height"]},
            __module__ : {value: "book_list.library_data"}
        });

        function cover_url(book_id) {
            var lid;
            lid = current_library_id();
            return absolute_path("get/cover/" + _str.format("{}", book_id) + "/" + _str.format("{}", lid) + "");
        };
        if (!cover_url.__argnames__) Object.defineProperties(cover_url, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.library_data"}
        });

        function download_url(book_id, fmt, content_disposition) {
            var lid, ans;
            lid = current_library_id();
            ans = absolute_path("get/" + _str.format("{}", fmt) + "/" + _str.format("{}", book_id) + "/" + _str.format("{}", lid) + "");
            if (content_disposition) {
                ans += "?content_disposition=" + _str.format("{}", content_disposition) + "";
            }
            return ans;
        };
        if (!download_url.__argnames__) Object.defineProperties(download_url, {
            __argnames__ : {value: ["book_id", "fmt", "content_disposition"]},
            __module__ : {value: "book_list.library_data"}
        });

        function book_metadata(book_id) {
            return (_expr_temp = library_data.metadata)[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id];
        };
        if (!book_metadata.__argnames__) Object.defineProperties(book_metadata, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.library_data"}
        });

        function set_book_metadata(book_id, value) {
            (_expr_temp = library_data.metadata)[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id] = value;
        };
        if (!set_book_metadata.__argnames__) Object.defineProperties(set_book_metadata, {
            __argnames__ : {value: ["book_id", "value"]},
            __module__ : {value: "book_list.library_data"}
        });

        function loaded_book_ids() {
            return Object.keys(library_data.metadata);
        };
        if (!loaded_book_ids.__module__) Object.defineProperties(loaded_book_ids, {
            __module__ : {value: "book_list.library_data"}
        });

        function force_refresh_on_next_load() {
            library_data.force_refresh = true;
        };
        if (!force_refresh_on_next_load.__module__) Object.defineProperties(force_refresh_on_next_load, {
            __module__ : {value: "book_list.library_data"}
        });

        function ensure_current_library_data() {
            var fr, matches, q, loaded, key;
            fr = library_data.force_refresh;
            library_data.force_refresh = false;
            function is_same(a, b) {
                if (!a && !b) {
                    return true;
                }
                return a === b;
            };
            if (!is_same.__argnames__) Object.defineProperties(is_same, {
                __argnames__ : {value: ["a", "b"]},
                __module__ : {value: "book_list.library_data"}
            });

            if (fr) {
                matches = false;
            } else {
                q = url_books_query();
                loaded = loaded_books_query();
                matches = true;
                var _Iter2 = _Iterable(q);
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    key = _Iter2[_Index2];
                    if (!is_same(q[(typeof key === "number" && key < 0) ? q.length + key : key], loaded[(typeof key === "number" && key < 0) ? loaded.length + key : key])) {
                        matches = false;
                        break;
                    }
                }
            }
            if (!matches) {
                fetch_init_data();
            }
        };
        if (!ensure_current_library_data.__module__) Object.defineProperties(ensure_current_library_data, {
            __module__ : {value: "book_list.library_data"}
        });

        function ThumbnailCache() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ThumbnailCache.prototype.__bind_methods__.call(this);
            ThumbnailCache.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ThumbnailCache.prototype, "__bind_methods__", {value: function () {
            this.get = ThumbnailCache.prototype.get.bind(this);
            this.load_finished = ThumbnailCache.prototype.load_finished.bind(this);
        }});
        ThumbnailCache.prototype.__init__ = function __init__() {
            var self = this;
            var size = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.size : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "size")){
                size = _kwargs_obj.size;
            }
            self.cache = new LRUCache(size);
        };
        if (!ThumbnailCache.prototype.__init__.__defaults__) Object.defineProperties(ThumbnailCache.prototype.__init__, {
            __defaults__ : {value: {size:256}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["size"]},
            __module__ : {value: "book_list.library_data"}
        });
        ThumbnailCache.__argnames__ = ThumbnailCache.prototype.__init__.__argnames__;
        ThumbnailCache.__handles_kwarg_interpolation__ = ThumbnailCache.prototype.__init__.__handles_kwarg_interpolation__;
        ThumbnailCache.prototype.get = function get(book_id, width, height, callback) {
            var self = this;
            var url, item, img;
            url = thumbnail_url(book_id, width, height);
            item = self.cache.get(url);
            if (!item) {
                img = new Image;
                item = (function(){
                    var _d = Object.create(null);
                    _d["img"] = img;
                    _d["load_type"] = null;
                    _d["callbacks"] = [callback];
                    return _d;
                }).call(this);
                img.onerror = self.load_finished.bind(null, item, "error");
                img.onload = self.load_finished.bind(null, item, "load");
                img.onabort = self.load_finished.bind(null, item, "abort");
                img.dataset.bookId = book_id + "";
                img.src = url;
                self.cache.set(url, item);
                return img;
            }
            if (item.load_type === null) {
                if (item.callbacks.indexOf(callback) < 0) {
                    item.callbacks.push(callback);
                }
            } else {
                callback(item.img, item.load_type);
            }
            return item.img;
        };
        if (!ThumbnailCache.prototype.get.__argnames__) Object.defineProperties(ThumbnailCache.prototype.get, {
            __argnames__ : {value: ["book_id", "width", "height", "callback"]},
            __module__ : {value: "book_list.library_data"}
        });
        ThumbnailCache.prototype.load_finished = function load_finished(item, load_type) {
            var self = this;
            var img, callback;
            item.load_type = load_type;
            img = item.img;
            img.onload = img.onerror = img.onabort = null;
            var _Iter3 = _Iterable(item.callbacks);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                callback = _Iter3[_Index3];
                callback(img, load_type);
            }
        };
        if (!ThumbnailCache.prototype.load_finished.__argnames__) Object.defineProperties(ThumbnailCache.prototype.load_finished, {
            __argnames__ : {value: ["item", "load_type"]},
            __module__ : {value: "book_list.library_data"}
        });
        ThumbnailCache.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ThumbnailCache.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ThumbnailCache.prototype, "__bases__", {value: []});

        thumbnail_cache = new ThumbnailCache;
        function sync_library_books(library_id, to_sync, callback) {
            var url, which, lrmap, _unpack, book_id, fmt, key, last_read;
            url = "book-get-annotations/" + _str.format("{}", library_id) + "/";
            which = [];
            lrmap = Object.create(null);
            var _Iter4 = _Iterable(to_sync);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                _unpack = _Iter4[_Index4];
                key = _unpack[0];
                last_read = _unpack[1];
                _unpack = key;
_unpack = _unpack_asarray(3, _unpack);
                library_id = _unpack[0];
                book_id = _unpack[1];
                fmt = _unpack[2];
                fmt = fmt.upper();
                which.push("" + _str.format("{}", book_id) + "-" + _str.format("{}", fmt) + "");
                lrmap[_bound_index("" + _str.format("{}", book_id) + ":" + _str.format("{}", fmt) + "", lrmap)] = last_read;
            }
            url += which.join("_");
            ajax(url, callback.bind(null, library_id, lrmap)).send();
        };
        if (!sync_library_books.__argnames__) Object.defineProperties(sync_library_books, {
            __argnames__ : {value: ["library_id", "to_sync", "callback"]},
            __module__ : {value: "book_list.library_data"}
        });

        _modules["book_list.library_data"].load_status = load_status;
        _modules["book_list.library_data"].library_data = library_data;
        _modules["book_list.library_data"].thumbnail_cache = thumbnail_cache;
        _modules["book_list.library_data"].current_library_id = current_library_id;
        _modules["book_list.library_data"].all_libraries = all_libraries;
        _modules["book_list.library_data"].current_virtual_library = current_virtual_library;
        _modules["book_list.library_data"].last_virtual_library_for = last_virtual_library_for;
        _modules["book_list.library_data"].url_books_query = url_books_query;
        _modules["book_list.library_data"].loaded_books_query = loaded_books_query;
        _modules["book_list.library_data"].current_sorted_field = current_sorted_field;
        _modules["book_list.library_data"].all_virtual_libraries = all_virtual_libraries;
        _modules["book_list.library_data"].update_library_data = update_library_data;
        _modules["book_list.library_data"].add_more_books = add_more_books;
        _modules["book_list.library_data"].current_book_ids = current_book_ids;
        _modules["book_list.library_data"].remove_from_array = remove_from_array;
        _modules["book_list.library_data"].remove_book = remove_book;
        _modules["book_list.library_data"].book_after = book_after;
        _modules["book_list.library_data"].on_data_loaded = on_data_loaded;
        _modules["book_list.library_data"].fetch_init_data = fetch_init_data;
        _modules["book_list.library_data"].field_names_received = field_names_received;
        _modules["book_list.library_data"].field_names_for = field_names_for;
        _modules["book_list.library_data"].thumbnail_url = thumbnail_url;
        _modules["book_list.library_data"].cover_url = cover_url;
        _modules["book_list.library_data"].download_url = download_url;
        _modules["book_list.library_data"].book_metadata = book_metadata;
        _modules["book_list.library_data"].set_book_metadata = set_book_metadata;
        _modules["book_list.library_data"].loaded_book_ids = loaded_book_ids;
        _modules["book_list.library_data"].force_refresh_on_next_load = force_refresh_on_next_load;
        _modules["book_list.library_data"].ensure_current_library_data = ensure_current_library_data;
        _modules["book_list.library_data"].ThumbnailCache = ThumbnailCache;
        _modules["book_list.library_data"].sync_library_books = sync_library_books;
    })();

    (function(){
        var __name__ = "book_list.router";
        var mode_handlers, default_mode_handler, read_book_mode;
        var absolute_path = _modules.ajax.absolute_path;
        var encode_query = _modules.ajax.encode_query;

        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var book_list_container_id = _modules["book_list.constants"].book_list_container_id;
        var read_book_container_id = _modules["book_list.constants"].read_book_container_id;

        var get_current_query = _modules["book_list.globals"].get_current_query;
        var get_session_data = _modules["book_list.globals"].get_session_data;

        var current_library_id = _modules["book_list.library_data"].current_library_id;

        var close_all_modals = _modules.modals.close_all_modals;

        var encode_query_with_path = _modules.utils.encode_query_with_path;
        var parse_url_params = _modules.utils.parse_url_params;
        var request_full_screen = _modules.utils.request_full_screen;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        mode_handlers = Object.create(null);
        default_mode_handler = null;
        read_book_mode = "read_book";
        function set_mode_handler(mode, handler) {
            mode_handlers[(typeof mode === "number" && mode < 0) ? mode_handlers.length + mode : mode] = handler;
        };
        if (!set_mode_handler.__argnames__) Object.defineProperties(set_mode_handler, {
            __argnames__ : {value: ["mode", "handler"]},
            __module__ : {value: "book_list.router"}
        });

        function set_default_mode_handler(handler) {
            default_mode_handler = handler;
        };
        if (!set_default_mode_handler.__argnames__) Object.defineProperties(set_default_mode_handler, {
            __argnames__ : {value: ["handler"]},
            __module__ : {value: "book_list.router"}
        });

        function update_window_title() {
            var subtitle = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var title = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? update_window_title.__defaults__.title : arguments[1];
            var sep = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? update_window_title.__defaults__.sep : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "title")){
                title = _kwargs_obj.title;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "sep")){
                sep = _kwargs_obj.sep;
            }
            var extra;
            extra = (subtitle) ? sep + subtitle : "";
            document.title = title + extra;
        };
        if (!update_window_title.__defaults__) Object.defineProperties(update_window_title, {
            __defaults__ : {value: {title:"calibre", sep:" :: "}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["subtitle", "title", "sep"]},
            __module__ : {value: "book_list.router"}
        });

        function is_reading_book() {
            var cq;
            cq = get_current_query();
            return cq && cq.mode === read_book_mode;
        };
        if (!is_reading_book.__module__) Object.defineProperties(is_reading_book, {
            __module__ : {value: "book_list.router"}
        });

        function apply_mode() {
            var divid, div;
            divid = (is_reading_book()) ? read_book_container_id : book_list_container_id;
            var _Iter0 = _Iterable(document.getElementById(divid).parentNode.childNodes);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                div = _Iter0[_Index0];
                div.style.display = (div.id === divid) ? "block" : "none";
            }
        };
        if (!apply_mode.__module__) Object.defineProperties(apply_mode, {
            __module__ : {value: "book_list.router"}
        });

        function apply_url(ignore_handler) {
            var data, handler;
            close_all_modals();
            data = parse_url_params();
            data.mode = data.mode || "book_list";
            get_current_query(data);
            apply_mode();
            if (!ignore_handler) {
                handler = mode_handlers[_bound_index(data.mode, mode_handlers)] || default_mode_handler;
                handler(data);
            }
        };
        if (!apply_url.__argnames__) Object.defineProperties(apply_url, {
            __argnames__ : {value: ["ignore_handler"]},
            __module__ : {value: "book_list.router"}
        });

        function request_full_screen_if_wanted() {
            var opt, has_touch, at_left, likely_wants_fullscreen;
            opt = get_session_data().get("fullscreen_when_opening");
            has_touch = "ontouchstart" in window;
            at_left = window.screenLeft === 0;
            likely_wants_fullscreen = has_touch && at_left;
            if (opt === "auto" && likely_wants_fullscreen || opt === "always") {
                request_full_screen();
            }
        };
        if (!request_full_screen_if_wanted.__module__) Object.defineProperties(request_full_screen_if_wanted, {
            __module__ : {value: "book_list.router"}
        });

        function open_book() {
            var book_id = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var fmt = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var library_id = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? open_book.__defaults__.library_id : arguments[2];
            var replace = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? open_book.__defaults__.replace : arguments[3];
            var extra_query = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? open_book.__defaults__.extra_query : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "library_id")){
                library_id = _kwargs_obj.library_id;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "extra_query")){
                extra_query = _kwargs_obj.extra_query;
            }
            var q;
            request_full_screen_if_wanted();
            library_id = library_id || current_library_id();
            q = (function(){
                var _d = Object.create(null);
                _d["book_id"] = book_id;
                _d["fmt"] = fmt;
                _d["library_id"] = library_id;
                return _d;
            }).call(this);
            if (extra_query && typeof extra_query === "object") {
                Object.assign(q, extra_query);
            }
            _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: replace, mode: read_book_mode})]));
        };
        if (!open_book.__defaults__) Object.defineProperties(open_book, {
            __defaults__ : {value: {library_id:null, replace:false, extra_query:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["book_id", "fmt", "library_id", "replace", "extra_query"]},
            __module__ : {value: "book_list.router"}
        });

        function open_book_url(book_id, fmt, extra_query) {
            var lid, ans, q;
            lid = current_library_id();
            ans = absolute_path("");
            q = (function(){
                var _d = Object.create(null);
                _d["book_id"] = book_id;
                _d["fmt"] = fmt;
                _d["mode"] = read_book_mode;
                return _d;
            }).call(this);
            if (lid) {
                q.library_id = lid;
            }
            if (extra_query) {
                Object.assign(q, extra_query);
            }
            return ans + encode_query(q, "#");
        };
        if (!open_book_url.__argnames__) Object.defineProperties(open_book_url, {
            __argnames__ : {value: ["book_id", "fmt", "extra_query"]},
            __module__ : {value: "book_list.router"}
        });

        function show_note() {
            var field = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var item_id = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var item_value = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var replace = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_note.__defaults__.replace : arguments[3];
            var library_id = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_note.__defaults__.library_id : arguments[4];
            var close_action = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_note.__defaults__.close_action : arguments[5];
            var panel = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_note.__defaults__.panel : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "library_id")){
                library_id = _kwargs_obj.library_id;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "close_action")){
                close_action = _kwargs_obj.close_action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "panel")){
                panel = _kwargs_obj.panel;
            }
            var lid, q;
            lid = library_id || current_library_id();
            q = (function(){
                var _d = Object.create(null);
                _d["field"] = field;
                _d["item"] = item_value + "";
                _d["item_id"] = (item_id || "") + "";
                _d["panel"] = panel;
                return _d;
            }).call(this);
            if (panel === "show_note") {
                q.close_action = close_action;
            }
            if (lid) {
                q.library_id = lid;
            }
            _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: replace})]));
        };
        if (!show_note.__defaults__) Object.defineProperties(show_note, {
            __defaults__ : {value: {replace:false, library_id:null, close_action:"back", panel:"show_note"}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["field", "item_id", "item_value", "replace", "library_id", "close_action", "panel"]},
            __module__ : {value: "book_list.router"}
        });

        function push_state() {
            var query = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var replace = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? push_state.__defaults__.replace : arguments[1];
            var mode = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? push_state.__defaults__.mode : arguments[2];
            var call_handler = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? push_state.__defaults__.call_handler : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "mode")){
                mode = _kwargs_obj.mode;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "call_handler")){
                call_handler = _kwargs_obj.call_handler;
            }
            var k;
            query = (function() {
                var _Iter = _Iterable(query), _Result = Object.create(null), k;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    k = _Iter[_Index];
                    if (query[(typeof k === "number" && k < 0) ? query.length + k : k]) {
                        _Result[k] = (query[(typeof k === "number" && k < 0) ? query.length + k : k]);
                    }
                }
                return _Result;
            })();
            if (mode !== "book_list") {
                query.mode = mode;
            }
            query = encode_query_with_path(query);
            if (replace) {
                window.history.replaceState(null, "", query);
            } else {
                window.history.pushState(null, "", query);
                push_state.history_count += 1;
            }
            apply_url(!call_handler);
        };
        if (!push_state.__defaults__) Object.defineProperties(push_state, {
            __defaults__ : {value: {replace:false, mode:"book_list", call_handler:true}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["query", "replace", "mode", "call_handler"]},
            __module__ : {value: "book_list.router"}
        });

        push_state.history_count = 0;
        function on_pop_state(ev) {
            push_state.history_count = max(0, push_state.history_count - 1);
            apply_url();
        };
        if (!on_pop_state.__argnames__) Object.defineProperties(on_pop_state, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "book_list.router"}
        });

        function back() {
            var cq, handler, q;
            if (push_state.history_count > 0) {
                window.history.back();
            } else {
                cq = get_current_query();
                handler = mode_handlers[_bound_index(cq.mode, mode_handlers)] || default_mode_handler;
                if (handler.back_from_current) {
                    q = handler.back_from_current(cq);
                } else {
                    q = Object.create(null);
                }
                _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: true})]));
            }
        };
        if (!back.__module__) Object.defineProperties(back, {
            __module__ : {value: "book_list.router"}
        });

        function home() {
            var replace = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? home.__defaults__.replace : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            push_state(Object.create(null));
        };
        if (!home.__defaults__) Object.defineProperties(home, {
            __defaults__ : {value: {replace:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["replace"]},
            __module__ : {value: "book_list.router"}
        });

        function report_a_load_failure(container, msg, error_html) {
            var err;
            err = E.div();
            safe_set_inner_html(err, error_html);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(msg), err, _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Go back to the home page")].concat([_desugar_kwargs({onclick: (function() {
                var _anonfunc = function () {
                    _interpolate_kwargs.call(this, home, [_desugar_kwargs({replace: true})]);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.router"}
                });
                return _anonfunc;
            })(), href: "javascript: void(0)", class_: "blue-link"})]))].concat([_desugar_kwargs({style: "margin-top: 1em; border-top: solid 1px currentColor; padding-top: 1ex;"})]))].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
        };
        if (!report_a_load_failure.__argnames__) Object.defineProperties(report_a_load_failure, {
            __argnames__ : {value: ["container", "msg", "error_html"]},
            __module__ : {value: "book_list.router"}
        });

        _modules["book_list.router"].mode_handlers = mode_handlers;
        _modules["book_list.router"].default_mode_handler = default_mode_handler;
        _modules["book_list.router"].read_book_mode = read_book_mode;
        _modules["book_list.router"].set_mode_handler = set_mode_handler;
        _modules["book_list.router"].set_default_mode_handler = set_default_mode_handler;
        _modules["book_list.router"].update_window_title = update_window_title;
        _modules["book_list.router"].is_reading_book = is_reading_book;
        _modules["book_list.router"].apply_mode = apply_mode;
        _modules["book_list.router"].apply_url = apply_url;
        _modules["book_list.router"].request_full_screen_if_wanted = request_full_screen_if_wanted;
        _modules["book_list.router"].open_book = open_book;
        _modules["book_list.router"].open_book_url = open_book_url;
        _modules["book_list.router"].show_note = show_note;
        _modules["book_list.router"].push_state = push_state;
        _modules["book_list.router"].on_pop_state = on_pop_state;
        _modules["book_list.router"].back = back;
        _modules["book_list.router"].home = home;
        _modules["book_list.router"].report_a_load_failure = report_a_load_failure;
    })();

    (function(){
        var __name__ = "book_list.top_bar";
        var bar_counter, CLASS_NAME, SPACING, VSPACING, THROBBER_NAME;
        var get_color = _modules["book_list.theme"].get_color;
        var get_font_size = _modules["book_list.theme"].get_font_size;

        var set_css = _modules.dom.set_css;
        var clear = _modules.dom.clear;
        var create_keyframes = _modules.dom.create_keyframes;
        var build_rule = _modules.dom.build_rule;
        var svgicon = _modules.dom.svgicon;
        var add_extra_css = _modules.dom.add_extra_css;

        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_interface_data = _modules.session.get_interface_data;

        bar_counter = 0;
        CLASS_NAME = "main-top-bar";
        SPACING = "0.75em";
        VSPACING = "0.5ex";
        THROBBER_NAME = "top-bar-throbber";
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME + " ";
                style = "";
                style += create_keyframes(THROBBER_NAME, "from { transform: scale(1); } 50% { transform: scale(0.5); } to { transform: scale(1); }");
                style += _interpolate_kwargs.call(this, build_rule, [sel + "a"].concat([_desugar_kwargs({display: "inline-block", vertical_align: "middle", overflow: "hidden", cursor: "pointer", color: get_color("bar-foreground"), background: "none", padding_top: VSPACING, padding_bottom: VSPACING})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "a:hover"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "a:active"].concat([_desugar_kwargs({transform: "scale(2)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "a:focus"].concat([_desugar_kwargs({outline: "none"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "a.top-bar-title:hover"].concat([_desugar_kwargs({transform: "scale(1)", color: get_color("bar-highlight"), font_style: "italic"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "a.top-bar-title:active"].concat([_desugar_kwargs({transform: "scale(1)", color: get_color("bar-highlight"), font_style: "italic"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.top_bar"}
            });
            return _anonfunc;
        })());
        function create_markup(container) {
            var bar, i;
            for (var _Index0 = 0; _Index0 < 2; _Index0++) {
                i = _Index0;
                bar = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "white-space:nowrap; overflow:hidden; text-overflow: ellipsis; padding-left: 0.5em;"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "white-space:nowrap; text-align:right; padding-right: 0.5em;"})])].concat([_desugar_kwargs({class_: CLASS_NAME})]));
                if (i === 0) {
                    _interpolate_kwargs.call(this, set_css, [bar].concat([_desugar_kwargs({position: "fixed", left: "0", top: "0", z_index: "1"})]));
                }
                _interpolate_kwargs.call(this, set_css, [bar].concat([_desugar_kwargs({width: "100%", display: "flex", flex_direction: "row", flex_wrap: "wrap", justify_content: "space-between", font_size: get_font_size("title"), user_select: "none", color: get_color("bar-foreground"), background_color: get_color("bar-background")})]));
                container.appendChild(bar);
            }
        };
        if (!create_markup.__argnames__) Object.defineProperties(create_markup, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function get_bars(container) {
            return container.getElementsByClassName(CLASS_NAME);
        };
        if (!get_bars.__argnames__) Object.defineProperties(get_bars, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function set_left_data() {
            var container = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var title = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.title : arguments[1];
            var icon = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.icon : arguments[2];
            var action = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.action : arguments[3];
            var tooltip = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.tooltip : arguments[4];
            var run_animation = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.run_animation : arguments[5];
            var title_action = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.title_action : arguments[6];
            var title_tooltip = (arguments[7] === undefined || ( 7 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? set_left_data.__defaults__.title_tooltip : arguments[7];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "title")){
                title = _kwargs_obj.title;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "icon")){
                icon = _kwargs_obj.icon;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "action")){
                action = _kwargs_obj.action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "run_animation")){
                run_animation = _kwargs_obj.run_animation;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "title_action")){
                title_action = _kwargs_obj.title_action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "title_tooltip")){
                title_tooltip = _kwargs_obj.title_tooltip;
            }
            var bars, interface_data, left, title_elem, a, _unpack, i, bar;
            bars = get_bars(container);
            if (icon === "heart") {
                if (!tooltip) {
                    tooltip = _("Donate to support calibre development");
                }
            }
            interface_data = get_interface_data();
            var _Iter1 = _Iterable(enumerate(bars));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                _unpack = _Iter1[_Index1];
                i = _unpack[0];
                bar = _unpack[1];
                left = bar.firstChild;
                clear(left);
                title_elem = (callable(title_action)) ? "a" : "span";
                left.appendChild(_interpolate_kwargs.call(E, E.a, [svgicon(icon)].concat([_desugar_kwargs({title: tooltip})])));
                left.appendChild(_interpolate_kwargs.call(this, E, [title_elem, title].concat([_desugar_kwargs({title: title_tooltip, class_: "top-bar-title", style: "margin-left: {0}; font-weight: bold; padding-top: {1}; padding-bottom: {1}; vertical-align: middle".format(SPACING, VSPACING)})])));
                if (i === 0) {
                    a = left.firstChild;
                    if (icon === "heart") {
                        _interpolate_kwargs.call(this, set_css, [a].concat([_desugar_kwargs({animation_name: THROBBER_NAME, animation_duration: "1s", animation_timing_function: "ease-in-out", animation_iteration_count: "5", animation_play_state: (run_animation) ? "running" : "paused"})]));
                        _interpolate_kwargs.call(this, set_css, [a.firstChild].concat([_desugar_kwargs({color: get_color("heart")})]));
                        a.setAttribute("href", interface_data.donate_link);
                        a.setAttribute("target", "donate-to-calibre");
                    }
                    if (action !== null) {
                        a.addEventListener("click", (function() {
                            var _anonfunc = function (event) {
                                event.preventDefault();
                                action.bind(event)();
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["event"]},
                                __module__ : {value: "book_list.top_bar"}
                            });
                            return _anonfunc;
                        })());
                    }
                    if (callable(title_action)) {
                        a = a.nextSibling;
                        a.addEventListener("click", (function() {
                            var _anonfunc = function (event) {
                                event.preventDefault();
                                title_action.bind(event)();
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["event"]},
                                __module__ : {value: "book_list.top_bar"}
                            });
                            return _anonfunc;
                        })());
                    }
                }
            }
        };
        if (!set_left_data.__defaults__) Object.defineProperties(set_left_data, {
            __defaults__ : {value: {title:"calibre", icon:"heart", action:null, tooltip:"", run_animation:false, title_action:null, title_tooltip:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["container", "title", "icon", "action", "tooltip", "run_animation", "title_action", "title_tooltip"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function set_title(container, text) {
            var bars, bar;
            bars = get_bars(container);
            var _Iter2 = _Iterable(bars);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                bar = _Iter2[_Index2];
                bar.firstChild.firstChild.nextSibling.textContent = text;
            }
        };
        if (!set_title.__argnames__) Object.defineProperties(set_title, {
            __argnames__ : {value: ["container", "text"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function set_title_tooltip(container, text) {
            var bars, bar;
            bars = get_bars(container);
            var _Iter3 = _Iterable(bars);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                bar = _Iter3[_Index3];
                bar.firstChild.firstChild.nextSibling.title = text;
            }
        };
        if (!set_title_tooltip.__argnames__) Object.defineProperties(set_title_tooltip, {
            __argnames__ : {value: ["container", "text"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function create_top_bar() {
            var container = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            create_markup(container);
            _interpolate_kwargs.call(this, set_left_data, [container].concat([_desugar_kwargs(kw)]));
        };
        if (!create_top_bar.__handles_kwarg_interpolation__) Object.defineProperties(create_top_bar, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function add_button() {
            var container = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var icon = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var action = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_button.__defaults__.action : arguments[2];
            var tooltip = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_button.__defaults__.tooltip : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "action")){
                action = _kwargs_obj.action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            var bars, right, _unpack, i, bar;
            if (!icon) {
                throw new ValueError("An icon must be specified");
            }
            bars = get_bars(container);
            var _Iter4 = _Iterable(enumerate(bars));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                _unpack = _Iter4[_Index4];
                i = _unpack[0];
                bar = _unpack[1];
                right = bar.firstChild.nextSibling;
                right.appendChild(_interpolate_kwargs.call(E, E.a, [svgicon(icon)].concat([_desugar_kwargs({style: "margin-left: " + SPACING, title: tooltip})])));
                right.lastChild.dataset.buttonIcon = icon;
                if (i === 0) {
                    if (action !== null) {
                        right.lastChild.addEventListener("click", (function() {
                            var _anonfunc = function (event) {
                                [event.preventDefault(), action()];
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["event"]},
                                __module__ : {value: "book_list.top_bar"}
                            });
                            return _anonfunc;
                        })());
                    }
                }
            }
        };
        if (!add_button.__defaults__) Object.defineProperties(add_button, {
            __defaults__ : {value: {action:null, tooltip:""}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["container", "icon", "action", "tooltip"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function clear_buttons(container) {
            var bars, right, _unpack, i, bar;
            bars = get_bars(container);
            var _Iter5 = _Iterable(enumerate(bars));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                _unpack = _Iter5[_Index5];
                i = _unpack[0];
                bar = _unpack[1];
                right = bar.firstChild.nextSibling;
                clear(right);
            }
        };
        if (!clear_buttons.__argnames__) Object.defineProperties(clear_buttons, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.top_bar"}
        });

        function set_button_visibility(container, icon, visible) {
            var right, elem, bar;
            var _Iter6 = _Iterable(get_bars(container));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                bar = _Iter6[_Index6];
                right = bar.firstChild.nextSibling;
                elem = right.querySelector("[data-button-icon=\"" + _str.format("{}", icon) + "\"]");
                if (elem) {
                    elem.style.display = (visible) ? "inline-block" : "none";
                }
            }
        };
        if (!set_button_visibility.__argnames__) Object.defineProperties(set_button_visibility, {
            __argnames__ : {value: ["container", "icon", "visible"]},
            __module__ : {value: "book_list.top_bar"}
        });

        _modules["book_list.top_bar"].bar_counter = bar_counter;
        _modules["book_list.top_bar"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.top_bar"].SPACING = SPACING;
        _modules["book_list.top_bar"].VSPACING = VSPACING;
        _modules["book_list.top_bar"].THROBBER_NAME = THROBBER_NAME;
        _modules["book_list.top_bar"].create_markup = create_markup;
        _modules["book_list.top_bar"].get_bars = get_bars;
        _modules["book_list.top_bar"].set_left_data = set_left_data;
        _modules["book_list.top_bar"].set_title = set_title;
        _modules["book_list.top_bar"].set_title_tooltip = set_title_tooltip;
        _modules["book_list.top_bar"].create_top_bar = create_top_bar;
        _modules["book_list.top_bar"].add_button = add_button;
        _modules["book_list.top_bar"].clear_buttons = clear_buttons;
        _modules["book_list.top_bar"].set_button_visibility = set_button_visibility;
    })();

    (function(){
        var __name__ = "book_list.ui";
        var panel_handlers, default_panel_handler;
        var ensure_id = _modules.dom.ensure_id;
        var clear = _modules.dom.clear;

        var E = _modules.elementmaker.E;

        var book_list_container_id = _modules["book_list.constants"].book_list_container_id;

        var get_current_query = _modules["book_list.globals"].get_current_query;

        var push_state = _modules["book_list.router"].push_state;

        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var current_virtual_library = _modules["book_list.library_data"].current_virtual_library;

        var encode_query_with_path = _modules.utils.encode_query_with_path;

        panel_handlers = Object.create(null);
        default_panel_handler = null;
        function set_panel_handler(panel, handler) {
            panel_handlers[(typeof panel === "number" && panel < 0) ? panel_handlers.length + panel : panel] = handler;
        };
        if (!set_panel_handler.__argnames__) Object.defineProperties(set_panel_handler, {
            __argnames__ : {value: ["panel", "handler"]},
            __module__ : {value: "book_list.ui"}
        });

        function set_default_panel_handler(handler) {
            default_panel_handler = handler;
        };
        if (!set_default_panel_handler.__argnames__) Object.defineProperties(set_default_panel_handler, {
            __argnames__ : {value: ["handler"]},
            __module__ : {value: "book_list.ui"}
        });

        function develop_panel(container_id) {
            var container, q, m;
            container = document.getElementById(container_id);
            q = get_current_query();
            m = q.widget_module;
            if (m) {
                m = get_module(m);
                if ((typeof m !== "undefined" && m !== null ? m : Object.create(null)).develop) {
                    m.develop(container);
                } else {
                    container.textContent = "The module {} either does not exist or has no develop method.".format(q.widget_module);
                }
            }
        };
        if (!develop_panel.__argnames__) Object.defineProperties(develop_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.ui"}
        });

        set_panel_handler("develop-widgets", develop_panel);
        function currently_showing_panel() {
            var c;
            c = document.getElementById(book_list_container_id);
            return c.dataset.panel;
        };
        if (!currently_showing_panel.__module__) Object.defineProperties(currently_showing_panel, {
            __module__ : {value: "book_list.ui"}
        });

        function add_library_info(query) {
            var vlid;
            if (!query.library_id) {
                query.library_id = current_library_id();
            }
            if (!query.vl) {
                if (query.vl === null) {
                    delete query.vl;
                } else {
                    vlid = current_virtual_library();
                    if (vlid) {
                        query.vl = vlid;
                    }
                }
            }
        };
        if (!add_library_info.__argnames__) Object.defineProperties(add_library_info, {
            __argnames__ : {value: ["query"]},
            __module__ : {value: "book_list.ui"}
        });

        function prepare_query(query, panel) {
            var q, k;
            q = (function() {
                var _Iter = _Iterable(query || Object.create(null)), _Result = Object.create(null), k;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    k = _Iter[_Index];
                    if (k !== "panel") {
                        _Result[k] = (query[(typeof k === "number" && k < 0) ? query.length + k : k]);
                    }
                }
                return _Result;
            })();
            if (panel !== "home") {
                q.panel = panel;
                add_library_info(q);
            }
            return q;
        };
        if (!prepare_query.__argnames__) Object.defineProperties(prepare_query, {
            __argnames__ : {value: ["query", "panel"]},
            __module__ : {value: "book_list.ui"}
        });

        function query_as_href(query, panel) {
            var q;
            q = prepare_query(query, panel || "book_list");
            return encode_query_with_path(q);
        };
        if (!query_as_href.__argnames__) Object.defineProperties(query_as_href, {
            __argnames__ : {value: ["query", "panel"]},
            __module__ : {value: "book_list.ui"}
        });

        function show_panel() {
            var panel = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var query = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_panel.__defaults__.query : arguments[1];
            var replace = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_panel.__defaults__.replace : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "query")){
                query = _kwargs_obj.query;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            _interpolate_kwargs.call(this, push_state, [prepare_query(query, panel)].concat([_desugar_kwargs({replace: replace})]));
        };
        if (!show_panel.__defaults__) Object.defineProperties(show_panel, {
            __defaults__ : {value: {query:null, replace:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["panel", "query", "replace"]},
            __module__ : {value: "book_list.ui"}
        });

        function apply_url_state(state) {
            var panel, c, handler;
            panel = state.panel || "home";
            c = document.getElementById(book_list_container_id);
            clear(c);
            c.appendChild(E.div());
            c.dataset.panel = panel;
            handler = panel_handlers[(typeof panel === "number" && panel < 0) ? panel_handlers.length + panel : panel] || default_panel_handler;
            handler(ensure_id(c.firstChild, "panel"));
        };
        if (!apply_url_state.__argnames__) Object.defineProperties(apply_url_state, {
            __argnames__ : {value: ["state"]},
            __module__ : {value: "book_list.ui"}
        });

        apply_url_state.back_from_current = (function() {
            var _anonfunc = function back_from_current(current_query) {
                var q, k;
                q = current_query;
                if (q.panel) {
                    if (_in("^", q.panel)) {
                        q = (function() {
                            var _Iter = _Iterable(q), _Result = Object.create(null), k;
                            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                                k = _Iter[_Index];
                                _Result[k] = (q[(typeof k === "number" && k < 0) ? q.length + k : k]);
                            }
                            return _Result;
                        })();
                        q.panel = q.panel.rpartition("^")[0];
                    } else if (q.panel === "book_list") {
                        q = Object.create(null);
                    } else {
                        q = (function(){
                            var _d = Object.create(null);
                            _d["panel"] = "book_list";
                            return _d;
                        }).call(this);
                        add_library_info(q);
                    }
                }
                return q;
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["current_query"]},
                __module__ : {value: "book_list.ui"}
            });
            return _anonfunc;
        })();
        _modules["book_list.ui"].panel_handlers = panel_handlers;
        _modules["book_list.ui"].default_panel_handler = default_panel_handler;
        _modules["book_list.ui"].set_panel_handler = set_panel_handler;
        _modules["book_list.ui"].set_default_panel_handler = set_default_panel_handler;
        _modules["book_list.ui"].develop_panel = develop_panel;
        _modules["book_list.ui"].currently_showing_panel = currently_showing_panel;
        _modules["book_list.ui"].add_library_info = add_library_info;
        _modules["book_list.ui"].prepare_query = prepare_query;
        _modules["book_list.ui"].query_as_href = query_as_href;
        _modules["book_list.ui"].show_panel = show_panel;
        _modules["book_list.ui"].apply_url_state = apply_url_state;
    })();

    (function(){
        var __name__ = "book_list.home";
        var CLASS_NAME, recently_read_by_user;
        var E = _modules.elementmaker.E;

        var absolute_path = _modules.ajax.absolute_path;
        var ajax_send = _modules.ajax.ajax_send;
        var ajax = _modules.ajax.ajax;

        var BORDER_RADIUS = _modules["book_list.cover_grid"].BORDER_RADIUS;

        var get_db = _modules["book_list.globals"].get_db;

        var all_libraries = _modules["book_list.library_data"].all_libraries;
        var last_virtual_library_for = _modules["book_list.library_data"].last_virtual_library_for;
        var sync_library_books = _modules["book_list.library_data"].sync_library_books;

        var open_book = _modules["book_list.router"].open_book;
        var update_window_title = _modules["book_list.router"].update_window_title;

        var add_button = _modules["book_list.top_bar"].add_button;
        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var set_default_panel_handler = _modules["book_list.ui"].set_default_panel_handler;
        var show_panel = _modules["book_list.ui"].show_panel;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;
        var set_css = _modules.dom.set_css;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var create_custom_dialog = _modules.modals.create_custom_dialog;

        var get_device_uuid = _modules.session.get_device_uuid;
        var get_interface_data = _modules.session.get_interface_data;

        var conditional_timeout = _modules.utils.conditional_timeout;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var username_key = _modules.utils.username_key;

        var create_button = _modules.widgets.create_button;

        CLASS_NAME = "home-page";
        add_extra_css((function() {
            var _anonfunc = function () {
                var ans, sel;
                ans = "";
                sel = "." + _str.format("{}", CLASS_NAME) + " ";
                ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + " h2"].concat([_desugar_kwargs({padding: "1rem", font_size: "1.5em"})]));
                sel += ".recently-read img";
                ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({max_width: "25vw", max_height: "30vh", height: "auto", border_radius: "" + _str.format("{}", BORDER_RADIUS) + "px"})]));
                ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + ":hover"].concat([_desugar_kwargs({transform: "scale(1.2)"})]));
                ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + ":active"].concat([_desugar_kwargs({transform: "scale(2)"})]));
                return ans;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.home"}
            });
            return _anonfunc;
        })());
        recently_read_by_user = (function(){
            var _d = Object.create(null);
            _d["updated"] = false;
            return _d;
        }).call(this);
        function update_recently_read_by_user(items) {
            if (items) {
                recently_read_by_user.items = items;
            }
            recently_read_by_user.updated = true;
        };
        if (!update_recently_read_by_user.__argnames__) Object.defineProperties(update_recently_read_by_user, {
            __argnames__ : {value: ["items"]},
            __module__ : {value: "book_list.home"}
        });

        function update_book_in_recently_read_by_user_on_home_page(library_id, book_id, book_format, cfi) {
            var item;
            if (recently_read_by_user.items) {
                var _Iter0 = _Iterable(recently_read_by_user.items);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    item = _Iter0[_Index0];
                    if (item.library_id === library_id && item.book_id === book_id && item.format === book_format) {
                        item.cfi = cfi;
                    }
                }
            }
        };
        if (!update_book_in_recently_read_by_user_on_home_page.__argnames__) Object.defineProperties(update_book_in_recently_read_by_user_on_home_page, {
            __argnames__ : {value: ["library_id", "book_id", "book_format", "cfi"]},
            __module__ : {value: "book_list.home"}
        });

        function show_cover(blob, name, mt, book) {
            var img;
            img = document.getElementById(this);
            if (!img) {
                return;
            }
            img.onload = (function() {
                var _anonfunc = function () {
                    window.URL.revokeObjectURL(this.src);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.home"}
                });
                return _anonfunc;
            })();
            img.src = window.URL.createObjectURL(blob);
        };
        if (!show_cover.__argnames__) Object.defineProperties(show_cover, {
            __argnames__ : {value: ["blob", "name", "mt", "book"]},
            __module__ : {value: "book_list.home"}
        });

        function read_book(library_id, book_id, fmt, extra_query) {
            _interpolate_kwargs.call(this, open_book, [book_id, fmt, library_id].concat([_desugar_kwargs({extra_query: extra_query})]));
        };
        if (!read_book.__argnames__) Object.defineProperties(read_book, {
            __argnames__ : {value: ["library_id", "book_id", "fmt", "extra_query"]},
            __module__ : {value: "book_list.home"}
        });

        function view_book_page(library_id, book_id) {
            _interpolate_kwargs.call(this, show_panel, ["book_details", (function(){
                var _d = Object.create(null);
                _d["library_id"] = library_id;
                _d["book_id"] = book_id + "";
                return _d;
            }).call(this)].concat([_desugar_kwargs({replace: false})]));
        };
        if (!view_book_page.__argnames__) Object.defineProperties(view_book_page, {
            __argnames__ : {value: ["library_id", "book_id"]},
            __module__ : {value: "book_list.home"}
        });

        function get_last_read_position(last_read_positions, prev_last_read) {
            var prev_epoch, dev, newest_epoch, ans, data;
            prev_epoch = prev_last_read.getTime();
            dev = get_device_uuid();
            newest_epoch = ans = null;
            var _Iter1 = _Iterable(last_read_positions);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                data = _Iter1[_Index1];
                if (data.device !== dev && data.epoch > prev_epoch) {
                    if (ans === null || data.epoch > newest_epoch) {
                        newest_epoch = data.epoch;
                        ans = data;
                    }
                }
            }
            return ans;
        };
        if (!get_last_read_position.__argnames__) Object.defineProperties(get_last_read_position, {
            __argnames__ : {value: ["last_read_positions", "prev_last_read"]},
            __module__ : {value: "book_list.home"}
        });

        function sync_data_received(library_id, lrmap, load_type, xhr, ev) {
            var data, db, new_vals, entry, prev_last_read, last_read_positions, new_last_read, last_read, cfi, new_amap, is_empty, _unpack, book_id, fmt, key;
            if (load_type !== "load") {
                print("Failed to get book sync data");
                return;
            }
            data = JSON.parse(xhr.responseText);
            db = get_db();
            var _Iter2 = _Iterable(data);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                key = _Iter2[_Index2];
                new_vals = data[(typeof key === "number" && key < 0) ? data.length + key : key];
                entry = (function(){
                    var _d = Object.create(null);
                    _d["last_read"] = null;
                    _d["last_read_position"] = null;
                    _d["annotations_map"] = null;
                    return _d;
                }).call(this);
                prev_last_read = lrmap[(typeof key === "number" && key < 0) ? lrmap.length + key : key];
                if (prev_last_read) {
                    last_read_positions = new_vals.last_read_positions;
                    new_last_read = get_last_read_position(last_read_positions, prev_last_read);
                    if (new_last_read) {
                        last_read = new Date(new_last_read.epoch * 1e3);
                        cfi = new_last_read.cfi;
                        if (cfi) {
                            entry.last_read = last_read;
                            entry.last_read_position = cfi;
                        }
                    }
                }
                new_amap = new_vals.annotations_map || Object.create(null);
                is_empty = true;
                for(var ikey in new_amap) { is_empty = false; break; };
                if (!is_empty) {
                    entry.annotations_map = new_amap;
                }
                if (entry.last_read_position || entry.annotations_map) {
                    _unpack = _eslice(key.partition(":"), 2);
_unpack = _unpack_asarray(2, _unpack);
                    book_id = _unpack[0];
                    fmt = _unpack[1];
                    db.update_annotations_data_from_key(library_id, int(book_id), fmt, entry);
                }
            }
        };
        if (!sync_data_received.__argnames__) Object.defineProperties(sync_data_received, {
            __argnames__ : {value: ["library_id", "lrmap", "load_type", "xhr", "ev"]},
            __module__ : {value: "book_list.home"}
        });

        function start_sync(to_sync) {
            var libraries, library_id, _unpack, key, last_read, lid;
            libraries = Object.create(null);
            var _Iter3 = _Iterable(to_sync);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                _unpack = _Iter3[_Index3];
                key = _unpack[0];
                last_read = _unpack[1];
                library_id = key[0];
                if (!libraries[(typeof library_id === "number" && library_id < 0) ? libraries.length + library_id : library_id]) {
                    libraries[(typeof library_id === "number" && library_id < 0) ? libraries.length + library_id : library_id] = [];
                }
                libraries[(typeof library_id === "number" && library_id < 0) ? libraries.length + library_id : library_id].push([key, last_read]);
            }
            var _Iter4 = _Iterable(libraries);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                lid = _Iter4[_Index4];
                sync_library_books(lid, libraries[(typeof lid === "number" && lid < 0) ? libraries.length + lid : lid], sync_data_received);
            }
        };
        if (!start_sync.__argnames__) Object.defineProperties(start_sync, {
            __argnames__ : {value: ["to_sync"]},
            __module__ : {value: "book_list.home"}
        });

        function prepare_recent_container(container) {
            var cover_container;
            container.style.display = "block";
            container.style.borderBottom = "solid 1px currentColor";
            container.style.paddingBottom = "1em";
            container.appendChild(E.h2(_("Continue reading")));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:flex"})]));
            cover_container = container.lastChild;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Browse all downloaded books")].concat([_desugar_kwargs({action: (function() {
                var _anonfunc = function () {
                    show_panel("local_books");
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.home"}
                });
                return _anonfunc;
            })()})]))].concat([_desugar_kwargs({style: "margin: 1rem 1rem"})])));
            return cover_container;
        };
        if (!prepare_recent_container.__argnames__) Object.defineProperties(prepare_recent_container, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.home"}
        });

        function show_recent_for_user(container_id) {
            var container, images, q, rb, img, item;
            container = document.getElementById(container_id);
            images = prepare_recent_container(container);
            var _Iter5 = _Iterable(recently_read_by_user.items.slice(0, 3));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                item = _Iter5[_Index5];
                q = Object.create(null);
                if (item.cfi) {
                    q.bookpos = item.cfi;
                }
                rb = read_book.bind(null, item.library_id, item.book_id, item.format, q);
                img = _interpolate_kwargs.call(E, E.img, [_desugar_kwargs({alt: item.tooltip, src: absolute_path("get/cover/" + _str.format("{}", item.book_id) + "/" + _str.format("{}", item.library_id) + "")})]);
                images.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [img].concat([_desugar_kwargs({title: item.tooltip, href: "javascript:void(0)", onclick: rb})]))].concat([_desugar_kwargs({style: "margin: 0 1em"})])));
                img.onerror = (function() {
                    var _anonfunc = function (err) {
                        var failed;
                        failed = err.target;
                        failed.parentNode.parentNode.style.display = "none";
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["err"]},
                        __module__ : {value: "book_list.home"}
                    });
                    return _anonfunc;
                })();
            }
        };
        if (!show_recent_for_user.__argnames__) Object.defineProperties(show_recent_for_user, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.home"}
        });

        function show_recent_stage2(books) {
            var container, images, db, to_sync, username, lr, authors, img, img_id, book;
            container = document.getElementById(this);
            if (!container || !books.length) {
                return;
            }
            images = prepare_recent_container(container);
            db = get_db();
            to_sync = [];
            username = get_interface_data().username;
            var _Iter6 = _Iterable(books);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                book = _Iter6[_Index6];
                if (to_sync.length < 10) {
                    lr = (_expr_temp = book.last_read)[_bound_index(username_key(username), _expr_temp)] || new Date(0);
                    to_sync.push([book.key, lr]);
                }
                authors = (book.metadata.authors) ? book.metadata.authors.join(" & ") : _("Unknown");
                img = _interpolate_kwargs.call(E, E.img, [_desugar_kwargs({alt: _("{} by {}").format(book.metadata.title, authors)})]);
                img_id = ensure_id(img);
                images.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [img].concat([_desugar_kwargs({href: "javascript: void(0)", title: img.alt, onclick: read_book.bind(null, book.key[0], book.key[1], book.key[2], null)})]))].concat([_desugar_kwargs({style: "margin: 0 1em"})])));
                if (book.cover_name) {
                    db.get_file(book, book.cover_name, show_cover.bind(img_id));
                }
            }
            start_sync(to_sync);
        };
        if (!show_recent_stage2.__argnames__) Object.defineProperties(show_recent_stage2, {
            __argnames__ : {value: ["books"]},
            __module__ : {value: "book_list.home"}
        });

        function show_recent_for_user_if_fetched() {
            var container;
            container = this;
            if (!recently_read_by_user.updated) {
                return conditional_timeout(container.id, 5, show_recent_for_user_if_fetched);
            }
            if (recently_read_by_user.items && recently_read_by_user.items.length > 0) {
                return show_recent_for_user(container.id);
            }
            return show_recent.call(container);
        };
        if (!show_recent_for_user_if_fetched.__module__) Object.defineProperties(show_recent_for_user_if_fetched, {
            __module__ : {value: "book_list.home"}
        });

        function show_recent() {
            var container, db;
            container = this;
            db = get_db();
            if (!db.initialized) {
                conditional_timeout(container.id, 5, show_recent);
                return;
            }
            if (db.is_ok) {
                db.get_recently_read_books(show_recent_stage2.bind(container.id));
            } else {
                print(db.initialize_error_msg);
            }
        };
        if (!show_recent.__module__) Object.defineProperties(show_recent, {
            __module__ : {value: "book_list.home"}
        });

        function newly_added_received(newly_container_id, end_type, xhr, ev) {
            var container, data, images, authors, alt, img, book_id;
            container = document.getElementById(newly_container_id);
            if (!container || end_type !== "load") {
                return;
            }
            data = JSON.parse(xhr.responseText);
            if (!data.books || !data.books.length) {
                return;
            }
            container.style.display = "block";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:flex"})]));
            images = container.lastChild;
            var _Iter7 = _Iterable(data.books);
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                book_id = _Iter7[_Index7];
                authors = (_expr_temp = data.authors)[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id].join(" & ");
                alt = _("{} by {}").format((_expr_temp = data.titles)[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id], authors);
                img = _interpolate_kwargs.call(E, E.img, [_desugar_kwargs({alt: alt, src: absolute_path("get/cover/" + _str.format("{}", book_id) + "/" + _str.format("{}", data.library_id) + "")})]);
                images.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [img].concat([_desugar_kwargs({href: "javascript: void(0)", title: img.alt, onclick: view_book_page.bind(null, data.library_id, book_id)})]))].concat([_desugar_kwargs({style: "margin: 0 1em"})])));
            }
        };
        if (!newly_added_received.__argnames__) Object.defineProperties(newly_added_received, {
            __argnames__ : {value: ["newly_container_id", "end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.home"}
        });

        function change_password() {
            var interface_data;
            interface_data = get_interface_data();
            create_custom_dialog(_("Change password for: {}").format(interface_data.username), (function() {
                var _anonfunc = function (parent, close_modal) {
                    var ids;
                    ids = [unique_id(), unique_id(), unique_id()];
                    parent.appendChild(E.table(E.tr(E.td(_interpolate_kwargs.call(E, E.label, [_("Current password:") + ""].concat([_desugar_kwargs({for_: ids[0]})]))), _interpolate_kwargs.call(this, set_css, [_interpolate_kwargs.call(E, E.td, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "password"})])].concat([_desugar_kwargs({id: ids[0]})]))].concat([_desugar_kwargs({padding_bottom: "1.5ex"})]))), E.tr(E.td(_interpolate_kwargs.call(E, E.label, [_("New password:") + ""].concat([_desugar_kwargs({for_: ids[1]})]))), _interpolate_kwargs.call(this, set_css, [_interpolate_kwargs.call(E, E.td, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "password"})])].concat([_desugar_kwargs({id: ids[1]})]))].concat([_desugar_kwargs({padding_bottom: "1.5ex"})]))), E.tr(E.td(_interpolate_kwargs.call(E, E.label, [_("New password again:") + ""].concat([_desugar_kwargs({for_: ids[2]})]))), _interpolate_kwargs.call(this, set_css, [_interpolate_kwargs.call(E, E.td, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "password"})])].concat([_desugar_kwargs({id: ids[2]})]))].concat([_desugar_kwargs({padding_bottom: "1.5ex"})])))));
                    parent.appendChild(E.div());
                    function show_msg(html, is_info) {
                        var msg;
                        msg = parent.firstChild.nextSibling;
                        safe_set_inner_html(msg, html);
                        msg.style.color = (!is_info) ? "red" : "currentColor";
                    };
                    if (!show_msg.__argnames__) Object.defineProperties(show_msg, {
                        __argnames__ : {value: ["html", "is_info"]},
                        __module__ : {value: "book_list.home"}
                    });

                    function on_complete(end_type, xhr, ev) {
                        if (end_type === "load") {
                            clear(parent);
                            parent.appendChild(E.div(_("Password successfully changed, you will be asked for the new password the next time the browser has to contact the calibre server.")));
                            parent.appendChild(_interpolate_kwargs.call(E, E.div, [create_button(_("OK"), null, close_modal)].concat([_desugar_kwargs({class_: "button-box"})])));
                            return;
                        }
                        show_msg(_("Failed to change password, with error: {}").format(xhr.error_html));
                    };
                    if (!on_complete.__argnames__) Object.defineProperties(on_complete, {
                        __argnames__ : {value: ["end_type", "xhr", "ev"]},
                        __module__ : {value: "book_list.home"}
                    });

                    function ok() {
                        var pws, _unpack, oldpw, pw1, pw2;
                        pws = parent.firstChild.getElementsByTagName("input");
                        _unpack = [pws[0].value, pws[1].value, pws[2].value];
                        oldpw = _unpack[0];
                        pw1 = _unpack[1];
                        pw2 = _unpack[2];
                        if (pw1 !== pw2) {
                            show_msg(_("The two new passwords do not match"));
                            return;
                        }
                        if (!pw1 || !oldpw) {
                            show_msg(_("Empty passwords are not allowed"));
                            return;
                        }
                        ajax_send("users/change-pw", (function(){
                            var _d = Object.create(null);
                            _d["oldpw"] = oldpw;
                            _d["newpw"] = pw1;
                            return _d;
                        }).call(this), on_complete);
                        show_msg(_("Contacting server, please wait..."), true);
                        parent.lastChild.display = "none";
                    };
                    if (!ok.__module__) Object.defineProperties(ok, {
                        __module__ : {value: "book_list.home"}
                    });

                    parent.appendChild(_interpolate_kwargs.call(E, E.div, [create_button(_("OK"), null, ok), "", create_button(_("Cancel"), null, close_modal)].concat([_desugar_kwargs({class_: "button-box"})])));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.home"}
                });
                return _anonfunc;
            })());
        };
        if (!change_password.__module__) Object.defineProperties(change_password, {
            __module__ : {value: "book_list.home"}
        });

        function show_user_details() {
            var interface_data;
            interface_data = get_interface_data();
            create_custom_dialog(_("Logged in as {}").format(interface_data.username), (function() {
                var _anonfunc = function (parent, close_modal) {
                    var msg;
                    msg = E.div();
                    safe_set_inner_html(msg, _("You are logged in as the user <b>{}</b>. To log in as a different user, you will have to restart the browser.").format(interface_data.username));
                    parent.appendChild(msg);
                    parent.appendChild(_interpolate_kwargs.call(E, E.div, [create_button(_("Change password"), null, (function() {
                        var _anonfunc = function () {
                            setTimeout(change_password, 0);
                            close_modal();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "book_list.home"}
                        });
                        return _anonfunc;
                    })()), "", create_button(_("Close"), null, close_modal)].concat([_desugar_kwargs({class_: "button-box"})])));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.home"}
                });
                return _anonfunc;
            })());
        };
        if (!show_user_details.__module__) Object.defineProperties(show_user_details, {
            __module__ : {value: "book_list.home"}
        });

        function init(container_id) {
            var container, interface_data, recent, recent_container_id, cl, library_name, _unpack, library_id, newly, newly_container_id;
            update_window_title();
            container = document.getElementById(container_id);
            container.classList.add(CLASS_NAME);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({run_animation: true})]));
            interface_data = get_interface_data();
            if (interface_data.username) {
                add_button(container, "user", show_user_details, _("Logged in as {}").format(interface_data.username));
            }
            recent = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:none", class_: "recently-read"})]);
            recent_container_id = ensure_id(recent);
            container.appendChild(recent);
            if (interface_data.username) {
                conditional_timeout(recent_container_id, 5, show_recent_for_user_if_fetched);
            } else {
                conditional_timeout(recent_container_id, 5, show_recent);
            }
            container.appendChild(E.h2(_("Choose the calibre library to browse")));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display: flex; flex-wrap: wrap"})]));
            cl = container.lastChild;
            var _Iter8 = _Iterable(all_libraries());
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                _unpack = _Iter8[_Index8];
                library_id = _unpack[0];
                library_name = _unpack[1];
                library_name = (_expr_temp = interface_data.library_map)[(typeof library_id === "number" && library_id < 0) ? _expr_temp.length + library_id : library_id];
                if (library_name) {
                    cl.appendChild(_interpolate_kwargs.call(this, create_button, [library_name].concat([_desugar_kwargs({icon: "library", action: (function() {
                        var _anonfunc = function (ev) {
                            var lib_id, q, vlid;
                            lib_id = ev.currentTarget.dataset.lid;
                            q = (function(){
                                var _d = Object.create(null);
                                _d["library_id"] = lib_id;
                                return _d;
                            }).call(this);
                            vlid = last_virtual_library_for(lib_id);
                            if (vlid) {
                                q.vl = vlid;
                            }
                            show_panel("book_list", q);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["ev"]},
                            __module__ : {value: "book_list.home"}
                        });
                        return _anonfunc;
                    })()})])));
                    cl.lastChild.style.margin = "1ex 1rem";
                    cl.lastChild.dataset.lid = library_id;
                }
            }
            newly = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "border-top: solid 1px currentColor; padding-top: 1em; display: none", class_: "recently-read"})]);
            newly.appendChild(E.h2(_("Newly added")));
            newly_container_id = ensure_id(newly);
            container.appendChild(newly);
            ajax("interface-data/newly-added", newly_added_received.bind(null, newly_container_id)).send();
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.home"}
        });

        set_default_panel_handler(init);
        _modules["book_list.home"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.home"].recently_read_by_user = recently_read_by_user;
        _modules["book_list.home"].update_recently_read_by_user = update_recently_read_by_user;
        _modules["book_list.home"].update_book_in_recently_read_by_user_on_home_page = update_book_in_recently_read_by_user_on_home_page;
        _modules["book_list.home"].show_cover = show_cover;
        _modules["book_list.home"].read_book = read_book;
        _modules["book_list.home"].view_book_page = view_book_page;
        _modules["book_list.home"].get_last_read_position = get_last_read_position;
        _modules["book_list.home"].sync_data_received = sync_data_received;
        _modules["book_list.home"].start_sync = start_sync;
        _modules["book_list.home"].prepare_recent_container = prepare_recent_container;
        _modules["book_list.home"].show_recent_for_user = show_recent_for_user;
        _modules["book_list.home"].show_recent_stage2 = show_recent_stage2;
        _modules["book_list.home"].show_recent_for_user_if_fetched = show_recent_for_user_if_fetched;
        _modules["book_list.home"].show_recent = show_recent;
        _modules["book_list.home"].newly_added_received = newly_added_received;
        _modules["book_list.home"].change_password = change_password;
        _modules["book_list.home"].show_user_details = show_user_details;
        _modules["book_list.home"].init = init;
    })();

    (function(){
        var __name__ = "read_book";

    })();

    (function(){
        var __name__ = "aes";
        var string_to_bytes, bytes_to_string, number_of_rounds, rcon, S, Si, T1, T2, T3, T4, T5, T6, T7, T8, U1, U2, U3, U4, random_bytes, noderandom;
        function string_to_bytes_encoder(string) {
            return new TextEncoder("utf-8").encode(string + "");
        };
        if (!string_to_bytes_encoder.__argnames__) Object.defineProperties(string_to_bytes_encoder, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "aes"}
        });

        function string_to_bytes_slow(string) {
            var escstr, binstr, ua, _unpack, i, ch;
            escstr = encodeURIComponent(string);
            binstr = escstr.replace(/%([0-9A-F]{2})/g, (function() {
                var _anonfunc = function (match, p1) {
                    return String.fromCharCode("0x" + p1);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["match", "p1"]},
                    __module__ : {value: "aes"}
                });
                return _anonfunc;
            })());
            ua = new Uint8Array(binstr.length);
            var _Iter0 = _Iterable(enumerate(binstr));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                _unpack = _Iter0[_Index0];
                i = _unpack[0];
                ch = _unpack[1];
                ua[(typeof i === "number" && i < 0) ? ua.length + i : i] = ch.charCodeAt(0);
            }
            return ua;
        };
        if (!string_to_bytes_slow.__argnames__) Object.defineProperties(string_to_bytes_slow, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "aes"}
        });

        function as_hex() {
            var array = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var sep = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? as_hex.__defaults__.sep : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "sep")){
                sep = _kwargs_obj.sep;
            }
            var num, fmt;
            num = array.BYTES_PER_ELEMENT || 1;
            fmt = "{:0" + num * 2 + "x}";
            return (function() {
                var _Iter = _Iterable(array), _Result = [], x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    _Result.push(str.format(fmt, x));
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })().join(sep);
        };
        if (!as_hex.__defaults__) Object.defineProperties(as_hex, {
            __defaults__ : {value: {sep:""}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["array", "sep"]},
            __module__ : {value: "aes"}
        });

        function bytes_to_string_decoder(bytes, offset) {
            offset = offset || 0;
            if (offset) {
                bytes = bytes.subarray(offset);
            }
            return new TextDecoder("utf-8").decode(bytes);
        };
        if (!bytes_to_string_decoder.__argnames__) Object.defineProperties(bytes_to_string_decoder, {
            __argnames__ : {value: ["bytes", "offset"]},
            __module__ : {value: "aes"}
        });

        function bytes_to_string_slow(bytes, offset) {
            var ans, i, c;
            ans = [];
            i = offset || 0;
            while (i < bytes.length) {
                c = bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i];
                if (c < 128) {
                    ans.push(String.fromCharCode(c));
                    i += 1;
                } else if (191 < c && c < 224) {
                    ans.push(String.fromCharCode((c & 31) << 6 | bytes[_bound_index(i + 1, bytes)] & 63));
                    i += 2;
                } else {
                    ans.push(String.fromCharCode((c & 15) << 12 | (bytes[_bound_index(i + 1, bytes)] & 63) << 6 | bytes[_bound_index(i + 2, bytes)] & 63));
                    i += 3;
                }
            }
            return ans.join("");
        };
        if (!bytes_to_string_slow.__argnames__) Object.defineProperties(bytes_to_string_slow, {
            __argnames__ : {value: ["bytes", "offset"]},
            __module__ : {value: "aes"}
        });

        string_to_bytes = (typeof TextEncoder === "function") ? string_to_bytes_encoder : string_to_bytes_slow;
        bytes_to_string = (typeof TextDecoder === "function") ? bytes_to_string_decoder : bytes_to_string_slow;
        function increment_counter(c) {
            for (var i = 15; i >= 12; i--) {
                if (c[(typeof i === "number" && i < 0) ? c.length + i : i] === 255) {
                    c[(typeof i === "number" && i < 0) ? c.length + i : i] = 0;
                } else {
                    c[(typeof i === "number" && i < 0) ? c.length + i : i] += 1;
                    break;
                }
            }
        };
        if (!increment_counter.__argnames__) Object.defineProperties(increment_counter, {
            __argnames__ : {value: ["c"]},
            __module__ : {value: "aes"}
        });

        function convert_to_int32(bytes, output, offset, length) {
            offset = offset || 0;
            length = length || bytes.length;
            for (var i = offset, j = 0; i < offset + length; i += 4, j++) {
                output[(typeof j === "number" && j < 0) ? output.length + j : j] = bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i] << 24 | bytes[_bound_index(i + 1, bytes)] << 16 | bytes[_bound_index(i + 2, bytes)] << 8 | bytes[_bound_index(i + 3, bytes)];
            }
        };
        if (!convert_to_int32.__argnames__) Object.defineProperties(convert_to_int32, {
            __argnames__ : {value: ["bytes", "output", "offset", "length"]},
            __module__ : {value: "aes"}
        });

        function convert_to_int32_pad(bytes) {
            var extra, t, ans;
            extra = bytes.length % 4;
            if (extra) {
                t = new Uint8Array(bytes.length + 4 - extra);
                t.set(bytes);
                bytes = t;
            }
            ans = new Uint32Array(bytes.length / 4);
            convert_to_int32(bytes, ans);
            return ans;
        };
        if (!convert_to_int32_pad.__argnames__) Object.defineProperties(convert_to_int32_pad, {
            __argnames__ : {value: ["bytes"]},
            __module__ : {value: "aes"}
        });

        if (!Uint8Array.prototype.fill) {
            Uint8Array.prototype.fill = Uint32Array.prototype.fill = (function() {
                var _anonfunc = function (val, start, end) {
                    start = start || 0;
                    if (end === undefined) {
                        end = this.length;
                    }
                    if (start < 0) {
                        start += this.length;
                    }
                    if (end < 0) {
                        end += this.length;
                    }
                    for (var i = start; i < end; i++) {
                        (_expr_temp = this)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] = val;
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["val", "start", "end"]},
                    __module__ : {value: "aes"}
                });
                return _anonfunc;
            })();
        }
        function from_64_to_32(num) {
            var ans;
            ans = new Uint32Array(2);
            ans[0] = num / 4294967296 | 0;
            ans[1] = num & 4294967295;
            return ans;
        };
        if (!from_64_to_32.__argnames__) Object.defineProperties(from_64_to_32, {
            __argnames__ : {value: ["num"]},
            __module__ : {value: "aes"}
        });

        number_of_rounds = (function(){
            var _d = {};
            _d[16] = 10;
            _d[24] = 12;
            _d[32] = 14;
            return _d;
        }).call(this);
        rcon = new Uint32Array([0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1b, 0x36, 0x6c, 0xd8, 0xab, 0x4d, 0x9a, 0x2f, 0x5e, 0xbc, 0x63, 0xc6, 0x97, 0x35, 0x6a, 0xd4, 0xb3, 0x7d, 0xfa, 0xef, 0xc5, 0x91]);
        S = new Uint32Array([0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76, 0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0, 0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15, 0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75, 0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84, 0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf, 0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8, 0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2, 0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73, 0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb, 0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79, 0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08, 0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a, 0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e, 0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf, 0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16]);
        Si = new Uint32Array([0x52, 0x09, 0x6a, 0xd5, 0x30, 0x36, 0xa5, 0x38, 0xbf, 0x40, 0xa3, 0x9e, 0x81, 0xf3, 0xd7, 0xfb, 0x7c, 0xe3, 0x39, 0x82, 0x9b, 0x2f, 0xff, 0x87, 0x34, 0x8e, 0x43, 0x44, 0xc4, 0xde, 0xe9, 0xcb, 0x54, 0x7b, 0x94, 0x32, 0xa6, 0xc2, 0x23, 0x3d, 0xee, 0x4c, 0x95, 0x0b, 0x42, 0xfa, 0xc3, 0x4e, 0x08, 0x2e, 0xa1, 0x66, 0x28, 0xd9, 0x24, 0xb2, 0x76, 0x5b, 0xa2, 0x49, 0x6d, 0x8b, 0xd1, 0x25, 0x72, 0xf8, 0xf6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xd4, 0xa4, 0x5c, 0xcc, 0x5d, 0x65, 0xb6, 0x92, 0x6c, 0x70, 0x48, 0x50, 0xfd, 0xed, 0xb9, 0xda, 0x5e, 0x15, 0x46, 0x57, 0xa7, 0x8d, 0x9d, 0x84, 0x90, 0xd8, 0xab, 0x00, 0x8c, 0xbc, 0xd3, 0x0a, 0xf7, 0xe4, 0x58, 0x05, 0xb8, 0xb3, 0x45, 0x06, 0xd0, 0x2c, 0x1e, 0x8f, 0xca, 0x3f, 0x0f, 0x02, 0xc1, 0xaf, 0xbd, 0x03, 0x01, 0x13, 0x8a, 0x6b, 0x3a, 0x91, 0x11, 0x41, 0x4f, 0x67, 0xdc, 0xea, 0x97, 0xf2, 0xcf, 0xce, 0xf0, 0xb4, 0xe6, 0x73, 0x96, 0xac, 0x74, 0x22, 0xe7, 0xad, 0x35, 0x85, 0xe2, 0xf9, 0x37, 0xe8, 0x1c, 0x75, 0xdf, 0x6e, 0x47, 0xf1, 0x1a, 0x71, 0x1d, 0x29, 0xc5, 0x89, 0x6f, 0xb7, 0x62, 0x0e, 0xaa, 0x18, 0xbe, 0x1b, 0xfc, 0x56, 0x3e, 0x4b, 0xc6, 0xd2, 0x79, 0x20, 0x9a, 0xdb, 0xc0, 0xfe, 0x78, 0xcd, 0x5a, 0xf4, 0x1f, 0xdd, 0xa8, 0x33, 0x88, 0x07, 0xc7, 0x31, 0xb1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xec, 0x5f, 0x60, 0x51, 0x7f, 0xa9, 0x19, 0xb5, 0x4a, 0x0d, 0x2d, 0xe5, 0x7a, 0x9f, 0x93, 0xc9, 0x9c, 0xef, 0xa0, 0xe0, 0x3b, 0x4d, 0xae, 0x2a, 0xf5, 0xb0, 0xc8, 0xeb, 0xbb, 0x3c, 0x83, 0x53, 0x99, 0x61, 0x17, 0x2b, 0x04, 0x7e, 0xba, 0x77, 0xd6, 0x26, 0xe1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0c, 0x7d]);
        T1 = new Uint32Array([0xc66363a5, 0xf87c7c84, 0xee777799, 0xf67b7b8d, 0xfff2f20d, 0xd66b6bbd, 0xde6f6fb1, 0x91c5c554, 0x60303050, 0x02010103, 0xce6767a9, 0x562b2b7d, 0xe7fefe19, 0xb5d7d762, 0x4dababe6, 0xec76769a, 0x8fcaca45, 0x1f82829d, 0x89c9c940, 0xfa7d7d87, 0xeffafa15, 0xb25959eb, 0x8e4747c9, 0xfbf0f00b, 0x41adadec, 0xb3d4d467, 0x5fa2a2fd, 0x45afafea, 0x239c9cbf, 0x53a4a4f7, 0xe4727296, 0x9bc0c05b, 0x75b7b7c2, 0xe1fdfd1c, 0x3d9393ae, 0x4c26266a, 0x6c36365a, 0x7e3f3f41, 0xf5f7f702, 0x83cccc4f, 0x6834345c, 0x51a5a5f4, 0xd1e5e534, 0xf9f1f108, 0xe2717193, 0xabd8d873, 0x62313153, 0x2a15153f, 0x0804040c, 0x95c7c752, 0x46232365, 0x9dc3c35e, 0x30181828, 0x379696a1, 0x0a05050f, 0x2f9a9ab5, 0x0e070709, 0x24121236, 0x1b80809b, 0xdfe2e23d, 0xcdebeb26, 0x4e272769, 0x7fb2b2cd, 0xea75759f, 0x1209091b, 0x1d83839e, 0x582c2c74, 0x341a1a2e, 0x361b1b2d, 0xdc6e6eb2, 0xb45a5aee, 0x5ba0a0fb, 0xa45252f6, 0x763b3b4d, 0xb7d6d661, 0x7db3b3ce, 0x5229297b, 0xdde3e33e, 0x5e2f2f71, 0x13848497, 0xa65353f5, 0xb9d1d168, 0x00000000, 0xc1eded2c, 0x40202060, 0xe3fcfc1f, 0x79b1b1c8, 0xb65b5bed, 0xd46a6abe, 0x8dcbcb46, 0x67bebed9, 0x7239394b, 0x944a4ade, 0x984c4cd4, 0xb05858e8, 0x85cfcf4a, 0xbbd0d06b, 0xc5efef2a, 0x4faaaae5, 0xedfbfb16, 0x864343c5, 0x9a4d4dd7, 0x66333355, 0x11858594, 0x8a4545cf, 0xe9f9f910, 0x04020206, 0xfe7f7f81, 0xa05050f0, 0x783c3c44, 0x259f9fba, 0x4ba8a8e3, 0xa25151f3, 0x5da3a3fe, 0x804040c0, 0x058f8f8a, 0x3f9292ad, 0x219d9dbc, 0x70383848, 0xf1f5f504, 0x63bcbcdf, 0x77b6b6c1, 0xafdada75, 0x42212163, 0x20101030, 0xe5ffff1a, 0xfdf3f30e, 0xbfd2d26d, 0x81cdcd4c, 0x180c0c14, 0x26131335, 0xc3ecec2f, 0xbe5f5fe1, 0x359797a2, 0x884444cc, 0x2e171739, 0x93c4c457, 0x55a7a7f2, 0xfc7e7e82, 0x7a3d3d47, 0xc86464ac, 0xba5d5de7, 0x3219192b, 0xe6737395, 0xc06060a0, 0x19818198, 0x9e4f4fd1, 0xa3dcdc7f, 0x44222266, 0x542a2a7e, 0x3b9090ab, 0x0b888883, 0x8c4646ca, 0xc7eeee29, 0x6bb8b8d3, 0x2814143c, 0xa7dede79, 0xbc5e5ee2, 0x160b0b1d, 0xaddbdb76, 0xdbe0e03b, 0x64323256, 0x743a3a4e, 0x140a0a1e, 0x924949db, 0x0c06060a, 0x4824246c, 0xb85c5ce4, 0x9fc2c25d, 0xbdd3d36e, 0x43acacef, 0xc46262a6, 0x399191a8, 0x319595a4, 0xd3e4e437, 0xf279798b, 0xd5e7e732, 0x8bc8c843, 0x6e373759, 0xda6d6db7, 0x018d8d8c, 0xb1d5d564, 0x9c4e4ed2, 0x49a9a9e0, 0xd86c6cb4, 0xac5656fa, 0xf3f4f407, 0xcfeaea25, 0xca6565af, 0xf47a7a8e, 0x47aeaee9, 0x10080818, 0x6fbabad5, 0xf0787888, 0x4a25256f, 0x5c2e2e72, 0x381c1c24, 0x57a6a6f1, 0x73b4b4c7, 0x97c6c651, 0xcbe8e823, 0xa1dddd7c, 0xe874749c, 0x3e1f1f21, 0x964b4bdd, 0x61bdbddc, 0x0d8b8b86, 0x0f8a8a85, 0xe0707090, 0x7c3e3e42, 0x71b5b5c4, 0xcc6666aa, 0x904848d8, 0x06030305, 0xf7f6f601, 0x1c0e0e12, 0xc26161a3, 0x6a35355f, 0xae5757f9, 0x69b9b9d0, 0x17868691, 0x99c1c158, 0x3a1d1d27, 0x279e9eb9, 0xd9e1e138, 0xebf8f813, 0x2b9898b3, 0x22111133, 0xd26969bb, 0xa9d9d970, 0x078e8e89, 0x339494a7, 0x2d9b9bb6, 0x3c1e1e22, 0x15878792, 0xc9e9e920, 0x87cece49, 0xaa5555ff, 0x50282878, 0xa5dfdf7a, 0x038c8c8f, 0x59a1a1f8, 0x09898980, 0x1a0d0d17, 0x65bfbfda, 0xd7e6e631, 0x844242c6, 0xd06868b8, 0x824141c3, 0x299999b0, 0x5a2d2d77, 0x1e0f0f11, 0x7bb0b0cb, 0xa85454fc, 0x6dbbbbd6, 0x2c16163a]);
        T2 = new Uint32Array([0xa5c66363, 0x84f87c7c, 0x99ee7777, 0x8df67b7b, 0x0dfff2f2, 0xbdd66b6b, 0xb1de6f6f, 0x5491c5c5, 0x50603030, 0x03020101, 0xa9ce6767, 0x7d562b2b, 0x19e7fefe, 0x62b5d7d7, 0xe64dabab, 0x9aec7676, 0x458fcaca, 0x9d1f8282, 0x4089c9c9, 0x87fa7d7d, 0x15effafa, 0xebb25959, 0xc98e4747, 0x0bfbf0f0, 0xec41adad, 0x67b3d4d4, 0xfd5fa2a2, 0xea45afaf, 0xbf239c9c, 0xf753a4a4, 0x96e47272, 0x5b9bc0c0, 0xc275b7b7, 0x1ce1fdfd, 0xae3d9393, 0x6a4c2626, 0x5a6c3636, 0x417e3f3f, 0x02f5f7f7, 0x4f83cccc, 0x5c683434, 0xf451a5a5, 0x34d1e5e5, 0x08f9f1f1, 0x93e27171, 0x73abd8d8, 0x53623131, 0x3f2a1515, 0x0c080404, 0x5295c7c7, 0x65462323, 0x5e9dc3c3, 0x28301818, 0xa1379696, 0x0f0a0505, 0xb52f9a9a, 0x090e0707, 0x36241212, 0x9b1b8080, 0x3ddfe2e2, 0x26cdebeb, 0x694e2727, 0xcd7fb2b2, 0x9fea7575, 0x1b120909, 0x9e1d8383, 0x74582c2c, 0x2e341a1a, 0x2d361b1b, 0xb2dc6e6e, 0xeeb45a5a, 0xfb5ba0a0, 0xf6a45252, 0x4d763b3b, 0x61b7d6d6, 0xce7db3b3, 0x7b522929, 0x3edde3e3, 0x715e2f2f, 0x97138484, 0xf5a65353, 0x68b9d1d1, 0x00000000, 0x2cc1eded, 0x60402020, 0x1fe3fcfc, 0xc879b1b1, 0xedb65b5b, 0xbed46a6a, 0x468dcbcb, 0xd967bebe, 0x4b723939, 0xde944a4a, 0xd4984c4c, 0xe8b05858, 0x4a85cfcf, 0x6bbbd0d0, 0x2ac5efef, 0xe54faaaa, 0x16edfbfb, 0xc5864343, 0xd79a4d4d, 0x55663333, 0x94118585, 0xcf8a4545, 0x10e9f9f9, 0x06040202, 0x81fe7f7f, 0xf0a05050, 0x44783c3c, 0xba259f9f, 0xe34ba8a8, 0xf3a25151, 0xfe5da3a3, 0xc0804040, 0x8a058f8f, 0xad3f9292, 0xbc219d9d, 0x48703838, 0x04f1f5f5, 0xdf63bcbc, 0xc177b6b6, 0x75afdada, 0x63422121, 0x30201010, 0x1ae5ffff, 0x0efdf3f3, 0x6dbfd2d2, 0x4c81cdcd, 0x14180c0c, 0x35261313, 0x2fc3ecec, 0xe1be5f5f, 0xa2359797, 0xcc884444, 0x392e1717, 0x5793c4c4, 0xf255a7a7, 0x82fc7e7e, 0x477a3d3d, 0xacc86464, 0xe7ba5d5d, 0x2b321919, 0x95e67373, 0xa0c06060, 0x98198181, 0xd19e4f4f, 0x7fa3dcdc, 0x66442222, 0x7e542a2a, 0xab3b9090, 0x830b8888, 0xca8c4646, 0x29c7eeee, 0xd36bb8b8, 0x3c281414, 0x79a7dede, 0xe2bc5e5e, 0x1d160b0b, 0x76addbdb, 0x3bdbe0e0, 0x56643232, 0x4e743a3a, 0x1e140a0a, 0xdb924949, 0x0a0c0606, 0x6c482424, 0xe4b85c5c, 0x5d9fc2c2, 0x6ebdd3d3, 0xef43acac, 0xa6c46262, 0xa8399191, 0xa4319595, 0x37d3e4e4, 0x8bf27979, 0x32d5e7e7, 0x438bc8c8, 0x596e3737, 0xb7da6d6d, 0x8c018d8d, 0x64b1d5d5, 0xd29c4e4e, 0xe049a9a9, 0xb4d86c6c, 0xfaac5656, 0x07f3f4f4, 0x25cfeaea, 0xafca6565, 0x8ef47a7a, 0xe947aeae, 0x18100808, 0xd56fbaba, 0x88f07878, 0x6f4a2525, 0x725c2e2e, 0x24381c1c, 0xf157a6a6, 0xc773b4b4, 0x5197c6c6, 0x23cbe8e8, 0x7ca1dddd, 0x9ce87474, 0x213e1f1f, 0xdd964b4b, 0xdc61bdbd, 0x860d8b8b, 0x850f8a8a, 0x90e07070, 0x427c3e3e, 0xc471b5b5, 0xaacc6666, 0xd8904848, 0x05060303, 0x01f7f6f6, 0x121c0e0e, 0xa3c26161, 0x5f6a3535, 0xf9ae5757, 0xd069b9b9, 0x91178686, 0x5899c1c1, 0x273a1d1d, 0xb9279e9e, 0x38d9e1e1, 0x13ebf8f8, 0xb32b9898, 0x33221111, 0xbbd26969, 0x70a9d9d9, 0x89078e8e, 0xa7339494, 0xb62d9b9b, 0x223c1e1e, 0x92158787, 0x20c9e9e9, 0x4987cece, 0xffaa5555, 0x78502828, 0x7aa5dfdf, 0x8f038c8c, 0xf859a1a1, 0x80098989, 0x171a0d0d, 0xda65bfbf, 0x31d7e6e6, 0xc6844242, 0xb8d06868, 0xc3824141, 0xb0299999, 0x775a2d2d, 0x111e0f0f, 0xcb7bb0b0, 0xfca85454, 0xd66dbbbb, 0x3a2c1616]);
        T3 = new Uint32Array([0x63a5c663, 0x7c84f87c, 0x7799ee77, 0x7b8df67b, 0xf20dfff2, 0x6bbdd66b, 0x6fb1de6f, 0xc55491c5, 0x30506030, 0x01030201, 0x67a9ce67, 0x2b7d562b, 0xfe19e7fe, 0xd762b5d7, 0xabe64dab, 0x769aec76, 0xca458fca, 0x829d1f82, 0xc94089c9, 0x7d87fa7d, 0xfa15effa, 0x59ebb259, 0x47c98e47, 0xf00bfbf0, 0xadec41ad, 0xd467b3d4, 0xa2fd5fa2, 0xafea45af, 0x9cbf239c, 0xa4f753a4, 0x7296e472, 0xc05b9bc0, 0xb7c275b7, 0xfd1ce1fd, 0x93ae3d93, 0x266a4c26, 0x365a6c36, 0x3f417e3f, 0xf702f5f7, 0xcc4f83cc, 0x345c6834, 0xa5f451a5, 0xe534d1e5, 0xf108f9f1, 0x7193e271, 0xd873abd8, 0x31536231, 0x153f2a15, 0x040c0804, 0xc75295c7, 0x23654623, 0xc35e9dc3, 0x18283018, 0x96a13796, 0x050f0a05, 0x9ab52f9a, 0x07090e07, 0x12362412, 0x809b1b80, 0xe23ddfe2, 0xeb26cdeb, 0x27694e27, 0xb2cd7fb2, 0x759fea75, 0x091b1209, 0x839e1d83, 0x2c74582c, 0x1a2e341a, 0x1b2d361b, 0x6eb2dc6e, 0x5aeeb45a, 0xa0fb5ba0, 0x52f6a452, 0x3b4d763b, 0xd661b7d6, 0xb3ce7db3, 0x297b5229, 0xe33edde3, 0x2f715e2f, 0x84971384, 0x53f5a653, 0xd168b9d1, 0x00000000, 0xed2cc1ed, 0x20604020, 0xfc1fe3fc, 0xb1c879b1, 0x5bedb65b, 0x6abed46a, 0xcb468dcb, 0xbed967be, 0x394b7239, 0x4ade944a, 0x4cd4984c, 0x58e8b058, 0xcf4a85cf, 0xd06bbbd0, 0xef2ac5ef, 0xaae54faa, 0xfb16edfb, 0x43c58643, 0x4dd79a4d, 0x33556633, 0x85941185, 0x45cf8a45, 0xf910e9f9, 0x02060402, 0x7f81fe7f, 0x50f0a050, 0x3c44783c, 0x9fba259f, 0xa8e34ba8, 0x51f3a251, 0xa3fe5da3, 0x40c08040, 0x8f8a058f, 0x92ad3f92, 0x9dbc219d, 0x38487038, 0xf504f1f5, 0xbcdf63bc, 0xb6c177b6, 0xda75afda, 0x21634221, 0x10302010, 0xff1ae5ff, 0xf30efdf3, 0xd26dbfd2, 0xcd4c81cd, 0x0c14180c, 0x13352613, 0xec2fc3ec, 0x5fe1be5f, 0x97a23597, 0x44cc8844, 0x17392e17, 0xc45793c4, 0xa7f255a7, 0x7e82fc7e, 0x3d477a3d, 0x64acc864, 0x5de7ba5d, 0x192b3219, 0x7395e673, 0x60a0c060, 0x81981981, 0x4fd19e4f, 0xdc7fa3dc, 0x22664422, 0x2a7e542a, 0x90ab3b90, 0x88830b88, 0x46ca8c46, 0xee29c7ee, 0xb8d36bb8, 0x143c2814, 0xde79a7de, 0x5ee2bc5e, 0x0b1d160b, 0xdb76addb, 0xe03bdbe0, 0x32566432, 0x3a4e743a, 0x0a1e140a, 0x49db9249, 0x060a0c06, 0x246c4824, 0x5ce4b85c, 0xc25d9fc2, 0xd36ebdd3, 0xacef43ac, 0x62a6c462, 0x91a83991, 0x95a43195, 0xe437d3e4, 0x798bf279, 0xe732d5e7, 0xc8438bc8, 0x37596e37, 0x6db7da6d, 0x8d8c018d, 0xd564b1d5, 0x4ed29c4e, 0xa9e049a9, 0x6cb4d86c, 0x56faac56, 0xf407f3f4, 0xea25cfea, 0x65afca65, 0x7a8ef47a, 0xaee947ae, 0x08181008, 0xbad56fba, 0x7888f078, 0x256f4a25, 0x2e725c2e, 0x1c24381c, 0xa6f157a6, 0xb4c773b4, 0xc65197c6, 0xe823cbe8, 0xdd7ca1dd, 0x749ce874, 0x1f213e1f, 0x4bdd964b, 0xbddc61bd, 0x8b860d8b, 0x8a850f8a, 0x7090e070, 0x3e427c3e, 0xb5c471b5, 0x66aacc66, 0x48d89048, 0x03050603, 0xf601f7f6, 0x0e121c0e, 0x61a3c261, 0x355f6a35, 0x57f9ae57, 0xb9d069b9, 0x86911786, 0xc15899c1, 0x1d273a1d, 0x9eb9279e, 0xe138d9e1, 0xf813ebf8, 0x98b32b98, 0x11332211, 0x69bbd269, 0xd970a9d9, 0x8e89078e, 0x94a73394, 0x9bb62d9b, 0x1e223c1e, 0x87921587, 0xe920c9e9, 0xce4987ce, 0x55ffaa55, 0x28785028, 0xdf7aa5df, 0x8c8f038c, 0xa1f859a1, 0x89800989, 0x0d171a0d, 0xbfda65bf, 0xe631d7e6, 0x42c68442, 0x68b8d068, 0x41c38241, 0x99b02999, 0x2d775a2d, 0x0f111e0f, 0xb0cb7bb0, 0x54fca854, 0xbbd66dbb, 0x163a2c16]);
        T4 = new Uint32Array([0x6363a5c6, 0x7c7c84f8, 0x777799ee, 0x7b7b8df6, 0xf2f20dff, 0x6b6bbdd6, 0x6f6fb1de, 0xc5c55491, 0x30305060, 0x01010302, 0x6767a9ce, 0x2b2b7d56, 0xfefe19e7, 0xd7d762b5, 0xababe64d, 0x76769aec, 0xcaca458f, 0x82829d1f, 0xc9c94089, 0x7d7d87fa, 0xfafa15ef, 0x5959ebb2, 0x4747c98e, 0xf0f00bfb, 0xadadec41, 0xd4d467b3, 0xa2a2fd5f, 0xafafea45, 0x9c9cbf23, 0xa4a4f753, 0x727296e4, 0xc0c05b9b, 0xb7b7c275, 0xfdfd1ce1, 0x9393ae3d, 0x26266a4c, 0x36365a6c, 0x3f3f417e, 0xf7f702f5, 0xcccc4f83, 0x34345c68, 0xa5a5f451, 0xe5e534d1, 0xf1f108f9, 0x717193e2, 0xd8d873ab, 0x31315362, 0x15153f2a, 0x04040c08, 0xc7c75295, 0x23236546, 0xc3c35e9d, 0x18182830, 0x9696a137, 0x05050f0a, 0x9a9ab52f, 0x0707090e, 0x12123624, 0x80809b1b, 0xe2e23ddf, 0xebeb26cd, 0x2727694e, 0xb2b2cd7f, 0x75759fea, 0x09091b12, 0x83839e1d, 0x2c2c7458, 0x1a1a2e34, 0x1b1b2d36, 0x6e6eb2dc, 0x5a5aeeb4, 0xa0a0fb5b, 0x5252f6a4, 0x3b3b4d76, 0xd6d661b7, 0xb3b3ce7d, 0x29297b52, 0xe3e33edd, 0x2f2f715e, 0x84849713, 0x5353f5a6, 0xd1d168b9, 0x00000000, 0xeded2cc1, 0x20206040, 0xfcfc1fe3, 0xb1b1c879, 0x5b5bedb6, 0x6a6abed4, 0xcbcb468d, 0xbebed967, 0x39394b72, 0x4a4ade94, 0x4c4cd498, 0x5858e8b0, 0xcfcf4a85, 0xd0d06bbb, 0xefef2ac5, 0xaaaae54f, 0xfbfb16ed, 0x4343c586, 0x4d4dd79a, 0x33335566, 0x85859411, 0x4545cf8a, 0xf9f910e9, 0x02020604, 0x7f7f81fe, 0x5050f0a0, 0x3c3c4478, 0x9f9fba25, 0xa8a8e34b, 0x5151f3a2, 0xa3a3fe5d, 0x4040c080, 0x8f8f8a05, 0x9292ad3f, 0x9d9dbc21, 0x38384870, 0xf5f504f1, 0xbcbcdf63, 0xb6b6c177, 0xdada75af, 0x21216342, 0x10103020, 0xffff1ae5, 0xf3f30efd, 0xd2d26dbf, 0xcdcd4c81, 0x0c0c1418, 0x13133526, 0xecec2fc3, 0x5f5fe1be, 0x9797a235, 0x4444cc88, 0x1717392e, 0xc4c45793, 0xa7a7f255, 0x7e7e82fc, 0x3d3d477a, 0x6464acc8, 0x5d5de7ba, 0x19192b32, 0x737395e6, 0x6060a0c0, 0x81819819, 0x4f4fd19e, 0xdcdc7fa3, 0x22226644, 0x2a2a7e54, 0x9090ab3b, 0x8888830b, 0x4646ca8c, 0xeeee29c7, 0xb8b8d36b, 0x14143c28, 0xdede79a7, 0x5e5ee2bc, 0x0b0b1d16, 0xdbdb76ad, 0xe0e03bdb, 0x32325664, 0x3a3a4e74, 0x0a0a1e14, 0x4949db92, 0x06060a0c, 0x24246c48, 0x5c5ce4b8, 0xc2c25d9f, 0xd3d36ebd, 0xacacef43, 0x6262a6c4, 0x9191a839, 0x9595a431, 0xe4e437d3, 0x79798bf2, 0xe7e732d5, 0xc8c8438b, 0x3737596e, 0x6d6db7da, 0x8d8d8c01, 0xd5d564b1, 0x4e4ed29c, 0xa9a9e049, 0x6c6cb4d8, 0x5656faac, 0xf4f407f3, 0xeaea25cf, 0x6565afca, 0x7a7a8ef4, 0xaeaee947, 0x08081810, 0xbabad56f, 0x787888f0, 0x25256f4a, 0x2e2e725c, 0x1c1c2438, 0xa6a6f157, 0xb4b4c773, 0xc6c65197, 0xe8e823cb, 0xdddd7ca1, 0x74749ce8, 0x1f1f213e, 0x4b4bdd96, 0xbdbddc61, 0x8b8b860d, 0x8a8a850f, 0x707090e0, 0x3e3e427c, 0xb5b5c471, 0x6666aacc, 0x4848d890, 0x03030506, 0xf6f601f7, 0x0e0e121c, 0x6161a3c2, 0x35355f6a, 0x5757f9ae, 0xb9b9d069, 0x86869117, 0xc1c15899, 0x1d1d273a, 0x9e9eb927, 0xe1e138d9, 0xf8f813eb, 0x9898b32b, 0x11113322, 0x6969bbd2, 0xd9d970a9, 0x8e8e8907, 0x9494a733, 0x9b9bb62d, 0x1e1e223c, 0x87879215, 0xe9e920c9, 0xcece4987, 0x5555ffaa, 0x28287850, 0xdfdf7aa5, 0x8c8c8f03, 0xa1a1f859, 0x89898009, 0x0d0d171a, 0xbfbfda65, 0xe6e631d7, 0x4242c684, 0x6868b8d0, 0x4141c382, 0x9999b029, 0x2d2d775a, 0x0f0f111e, 0xb0b0cb7b, 0x5454fca8, 0xbbbbd66d, 0x16163a2c]);
        T5 = new Uint32Array([0x51f4a750, 0x7e416553, 0x1a17a4c3, 0x3a275e96, 0x3bab6bcb, 0x1f9d45f1, 0xacfa58ab, 0x4be30393, 0x2030fa55, 0xad766df6, 0x88cc7691, 0xf5024c25, 0x4fe5d7fc, 0xc52acbd7, 0x26354480, 0xb562a38f, 0xdeb15a49, 0x25ba1b67, 0x45ea0e98, 0x5dfec0e1, 0xc32f7502, 0x814cf012, 0x8d4697a3, 0x6bd3f9c6, 0x038f5fe7, 0x15929c95, 0xbf6d7aeb, 0x955259da, 0xd4be832d, 0x587421d3, 0x49e06929, 0x8ec9c844, 0x75c2896a, 0xf48e7978, 0x99583e6b, 0x27b971dd, 0xbee14fb6, 0xf088ad17, 0xc920ac66, 0x7dce3ab4, 0x63df4a18, 0xe51a3182, 0x97513360, 0x62537f45, 0xb16477e0, 0xbb6bae84, 0xfe81a01c, 0xf9082b94, 0x70486858, 0x8f45fd19, 0x94de6c87, 0x527bf8b7, 0xab73d323, 0x724b02e2, 0xe31f8f57, 0x6655ab2a, 0xb2eb2807, 0x2fb5c203, 0x86c57b9a, 0xd33708a5, 0x302887f2, 0x23bfa5b2, 0x02036aba, 0xed16825c, 0x8acf1c2b, 0xa779b492, 0xf307f2f0, 0x4e69e2a1, 0x65daf4cd, 0x0605bed5, 0xd134621f, 0xc4a6fe8a, 0x342e539d, 0xa2f355a0, 0x058ae132, 0xa4f6eb75, 0x0b83ec39, 0x4060efaa, 0x5e719f06, 0xbd6e1051, 0x3e218af9, 0x96dd063d, 0xdd3e05ae, 0x4de6bd46, 0x91548db5, 0x71c45d05, 0x0406d46f, 0x605015ff, 0x1998fb24, 0xd6bde997, 0x894043cc, 0x67d99e77, 0xb0e842bd, 0x07898b88, 0xe7195b38, 0x79c8eedb, 0xa17c0a47, 0x7c420fe9, 0xf8841ec9, 0x00000000, 0x09808683, 0x322bed48, 0x1e1170ac, 0x6c5a724e, 0xfd0efffb, 0x0f853856, 0x3daed51e, 0x362d3927, 0x0a0fd964, 0x685ca621, 0x9b5b54d1, 0x24362e3a, 0x0c0a67b1, 0x9357e70f, 0xb4ee96d2, 0x1b9b919e, 0x80c0c54f, 0x61dc20a2, 0x5a774b69, 0x1c121a16, 0xe293ba0a, 0xc0a02ae5, 0x3c22e043, 0x121b171d, 0x0e090d0b, 0xf28bc7ad, 0x2db6a8b9, 0x141ea9c8, 0x57f11985, 0xaf75074c, 0xee99ddbb, 0xa37f60fd, 0xf701269f, 0x5c72f5bc, 0x44663bc5, 0x5bfb7e34, 0x8b432976, 0xcb23c6dc, 0xb6edfc68, 0xb8e4f163, 0xd731dcca, 0x42638510, 0x13972240, 0x84c61120, 0x854a247d, 0xd2bb3df8, 0xaef93211, 0xc729a16d, 0x1d9e2f4b, 0xdcb230f3, 0x0d8652ec, 0x77c1e3d0, 0x2bb3166c, 0xa970b999, 0x119448fa, 0x47e96422, 0xa8fc8cc4, 0xa0f03f1a, 0x567d2cd8, 0x223390ef, 0x87494ec7, 0xd938d1c1, 0x8ccaa2fe, 0x98d40b36, 0xa6f581cf, 0xa57ade28, 0xdab78e26, 0x3fadbfa4, 0x2c3a9de4, 0x5078920d, 0x6a5fcc9b, 0x547e4662, 0xf68d13c2, 0x90d8b8e8, 0x2e39f75e, 0x82c3aff5, 0x9f5d80be, 0x69d0937c, 0x6fd52da9, 0xcf2512b3, 0xc8ac993b, 0x10187da7, 0xe89c636e, 0xdb3bbb7b, 0xcd267809, 0x6e5918f4, 0xec9ab701, 0x834f9aa8, 0xe6956e65, 0xaaffe67e, 0x21bccf08, 0xef15e8e6, 0xbae79bd9, 0x4a6f36ce, 0xea9f09d4, 0x29b07cd6, 0x31a4b2af, 0x2a3f2331, 0xc6a59430, 0x35a266c0, 0x744ebc37, 0xfc82caa6, 0xe090d0b0, 0x33a7d815, 0xf104984a, 0x41ecdaf7, 0x7fcd500e, 0x1791f62f, 0x764dd68d, 0x43efb04d, 0xccaa4d54, 0xe49604df, 0x9ed1b5e3, 0x4c6a881b, 0xc12c1fb8, 0x4665517f, 0x9d5eea04, 0x018c355d, 0xfa877473, 0xfb0b412e, 0xb3671d5a, 0x92dbd252, 0xe9105633, 0x6dd64713, 0x9ad7618c, 0x37a10c7a, 0x59f8148e, 0xeb133c89, 0xcea927ee, 0xb761c935, 0xe11ce5ed, 0x7a47b13c, 0x9cd2df59, 0x55f2733f, 0x1814ce79, 0x73c737bf, 0x53f7cdea, 0x5ffdaa5b, 0xdf3d6f14, 0x7844db86, 0xcaaff381, 0xb968c43e, 0x3824342c, 0xc2a3405f, 0x161dc372, 0xbce2250c, 0x283c498b, 0xff0d9541, 0x39a80171, 0x080cb3de, 0xd8b4e49c, 0x6456c190, 0x7bcb8461, 0xd532b670, 0x486c5c74, 0xd0b85742]);
        T6 = new Uint32Array([0x5051f4a7, 0x537e4165, 0xc31a17a4, 0x963a275e, 0xcb3bab6b, 0xf11f9d45, 0xabacfa58, 0x934be303, 0x552030fa, 0xf6ad766d, 0x9188cc76, 0x25f5024c, 0xfc4fe5d7, 0xd7c52acb, 0x80263544, 0x8fb562a3, 0x49deb15a, 0x6725ba1b, 0x9845ea0e, 0xe15dfec0, 0x02c32f75, 0x12814cf0, 0xa38d4697, 0xc66bd3f9, 0xe7038f5f, 0x9515929c, 0xebbf6d7a, 0xda955259, 0x2dd4be83, 0xd3587421, 0x2949e069, 0x448ec9c8, 0x6a75c289, 0x78f48e79, 0x6b99583e, 0xdd27b971, 0xb6bee14f, 0x17f088ad, 0x66c920ac, 0xb47dce3a, 0x1863df4a, 0x82e51a31, 0x60975133, 0x4562537f, 0xe0b16477, 0x84bb6bae, 0x1cfe81a0, 0x94f9082b, 0x58704868, 0x198f45fd, 0x8794de6c, 0xb7527bf8, 0x23ab73d3, 0xe2724b02, 0x57e31f8f, 0x2a6655ab, 0x07b2eb28, 0x032fb5c2, 0x9a86c57b, 0xa5d33708, 0xf2302887, 0xb223bfa5, 0xba02036a, 0x5ced1682, 0x2b8acf1c, 0x92a779b4, 0xf0f307f2, 0xa14e69e2, 0xcd65daf4, 0xd50605be, 0x1fd13462, 0x8ac4a6fe, 0x9d342e53, 0xa0a2f355, 0x32058ae1, 0x75a4f6eb, 0x390b83ec, 0xaa4060ef, 0x065e719f, 0x51bd6e10, 0xf93e218a, 0x3d96dd06, 0xaedd3e05, 0x464de6bd, 0xb591548d, 0x0571c45d, 0x6f0406d4, 0xff605015, 0x241998fb, 0x97d6bde9, 0xcc894043, 0x7767d99e, 0xbdb0e842, 0x8807898b, 0x38e7195b, 0xdb79c8ee, 0x47a17c0a, 0xe97c420f, 0xc9f8841e, 0x00000000, 0x83098086, 0x48322bed, 0xac1e1170, 0x4e6c5a72, 0xfbfd0eff, 0x560f8538, 0x1e3daed5, 0x27362d39, 0x640a0fd9, 0x21685ca6, 0xd19b5b54, 0x3a24362e, 0xb10c0a67, 0x0f9357e7, 0xd2b4ee96, 0x9e1b9b91, 0x4f80c0c5, 0xa261dc20, 0x695a774b, 0x161c121a, 0x0ae293ba, 0xe5c0a02a, 0x433c22e0, 0x1d121b17, 0x0b0e090d, 0xadf28bc7, 0xb92db6a8, 0xc8141ea9, 0x8557f119, 0x4caf7507, 0xbbee99dd, 0xfda37f60, 0x9ff70126, 0xbc5c72f5, 0xc544663b, 0x345bfb7e, 0x768b4329, 0xdccb23c6, 0x68b6edfc, 0x63b8e4f1, 0xcad731dc, 0x10426385, 0x40139722, 0x2084c611, 0x7d854a24, 0xf8d2bb3d, 0x11aef932, 0x6dc729a1, 0x4b1d9e2f, 0xf3dcb230, 0xec0d8652, 0xd077c1e3, 0x6c2bb316, 0x99a970b9, 0xfa119448, 0x2247e964, 0xc4a8fc8c, 0x1aa0f03f, 0xd8567d2c, 0xef223390, 0xc787494e, 0xc1d938d1, 0xfe8ccaa2, 0x3698d40b, 0xcfa6f581, 0x28a57ade, 0x26dab78e, 0xa43fadbf, 0xe42c3a9d, 0x0d507892, 0x9b6a5fcc, 0x62547e46, 0xc2f68d13, 0xe890d8b8, 0x5e2e39f7, 0xf582c3af, 0xbe9f5d80, 0x7c69d093, 0xa96fd52d, 0xb3cf2512, 0x3bc8ac99, 0xa710187d, 0x6ee89c63, 0x7bdb3bbb, 0x09cd2678, 0xf46e5918, 0x01ec9ab7, 0xa8834f9a, 0x65e6956e, 0x7eaaffe6, 0x0821bccf, 0xe6ef15e8, 0xd9bae79b, 0xce4a6f36, 0xd4ea9f09, 0xd629b07c, 0xaf31a4b2, 0x312a3f23, 0x30c6a594, 0xc035a266, 0x37744ebc, 0xa6fc82ca, 0xb0e090d0, 0x1533a7d8, 0x4af10498, 0xf741ecda, 0x0e7fcd50, 0x2f1791f6, 0x8d764dd6, 0x4d43efb0, 0x54ccaa4d, 0xdfe49604, 0xe39ed1b5, 0x1b4c6a88, 0xb8c12c1f, 0x7f466551, 0x049d5eea, 0x5d018c35, 0x73fa8774, 0x2efb0b41, 0x5ab3671d, 0x5292dbd2, 0x33e91056, 0x136dd647, 0x8c9ad761, 0x7a37a10c, 0x8e59f814, 0x89eb133c, 0xeecea927, 0x35b761c9, 0xede11ce5, 0x3c7a47b1, 0x599cd2df, 0x3f55f273, 0x791814ce, 0xbf73c737, 0xea53f7cd, 0x5b5ffdaa, 0x14df3d6f, 0x867844db, 0x81caaff3, 0x3eb968c4, 0x2c382434, 0x5fc2a340, 0x72161dc3, 0x0cbce225, 0x8b283c49, 0x41ff0d95, 0x7139a801, 0xde080cb3, 0x9cd8b4e4, 0x906456c1, 0x617bcb84, 0x70d532b6, 0x74486c5c, 0x42d0b857]);
        T7 = new Uint32Array([0xa75051f4, 0x65537e41, 0xa4c31a17, 0x5e963a27, 0x6bcb3bab, 0x45f11f9d, 0x58abacfa, 0x03934be3, 0xfa552030, 0x6df6ad76, 0x769188cc, 0x4c25f502, 0xd7fc4fe5, 0xcbd7c52a, 0x44802635, 0xa38fb562, 0x5a49deb1, 0x1b6725ba, 0x0e9845ea, 0xc0e15dfe, 0x7502c32f, 0xf012814c, 0x97a38d46, 0xf9c66bd3, 0x5fe7038f, 0x9c951592, 0x7aebbf6d, 0x59da9552, 0x832dd4be, 0x21d35874, 0x692949e0, 0xc8448ec9, 0x896a75c2, 0x7978f48e, 0x3e6b9958, 0x71dd27b9, 0x4fb6bee1, 0xad17f088, 0xac66c920, 0x3ab47dce, 0x4a1863df, 0x3182e51a, 0x33609751, 0x7f456253, 0x77e0b164, 0xae84bb6b, 0xa01cfe81, 0x2b94f908, 0x68587048, 0xfd198f45, 0x6c8794de, 0xf8b7527b, 0xd323ab73, 0x02e2724b, 0x8f57e31f, 0xab2a6655, 0x2807b2eb, 0xc2032fb5, 0x7b9a86c5, 0x08a5d337, 0x87f23028, 0xa5b223bf, 0x6aba0203, 0x825ced16, 0x1c2b8acf, 0xb492a779, 0xf2f0f307, 0xe2a14e69, 0xf4cd65da, 0xbed50605, 0x621fd134, 0xfe8ac4a6, 0x539d342e, 0x55a0a2f3, 0xe132058a, 0xeb75a4f6, 0xec390b83, 0xefaa4060, 0x9f065e71, 0x1051bd6e, 0x8af93e21, 0x063d96dd, 0x05aedd3e, 0xbd464de6, 0x8db59154, 0x5d0571c4, 0xd46f0406, 0x15ff6050, 0xfb241998, 0xe997d6bd, 0x43cc8940, 0x9e7767d9, 0x42bdb0e8, 0x8b880789, 0x5b38e719, 0xeedb79c8, 0x0a47a17c, 0x0fe97c42, 0x1ec9f884, 0x00000000, 0x86830980, 0xed48322b, 0x70ac1e11, 0x724e6c5a, 0xfffbfd0e, 0x38560f85, 0xd51e3dae, 0x3927362d, 0xd9640a0f, 0xa621685c, 0x54d19b5b, 0x2e3a2436, 0x67b10c0a, 0xe70f9357, 0x96d2b4ee, 0x919e1b9b, 0xc54f80c0, 0x20a261dc, 0x4b695a77, 0x1a161c12, 0xba0ae293, 0x2ae5c0a0, 0xe0433c22, 0x171d121b, 0x0d0b0e09, 0xc7adf28b, 0xa8b92db6, 0xa9c8141e, 0x198557f1, 0x074caf75, 0xddbbee99, 0x60fda37f, 0x269ff701, 0xf5bc5c72, 0x3bc54466, 0x7e345bfb, 0x29768b43, 0xc6dccb23, 0xfc68b6ed, 0xf163b8e4, 0xdccad731, 0x85104263, 0x22401397, 0x112084c6, 0x247d854a, 0x3df8d2bb, 0x3211aef9, 0xa16dc729, 0x2f4b1d9e, 0x30f3dcb2, 0x52ec0d86, 0xe3d077c1, 0x166c2bb3, 0xb999a970, 0x48fa1194, 0x642247e9, 0x8cc4a8fc, 0x3f1aa0f0, 0x2cd8567d, 0x90ef2233, 0x4ec78749, 0xd1c1d938, 0xa2fe8cca, 0x0b3698d4, 0x81cfa6f5, 0xde28a57a, 0x8e26dab7, 0xbfa43fad, 0x9de42c3a, 0x920d5078, 0xcc9b6a5f, 0x4662547e, 0x13c2f68d, 0xb8e890d8, 0xf75e2e39, 0xaff582c3, 0x80be9f5d, 0x937c69d0, 0x2da96fd5, 0x12b3cf25, 0x993bc8ac, 0x7da71018, 0x636ee89c, 0xbb7bdb3b, 0x7809cd26, 0x18f46e59, 0xb701ec9a, 0x9aa8834f, 0x6e65e695, 0xe67eaaff, 0xcf0821bc, 0xe8e6ef15, 0x9bd9bae7, 0x36ce4a6f, 0x09d4ea9f, 0x7cd629b0, 0xb2af31a4, 0x23312a3f, 0x9430c6a5, 0x66c035a2, 0xbc37744e, 0xcaa6fc82, 0xd0b0e090, 0xd81533a7, 0x984af104, 0xdaf741ec, 0x500e7fcd, 0xf62f1791, 0xd68d764d, 0xb04d43ef, 0x4d54ccaa, 0x04dfe496, 0xb5e39ed1, 0x881b4c6a, 0x1fb8c12c, 0x517f4665, 0xea049d5e, 0x355d018c, 0x7473fa87, 0x412efb0b, 0x1d5ab367, 0xd25292db, 0x5633e910, 0x47136dd6, 0x618c9ad7, 0x0c7a37a1, 0x148e59f8, 0x3c89eb13, 0x27eecea9, 0xc935b761, 0xe5ede11c, 0xb13c7a47, 0xdf599cd2, 0x733f55f2, 0xce791814, 0x37bf73c7, 0xcdea53f7, 0xaa5b5ffd, 0x6f14df3d, 0xdb867844, 0xf381caaf, 0xc43eb968, 0x342c3824, 0x405fc2a3, 0xc372161d, 0x250cbce2, 0x498b283c, 0x9541ff0d, 0x017139a8, 0xb3de080c, 0xe49cd8b4, 0xc1906456, 0x84617bcb, 0xb670d532, 0x5c74486c, 0x5742d0b8]);
        T8 = new Uint32Array([0xf4a75051, 0x4165537e, 0x17a4c31a, 0x275e963a, 0xab6bcb3b, 0x9d45f11f, 0xfa58abac, 0xe303934b, 0x30fa5520, 0x766df6ad, 0xcc769188, 0x024c25f5, 0xe5d7fc4f, 0x2acbd7c5, 0x35448026, 0x62a38fb5, 0xb15a49de, 0xba1b6725, 0xea0e9845, 0xfec0e15d, 0x2f7502c3, 0x4cf01281, 0x4697a38d, 0xd3f9c66b, 0x8f5fe703, 0x929c9515, 0x6d7aebbf, 0x5259da95, 0xbe832dd4, 0x7421d358, 0xe0692949, 0xc9c8448e, 0xc2896a75, 0x8e7978f4, 0x583e6b99, 0xb971dd27, 0xe14fb6be, 0x88ad17f0, 0x20ac66c9, 0xce3ab47d, 0xdf4a1863, 0x1a3182e5, 0x51336097, 0x537f4562, 0x6477e0b1, 0x6bae84bb, 0x81a01cfe, 0x082b94f9, 0x48685870, 0x45fd198f, 0xde6c8794, 0x7bf8b752, 0x73d323ab, 0x4b02e272, 0x1f8f57e3, 0x55ab2a66, 0xeb2807b2, 0xb5c2032f, 0xc57b9a86, 0x3708a5d3, 0x2887f230, 0xbfa5b223, 0x036aba02, 0x16825ced, 0xcf1c2b8a, 0x79b492a7, 0x07f2f0f3, 0x69e2a14e, 0xdaf4cd65, 0x05bed506, 0x34621fd1, 0xa6fe8ac4, 0x2e539d34, 0xf355a0a2, 0x8ae13205, 0xf6eb75a4, 0x83ec390b, 0x60efaa40, 0x719f065e, 0x6e1051bd, 0x218af93e, 0xdd063d96, 0x3e05aedd, 0xe6bd464d, 0x548db591, 0xc45d0571, 0x06d46f04, 0x5015ff60, 0x98fb2419, 0xbde997d6, 0x4043cc89, 0xd99e7767, 0xe842bdb0, 0x898b8807, 0x195b38e7, 0xc8eedb79, 0x7c0a47a1, 0x420fe97c, 0x841ec9f8, 0x00000000, 0x80868309, 0x2bed4832, 0x1170ac1e, 0x5a724e6c, 0x0efffbfd, 0x8538560f, 0xaed51e3d, 0x2d392736, 0x0fd9640a, 0x5ca62168, 0x5b54d19b, 0x362e3a24, 0x0a67b10c, 0x57e70f93, 0xee96d2b4, 0x9b919e1b, 0xc0c54f80, 0xdc20a261, 0x774b695a, 0x121a161c, 0x93ba0ae2, 0xa02ae5c0, 0x22e0433c, 0x1b171d12, 0x090d0b0e, 0x8bc7adf2, 0xb6a8b92d, 0x1ea9c814, 0xf1198557, 0x75074caf, 0x99ddbbee, 0x7f60fda3, 0x01269ff7, 0x72f5bc5c, 0x663bc544, 0xfb7e345b, 0x4329768b, 0x23c6dccb, 0xedfc68b6, 0xe4f163b8, 0x31dccad7, 0x63851042, 0x97224013, 0xc6112084, 0x4a247d85, 0xbb3df8d2, 0xf93211ae, 0x29a16dc7, 0x9e2f4b1d, 0xb230f3dc, 0x8652ec0d, 0xc1e3d077, 0xb3166c2b, 0x70b999a9, 0x9448fa11, 0xe9642247, 0xfc8cc4a8, 0xf03f1aa0, 0x7d2cd856, 0x3390ef22, 0x494ec787, 0x38d1c1d9, 0xcaa2fe8c, 0xd40b3698, 0xf581cfa6, 0x7ade28a5, 0xb78e26da, 0xadbfa43f, 0x3a9de42c, 0x78920d50, 0x5fcc9b6a, 0x7e466254, 0x8d13c2f6, 0xd8b8e890, 0x39f75e2e, 0xc3aff582, 0x5d80be9f, 0xd0937c69, 0xd52da96f, 0x2512b3cf, 0xac993bc8, 0x187da710, 0x9c636ee8, 0x3bbb7bdb, 0x267809cd, 0x5918f46e, 0x9ab701ec, 0x4f9aa883, 0x956e65e6, 0xffe67eaa, 0xbccf0821, 0x15e8e6ef, 0xe79bd9ba, 0x6f36ce4a, 0x9f09d4ea, 0xb07cd629, 0xa4b2af31, 0x3f23312a, 0xa59430c6, 0xa266c035, 0x4ebc3774, 0x82caa6fc, 0x90d0b0e0, 0xa7d81533, 0x04984af1, 0xecdaf741, 0xcd500e7f, 0x91f62f17, 0x4dd68d76, 0xefb04d43, 0xaa4d54cc, 0x9604dfe4, 0xd1b5e39e, 0x6a881b4c, 0x2c1fb8c1, 0x65517f46, 0x5eea049d, 0x8c355d01, 0x877473fa, 0x0b412efb, 0x671d5ab3, 0xdbd25292, 0x105633e9, 0xd647136d, 0xd7618c9a, 0xa10c7a37, 0xf8148e59, 0x133c89eb, 0xa927eece, 0x61c935b7, 0x1ce5ede1, 0x47b13c7a, 0xd2df599c, 0xf2733f55, 0x14ce7918, 0xc737bf73, 0xf7cdea53, 0xfdaa5b5f, 0x3d6f14df, 0x44db8678, 0xaff381ca, 0x68c43eb9, 0x24342c38, 0xa3405fc2, 0x1dc37216, 0xe2250cbc, 0x3c498b28, 0x0d9541ff, 0xa8017139, 0x0cb3de08, 0xb4e49cd8, 0x56c19064, 0xcb84617b, 0x32b670d5, 0x6c5c7448, 0xb85742d0]);
        U1 = new Uint32Array([0x00000000, 0x0e090d0b, 0x1c121a16, 0x121b171d, 0x3824342c, 0x362d3927, 0x24362e3a, 0x2a3f2331, 0x70486858, 0x7e416553, 0x6c5a724e, 0x62537f45, 0x486c5c74, 0x4665517f, 0x547e4662, 0x5a774b69, 0xe090d0b0, 0xee99ddbb, 0xfc82caa6, 0xf28bc7ad, 0xd8b4e49c, 0xd6bde997, 0xc4a6fe8a, 0xcaaff381, 0x90d8b8e8, 0x9ed1b5e3, 0x8ccaa2fe, 0x82c3aff5, 0xa8fc8cc4, 0xa6f581cf, 0xb4ee96d2, 0xbae79bd9, 0xdb3bbb7b, 0xd532b670, 0xc729a16d, 0xc920ac66, 0xe31f8f57, 0xed16825c, 0xff0d9541, 0xf104984a, 0xab73d323, 0xa57ade28, 0xb761c935, 0xb968c43e, 0x9357e70f, 0x9d5eea04, 0x8f45fd19, 0x814cf012, 0x3bab6bcb, 0x35a266c0, 0x27b971dd, 0x29b07cd6, 0x038f5fe7, 0x0d8652ec, 0x1f9d45f1, 0x119448fa, 0x4be30393, 0x45ea0e98, 0x57f11985, 0x59f8148e, 0x73c737bf, 0x7dce3ab4, 0x6fd52da9, 0x61dc20a2, 0xad766df6, 0xa37f60fd, 0xb16477e0, 0xbf6d7aeb, 0x955259da, 0x9b5b54d1, 0x894043cc, 0x87494ec7, 0xdd3e05ae, 0xd33708a5, 0xc12c1fb8, 0xcf2512b3, 0xe51a3182, 0xeb133c89, 0xf9082b94, 0xf701269f, 0x4de6bd46, 0x43efb04d, 0x51f4a750, 0x5ffdaa5b, 0x75c2896a, 0x7bcb8461, 0x69d0937c, 0x67d99e77, 0x3daed51e, 0x33a7d815, 0x21bccf08, 0x2fb5c203, 0x058ae132, 0x0b83ec39, 0x1998fb24, 0x1791f62f, 0x764dd68d, 0x7844db86, 0x6a5fcc9b, 0x6456c190, 0x4e69e2a1, 0x4060efaa, 0x527bf8b7, 0x5c72f5bc, 0x0605bed5, 0x080cb3de, 0x1a17a4c3, 0x141ea9c8, 0x3e218af9, 0x302887f2, 0x223390ef, 0x2c3a9de4, 0x96dd063d, 0x98d40b36, 0x8acf1c2b, 0x84c61120, 0xaef93211, 0xa0f03f1a, 0xb2eb2807, 0xbce2250c, 0xe6956e65, 0xe89c636e, 0xfa877473, 0xf48e7978, 0xdeb15a49, 0xd0b85742, 0xc2a3405f, 0xccaa4d54, 0x41ecdaf7, 0x4fe5d7fc, 0x5dfec0e1, 0x53f7cdea, 0x79c8eedb, 0x77c1e3d0, 0x65daf4cd, 0x6bd3f9c6, 0x31a4b2af, 0x3fadbfa4, 0x2db6a8b9, 0x23bfa5b2, 0x09808683, 0x07898b88, 0x15929c95, 0x1b9b919e, 0xa17c0a47, 0xaf75074c, 0xbd6e1051, 0xb3671d5a, 0x99583e6b, 0x97513360, 0x854a247d, 0x8b432976, 0xd134621f, 0xdf3d6f14, 0xcd267809, 0xc32f7502, 0xe9105633, 0xe7195b38, 0xf5024c25, 0xfb0b412e, 0x9ad7618c, 0x94de6c87, 0x86c57b9a, 0x88cc7691, 0xa2f355a0, 0xacfa58ab, 0xbee14fb6, 0xb0e842bd, 0xea9f09d4, 0xe49604df, 0xf68d13c2, 0xf8841ec9, 0xd2bb3df8, 0xdcb230f3, 0xcea927ee, 0xc0a02ae5, 0x7a47b13c, 0x744ebc37, 0x6655ab2a, 0x685ca621, 0x42638510, 0x4c6a881b, 0x5e719f06, 0x5078920d, 0x0a0fd964, 0x0406d46f, 0x161dc372, 0x1814ce79, 0x322bed48, 0x3c22e043, 0x2e39f75e, 0x2030fa55, 0xec9ab701, 0xe293ba0a, 0xf088ad17, 0xfe81a01c, 0xd4be832d, 0xdab78e26, 0xc8ac993b, 0xc6a59430, 0x9cd2df59, 0x92dbd252, 0x80c0c54f, 0x8ec9c844, 0xa4f6eb75, 0xaaffe67e, 0xb8e4f163, 0xb6edfc68, 0x0c0a67b1, 0x02036aba, 0x10187da7, 0x1e1170ac, 0x342e539d, 0x3a275e96, 0x283c498b, 0x26354480, 0x7c420fe9, 0x724b02e2, 0x605015ff, 0x6e5918f4, 0x44663bc5, 0x4a6f36ce, 0x587421d3, 0x567d2cd8, 0x37a10c7a, 0x39a80171, 0x2bb3166c, 0x25ba1b67, 0x0f853856, 0x018c355d, 0x13972240, 0x1d9e2f4b, 0x47e96422, 0x49e06929, 0x5bfb7e34, 0x55f2733f, 0x7fcd500e, 0x71c45d05, 0x63df4a18, 0x6dd64713, 0xd731dcca, 0xd938d1c1, 0xcb23c6dc, 0xc52acbd7, 0xef15e8e6, 0xe11ce5ed, 0xf307f2f0, 0xfd0efffb, 0xa779b492, 0xa970b999, 0xbb6bae84, 0xb562a38f, 0x9f5d80be, 0x91548db5, 0x834f9aa8, 0x8d4697a3]);
        U2 = new Uint32Array([0x00000000, 0x0b0e090d, 0x161c121a, 0x1d121b17, 0x2c382434, 0x27362d39, 0x3a24362e, 0x312a3f23, 0x58704868, 0x537e4165, 0x4e6c5a72, 0x4562537f, 0x74486c5c, 0x7f466551, 0x62547e46, 0x695a774b, 0xb0e090d0, 0xbbee99dd, 0xa6fc82ca, 0xadf28bc7, 0x9cd8b4e4, 0x97d6bde9, 0x8ac4a6fe, 0x81caaff3, 0xe890d8b8, 0xe39ed1b5, 0xfe8ccaa2, 0xf582c3af, 0xc4a8fc8c, 0xcfa6f581, 0xd2b4ee96, 0xd9bae79b, 0x7bdb3bbb, 0x70d532b6, 0x6dc729a1, 0x66c920ac, 0x57e31f8f, 0x5ced1682, 0x41ff0d95, 0x4af10498, 0x23ab73d3, 0x28a57ade, 0x35b761c9, 0x3eb968c4, 0x0f9357e7, 0x049d5eea, 0x198f45fd, 0x12814cf0, 0xcb3bab6b, 0xc035a266, 0xdd27b971, 0xd629b07c, 0xe7038f5f, 0xec0d8652, 0xf11f9d45, 0xfa119448, 0x934be303, 0x9845ea0e, 0x8557f119, 0x8e59f814, 0xbf73c737, 0xb47dce3a, 0xa96fd52d, 0xa261dc20, 0xf6ad766d, 0xfda37f60, 0xe0b16477, 0xebbf6d7a, 0xda955259, 0xd19b5b54, 0xcc894043, 0xc787494e, 0xaedd3e05, 0xa5d33708, 0xb8c12c1f, 0xb3cf2512, 0x82e51a31, 0x89eb133c, 0x94f9082b, 0x9ff70126, 0x464de6bd, 0x4d43efb0, 0x5051f4a7, 0x5b5ffdaa, 0x6a75c289, 0x617bcb84, 0x7c69d093, 0x7767d99e, 0x1e3daed5, 0x1533a7d8, 0x0821bccf, 0x032fb5c2, 0x32058ae1, 0x390b83ec, 0x241998fb, 0x2f1791f6, 0x8d764dd6, 0x867844db, 0x9b6a5fcc, 0x906456c1, 0xa14e69e2, 0xaa4060ef, 0xb7527bf8, 0xbc5c72f5, 0xd50605be, 0xde080cb3, 0xc31a17a4, 0xc8141ea9, 0xf93e218a, 0xf2302887, 0xef223390, 0xe42c3a9d, 0x3d96dd06, 0x3698d40b, 0x2b8acf1c, 0x2084c611, 0x11aef932, 0x1aa0f03f, 0x07b2eb28, 0x0cbce225, 0x65e6956e, 0x6ee89c63, 0x73fa8774, 0x78f48e79, 0x49deb15a, 0x42d0b857, 0x5fc2a340, 0x54ccaa4d, 0xf741ecda, 0xfc4fe5d7, 0xe15dfec0, 0xea53f7cd, 0xdb79c8ee, 0xd077c1e3, 0xcd65daf4, 0xc66bd3f9, 0xaf31a4b2, 0xa43fadbf, 0xb92db6a8, 0xb223bfa5, 0x83098086, 0x8807898b, 0x9515929c, 0x9e1b9b91, 0x47a17c0a, 0x4caf7507, 0x51bd6e10, 0x5ab3671d, 0x6b99583e, 0x60975133, 0x7d854a24, 0x768b4329, 0x1fd13462, 0x14df3d6f, 0x09cd2678, 0x02c32f75, 0x33e91056, 0x38e7195b, 0x25f5024c, 0x2efb0b41, 0x8c9ad761, 0x8794de6c, 0x9a86c57b, 0x9188cc76, 0xa0a2f355, 0xabacfa58, 0xb6bee14f, 0xbdb0e842, 0xd4ea9f09, 0xdfe49604, 0xc2f68d13, 0xc9f8841e, 0xf8d2bb3d, 0xf3dcb230, 0xeecea927, 0xe5c0a02a, 0x3c7a47b1, 0x37744ebc, 0x2a6655ab, 0x21685ca6, 0x10426385, 0x1b4c6a88, 0x065e719f, 0x0d507892, 0x640a0fd9, 0x6f0406d4, 0x72161dc3, 0x791814ce, 0x48322bed, 0x433c22e0, 0x5e2e39f7, 0x552030fa, 0x01ec9ab7, 0x0ae293ba, 0x17f088ad, 0x1cfe81a0, 0x2dd4be83, 0x26dab78e, 0x3bc8ac99, 0x30c6a594, 0x599cd2df, 0x5292dbd2, 0x4f80c0c5, 0x448ec9c8, 0x75a4f6eb, 0x7eaaffe6, 0x63b8e4f1, 0x68b6edfc, 0xb10c0a67, 0xba02036a, 0xa710187d, 0xac1e1170, 0x9d342e53, 0x963a275e, 0x8b283c49, 0x80263544, 0xe97c420f, 0xe2724b02, 0xff605015, 0xf46e5918, 0xc544663b, 0xce4a6f36, 0xd3587421, 0xd8567d2c, 0x7a37a10c, 0x7139a801, 0x6c2bb316, 0x6725ba1b, 0x560f8538, 0x5d018c35, 0x40139722, 0x4b1d9e2f, 0x2247e964, 0x2949e069, 0x345bfb7e, 0x3f55f273, 0x0e7fcd50, 0x0571c45d, 0x1863df4a, 0x136dd647, 0xcad731dc, 0xc1d938d1, 0xdccb23c6, 0xd7c52acb, 0xe6ef15e8, 0xede11ce5, 0xf0f307f2, 0xfbfd0eff, 0x92a779b4, 0x99a970b9, 0x84bb6bae, 0x8fb562a3, 0xbe9f5d80, 0xb591548d, 0xa8834f9a, 0xa38d4697]);
        U3 = new Uint32Array([0x00000000, 0x0d0b0e09, 0x1a161c12, 0x171d121b, 0x342c3824, 0x3927362d, 0x2e3a2436, 0x23312a3f, 0x68587048, 0x65537e41, 0x724e6c5a, 0x7f456253, 0x5c74486c, 0x517f4665, 0x4662547e, 0x4b695a77, 0xd0b0e090, 0xddbbee99, 0xcaa6fc82, 0xc7adf28b, 0xe49cd8b4, 0xe997d6bd, 0xfe8ac4a6, 0xf381caaf, 0xb8e890d8, 0xb5e39ed1, 0xa2fe8cca, 0xaff582c3, 0x8cc4a8fc, 0x81cfa6f5, 0x96d2b4ee, 0x9bd9bae7, 0xbb7bdb3b, 0xb670d532, 0xa16dc729, 0xac66c920, 0x8f57e31f, 0x825ced16, 0x9541ff0d, 0x984af104, 0xd323ab73, 0xde28a57a, 0xc935b761, 0xc43eb968, 0xe70f9357, 0xea049d5e, 0xfd198f45, 0xf012814c, 0x6bcb3bab, 0x66c035a2, 0x71dd27b9, 0x7cd629b0, 0x5fe7038f, 0x52ec0d86, 0x45f11f9d, 0x48fa1194, 0x03934be3, 0x0e9845ea, 0x198557f1, 0x148e59f8, 0x37bf73c7, 0x3ab47dce, 0x2da96fd5, 0x20a261dc, 0x6df6ad76, 0x60fda37f, 0x77e0b164, 0x7aebbf6d, 0x59da9552, 0x54d19b5b, 0x43cc8940, 0x4ec78749, 0x05aedd3e, 0x08a5d337, 0x1fb8c12c, 0x12b3cf25, 0x3182e51a, 0x3c89eb13, 0x2b94f908, 0x269ff701, 0xbd464de6, 0xb04d43ef, 0xa75051f4, 0xaa5b5ffd, 0x896a75c2, 0x84617bcb, 0x937c69d0, 0x9e7767d9, 0xd51e3dae, 0xd81533a7, 0xcf0821bc, 0xc2032fb5, 0xe132058a, 0xec390b83, 0xfb241998, 0xf62f1791, 0xd68d764d, 0xdb867844, 0xcc9b6a5f, 0xc1906456, 0xe2a14e69, 0xefaa4060, 0xf8b7527b, 0xf5bc5c72, 0xbed50605, 0xb3de080c, 0xa4c31a17, 0xa9c8141e, 0x8af93e21, 0x87f23028, 0x90ef2233, 0x9de42c3a, 0x063d96dd, 0x0b3698d4, 0x1c2b8acf, 0x112084c6, 0x3211aef9, 0x3f1aa0f0, 0x2807b2eb, 0x250cbce2, 0x6e65e695, 0x636ee89c, 0x7473fa87, 0x7978f48e, 0x5a49deb1, 0x5742d0b8, 0x405fc2a3, 0x4d54ccaa, 0xdaf741ec, 0xd7fc4fe5, 0xc0e15dfe, 0xcdea53f7, 0xeedb79c8, 0xe3d077c1, 0xf4cd65da, 0xf9c66bd3, 0xb2af31a4, 0xbfa43fad, 0xa8b92db6, 0xa5b223bf, 0x86830980, 0x8b880789, 0x9c951592, 0x919e1b9b, 0x0a47a17c, 0x074caf75, 0x1051bd6e, 0x1d5ab367, 0x3e6b9958, 0x33609751, 0x247d854a, 0x29768b43, 0x621fd134, 0x6f14df3d, 0x7809cd26, 0x7502c32f, 0x5633e910, 0x5b38e719, 0x4c25f502, 0x412efb0b, 0x618c9ad7, 0x6c8794de, 0x7b9a86c5, 0x769188cc, 0x55a0a2f3, 0x58abacfa, 0x4fb6bee1, 0x42bdb0e8, 0x09d4ea9f, 0x04dfe496, 0x13c2f68d, 0x1ec9f884, 0x3df8d2bb, 0x30f3dcb2, 0x27eecea9, 0x2ae5c0a0, 0xb13c7a47, 0xbc37744e, 0xab2a6655, 0xa621685c, 0x85104263, 0x881b4c6a, 0x9f065e71, 0x920d5078, 0xd9640a0f, 0xd46f0406, 0xc372161d, 0xce791814, 0xed48322b, 0xe0433c22, 0xf75e2e39, 0xfa552030, 0xb701ec9a, 0xba0ae293, 0xad17f088, 0xa01cfe81, 0x832dd4be, 0x8e26dab7, 0x993bc8ac, 0x9430c6a5, 0xdf599cd2, 0xd25292db, 0xc54f80c0, 0xc8448ec9, 0xeb75a4f6, 0xe67eaaff, 0xf163b8e4, 0xfc68b6ed, 0x67b10c0a, 0x6aba0203, 0x7da71018, 0x70ac1e11, 0x539d342e, 0x5e963a27, 0x498b283c, 0x44802635, 0x0fe97c42, 0x02e2724b, 0x15ff6050, 0x18f46e59, 0x3bc54466, 0x36ce4a6f, 0x21d35874, 0x2cd8567d, 0x0c7a37a1, 0x017139a8, 0x166c2bb3, 0x1b6725ba, 0x38560f85, 0x355d018c, 0x22401397, 0x2f4b1d9e, 0x642247e9, 0x692949e0, 0x7e345bfb, 0x733f55f2, 0x500e7fcd, 0x5d0571c4, 0x4a1863df, 0x47136dd6, 0xdccad731, 0xd1c1d938, 0xc6dccb23, 0xcbd7c52a, 0xe8e6ef15, 0xe5ede11c, 0xf2f0f307, 0xfffbfd0e, 0xb492a779, 0xb999a970, 0xae84bb6b, 0xa38fb562, 0x80be9f5d, 0x8db59154, 0x9aa8834f, 0x97a38d46]);
        U4 = new Uint32Array([0x00000000, 0x090d0b0e, 0x121a161c, 0x1b171d12, 0x24342c38, 0x2d392736, 0x362e3a24, 0x3f23312a, 0x48685870, 0x4165537e, 0x5a724e6c, 0x537f4562, 0x6c5c7448, 0x65517f46, 0x7e466254, 0x774b695a, 0x90d0b0e0, 0x99ddbbee, 0x82caa6fc, 0x8bc7adf2, 0xb4e49cd8, 0xbde997d6, 0xa6fe8ac4, 0xaff381ca, 0xd8b8e890, 0xd1b5e39e, 0xcaa2fe8c, 0xc3aff582, 0xfc8cc4a8, 0xf581cfa6, 0xee96d2b4, 0xe79bd9ba, 0x3bbb7bdb, 0x32b670d5, 0x29a16dc7, 0x20ac66c9, 0x1f8f57e3, 0x16825ced, 0x0d9541ff, 0x04984af1, 0x73d323ab, 0x7ade28a5, 0x61c935b7, 0x68c43eb9, 0x57e70f93, 0x5eea049d, 0x45fd198f, 0x4cf01281, 0xab6bcb3b, 0xa266c035, 0xb971dd27, 0xb07cd629, 0x8f5fe703, 0x8652ec0d, 0x9d45f11f, 0x9448fa11, 0xe303934b, 0xea0e9845, 0xf1198557, 0xf8148e59, 0xc737bf73, 0xce3ab47d, 0xd52da96f, 0xdc20a261, 0x766df6ad, 0x7f60fda3, 0x6477e0b1, 0x6d7aebbf, 0x5259da95, 0x5b54d19b, 0x4043cc89, 0x494ec787, 0x3e05aedd, 0x3708a5d3, 0x2c1fb8c1, 0x2512b3cf, 0x1a3182e5, 0x133c89eb, 0x082b94f9, 0x01269ff7, 0xe6bd464d, 0xefb04d43, 0xf4a75051, 0xfdaa5b5f, 0xc2896a75, 0xcb84617b, 0xd0937c69, 0xd99e7767, 0xaed51e3d, 0xa7d81533, 0xbccf0821, 0xb5c2032f, 0x8ae13205, 0x83ec390b, 0x98fb2419, 0x91f62f17, 0x4dd68d76, 0x44db8678, 0x5fcc9b6a, 0x56c19064, 0x69e2a14e, 0x60efaa40, 0x7bf8b752, 0x72f5bc5c, 0x05bed506, 0x0cb3de08, 0x17a4c31a, 0x1ea9c814, 0x218af93e, 0x2887f230, 0x3390ef22, 0x3a9de42c, 0xdd063d96, 0xd40b3698, 0xcf1c2b8a, 0xc6112084, 0xf93211ae, 0xf03f1aa0, 0xeb2807b2, 0xe2250cbc, 0x956e65e6, 0x9c636ee8, 0x877473fa, 0x8e7978f4, 0xb15a49de, 0xb85742d0, 0xa3405fc2, 0xaa4d54cc, 0xecdaf741, 0xe5d7fc4f, 0xfec0e15d, 0xf7cdea53, 0xc8eedb79, 0xc1e3d077, 0xdaf4cd65, 0xd3f9c66b, 0xa4b2af31, 0xadbfa43f, 0xb6a8b92d, 0xbfa5b223, 0x80868309, 0x898b8807, 0x929c9515, 0x9b919e1b, 0x7c0a47a1, 0x75074caf, 0x6e1051bd, 0x671d5ab3, 0x583e6b99, 0x51336097, 0x4a247d85, 0x4329768b, 0x34621fd1, 0x3d6f14df, 0x267809cd, 0x2f7502c3, 0x105633e9, 0x195b38e7, 0x024c25f5, 0x0b412efb, 0xd7618c9a, 0xde6c8794, 0xc57b9a86, 0xcc769188, 0xf355a0a2, 0xfa58abac, 0xe14fb6be, 0xe842bdb0, 0x9f09d4ea, 0x9604dfe4, 0x8d13c2f6, 0x841ec9f8, 0xbb3df8d2, 0xb230f3dc, 0xa927eece, 0xa02ae5c0, 0x47b13c7a, 0x4ebc3774, 0x55ab2a66, 0x5ca62168, 0x63851042, 0x6a881b4c, 0x719f065e, 0x78920d50, 0x0fd9640a, 0x06d46f04, 0x1dc37216, 0x14ce7918, 0x2bed4832, 0x22e0433c, 0x39f75e2e, 0x30fa5520, 0x9ab701ec, 0x93ba0ae2, 0x88ad17f0, 0x81a01cfe, 0xbe832dd4, 0xb78e26da, 0xac993bc8, 0xa59430c6, 0xd2df599c, 0xdbd25292, 0xc0c54f80, 0xc9c8448e, 0xf6eb75a4, 0xffe67eaa, 0xe4f163b8, 0xedfc68b6, 0x0a67b10c, 0x036aba02, 0x187da710, 0x1170ac1e, 0x2e539d34, 0x275e963a, 0x3c498b28, 0x35448026, 0x420fe97c, 0x4b02e272, 0x5015ff60, 0x5918f46e, 0x663bc544, 0x6f36ce4a, 0x7421d358, 0x7d2cd856, 0xa10c7a37, 0xa8017139, 0xb3166c2b, 0xba1b6725, 0x8538560f, 0x8c355d01, 0x97224013, 0x9e2f4b1d, 0xe9642247, 0xe0692949, 0xfb7e345b, 0xf2733f55, 0xcd500e7f, 0xc45d0571, 0xdf4a1863, 0xd647136d, 0x31dccad7, 0x38d1c1d9, 0x23c6dccb, 0x2acbd7c5, 0x15e8e6ef, 0x1ce5ede1, 0x07f2f0f3, 0x0efffbfd, 0x79b492a7, 0x70b999a9, 0x6bae84bb, 0x62a38fb5, 0x5d80be9f, 0x548db591, 0x4f9aa883, 0x4697a38d]);
        function AES() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            AES.prototype.__init__.apply(this, arguments);
        }
        AES.prototype.__init__ = function __init__(key) {
            var self = this;
            var rounds, round_key_count, KC, tk, index, rconpointer, t, tt, i, r, c;
            self.working_mem = _list_decorate([ new Uint32Array(4), new Uint32Array(4) ]);
            rounds = number_of_rounds[_bound_index(key.length, number_of_rounds)];
            if (!rounds) {
                throw new ValueError("invalid key size (must be length 16, 24 or 32)");
            }
            self._Ke = [];
            self._Kd = [];
            for (var i = 0; i <= rounds; i++) {
                self._Ke.push(new Uint32Array(4));
                self._Kd.push(new Uint32Array(4));
            }
            round_key_count = (rounds + 1) * 4;
            KC = key.length / 4;
            tk = new Uint32Array(KC);
            convert_to_int32(key, tk);
            index = 0;
            for (var i = 0; i < KC; i++) {
                index = i >> 2;
                (_expr_temp = (_expr_temp = self._Ke)[(typeof index === "number" && index < 0) ? _expr_temp.length + index : index])[_bound_index(i % 4, _expr_temp)] = tk[(typeof i === "number" && i < 0) ? tk.length + i : i];
                (_expr_temp = (_expr_temp = self._Kd)[_bound_index(rounds - index, _expr_temp)])[_bound_index(i % 4, _expr_temp)] = tk[(typeof i === "number" && i < 0) ? tk.length + i : i];
            }
            rconpointer = 0;
            t = KC;
            while (t < round_key_count) {
                tt = tk[_bound_index(KC - 1, tk)];
                tk[0] ^= S[_bound_index(tt >> 16 & 255, S)] << 24 ^ S[_bound_index(tt >> 8 & 255, S)] << 16 ^ S[_bound_index(tt & 255, S)] << 8 ^ S[_bound_index(tt >> 24 & 255, S)] ^ rcon[(typeof rconpointer === "number" && rconpointer < 0) ? rcon.length + rconpointer : rconpointer] << 24;
                rconpointer += 1;
                if ((KC !== 8 && (typeof KC !== "object" || _not_equals(KC, 8)))) {
                    for (var i = 1; i < KC; i++) {
                        tk[(typeof i === "number" && i < 0) ? tk.length + i : i] ^= tk[_bound_index(i - 1, tk)];
                    }
                } else {
                    for (var i = 1; i < (KC / 2); i++) {
                        tk[(typeof i === "number" && i < 0) ? tk.length + i : i] ^= tk[_bound_index(i - 1, tk)];
                    }
                    tt = tk[_bound_index(KC / 2 - 1, tk)];
                    tk[_bound_index(KC / 2, tk)] ^= S[_bound_index(tt & 255, S)] ^ S[_bound_index(tt >> 8 & 255, S)] << 8 ^ S[_bound_index(tt >> 16 & 255, S)] << 16 ^ S[_bound_index(tt >> 24 & 255, S)] << 24;
                    for (var i = (KC / 2) + 1; i < KC; i++) {
                        tk[(typeof i === "number" && i < 0) ? tk.length + i : i] ^= tk[_bound_index(i - 1, tk)];
                    }
                }
                i = 0;
                while (i < KC && t < round_key_count) {
                    r = t >> 2;
                    c = t % 4;
                    (_expr_temp = (_expr_temp = self._Ke)[(typeof r === "number" && r < 0) ? _expr_temp.length + r : r])[(typeof c === "number" && c < 0) ? _expr_temp.length + c : c] = tk[(typeof i === "number" && i < 0) ? tk.length + i : i];
                    (_expr_temp = (_expr_temp = self._Kd)[_bound_index(rounds - r, _expr_temp)])[(typeof c === "number" && c < 0) ? _expr_temp.length + c : c] = tk[_bound_index(i++, tk)];
                    t += 1;
                }
            }
            for (var r = 1; r < rounds; r++) {
                for (var c = 0; c < 4; c++) {
                    tt = (_expr_temp = (_expr_temp = self._Kd)[(typeof r === "number" && r < 0) ? _expr_temp.length + r : r])[(typeof c === "number" && c < 0) ? _expr_temp.length + c : c];
                    (_expr_temp = (_expr_temp = self._Kd)[(typeof r === "number" && r < 0) ? _expr_temp.length + r : r])[(typeof c === "number" && c < 0) ? _expr_temp.length + c : c] = U1[_bound_index(tt >> 24 & 255, U1)] ^ U2[_bound_index(tt >> 16 & 255, U2)] ^ U3[_bound_index(tt >> 8 & 255, U3)] ^ U4[_bound_index(tt & 255, U4)];
                }
            }
        };
        if (!AES.prototype.__init__.__argnames__) Object.defineProperties(AES.prototype.__init__, {
            __argnames__ : {value: ["key"]},
            __module__ : {value: "aes"}
        });
        AES.__argnames__ = AES.prototype.__init__.__argnames__;
        AES.__handles_kwarg_interpolation__ = AES.prototype.__init__.__handles_kwarg_interpolation__;
        AES.prototype._crypt = function _crypt(ciphertext, offset, encrypt) {
            var self = this;
            var R1, R2, R3, R4, o1, o3, SB, K, rounds, a, t, tt;
            if (encrypt) {
                R1 = T1;
                R2 = T2;
                R3 = T3;
                R4 = T4;
                o1 = 1;
                o3 = 3;
                SB = S;
                K = self._Ke;
            } else {
                R1 = T5;
                R2 = T6;
                R3 = T7;
                R4 = T8;
                o1 = 3;
                o3 = 1;
                SB = Si;
                K = self._Kd;
            }
            rounds = K.length - 1;
            a = self.working_mem[0];
            t = self.working_mem[1];
            for (var i = 0; i < 4; i++) {
                t[(typeof i === "number" && i < 0) ? t.length + i : i] ^= (_expr_temp = K[0])[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
            }
            for (var r = 1; r < rounds; r++) {
                for (var i = 0; i < 4; i++) {
                    a[(typeof i === "number" && i < 0) ? a.length + i : i] = R1[_bound_index(t[(typeof i === "number" && i < 0) ? t.length + i : i] >> 24 & 255, R1)] ^ R2[_bound_index(t[_bound_index((i + o1) % 4, t)] >> 16 & 255, R2)] ^ R3[_bound_index(t[_bound_index((i + 2) % 4, t)] >> 8 & 255, R3)] ^ R4[_bound_index(t[_bound_index((i + o3) % 4, t)] & 255, R4)] ^ (_expr_temp = K[(typeof r === "number" && r < 0) ? K.length + r : r])[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                }
                t.set(a);
            }
            for (var i = 0; i < 4; i++) {
                tt = (_expr_temp = K[(typeof rounds === "number" && rounds < 0) ? K.length + rounds : rounds])[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                ciphertext[_bound_index(offset + 4 * i, ciphertext)] = (SB[_bound_index(t[(typeof i === "number" && i < 0) ? t.length + i : i] >> 24 & 255, SB)] ^ tt >> 24) & 255;
                ciphertext[_bound_index(offset + 4 * i + 1, ciphertext)] = (SB[_bound_index(t[_bound_index((i + o1) % 4, t)] >> 16 & 255, SB)] ^ tt >> 16) & 255;
                ciphertext[_bound_index(offset + 4 * i + 2, ciphertext)] = (SB[_bound_index(t[_bound_index((i + 2) % 4, t)] >> 8 & 255, SB)] ^ tt >> 8) & 255;
                ciphertext[_bound_index(offset + 4 * i + 3, ciphertext)] = (SB[_bound_index(t[_bound_index((i + o3) % 4, t)] & 255, SB)] ^ tt) & 255;
            }
        };
        if (!AES.prototype._crypt.__argnames__) Object.defineProperties(AES.prototype._crypt, {
            __argnames__ : {value: ["ciphertext", "offset", "encrypt"]},
            __module__ : {value: "aes"}
        });
        AES.prototype.encrypt = function encrypt(plaintext, ciphertext, offset) {
            var self = this;
            convert_to_int32(plaintext, self.working_mem[1], offset, 16);
            return self._crypt(ciphertext, offset, true);
        };
        if (!AES.prototype.encrypt.__argnames__) Object.defineProperties(AES.prototype.encrypt, {
            __argnames__ : {value: ["plaintext", "ciphertext", "offset"]},
            __module__ : {value: "aes"}
        });
        AES.prototype.encrypt32 = function encrypt32(plaintext, ciphertext, offset) {
            var self = this;
            self.working_mem[1].set(plaintext);
            return self._crypt(ciphertext, offset, true);
        };
        if (!AES.prototype.encrypt32.__argnames__) Object.defineProperties(AES.prototype.encrypt32, {
            __argnames__ : {value: ["plaintext", "ciphertext", "offset"]},
            __module__ : {value: "aes"}
        });
        AES.prototype.decrypt = function decrypt(ciphertext, plaintext, offset) {
            var self = this;
            convert_to_int32(ciphertext, self.working_mem[1], offset, 16);
            return self._crypt(plaintext, offset, false);
        };
        if (!AES.prototype.decrypt.__argnames__) Object.defineProperties(AES.prototype.decrypt, {
            __argnames__ : {value: ["ciphertext", "plaintext", "offset"]},
            __module__ : {value: "aes"}
        });
        AES.prototype.decrypt32 = function decrypt32(ciphertext, plaintext, offset) {
            var self = this;
            self.working_mem[1].set(ciphertext);
            return self._crypt(plaintext, offset, false);
        };
        if (!AES.prototype.decrypt32.__argnames__) Object.defineProperties(AES.prototype.decrypt32, {
            __argnames__ : {value: ["ciphertext", "plaintext", "offset"]},
            __module__ : {value: "aes"}
        });
        AES.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        AES.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(AES.prototype, "__bases__", {value: []});

        function random_bytes_insecure(sz) {
            var ans;
            ans = new Uint8Array(sz);
            for (var i = 0; i < sz; i++) {
                ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = Math.floor(Math.random() * 256);
            }
            return ans;
        };
        if (!random_bytes_insecure.__argnames__) Object.defineProperties(random_bytes_insecure, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "aes"}
        });

        function random_bytes_secure(sz) {
            var ans;
            ans = new Uint8Array(sz);
            crypto.getRandomValues(ans);
            return ans;
        };
        if (!random_bytes_secure.__argnames__) Object.defineProperties(random_bytes_secure, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "aes"}
        });

        random_bytes = (typeof crypto !== "undefined" && typeof crypto.getRandomValues === "function") ? random_bytes_secure : random_bytes_insecure;
        if (random_bytes === random_bytes_insecure) {
            try {
                noderandom = require("crypto").randomBytes;
                random_bytes = (function() {
                    var _anonfunc = function (sz) {
                        return new Uint8Array(noderandom(sz));
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["sz"]},
                        __module__ : {value: "aes"}
                    });
                    return _anonfunc;
                })();
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    print("WARNING: Using insecure RNG for AES");
                } 
            }
        }
        function ModeOfOperation() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ModeOfOperation.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperties(ModeOfOperation.prototype,  {
            "key_as_js": {
                "enumerable": true, 
                "get": function key_as_js() {
                    var self = this;
                    return typed_array_as_js(self.key);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ModeOfOperation.prototype.__init__ = function __init__(key) {
            var self = this;
            self.key = key || generate_key(32);
            self.aes = new AES(self.key);
        };
        if (!ModeOfOperation.prototype.__init__.__argnames__) Object.defineProperties(ModeOfOperation.prototype.__init__, {
            __argnames__ : {value: ["key"]},
            __module__ : {value: "aes"}
        });
        ModeOfOperation.__argnames__ = ModeOfOperation.prototype.__init__.__argnames__;
        ModeOfOperation.__handles_kwarg_interpolation__ = ModeOfOperation.prototype.__init__.__handles_kwarg_interpolation__;
        ModeOfOperation.prototype.tag_as_bytes = function tag_as_bytes(tag) {
            var self = this;
            if (_instanceof(tag, Uint8Array)) {
                return tag;
            }
            if (!tag) {
                return new Uint8Array(0);
            }
            if (typeof tag === "string") {
                return string_to_bytes(tag);
            }
            throw new TypeError("Invalid tag, must be a string or a Uint8Array");
        };
        if (!ModeOfOperation.prototype.tag_as_bytes.__argnames__) Object.defineProperties(ModeOfOperation.prototype.tag_as_bytes, {
            __argnames__ : {value: ["tag"]},
            __module__ : {value: "aes"}
        });
        ModeOfOperation.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ModeOfOperation.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ModeOfOperation.prototype, "__bases__", {value: []});
        

        function GaloisField() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            GaloisField.prototype.__init__.apply(this, arguments);
        }
        GaloisField.prototype.__init__ = function __init__(sub_key) {
            var self = this;
            var k32;
            k32 = new Uint32Array(4);
            convert_to_int32(sub_key, k32, 0);
            self.m = self.generate_hash_table(k32);
            self.wmem = new Uint32Array(4);
        };
        if (!GaloisField.prototype.__init__.__argnames__) Object.defineProperties(GaloisField.prototype.__init__, {
            __argnames__ : {value: ["sub_key"]},
            __module__ : {value: "aes"}
        });
        GaloisField.__argnames__ = GaloisField.prototype.__init__.__argnames__;
        GaloisField.__handles_kwarg_interpolation__ = GaloisField.prototype.__init__.__handles_kwarg_interpolation__;
        GaloisField.prototype.power = function power(x, out) {
            var self = this;
            var lsb;
            lsb = x[3] & 1;
            for (var i = 3; i > 0; --i) {
                out[(typeof i === "number" && i < 0) ? out.length + i : i] = x[(typeof i === "number" && i < 0) ? x.length + i : i] >>> 1 | (x[_bound_index(i - 1, x)] & 1) << 31;
            }
            out[0] = x[0] >>> 1;
            if (lsb) {
                out[0] ^= 3774873600;
            }
        };
        if (!GaloisField.prototype.power.__argnames__) Object.defineProperties(GaloisField.prototype.power, {
            __argnames__ : {value: ["x", "out"]},
            __module__ : {value: "aes"}
        });
        GaloisField.prototype.multiply = function multiply(x, y) {
            var self = this;
            var z_i, v_i, x_i;
            z_i = new Uint32Array(4);
            v_i = new Uint32Array(y);
            for (var i = 0; i < 128; ++i) {
                x_i = x[_bound_index(i / 32 | 0, x)] & 1 << 31 - i % 32;
                if (x_i) {
                    z_i[0] ^= v_i[0];
                    z_i[1] ^= v_i[1];
                    z_i[2] ^= v_i[2];
                    z_i[3] ^= v_i[3];
                }
                self.power(v_i, v_i);
            }
            return z_i;
        };
        if (!GaloisField.prototype.multiply.__argnames__) Object.defineProperties(GaloisField.prototype.multiply, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "aes"}
        });
        GaloisField.prototype.generate_sub_hash_table = function generate_sub_hash_table(mid) {
            var self = this;
            var bits, size, half, m, i, m_i, m_j, x, y;
            bits = mid.length;
            size = 1 << bits;
            half = size >>> 1;
            m = new Array(size);
            m[(typeof half === "number" && half < 0) ? m.length + half : half] = new Uint32Array(mid);
            i = half >>> 1;
            while (i > 0) {
                m[(typeof i === "number" && i < 0) ? m.length + i : i] = new Uint32Array(4);
                self.power(m[_bound_index(2 * i, m)], m[(typeof i === "number" && i < 0) ? m.length + i : i]);
                i >>= 1;
            }
            i = 2;
            while (i < half) {
                for (var j = 1; j < i; ++j) {
                    m_i = m[(typeof i === "number" && i < 0) ? m.length + i : i];
                    m_j = m[(typeof j === "number" && j < 0) ? m.length + j : j];
                    m[_bound_index(i + j, m)] = x = new Uint32Array(4);
                    for (var c = 0; c < 4; c++) {
                        x[(typeof c === "number" && c < 0) ? x.length + c : c] = m_i[(typeof c === "number" && c < 0) ? m_i.length + c : c] ^ m_j[(typeof c === "number" && c < 0) ? m_j.length + c : c];
                    }
                }
                i *= 2;
            }
            m[0] = new Uint32Array(4);
            for (i = half + 1; i < size; ++i) {
                x = m[_bound_index(i ^ half, m)];
                m[(typeof i === "number" && i < 0) ? m.length + i : i] = y = new Uint32Array(4);
                for (var c = 0; c < 4; c++) {
                    y[(typeof c === "number" && c < 0) ? y.length + c : c] = mid[(typeof c === "number" && c < 0) ? mid.length + c : c] ^ x[(typeof c === "number" && c < 0) ? x.length + c : c];
                }
            }
            return m;
        };
        if (!GaloisField.prototype.generate_sub_hash_table.__argnames__) Object.defineProperties(GaloisField.prototype.generate_sub_hash_table, {
            __argnames__ : {value: ["mid"]},
            __module__ : {value: "aes"}
        });
        GaloisField.prototype.generate_hash_table = function generate_hash_table(key_as_int32_array) {
            var self = this;
            var bits, multiplier, per_int, size, ans, tmp, idx, shft;
            bits = key_as_int32_array.length;
            multiplier = 8 / bits;
            per_int = 4 * multiplier;
            size = 16 * multiplier;
            ans = new Array(size);
            for (var i =0; i < size; ++i) {
                tmp = new Uint32Array(4);
                idx = i / per_int | 0;
                shft = (per_int - 1 - i % per_int) * bits;
                tmp[(typeof idx === "number" && idx < 0) ? tmp.length + idx : idx] = 1 << bits - 1 << shft;
                ans[(typeof i === "number" && i < 0) ? ans.length + i : i] = self.generate_sub_hash_table(self.multiply(tmp, key_as_int32_array));
            }
            return ans;
        };
        if (!GaloisField.prototype.generate_hash_table.__argnames__) Object.defineProperties(GaloisField.prototype.generate_hash_table, {
            __argnames__ : {value: ["key_as_int32_array"]},
            __module__ : {value: "aes"}
        });
        GaloisField.prototype.table_multiply = function table_multiply(x) {
            var self = this;
            var z, idx, x_i, ah;
            z = new Uint32Array(4);
            for (var i = 0; i < 32; ++i) {
                idx = i / 8 | 0;
                x_i = x[(typeof idx === "number" && idx < 0) ? x.length + idx : idx] >>> (7 - i % 8) * 4 & 15;
                ah = (_expr_temp = (_expr_temp = self.m)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i])[(typeof x_i === "number" && x_i < 0) ? _expr_temp.length + x_i : x_i];
                z[0] ^= ah[0];
                z[1] ^= ah[1];
                z[2] ^= ah[2];
                z[3] ^= ah[3];
            }
            return z;
        };
        if (!GaloisField.prototype.table_multiply.__argnames__) Object.defineProperties(GaloisField.prototype.table_multiply, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "aes"}
        });
        GaloisField.prototype.ghash = function ghash(x, y) {
            var self = this;
            var z;
            z = self.wmem;
            z[0] = y[0] ^ x[0];
            z[1] = y[1] ^ x[1];
            z[2] = y[2] ^ x[2];
            z[3] = y[3] ^ x[3];
            return self.table_multiply(z);
        };
        if (!GaloisField.prototype.ghash.__argnames__) Object.defineProperties(GaloisField.prototype.ghash, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "aes"}
        });
        GaloisField.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        GaloisField.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(GaloisField.prototype, "__bases__", {value: []});

        function generate_key(sz) {
            if (!number_of_rounds[(typeof sz === "number" && sz < 0) ? number_of_rounds.length + sz : sz]) {
                throw new ValueError("Invalid key size, must be: 16, 24 or 32");
            }
            return random_bytes(sz);
        };
        if (!generate_key.__argnames__) Object.defineProperties(generate_key, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "aes"}
        });

        function generate_tag(sz) {
            return random_bytes(sz || 32);
        };
        if (!generate_tag.__argnames__) Object.defineProperties(generate_tag, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "aes"}
        });

        function typed_array_as_js(x) {
            var name;
            name = x.constructor.name || "Uint8Array";
            return "(new " + name + "(" + JSON.stringify(Array.prototype.slice.call(x)) + "))";
        };
        if (!typed_array_as_js.__argnames__) Object.defineProperties(typed_array_as_js, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "aes"}
        });

        function CBC() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            CBC.prototype.__init__.apply(this, arguments);
        }
        _extends(CBC, ModeOfOperation);
        CBC.prototype.__init__ = function __init__ () {
            ModeOfOperation.prototype.__init__ && ModeOfOperation.prototype.__init__.apply(this, arguments);
        };
        CBC.prototype.encrypt_bytes = function encrypt_bytes(bytes, tag_bytes, iv) {
            var self = this;
            var first_iv, mlen, padsz, inputbytes, offset, outputbytes, _unpack;
            iv = first_iv = iv || random_bytes(16);
            mlen = bytes.length + tag_bytes.length;
            padsz = (16 - mlen % 16) % 16;
            inputbytes = new Uint8Array(mlen + padsz);
            if (tag_bytes.length) {
                inputbytes.set(tag_bytes);
            }
            inputbytes.set(bytes, tag_bytes.length);
            offset = 0;
            outputbytes = new Uint8Array(inputbytes.length);
            for (var block = 0; block < inputbytes.length; block += 16) {
                if (block > 0) {
                    _unpack = [outputbytes, block - 16];
                    iv = _unpack[0];
                    offset = _unpack[1];
                }
                for (var i = 0; i < 16; i++) {
                    inputbytes[_bound_index(block + i, inputbytes)] ^= iv[_bound_index(offset + i, iv)];
                }
                self.aes.encrypt(inputbytes, outputbytes, block);
            }
            return (function(){
                var _d = {};
                _d["iv"] = first_iv;
                _d["cipherbytes"] = outputbytes;
                return _d;
            }).call(this);
        };
        if (!CBC.prototype.encrypt_bytes.__argnames__) Object.defineProperties(CBC.prototype.encrypt_bytes, {
            __argnames__ : {value: ["bytes", "tag_bytes", "iv"]},
            __module__ : {value: "aes"}
        });
        CBC.prototype.encrypt = function encrypt(plaintext, tag) {
            var self = this;
            return self.encrypt_bytes(string_to_bytes(plaintext), self.tag_as_bytes(tag));
        };
        if (!CBC.prototype.encrypt.__argnames__) Object.defineProperties(CBC.prototype.encrypt, {
            __argnames__ : {value: ["plaintext", "tag"]},
            __module__ : {value: "aes"}
        });
        CBC.prototype.decrypt_bytes = function decrypt_bytes(inputbytes, tag_bytes, iv) {
            var self = this;
            var offset, outputbytes, _unpack;
            offset = 0;
            outputbytes = new Uint8Array(inputbytes.length);
            for (var block = 0; block < inputbytes.length; block += 16) {
                self.aes.decrypt(inputbytes, outputbytes, block);
                if (block > 0) {
                    _unpack = [inputbytes, block - 16];
                    iv = _unpack[0];
                    offset = _unpack[1];
                }
                for (var i = 0; i < 16; i++) {
                    outputbytes[_bound_index(block + i, outputbytes)] ^= iv[_bound_index(offset + i, iv)];
                }
            }
            for (var i = 0; i < tag_bytes.length; i++) {
                if ((tag_bytes[(typeof i === "number" && i < 0) ? tag_bytes.length + i : i] !== outputbytes[(typeof i === "number" && i < 0) ? outputbytes.length + i : i] && (typeof tag_bytes[(typeof i === "number" && i < 0) ? tag_bytes.length + i : i] !== "object" || _not_equals(tag_bytes[(typeof i === "number" && i < 0) ? tag_bytes.length + i : i], outputbytes[(typeof i === "number" && i < 0) ? outputbytes.length + i : i])))) {
                    throw new ValueError("Corrupt message");
                }
            }
            outputbytes = outputbytes.subarray(tag_bytes.length);
            return outputbytes;
        };
        if (!CBC.prototype.decrypt_bytes.__argnames__) Object.defineProperties(CBC.prototype.decrypt_bytes, {
            __argnames__ : {value: ["inputbytes", "tag_bytes", "iv"]},
            __module__ : {value: "aes"}
        });
        CBC.prototype.decrypt = function decrypt(output_from_encrypt, tag) {
            var self = this;
            var ans;
            ans = self.decrypt_bytes(output_from_encrypt.cipherbytes, self.tag_as_bytes(tag), output_from_encrypt.iv);
            return str.rstrip(bytes_to_string(ans), "\u0000");
        };
        if (!CBC.prototype.decrypt.__argnames__) Object.defineProperties(CBC.prototype.decrypt, {
            __argnames__ : {value: ["output_from_encrypt", "tag"]},
            __module__ : {value: "aes"}
        });
        CBC.prototype.__repr__ = function __repr__ () {
            if(ModeOfOperation.prototype.__repr__) return ModeOfOperation.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        CBC.prototype.__str__ = function __str__ () {
            if(ModeOfOperation.prototype.__str__) return ModeOfOperation.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(CBC.prototype, "__bases__", {value: [ModeOfOperation]});

        function CTR() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            CTR.prototype.__init__.apply(this, arguments);
        }
        _extends(CTR, ModeOfOperation);
        CTR.prototype.__init__ = function __init__(key, iv) {
            var self = this;
            ModeOfOperation.prototype.__init__.call(self, key);
            self.wmem = new Uint8Array(16);
            self.counter_block = new Uint8Array(iv || 16);
            if ((self.counter_block.length !== 16 && (typeof self.counter_block.length !== "object" || _not_equals(self.counter_block.length, 16)))) {
                throw new ValueError("iv must be 16 bytes long");
            }
            self.counter_index = 16;
        };
        if (!CTR.prototype.__init__.__argnames__) Object.defineProperties(CTR.prototype.__init__, {
            __argnames__ : {value: ["key", "iv"]},
            __module__ : {value: "aes"}
        });
        CTR.__argnames__ = CTR.prototype.__init__.__argnames__;
        CTR.__handles_kwarg_interpolation__ = CTR.prototype.__init__.__handles_kwarg_interpolation__;
        CTR.prototype._crypt = function _crypt(bytes) {
            var self = this;
            for (var i = 0; i < bytes.length; i++, self.counter_index++) {
                if (self.counter_index === 16) {
                    self.counter_index = 0;
                    self.aes.encrypt(self.counter_block, self.wmem, 0);
                    increment_counter(self.counter_block);
                }
                bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i] ^= (_expr_temp = self.wmem)[_bound_index(self.counter_index, _expr_temp)];
            }
            self.counter_index = 16;
        };
        if (!CTR.prototype._crypt.__argnames__) Object.defineProperties(CTR.prototype._crypt, {
            __argnames__ : {value: ["bytes"]},
            __module__ : {value: "aes"}
        });
        CTR.prototype.encrypt = function encrypt(plaintext, tag) {
            var self = this;
            var outbytes, counterbytes, tag_bytes, t;
            outbytes = string_to_bytes(plaintext);
            counterbytes = new Uint8Array(self.counter_block);
            if (tag) {
                tag_bytes = self.tag_as_bytes(tag);
                t = new Uint8Array(outbytes.length + tag_bytes.length);
                t.set(tag_bytes);
                t.set(outbytes, tag_bytes.length);
                outbytes = t;
            }
            self._crypt(outbytes);
            return (function(){
                var _d = {};
                _d["cipherbytes"] = outbytes;
                _d["counterbytes"] = counterbytes;
                return _d;
            }).call(this);
        };
        if (!CTR.prototype.encrypt.__argnames__) Object.defineProperties(CTR.prototype.encrypt, {
            __argnames__ : {value: ["plaintext", "tag"]},
            __module__ : {value: "aes"}
        });
        CTR.prototype.__enter__ = function __enter__() {
            var self = this;
            self.before_index = self.counter_index;
            self.before_counter = new Uint8Array(self.counter_block);
        };
        if (!CTR.prototype.__enter__.__module__) Object.defineProperties(CTR.prototype.__enter__, {
            __module__ : {value: "aes"}
        });
        CTR.prototype.__exit__ = function __exit__() {
            var self = this;
            self.counter_index = self.before_index;
            self.counter_block = self.before_counter;
        };
        if (!CTR.prototype.__exit__.__module__) Object.defineProperties(CTR.prototype.__exit__, {
            __module__ : {value: "aes"}
        });
        CTR.prototype.decrypt = function decrypt(output_from_encrypt, tag) {
            var self = this;
            var b, _with_exception, _with_suppress, offset, tag_bytes;
            b = new Uint8Array(output_from_encrypt.cipherbytes);
            _with_exception = undefined;
            var _with_clause_1 = self;
            _with_clause_1.__enter__();
            try {
                {
                    self.counter_block = output_from_encrypt.counterbytes;
                    self.counter_index = 16;
                    self._crypt(b);
                }
            } catch(e){
                _with_exception = e;
            }
            if (_with_exception === undefined){
                _with_clause_1.__exit__();
            } else {
                _with_suppress = false;
                _with_suppress |= _bool(_with_clause_1.__exit__(_with_exception.constructor, _with_exception, _with_exception.stack));
                if (!_with_suppress) throw _with_exception;
            }
            offset = 0;
            if (tag) {
                tag_bytes = self.tag_as_bytes(tag);
                for (var i = 0; i < tag_bytes.length; i++) {
                    if ((tag_bytes[(typeof i === "number" && i < 0) ? tag_bytes.length + i : i] !== b[(typeof i === "number" && i < 0) ? b.length + i : i] && (typeof tag_bytes[(typeof i === "number" && i < 0) ? tag_bytes.length + i : i] !== "object" || _not_equals(tag_bytes[(typeof i === "number" && i < 0) ? tag_bytes.length + i : i], b[(typeof i === "number" && i < 0) ? b.length + i : i])))) {
                        throw new ValueError("Corrupted message");
                    }
                }
                offset = tag_bytes.length;
            }
            return bytes_to_string(b, offset);
        };
        if (!CTR.prototype.decrypt.__argnames__) Object.defineProperties(CTR.prototype.decrypt, {
            __argnames__ : {value: ["output_from_encrypt", "tag"]},
            __module__ : {value: "aes"}
        });
        CTR.prototype.__repr__ = function __repr__ () {
            if(ModeOfOperation.prototype.__repr__) return ModeOfOperation.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        CTR.prototype.__str__ = function __str__ () {
            if(ModeOfOperation.prototype.__str__) return ModeOfOperation.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(CTR.prototype, "__bases__", {value: [ModeOfOperation]});

        function GCM() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            GCM.prototype.__init__.apply(this, arguments);
        }
        _extends(GCM, ModeOfOperation);
        GCM.prototype.__init__ = function __init__() {
            var self = this;
            var key = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var random_iv = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.random_iv : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "random_iv")){
                random_iv = _kwargs_obj.random_iv;
            }
            var H;
            ModeOfOperation.prototype.__init__.call(self, key);
            self.random_iv = random_iv;
            if (!random_iv) {
                self.current_iv = new Uint8Array(12);
            }
            H = new Uint8Array(16);
            self.aes.encrypt(new Uint8Array(16), H, 0);
            self.galois = new GaloisField(H);
            self.J0 = new Uint32Array(4);
            self.wmem = new Uint32Array(4);
            self.byte_block = new Uint8Array(16);
        };
        if (!GCM.prototype.__init__.__defaults__) Object.defineProperties(GCM.prototype.__init__, {
            __defaults__ : {value: {random_iv:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["key", "random_iv"]},
            __module__ : {value: "aes"}
        });
        GCM.__argnames__ = GCM.prototype.__init__.__argnames__;
        GCM.__handles_kwarg_interpolation__ = GCM.prototype.__init__.__handles_kwarg_interpolation__;
        GCM.prototype.increment_iv = function increment_iv() {
            var self = this;
            var c;
            c = self.current_iv;
            for (var i = 11; i >=0; i--) {
                if (c[(typeof i === "number" && i < 0) ? c.length + i : i] === 255) {
                    if (i === 0) {
                        throw new ValueError("The GCM IV space is exhausted, cannot encrypt anymore messages with this key as doing so would cause the IV to repeat");
                    }
                    c[(typeof i === "number" && i < 0) ? c.length + i : i] = 0;
                } else {
                    c[(typeof i === "number" && i < 0) ? c.length + i : i] += 1;
                    break;
                }
            }
        };
        if (!GCM.prototype.increment_iv.__module__) Object.defineProperties(GCM.prototype.increment_iv, {
            __module__ : {value: "aes"}
        });
        GCM.prototype._create_j0 = function _create_j0(iv) {
            var self = this;
            var J0, tmp;
            J0 = self.J0;
            if (iv.length === 12) {
                convert_to_int32(iv, J0);
                J0[3] = 1;
            } else {
                J0.fill(0);
                tmp = convert_to_int32_pad(iv);
                while (tmp.length) {
                    J0 = self.galois.ghash(J0, tmp);
                    tmp = tmp.subarray(4);
                }
                tmp = new Uint32Array(4);
                tmp.set(from_64_to_32(iv.length * 8), 2);
                J0 = self.galois.ghash(J0, tmp);
            }
            return J0;
        };
        if (!GCM.prototype._create_j0.__argnames__) Object.defineProperties(GCM.prototype._create_j0, {
            __argnames__ : {value: ["iv"]},
            __module__ : {value: "aes"}
        });
        GCM.prototype._start = function _start(iv, additional_data) {
            var self = this;
            var J0, in_block, S, overflow;
            J0 = self._create_j0(iv);
            in_block = new Uint32Array(J0);
            in_block[3] = in_block[3] + 1 & 4294967295;
            S = new Uint32Array(4);
            overflow = additional_data.length % 16;
            for (var i = 0; i < additional_data.length - overflow; i += 16) {
                convert_to_int32(additional_data, self.wmem, i, 16);
                S = self.galois.ghash(S, self.wmem);
            }
            if (overflow) {
                self.byte_block.fill(0);
                self.byte_block.set(additional_data.subarray(additional_data.length - overflow));
                convert_to_int32(self.byte_block, self.wmem);
                S = self.galois.ghash(S, self.wmem);
            }
            return [J0, in_block, S];
        };
        if (!GCM.prototype._start.__argnames__) Object.defineProperties(GCM.prototype._start, {
            __argnames__ : {value: ["iv", "additional_data"]},
            __module__ : {value: "aes"}
        });
        GCM.prototype._finish = function _finish(iv, J0, adata_len, S, outbytes) {
            var self = this;
            var lengths, tag;
            lengths = new Uint32Array(4);
            lengths.set(from_64_to_32(adata_len * 8));
            lengths.set(from_64_to_32(outbytes.length * 8), 2);
            S = self.galois.ghash(S, lengths);
            self.aes.encrypt32(J0, self.byte_block, 0);
            convert_to_int32(self.byte_block, self.wmem);
            tag = new Uint32Array(4);
            for (var i = 0; i < S.length; i++) {
                tag[(typeof i === "number" && i < 0) ? tag.length + i : i] = S[(typeof i === "number" && i < 0) ? S.length + i : i] ^ (_expr_temp = self.wmem)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
            }
            return (function(){
                var _d = {};
                _d["iv"] = iv;
                _d["cipherbytes"] = outbytes;
                _d["tag"] = tag;
                return _d;
            }).call(this);
        };
        if (!GCM.prototype._finish.__argnames__) Object.defineProperties(GCM.prototype._finish, {
            __argnames__ : {value: ["iv", "J0", "adata_len", "S", "outbytes"]},
            __module__ : {value: "aes"}
        });
        GCM.prototype._crypt = function _crypt(iv, bytes, additional_data, decrypt) {
            var self = this;
            var ghash, outbytes, _unpack, J0, in_block, S, bb, enc, hash_bytes, counter_index, overflow;
            ghash = self.galois.ghash.bind(self.galois);
            outbytes = new Uint8Array(bytes.length);
            _unpack = self._start(iv, additional_data);
_unpack = _unpack_asarray(3, _unpack);
            J0 = _unpack[0];
            in_block = _unpack[1];
            S = _unpack[2];
            bb = self.byte_block;
            enc = self.aes.encrypt32.bind(self.aes);
            hash_bytes = (decrypt) ? bytes : outbytes;
            for (var i = 0, counter_index = 16; i < bytes.length; i++, counter_index++) {
                if (counter_index === 16) {
                    enc(in_block, bb, 0);
                    in_block[3] = in_block[3] + 1 & 4294967295;
                    counter_index = 0;
                }
                outbytes[(typeof i === "number" && i < 0) ? outbytes.length + i : i] = bytes[(typeof i === "number" && i < 0) ? bytes.length + i : i] ^ bb[(typeof counter_index === "number" && counter_index < 0) ? bb.length + counter_index : counter_index];
                if (counter_index === 15) {
                    convert_to_int32(hash_bytes, self.wmem, i - 15, 16);
                    S = ghash(S, self.wmem);
                }
            }
            overflow = outbytes.length % 16;
            if (overflow) {
                bb.fill(0);
                bb.set(hash_bytes.subarray(hash_bytes.length - overflow));
                convert_to_int32(bb, self.wmem);
                S = ghash(S, self.wmem);
            }
            return self._finish(iv, J0, additional_data.length, S, outbytes);
        };
        if (!GCM.prototype._crypt.__argnames__) Object.defineProperties(GCM.prototype._crypt, {
            __argnames__ : {value: ["iv", "bytes", "additional_data", "decrypt"]},
            __module__ : {value: "aes"}
        });
        GCM.prototype.encrypt = function encrypt(plaintext, tag) {
            var self = this;
            var iv;
            if (self.random_iv) {
                iv = random_bytes(12);
            } else {
                self.increment_iv();
                iv = self.current_iv;
            }
            return self._crypt(iv, string_to_bytes(plaintext), self.tag_as_bytes(tag), false);
        };
        if (!GCM.prototype.encrypt.__argnames__) Object.defineProperties(GCM.prototype.encrypt, {
            __argnames__ : {value: ["plaintext", "tag"]},
            __module__ : {value: "aes"}
        });
        GCM.prototype.decrypt = function decrypt(output_from_encrypt, tag) {
            var self = this;
            var ans;
            if ((output_from_encrypt.tag.length !== 4 && (typeof output_from_encrypt.tag.length !== "object" || _not_equals(output_from_encrypt.tag.length, 4)))) {
                throw new ValueError("Corrupted message");
            }
            ans = self._crypt(output_from_encrypt.iv, output_from_encrypt.cipherbytes, self.tag_as_bytes(tag), true);
            if ((ans.tag !== output_from_encrypt.tag && (typeof ans.tag !== "object" || _not_equals(ans.tag, output_from_encrypt.tag)))) {
                throw new ValueError("Corrupted message");
            }
            return bytes_to_string(ans.cipherbytes);
        };
        if (!GCM.prototype.decrypt.__argnames__) Object.defineProperties(GCM.prototype.decrypt, {
            __argnames__ : {value: ["output_from_encrypt", "tag"]},
            __module__ : {value: "aes"}
        });
        GCM.prototype.__repr__ = function __repr__ () {
            if(ModeOfOperation.prototype.__repr__) return ModeOfOperation.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        GCM.prototype.__str__ = function __str__ () {
            if(ModeOfOperation.prototype.__str__) return ModeOfOperation.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(GCM.prototype, "__bases__", {value: [ModeOfOperation]});

        _modules.aes.string_to_bytes = string_to_bytes;
        _modules.aes.bytes_to_string = bytes_to_string;
        _modules.aes.number_of_rounds = number_of_rounds;
        _modules.aes.rcon = rcon;
        _modules.aes.S = S;
        _modules.aes.Si = Si;
        _modules.aes.T1 = T1;
        _modules.aes.T2 = T2;
        _modules.aes.T3 = T3;
        _modules.aes.T4 = T4;
        _modules.aes.T5 = T5;
        _modules.aes.T6 = T6;
        _modules.aes.T7 = T7;
        _modules.aes.T8 = T8;
        _modules.aes.U1 = U1;
        _modules.aes.U2 = U2;
        _modules.aes.U3 = U3;
        _modules.aes.U4 = U4;
        _modules.aes.random_bytes = random_bytes;
        _modules.aes.noderandom = noderandom;
        _modules.aes.string_to_bytes_encoder = string_to_bytes_encoder;
        _modules.aes.string_to_bytes_slow = string_to_bytes_slow;
        _modules.aes.as_hex = as_hex;
        _modules.aes.bytes_to_string_decoder = bytes_to_string_decoder;
        _modules.aes.bytes_to_string_slow = bytes_to_string_slow;
        _modules.aes.increment_counter = increment_counter;
        _modules.aes.convert_to_int32 = convert_to_int32;
        _modules.aes.convert_to_int32_pad = convert_to_int32_pad;
        _modules.aes.from_64_to_32 = from_64_to_32;
        _modules.aes.AES = AES;
        _modules.aes.random_bytes_insecure = random_bytes_insecure;
        _modules.aes.random_bytes_secure = random_bytes_secure;
        _modules.aes.ModeOfOperation = ModeOfOperation;
        _modules.aes.GaloisField = GaloisField;
        _modules.aes.generate_key = generate_key;
        _modules.aes.generate_tag = generate_tag;
        _modules.aes.typed_array_as_js = typed_array_as_js;
        _modules.aes.CBC = CBC;
        _modules.aes.CTR = CTR;
        _modules.aes.GCM = GCM;
    })();

    (function(){
        var __name__ = "read_book.globals";
        var _boss, dark_link_color, uid, default_color_schemes, IN_DEVELOP_MODE, runtime, ui_operations, annot_id_uuid_map;
        var random_bytes = _modules.aes.random_bytes;

        var hexlify = _modules.encodings.hexlify;

        var _ = _modules.gettext.gettext;
        var register_callback = _modules.gettext.register_callback;
        var gt = _modules.gettext.gettext;

        _boss = null;
        dark_link_color = "#6cb4ee";
        function set_boss(b) {
            _boss = b;
        };
        if (!set_boss.__argnames__) Object.defineProperties(set_boss, {
            __argnames__ : {value: ["b"]},
            __module__ : {value: "read_book.globals"}
        });

        function get_boss() {
            return _boss;
        };
        if (!get_boss.__module__) Object.defineProperties(get_boss, {
            __module__ : {value: "read_book.globals"}
        });

        function current_book() {
            return current_book.book;
        };
        if (!current_book.__module__) Object.defineProperties(current_book, {
            __module__ : {value: "read_book.globals"}
        });

        current_book.book = null;
        function rtl_page_progression() {
            return (current_book().manifest.page_progression_direction === "rtl" || typeof current_book().manifest.page_progression_direction === "object" && _equals(current_book().manifest.page_progression_direction, "rtl"));
        };
        if (!rtl_page_progression.__module__) Object.defineProperties(rtl_page_progression, {
            __module__ : {value: "read_book.globals"}
        });

        function ltr_page_progression() {
            return !rtl_page_progression();
        };
        if (!ltr_page_progression.__module__) Object.defineProperties(ltr_page_progression, {
            __module__ : {value: "read_book.globals"}
        });

        uid = "calibre-" + hexlify(random_bytes(12));
        function viewport_mode_changer(val) {
            if (val) {
                viewport_mode_changer.val = val;
            }
            return viewport_mode_changer.val;
        };
        if (!viewport_mode_changer.__argnames__) Object.defineProperties(viewport_mode_changer, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "read_book.globals"}
        });

        function current_layout_mode() {
            return current_layout_mode.value;
        };
        if (!current_layout_mode.__module__) Object.defineProperties(current_layout_mode, {
            __module__ : {value: "read_book.globals"}
        });

        current_layout_mode.value = "flow";
        function set_layout_mode(val) {
            current_layout_mode.value = val;
            viewport_mode_changer()(val);
        };
        if (!set_layout_mode.__argnames__) Object.defineProperties(set_layout_mode, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "read_book.globals"}
        });

        function current_spine_item() {
            return current_spine_item.value;
        };
        if (!current_spine_item.__module__) Object.defineProperties(current_spine_item, {
            __module__ : {value: "read_book.globals"}
        });

        current_spine_item.value = null;
        function set_current_spine_item(val) {
            current_spine_item.value = val;
        };
        if (!set_current_spine_item.__argnames__) Object.defineProperties(set_current_spine_item, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "read_book.globals"}
        });

        function toc_anchor_map() {
            return toc_anchor_map.value;
        };
        if (!toc_anchor_map.__module__) Object.defineProperties(toc_anchor_map, {
            __module__ : {value: "read_book.globals"}
        });

        function set_toc_anchor_map(val) {
            toc_anchor_map.value = val;
        };
        if (!set_toc_anchor_map.__argnames__) Object.defineProperties(set_toc_anchor_map, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "read_book.globals"}
        });

        default_color_schemes = (function(){
            var _d = Object.create(null);
            _d["system"] = (function(){
                var _d = Object.create(null);
                _d["foreground"] = "#000000";
                _d["background"] = "#ffffff";
                _d["name"] = _("System");
                return _d;
            }).call(this);
            _d["white"] = (function(){
                var _d = Object.create(null);
                _d["foreground"] = "#000000";
                _d["background"] = "#ffffff";
                _d["name"] = _("White");
                return _d;
            }).call(this);
            _d["black"] = (function(){
                var _d = Object.create(null);
                _d["foreground"] = "#ffffff";
                _d["background"] = "#000000";
                _d["link"] = "#4f81bd";
                _d["name"] = _("Black");
                return _d;
            }).call(this);
            _d["sepia-light"] = (function(){
                var _d = Object.create(null);
                _d["foreground"] = "#39322B";
                _d["background"] = "#F6F3E9";
                _d["name"] = _("Sepia light");
                return _d;
            }).call(this);
            _d["sepia-dark"] = (function(){
                var _d = Object.create(null);
                _d["background"] = "#39322B";
                _d["foreground"] = "#F6F3E9";
                _d["link"] = "#4f81bd";
                _d["name"] = _("Sepia dark");
                return _d;
            }).call(this);
            return _d;
        }).call(this);
        function set_system_colors(spec) {
            var c;
            c = default_color_schemes.system;
            c.foreground = spec.foreground;
            c.background = spec.background;
            delete c.link;
            if (spec.link) {
                c.link = spec.link;
            }
        };
        if (!set_system_colors.__argnames__) Object.defineProperties(set_system_colors, {
            __argnames__ : {value: ["spec"]},
            __module__ : {value: "read_book.globals"}
        });

        register_callback((function() {
            var _anonfunc = function () {
                var scheme, key;
                var _Iter0 = _Iterable(default_color_schemes);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    key = _Iter0[_Index0];
                    scheme = default_color_schemes[(typeof key === "number" && key < 0) ? default_color_schemes.length + key : key];
                    scheme.name = gt(scheme.name);
                }
                if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                    set_system_colors((function(){
                        var _d = Object.create(null);
                        _d["background"] = "#111";
                        _d["foreground"] = "#ddd";
                        _d["link"] = dark_link_color;
                        return _d;
                    }).call(this));
                }
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.globals"}
            });
            return _anonfunc;
        })());
        IN_DEVELOP_MODE = "__IN_DEVELOP_MODE__";
        runtime = (function(){
            var _d = Object.create(null);
            _d["is_standalone_viewer"] = false;
            _d["viewer_in_full_screen"] = false;
            _d["in_develop_mode"] = IN_DEVELOP_MODE === "1";
            _d["QT_VERSION"] = 0;
            return _d;
        }).call(this);
        ui_operations = (function(){
            var _d = Object.create(null);
            _d["get_file"] = null;
            _d["get_mathjax_files"] = null;
            _d["update_url_state"] = null;
            _d["update_last_read_time"] = null;
            _d["show_error"] = null;
            _d["redisplay_book"] = null;
            _d["reload_book"] = null;
            _d["forward_gesture"] = null;
            _d["update_color_scheme"] = null;
            _d["update_font_size"] = null;
            _d["goto_cfi"] = null;
            _d["delete_book"] = null;
            _d["focus_iframe"] = null;
            _d["toggle_toc"] = null;
            _d["toggle_full_screen"] = null;
            return _d;
        }).call(this);
        annot_id_uuid_map = Object.create(null);
        function clear_annot_id_uuid_map() {
            var key;
            var _Iter1 = _Iterable(Object.keys(annot_id_uuid_map));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                key = _Iter1[_Index1];
                delete annot_id_uuid_map[key];
            }
        };
        if (!clear_annot_id_uuid_map.__module__) Object.defineProperties(clear_annot_id_uuid_map, {
            __module__ : {value: "read_book.globals"}
        });

        function is_dark_theme(set_val) {
            if ((typeof set_val !== "undefined" && set_val !== null)) {
                is_dark_theme.ans = set_val;
            }
            return !!is_dark_theme.ans;
        };
        if (!is_dark_theme.__argnames__) Object.defineProperties(is_dark_theme, {
            __argnames__ : {value: ["set_val"]},
            __module__ : {value: "read_book.globals"}
        });

        _modules["read_book.globals"]._boss = _boss;
        _modules["read_book.globals"].dark_link_color = dark_link_color;
        _modules["read_book.globals"].uid = uid;
        _modules["read_book.globals"].default_color_schemes = default_color_schemes;
        _modules["read_book.globals"].IN_DEVELOP_MODE = IN_DEVELOP_MODE;
        _modules["read_book.globals"].runtime = runtime;
        _modules["read_book.globals"].ui_operations = ui_operations;
        _modules["read_book.globals"].annot_id_uuid_map = annot_id_uuid_map;
        _modules["read_book.globals"].set_boss = set_boss;
        _modules["read_book.globals"].get_boss = get_boss;
        _modules["read_book.globals"].current_book = current_book;
        _modules["read_book.globals"].rtl_page_progression = rtl_page_progression;
        _modules["read_book.globals"].ltr_page_progression = ltr_page_progression;
        _modules["read_book.globals"].viewport_mode_changer = viewport_mode_changer;
        _modules["read_book.globals"].current_layout_mode = current_layout_mode;
        _modules["read_book.globals"].set_layout_mode = set_layout_mode;
        _modules["read_book.globals"].current_spine_item = current_spine_item;
        _modules["read_book.globals"].set_current_spine_item = set_current_spine_item;
        _modules["read_book.globals"].toc_anchor_map = toc_anchor_map;
        _modules["read_book.globals"].set_toc_anchor_map = set_toc_anchor_map;
        _modules["read_book.globals"].set_system_colors = set_system_colors;
        _modules["read_book.globals"].clear_annot_id_uuid_map = clear_annot_id_uuid_map;
        _modules["read_book.globals"].is_dark_theme = is_dark_theme;
    })();

    (function(){
        var __name__ = "read_book.viewport";
        var FUNCTIONS, scroll_viewport, attr;
        FUNCTIONS = "x y scroll_to scroll_into_view reset_globals __reset_transforms window_scroll_pos content_size".split(" ");
        var get_boss = _modules["read_book.globals"].get_boss;
        var viewport_mode_changer = _modules["read_book.globals"].viewport_mode_changer;

        var document_height = _modules.utils.document_height;
        var document_width = _modules.utils.document_width;
        var ios_major_version = _modules.utils.ios_major_version;

        function ScrollViewport() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ScrollViewport.prototype.__bind_methods__.call(this);
            ScrollViewport.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ScrollViewport.prototype, "__bind_methods__", {value: function () {
            this.set_mode = ScrollViewport.prototype.set_mode.bind(this);
            this.initialize_on_layout = ScrollViewport.prototype.initialize_on_layout.bind(this);
            this.flow_x = ScrollViewport.prototype.flow_x.bind(this);
            this.flow_y = ScrollViewport.prototype.flow_y.bind(this);
            this.flow_window_scroll_pos = ScrollViewport.prototype.flow_window_scroll_pos.bind(this);
            this.inline_pos = ScrollViewport.prototype.inline_pos.bind(this);
            this.block_pos = ScrollViewport.prototype.block_pos.bind(this);
            this.flow_scroll_to = ScrollViewport.prototype.flow_scroll_to.bind(this);
            this.scroll_to_in_inline_direction = ScrollViewport.prototype.scroll_to_in_inline_direction.bind(this);
            this.scroll_to_in_block_direction = ScrollViewport.prototype.scroll_to_in_block_direction.bind(this);
            this.flow_scroll_into_view = ScrollViewport.prototype.flow_scroll_into_view.bind(this);
            this.scroll_by = ScrollViewport.prototype.scroll_by.bind(this);
            this.scroll_by_in_inline_direction = ScrollViewport.prototype.scroll_by_in_inline_direction.bind(this);
            this.scroll_by_in_block_direction = ScrollViewport.prototype.scroll_by_in_block_direction.bind(this);
            this.flow_reset_globals = ScrollViewport.prototype.flow_reset_globals.bind(this);
            this.flow___reset_transforms = ScrollViewport.prototype.flow___reset_transforms.bind(this);
            this.flow_content_size = ScrollViewport.prototype.flow_content_size.bind(this);
            this.paged_content_inline_size = ScrollViewport.prototype.paged_content_inline_size.bind(this);
            this.paged_content_block_size = ScrollViewport.prototype.paged_content_block_size.bind(this);
            this.inline_size = ScrollViewport.prototype.inline_size.bind(this);
            this.block_size = ScrollViewport.prototype.block_size.bind(this);
            this.update_window_size = ScrollViewport.prototype.update_window_size.bind(this);
            this.width = ScrollViewport.prototype.width.bind(this);
            this.height = ScrollViewport.prototype.height.bind(this);
            this.document_inline_size = ScrollViewport.prototype.document_inline_size.bind(this);
            this.document_block_size = ScrollViewport.prototype.document_block_size.bind(this);
            this.viewport_to_document = ScrollViewport.prototype.viewport_to_document.bind(this);
            this.rect_inline_start = ScrollViewport.prototype.rect_inline_start.bind(this);
            this.rect_inline_end = ScrollViewport.prototype.rect_inline_end.bind(this);
            this.rect_block_start = ScrollViewport.prototype.rect_block_start.bind(this);
            this.rect_block_end = ScrollViewport.prototype.rect_block_end.bind(this);
            this.rect_inline_size = ScrollViewport.prototype.rect_inline_size.bind(this);
            this.rect_block_size = ScrollViewport.prototype.rect_block_size.bind(this);
            this.viewport_to_document_inline = ScrollViewport.prototype.viewport_to_document_inline.bind(this);
            this.viewport_to_document_block = ScrollViewport.prototype.viewport_to_document_block.bind(this);
            this.viewport_to_document_inline_block = ScrollViewport.prototype.viewport_to_document_inline_block.bind(this);
        }});
        ScrollViewport.prototype.__init__ = function __init__() {
            var self = this;
            self.set_mode("flow");
            self.window_width_from_parent = self.window_height_from_parent = null;
            self.rtl = false;
            self.ltr = true;
            self.vertical_writing_mode = false;
            self.horizontal_writing_mode = true;
        };
        if (!ScrollViewport.prototype.__init__.__module__) Object.defineProperties(ScrollViewport.prototype.__init__, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.__argnames__ = ScrollViewport.prototype.__init__.__argnames__;
        ScrollViewport.__handles_kwarg_interpolation__ = ScrollViewport.prototype.__init__.__handles_kwarg_interpolation__;
        ScrollViewport.prototype.set_mode = function set_mode(mode) {
            var self = this;
            var prefix, attr;
            prefix = ((mode === "flow") ? "flow" : "paged") + "_";
            var _Iter0 = _Iterable(FUNCTIONS);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                attr = _Iter0[_Index0];
                self[(typeof attr === "number" && attr < 0) ? self.length + attr : attr] = self[_bound_index(prefix + attr, self)];
            }
        };
        if (!ScrollViewport.prototype.set_mode.__argnames__) Object.defineProperties(ScrollViewport.prototype.set_mode, {
            __argnames__ : {value: ["mode"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.initialize_on_layout = function initialize_on_layout(body_style) {
            var self = this;
            var css_vertical_rl, css_vertical_lr;
            self.horizontal_writing_mode = true;
            self.vertical_writing_mode = false;
            self.ltr = true;
            self.rtl = false;
            if (body_style.direction === "rtl") {
                self.rtl = true;
                self.ltr = false;
            }
            css_vertical_rl = body_style.getPropertyValue("writing-mode") === "vertical-rl";
            if (css_vertical_rl) {
                self.vertical_writing_mode = true;
                self.horizontal_writing_mode = false;
                self.rtl = true;
                self.ltr = false;
            } else {
                css_vertical_lr = body_style.getPropertyValue("writing-mode") === "vertical-lr";
                if (css_vertical_lr) {
                    self.vertical_writing_mode = true;
                    self.horizontal_writing_mode = false;
                    self.ltr = true;
                    self.rtl = false;
                }
            }
        };
        if (!ScrollViewport.prototype.initialize_on_layout.__argnames__) Object.defineProperties(ScrollViewport.prototype.initialize_on_layout, {
            __argnames__ : {value: ["body_style"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_x = function flow_x() {
            var self = this;
            if (self.rtl) {
                return -window.pageXOffset;
            }
            return window.pageXOffset;
        };
        if (!ScrollViewport.prototype.flow_x.__module__) Object.defineProperties(ScrollViewport.prototype.flow_x, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_y = function flow_y() {
            var self = this;
            return window.pageYOffset;
        };
        if (!ScrollViewport.prototype.flow_y.__module__) Object.defineProperties(ScrollViewport.prototype.flow_y, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_window_scroll_pos = function flow_window_scroll_pos() {
            var self = this;
            return [window.pageXOffset, window.pageYOffset];
        };
        if (!ScrollViewport.prototype.flow_window_scroll_pos.__module__) Object.defineProperties(ScrollViewport.prototype.flow_window_scroll_pos, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.inline_pos = function inline_pos() {
            var self = this;
            if (self.vertical_writing_mode) {
                return self.y();
            }
            return self.x();
        };
        if (!ScrollViewport.prototype.inline_pos.__module__) Object.defineProperties(ScrollViewport.prototype.inline_pos, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.block_pos = function block_pos() {
            var self = this;
            if (self.horizontal_writing_mode) {
                return self.y();
            }
            return self.x();
        };
        if (!ScrollViewport.prototype.block_pos.__module__) Object.defineProperties(ScrollViewport.prototype.block_pos, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_scroll_to = function flow_scroll_to(x, y) {
            var self = this;
            if (self.rtl) {
                window.scrollTo(-x, y);
            } else {
                window.scrollTo(x, y);
            }
        };
        if (!ScrollViewport.prototype.flow_scroll_to.__argnames__) Object.defineProperties(ScrollViewport.prototype.flow_scroll_to, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.scroll_to_in_inline_direction = function scroll_to_in_inline_direction(pos, preserve_other) {
            var self = this;
            if (self.vertical_writing_mode) {
                self.scroll_to((preserve_other) ? self.x() : 0, pos);
            } else {
                self.scroll_to(pos, (preserve_other) ? self.y() : 0);
            }
        };
        if (!ScrollViewport.prototype.scroll_to_in_inline_direction.__argnames__) Object.defineProperties(ScrollViewport.prototype.scroll_to_in_inline_direction, {
            __argnames__ : {value: ["pos", "preserve_other"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.scroll_to_in_block_direction = function scroll_to_in_block_direction(pos, preserve_other) {
            var self = this;
            if (self.horizontal_writing_mode) {
                self.scroll_to((preserve_other) ? self.x() : 0, pos);
            } else {
                self.scroll_to(pos, (preserve_other) ? self.y() : 0);
            }
        };
        if (!ScrollViewport.prototype.scroll_to_in_block_direction.__argnames__) Object.defineProperties(ScrollViewport.prototype.scroll_to_in_block_direction, {
            __argnames__ : {value: ["pos", "preserve_other"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_scroll_into_view = function flow_scroll_into_view(elem) {
            var self = this;
            elem.scrollIntoView();
        };
        if (!ScrollViewport.prototype.flow_scroll_into_view.__argnames__) Object.defineProperties(ScrollViewport.prototype.flow_scroll_into_view, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.scroll_by = function scroll_by(x, y) {
            var self = this;
            if (self.ltr) {
                window.scrollBy(x, y);
            } else {
                window.scrollBy(-x, y);
            }
        };
        if (!ScrollViewport.prototype.scroll_by.__argnames__) Object.defineProperties(ScrollViewport.prototype.scroll_by, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.scroll_by_in_inline_direction = function scroll_by_in_inline_direction(offset) {
            var self = this;
            if (self.vertical_writing_mode) {
                self.scroll_by(0, offset);
            } else {
                self.scroll_by(offset, 0);
            }
        };
        if (!ScrollViewport.prototype.scroll_by_in_inline_direction.__argnames__) Object.defineProperties(ScrollViewport.prototype.scroll_by_in_inline_direction, {
            __argnames__ : {value: ["offset"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.scroll_by_in_block_direction = function scroll_by_in_block_direction(offset) {
            var self = this;
            if (self.horizontal_writing_mode) {
                self.scroll_by(0, offset);
            } else {
                self.scroll_by(offset, 0);
            }
        };
        if (!ScrollViewport.prototype.scroll_by_in_block_direction.__argnames__) Object.defineProperties(ScrollViewport.prototype.scroll_by_in_block_direction, {
            __argnames__ : {value: ["offset"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_reset_globals = function flow_reset_globals() {
            var self = this;
        };
        if (!ScrollViewport.prototype.flow_reset_globals.__module__) Object.defineProperties(ScrollViewport.prototype.flow_reset_globals, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow___reset_transforms = function flow___reset_transforms() {
            var self = this;
        };
        if (!ScrollViewport.prototype.flow___reset_transforms.__module__) Object.defineProperties(ScrollViewport.prototype.flow___reset_transforms, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.flow_content_size = function flow_content_size() {
            var self = this;
            return [document.documentElement.scrollWidth, document.documentElement.scrollHeight];
        };
        if (!ScrollViewport.prototype.flow_content_size.__module__) Object.defineProperties(ScrollViewport.prototype.flow_content_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.paged_content_inline_size = function paged_content_inline_size() {
            var self = this;
            var _unpack, w, h;
            _unpack = self.content_size();
_unpack = _unpack_asarray(2, _unpack);
            w = _unpack[0];
            h = _unpack[1];
            return (self.horizontal_writing_mode) ? w : h;
        };
        if (!ScrollViewport.prototype.paged_content_inline_size.__module__) Object.defineProperties(ScrollViewport.prototype.paged_content_inline_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.paged_content_block_size = function paged_content_block_size() {
            var self = this;
            var _unpack, w, h;
            _unpack = self.content_size();
_unpack = _unpack_asarray(2, _unpack);
            w = _unpack[0];
            h = _unpack[1];
            return (self.horizontal_writing_mode) ? h : w;
        };
        if (!ScrollViewport.prototype.paged_content_block_size.__module__) Object.defineProperties(ScrollViewport.prototype.paged_content_block_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.inline_size = function inline_size() {
            var self = this;
            if (self.horizontal_writing_mode) {
                return self.width();
            }
            return self.height();
        };
        if (!ScrollViewport.prototype.inline_size.__module__) Object.defineProperties(ScrollViewport.prototype.inline_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.block_size = function block_size() {
            var self = this;
            if (self.horizontal_writing_mode) {
                return self.height();
            }
            return self.width();
        };
        if (!ScrollViewport.prototype.block_size.__module__) Object.defineProperties(ScrollViewport.prototype.block_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.update_window_size = function update_window_size(w, h) {
            var self = this;
            self.window_width_from_parent = w;
            self.window_height_from_parent = h;
        };
        if (!ScrollViewport.prototype.update_window_size.__argnames__) Object.defineProperties(ScrollViewport.prototype.update_window_size, {
            __argnames__ : {value: ["w", "h"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.width = function width() {
            var self = this;
            return window.innerWidth;
        };
        if (!ScrollViewport.prototype.width.__module__) Object.defineProperties(ScrollViewport.prototype.width, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.height = function height() {
            var self = this;
            return window.innerHeight;
        };
        if (!ScrollViewport.prototype.height.__module__) Object.defineProperties(ScrollViewport.prototype.height, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.document_inline_size = function document_inline_size() {
            var self = this;
            if (self.horizontal_writing_mode) {
                return document_width();
            }
            return document_height();
        };
        if (!ScrollViewport.prototype.document_inline_size.__module__) Object.defineProperties(ScrollViewport.prototype.document_inline_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.document_block_size = function document_block_size() {
            var self = this;
            if (self.horizontal_writing_mode) {
                return document_height();
            }
            return document_width();
        };
        if (!ScrollViewport.prototype.document_block_size.__module__) Object.defineProperties(ScrollViewport.prototype.document_block_size, {
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.viewport_to_document = function viewport_to_document(x, y, doc) {
            var self = this;
            var topdoc, frame, rect, _unpack, wx, wy;
            doc = doc || window.document;
            topdoc = window.document;
            while (doc !== topdoc && doc.defaultView) {
                frame = doc.defaultView.frameElement;
                rect = frame.getBoundingClientRect();
                x += rect.left;
                y += rect.top;
                doc = frame.ownerDocument;
            }
            _unpack = self.window_scroll_pos();
_unpack = _unpack_asarray(2, _unpack);
            wx = _unpack[0];
            wy = _unpack[1];
            x += wx;
            y += wy;
            if (self.rtl) {
                x *= -1;
            }
            return [x, y];
        };
        if (!ScrollViewport.prototype.viewport_to_document.__argnames__) Object.defineProperties(ScrollViewport.prototype.viewport_to_document, {
            __argnames__ : {value: ["x", "y", "doc"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.rect_inline_start = function rect_inline_start(rect) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return (self.ltr) ? rect.left : rect.right;
            }
            return rect.top;
        };
        if (!ScrollViewport.prototype.rect_inline_start.__argnames__) Object.defineProperties(ScrollViewport.prototype.rect_inline_start, {
            __argnames__ : {value: ["rect"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.rect_inline_end = function rect_inline_end(rect) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return (self.ltr) ? rect.right : rect.left;
            }
            return rect.bottom;
        };
        if (!ScrollViewport.prototype.rect_inline_end.__argnames__) Object.defineProperties(ScrollViewport.prototype.rect_inline_end, {
            __argnames__ : {value: ["rect"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.rect_block_start = function rect_block_start(rect) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return rect.top;
            }
            return (self.ltr) ? rect.left : rect.right;
        };
        if (!ScrollViewport.prototype.rect_block_start.__argnames__) Object.defineProperties(ScrollViewport.prototype.rect_block_start, {
            __argnames__ : {value: ["rect"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.rect_block_end = function rect_block_end(rect) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return rect.bottom;
            }
            return (self.ltr) ? rect.right : rect.left;
        };
        if (!ScrollViewport.prototype.rect_block_end.__argnames__) Object.defineProperties(ScrollViewport.prototype.rect_block_end, {
            __argnames__ : {value: ["rect"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.rect_inline_size = function rect_inline_size(rect) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return rect.width;
            }
            return rect.height;
        };
        if (!ScrollViewport.prototype.rect_inline_size.__argnames__) Object.defineProperties(ScrollViewport.prototype.rect_inline_size, {
            __argnames__ : {value: ["rect"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.rect_block_size = function rect_block_size(rect) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return rect.height;
            }
            return rect.width;
        };
        if (!ScrollViewport.prototype.rect_block_size.__argnames__) Object.defineProperties(ScrollViewport.prototype.rect_block_size, {
            __argnames__ : {value: ["rect"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.viewport_to_document_inline = function viewport_to_document_inline(pos, doc) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return self.viewport_to_document(pos, 0, doc)[0];
            }
            return self.viewport_to_document(0, pos, doc)[1];
        };
        if (!ScrollViewport.prototype.viewport_to_document_inline.__argnames__) Object.defineProperties(ScrollViewport.prototype.viewport_to_document_inline, {
            __argnames__ : {value: ["pos", "doc"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.viewport_to_document_block = function viewport_to_document_block(pos, doc) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return self.viewport_to_document(0, pos, doc)[1];
            }
            return self.viewport_to_document(pos, 0, doc)[0];
        };
        if (!ScrollViewport.prototype.viewport_to_document_block.__argnames__) Object.defineProperties(ScrollViewport.prototype.viewport_to_document_block, {
            __argnames__ : {value: ["pos", "doc"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.viewport_to_document_inline_block = function viewport_to_document_inline_block(inline, block, doc) {
            var self = this;
            if (self.horizontal_writing_mode) {
                return self.viewport_to_document(inline, block, doc);
            }
            return self.viewport_to_document(block, inline, doc);
        };
        if (!ScrollViewport.prototype.viewport_to_document_inline_block.__argnames__) Object.defineProperties(ScrollViewport.prototype.viewport_to_document_inline_block, {
            __argnames__ : {value: ["inline", "block", "doc"]},
            __module__ : {value: "read_book.viewport"}
        });
        ScrollViewport.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ScrollViewport.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ScrollViewport.prototype, "__bases__", {value: []});

        function IOSScrollViewport() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            IOSScrollViewport.prototype.__bind_methods__.call(this);
            IOSScrollViewport.prototype.__init__.apply(this, arguments);
        }
        _extends(IOSScrollViewport, ScrollViewport);
        Object.defineProperty(IOSScrollViewport.prototype, "__bind_methods__", {value: function () {
            ScrollViewport.prototype.__bind_methods__ && ScrollViewport.prototype.__bind_methods__.call(this);
            this.width = IOSScrollViewport.prototype.width.bind(this);
            this.height = IOSScrollViewport.prototype.height.bind(this);
            this._scroll_implementation = IOSScrollViewport.prototype._scroll_implementation.bind(this);
            this.paged_scroll_to = IOSScrollViewport.prototype.paged_scroll_to.bind(this);
            this.transform_val = IOSScrollViewport.prototype.transform_val.bind(this);
            this.paged_x = IOSScrollViewport.prototype.paged_x.bind(this);
            this.paged_y = IOSScrollViewport.prototype.paged_y.bind(this);
            this.paged_scroll_into_view = IOSScrollViewport.prototype.paged_scroll_into_view.bind(this);
            this.paged_window_scroll_pos = IOSScrollViewport.prototype.paged_window_scroll_pos.bind(this);
            this.paged_content_size = IOSScrollViewport.prototype.paged_content_size.bind(this);
            this.paged___reset_transforms = IOSScrollViewport.prototype.paged___reset_transforms.bind(this);
            this.paged_reset_globals = IOSScrollViewport.prototype.paged_reset_globals.bind(this);
        }});
        IOSScrollViewport.prototype.__init__ = function __init__ () {
            ScrollViewport.prototype.__init__ && ScrollViewport.prototype.__init__.apply(this, arguments);
        };
        IOSScrollViewport.prototype.width = function width() {
            var self = this;
            return self.window_width_from_parent || window.innerWidth;
        };
        if (!IOSScrollViewport.prototype.width.__module__) Object.defineProperties(IOSScrollViewport.prototype.width, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.height = function height() {
            var self = this;
            return self.window_height_from_parent || window.innerHeight;
        };
        if (!IOSScrollViewport.prototype.height.__module__) Object.defineProperties(IOSScrollViewport.prototype.height, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype._scroll_implementation = function _scroll_implementation(x, y) {
            var self = this;
            if (x === 0 && y === 0) {
                document.documentElement.style.transform = "none";
            } else {
                x *= -1;
                y *= -1;
                document.documentElement.style.transform = "translateX(" + _str.format("{}", x) + "px) translateY(" + _str.format("{}", y) + "px)";
            }
        };
        if (!IOSScrollViewport.prototype._scroll_implementation.__argnames__) Object.defineProperties(IOSScrollViewport.prototype._scroll_implementation, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_scroll_to = function paged_scroll_to(x, y) {
            var self = this;
            var boss;
            x = x || 0;
            y = y || 0;
            if (self.ltr) {
                self._scroll_implementation(x, y);
            } else {
                self._scroll_implementation(-x, y);
            }
            boss = get_boss();
            if (boss) {
                boss.onscroll();
            }
        };
        if (!IOSScrollViewport.prototype.paged_scroll_to.__argnames__) Object.defineProperties(IOSScrollViewport.prototype.paged_scroll_to, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.transform_val = function transform_val(y) {
            var self = this;
            var raw, idx, ans;
            raw = document.documentElement.style.transform;
            if (!raw || raw === "none") {
                return 0;
            }
            idx = (y) ? raw.lastIndexOf("(") : raw.indexOf("(");
            raw = raw.slice(idx + 1);
            ans = parseInt(raw);
            if (isNaN(ans)) {
                ans = 0;
            }
            return ans;
        };
        if (!IOSScrollViewport.prototype.transform_val.__argnames__) Object.defineProperties(IOSScrollViewport.prototype.transform_val, {
            __argnames__ : {value: ["y"]},
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_x = function paged_x() {
            var self = this;
            var ans;
            ans = self.transform_val();
            if (self.ltr) {
                ans *= -1;
            }
            return ans;
        };
        if (!IOSScrollViewport.prototype.paged_x.__module__) Object.defineProperties(IOSScrollViewport.prototype.paged_x, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_y = function paged_y() {
            var self = this;
            return -1 * self.transform_val(true);
        };
        if (!IOSScrollViewport.prototype.paged_y.__module__) Object.defineProperties(IOSScrollViewport.prototype.paged_y, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_scroll_into_view = function paged_scroll_into_view(elem) {
            var self = this;
            var left, p;
            left = elem.offsetLeft;
            if (left === null) {
                return;
            }
            elem.scrollIntoView();
            window.scrollTo(0, 0);
            p = elem.offsetParent;
            while (p) {
                left += p.offsetLeft;
                p = p.offsetParent;
            }
            self._scroll_implementation(max(0, left), 0);
        };
        if (!IOSScrollViewport.prototype.paged_scroll_into_view.__argnames__) Object.defineProperties(IOSScrollViewport.prototype.paged_scroll_into_view, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_window_scroll_pos = function paged_window_scroll_pos() {
            var self = this;
            return [self.transform_val(), self.transform_val(true)];
        };
        if (!IOSScrollViewport.prototype.paged_window_scroll_pos.__module__) Object.defineProperties(IOSScrollViewport.prototype.paged_window_scroll_pos, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_content_size = function paged_content_size() {
            var self = this;
            var w, h;
            w = document.documentElement.scrollWidth;
            h = document.documentElement.scrollHeight;
            return [w - self.transform_val(), h - self.transform_val(true)];
        };
        if (!IOSScrollViewport.prototype.paged_content_size.__module__) Object.defineProperties(IOSScrollViewport.prototype.paged_content_size, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged___reset_transforms = function paged___reset_transforms() {
            var self = this;
            var s;
            s = document.documentElement.style;
            if (s.transform !== "none") {
                s.transform = "none";
            }
        };
        if (!IOSScrollViewport.prototype.paged___reset_transforms.__module__) Object.defineProperties(IOSScrollViewport.prototype.paged___reset_transforms, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.paged_reset_globals = function paged_reset_globals() {
            var self = this;
            self.__reset_transforms();
        };
        if (!IOSScrollViewport.prototype.paged_reset_globals.__module__) Object.defineProperties(IOSScrollViewport.prototype.paged_reset_globals, {
            __module__ : {value: "read_book.viewport"}
        });
        IOSScrollViewport.prototype.__repr__ = function __repr__ () {
            if(ScrollViewport.prototype.__repr__) return ScrollViewport.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        IOSScrollViewport.prototype.__str__ = function __str__ () {
            if(ScrollViewport.prototype.__str__) return ScrollViewport.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(IOSScrollViewport.prototype, "__bases__", {value: [ScrollViewport]});

        if (1 < ios_major_version && ios_major_version < 15) {
            scroll_viewport = new IOSScrollViewport;
        } else {
            scroll_viewport = new ScrollViewport;
        }
        var _Iter1 = _Iterable(FUNCTIONS);
        for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
            attr = _Iter1[_Index1];
            if (!scroll_viewport[_bound_index("paged_" + attr, scroll_viewport)]) {
                scroll_viewport[_bound_index("paged_" + attr, scroll_viewport)] = scroll_viewport[(typeof attr === "number" && attr < 0) ? scroll_viewport.length + attr : attr];
            }
        }
        viewport_mode_changer(scroll_viewport.set_mode);
        function get_unit_size_in_pixels(unit) {
            var d, ans;
            d = document.createElement("span");
            d.style.position = "absolute";
            d.style.visibility = "hidden";
            d.style.width = "1" + _str.format("{}", unit) + "";
            d.style.fontSize = "1" + _str.format("{}", unit) + "";
            d.style.paddingTop = d.style.paddingBottom = d.style.paddingLeft = d.style.paddingRight = "0";
            d.style.marginTop = d.style.marginBottom = d.style.marginLeft = d.style.marginRight = "0";
            d.style.borderStyle = "none";
            document.body.appendChild(d);
            ans = d.clientWidth;
            document.body.removeChild(d);
            return ans;
        };
        if (!get_unit_size_in_pixels.__argnames__) Object.defineProperties(get_unit_size_in_pixels, {
            __argnames__ : {value: ["unit"]},
            __module__ : {value: "read_book.viewport"}
        });

        function rem_size(reset) {
            var d;
            if (reset) {
                rem_size.ans = null;
                return;
            }
            if (!rem_size.ans) {
                d = document.createElement("span");
                d.style.position = "absolute";
                d.style.visibility = "hidden";
                d.style.width = "1rem";
                d.style.fontSize = "1rem";
                d.style.paddingTop = d.style.paddingBottom = d.style.paddingLeft = d.style.paddingRight = "0";
                d.style.marginTop = d.style.marginBottom = d.style.marginLeft = d.style.marginRight = "0";
                d.style.borderStyle = "none";
                document.body.appendChild(d);
                rem_size.ans = max(2, d.clientWidth);
                document.body.removeChild(d);
            }
            return rem_size.ans;
        };
        if (!rem_size.__argnames__) Object.defineProperties(rem_size, {
            __argnames__ : {value: ["reset"]},
            __module__ : {value: "read_book.viewport"}
        });

        function line_height(reset) {
            var ds, lh;
            if (reset) {
                line_height.ans = null;
                return;
            }
            if (!line_height.ans) {
                ds = window.getComputedStyle(document.body);
                try {
                    lh = float(ds.lineHeight);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        try {
                            lh = 1.2 * float(ds.fontSize);
                        } catch (_Exception) {
                            _last_exception = _Exception;
                            {
                                lh = 15;
                            } 
                        }
                    } 
                }
                line_height.ans = max(5, lh);
            }
            return line_height.ans;
        };
        if (!line_height.__argnames__) Object.defineProperties(line_height, {
            __argnames__ : {value: ["reset"]},
            __module__ : {value: "read_book.viewport"}
        });

        _modules["read_book.viewport"].FUNCTIONS = FUNCTIONS;
        _modules["read_book.viewport"].scroll_viewport = scroll_viewport;
        _modules["read_book.viewport"].attr = attr;
        _modules["read_book.viewport"].ScrollViewport = ScrollViewport;
        _modules["read_book.viewport"].IOSScrollViewport = IOSScrollViewport;
        _modules["read_book.viewport"].get_unit_size_in_pixels = get_unit_size_in_pixels;
        _modules["read_book.viewport"].rem_size = rem_size;
        _modules["read_book.viewport"].line_height = line_height;
    })();

    (function(){
        var __name__ = "read_book.cfi";
        var escape_pat, unescape_pat;
        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;
        var rem_size = _modules["read_book.viewport"].rem_size;

        escape_pat = /[\[\],^();~@!]/g;
        unescape_pat = /[\^](.)/g;
        function escape_for_cfi(raw) {
            return (raw || "").replace(escape_pat, "^$&");
        };
        if (!escape_for_cfi.__argnames__) Object.defineProperties(escape_for_cfi, {
            __argnames__ : {value: ["raw"]},
            __module__ : {value: "read_book.cfi"}
        });

        function unescape_from_cfi(raw) {
            return (raw || "").replace(unescape_pat, "$1");
        };
        if (!unescape_from_cfi.__argnames__) Object.defineProperties(unescape_from_cfi, {
            __argnames__ : {value: ["raw"]},
            __module__ : {value: "read_book.cfi"}
        });

        function fstr(d) {
            var ans, n;
            ans = "";
            if (d < 0) {
                ans = "-";
                d = -d;
            }
            n = Math.floor(d);
            ans += n;
            n = Math.round((d - n) * 100);
            if (n !== 0) {
                ans += "." + ((n % 10 === 0) ? n / 10 : n);
            }
            return ans;
        };
        if (!fstr.__argnames__) Object.defineProperties(fstr, {
            __argnames__ : {value: ["d"]},
            __module__ : {value: "read_book.cfi"}
        });

        function get_current_time(target) {
            return fstr(target.currentTime || 0);
        };
        if (!get_current_time.__argnames__) Object.defineProperties(get_current_time, {
            __argnames__ : {value: ["target"]},
            __module__ : {value: "read_book.cfi"}
        });

        function id_is_unique(idval) {
            var multiples;
            try {
                multiples = document.querySelectorAll("[id=" + window.CSS.escape(idval) + "]");
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    return false;
                } 
            }
            if (multiples && multiples.length < 2) {
                return true;
            }
            return false;
        };
        if (!id_is_unique.__argnames__) Object.defineProperties(id_is_unique, {
            __argnames__ : {value: ["idval"]},
            __module__ : {value: "read_book.cfi"}
        });

        function range_has_point(range_, x, y) {
            var rects, rect;
            rects = range_.getClientRects();
            for (var i = 0; i < rects.length; i++) {
                rect = rects[(typeof i === "number" && i < 0) ? rects.length + i : i];
                if (rect.left <= x && x <= rect.right && rect.top <= y && y <= rect.bottom) {
                    return true;
                }
            }
            return false;
        };
        if (!range_has_point.__argnames__) Object.defineProperties(range_has_point, {
            __argnames__ : {value: ["range_", "x", "y"]},
            __module__ : {value: "read_book.cfi"}
        });

        function offset_in_text_node(node, range_, x, y) {
            var limits, pivot, lr, rr;
            limits = [0, node.nodeValue.length];
            while (limits[0] !== limits[1]) {
                pivot = Math.floor((limits[0] + limits[1]) / 2);
                lr = [limits[0], pivot];
                rr = [pivot+1, limits[1]];
                range_.setStart(node, pivot);
                range_.setEnd(node, pivot + 1);
                if (range_has_point(range_, x, y)) {
                    return pivot;
                }
                range_.setStart(node, rr[0]);
                range_.setEnd(node, rr[1]);
                if (range_has_point(range_, x, y)) {
                    limits = rr;
                    continue;
                }
                range_.setStart(node, lr[0]);
                range_.setEnd(node, lr[1]);
                if (range_has_point(range_, x, y)) {
                    limits = lr;
                    continue;
                }
                break;
            }
            return limits[0];
        };
        if (!offset_in_text_node.__argnames__) Object.defineProperties(offset_in_text_node, {
            __argnames__ : {value: ["node", "range_", "x", "y"]},
            __module__ : {value: "read_book.cfi"}
        });

        function find_offset_for_point(x, y, node, cdoc) {
            var range_, child;
            range_ = cdoc.createRange();
            child = node.firstChild;
            while (child) {
                if (Node.TEXT_NODE <= (_cond_temp = child.nodeType) && _cond_temp <= Node.ENTITY_NODE && child.nodeValue && child.nodeValue.length) {
                    range_.setStart(child, 0);
                    range_.setEnd(child, child.nodeValue.length);
                    if (range_has_point(range_, x, y)) {
                        return [child, offset_in_text_node(child, range_, x, y)];
                    }
                }
                child = child.nextSibling;
            }
            return [null, null];
        };
        if (!find_offset_for_point.__argnames__) Object.defineProperties(find_offset_for_point, {
            __argnames__ : {value: ["x", "y", "node", "cdoc"]},
            __module__ : {value: "read_book.cfi"}
        });

        function set_current_time(target, val) {
            if (target.currentTime === undefined) {
                return;
            }
            if (target.readyState === 4 || target.readyState === "complete") {
                target.currentTime = val + 0;
            } else {
                target.addEventListener("canplay", (function() {
                    var _anonfunc = function () {
                        target.currentTime = val;
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.cfi"}
                    });
                    return _anonfunc;
                })(), false);
            }
        };
        if (!set_current_time.__argnames__) Object.defineProperties(set_current_time, {
            __argnames__ : {value: ["target", "val"]},
            __module__ : {value: "read_book.cfi"}
        });

        function is_text_node(node) {
            return node.nodeType === Node.TEXT_NODE || node.nodeType === Node.CDATA_SECTION_NODE;
        };
        if (!is_text_node.__argnames__) Object.defineProperties(is_text_node, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.cfi"}
        });

        function text_length_in_range_wrapper(node) {
            var p, ans;
            p = node.firstChild;
            ans = 0;
            while (p) {
                if (is_text_node(p)) {
                    ans += p.nodeValue.length;
                } else if (p.nodeType === Node.ELEMENT_NODE && _exists.d(p.dataset).calibreRangeWrapper) {
                    ans += text_length_in_range_wrapper(p);
                }
                p = p.nextSibling;
            }
            return ans;
        };
        if (!text_length_in_range_wrapper.__argnames__) Object.defineProperties(text_length_in_range_wrapper, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.cfi"}
        });

        function adjust_node_for_text_offset(node) {
            var offset, adjusted, p;
            if (node.parentNode && _exists.d(node.parentNode.dataset).calibreRangeWrapper) {
                node = node.parentNode;
            }
            offset = 0;
            adjusted = false;
            while (true) {
                p = node.previousSibling;
                if (!p || p.nodeType > Node.COMMENT_NODE) {
                    break;
                }
                if (is_text_node(p)) {
                    offset += p.nodeValue.length;
                } else if (p.nodeType === Node.ELEMENT_NODE && _exists.d(p.dataset).calibreRangeWrapper) {
                    offset += text_length_in_range_wrapper(p);
                }
                node = p;
                adjusted = true;
            }
            if (adjusted && node.nodeType === Node.ELEMENT_NODE && _exists.d(node.dataset).calibreRangeWrapper) {
                if (!node.firstChild || node.firstChild.nodeType !== Node.TEXT_NODE) {
                    node.insertBefore(document.createTextNode(""), node.firstChild || null);
                }
                node = node.firstChild;
            }
            return [node, offset, adjusted];
        };
        if (!adjust_node_for_text_offset.__argnames__) Object.defineProperties(adjust_node_for_text_offset, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.cfi"}
        });

        function unwrapped_nodes(range_wrapper) {
            var ans, child;
            ans = [];
            var _Iter0 = _Iterable(range_wrapper.childNodes);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                child = _Iter0[_Index0];
                if (child.nodeType === Node.ELEMENT_NODE && _exists.d(child.dataset).calibreRangeWrapper) {
                    ans = ans.concat(unwrapped_nodes(child));
                } else {
                    ans.push(child);
                }
            }
            return ans;
        };
        if (!unwrapped_nodes.__argnames__) Object.defineProperties(unwrapped_nodes, {
            __argnames__ : {value: ["range_wrapper"]},
            __module__ : {value: "read_book.cfi"}
        });

        function increment_index_for_child(child, index, sentinel) {
            var is_element, nodes;
            is_element = child.nodeType === Node.ELEMENT_NODE;
            if (is_element && _exists.d(child.dataset).calibreRangeWrapper) {
                nodes = unwrapped_nodes(child);
                index = increment_index_for_children(nodes, index, sentinel);
            } else {
                index |= 1;
                if (is_element) {
                    index += 1;
                }
            }
            return index;
        };
        if (!increment_index_for_child.__argnames__) Object.defineProperties(increment_index_for_child, {
            __argnames__ : {value: ["child", "index", "sentinel"]},
            __module__ : {value: "read_book.cfi"}
        });

        function increment_index_for_children(children, index, sentinel) {
            var child, i;
            for (var _Index1 = 0; _Index1 < children.length; _Index1++) {
                i = _Index1;
                child = children[(typeof i === "number" && i < 0) ? children.length + i : i];
                index = increment_index_for_child(child, index, sentinel);
                if (child === sentinel) {
                    break;
                }
            }
            return index;
        };
        if (!increment_index_for_children.__argnames__) Object.defineProperties(increment_index_for_children, {
            __argnames__ : {value: ["children", "index", "sentinel"]},
            __module__ : {value: "read_book.cfi"}
        });

        function non_range_wrapper_parent(node) {
            var p, child;
            p = node.parentNode;
            child = node;
            while (_exists.d(p.dataset).calibreRangeWrapper) {
                child = p;
                p = p.parentNode;
            }
            return [p, child];
        };
        if (!non_range_wrapper_parent.__argnames__) Object.defineProperties(non_range_wrapper_parent, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.cfi"}
        });

        function encode(doc, node, offset, tail) {
            var cfi, q, _unpack, adjusted_node, additional_offset, adjusted, is_first, p, sentinel, win, index, id, idspec;
            cfi = tail || "";
            if (node.nodeType === Node.ELEMENT_NODE) {
                if (typeof offset === "number") {
                    q = node.childNodes.item(offset);
                    if (q) {
                        if (q.nodeType === Node.ELEMENT_NODE) {
                            node = q;
                            if (_exists.d(node.dataset).calibreRangeWrapper) {
                                if (!node.firstChild) {
                                    node.appendChild(document.createTextNode(""));
                                }
                                node = node.firstChild;
                            }
                        }
                    }
                } else if (_exists.d(node.dataset).calibreRangeWrapper) {
                    if (!node.firstChild) {
                        node.appendChild(document.createTextNode(""));
                    }
                    node = node.firstChild;
                }
            }
            if (is_text_node(node)) {
                offset = offset || 0;
                _unpack = adjust_node_for_text_offset(node);
_unpack = _unpack_asarray(3, _unpack);
                adjusted_node = _unpack[0];
                additional_offset = _unpack[1];
                adjusted = _unpack[2];
                if (adjusted) {
                    node = adjusted_node;
                    offset += additional_offset;
                }
                cfi = ":" + offset + cfi;
            } else if (node.nodeType !== Node.ELEMENT_NODE) {
                print("Offsets for nodes of type " + _str.format("{}", node.nodeType) + " are not handled");
            }
            is_first = true;
            while (node !== doc) {
                _unpack = non_range_wrapper_parent(node);
_unpack = _unpack_asarray(2, _unpack);
                p = _unpack[0];
                sentinel = _unpack[1];
                if (!p) {
                    if ((node.nodeType === Node.DOCUMENT_NODE || typeof node.nodeType === "object" && _equals(node.nodeType, Node.DOCUMENT_NODE))) {
                        win = node.defaultView;
                        if (win.frameElement) {
                            node = win.frameElement;
                            cfi = "!" + cfi;
                            continue;
                        }
                    }
                    break;
                }
                index = increment_index_for_children(p.childNodes, 0, sentinel);
                if (is_first) {
                    is_first = false;
                    if (node.nodeType === Node.ELEMENT_NODE && _exists.d(node.dataset).calibreRangeWrapper) {
                        index -= 1;
                    }
                }
                id = node.id;
                idspec = "";
                if (id && id_is_unique(id)) {
                    idspec = "[" + escape_for_cfi(id) + "]";
                }
                cfi = "/" + index + idspec + cfi;
                node = p;
            }
            return cfi;
        };
        if (!encode.__argnames__) Object.defineProperties(encode, {
            __argnames__ : {value: ["doc", "node", "offset", "tail"]},
            __module__ : {value: "read_book.cfi"}
        });

        function node_at_index(nodes, target, index, iter_text_nodes) {
            var node, is_element, _unpack, q, i;
            for (var _Index2 = 0; _Index2 < nodes.length; _Index2++) {
                i = _Index2;
                node = nodes[(typeof i === "number" && i < 0) ? nodes.length + i : i];
                is_element = node.nodeType === Node.ELEMENT_NODE;
                if (is_element && _exists.d(node.dataset).calibreRangeWrapper) {
                    _unpack = node_at_index(unwrapped_nodes(node), target, index, iter_text_nodes);
_unpack = _unpack_asarray(2, _unpack);
                    q = _unpack[0];
                    index = _unpack[1];
                    if (q) {
                        return [q, index];
                    }
                    continue;
                }
                if (iter_text_nodes && !is_text_node(node) || !iter_text_nodes && !is_element) {
                    continue;
                }
                if (index === target) {
                    return [node, index];
                }
                index += 1;
            }
            return [null, index];
        };
        if (!node_at_index.__argnames__) Object.defineProperties(node_at_index, {
            __argnames__ : {value: ["nodes", "target", "index", "iter_text_nodes"]},
            __module__ : {value: "read_book.cfi"}
        });

        function node_for_path_step(parent, target, assertion) {
            var q, is_element;
            if (assertion) {
                q = document.getElementById(assertion);
                if (q && id_is_unique(assertion)) {
                    return q;
                }
            }
            is_element = _equals(target % 2, 0);
            target = Math.floor(target / 2);
            if (is_element && target > 0) {
                target -= 1;
            }
            return node_at_index(parent.childNodes, target, 0, !is_element)[0];
        };
        if (!node_for_path_step.__argnames__) Object.defineProperties(node_for_path_step, {
            __argnames__ : {value: ["parent", "target", "assertion"]},
            __module__ : {value: "read_book.cfi"}
        });

        function node_for_text_offset(nodes, offset, first_node) {
            var last_text_node, seen_first, node, l, _unpack, qn, ok, i;
            last_text_node = null;
            seen_first = false;
            for (var _Index3 = 0; _Index3 < nodes.length; _Index3++) {
                i = _Index3;
                node = nodes[(typeof i === "number" && i < 0) ? nodes.length + i : i];
                if (!seen_first) {
                    if (!first_node || node.isSameNode(first_node)) {
                        seen_first = true;
                    } else {
                        continue;
                    }
                }
                if (is_text_node(node)) {
                    l = node.nodeValue.length;
                    if (offset <= l) {
                        return [node, offset, true];
                    }
                    last_text_node = node;
                    offset -= l;
                } else if (node.nodeType === Node.ELEMENT_NODE && _exists.d(node.dataset).calibreRangeWrapper) {
                    _unpack = node_for_text_offset(unwrapped_nodes(node), offset);
_unpack = _unpack_asarray(3, _unpack);
                    qn = _unpack[0];
                    offset = _unpack[1];
                    ok = _unpack[2];
                    if (ok) {
                        return [qn, offset, true];
                    }
                }
            }
            return [last_text_node, offset, false];
        };
        if (!node_for_text_offset.__argnames__) Object.defineProperties(node_for_text_offset, {
            __argnames__ : {value: ["nodes", "offset", "first_node"]},
            __module__ : {value: "read_book.cfi"}
        });

        function decode(cfi, doc) {
            var simple_node_regex, error, node, orig_cfi, r, target, assertion, q, decoded, offset, orig_offset, _unpack, qnode, ok;
            doc = doc || window.document;
            simple_node_regex = /^\/(\d+)(\[[^\]]*\])?/;
            error = null;
            node = doc;
            orig_cfi = cfi;
            while (cfi.length > 0 && !error) {
                r = cfi.match(simple_node_regex);
                if (r) {
                    target = parseInt(r[1]);
                    assertion = r[2];
                    if (assertion) {
                        assertion = unescape_from_cfi(assertion.slice(1, assertion.length - 1));
                    }
                    q = node_for_path_step(node, target, assertion);
                    if (q) {
                        node = q;
                        cfi = cfi.substr(r[0].length);
                    } else {
                        if (target) {
                            error = "No matching child found for CFI: " + _str.format("{}", orig_cfi) + " leftover: " + _str.format("{}", cfi) + "";
                            break;
                        } else {
                            cfi = cfi.substr(r[0].length);
                        }
                    }
                } else if (cfi[0] === "!") {
                    if (node.contentDocument) {
                        node = node.contentDocument;
                        cfi = cfi.substr(1);
                    } else {
                        error = "Cannot reference " + node.nodeName + "'s content: " + cfi;
                    }
                } else {
                    break;
                }
            }
            if (error) {
                print(error);
                return null;
            }
            decoded = Object.create(null);
            error = null;
            offset = null;
            r = cfi.match(/^:(\d+)/);
            if (r) {
                offset = parseInt(r[1]);
                cfi = cfi.substr(r[0].length);
            }
            r = cfi.match(/^~(-?\d+(\.\d+)?)/);
            if (r) {
                decoded.time = r[1] - 0;
                cfi = cfi.substr(r[0].length);
            }
            r = cfi.match(/^@(-?\d+(\.\d+)?):(-?\d+(\.\d+)?)/);
            if (r) {
                decoded.x = r[1] - 0;
                decoded.y = r[3] - 0;
                cfi = cfi.substr(r[0].length);
            }
            r = cfi.match(/^\[([^\]]+)\]/);
            if (r) {
                assertion = r[1];
                cfi = cfi.substr(r[0].length);
                r = assertion.match(/;s=([ab])$/);
                if (r) {
                    if (r.index > 0 && assertion[_bound_index(r.index - 1, assertion)] !== "^") {
                        assertion = assertion.substr(0, r.index);
                        decoded.forward = r[1] === "a";
                    }
                    assertion = unescape_from_cfi(assertion);
                }
            }
            if (offset !== null) {
                orig_offset = offset;
                if (_exists.d(node.parentNode).nodeType === Node.ELEMENT_NODE && _exists.d(node.parentNode.dataset).calibreRangeWrapper) {
                    node = node.parentNode;
                }
                _unpack = node_for_text_offset(node.parentNode.childNodes, offset, node);
_unpack = _unpack_asarray(3, _unpack);
                qnode = _unpack[0];
                offset = _unpack[1];
                ok = _unpack[2];
                if (!ok) {
                    error = "Offset out of range: " + orig_offset;
                }
                if (qnode) {
                    node = qnode;
                }
                decoded.offset = offset;
            }
            decoded.node = node;
            if (error) {
                decoded.error = error;
            } else if (cfi.length > 0) {
                decoded.error = "Undecoded CFI: " + cfi;
            }
            if (decoded.error) {
                print(decoded.error);
            }
            return decoded;
        };
        if (!decode.__argnames__) Object.defineProperties(decode, {
            __argnames__ : {value: ["cfi", "doc"]},
            __module__ : {value: "read_book.cfi"}
        });

        function cfi_sort_key(cfi) {
            var simple_node_regex, steps, r, target, ans, offset;
            simple_node_regex = /^\/(\d+)(\[[^\]]*\])?/;
            steps = [];
            while (cfi.length > 0) {
                r = cfi.match(simple_node_regex);
                if (r) {
                    target = parseInt(r[1]);
                    cfi = cfi.substr(r[0].length);
                    steps.push(target);
                } else if (cfi[0] === "!") {
                    cfi = cfi.substr(1);
                } else {
                    break;
                }
            }
            ans = (function(){
                var _d = Object.create(null);
                _d["steps"] = steps;
                _d["text_offset"] = 0;
                _d["temporal_offset"] = 0;
                _d["spatial_offset"] = [0, 0];
                return _d;
            }).call(this);
            r = cfi.match(/^:(\d+)/);
            if (r) {
                offset = parseInt(r[1]);
                ans["text_offset"] = offset;
                cfi = cfi.substr(r[0].length);
            }
            r = cfi.match(/^~(-?\d+(\.\d+)?)/);
            if (r) {
                ans["temporal_offset"] = r[1] - 0;
                cfi = cfi.substr(r[0].length);
            }
            r = cfi.match(/^@(-?\d+(\.\d+)?):(-?\d+(\.\d+)?)/);
            if (r) {
                ans["spatial_offset"] = [r[1] - 0, r[3] - 0];
                cfi = cfi.substr(r[0].length);
            }
            return ans;
        };
        if (!cfi_sort_key.__argnames__) Object.defineProperties(cfi_sort_key, {
            __argnames__ : {value: ["cfi"]},
            __module__ : {value: "read_book.cfi"}
        });

        function create_cfi_cmp(key_map) {
            if (!key_map) {
                key_map = Object.create(null);
            }
            function cfi_cmp(a_cfi, b_cfi) {
                var a, b, diff, i;
                a = key_map[(typeof a_cfi === "number" && a_cfi < 0) ? key_map.length + a_cfi : a_cfi];
                if (!a) {
                    a = key_map[(typeof a_cfi === "number" && a_cfi < 0) ? key_map.length + a_cfi : a_cfi] = cfi_sort_key(a_cfi);
                }
                b = key_map[(typeof b_cfi === "number" && b_cfi < 0) ? key_map.length + b_cfi : b_cfi];
                if (!b) {
                    b = key_map[(typeof b_cfi === "number" && b_cfi < 0) ? key_map.length + b_cfi : b_cfi] = cfi_sort_key(b_cfi);
                }
                var _Iter4 = _Iterable(range(min(a.steps.length, b.steps.length)));
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    i = _Iter4[_Index4];
                    diff = (_expr_temp = a.steps)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i] - (_expr_temp = b.steps)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                    if (diff !== 0) {
                        return diff;
                    }
                }
                diff = a.steps.length - b.steps.length;
                if (diff !== 0) {
                    return diff;
                }
                if (a.temporal_offset !== b.temporal_offset) {
                    return a.temporal_offset - b.temporal_offset;
                }
                if (a.spatial_offset[0] !== b.spatial_offset[0]) {
                    return a.spatial_offset[0] - b.spatial_offset[0];
                }
                if (a.spatial_offset[1] !== b.spatial_offset[1]) {
                    return a.spatial_offset[1] - b.spatial_offset[1];
                }
                if (a.text_offset !== b.text_offset) {
                    return a.text_offset - b.text_offset;
                }
                return 0;
            };
            if (!cfi_cmp.__argnames__) Object.defineProperties(cfi_cmp, {
                __argnames__ : {value: ["a_cfi", "b_cfi"]},
                __module__ : {value: "read_book.cfi"}
            });

            return cfi_cmp;
        };
        if (!create_cfi_cmp.__argnames__) Object.defineProperties(create_cfi_cmp, {
            __argnames__ : {value: ["key_map"]},
            __module__ : {value: "read_book.cfi"}
        });

        function sort_cfis(array_of_cfis) {
            var key_map, cfi;
            key_map = (function() {
                var _Iter = _Iterable(array_of_cfis), _Result = Object.create(null), cfi;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    cfi = _Iter[_Index];
                    _Result[cfi] = (cfi_sort_key(cfi));
                }
                return _Result;
            })();
            Array.prototype.sort.call(array_of_cfis, create_cfi_cmp(key_map));
        };
        if (!sort_cfis.__argnames__) Object.defineProperties(sort_cfis, {
            __argnames__ : {value: ["array_of_cfis"]},
            __module__ : {value: "read_book.cfi"}
        });

        function at(x, y, doc) {
            var cdoc, target, tail, offset, name, cd, rect, px, py, _unpack;
            doc = doc || window.document;
            cdoc = doc;
            target = null;
            tail = "";
            offset = null;
            name = null;
            while (true) {
                target = cdoc.elementFromPoint(x, y);
                if (!target || target === cdoc.documentElement || target === cdoc.body) {
                    return null;
                }
                name = target.localName;
                if (!_in(name, (function(){
                    var s = _set();
                    s.jsset.add("iframe");
                    s.jsset.add("embed");
                    s.jsset.add("object");
                    return s;
                })())) {
                    break;
                }
                cd = target.contentDocument;
                if (!cd) {
                    break;
                }
                rect = target.getBoundingClientRect();
                x -= rect.left;
                y -= rect.top;
                cdoc = cd;
            }
            (target.parentNode || target).normalize();
            if (_in(name, (function(){
                var s = _set();
                s.jsset.add("audio");
                s.jsset.add("video");
                return s;
            })())) {
                tail = "~" + get_current_time(target);
            }
            if (_in(name, (function(){
                var s = _set();
                s.jsset.add("img");
                s.jsset.add("video");
                return s;
            })())) {
                rect = target.getBoundingClientRect();
                px = (x - rect.left) * 100 / target.offsetWidth;
                py = (y - rect.top) * 100 / target.offsetHeight;
                tail = str.format("{}@{}:{}", tail, fstr(px), fstr(py));
            } else if (name !== "audio") {
                _unpack = find_offset_for_point(x, y, target, cdoc);
_unpack = _unpack_asarray(2, _unpack);
                target = _unpack[0];
                offset = _unpack[1];
                if (target === null) {
                    return null;
                }
            }
            return encode(doc, target, offset, tail);
        };
        if (!at.__argnames__) Object.defineProperties(at, {
            __argnames__ : {value: ["x", "y", "doc"]},
            __module__ : {value: "read_book.cfi"}
        });

        function decode_with_range(cfi, doc) {
            var decoded, node, ndoc, range_, position_at_end_of_range, node_len, offset, rect;
            doc = doc || window.document;
            decoded = decode(cfi, doc);
            if (!decoded || !decoded.node) {
                return null;
            }
            node = decoded.node;
            ndoc = node.ownerDocument;
            if (!ndoc) {
                print(str.format("CFI node has no owner document: {} {}", cfi, node));
                return null;
            }
            range_ = null;
            position_at_end_of_range = null;
            if (typeof decoded.offset === "number") {
                node_len = (node.nodeValue) ? node.nodeValue.length : 0;
                if (!node_len && _exists.d(_exists.d(node.nextSibling).dataset).calibreRangeWrapper && _exists.d(node.nextSibling.firstChild).nodeType === Node.TEXT_NODE) {
                    node = node.nextSibling.firstChild;
                    node_len = (node.nodeValue) ? node.nodeValue.length : 0;
                }
                if (node_len) {
                    range_ = ndoc.createRange();
                    offset = decoded.offset;
                    position_at_end_of_range = false;
                    if (offset >= node_len) {
                        offset = node_len - 1;
                        position_at_end_of_range = true;
                    }
                    range_.setStart(node, offset);
                    range_.setEnd(node, offset + 1);
                    rect = range_.getBoundingClientRect();
                    if (!rect) {
                        print(str.format("Could not find caret position for {} (offset: {})", cfi, decoded.offset));
                        range_ = null;
                    }
                } else {
                    print("Caret offset pointed to an empty text node or a non-text node for " + _str.format("{}", cfi) + ", (offset: " + _str.format("{}", decoded.offset) + ")");
                    range_ = null;
                }
            }
            decoded.range = range_;
            decoded.use_range_end_pos = position_at_end_of_range;
            return decoded;
        };
        if (!decode_with_range.__argnames__) Object.defineProperties(decode_with_range, {
            __argnames__ : {value: ["cfi", "doc"]},
            __module__ : {value: "read_book.cfi"}
        });

        function decoded_range_to_document_position(decoded) {
            var rect, inserted_node, inline_vs_pos, block_vs_pos;
            rect = decoded.range.getBoundingClientRect();
            inserted_node = null;
            if (!rect.width && !rect.height && !rect.left && !rect.right) {
                inserted_node = document.createTextNode("");
                decoded.range.insertNode(inserted_node);
                rect = decoded.range.getBoundingClientRect();
            }
            if (decoded.use_range_end_pos) {
                inline_vs_pos = scroll_viewport.rect_inline_end(rect);
            } else {
                inline_vs_pos = scroll_viewport.rect_inline_start(rect);
            }
            if (decoded.forward) {
                block_vs_pos = scroll_viewport.rect_block_end(rect);
            } else {
                block_vs_pos = scroll_viewport.rect_block_start(rect);
            }
            if (inserted_node) {
                inserted_node.parentNode.removeChild(inserted_node);
            }
            return scroll_viewport.viewport_to_document_inline_block(inline_vs_pos, block_vs_pos, decoded.node.ownerDocument);
        };
        if (!decoded_range_to_document_position.__argnames__) Object.defineProperties(decoded_range_to_document_position, {
            __argnames__ : {value: ["decoded"]},
            __module__ : {value: "read_book.cfi"}
        });

        function decoded_node_or_spatial_offset_to_document_position(decoded) {
            var node, rect, _unpack, percentx, percenty, viewx, viewy, doc_left, doc_top, block_vs_pos, inline_vs_pos;
            node = decoded.node;
            rect = node.getBoundingClientRect();
            _unpack = [decoded.x, decoded.y];
            percentx = _unpack[0];
            percenty = _unpack[1];
            if (typeof percentx === "number" && node.offsetWidth && typeof percenty === "number" && node.offsetHeight) {
                viewx = rect.left + percentx * node.offsetWidth / 100;
                viewy = rect.top + percenty * node.offsetHeight / 100;
                _unpack = scroll_viewport.viewport_to_document(viewx, viewy, node.ownerDocument);
_unpack = _unpack_asarray(2, _unpack);
                doc_left = _unpack[0];
                doc_top = _unpack[1];
                return [doc_left, doc_top];
            } else {
                if (decoded.forward) {
                    block_vs_pos = scroll_viewport.rect_block_end(rect);
                } else {
                    block_vs_pos = scroll_viewport.rect_block_start(rect);
                }
                inline_vs_pos = scroll_viewport.rect_inline_start(rect);
                return scroll_viewport.viewport_to_document_inline_block(inline_vs_pos, block_vs_pos, node.ownerDocument);
            }
        };
        if (!decoded_node_or_spatial_offset_to_document_position.__argnames__) Object.defineProperties(decoded_node_or_spatial_offset_to_document_position, {
            __argnames__ : {value: ["decoded"]},
            __module__ : {value: "read_book.cfi"}
        });

        function decoded_to_document_position(decoded) {
            var node;
            node = decoded.node;
            if (decoded.range !== null) {
                return decoded_range_to_document_position(decoded);
            } else if (node !== null && node.getBoundingClientRect) {
                return decoded_node_or_spatial_offset_to_document_position(decoded);
            }
            return [null, null];
        };
        if (!decoded_to_document_position.__argnames__) Object.defineProperties(decoded_to_document_position, {
            __argnames__ : {value: ["decoded"]},
            __module__ : {value: "read_book.cfi"}
        });

        function scroll_to(cfi, callback, doc) {
            var decoded, fn;
            decoded = decode_with_range(cfi, doc);
            if (!decoded) {
                print("No location information found for cfi: " + cfi);
                return;
            }
            if (typeof decoded.time === "number") {
                set_current_time(decoded.node, decoded.time);
            }
            function handle_text_node() {
                var r, _unpack, so, eo, original_node, node_parent, original_node_index, ndoc, span;
                r = decoded.range;
                _unpack = [r.startOffset, r.endOffset];
                so = _unpack[0];
                eo = _unpack[1];
                original_node = r.startContainer;
                node_parent = original_node.parentNode;
                original_node_index = 0;
                for (var i = 0; i < node_parent.childNodes.length; i++) {
                    if ((_expr_temp = node_parent.childNodes)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i].isSameNode(original_node)) {
                        original_node_index = i;
                        break;
                    }
                }
                ndoc = original_node.ownerDocument || document;
                span = ndoc.createElement("span");
                span.setAttribute("style", "border-width: 0; padding: 0; margin: 0");
                r.surroundContents(span);
                scroll_viewport.scroll_into_view(span);
                return (function() {
                    var _anonfunc = function () {
                        var p, node, offset, _unpack, doc_x, doc_y;
                        p = span.parentNode;
                        var _Iter5 = _Iterable(span.childNodes);
                        for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                            node = _Iter5[_Index5];
                            span.removeChild(node);
                            p.insertBefore(node, span);
                        }
                        p.removeChild(span);
                        p.normalize();
                        original_node = (_expr_temp = node_parent.childNodes)[(typeof original_node_index === "number" && original_node_index < 0) ? _expr_temp.length + original_node_index : original_node_index];
                        if (!original_node) {
                            return;
                        }
                        offset = so;
                        while (offset > -1) {
                            try {
                                r.setStart(original_node, offset);
                                break;
                            } catch (_Exception) {
                                _last_exception = _Exception;
                                {
                                    offset -= 1;
                                } 
                            }
                        }
                        offset = eo;
                        while (offset > -1) {
                            try {
                                r.setEnd(original_node, offset);
                                break;
                            } catch (_Exception) {
                                _last_exception = _Exception;
                                {
                                    offset -= 1;
                                } 
                            }
                        }
                        _unpack = decoded_range_to_document_position(decoded);
_unpack = _unpack_asarray(2, _unpack);
                        doc_x = _unpack[0];
                        doc_y = _unpack[1];
                        if (doc_x === null || doc_y === null) {
                            return;
                        }
                        if (scroll_viewport.rtl) {
                            doc_x += scroll_viewport.width();
                        }
                        if (callback) {
                            callback(doc_x, doc_y);
                        }
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.cfi"}
                    });
                    return _anonfunc;
                })();
            };
            if (!handle_text_node.__module__) Object.defineProperties(handle_text_node, {
                __module__ : {value: "read_book.cfi"}
            });

            function handle_element_node() {
                var node;
                node = decoded.node;
                if (node.nodeType === Node.TEXT_NODE) {
                    node = decoded.node = node.parentNode;
                }
                if (!node.scrollIntoView) {
                    return;
                }
                scroll_viewport.scroll_into_view(node);
                return (function() {
                    var _anonfunc = function () {
                        var _unpack, doc_x, doc_y;
                        _unpack = decoded_node_or_spatial_offset_to_document_position(decoded);
_unpack = _unpack_asarray(2, _unpack);
                        doc_x = _unpack[0];
                        doc_y = _unpack[1];
                        if (doc_x === null || doc_y === null) {
                            return;
                        }
                        if (scroll_viewport.rtl) {
                            doc_x += scroll_viewport.width();
                        }
                        if (callback) {
                            callback(doc_x, doc_y);
                        }
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.cfi"}
                    });
                    return _anonfunc;
                })();
            };
            if (!handle_element_node.__module__) Object.defineProperties(handle_element_node, {
                __module__ : {value: "read_book.cfi"}
            });

            if (decoded.range !== null) {
                fn = handle_text_node();
            } else {
                fn = handle_element_node();
            }
            setTimeout(fn, 10);
        };
        if (!scroll_to.__argnames__) Object.defineProperties(scroll_to, {
            __argnames__ : {value: ["cfi", "callback", "doc"]},
            __module__ : {value: "read_book.cfi"}
        });

        function at_point(x, y) {
            var cfi, decoded, _unpack, cfix, cfiy;
            function dist(p1, p2) {
                Math.sqrt(Math.pow(p1[0] - p2[0], 2), Math.pow(p1[1] - p2[1], 2));
            };
            if (!dist.__argnames__) Object.defineProperties(dist, {
                __argnames__ : {value: ["p1", "p2"]},
                __module__ : {value: "read_book.cfi"}
            });

            try {
                cfi = at(x, y);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    cfi = null;
                } 
            }
            if (cfi === null) {
                return null;
            }
            try {
                decoded = decode_with_range(cfi);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    decoded = null;
                } 
            }
            if (!decoded) {
                return null;
            }
            if (cfi) {
                try {
                    _unpack = decoded_to_document_position(decoded);
_unpack = _unpack_asarray(2, _unpack);
                    cfix = _unpack[0];
                    cfiy = _unpack[1];
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        cfix = cfiy = null;
                    } 
                }
                if (cfix === null || cfiy === null || dist(scroll_viewport.viewport_to_document(x, y), [cfix, cfiy]) > 50) {
                    cfi = null;
                }
            }
            return cfi;
        };
        if (!at_point.__argnames__) Object.defineProperties(at_point, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.cfi"}
        });

        function at_current() {
            var _unpack, wini, winb, deltai, deltab, startb, endb, starti, endi, up_boundb, up_boundi, low_boundb, low_boundi, at_point_conditional, curb, cfi, x, y, de, rect, px, py;
            _unpack = [scroll_viewport.inline_size() - 1, scroll_viewport.block_size() - 1];
            wini = _unpack[0];
            winb = _unpack[1];
            deltai = deltab = max(8, min(Math.ceil(rem_size() / 2), 32));
            if (scroll_viewport.horizontal_writing_mode) {
                startb = 0;
                endb = winb;
                if (scroll_viewport.ltr) {
                    starti = 0;
                    endi = wini;
                } else {
                    starti = wini;
                    endi = 0;
                    deltai = -deltai;
                }
            } else {
                starti = 0;
                endi = winb;
                if (scroll_viewport.rtl) {
                    startb = winb;
                    endb = 0;
                    deltab = -deltab;
                } else {
                    startb = 0;
                    endb = winb;
                }
            }
            up_boundb = max(startb, endb);
            up_boundi = max(starti, endi);
            low_boundb = min(startb, endb);
            low_boundi = min(starti, endi);
            function at_point_vertical_mode(i, b) {
                return at_point(b, i);
            };
            if (!at_point_vertical_mode.__argnames__) Object.defineProperties(at_point_vertical_mode, {
                __argnames__ : {value: ["i", "b"]},
                __module__ : {value: "read_book.cfi"}
            });

            at_point_conditional = (scroll_viewport.vertical_writing_mode) ? at_point_vertical_mode : at_point;
            function i_loop(curb) {
                var curi, cfi;
                curi = starti;
                while (low_boundi <= curi && curi <= up_boundi) {
                    cfi = at_point_conditional(curi, curb);
                    if (cfi) {
                        return cfi;
                    }
                    curi += deltai;
                }
            };
            if (!i_loop.__argnames__) Object.defineProperties(i_loop, {
                __argnames__ : {value: ["curb"]},
                __module__ : {value: "read_book.cfi"}
            });

            curb = startb;
            cfi = null;
            while (low_boundb <= curb && curb <= up_boundb && !cfi) {
                cfi = i_loop(curb);
                curb += deltab;
            }
            if (cfi) {
                return cfi;
            }
            _unpack = [scroll_viewport.x() + ((scroll_viewport.ltr) ? 0 : scroll_viewport.width()), 
            scroll_viewport.y()];
            x = _unpack[0];
            y = _unpack[1];
            de = document.documentElement;
            rect = de.getBoundingClientRect();
            px = x * 100 / rect.width;
            py = y * 100 / rect.height;
            cfi = str.format("/2@{}:{}", fstr(px), fstr(py));
            return cfi;
        };
        if (!at_current.__module__) Object.defineProperties(at_current, {
            __module__ : {value: "read_book.cfi"}
        });

        function cfi_for_selection(r) {
            if (!r) {
                r = window.getSelection().getRangeAt(0);
            }
            function pos(container, offset) {
                var nt;
                nt = container.nodeType;
                if (nt === Node.TEXT_NODE || nt === Node.CDATA_SECTION_NODE || nt === Node.COMMENT_NODE) {
                    return [container, offset];
                }
                if (nt === Node.ELEMENT_NODE && offset && container.childNodes.length > offset) {
                    return [(_expr_temp = container.childNodes)[(typeof offset === "number" && offset < 0) ? _expr_temp.length + offset : offset], 
                    0];
                }
                return [container, offset];
            };
            if (!pos.__argnames__) Object.defineProperties(pos, {
                __argnames__ : {value: ["container", "offset"]},
                __module__ : {value: "read_book.cfi"}
            });

            return (function(){
                var _d = Object.create(null);
                _d["start"] = encode.apply(this, [r.startContainer.ownerDocument].concat(pos(r.startContainer, r.startOffset)));
                _d["end"] = encode.apply(this, [r.endContainer.ownerDocument].concat(pos(r.endContainer, r.endOffset)));
                return _d;
            }).call(this);
        };
        if (!cfi_for_selection.__argnames__) Object.defineProperties(cfi_for_selection, {
            __argnames__ : {value: ["r"]},
            __module__ : {value: "read_book.cfi"}
        });

        function range_from_cfi(start, end) {
            var r;
            start = decode(start);
            end = decode(end);
            if (!start || start.error || !end || end.error) {
                return;
            }
            r = document.createRange();
            r.setStart(start.node, start.offset);
            r.setEnd(end.node, end.offset);
            return r;
        };
        if (!range_from_cfi.__argnames__) Object.defineProperties(range_from_cfi, {
            __argnames__ : {value: ["start", "end"]},
            __module__ : {value: "read_book.cfi"}
        });

        _modules["read_book.cfi"].escape_pat = escape_pat;
        _modules["read_book.cfi"].unescape_pat = unescape_pat;
        _modules["read_book.cfi"].escape_for_cfi = escape_for_cfi;
        _modules["read_book.cfi"].unescape_from_cfi = unescape_from_cfi;
        _modules["read_book.cfi"].fstr = fstr;
        _modules["read_book.cfi"].get_current_time = get_current_time;
        _modules["read_book.cfi"].id_is_unique = id_is_unique;
        _modules["read_book.cfi"].range_has_point = range_has_point;
        _modules["read_book.cfi"].offset_in_text_node = offset_in_text_node;
        _modules["read_book.cfi"].find_offset_for_point = find_offset_for_point;
        _modules["read_book.cfi"].set_current_time = set_current_time;
        _modules["read_book.cfi"].is_text_node = is_text_node;
        _modules["read_book.cfi"].text_length_in_range_wrapper = text_length_in_range_wrapper;
        _modules["read_book.cfi"].adjust_node_for_text_offset = adjust_node_for_text_offset;
        _modules["read_book.cfi"].unwrapped_nodes = unwrapped_nodes;
        _modules["read_book.cfi"].increment_index_for_child = increment_index_for_child;
        _modules["read_book.cfi"].increment_index_for_children = increment_index_for_children;
        _modules["read_book.cfi"].non_range_wrapper_parent = non_range_wrapper_parent;
        _modules["read_book.cfi"].encode = encode;
        _modules["read_book.cfi"].node_at_index = node_at_index;
        _modules["read_book.cfi"].node_for_path_step = node_for_path_step;
        _modules["read_book.cfi"].node_for_text_offset = node_for_text_offset;
        _modules["read_book.cfi"].decode = decode;
        _modules["read_book.cfi"].cfi_sort_key = cfi_sort_key;
        _modules["read_book.cfi"].create_cfi_cmp = create_cfi_cmp;
        _modules["read_book.cfi"].sort_cfis = sort_cfis;
        _modules["read_book.cfi"].at = at;
        _modules["read_book.cfi"].decode_with_range = decode_with_range;
        _modules["read_book.cfi"].decoded_range_to_document_position = decoded_range_to_document_position;
        _modules["read_book.cfi"].decoded_node_or_spatial_offset_to_document_position = decoded_node_or_spatial_offset_to_document_position;
        _modules["read_book.cfi"].decoded_to_document_position = decoded_to_document_position;
        _modules["read_book.cfi"].scroll_to = scroll_to;
        _modules["read_book.cfi"].at_point = at_point;
        _modules["read_book.cfi"].at_current = at_current;
        _modules["read_book.cfi"].cfi_for_selection = cfi_for_selection;
        _modules["read_book.cfi"].range_from_cfi = range_from_cfi;
    })();

    (function(){
        var __name__ = "read_book.annotations";
        var no_cfi, field_map, getter_map;
        var _ = _modules.gettext.gettext;

        var create_cfi_cmp = _modules["read_book.cfi"].create_cfi_cmp;
        var cfi_sort_key = _modules["read_book.cfi"].cfi_sort_key;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        no_cfi = "/99999999";
        function bookmark_get_cfi(b) {
            if (b.pos_type === "epubcfi") {
                return b.pos.slice(8, -1);
            }
            return no_cfi;
        };
        if (!bookmark_get_cfi.__argnames__) Object.defineProperties(bookmark_get_cfi, {
            __argnames__ : {value: ["b"]},
            __module__ : {value: "read_book.annotations"}
        });

        function highlight_get_cfi(hl) {
            var cfi, si;
            cfi = hl.start_cfi;
            if (cfi) {
                si = (_exists.n(hl.spine_index)) ? "/" + _str.format("{}", hl.spine_index) + "" : no_cfi;
                return si + cfi;
            }
            return no_cfi;
        };
        if (!highlight_get_cfi.__argnames__) Object.defineProperties(highlight_get_cfi, {
            __argnames__ : {value: ["hl"]},
            __module__ : {value: "read_book.annotations"}
        });

        function sort_annot_list(annots, get_cfi_func) {
            var key_map, cfi, annot, cfi_cmp;
            key_map = (function(){
                var _d = Object.create(null);
                _d[no_cfi] = cfi_sort_key(no_cfi);
                return _d;
            }).call(this);
            var _Iter0 = _Iterable(annots);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                annot = _Iter0[_Index0];
                cfi = get_cfi_func(annot);
                if (cfi && !key_map[(typeof cfi === "number" && cfi < 0) ? key_map.length + cfi : cfi]) {
                    key_map[(typeof cfi === "number" && cfi < 0) ? key_map.length + cfi : cfi] = cfi_sort_key(cfi);
                }
            }
            cfi_cmp = create_cfi_cmp(key_map);
            annots.sort((function() {
                var _anonfunc = function (a, b) {
                    var acfi, bcfi;
                    acfi = get_cfi_func(a);
                    bcfi = get_cfi_func(b);
                    return cfi_cmp(acfi, bcfi);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "read_book.annotations"}
                });
                return _anonfunc;
            })());
        };
        if (!sort_annot_list.__argnames__) Object.defineProperties(sort_annot_list, {
            __argnames__ : {value: ["annots", "get_cfi_func"]},
            __module__ : {value: "read_book.annotations"}
        });

        function annots_descending_cmp(a, b) {
            return (a.timestamp > b.timestamp) ? -1 : (a.timestamp < b.timestamp) ? 1 : 0;
        };
        if (!annots_descending_cmp.__argnames__) Object.defineProperties(annots_descending_cmp, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "read_book.annotations"}
        });

        function merge_annots_with_identical_field(annots_a, annots_b, field, cfi_getter_func) {
            var title_groups, changed, all_annots, q, a, tg, seen, ans, title, candidates;
            title_groups = Object.create(null);
            changed = false;
            all_annots = annots_a.concat(annots_b);
            var _Iter1 = _Iterable(all_annots);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                a = _Iter1[_Index1];
                q = title_groups[_bound_index(a[(typeof field === "number" && field < 0) ? a.length + field : field], title_groups)];
                if (!q) {
                    q = title_groups[_bound_index(a[(typeof field === "number" && field < 0) ? a.length + field : field], title_groups)] = [];
                }
                q.push(a);
            }
            var _Iter2 = _Iterable(Object.values(title_groups));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                tg = _Iter2[_Index2];
                tg.sort(annots_descending_cmp);
            }
            seen = Object.create(null);
            ans = [];
            var _Iter3 = _Iterable(all_annots);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                a = _Iter3[_Index3];
                title = a[(typeof field === "number" && field < 0) ? a.length + field : field];
                if (!seen[(typeof title === "number" && title < 0) ? seen.length + title : title]) {
                    seen[(typeof title === "number" && title < 0) ? seen.length + title : title] = true;
                    candidates = title_groups[(typeof title === "number" && title < 0) ? title_groups.length + title : title];
                    if (!changed && candidates.length > 1 && candidates[0].timestamp !== candidates[1].timestamp) {
                        changed = true;
                    }
                    ans.push(title_groups[(typeof title === "number" && title < 0) ? title_groups.length + title : title][0]);
                }
            }
            if (ans.length !== annots_a.length || ans.length !== annots_b.length) {
                changed = true;
            }
            if (changed) {
                sort_annot_list(ans, cfi_getter_func);
            }
            return [changed, ans];
        };
        if (!merge_annots_with_identical_field.__argnames__) Object.defineProperties(merge_annots_with_identical_field, {
            __argnames__ : {value: ["annots_a", "annots_b", "field", "cfi_getter_func"]},
            __module__ : {value: "read_book.annotations"}
        });

        field_map = (function(){
            var _d = Object.create(null);
            _d["bookmark"] = "title";
            _d["highlight"] = "uuid";
            return _d;
        }).call(this);
        getter_map = (function(){
            var _d = Object.create(null);
            _d["bookmark"] = bookmark_get_cfi;
            _d["highlight"] = highlight_get_cfi;
            return _d;
        }).call(this);
        function merge_annot_lists(a, b, field) {
            var key_field;
            key_field = field_map[(typeof field === "number" && field < 0) ? field_map.length + field : field];
            return merge_annots_with_identical_field(a, b, key_field, getter_map[(typeof field === "number" && field < 0) ? getter_map.length + field : field]);
        };
        if (!merge_annot_lists.__argnames__) Object.defineProperties(merge_annot_lists, {
            __argnames__ : {value: ["a", "b", "field"]},
            __module__ : {value: "read_book.annotations"}
        });

        function merge_annotation_maps(a, b) {
            var updated, ans, a_items, b_items, _unpack, changed, field;
            updated = false;
            ans = Object.create(null);
            var _Iter4 = _Iterable(field_map);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                field = _Iter4[_Index4];
                a_items = a[(typeof field === "number" && field < 0) ? a.length + field : field] || [];
                b_items = b[(typeof field === "number" && field < 0) ? b.length + field : field] || [];
                if (!a_items.length) {
                    ans[(typeof field === "number" && field < 0) ? ans.length + field : field] = b_items;
                    updated = true;
                    continue;
                }
                if (!b_items.length) {
                    ans[(typeof field === "number" && field < 0) ? ans.length + field : field] = a_items;
                    continue;
                }
                _unpack = merge_annot_lists(a_items, b_items, field);
_unpack = _unpack_asarray(2, _unpack);
                changed = _unpack[0];
                ans[(typeof field === "number" && field < 0) ? ans.length + field : field] = _unpack[1];
                if (changed) {
                    updated = true;
                }
            }
            return [updated, ans];
        };
        if (!merge_annotation_maps.__argnames__) Object.defineProperties(merge_annotation_maps, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "read_book.annotations"}
        });

        function AnnotationsManager() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            AnnotationsManager.prototype.__bind_methods__.call(this);
            AnnotationsManager.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(AnnotationsManager.prototype, "__bind_methods__", {value: function () {
            this.sync_annots_to_server = AnnotationsManager.prototype.sync_annots_to_server.bind(this);
            this.set_bookmarks = AnnotationsManager.prototype.set_bookmarks.bind(this);
            this.all_bookmarks = AnnotationsManager.prototype.all_bookmarks.bind(this);
            this.add_bookmark = AnnotationsManager.prototype.add_bookmark.bind(this);
            this.remove_bookmark = AnnotationsManager.prototype.remove_bookmark.bind(this);
            this.edit_bookmark = AnnotationsManager.prototype.edit_bookmark.bind(this);
            this.default_bookmark_title = AnnotationsManager.prototype.default_bookmark_title.bind(this);
            this.set_highlights = AnnotationsManager.prototype.set_highlights.bind(this);
            this.all_highlights = AnnotationsManager.prototype.all_highlights.bind(this);
            this.merge_highlights = AnnotationsManager.prototype.merge_highlights.bind(this);
            this.remove_highlight = AnnotationsManager.prototype.remove_highlight.bind(this);
            this.delete_highlight = AnnotationsManager.prototype.delete_highlight.bind(this);
            this.notes_for_highlight = AnnotationsManager.prototype.notes_for_highlight.bind(this);
            this.text_for_highlight = AnnotationsManager.prototype.text_for_highlight.bind(this);
            this.set_notes_for_highlight = AnnotationsManager.prototype.set_notes_for_highlight.bind(this);
            this.style_for_highlight = AnnotationsManager.prototype.style_for_highlight.bind(this);
            this.data_for_highlight = AnnotationsManager.prototype.data_for_highlight.bind(this);
            this.spine_index_for_highlight = AnnotationsManager.prototype.spine_index_for_highlight.bind(this);
            this.cfi_for_highlight = AnnotationsManager.prototype.cfi_for_highlight.bind(this);
            this.add_highlight = AnnotationsManager.prototype.add_highlight.bind(this);
            this.highlights_for_currently_showing = AnnotationsManager.prototype.highlights_for_currently_showing.bind(this);
        }});
        AnnotationsManager.prototype.__init__ = function __init__(view) {
            var self = this;
            self.view = view;
            self.set_highlights();
            self.set_bookmarks();
        };
        if (!AnnotationsManager.prototype.__init__.__argnames__) Object.defineProperties(AnnotationsManager.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.__argnames__ = AnnotationsManager.prototype.__init__.__argnames__;
        AnnotationsManager.__handles_kwarg_interpolation__ = AnnotationsManager.prototype.__init__.__handles_kwarg_interpolation__;
        AnnotationsManager.prototype.sync_annots_to_server = function sync_annots_to_server(which) {
            var self = this;
            var amap;
            if (ui_operations.annots_changed) {
                amap = Object.create(null);
                if (!which || which === "bookmarks") {
                    amap.bookmark = self.bookmarks.as_array();
                }
                if (!which || which === "highlights") {
                    amap.highlight = Object.values(self.highlights);
                }
                ui_operations.annots_changed(amap);
            }
        };
        if (!AnnotationsManager.prototype.sync_annots_to_server.__argnames__) Object.defineProperties(AnnotationsManager.prototype.sync_annots_to_server, {
            __argnames__ : {value: ["which"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.set_bookmarks = function set_bookmarks(bookmarks) {
            var self = this;
            bookmarks = bookmarks || [];
            self.bookmarks = list(bookmarks);
        };
        if (!AnnotationsManager.prototype.set_bookmarks.__argnames__) Object.defineProperties(AnnotationsManager.prototype.set_bookmarks, {
            __argnames__ : {value: ["bookmarks"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.all_bookmarks = function all_bookmarks() {
            var self = this;
            return self.bookmarks;
        };
        if (!AnnotationsManager.prototype.all_bookmarks.__module__) Object.defineProperties(AnnotationsManager.prototype.all_bookmarks, {
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.add_bookmark = function add_bookmark(title, cfi) {
            var self = this;
            var b;
            if (!title || !cfi) {
                return;
            }
            self.bookmarks = (function() {
                var _Iter = _Iterable(self.bookmarks), _Result = [], b;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    b = _Iter[_Index];
                    if (b.title !== title) {
                        _Result.push(b);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            self.bookmarks.push((function(){
                var _d = Object.create(null);
                _d["type"] = "bookmark";
                _d["timestamp"] = (new Date).toISOString();
                _d["pos_type"] = "epubcfi";
                _d["pos"] = cfi;
                _d["title"] = title;
                return _d;
            }).call(this));
            sort_annot_list(self.bookmarks, bookmark_get_cfi);
            self.sync_annots_to_server("bookmarks");
        };
        if (!AnnotationsManager.prototype.add_bookmark.__argnames__) Object.defineProperties(AnnotationsManager.prototype.add_bookmark, {
            __argnames__ : {value: ["title", "cfi"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.remove_bookmark = function remove_bookmark(title) {
            var self = this;
            var changed, b;
            changed = false;
            var _Iter5 = _Iterable(self.bookmarks);
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                b = _Iter5[_Index5];
                if (b.title === title) {
                    b.removed = true;
                    b.timestamp = (new Date).toISOString();
                    changed = true;
                }
            }
            if (changed) {
                self.sync_annots_to_server("bookmarks");
            }
            return changed;
        };
        if (!AnnotationsManager.prototype.remove_bookmark.__argnames__) Object.defineProperties(AnnotationsManager.prototype.remove_bookmark, {
            __argnames__ : {value: ["title"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.edit_bookmark = function edit_bookmark(title, new_title) {
            var self = this;
            var changed, b;
            changed = false;
            var _Iter6 = _Iterable(self.bookmarks);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                b = _Iter6[_Index6];
                if (b.title === title) {
                    b.title = new_title;
                    b.timestamp = (new Date).toISOString();
                    changed = true;
                }
            }
            if (changed) {
                self.sync_annots_to_server("bookmarks");
            }
            return changed;
        };
        if (!AnnotationsManager.prototype.edit_bookmark.__argnames__) Object.defineProperties(AnnotationsManager.prototype.edit_bookmark, {
            __argnames__ : {value: ["title", "new_title"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.default_bookmark_title = function default_bookmark_title(base_default_title) {
            var self = this;
            var all_titles, bm, c, default_title;
            all_titles = (function() {
                var _Iter = _Iterable(self.bookmarks), _Result = Object.create(null), bm;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    bm = _Iter[_Index];
                    if (!bm.removed) {
                        _Result[bm.title] = (true);
                    }
                }
                return _Result;
            })();
            base_default_title = base_default_title || _("Bookmark");
            c = 0;
            while (true) {
                c += 1;
                default_title = "" + _str.format("{}", base_default_title) + " #" + _str.format("{}", c) + "";
                if (!all_titles[(typeof default_title === "number" && default_title < 0) ? all_titles.length + default_title : default_title]) {
                    return default_title;
                }
            }
        };
        if (!AnnotationsManager.prototype.default_bookmark_title.__argnames__) Object.defineProperties(AnnotationsManager.prototype.default_bookmark_title, {
            __argnames__ : {value: ["base_default_title"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.set_highlights = function set_highlights(highlights) {
            var self = this;
            var h;
            highlights = highlights || [];
            self.highlights = (function() {
                var _Iter = _Iterable(highlights), _Result = Object.create(null), h;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    h = _Iter[_Index];
                    _Result[h.uuid] = (h);
                }
                return _Result;
            })();
        };
        if (!AnnotationsManager.prototype.set_highlights.__argnames__) Object.defineProperties(AnnotationsManager.prototype.set_highlights, {
            __argnames__ : {value: ["highlights"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.all_highlights = function all_highlights() {
            var self = this;
            var ans;
            ans = (function() {
                var _Iter = _Iterable(Object.values(self.highlights)), _Result = [], h;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    h = _Iter[_Index];
                    if (!h.removed) {
                        _Result.push(h);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })().as_array();
            sort_annot_list(ans, highlight_get_cfi);
            return ans;
        };
        if (!AnnotationsManager.prototype.all_highlights.__module__) Object.defineProperties(AnnotationsManager.prototype.all_highlights, {
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.merge_highlights = function merge_highlights(highlights) {
            var self = this;
            var updated, base, newvals, _unpack, ans;
            highlights = highlights || [];
            updated = false;
            if (highlights.length) {
                base = (function(){
                    var _d = Object.create(null);
                    _d["highlight"] = Object.values(self.highlights);
                    return _d;
                }).call(this);
                newvals = (function(){
                    var _d = Object.create(null);
                    _d["highlight"] = highlights;
                    return _d;
                }).call(this);
                _unpack = merge_annotation_maps(base, newvals);
_unpack = _unpack_asarray(2, _unpack);
                updated = _unpack[0];
                ans = _unpack[1];
                if (updated) {
                    self.set_highlights(ans.highlight);
                }
            }
            return updated;
        };
        if (!AnnotationsManager.prototype.merge_highlights.__argnames__) Object.defineProperties(AnnotationsManager.prototype.merge_highlights, {
            __argnames__ : {value: ["highlights"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.remove_highlight = function remove_highlight(uuid) {
            var self = this;
            var h;
            h = (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid];
            if (h) {
                h.timestamp = (new Date).toISOString();
                h.removed = true;
                delete h.style;
                delete h.highlighted_text;
                delete h.start_cfi;
                delete h.end_cfi;
                delete h.notes;
                delete h.spine_name;
                delete h.spine_index;
                delete h.toc_family_titles;
                return true;
            }
        };
        if (!AnnotationsManager.prototype.remove_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.remove_highlight, {
            __argnames__ : {value: ["uuid"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.delete_highlight = function delete_highlight(uuid) {
            var self = this;
            if (self.remove_highlight(uuid)) {
                self.sync_annots_to_server("highlights");
            }
        };
        if (!AnnotationsManager.prototype.delete_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.delete_highlight, {
            __argnames__ : {value: ["uuid"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.notes_for_highlight = function notes_for_highlight(uuid) {
            var self = this;
            var h;
            h = (uuid) ? (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid] : null;
            if (h) {
                return h.notes;
            }
        };
        if (!AnnotationsManager.prototype.notes_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.notes_for_highlight, {
            __argnames__ : {value: ["uuid"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.text_for_highlight = function text_for_highlight(uuid) {
            var self = this;
            var h;
            h = (uuid) ? (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid] : null;
            if (h) {
                return h.highlighted_text;
            }
        };
        if (!AnnotationsManager.prototype.text_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.text_for_highlight, {
            __argnames__ : {value: ["uuid"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.set_notes_for_highlight = function set_notes_for_highlight(uuid, notes) {
            var self = this;
            var h;
            h = (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid];
            if (h) {
                if (notes) {
                    h.notes = notes;
                } else {
                    delete h.notes;
                }
                self.sync_annots_to_server("highlights");
                return true;
            }
            return false;
        };
        if (!AnnotationsManager.prototype.set_notes_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.set_notes_for_highlight, {
            __argnames__ : {value: ["uuid", "notes"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.style_for_highlight = function style_for_highlight(uuid) {
            var self = this;
            var h;
            h = (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid];
            if (h) {
                return h.style;
            }
        };
        if (!AnnotationsManager.prototype.style_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.style_for_highlight, {
            __argnames__ : {value: ["uuid"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.data_for_highlight = function data_for_highlight(uuid) {
            var self = this;
            return (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid];
        };
        if (!AnnotationsManager.prototype.data_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.data_for_highlight, {
            __argnames__ : {value: ["uuid"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.spine_index_for_highlight = function spine_index_for_highlight(uuid, spine) {
            var self = this;
            var h, ans, name, idx;
            h = (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid];
            if (!h) {
                return -1;
            }
            ans = h.spine_index;
            name = h.spine_name;
            if (name) {
                idx = spine.indexOf(name);
                if (idx > -1) {
                    ans = idx;
                }
            }
            return ans;
        };
        if (!AnnotationsManager.prototype.spine_index_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.spine_index_for_highlight, {
            __argnames__ : {value: ["uuid", "spine"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.cfi_for_highlight = function cfi_for_highlight(uuid, spine_index) {
            var self = this;
            var h, x;
            h = (_expr_temp = self.highlights)[(typeof uuid === "number" && uuid < 0) ? _expr_temp.length + uuid : uuid];
            if (h) {
                x = 2 * (spine_index + 1);
                return "epubcfi(/" + _str.format("{}", x) + "" + _str.format("{}", h.start_cfi) + ")";
            }
        };
        if (!AnnotationsManager.prototype.cfi_for_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.cfi_for_highlight, {
            __argnames__ : {value: ["uuid", "spine_index"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.add_highlight = function add_highlight(msg, style, notes, toc_family) {
            var self = this;
            var now, uuid, annot, toc_family_titles, x;
            now = (new Date).toISOString();
            var _Iter7 = _Iterable(msg.removed_highlights);
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                uuid = _Iter7[_Index7];
                self.remove_highlight(uuid);
            }
            annot = (_expr_temp = self.highlights)[_bound_index(msg.uuid, _expr_temp)] = (function(){
                var _d = Object.create(null);
                _d["type"] = "highlight";
                _d["timestamp"] = now;
                _d["uuid"] = msg.uuid;
                _d["highlighted_text"] = msg.highlighted_text;
                _d["start_cfi"] = msg.bounds.start;
                _d["end_cfi"] = msg.bounds.end;
                _d["style"] = style;
                _d["spine_name"] = self.view.currently_showing.name;
                _d["spine_index"] = self.view.currently_showing.spine_index;
                return _d;
            }).call(this);
            if (notes) {
                annot.notes = notes;
            }
            if ((typeof toc_family !== "undefined" && toc_family !== null ? toc_family : Object.create(null)).length) {
                toc_family_titles = [];
                var _Iter8 = _Iterable(toc_family);
                for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                    x = _Iter8[_Index8];
                    if (x.title) {
                        toc_family_titles.push(x.title);
                    }
                }
                annot.toc_family_titles = toc_family_titles;
            }
            self.sync_annots_to_server("highlights");
        };
        if (!AnnotationsManager.prototype.add_highlight.__argnames__) Object.defineProperties(AnnotationsManager.prototype.add_highlight, {
            __argnames__ : {value: ["msg", "style", "notes", "toc_family"]},
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.highlights_for_currently_showing = function highlights_for_currently_showing() {
            var self = this;
            var name, ans, h;
            name = self.view.currently_showing.name;
            ans = [];
            var _Iter9 = _Iterable(Object.values(self.highlights));
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                h = _Iter9[_Index9];
                if (h.spine_name === name && !h.removed && h.start_cfi) {
                    ans.push(h);
                }
            }
            return ans;
        };
        if (!AnnotationsManager.prototype.highlights_for_currently_showing.__module__) Object.defineProperties(AnnotationsManager.prototype.highlights_for_currently_showing, {
            __module__ : {value: "read_book.annotations"}
        });
        AnnotationsManager.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        AnnotationsManager.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(AnnotationsManager.prototype, "__bases__", {value: []});

        _modules["read_book.annotations"].no_cfi = no_cfi;
        _modules["read_book.annotations"].field_map = field_map;
        _modules["read_book.annotations"].getter_map = getter_map;
        _modules["read_book.annotations"].bookmark_get_cfi = bookmark_get_cfi;
        _modules["read_book.annotations"].highlight_get_cfi = highlight_get_cfi;
        _modules["read_book.annotations"].sort_annot_list = sort_annot_list;
        _modules["read_book.annotations"].annots_descending_cmp = annots_descending_cmp;
        _modules["read_book.annotations"].merge_annots_with_identical_field = merge_annots_with_identical_field;
        _modules["read_book.annotations"].merge_annot_lists = merge_annot_lists;
        _modules["read_book.annotations"].merge_annotation_maps = merge_annotation_maps;
        _modules["read_book.annotations"].AnnotationsManager = AnnotationsManager;
    })();

    (function(){
        var __name__ = "read_book.db";
        var DB_NAME, DB_VERSION;
        var base64decode = _modules.encodings.base64decode;
        var base64encode = _modules.encodings.base64encode;

        var _ = _modules.gettext.gettext;

        var is_reading_book = _modules["book_list.router"].is_reading_book;

        var error_dialog = _modules.modals.error_dialog;

        var merge_annotation_maps = _modules["read_book.annotations"].merge_annotation_maps;

        var get_interface_data = _modules.session.get_interface_data;

        var username_key = _modules.utils.username_key;

        function upgrade_schema(idb, old_version, new_version, transaction) {
            var books_store;
            print("upgrade_schema:", old_version, new_version);
            if (!idb.objectStoreNames.contains("books")) {
                idb.createObjectStore("books", (function(){
                    var _d = Object.create(null);
                    _d["keyPath"] = "key";
                    return _d;
                }).call(this));
            }
            if (!idb.objectStoreNames.contains("files")) {
                idb.createObjectStore("files");
            }
            if (!idb.objectStoreNames.contains("mathjax")) {
                idb.createObjectStore("mathjax");
            }
            if (!idb.objectStoreNames.contains("objects")) {
                idb.createObjectStore("objects", (function(){
                    var _d = Object.create(null);
                    _d["keyPath"] = "key";
                    return _d;
                }).call(this));
            }
            books_store = transaction.objectStore("books");
            if (!books_store.indexNames.contains("recent_index")) {
                books_store.createIndex("recent_index", "recent_date");
            }
        };
        if (!upgrade_schema.__argnames__) Object.defineProperties(upgrade_schema, {
            __argnames__ : {value: ["idb", "old_version", "new_version", "transaction"]},
            __module__ : {value: "read_book.db"}
        });

        function file_store_name(book, name) {
            return book.book_hash + " " + name;
        };
        if (!file_store_name.__argnames__) Object.defineProperties(file_store_name, {
            __argnames__ : {value: ["book", "name"]},
            __module__ : {value: "read_book.db"}
        });

        function get_error_details(event) {
            var desc;
            desc = event.target;
            if (desc.error && desc.error.toString) {
                desc = desc.error.toString();
            } else if (desc.errorCode) {
                desc = desc.errorCode;
            } else if (desc.error) {
                desc = desc.error;
                if (desc.name === "QuotaExceededError") {
                    desc = _("Offline storage quota exceeded! Try deleting some stored books first.");
                } else if (desc.name) {
                    desc = desc.name;
                }
            }
            return desc || "Unknown Error";
        };
        if (!get_error_details.__argnames__) Object.defineProperties(get_error_details, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.db"}
        });

        function new_book(key, metadata) {
            return (function(){
                var _d = Object.create(null);
                _d["key"] = key;
                _d["is_complete"] = false;
                _d["stored_files"] = Object.create(null);
                _d["book_hash"] = null;
                _d["metadata"] = metadata;
                _d["manifest"] = null;
                _d["cover_width"] = null;
                _d["cover_height"] = null;
                _d["cover_name"] = null;
                _d["recent_date"] = new Date;
                _d["last_read"] = Object.create(null);
                _d["last_read_position"] = Object.create(null);
                _d["saved_reading_rates"] = Object.create(null);
                _d["annotations_map"] = Object.create(null);
                return _d;
            }).call(this);
        };
        if (!new_book.__argnames__) Object.defineProperties(new_book, {
            __argnames__ : {value: ["key", "metadata"]},
            __module__ : {value: "read_book.db"}
        });

        DB_NAME = "calibre";
        DB_VERSION = 1;
        function indexed_db_api() {
            if ((typeof window !== "undefined" && window !== null)) {
                return window.indexedDB;
            }
            if ((typeof self !== "undefined" && self !== null)) {
                return self.indexedDB;
            }
        };
        if (!indexed_db_api.__module__) Object.defineProperties(indexed_db_api, {
            __module__ : {value: "read_book.db"}
        });

        function DB() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            DB.prototype.__bind_methods__.call(this);
            DB.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(DB.prototype, "__bind_methods__", {value: function () {
            this.show_error = DB.prototype.show_error.bind(this);
            this.initialize_stage1 = DB.prototype.initialize_stage1.bind(this);
            this.initialize_stage2 = DB.prototype.initialize_stage2.bind(this);
            this.display_error = DB.prototype.display_error.bind(this);
            this.do_op = DB.prototype.do_op.bind(this);
            this.get_book = DB.prototype.get_book.bind(this);
            this.get_mathjax_info = DB.prototype.get_mathjax_info.bind(this);
            this.save_manifest = DB.prototype.save_manifest.bind(this);
            this.store_file = DB.prototype.store_file.bind(this);
            this.store_cover = DB.prototype.store_cover.bind(this);
            this.store_file_stage2 = DB.prototype.store_file_stage2.bind(this);
            this.clear_mathjax = DB.prototype.clear_mathjax.bind(this);
            this.store_mathjax_file = DB.prototype.store_mathjax_file.bind(this);
            this.finish_book = DB.prototype.finish_book.bind(this);
            this.finish_mathjax = DB.prototype.finish_mathjax.bind(this);
            this.update_last_read_time = DB.prototype.update_last_read_time.bind(this);
            this.update_metadata = DB.prototype.update_metadata.bind(this);
            this.save_reading_rates = DB.prototype.save_reading_rates.bind(this);
            this.update_annotations_data_from_key = DB.prototype.update_annotations_data_from_key.bind(this);
            this.get_file = DB.prototype.get_file.bind(this);
            this.get_book_file = DB.prototype.get_book_file.bind(this);
            this.get_mathjax_files = DB.prototype.get_mathjax_files.bind(this);
            this.get_recently_read_books = DB.prototype.get_recently_read_books.bind(this);
            this.has_book_matching = DB.prototype.has_book_matching.bind(this);
            this.delete_book = DB.prototype.delete_book.bind(this);
            this.delete_books_matching = DB.prototype.delete_books_matching.bind(this);
        }});
        DB.prototype.__init__ = function __init__(callback, show_read_book_error) {
            var self = this;
            self.initialized = false;
            self.is_ok = false;
            self.initialize_error_msg = null;
            self.callback = callback;
            self.show_read_book_error = show_read_book_error;
            self.initialize_stage1();
        };
        if (!DB.prototype.__init__.__argnames__) Object.defineProperties(DB.prototype.__init__, {
            __argnames__ : {value: ["callback", "show_read_book_error"]},
            __module__ : {value: "read_book.db"}
        });
        DB.__argnames__ = DB.prototype.__init__.__argnames__;
        DB.__handles_kwarg_interpolation__ = DB.prototype.__init__.__handles_kwarg_interpolation__;
        DB.prototype.show_error = function show_error(title, msg, det_msg) {
            var self = this;
            if (!(typeof window !== "undefined" && window !== null) || is_reading_book()) {
                self.show_read_book_error(title, msg, det_msg);
            } else {
                error_dialog(title, msg, det_msg);
            }
        };
        if (!DB.prototype.show_error.__argnames__) Object.defineProperties(DB.prototype.show_error, {
            __argnames__ : {value: ["title", "msg", "det_msg"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.initialize_stage1 = function initialize_stage1() {
            var self = this;
            var idb, request;
            idb = indexed_db_api();
            if (!idb) {
                self.initialize_error_msg = _("Your browser does not support IndexedDB. Cannot read books. Consider using a modern browser, such as Chrome or Firefox.");
                self.initialized = true;
                setTimeout(self.callback, 0);
                return;
            }
            request = idb.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (function() {
                var _anonfunc = function (event) {
                    upgrade_schema(event.target.result, event.oldVersion, event.newVersion, event.target.transaction);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            request.onblocked = (function() {
                var _anonfunc = function (event) {
                    self.initialize_error_msg = _("Please close all other browser tabs with calibre open");
                    self.initialized = true;
                    console.log(event);
                    self.callback();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            request.onerror = (function() {
                var _anonfunc = function (event) {
                    self.initialize_error_msg = _("You must allow calibre to use IndexedDB storage in your browser to read books");
                    self.initialized = true;
                    console.log(event);
                    self.callback();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            request.onsuccess = (function() {
                var _anonfunc = function (event) {
                    var blob, idb, store, req;
                    blob = new Blob(_list_decorate([ "test" ]), (function(){
                        var _d = Object.create(null);
                        _d["type"] = "text/plain";
                        return _d;
                    }).call(this));
                    idb = event.target.result;
                    store = idb.transaction(_list_decorate([ "files" ]), "readwrite").objectStore("files");
                    try {
                        req = store.put(blob, ":-test-blob-:");
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            self.initialize_stage2(idb, false);
                            return;
                        } 
                    }
                    req.onsuccess = (function() {
                        var _anonfunc = function (event) {
                            self.initialize_stage2(idb, true);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["event"]},
                            __module__ : {value: "read_book.db"}
                        });
                        return _anonfunc;
                    })();
                    req.onerror = (function() {
                        var _anonfunc = function (event) {
                            setTimeout(self.initialize_stage2.bind(null, idb, false), 0);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["event"]},
                            __module__ : {value: "read_book.db"}
                        });
                        return _anonfunc;
                    })();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.initialize_stage1.__module__) Object.defineProperties(DB.prototype.initialize_stage1, {
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.initialize_stage2 = function initialize_stage2(idb, supports_blobs) {
            var self = this;
            self.idb = idb;
            self.supports_blobs = supports_blobs;
            self.initialized = true;
            self.is_ok = true;
            if (!supports_blobs) {
                print("WARNING: browser does not support blob storage, calibre falling back to base64 encoding");
            }
            idb.onerror = (function() {
                var _anonfunc = function (event) {
                    self.display_error(null, event);
                    if (console.dir) {
                        console.dir(event);
                    } else {
                        console.log(event);
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            idb.onversionchange = (function() {
                var _anonfunc = function (event) {
                    idb.close();
                    self.show_error(_("Database upgraded!"), _("A newer version of calibre is available, please click the Reload button in your browser."));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            self.callback();
        };
        if (!DB.prototype.initialize_stage2.__argnames__) Object.defineProperties(DB.prototype.initialize_stage2, {
            __argnames__ : {value: ["idb", "supports_blobs"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.display_error = function display_error(msg, event) {
            var self = this;
            if (event.already_displayed_by_calibre) {
                return;
            }
            event.already_displayed_by_calibre = true;
            msg = msg || _("There was an error while interacting with the database used to store books for offline reading. Click \"Show details\" for more information.");
            self.show_error(_("Cannot read book"), msg, get_error_details(event));
        };
        if (!DB.prototype.display_error.__argnames__) Object.defineProperties(DB.prototype.display_error, {
            __argnames__ : {value: ["msg", "event"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.do_op = function do_op() {
            var self = this;
            var stores = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var data = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var error_msg = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var proceed = ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[3];
            var op = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? do_op.__defaults__.op : arguments[4];
            var store = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? do_op.__defaults__.store : arguments[5];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "op")){
                op = _kwargs_obj.op;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "store")){
                store = _kwargs_obj.store;
            }
            var transaction, req;
            store = store || stores[0];
            if (op === "get") {
                transaction = self.idb.transaction(stores);
                req = transaction.objectStore(store).get(data);
                req.onsuccess = (function() {
                    var _anonfunc = function (event) {
                        if (proceed) {
                            proceed(req.result);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["event"]},
                        __module__ : {value: "read_book.db"}
                    });
                    return _anonfunc;
                })();
            } else if (op === "put") {
                transaction = self.idb.transaction(stores, "readwrite");
                req = transaction.objectStore(store).put(data);
                if (proceed) {
                    req.onsuccess = proceed;
                }
            }
            req.onerror = (function() {
                var _anonfunc = function (event) {
                    self.display_error(error_msg, event);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.do_op.__defaults__) Object.defineProperties(DB.prototype.do_op, {
            __defaults__ : {value: {op:"get", store:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["stores", "data", "error_msg", "proceed", "op", "store"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.get_book = function get_book(library_id, book_id, fmt, metadata, proceed) {
            var self = this;
            var key;
            fmt = fmt.toUpperCase();
            book_id = int(book_id);
            key = [library_id, book_id, fmt];
            self.do_op(_list_decorate([ "books" ]), key, _("Failed to read from the books database"), (function() {
                var _anonfunc = function (result) {
                    if (result && !result.annotations_map) {
                        result.annotations_map = Object.create(null);
                    }
                    proceed(result || new_book(key, metadata));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["result"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })());
        };
        if (!DB.prototype.get_book.__argnames__) Object.defineProperties(DB.prototype.get_book, {
            __argnames__ : {value: ["library_id", "book_id", "fmt", "metadata", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.get_mathjax_info = function get_mathjax_info(proceed) {
            var self = this;
            self.do_op(_list_decorate([ "objects" ]), "mathjax-info", _("Failed to read from the objects database"), (function() {
                var _anonfunc = function (result) {
                    proceed(result || (function(){
                        var _d = Object.create(null);
                        _d["key"] = "mathjax-info";
                        return _d;
                    }).call(this));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["result"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })());
        };
        if (!DB.prototype.get_mathjax_info.__argnames__) Object.defineProperties(DB.prototype.get_mathjax_info, {
            __argnames__ : {value: ["proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.save_manifest = function save_manifest(book, manifest, proceed) {
            var self = this;
            var newest_epoch, newest_pos, pos, username, unkey;
            book.manifest = manifest;
            book.metadata = manifest.metadata;
            book.book_hash = manifest.book_hash.hash;
            book.stored_files = Object.create(null);
            book.is_complete = false;
            newest_epoch = newest_pos = null;
            var _Iter0 = _Iterable(manifest.last_read_positions);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                pos = _Iter0[_Index0];
                if (newest_epoch === null || pos.epoch > newest_epoch) {
                    newest_epoch = pos.epoch;
                    newest_pos = pos.cfi;
                }
            }
            username = get_interface_data().username;
            unkey = username_key(username);
            if (newest_pos && username) {
                (_expr_temp = book.last_read)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = new Date(newest_epoch * 1e3);
                (_expr_temp = book.last_read_position)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = newest_pos;
            }
            if (manifest.annotations_map) {
                (_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = manifest.annotations_map;
            }
            delete manifest.metadata;
            delete manifest.last_read_positions;
            delete manifest.annotations_map;
            _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "books" ]), book, _("Failed to write to the books database"), proceed].concat([_desugar_kwargs({op: "put"})]));
        };
        if (!DB.prototype.save_manifest.__argnames__) Object.defineProperties(DB.prototype.save_manifest, {
            __argnames__ : {value: ["book", "manifest", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.store_file = function store_file(book, name, xhr, proceed, is_cover) {
            var self = this;
            var store_as_text, fname, needs_encoding, mt;
            store_as_text = xhr.responseType === "text" || !xhr.responseType;
            fname = file_store_name(book, name);
            needs_encoding = !store_as_text && !self.supports_blobs;
            mt = _exists.d((_expr_temp = book.manifest.files)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]).mimetype;
            if (!mt && is_cover) {
                mt = "image/jpeg";
            }
            (_expr_temp = book.stored_files)[(typeof fname === "number" && fname < 0) ? _expr_temp.length + fname : fname] = (function(){
                var _d = Object.create(null);
                _d["encoded"] = needs_encoding;
                _d["mimetype"] = mt;
                _d["store_as_text"] = store_as_text;
                return _d;
            }).call(this);
            if (is_cover) {
                self.store_cover(book, needs_encoding, xhr.response, name, fname, proceed);
            } else {
                self.store_file_stage2(needs_encoding, xhr.response, name, fname, proceed);
            }
        };
        if (!DB.prototype.store_file.__argnames__) Object.defineProperties(DB.prototype.store_file, {
            __argnames__ : {value: ["book", "name", "xhr", "proceed", "is_cover"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.store_cover = function store_cover(book, needs_encoding, data, name, fname, proceed) {
            var self = this;
            var blob, url, img, proceeded;
            blob = data;
            if (needs_encoding) {
                blob = new Blob(_list_decorate([ data ]), (function(){
                    var _d = Object.create(null);
                    _d["type"] = "image/jpeg";
                    return _d;
                }).call(this));
            }
            url = window.URL.createObjectURL(blob);
            img = new Image;
            book.cover_name = name;
            proceeded = false;
            function done() {
                if (!proceeded) {
                    proceeded = true;
                    window.URL.revokeObjectURL(url);
                    self.store_file_stage2(needs_encoding, data, name, fname, proceed);
                }
            };
            if (!done.__module__) Object.defineProperties(done, {
                __module__ : {value: "read_book.db"}
            });

            img.onload = (function() {
                var _anonfunc = function () {
                    book.cover_width = this.width;
                    book.cover_height = this.height;
                    done();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            img.onerror = (function() {
                var _anonfunc = function () {
                    print("WARNING: Failed to read dimensions of cover");
                    done();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            img.src = url;
        };
        if (!DB.prototype.store_cover.__argnames__) Object.defineProperties(DB.prototype.store_cover, {
            __argnames__ : {value: ["book", "needs_encoding", "data", "name", "fname", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.store_file_stage2 = function store_file_stage2(needs_encoding, data, name, fname, proceed) {
            var self = this;
            var req;
            if (needs_encoding) {
                data = base64encode(new Uint8Array(data));
            }
            req = self.idb.transaction(_list_decorate([ "files" ]), "readwrite").objectStore("files").put(data, fname);
            req.onsuccess = (function() {
                var _anonfunc = function (event) {
                    proceed();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            req.onerror = (function() {
                var _anonfunc = function (event) {
                    proceed(_("Failed to store book data ({0}) with error: {1}").format(name, get_error_details(event)));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.store_file_stage2.__argnames__) Object.defineProperties(DB.prototype.store_file_stage2, {
            __argnames__ : {value: ["needs_encoding", "data", "name", "fname", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.clear_mathjax = function clear_mathjax(proceed) {
            var self = this;
            self.idb.transaction(_list_decorate([ "mathjax" ]), "readwrite").objectStore("mathjax").clear().onsuccess = proceed;
        };
        if (!DB.prototype.clear_mathjax.__argnames__) Object.defineProperties(DB.prototype.clear_mathjax, {
            __argnames__ : {value: ["proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.store_mathjax_file = function store_mathjax_file(name, xhr, proceed) {
            var self = this;
            var data, req;
            data = xhr.response;
            if (!self.supports_blobs) {
                data = base64encode(new Uint8Array(data));
            }
            req = self.idb.transaction(_list_decorate([ "mathjax" ]), "readwrite").objectStore("mathjax").put(data, name);
            req.onsuccess = (function() {
                var _anonfunc = function (event) {
                    proceed();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            req.onerror = (function() {
                var _anonfunc = function (event) {
                    proceed(_("Failed to store mathjax file ({0}) with error: {1}").format(name, get_error_details(event)));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.store_mathjax_file.__argnames__) Object.defineProperties(DB.prototype.store_mathjax_file, {
            __argnames__ : {value: ["name", "xhr", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.finish_book = function finish_book(book, proceed) {
            var self = this;
            book.is_complete = true;
            _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "books" ]), book, _("Failed to write to the books database"), proceed].concat([_desugar_kwargs({op: "put"})]));
        };
        if (!DB.prototype.finish_book.__argnames__) Object.defineProperties(DB.prototype.finish_book, {
            __argnames__ : {value: ["book", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.finish_mathjax = function finish_mathjax(mathjax_info, proceed) {
            var self = this;
            _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "objects" ]), mathjax_info, _("Failed to write to the objects database"), proceed].concat([_desugar_kwargs({op: "put"})]));
        };
        if (!DB.prototype.finish_mathjax.__argnames__) Object.defineProperties(DB.prototype.finish_mathjax, {
            __argnames__ : {value: ["mathjax_info", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.update_last_read_time = function update_last_read_time(book) {
            var self = this;
            var unkey, now;
            unkey = username_key(get_interface_data().username);
            now = new Date;
            (_expr_temp = book.last_read)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = book.recent_date = now;
            _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "books" ]), book, _("Failed to write to the books database")].concat([_desugar_kwargs({op: "put"})]));
        };
        if (!DB.prototype.update_last_read_time.__argnames__) Object.defineProperties(DB.prototype.update_last_read_time, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.update_metadata = function update_metadata(book, new_metadata) {
            var self = this;
            var key;
            if (book.metadata) {
                var _Iter1 = _Iterable(Object.keys(new_metadata));
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    key = _Iter1[_Index1];
                    (_expr_temp = book.metadata)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key] = new_metadata[(typeof key === "number" && key < 0) ? new_metadata.length + key : key];
                }
                _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "books" ]), book, _("Failed to write to the books database"), (function() {
                    var _anonfunc = function () {
                        null;
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.db"}
                    });
                    return _anonfunc;
                })()].concat([_desugar_kwargs({op: "put"})]));
            }
        };
        if (!DB.prototype.update_metadata.__argnames__) Object.defineProperties(DB.prototype.update_metadata, {
            __argnames__ : {value: ["book", "new_metadata"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.save_reading_rates = function save_reading_rates(book, rates) {
            var self = this;
            book.saved_reading_rates = rates;
            _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "books" ]), book, _("Failed to write to the books database"), (function() {
                var _anonfunc = function () {
                    null;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({op: "put"})]));
        };
        if (!DB.prototype.save_reading_rates.__argnames__) Object.defineProperties(DB.prototype.save_reading_rates, {
            __argnames__ : {value: ["book", "rates"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.update_annotations_data_from_key = function update_annotations_data_from_key(library_id, book_id, fmt, new_data) {
            var self = this;
            var unkey;
            unkey = username_key(get_interface_data().username);
            self.get_book(library_id, book_id, fmt, null, (function() {
                var _anonfunc = function (book) {
                    var changed, existing, _unpack, updated, merged;
                    if (book.metadata) {
                        changed = false;
                        if (new_data.last_read_position) {
                            (_expr_temp = book.last_read)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = book.recent_date = new_data.last_read;
                            (_expr_temp = book.last_read_position)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = new_data.last_read_position;
                            changed = true;
                        }
                        if (!book.annotations_map) {
                            book.annotations_map = {};
                        }
                        if (new_data.annotations_map) {
                            existing = (_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey];
                            if (!existing) {
                                changed = true;
                                (_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = new_data.annotations_map;
                            } else {
                                _unpack = merge_annotation_maps(existing, new_data.annotations_map);
_unpack = _unpack_asarray(2, _unpack);
                                updated = _unpack[0];
                                merged = _unpack[1];
                                if (updated) {
                                    changed = true;
                                    (_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = merged;
                                }
                            }
                        }
                        if (changed) {
                            _interpolate_kwargs.call(self, self.do_op, [_list_decorate([ "books" ]), book, _("Failed to write to the books database"), (function() {
                                var _anonfunc = function () {
                                    null;
                                };
                                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                    __module__ : {value: "read_book.db"}
                                });
                                return _anonfunc;
                            })()].concat([_desugar_kwargs({op: "put"})]));
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["book"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })());
        };
        if (!DB.prototype.update_annotations_data_from_key.__argnames__) Object.defineProperties(DB.prototype.update_annotations_data_from_key, {
            __argnames__ : {value: ["library_id", "book_id", "fmt", "new_data"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.get_file = function get_file(book, name, proceed) {
            var self = this;
            var key, err;
            key = file_store_name(book, name);
            err = _("Failed to read the file {0} for the book {1} from the browser offline cache.").format(name, book.metadata.title);
            self.do_op(_list_decorate([ "files" ]), key, err, (function() {
                var _anonfunc = function (result) {
                    var bad, fdata, mt;
                    if (!result) {
                        bad = err + _(" This usually means the cache is close to full. Clear the browser cache from the browser settings.");
                        self.show_error(_("Cannot read file from book"), bad);
                        return;
                    }
                    fdata = (_expr_temp = book.stored_files)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
                    mt = fdata.mimetype || "application/octet-stream";
                    if (fdata.encoded) {
                        result = new Blob(_list_decorate([ base64decode(result) ]), (function(){
                            var _d = Object.create(null);
                            _d["type"] = mt;
                            return _d;
                        }).call(this));
                    }
                    proceed(result, name, mt, book);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["result"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })());
        };
        if (!DB.prototype.get_file.__argnames__) Object.defineProperties(DB.prototype.get_file, {
            __argnames__ : {value: ["book", "name", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.get_book_file = function get_book_file(book_hash, stored_files, name, proceed) {
            var self = this;
            var stores, key, transaction, req;
            stores = _list_decorate([ "files" ]);
            key = file_store_name((function(){
                var _d = Object.create(null);
                _d["book_hash"] = book_hash;
                return _d;
            }).call(this), name);
            transaction = self.idb.transaction(stores);
            req = transaction.objectStore(stores[0]).get(key);
            req.onsuccess = (function() {
                var _anonfunc = function (event) {
                    var fdata, mt, result;
                    if (!req.result) {
                        proceed((function(){
                            var _d = Object.create(null);
                            _d["ok"] = false;
                            _d["name"] = name;
                            _d["details"] = "ENOENT";
                            return _d;
                        }).call(this));
                        return;
                    }
                    fdata = stored_files[(typeof key === "number" && key < 0) ? stored_files.length + key : key];
                    mt = fdata.mimetype || "application/octet-stream";
                    if (fdata.encoded) {
                        result = new Blob(_list_decorate([ base64decode(result) ]), (function(){
                            var _d = Object.create(null);
                            _d["type"] = mt;
                            return _d;
                        }).call(this));
                    }
                    proceed((function(){
                        var _d = Object.create(null);
                        _d["ok"] = true;
                        _d["result"] = req.result;
                        _d["name"] = name;
                        _d["mt"] = mt;
                        return _d;
                    }).call(this));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            req.onerror = (function() {
                var _anonfunc = function (event) {
                    var details;
                    details = get_error_details(event);
                    proceed((function(){
                        var _d = Object.create(null);
                        _d["ok"] = false;
                        _d["name"] = name;
                        _d["details"] = details;
                        return _d;
                    }).call(this));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.get_book_file.__argnames__) Object.defineProperties(DB.prototype.get_book_file, {
            __argnames__ : {value: ["book_hash", "stored_files", "name", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.get_mathjax_files = function get_mathjax_files(proceed) {
            var self = this;
            var c, data;
            c = self.idb.transaction("mathjax").objectStore("mathjax").openCursor();
            c.onerror = (function() {
                var _anonfunc = function (event) {
                    var err;
                    err = _("Failed to read the MathJax files from the browser offline cache.");
                    self.display_error(err, event);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            data = Object.create(null);
            c.onsuccess = (function() {
                var _anonfunc = function (event) {
                    var cursor, _unpack, name, result, mt;
                    cursor = event.target.result;
                    if (cursor) {
                        _unpack = [cursor.key, cursor.value];
                        name = _unpack[0];
                        result = _unpack[1];
                        if (!(_instanceof(result, Blob))) {
                            mt = (name.endswith(".woff")) ? "application/x-font-woff" : "text/javascript";
                            result = new Blob(_list_decorate([ base64decode(result) ]), (function(){
                                var _d = Object.create(null);
                                _d["type"] = mt;
                                return _d;
                            }).call(this));
                        }
                        data[(typeof name === "number" && name < 0) ? data.length + name : name] = result;
                        cursor.continue();
                    } else {
                        proceed(data);
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.get_mathjax_files.__argnames__) Object.defineProperties(DB.prototype.get_mathjax_files, {
            __argnames__ : {value: ["proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.get_recently_read_books = function get_recently_read_books(proceed, limit) {
            var self = this;
            var c, books;
            limit = limit || 3;
            c = self.idb.transaction(_list_decorate([ "books" ]), "readonly").objectStore("books").index("recent_index").openCursor(null, "prev");
            books = [];
            c.onerror = (function() {
                var _anonfunc = function (event) {
                    var err;
                    err = _("Failed to read recent books from local storage");
                    self.display_error(err, event);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            c.onsuccess = (function() {
                var _anonfunc = function (ev) {
                    var cursor;
                    cursor = ev.target.result;
                    if (cursor) {
                        books.push(cursor.value);
                    }
                    if (books.length >= limit || !cursor) {
                        proceed(books);
                        return;
                    }
                    if (cursor) {
                        cursor.continue();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.get_recently_read_books.__argnames__) Object.defineProperties(DB.prototype.get_recently_read_books, {
            __argnames__ : {value: ["proceed", "limit"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.has_book_matching = function has_book_matching(library_id, book_id, proceed) {
            var self = this;
            var c;
            c = self.idb.transaction(_list_decorate([ "books" ]), "readonly").objectStore("books").index("recent_index").openCursor(null, "prev");
            c.onerror = (function() {
                var _anonfunc = function (event) {
                    proceed(false);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            book_id = int(book_id);
            c.onsuccess = (function() {
                var _anonfunc = function (ev) {
                    var cursor, book;
                    cursor = ev.target.result;
                    if (cursor) {
                        book = cursor.value;
                        if (book.key[0] === library_id && book.key[1] === book_id) {
                            proceed(true);
                            return;
                        }
                        cursor.continue();
                    } else {
                        proceed(false);
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.has_book_matching.__argnames__) Object.defineProperties(DB.prototype.has_book_matching, {
            __argnames__ : {value: ["library_id", "book_id", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.delete_book = function delete_book(book, proceed) {
            var self = this;
            var c, files, books, filenames;
            c = self.idb.transaction(_list_decorate([ "books", "files" ]), "readwrite");
            files = c.objectStore("files");
            books = c.objectStore("books");
            filenames = Object.keys(book.stored_files);
            c.oncomplete = (function() {
                var _anonfunc = function (event) {
                    proceed(book);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            c.onerror = (function() {
                var _anonfunc = function (event) {
                    proceed(book, c.error.toString());
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            function next_step() {
                var r;
                if (filenames.length) {
                    r = files.delete(filenames.pop());
                    r.onsuccess = next_step;
                } else {
                    books.delete(book.key);
                }
            };
            if (!next_step.__module__) Object.defineProperties(next_step, {
                __module__ : {value: "read_book.db"}
            });

            next_step();
        };
        if (!DB.prototype.delete_book.__argnames__) Object.defineProperties(DB.prototype.delete_book, {
            __argnames__ : {value: ["book", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.delete_books_matching = function delete_books_matching(library_id, book_id, proceed) {
            var self = this;
            var c, matches;
            c = self.idb.transaction(_list_decorate([ "books" ]), "readonly").objectStore("books").index("recent_index").openCursor(null, "prev");
            c.onerror = (function() {
                var _anonfunc = function (event) {
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
            book_id = int(book_id);
            matches = [];
            function delete_all() {
                var book;
                if (matches.length) {
                    book = matches.pop();
                    self.delete_book(book, delete_all);
                } else {
                    if (proceed) {
                        proceed();
                    }
                }
            };
            if (!delete_all.__module__) Object.defineProperties(delete_all, {
                __module__ : {value: "read_book.db"}
            });

            c.onsuccess = (function() {
                var _anonfunc = function (ev) {
                    var cursor, book;
                    cursor = ev.target.result;
                    if (cursor) {
                        book = cursor.value;
                        if (book.key[0] === library_id && book.key[1] === book_id) {
                            matches.push(book);
                        }
                        cursor.continue();
                    } else {
                        delete_all();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.db"}
                });
                return _anonfunc;
            })();
        };
        if (!DB.prototype.delete_books_matching.__argnames__) Object.defineProperties(DB.prototype.delete_books_matching, {
            __argnames__ : {value: ["library_id", "book_id", "proceed"]},
            __module__ : {value: "read_book.db"}
        });
        DB.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        DB.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(DB.prototype, "__bases__", {value: []});

        function get_db(callback, show_read_book_error) {
            if (!get_db.ans) {
                get_db.ans = new DB(callback, show_read_book_error);
            }
            return get_db.ans;
        };
        if (!get_db.__argnames__) Object.defineProperties(get_db, {
            __argnames__ : {value: ["callback", "show_read_book_error"]},
            __module__ : {value: "read_book.db"}
        });

        _modules["read_book.db"].DB_NAME = DB_NAME;
        _modules["read_book.db"].DB_VERSION = DB_VERSION;
        _modules["read_book.db"].upgrade_schema = upgrade_schema;
        _modules["read_book.db"].file_store_name = file_store_name;
        _modules["read_book.db"].get_error_details = get_error_details;
        _modules["read_book.db"].new_book = new_book;
        _modules["read_book.db"].indexed_db_api = indexed_db_api;
        _modules["read_book.db"].DB = DB;
        _modules["read_book.db"].get_db = get_db;
    })();

    (function(){
        var __name__ = "read_book.tts";
        var E = _modules.elementmaker.E;

        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_custom_dialog = _modules.modals.create_custom_dialog;
        var error_dialog = _modules.modals.error_dialog;

        var create_button = _modules.widgets.create_button;

        function escaper() {
            var doc, el, ser;
            doc = document.implementation.createDocument("", "", null);
            el = doc.createElement("temp");
            el.textContent = "temp";
            el = el.firstChild;
            ser = new XMLSerializer;
            return (function() {
                var _anonfunc = function (text) {
                    el.nodeValue = text;
                    return ser.serializeToString(el);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["text"]},
                    __module__ : {value: "read_book.tts"}
                });
                return _anonfunc;
            })();
        };
        if (!escaper.__module__) Object.defineProperties(escaper, {
            __module__ : {value: "read_book.tts"}
        });

        function Client() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Client.prototype.__bind_methods__.call(this);
            Client.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Client.prototype, "__bind_methods__", {value: function () {
            this.create_utterance = Client.prototype.create_utterance.bind(this);
            this.utterance_started = Client.prototype.utterance_started.bind(this);
            this.utterance_paused = Client.prototype.utterance_paused.bind(this);
            this.utterance_ended = Client.prototype.utterance_ended.bind(this);
            this.utterance_failed = Client.prototype.utterance_failed.bind(this);
            this.utterance_mark_reached = Client.prototype.utterance_mark_reached.bind(this);
            this.utterance_resumed = Client.prototype.utterance_resumed.bind(this);
            this.pause = Client.prototype.pause.bind(this);
            this.resume = Client.prototype.resume.bind(this);
            this.resume_after_configure = Client.prototype.resume_after_configure.bind(this);
            this.stop = Client.prototype.stop.bind(this);
            this.speak_simple_text = Client.prototype.speak_simple_text.bind(this);
            this.speak_marked_text = Client.prototype.speak_marked_text.bind(this);
            this.faster = Client.prototype.faster.bind(this);
            this.slower = Client.prototype.slower.bind(this);
            this.apply_settings = Client.prototype.apply_settings.bind(this);
            this.change_rate = Client.prototype.change_rate.bind(this);
            this.configure = Client.prototype.configure.bind(this);
        }});
        Client.prototype.__init__ = function __init__() {
            var self = this;
            var data;
            self.stop_requested_at = null;
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = false;
                _d["paused"] = false;
                return _d;
            }).call(this);
            self.queue = [];
            self.last_reached_mark = null;
            self.onevent = (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.tts"}
                });
                return _anonfunc;
            })();
            data = get_session_data().get("tts_backend");
            self.current_voice_uri = data.voice || "";
            self.current_rate = data.rate || null;
        };
        if (!Client.prototype.__init__.__module__) Object.defineProperties(Client.prototype.__init__, {
            __module__ : {value: "read_book.tts"}
        });
        Client.__argnames__ = Client.prototype.__init__.__argnames__;
        Client.__handles_kwarg_interpolation__ = Client.prototype.__init__.__handles_kwarg_interpolation__;
        Client.prototype.create_utterance = function create_utterance(text_or_ssml, wrap_in_ssml) {
            var self = this;
            var ut, voice;
            if (wrap_in_ssml) {
                text_or_ssml = "<?xml version=\"1.0\"?>\n<speak version=\"1.0\" xmlns=\"http://www.w3.org/2001/10/synthesis\"><s>" + text_or_ssml + "</s></speak>";
            }
            ut = new window.SpeechSynthesisUtterance(text_or_ssml);
            ut.onstart = self.utterance_started;
            ut.onpause = self.utterance_paused;
            ut.onend = self.utterance_ended;
            ut.onerror = self.utterance_failed;
            ut.onmark = self.utterance_mark_reached;
            ut.onresume = self.utterance_resumed;
            if (self.current_voice_uri) {
                var _Iter0 = _Iterable(window.speechSynthesis.getVoices());
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    voice = _Iter0[_Index0];
                    if (voice.voiceURI === self.current_voice_uri) {
                        ut.voice = voice;
                        break;
                    }
                }
            }
            if (self.current_rate) {
                ut.rate = self.current_rate;
            }
            self.queue.push(ut);
            return ut;
        };
        if (!Client.prototype.create_utterance.__argnames__) Object.defineProperties(Client.prototype.create_utterance, {
            __argnames__ : {value: ["text_or_ssml", "wrap_in_ssml"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.utterance_started = function utterance_started(event) {
            var self = this;
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = true;
                _d["paused"] = false;
                return _d;
            }).call(this);
            self.onevent("begin");
        };
        if (!Client.prototype.utterance_started.__argnames__) Object.defineProperties(Client.prototype.utterance_started, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.utterance_paused = function utterance_paused(event) {
            var self = this;
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = true;
                _d["paused"] = true;
                return _d;
            }).call(this);
            self.onevent("pause");
        };
        if (!Client.prototype.utterance_paused.__argnames__) Object.defineProperties(Client.prototype.utterance_paused, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.utterance_ended = function utterance_ended(event) {
            var self = this;
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = false;
                _d["paused"] = false;
                return _d;
            }).call(this);
            if (_exists.n(self.stop_requested_at) && window.performance.now() - self.stop_requested_at < 1e3) {
                self.stop_requested_at = null;
                return;
            }
            self.queue.splice(0, 1);
            if (self.queue.length) {
                window.speechSynthesis.speak(self.queue[0]);
            } else {
                self.onevent("end");
            }
        };
        if (!Client.prototype.utterance_ended.__argnames__) Object.defineProperties(Client.prototype.utterance_ended, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.utterance_failed = function utterance_failed(event) {
            var self = this;
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = false;
                _d["paused"] = false;
                return _d;
            }).call(this);
            self.queue = [];
            error_dialog(_("Speaking failed"), _("An error has occurred with speech synthesis: " + event.error));
            self.onevent("cancel");
        };
        if (!Client.prototype.utterance_failed.__argnames__) Object.defineProperties(Client.prototype.utterance_failed, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.utterance_mark_reached = function utterance_mark_reached(event) {
            var self = this;
            self.last_reached_mark = event.name;
            self.onevent("mark", int(event.name));
        };
        if (!Client.prototype.utterance_mark_reached.__argnames__) Object.defineProperties(Client.prototype.utterance_mark_reached, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.utterance_resumed = function utterance_resumed(event) {
            var self = this;
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = true;
                _d["paused"] = false;
                return _d;
            }).call(this);
            self.onevent("resume");
        };
        if (!Client.prototype.utterance_resumed.__argnames__) Object.defineProperties(Client.prototype.utterance_resumed, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.pause = function pause() {
            var self = this;
            window.speechSynthesis.pause();
        };
        if (!Client.prototype.pause.__module__) Object.defineProperties(Client.prototype.pause, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.resume = function resume() {
            var self = this;
            window.speechSynthesis.resume();
        };
        if (!Client.prototype.resume.__module__) Object.defineProperties(Client.prototype.resume, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.resume_after_configure = function resume_after_configure() {
            var self = this;
            if (self.queue.length) {
                window.speechSynthesis.speak(self.queue[0]);
            }
        };
        if (!Client.prototype.resume_after_configure.__module__) Object.defineProperties(Client.prototype.resume_after_configure, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.stop = function stop() {
            var self = this;
            self.queue = [];
            self.stop_requested_at = window.performance.now();
            window.speechSynthesis.cancel();
            self.status = (function(){
                var _d = Object.create(null);
                _d["synthesizing"] = false;
                _d["paused"] = false;
                return _d;
            }).call(this);
        };
        if (!Client.prototype.stop.__module__) Object.defineProperties(Client.prototype.stop, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.speak_simple_text = function speak_simple_text(text) {
            var self = this;
            self.stop();
            while (text.length > 32766) {
                self.create_utterance(text.slice(0, 32766));
                text = text.slice(32766);
            }
            if (text) {
                self.create_utterance(text);
            }
            if (self.queue.length) {
                window.speechSynthesis.speak(self.queue[0]);
            }
        };
        if (!Client.prototype.speak_simple_text.__argnames__) Object.defineProperties(Client.prototype.speak_simple_text, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.speak_marked_text = function speak_marked_text(text_segments, onevent) {
            var self = this;
            var buf, size, limit, x;
            self.stop();
            self.onevent = onevent;
            buf = [];
            size = 0;
            limit = 2048;
            function commit() {
                var text;
                text = buf.join("");
                if (text.length) {
                    self.create_utterance(text);
                }
                buf = [];
                size = 0;
            };
            if (!commit.__module__) Object.defineProperties(commit, {
                __module__ : {value: "read_book.tts"}
            });

            var _Iter1 = _Iterable(text_segments);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                x = _Iter1[_Index1];
                if (typeof x === "number") {
                    continue;
                } else {
                    if (x.length > limit) {
                        commit();
                        while (x.length) {
                            self.create_utterance(x.slice(0, limit));
                            x = x.slice(limit);
                        }
                        continue;
                    }
                }
                if (size + x.length > limit) {
                    commit();
                }
                buf.push(x);
                size += x.length;
            }
            commit();
            if (self.queue.length) {
                window.speechSynthesis.speak(self.queue[0]);
            }
        };
        if (!Client.prototype.speak_marked_text.__argnames__) Object.defineProperties(Client.prototype.speak_marked_text, {
            __argnames__ : {value: ["text_segments", "onevent"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.faster = function faster() {
            var self = this;
            _interpolate_kwargs.call(self, self.change_rate, [_desugar_kwargs({steps: 1})]);
        };
        if (!Client.prototype.faster.__module__) Object.defineProperties(Client.prototype.faster, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.slower = function slower() {
            var self = this;
            _interpolate_kwargs.call(self, self.change_rate, [_desugar_kwargs({steps: -1})]);
        };
        if (!Client.prototype.slower.__module__) Object.defineProperties(Client.prototype.slower, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.apply_settings = function apply_settings() {
            var self = this;
            var sd, existing, ut;
            sd = get_session_data();
            sd.set("tts_backend", (function(){
                var _d = Object.create(null);
                _d["voice"] = self.current_voice_uri;
                _d["rate"] = self.current_rate;
                return _d;
            }).call(this));
            existing = self.queue;
            if (self.queue && self.queue.length) {
                if (self.status.paused) {
                    window.speechSynthesis.resume();
                }
                self.stop();
                var _Iter2 = _Iterable(existing);
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    ut = _Iter2[_Index2];
                    self.create_utterance(ut.text);
                }
            }
        };
        if (!Client.prototype.apply_settings.__module__) Object.defineProperties(Client.prototype.apply_settings, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.change_rate = function change_rate() {
            var self = this;
            var steps = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? change_rate.__defaults__.steps : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "steps")){
                steps = _kwargs_obj.steps;
            }
            var rate, current_rate, step_size;
            rate = current_rate = (self.current_rate || 1) * 10;
            step_size = 2;
            rate += steps * step_size;
            rate /= 10;
            rate = max(self.min_rate, min(rate, self.max_rate));
            if (rate !== current_rate) {
                self.current_rate = rate;
                self.apply_settings();
                self.resume_after_configure();
            }
        };
        if (!Client.prototype.change_rate.__defaults__) Object.defineProperties(Client.prototype.change_rate, {
            __defaults__ : {value: {steps:1}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["steps"]},
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.configure = function configure() {
            var self = this;
            var voice_id, rate_id, default_voice;
            voice_id = unique_id();
            rate_id = unique_id();
            default_voice = null;
            function restore_defaults() {
                document.getElementById(voice_id).selectedIndex = -1;
                document.getElementById(rate_id).value = 10;
            };
            if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
                __module__ : {value: "read_book.tts"}
            });

            _interpolate_kwargs.call(this, create_custom_dialog, [_("Configure Text-to-Speech"), (function() {
                var _anonfunc = function (parent_div, close_modal) {
                    var select, voices, dflt, option, voice;
                    select = _interpolate_kwargs.call(E, E.select, [_desugar_kwargs({size: "5", id: voice_id})]);
                    voices = window.speechSynthesis.getVoices();
                    voices.sort((function() {
                        var _anonfunc = function (a, b) {
                            a = a.name.toLowerCase();
                            b = b.name.toLowerCase();
                            return (a < b) ? -1 : (a === b) ? 0 : 1;
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["a", "b"]},
                            __module__ : {value: "read_book.tts"}
                        });
                        return _anonfunc;
                    })());
                    var _Iter3 = _Iterable(voices);
                    for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                        voice = _Iter3[_Index3];
                        dflt = "";
                        if (voice.default) {
                            default_voice = voice.voiceURI;
                            dflt = "-- {}".format(_("default"));
                        }
                        option = _interpolate_kwargs.call(E, E.option, ["" + _str.format("{}", voice.name) + " (" + _str.format("{}", voice.lang) + ")" + _str.format("{}", dflt) + ""].concat([_desugar_kwargs({value: voice.voiceURI})]));
                        if (self.current_voice_uri && voice.voiceURI === self.current_voice_uri || !self.current_voice_uri && voice.default) {
                            option.setAttribute("selected", "selected");
                        }
                        select.appendChild(option);
                    }
                    parent_div.appendChild(E.div(_("Speed of speech:")));
                    parent_div.appendChild(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "range", id: rate_id, min: self.min_rate * 10 + "", max: self.max_rate * 10 + "", value: (self.current_rate || 1) * 10 + ""})]));
                    parent_div.appendChild(E.div(_("Pick a voice below:")));
                    parent_div.appendChild(select);
                    if (_exists.n(select.options.selectedIndex) && (_expr_temp = select.options)[_bound_index(select.options.selectedIndex, _expr_temp)]) {
                        (_expr_temp = select.options)[_bound_index(select.options.selectedIndex, _expr_temp)].scrollIntoView();
                    }
                    parent_div.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Restore defaults")].concat([_desugar_kwargs({action: restore_defaults})])), _interpolate_kwargs.call(this, create_button, [_("Close")].concat([_desugar_kwargs({action: close_modal})]))].concat([_desugar_kwargs({style: "margin: 1rem; display: flex; justify-content: space-between; align-items: flex-start"})])));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent_div", "close_modal"]},
                    __module__ : {value: "read_book.tts"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({on_close: (function() {
                var _anonfunc = function () {
                    var voice, rate, changed;
                    voice = document.getElementById(voice_id).value;
                    rate = int(document.getElementById(rate_id).value) / 10;
                    if (rate === 1) {
                        rate = null;
                    }
                    if (voice === default_voice) {
                        voice = "";
                    }
                    changed = voice !== self.current_voice_uri || rate !== self.current_rate;
                    if (changed) {
                        self.current_voice_uri = voice;
                        self.current_rate = rate;
                        self.apply_settings();
                    }
                    self.onevent("configured");
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.tts"}
                });
                return _anonfunc;
            })()})]));
        };
        if (!Client.prototype.configure.__module__) Object.defineProperties(Client.prototype.configure, {
            __module__ : {value: "read_book.tts"}
        });
        Client.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Client.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Client.prototype, "__bases__", {value: []});
        Client.prototype.min_rate = .1;
        Client.prototype.max_rate = 2;

        _modules["read_book.tts"].escaper = escaper;
        _modules["read_book.tts"].Client = Client;
    })();

    (function(){
        var __name__ = "fs_images";
        function is_svg_fs_markup(names, svg) {
            if (svg !== null) {
                if (names.length === 2 || names.length === 3) {
                    if (names[names.length-1] === "image" && names[names.length-2] === "svg") {
                        if (names.length === 2 || names[0] === "div") {
                            if (svg.width === "100%" && svg.height === "100%") {
                                return true;
                            }
                        }
                    }
                }
            }
            return false;
        };
        if (!is_svg_fs_markup.__argnames__) Object.defineProperties(is_svg_fs_markup, {
            __argnames__ : {value: ["names", "svg"]},
            __module__ : {value: "fs_images"}
        });

        function fix_fullscreen_svg_images() {
            var child_names, name, node, names, svg;
            child_names = [];
            var _Iter0 = _Iterable(document.body.childNodes);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                node = _Iter0[_Index0];
                if (node.tagName) {
                    name = node.tagName.toLowerCase();
                    if (name !== "style" && name !== "script") {
                        child_names.push(name);
                    }
                    if (child_names.length > 1) {
                        break;
                    }
                }
            }
            if (child_names.length === 1 && (child_names[0] === "div" || child_names[0] === "svg")) {
                names = [];
                svg = null;
                var _Iter1 = _Iterable(document.body.querySelectorAll("*"));
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    node = _Iter1[_Index1];
                    if (node.tagName) {
                        name = node.tagName.toLowerCase();
                        if (name !== "style" && name !== "script") {
                            names.push(name);
                            if (name === "svg") {
                                svg = node;
                            }
                        }
                    }
                }
                if (is_svg_fs_markup(names, svg)) {
                    svg.setAttribute("width", "100vw");
                    svg.setAttribute("height", "100vh");
                }
            }
        };
        if (!fix_fullscreen_svg_images.__module__) Object.defineProperties(fix_fullscreen_svg_images, {
            __module__ : {value: "fs_images"}
        });

        _modules.fs_images.is_svg_fs_markup = is_svg_fs_markup;
        _modules.fs_images.fix_fullscreen_svg_images = fix_fullscreen_svg_images;
    })();

    (function(){
        var __name__ = "iframe_comm";
        var LOADING_DOC, instance_numbers;
        var GCM = _modules.aes.GCM;

        var E = _modules.elementmaker.E;

        var traceback = _modules.traceback;

        var get_translations = _modules["book_list.globals"].get_translations;
        var main_js = _modules["book_list.globals"].main_js;

        var get_font_family = _modules["book_list.theme"].get_font_family;

        var ensure_id = _modules.dom.ensure_id;

        var install = _modules.gettext.install;

        LOADING_DOC = "\n<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, user-scalable=no\">\n<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n<script type=\"text/javascript\" id=\"bootstrap\">\nwindow.iframe_entry_point = '__ENTRY_POINT__';  // different in different iframes\nwindow.default_font_family = '__FONT__';  // from the theme\n__SCRIPT__\nend_script\n</head>\n<body>\n<div style=\"font-size:larger; font-weight: bold; margin-top:48vh; text-align:center\">\n__BS__\n</div>\n</body>\n</html>\n".replace("end_script", "<" + "/script>");
        function Messenger() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Messenger.prototype.__bind_methods__.call(this);
            Messenger.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Messenger.prototype, "__bind_methods__", {value: function () {
            this.reset = Messenger.prototype.reset.bind(this);
            this.encrypt = Messenger.prototype.encrypt.bind(this);
            this.decrypt = Messenger.prototype.decrypt.bind(this);
        }});
        Messenger.prototype.__init__ = function __init__() {
            var self = this;
            self.secret = new Uint8Array(64);
        };
        if (!Messenger.prototype.__init__.__module__) Object.defineProperties(Messenger.prototype.__init__, {
            __module__ : {value: "iframe_comm"}
        });
        Messenger.__argnames__ = Messenger.prototype.__init__.__argnames__;
        Messenger.__handles_kwarg_interpolation__ = Messenger.prototype.__init__.__handles_kwarg_interpolation__;
        Messenger.prototype.reset = function reset() {
            var self = this;
            window.crypto.getRandomValues(self.secret);
            self.gcm_to_iframe = new GCM(self.secret.subarray(0, 32));
            self.gcm_from_iframe = new GCM(self.secret.subarray(32));
        };
        if (!Messenger.prototype.reset.__module__) Object.defineProperties(Messenger.prototype.reset, {
            __module__ : {value: "iframe_comm"}
        });
        Messenger.prototype.encrypt = function encrypt(data) {
            var self = this;
            return self.gcm_to_iframe.encrypt(JSON.stringify(data));
        };
        if (!Messenger.prototype.encrypt.__argnames__) Object.defineProperties(Messenger.prototype.encrypt, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "iframe_comm"}
        });
        Messenger.prototype.decrypt = function decrypt(data) {
            var self = this;
            return JSON.parse(self.gcm_from_iframe.decrypt(data));
        };
        if (!Messenger.prototype.decrypt.__argnames__) Object.defineProperties(Messenger.prototype.decrypt, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "iframe_comm"}
        });
        Messenger.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Messenger.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Messenger.prototype, "__bases__", {value: []});

        function IframeWrapper() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            IframeWrapper.prototype.__bind_methods__.call(this);
            IframeWrapper.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(IframeWrapper.prototype, "__bind_methods__", {value: function () {
            this.destroy = IframeWrapper.prototype.destroy.bind(this);
            this.create_srcdoc = IframeWrapper.prototype.create_srcdoc.bind(this);
            this.init = IframeWrapper.prototype.init.bind(this);
            this.reset = IframeWrapper.prototype.reset.bind(this);
            this._send_message = IframeWrapper.prototype._send_message.bind(this);
            this.send_message = IframeWrapper.prototype.send_message.bind(this);
            this.send_unencrypted_message = IframeWrapper.prototype.send_unencrypted_message.bind(this);
            this.handle_message = IframeWrapper.prototype.handle_message.bind(this);
            this.on_iframe_ready = IframeWrapper.prototype.on_iframe_ready.bind(this);
        }});
        Object.defineProperties(IframeWrapper.prototype,  {
            "iframe": {
                "enumerable": true, 
                "get": function iframe() {
                    var self = this;
                    return document.getElementById(self.iframe_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        IframeWrapper.prototype.__init__ = function __init__(handlers, iframe, entry_point, bootstrap_text) {
            var self = this;
            var k;
            self.messenger = new Messenger;
            self.iframe_id = ensure_id(iframe, "content-iframe");
            self.reload_count = 0;
            if (_in(":", entry_point)) {
                self.needs_init = iframe.src !== entry_point;
                self.srcdoc_created = true;
                self.constructor_url = entry_point;
                self.entry_point = null;
            } else {
                self.needs_init = true;
                self.srcdoc_created = false;
                self.constructor_url = null;
                self.entry_point = entry_point;
            }
            self.ready = false;
            self.encrypted_communications = false;
            self.bootstrap_text = bootstrap_text || "";
            self.handlers = (function() {
                var _Iter = _Iterable(handlers), _Result = Object.create(null), k;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    k = _Iter[_Index];
                    _Result[k] = (handlers[(typeof k === "number" && k < 0) ? handlers.length + k : k]);
                }
                return _Result;
            })();
            self.on_ready_handler = self.handlers.ready;
            self.handlers.ready = self.on_iframe_ready;
            window.addEventListener("message", self.handle_message, false);
        };
        if (!IframeWrapper.prototype.__init__.__argnames__) Object.defineProperties(IframeWrapper.prototype.__init__, {
            __argnames__ : {value: ["handlers", "iframe", "entry_point", "bootstrap_text"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.__argnames__ = IframeWrapper.prototype.__init__.__argnames__;
        IframeWrapper.__handles_kwarg_interpolation__ = IframeWrapper.prototype.__init__.__handles_kwarg_interpolation__;
        IframeWrapper.prototype.destroy = function destroy() {
            var self = this;
            window.removeEventListener("message", self.handle_message, false);
        };
        if (!IframeWrapper.prototype.destroy.__module__) Object.defineProperties(IframeWrapper.prototype.destroy, {
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.create_srcdoc = function create_srcdoc() {
            var self = this;
            var r, data;
            r = /__([A-Z][A-Z_0-9]*[A-Z0-9])__/g;
            if (self.entry_point) {
                data = (function(){
                    var _d = Object.create(null);
                    _d["BS"] = self.bootstrap_text;
                    _d["SCRIPT"] = main_js();
                    _d["FONT"] = get_font_family();
                    _d["ENTRY_POINT"] = self.entry_point;
                    return _d;
                }).call(this);
                self.iframe.srcdoc = LOADING_DOC.replace(r, (function() {
                    var _anonfunc = function (match, field) {
                        return data[(typeof field === "number" && field < 0) ? data.length + field : field];
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["match", "field"]},
                        __module__ : {value: "iframe_comm"}
                    });
                    return _anonfunc;
                })());
            } else {
                self.iframe.src = self.constructor_url;
            }
            self.srcdoc_created = true;
        };
        if (!IframeWrapper.prototype.create_srcdoc.__module__) Object.defineProperties(IframeWrapper.prototype.create_srcdoc, {
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.init = function init() {
            var self = this;
            var iframe, sdoc, ch;
            if (!self.needs_init) {
                return;
            }
            self.needs_init = false;
            iframe = self.iframe;
            if (self.srcdoc_created) {
                if (self.entry_point) {
                    sdoc = iframe.srcdoc;
                    iframe.srcdoc = "<p>&nbsp;</p>";
                    iframe.srcdoc = sdoc;
                } else {
                    self.reload_count += 1;
                    ch = (_in("?", self.constructor_url)) ? "&" : "?";
                    iframe.src = self.constructor_url + ("" + _str.format("{}", ch) + "rc=" + _str.format("{}", self.reload_count) + "");
                }
            } else {
                self.create_srcdoc();
            }
        };
        if (!IframeWrapper.prototype.init.__module__) Object.defineProperties(IframeWrapper.prototype.init, {
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.reset = function reset() {
            var self = this;
            self.ready = false;
            self.needs_init = true;
            self.encrypted_communications = false;
        };
        if (!IframeWrapper.prototype.reset.__module__) Object.defineProperties(IframeWrapper.prototype.reset, {
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype._send_message = function _send_message(action, encrypted, data) {
            var self = this;
            var msg;
            if (!self.ready) {
                return;
            }
            data.action = action;
            msg = (function(){
                var _d = Object.create(null);
                _d["data"] = data;
                _d["encrypted"] = encrypted;
                return _d;
            }).call(this);
            if (encrypted) {
                msg.data = self.messenger.encrypt(data);
            }
            self.iframe.contentWindow.postMessage(msg, "*");
        };
        if (!IframeWrapper.prototype._send_message.__argnames__) Object.defineProperties(IframeWrapper.prototype._send_message, {
            __argnames__ : {value: ["action", "encrypted", "data"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.send_message = function send_message() {
            var self = this;
            var action = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var data = arguments[arguments.length-1];
            if (data === null || typeof data !== "object" || data [_kwargs_symbol] !== true) data = {};
            self._send_message(action, self.encrypted_communications, data);
        };
        if (!IframeWrapper.prototype.send_message.__handles_kwarg_interpolation__) Object.defineProperties(IframeWrapper.prototype.send_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["action"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.send_unencrypted_message = function send_unencrypted_message() {
            var self = this;
            var action = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var data = arguments[arguments.length-1];
            if (data === null || typeof data !== "object" || data [_kwargs_symbol] !== true) data = {};
            self._send_message(action, false, data);
        };
        if (!IframeWrapper.prototype.send_unencrypted_message.__handles_kwarg_interpolation__) Object.defineProperties(IframeWrapper.prototype.send_unencrypted_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["action"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.handle_message = function handle_message(event) {
            var self = this;
            var data, func;
            if (event.source !== _exists.d(self.iframe).contentWindow) {
                return;
            }
            data = event.data;
            if (self.encrypted_communications) {
                if (data.tag === undefined) {
                    print("Ignoring unencrypted message from iframe:", data);
                    return;
                }
                try {
                    data = self.messenger.decrypt(data);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        var e = _Exception;
                        print("Could not decrypt message from iframe:");
                        console.log(e);
                        traceback.print_exc();
                        return;
                    } else {
                        throw _Exception;
                    }
                }
            }
            if (!data.action) {
                return;
            }
            func = (_expr_temp = self.handlers)[_bound_index(data.action, _expr_temp)];
            if (func) {
                func(data);
            } else {
                print("Unknown action in message from iframe to parent:", data.action);
            }
        };
        if (!IframeWrapper.prototype.handle_message.__argnames__) Object.defineProperties(IframeWrapper.prototype.handle_message, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.on_iframe_ready = function on_iframe_ready(data) {
            var self = this;
            var msg, callback;
            self.messenger.reset();
            msg = (function(){
                var _d = Object.create(null);
                _d["secret"] = self.messenger.secret;
                _d["translations"] = get_translations();
                return _d;
            }).call(this);
            self.ready = true;
            callback = null;
            if (self.on_ready_handler) {
                callback = self.on_ready_handler(msg);
            }
            self._send_message("initialize", false, msg);
            self.encrypted_communications = true;
            if (callback) {
                callback();
            }
        };
        if (!IframeWrapper.prototype.on_iframe_ready.__argnames__) Object.defineProperties(IframeWrapper.prototype.on_iframe_ready, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeWrapper.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        IframeWrapper.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(IframeWrapper.prototype, "__bases__", {value: []});
        

        function create_wrapped_iframe(handlers, bootstrap_text, entry_point, kw) {
            var iframe, ans;
            if (_in(":", entry_point)) {
                kw.src = entry_point;
                kw.sandbox = (kw.sandbox || "") + " allow-same-origin";
            }
            iframe = _interpolate_kwargs.call(E, E.iframe, [_desugar_kwargs(kw)]);
            ans = new IframeWrapper(handlers, iframe, entry_point, bootstrap_text);
            return [iframe, ans];
        };
        if (!create_wrapped_iframe.__argnames__) Object.defineProperties(create_wrapped_iframe, {
            __argnames__ : {value: ["handlers", "bootstrap_text", "entry_point", "kw"]},
            __module__ : {value: "iframe_comm"}
        });

        instance_numbers = Object.create(null);
        function IframeClient() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            IframeClient.prototype.__bind_methods__.call(this);
            IframeClient.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(IframeClient.prototype, "__bind_methods__", {value: function () {
            this.send_ready = IframeClient.prototype.send_ready.bind(this);
            this.initialize = IframeClient.prototype.initialize.bind(this);
            this.print_to_parent = IframeClient.prototype.print_to_parent.bind(this);
            this.handle_message = IframeClient.prototype.handle_message.bind(this);
            this.send_message = IframeClient.prototype.send_message.bind(this);
        }});
        IframeClient.prototype.__init__ = function __init__(handlers, name) {
            var self = this;
            var k;
            self.encrypted_communications = false;
            self.name = name;
            if (!instance_numbers[_bound_index(self.name, instance_numbers)]) {
                instance_numbers[_bound_index(self.name, instance_numbers)] = 0;
            }
            instance_numbers[_bound_index(self.name, instance_numbers)] += 1;
            self.instance_num = instance_numbers[_bound_index(self.name, instance_numbers)];
            self.handlers = (function() {
                var _Iter = _Iterable(handlers), _Result = Object.create(null), k;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    k = _Iter[_Index];
                    _Result[k] = (handlers[(typeof k === "number" && k < 0) ? handlers.length + k : k]);
                }
                return _Result;
            })();
            self.initialize_handler = handlers.initialize;
            self.handlers.initialize = self.initialize;
            self.ready_sent = false;
            window.addEventListener("message", self.handle_message, false);
            window.addEventListener("load", self.send_ready, (function(){
                var _d = Object.create(null);
                _d["once"] = true;
                return _d;
            }).call(this));
        };
        if (!IframeClient.prototype.__init__.__argnames__) Object.defineProperties(IframeClient.prototype.__init__, {
            __argnames__ : {value: ["handlers", "name"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeClient.__argnames__ = IframeClient.prototype.__init__.__argnames__;
        IframeClient.__handles_kwarg_interpolation__ = IframeClient.prototype.__init__.__handles_kwarg_interpolation__;
        IframeClient.prototype.send_ready = function send_ready() {
            var self = this;
            if (!self.ready_sent) {
                self.send_message("ready", Object.create(null));
                self.ready_sent = true;
            }
        };
        if (!IframeClient.prototype.send_ready.__module__) Object.defineProperties(IframeClient.prototype.send_ready, {
            __module__ : {value: "iframe_comm"}
        });
        IframeClient.prototype.initialize = function initialize(data) {
            var self = this;
            var _unpack;
            _unpack = [new GCM(data.secret.subarray(0, 32)), new GCM(data.secret.subarray(32))];
            self.gcm_from_parent = _unpack[0];
            self.gcm_to_parent = _unpack[1];
            self.encrypted_communications = true;
            if (data.translations) {
                install(data.translations);
            }
            print = self.print_to_parent;
            if (self.initialize_handler) {
                self.initialize_handler(data);
            }
        };
        if (!IframeClient.prototype.initialize.__argnames__) Object.defineProperties(IframeClient.prototype.initialize, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeClient.prototype.print_to_parent = function print_to_parent() {
            var self = this;
            var args = Array.prototype.slice.call(arguments, 0);
            if (arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) args.pop();
            _interpolate_kwargs.call(self, self.send_message, ["print"].concat([_desugar_kwargs({string: " ".join(map(str, args))})]));
        };
        if (!IframeClient.prototype.print_to_parent.__handles_kwarg_interpolation__) Object.defineProperties(IframeClient.prototype.print_to_parent, {
            __handles_kwarg_interpolation__ : {value: true},
            __module__ : {value: "iframe_comm"}
        });
        IframeClient.prototype.handle_message = function handle_message(event) {
            var self = this;
            var msg, data, func, details;
            if (event.source !== window.parent) {
                return;
            }
            msg = event.data;
            data = msg.data;
            if (msg.encrypted) {
                if (!self.gcm_from_parent) {
                    print("the iframe " + _str.format("{}", self.name) + "-" + _str.format("{}", self.instance_num) + " got an encrypted message from its parent without being initialized");
                    return;
                }
                try {
                    data = JSON.parse(self.gcm_from_parent.decrypt(data));
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        var e = _Exception;
                        print("Could not process message from parent:");
                        console.log(e);
                        return;
                    } else {
                        throw _Exception;
                    }
                }
            }
            if (!data || !data.action) {
                console.log("Got a null message from parent in iframe, ignoring");
                return;
            }
            func = (_expr_temp = self.handlers)[_bound_index(data.action, _expr_temp)];
            if (func) {
                try {
                    func(data);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        var e = _Exception;
                        console.log("Error in iframe message handler {}:".format((typeof data !== "undefined" && data !== null ? data : Object.create(null)).action));
                        console.log(e);
                        details = traceback.format_exc();
                        console.log(details);
                        _interpolate_kwargs.call(self, self.send_message, ["error"].concat([_desugar_kwargs({title: "Error in message handler", details: details, msg: e.toString()})]));
                    } else {
                        throw _Exception;
                    }
                }
            } else {
                print("Unknown action in message to iframe from parent: " + data.action);
            }
        };
        if (!IframeClient.prototype.handle_message.__argnames__) Object.defineProperties(IframeClient.prototype.handle_message, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeClient.prototype.send_message = function send_message(action, data) {
            var self = this;
            data.action = action;
            data.iframe_id = "" + _str.format("{}", self.name) + "-" + _str.format("{}", self.instance_num) + "";
            if (self.encrypted_communications) {
                data = self.gcm_to_parent.encrypt(JSON.stringify(data));
            }
            window.parent.postMessage(data, "*");
        };
        if (!IframeClient.prototype.send_message.__argnames__) Object.defineProperties(IframeClient.prototype.send_message, {
            __argnames__ : {value: ["action", "data"]},
            __module__ : {value: "iframe_comm"}
        });
        IframeClient.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        IframeClient.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(IframeClient.prototype, "__bases__", {value: []});

        _modules.iframe_comm.LOADING_DOC = LOADING_DOC;
        _modules.iframe_comm.instance_numbers = instance_numbers;
        _modules.iframe_comm.Messenger = Messenger;
        _modules.iframe_comm.IframeWrapper = IframeWrapper;
        _modules.iframe_comm.create_wrapped_iframe = create_wrapped_iframe;
        _modules.iframe_comm.IframeClient = IframeClient;
    })();

    (function(){
        var __name__ = "range_utils";
        var wrapper_counter;
        function is_non_empty_text_node(node) {
            return (node.nodeType === Node.TEXT_NODE || node.nodeType === Node.CDATA_SECTION_NODE) && node.nodeValue.length > 0;
        };
        if (!is_non_empty_text_node.__argnames__) Object.defineProperties(is_non_empty_text_node, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "range_utils"}
        });

        function is_element_visible(elem) {
            var s;
            s = window.getComputedStyle(elem);
            return s.display !== "none" && s.visibility !== "hidden";
        };
        if (!is_element_visible.__argnames__) Object.defineProperties(is_element_visible, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "range_utils"}
        });

        function is_node_visible(node) {
            var current;
            if (node.nodeType !== Node.ELEMENT_NODE) {
                node = node.parentElement;
                if (!node) {
                    return false;
                }
            }
            current = node;
            while (current) {
                if (!is_element_visible(current)) {
                    return false;
                }
                current = current.parentElement;
            }
            return true;
        };
        if (!is_node_visible.__argnames__) Object.defineProperties(is_node_visible, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "range_utils"}
        });

        function select_nodes_from_range(r, predicate) {
            var parent, doc, iterator, in_range, ans, node;
            parent = r.commonAncestorContainer;
            doc = parent.ownerDocument || document;
            iterator = doc.createNodeIterator(parent);
            in_range = false;
            ans = [];
            while (true) {
                node = iterator.nextNode();
                if (!node) {
                    break;
                }
                if (!in_range && node.isSameNode(r.startContainer)) {
                    in_range = true;
                }
                if (in_range) {
                    if (predicate(node)) {
                        ans.push(node);
                    }
                    if (node.isSameNode(r.endContainer)) {
                        break;
                    }
                }
            }
            return ans;
        };
        if (!select_nodes_from_range.__argnames__) Object.defineProperties(select_nodes_from_range, {
            __argnames__ : {value: ["r", "predicate"]},
            __module__ : {value: "range_utils"}
        });

        function select_first_node_from_range(r, predicate) {
            var parent, doc, iterator, in_range, node;
            parent = r.commonAncestorContainer;
            doc = parent.ownerDocument || document;
            iterator = doc.createNodeIterator(parent);
            in_range = false;
            while (true) {
                node = iterator.nextNode();
                if (!node) {
                    break;
                }
                if (!in_range && node.isSameNode(r.startContainer)) {
                    in_range = true;
                }
                if (in_range) {
                    if (predicate(node)) {
                        return node;
                    }
                    if (node.isSameNode(r.endContainer)) {
                        break;
                    }
                }
            }
        };
        if (!select_first_node_from_range.__argnames__) Object.defineProperties(select_first_node_from_range, {
            __argnames__ : {value: ["r", "predicate"]},
            __module__ : {value: "range_utils"}
        });

        function text_nodes_in_range(r) {
            return select_nodes_from_range(r, is_non_empty_text_node);
        };
        if (!text_nodes_in_range.__argnames__) Object.defineProperties(text_nodes_in_range, {
            __argnames__ : {value: ["r"]},
            __module__ : {value: "range_utils"}
        });

        function all_annots_in_range(r, annot_id_uuid_map, ans) {
            var parent, doc, iterator, is_full_tree, in_range, node, annot_id;
            parent = r.commonAncestorContainer;
            doc = parent.ownerDocument || document;
            iterator = doc.createNodeIterator(parent);
            is_full_tree = parent === doc.documentElement;
            in_range = is_full_tree;
            while (true) {
                node = iterator.nextNode();
                if (!node) {
                    break;
                }
                if (!in_range && node.isSameNode(r.startContainer)) {
                    in_range = true;
                }
                if (in_range) {
                    if (node.dataset && node.dataset.calibreRangeWrapper) {
                        annot_id = annot_id_uuid_map[_bound_index(node.dataset.calibreRangeWrapper, annot_id_uuid_map)];
                        if (annot_id) {
                            if (!ans) {
                                return annot_id;
                            }
                            ans[(typeof annot_id === "number" && annot_id < 0) ? ans.length + annot_id : annot_id] = true;
                        }
                    }
                    if (!is_full_tree && node.isSameNode(r.endContainer)) {
                        break;
                    }
                }
            }
            return ans;
        };
        if (!all_annots_in_range.__argnames__) Object.defineProperties(all_annots_in_range, {
            __argnames__ : {value: ["r", "annot_id_uuid_map", "ans"]},
            __module__ : {value: "range_utils"}
        });

        function first_annot_in_range(r, annot_id_uuid_map) {
            return all_annots_in_range(r, annot_id_uuid_map);
        };
        if (!first_annot_in_range.__argnames__) Object.defineProperties(first_annot_in_range, {
            __argnames__ : {value: ["r", "annot_id_uuid_map"]},
            __module__ : {value: "range_utils"}
        });

        function all_annots_in_selection(sel, annot_id_uuid_map) {
            var ans, i;
            ans = {};
            for (var _Index0 = 0; _Index0 < sel.rangeCount; _Index0++) {
                i = _Index0;
                all_annots_in_range(sel.getRangeAt(i), annot_id_uuid_map, ans);
            }
            return Object.keys(ans);
        };
        if (!all_annots_in_selection.__argnames__) Object.defineProperties(all_annots_in_selection, {
            __argnames__ : {value: ["sel", "annot_id_uuid_map"]},
            __module__ : {value: "range_utils"}
        });

        function remove(node) {
            if (node.parentNode) {
                node.parentNode.removeChild(node);
            }
        };
        if (!remove.__argnames__) Object.defineProperties(remove, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "range_utils"}
        });

        function replace_node(replacement, node) {
            var p;
            p = node.parentNode;
            p.insertBefore(replacement, node);
            remove(node);
            return p;
        };
        if (!replace_node.__argnames__) Object.defineProperties(replace_node, {
            __argnames__ : {value: ["replacement", "node"]},
            __module__ : {value: "range_utils"}
        });

        function unwrap(node) {
            var r, p;
            r = (node.ownerDocument || document).createRange();
            r.selectNodeContents(node);
            p = replace_node(r.extractContents(), node);
            if (p) {
                p.normalize();
            }
        };
        if (!unwrap.__argnames__) Object.defineProperties(unwrap, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "range_utils"}
        });

        function unwrap_crw(crw) {
            var node;
            var _Iter1 = _Iterable(document.querySelectorAll("span[data-calibre-range-wrapper=\"" + _str.format("{}", crw) + "\"]"));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                node = _Iter1[_Index1];
                unwrap(node);
            }
        };
        if (!unwrap_crw.__argnames__) Object.defineProperties(unwrap_crw, {
            __argnames__ : {value: ["crw"]},
            __module__ : {value: "range_utils"}
        });

        function unwrap_all_crw() {
            var node;
            var _Iter2 = _Iterable(document.querySelectorAll("span[data-calibre-range-wrapper]"));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                node = _Iter2[_Index2];
                unwrap(node);
            }
        };
        if (!unwrap_all_crw.__module__) Object.defineProperties(unwrap_all_crw, {
            __module__ : {value: "range_utils"}
        });

        function select_crw(crw) {
            var nodes, r, sel;
            nodes = document.querySelectorAll("span[data-calibre-range-wrapper=\"" + _str.format("{}", crw) + "\"]");
            if (nodes && nodes.length) {
                r = document.createRange();
                r.setStart(nodes[0].firstChild, 0);
                r.setEnd(nodes[nodes.length-1].lastChild, nodes[nodes.length-1].lastChild.nodeValue.length);
                sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(r);
                return true;
            }
            print("range-wrapper: " + _str.format("{}", crw) + " does not exist");
            return false;
        };
        if (!select_crw.__argnames__) Object.defineProperties(select_crw, {
            __argnames__ : {value: ["crw"]},
            __module__ : {value: "range_utils"}
        });

        function wrap_range(r, wrapper) {
            try {
                r.surroundContents(wrapper);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    wrapper.appendChild(r.extractContents());
                    r.insertNode(wrapper);
                } 
            }
        };
        if (!wrap_range.__argnames__) Object.defineProperties(wrap_range, {
            __argnames__ : {value: ["r", "wrapper"]},
            __module__ : {value: "range_utils"}
        });

        function create_wrapper_function(wrapper_elem, r, intersecting_wrappers, process_wrapper, all_wrappers) {
            var start_node, end_node, start_offset, end_offset;
            start_node = r.startContainer;
            end_node = r.endContainer;
            start_offset = r.startOffset;
            end_offset = r.endOffset;
            function wrap_node(node) {
                var current_range, current_wrapper, crw;
                current_range = (node.ownerDocument || document).createRange();
                current_wrapper = wrapper_elem.cloneNode();
                current_range.selectNodeContents(node);
                if (node.isSameNode(start_node)) {
                    current_range.setStart(node, start_offset);
                    start_node = current_wrapper;
                    start_offset = 0;
                }
                if (node.isSameNode(end_node)) {
                    current_range.setEnd(node, end_offset);
                    end_node = current_wrapper;
                    end_offset = 1;
                }
                if (current_range.collapsed) {
                    return;
                }
                crw = _exists.d(_exists.d(node.parentNode).dataset).calibreRangeWrapper;
                if (crw) {
                    intersecting_wrappers[(typeof crw === "number" && crw < 0) ? intersecting_wrappers.length + crw : crw] = true;
                }
                wrap_range(current_range, current_wrapper);
                if (process_wrapper) {
                    process_wrapper(current_wrapper);
                }
                all_wrappers.push(current_wrapper);
            };
            if (!wrap_node.__argnames__) Object.defineProperties(wrap_node, {
                __argnames__ : {value: ["node"]},
                __module__ : {value: "range_utils"}
            });

            return wrap_node;
        };
        if (!create_wrapper_function.__argnames__) Object.defineProperties(create_wrapper_function, {
            __argnames__ : {value: ["wrapper_elem", "r", "intersecting_wrappers", "process_wrapper", "all_wrappers"]},
            __module__ : {value: "range_utils"}
        });

        wrapper_counter = 0;
        function wrap_text_in_range(styler, r, class_to_add_to_last, process_wrapper) {
            var sel, wrapper_elem, intersecting_wrappers, all_wrappers, wrap_node, ancestor, crw;
            if (!r) {
                sel = window.getSelection();
                if (!sel || !sel.rangeCount) {
                    return [null, []];
                }
                r = sel.getRangeAt(0);
            }
            if (r.isCollapsed) {
                return [null, []];
            }
            wrapper_elem = document.createElement("span");
            wrapper_elem.dataset.calibreRangeWrapper = ++wrapper_counter + "";
            if (styler) {
                styler(wrapper_elem);
            }
            intersecting_wrappers = Object.create(null);
            all_wrappers = [];
            wrap_node = create_wrapper_function(wrapper_elem, r, intersecting_wrappers, process_wrapper, all_wrappers);
            text_nodes_in_range(r).map(wrap_node);
            ancestor = r.commonAncestorContainer;
            if (ancestor.nodeType === Node.TEXT_NODE) {
                ancestor = ancestor.parentNode;
            }
            ancestor.normalize();
            crw = wrapper_elem.dataset.calibreRangeWrapper;
            delete intersecting_wrappers[crw];
            if (class_to_add_to_last && all_wrappers.length) {
                all_wrappers[all_wrappers.length-1].classList.add(class_to_add_to_last);
            }
            return [crw, Object.keys(intersecting_wrappers)];
        };
        if (!wrap_text_in_range.__argnames__) Object.defineProperties(wrap_text_in_range, {
            __argnames__ : {value: ["styler", "r", "class_to_add_to_last", "process_wrapper"]},
            __module__ : {value: "range_utils"}
        });

        function last_span_for_crw(crw) {
            var nodes;
            nodes = document.querySelectorAll("span[data-calibre-range-wrapper=\"" + _str.format("{}", crw) + "\"]");
            if (nodes && nodes.length) {
                return nodes[nodes.length-1];
            }
        };
        if (!last_span_for_crw.__argnames__) Object.defineProperties(last_span_for_crw, {
            __argnames__ : {value: ["crw"]},
            __module__ : {value: "range_utils"}
        });

        function reset_highlight_counter() {
            wrapper_counter = 0;
        };
        if (!reset_highlight_counter.__module__) Object.defineProperties(reset_highlight_counter, {
            __module__ : {value: "range_utils"}
        });

        function get_annot_id_for(node, offset, annot_id_uuid_map) {
            if (!node) {
                return;
            }
            if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.dataset.calibreRangeWrapper) {
                    return annot_id_uuid_map[_bound_index(node.dataset.calibreRangeWrapper, annot_id_uuid_map)];
                }
                if (offset === 0) {
                    if (_exists.d(node.firstChild).nodeType === Node.ELEMENT_NODE && node.firstChild.dataset.calibreRangeWrapper) {
                        return annot_id_uuid_map[_bound_index(node.firstChild.dataset.calibreRangeWrapper, annot_id_uuid_map)];
                    }
                } else if (offset < node.childNodes.length) {
                    node = (_expr_temp = node.childNodes)[(typeof offset === "number" && offset < 0) ? _expr_temp.length + offset : offset];
                    return get_annot_id_for(node, 0, annot_id_uuid_map);
                }
            } else if (node.nodeType === Node.TEXT_NODE) {
                if (_exists.d(node.parentNode).nodeType === Node.ELEMENT_NODE && node.parentNode.dataset.calibreRangeWrapper) {
                    return annot_id_uuid_map[_bound_index(node.parentNode.dataset.calibreRangeWrapper, annot_id_uuid_map)];
                }
            }
        };
        if (!get_annot_id_for.__argnames__) Object.defineProperties(get_annot_id_for, {
            __argnames__ : {value: ["node", "offset", "annot_id_uuid_map"]},
            __module__ : {value: "range_utils"}
        });

        function highlight_associated_with_selection(sel, annot_id_uuid_map) {
            var annot_id, r;
            if (sel.rangeCount) {
                annot_id = get_annot_id_for(sel.focusNode, sel.focusOffset, annot_id_uuid_map) || get_annot_id_for(sel.anchorNode, sel.anchorOffset, annot_id_uuid_map);
                if (annot_id) {
                    return annot_id;
                }
                for (var i = 0; i < sel.rangeCount; i++) {
                    r = sel.getRangeAt(i);
                    annot_id = first_annot_in_range(r, annot_id_uuid_map);
                    if (annot_id) {
                        return annot_id;
                    }
                }
            }
        };
        if (!highlight_associated_with_selection.__argnames__) Object.defineProperties(highlight_associated_with_selection, {
            __argnames__ : {value: ["sel", "annot_id_uuid_map"]},
            __module__ : {value: "range_utils"}
        });

        _modules.range_utils.wrapper_counter = wrapper_counter;
        _modules.range_utils.is_non_empty_text_node = is_non_empty_text_node;
        _modules.range_utils.is_element_visible = is_element_visible;
        _modules.range_utils.is_node_visible = is_node_visible;
        _modules.range_utils.select_nodes_from_range = select_nodes_from_range;
        _modules.range_utils.select_first_node_from_range = select_first_node_from_range;
        _modules.range_utils.text_nodes_in_range = text_nodes_in_range;
        _modules.range_utils.all_annots_in_range = all_annots_in_range;
        _modules.range_utils.first_annot_in_range = first_annot_in_range;
        _modules.range_utils.all_annots_in_selection = all_annots_in_selection;
        _modules.range_utils.remove = remove;
        _modules.range_utils.replace_node = replace_node;
        _modules.range_utils.unwrap = unwrap;
        _modules.range_utils.unwrap_crw = unwrap_crw;
        _modules.range_utils.unwrap_all_crw = unwrap_all_crw;
        _modules.range_utils.select_crw = select_crw;
        _modules.range_utils.wrap_range = wrap_range;
        _modules.range_utils.create_wrapper_function = create_wrapper_function;
        _modules.range_utils.wrap_text_in_range = wrap_text_in_range;
        _modules.range_utils.last_span_for_crw = last_span_for_crw;
        _modules.range_utils.reset_highlight_counter = reset_highlight_counter;
        _modules.range_utils.get_annot_id_for = get_annot_id_for;
        _modules.range_utils.highlight_associated_with_selection = highlight_associated_with_selection;
    })();

    (function(){
        var __name__ = "read_book.anchor_visibility";
        var anchor_position_cache;
        var current_layout_mode = _modules["read_book.globals"].current_layout_mode;
        var get_boss = _modules["read_book.globals"].get_boss;

        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;

        anchor_position_cache = Object.create(null);
        function invalidate_anchor_position_cache() {
            anchor_position_cache = (function(){
                var _d = Object.create(null);
                _d["layout_mode"] = current_layout_mode();
                _d["width"] = scroll_viewport.width();
                _d["height"] = scroll_viewport.height();
                _d["positions"] = {};
                return _d;
            }).call(this);
        };
        if (!invalidate_anchor_position_cache.__module__) Object.defineProperties(invalidate_anchor_position_cache, {
            __module__ : {value: "read_book.anchor_visibility"}
        });

        function ensure_anchor_cache_valid() {
            var a;
            a = anchor_position_cache;
            if (a.layout_mode !== current_layout_mode() || a.width !== scroll_viewport.width() || a.height !== scroll_viewport.height()) {
                invalidate_anchor_position_cache();
            }
        };
        if (!ensure_anchor_cache_valid.__module__) Object.defineProperties(ensure_anchor_cache_valid, {
            __module__ : {value: "read_book.anchor_visibility"}
        });

        function position_for_anchor(anchor) {
            var cache, val, anchor_funcs, elem;
            ensure_anchor_cache_valid();
            cache = anchor_position_cache.positions;
            val = cache[(typeof anchor === "number" && anchor < 0) ? cache.length + anchor : anchor];
            if ((typeof val !== "undefined" && val !== null)) {
                return val;
            }
            anchor_funcs = get_boss().anchor_funcs;
            elem = document.getElementById(anchor);
            val = (elem) ? anchor_funcs.pos_for_elem(elem) : anchor_funcs.pos_for_elem();
            cache[(typeof anchor === "number" && anchor < 0) ? cache.length + anchor : anchor] = val;
            return val;
        };
        if (!position_for_anchor.__argnames__) Object.defineProperties(position_for_anchor, {
            __argnames__ : {value: ["anchor"]},
            __module__ : {value: "read_book.anchor_visibility"}
        });

        function is_anchor_on_screen(anchor) {
            var pos, anchor_funcs;
            pos = position_for_anchor(anchor);
            anchor_funcs = get_boss().anchor_funcs;
            return anchor_funcs.visibility(pos) === 0;
        };
        if (!is_anchor_on_screen.__argnames__) Object.defineProperties(is_anchor_on_screen, {
            __argnames__ : {value: ["anchor"]},
            __module__ : {value: "read_book.anchor_visibility"}
        });

        _modules["read_book.anchor_visibility"].anchor_position_cache = anchor_position_cache;
        _modules["read_book.anchor_visibility"].invalidate_anchor_position_cache = invalidate_anchor_position_cache;
        _modules["read_book.anchor_visibility"].ensure_anchor_cache_valid = ensure_anchor_cache_valid;
        _modules["read_book.anchor_visibility"].position_for_anchor = position_for_anchor;
        _modules["read_book.anchor_visibility"].is_anchor_on_screen = is_anchor_on_screen;
    })();

    (function(){
        var __name__ = "read_book.extract";
        var annot_id_uuid_map = _modules["read_book.globals"].annot_id_uuid_map;

        function get_elements(x, y) {
            var ans, tl, annot_id, elem;
            ans = (function(){
                var _d = Object.create(null);
                _d["link"] = null;
                _d["img"] = null;
                _d["highlight"] = null;
                _d["crw"] = null;
                return _d;
            }).call(this);
            var _Iter0 = _Iterable(document.elementsFromPoint(x, y));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                elem = _Iter0[_Index0];
                tl = elem.tagName.toLowerCase();
                if (tl === "a" && elem.getAttribute("href") && !ans.link) {
                    ans.link = elem.getAttribute("href");
                } else if ((tl === "img" || tl === "image") && elem.getAttribute("data-calibre-src") && !ans.img) {
                    ans.img = elem.getAttribute("data-calibre-src");
                } else if (_exists.d(elem.dataset).calibreRangeWrapper) {
                    ans.crw = elem.dataset.calibreRangeWrapper;
                    annot_id = annot_id_uuid_map[_bound_index(ans.crw, annot_id_uuid_map)];
                    if (annot_id) {
                        ans.highlight = annot_id;
                    }
                }
            }
            return ans;
        };
        if (!get_elements.__argnames__) Object.defineProperties(get_elements, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.extract"}
        });

        _modules["read_book.extract"].get_elements = get_elements;
    })();

    (function(){
        var __name__ = "read_book.find";
        var cache;
        function build_text_map() {
            var node_list, flat_text, ignored_tags, text_node_type, element_node_type;
            node_list = [];
            flat_text = "";
            ignored_tags = (function(){
                var _d = Object.create(null);
                _d["style"] = true;
                _d["script"] = true;
                _d["noscript"] = true;
                _d["title"] = true;
                _d["meta"] = true;
                _d["head"] = true;
                _d["link"] = true;
                _d["html"] = true;
                _d["img"] = true;
                return _d;
            }).call(this);
            text_node_type = Node.TEXT_NODE;
            element_node_type = Node.ELEMENT_NODE;
            function process_node(node) {
                var nt, text, tag, children, i;
                nt = node.nodeType;
                if (nt === text_node_type) {
                    text = node.nodeValue;
                    if (text && text.length) {
                        node_list.push({node: node, offset: flat_text.length, length: text.length});
                        flat_text += text;
                    }
                } else if (nt === element_node_type) {
                    if (!node.hasChildNodes()) {
                        return;
                    }
                    tag = node.tagName.toLowerCase();
                    if (ignored_tags[(typeof tag === "number" && tag < 0) ? ignored_tags.length + tag : tag]) {
                        return;
                    }
                    children = node.childNodes;
                    for (var _Index0 = 0; _Index0 < children.length; _Index0++) {
                        i = _Index0;
                        process_node(children[i]);
                    }
                }
            };
            if (!process_node.__argnames__) Object.defineProperties(process_node, {
                __argnames__ : {value: ["node"]},
                __module__ : {value: "read_book.find"}
            });

            process_node(document.body);
            return (function(){
                var _d = Object.create(null);
                _d["timestamp"] = window.performance.now();
                _d["flat_text"] = flat_text;
                _d["node_list"] = node_list;
                return _d;
            }).call(this);
        };
        if (!build_text_map.__module__) Object.defineProperties(build_text_map, {
            __module__ : {value: "read_book.find"}
        });

        function index_for_node(node, node_list) {
            var entry;
            var _Iter1 = _Iterable(node_list);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                entry = _Iter1[_Index1];
                if (entry.node.isSameNode(node)) {
                    return entry.offset;
                }
            }
        };
        if (!index_for_node.__argnames__) Object.defineProperties(index_for_node, {
            __argnames__ : {value: ["node", "node_list"]},
            __module__ : {value: "read_book.find"}
        });

        function tts_word_regex() {
            return /[\p{Letter}\p{Mark}\p{Number}\p{Punctuation}\p{Cf}]{1,50}/gu;
        };
        if (!tts_word_regex.__module__) Object.defineProperties(tts_word_regex, {
            __module__ : {value: "read_book.find"}
        });

        function tts_data(text_node, offset) {
            var offset_in_flat_text, match, first, last, marked_text, text, start, trailer;
            offset_in_flat_text = offset || 0;
            if (!cache.text_map) {
                cache.text_map = build_text_map();
            }
            if (text_node) {
                offset_in_flat_text += index_for_node(text_node, cache.text_map.node_list) || 0;
            }
            match = null;
            first = true;
            last = null;
            marked_text = [];
            text = cache.text_map.flat_text.slice(offset_in_flat_text);
            for (match of text.matchAll(tts_word_regex())) {
                start = match.index;
                if (first) {
                    first = false;
                    if (start) {
                        marked_text.push(text.slice(0, start));
                    }
                } else if (start > last) {
                    marked_text.push(text.slice(last, start));
                }
                marked_text.push(start + offset_in_flat_text);
                marked_text.push(match[0]);
                last = start + match[0].length;
            }
            if (last === null) {
                marked_text.push(text);
            } else {
                trailer = text.slice(last);
                if (trailer) {
                    marked_text.push(trailer);
                }
            }
            return marked_text;
        };
        if (!tts_data.__argnames__) Object.defineProperties(tts_data, {
            __argnames__ : {value: ["text_node", "offset"]},
            __module__ : {value: "read_book.find"}
        });

        function find_node_for_index_binary(node_list, idx_in_flat_text, start) {
            var end, mid, q, limit, start_node, start_offset;
            start = start || 0;
            end = node_list.length - 1;
            while (start <= end) {
                mid = Math.floor((start + end) / 2);
                q = node_list[(typeof mid === "number" && mid < 0) ? node_list.length + mid : mid];
                limit = q.offset + q.length;
                if (q.offset <= idx_in_flat_text && limit > idx_in_flat_text) {
                    start_node = q.node;
                    start_offset = idx_in_flat_text - q.offset;
                    return [start_node, start_offset, mid];
                }
                if (limit <= idx_in_flat_text) {
                    start = mid + 1;
                } else {
                    end = mid - 1;
                }
            }
            return [null, null, null];
        };
        if (!find_node_for_index_binary.__argnames__) Object.defineProperties(find_node_for_index_binary, {
            __argnames__ : {value: ["node_list", "idx_in_flat_text", "start"]},
            __module__ : {value: "read_book.find"}
        });

        function get_occurrence_data(node_list, start, end) {
            var _unpack, start_node, start_offset, start_pos, end_node, end_offset, node_pos;
            _unpack = find_node_for_index_binary(node_list, start);
_unpack = _unpack_asarray(3, _unpack);
            start_node = _unpack[0];
            start_offset = _unpack[1];
            start_pos = _unpack[2];
            if (start_node !== null) {
                _unpack = find_node_for_index_binary(node_list, end, start_pos);
_unpack = _unpack_asarray(3, _unpack);
                end_node = _unpack[0];
                end_offset = _unpack[1];
                node_pos = _unpack[2];
                if (end_node !== null) {
                    return (function(){
                        var _d = Object.create(null);
                        _d["start_node"] = start_node;
                        _d["start_offset"] = start_offset;
                        _d["start_pos"] = start_pos;
                        _d["end_node"] = end_node;
                        _d["end_offset"] = end_offset;
                        _d["end_pos"] = node_pos;
                        return _d;
                    }).call(this);
                }
            }
        };
        if (!get_occurrence_data.__argnames__) Object.defineProperties(get_occurrence_data, {
            __argnames__ : {value: ["node_list", "start", "end"]},
            __module__ : {value: "read_book.find"}
        });

        function find_specific_occurrence(q, num, before_len, after_len, text_map, from_offset) {
            var from_idx, flat_text, match_num, idx;
            if (!q || !q.length) {
                return;
            }
            from_idx = from_offset || 0;
            flat_text = text_map.flat_text;
            match_num = -1;
            while (true) {
                idx = flat_text.indexOf(q, from_idx);
                if (idx < 0) {
                    break;
                }
                match_num += 1;
                from_idx = idx + 1;
                if (match_num < num) {
                    continue;
                }
                return get_occurrence_data(text_map.node_list, idx + before_len, idx + q.length - after_len);
            }
        };
        if (!find_specific_occurrence.__argnames__) Object.defineProperties(find_specific_occurrence, {
            __argnames__ : {value: ["q", "num", "before_len", "after_len", "text_map", "from_offset"]},
            __module__ : {value: "read_book.find"}
        });

        cache = Object.create(null);
        function reset_find_caches() {
            cache = Object.create(null);
        };
        if (!reset_find_caches.__module__) Object.defineProperties(reset_find_caches, {
            __module__ : {value: "read_book.find"}
        });

        function select_find_result(match) {
            var sel;
            sel = window.getSelection();
            try {
                sel.setBaseAndExtent(match.start_node, match.start_offset, match.end_node, match.end_offset);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    return false;
                } 
            }
            return bool(sel.rangeCount && sel.toString());
        };
        if (!select_find_result.__argnames__) Object.defineProperties(select_find_result, {
            __argnames__ : {value: ["match"]},
            __module__ : {value: "read_book.find"}
        });

        function select_search_result(sr) {
            var q, before_len, after_len, after, match;
            window.getSelection().removeAllRanges();
            if (!cache.text_map) {
                cache.text_map = build_text_map();
            }
            q = "";
            before_len = after_len = 0;
            if (sr.before) {
                q = sr.before.slice(-15);
                before_len = q.length;
            }
            q += sr.text;
            if (sr.after) {
                after = sr.after.slice(0, 15);
                after_len = after.length;
                q += after;
            }
            match = find_specific_occurrence(q, int(sr.index), before_len, after_len, cache.text_map, sr.from_offset);
            if (!match) {
                return false;
            }
            return select_find_result(match);
        };
        if (!select_search_result.__argnames__) Object.defineProperties(select_search_result, {
            __argnames__ : {value: ["sr"]},
            __module__ : {value: "read_book.find"}
        });

        function select_tts_mark(idx_in_flat_text) {
            var r, match, word_length;
            window.getSelection().removeAllRanges();
            if (!cache.text_map) {
                cache.text_map = build_text_map();
            }
            r = tts_word_regex();
            r.lastIndex = idx_in_flat_text;
            match = r.exec(cache.text_map.flat_text);
            word_length = 5;
            if (match) {
                word_length = _exists.d(match[0]).length || 5;
            }
            match = get_occurrence_data(cache.text_map.node_list, idx_in_flat_text, idx_in_flat_text + word_length);
            if (!match) {
                return false;
            }
            return select_find_result(match);
        };
        if (!select_tts_mark.__argnames__) Object.defineProperties(select_tts_mark, {
            __argnames__ : {value: ["idx_in_flat_text"]},
            __module__ : {value: "read_book.find"}
        });

        _modules["read_book.find"].cache = cache;
        _modules["read_book.find"].build_text_map = build_text_map;
        _modules["read_book.find"].index_for_node = index_for_node;
        _modules["read_book.find"].tts_word_regex = tts_word_regex;
        _modules["read_book.find"].tts_data = tts_data;
        _modules["read_book.find"].find_node_for_index_binary = find_node_for_index_binary;
        _modules["read_book.find"].get_occurrence_data = get_occurrence_data;
        _modules["read_book.find"].find_specific_occurrence = find_specific_occurrence;
        _modules["read_book.find"].reset_find_caches = reset_find_caches;
        _modules["read_book.find"].select_find_result = select_find_result;
        _modules["read_book.find"].select_search_result = select_search_result;
        _modules["read_book.find"].select_tts_mark = select_tts_mark;
    })();

    (function(){
        var __name__ = "read_book.settings";
        var opts, styles_id;
        var E = _modules.elementmaker.E;

        var dark_link_color = _modules["read_book.globals"].dark_link_color;
        var runtime = _modules["read_book.globals"].runtime;

        var session_defaults = _modules.session.session_defaults;

        opts = Object.create(null);
        function update_settings(settings) {
            settings = Object.assign(Object.create(null), session_defaults(), settings);
            opts.base_font_size = max(8, min(settings.base_font_size, 64));
            opts.bg_image_fade = settings.bg_image_fade || "transparent";
            opts.color_scheme = settings.color_scheme;
            opts.columns_per_screen = settings.columns_per_screen;
            opts.cover_preserve_aspect_ratio = !!settings.cover_preserve_aspect_ratio;
            opts.hide_tooltips = settings.hide_tooltips;
            opts.is_dark_theme = !!settings.is_dark_theme;
            opts.lines_per_sec_auto = settings.lines_per_sec_auto;
            opts.lines_per_sec_smooth = settings.lines_per_sec_smooth;
            opts.margin_left = max(0, settings.margin_left);
            opts.margin_right = max(0, settings.margin_right);
            opts.margin_top = max(0, settings.margin_top);
            opts.margin_bottom = max(0, settings.margin_bottom);
            opts.override_book_colors = settings.override_book_colors;
            opts.paged_wheel_scrolls_by_screen = !!settings.paged_wheel_scrolls_by_screen;
            opts.paged_wheel_section_jumps = !!settings.paged_wheel_section_jumps;
            opts.paged_pixel_scroll_threshold = settings.paged_pixel_scroll_threshold;
            opts.scroll_auto_boundary_delay = settings.scroll_auto_boundary_delay;
            opts.scroll_stop_boundaries = !!settings.scroll_stop_boundaries;
            opts.reverse_page_turn_zones = !!settings.reverse_page_turn_zones;
            opts.user_stylesheet = settings.user_stylesheet;
            opts.gesture_overrides = settings.gesture_overrides;
        };
        if (!update_settings.__argnames__) Object.defineProperties(update_settings, {
            __argnames__ : {value: ["settings"]},
            __module__ : {value: "read_book.settings"}
        });

        update_settings();
        function apply_font_size() {
            if (!runtime.is_standalone_viewer) {
                document.documentElement.style.fontSize = "{}px".format(opts.base_font_size);
            }
        };
        if (!apply_font_size.__module__) Object.defineProperties(apply_font_size, {
            __module__ : {value: "read_book.settings"}
        });

        function default_selection_colors() {
            if (opts.is_dark_theme) {
                return [dark_link_color, "#111"];
            }
            return ["#3297FD", "#fff"];
        };
        if (!default_selection_colors.__module__) Object.defineProperties(default_selection_colors, {
            __module__ : {value: "read_book.settings"}
        });

        function make_selection_background_opaque(selbg) {
            if (selbg && selbg.startsWith("#") && len(selbg) === 7) {
                selbg += "fe";
            }
            return selbg;
        };
        if (!make_selection_background_opaque.__argnames__) Object.defineProperties(make_selection_background_opaque, {
            __argnames__ : {value: ["selbg"]},
            __module__ : {value: "read_book.settings"}
        });

        styles_id = "calibre-color-scheme-style-overrides";
        function apply_colors(is_content_popup) {
            var des, elem, ss, text, c, _unpack, selbg, selfg, hints_box_css;
            des = document.documentElement.style;
            des.setProperty("--calibre-viewer-background-color", opts.color_scheme.background);
            des.setProperty("--calibre-viewer-foreground-color", opts.color_scheme.foreground);
            des.colorScheme = (opts.is_dark_theme) ? "dark" : "light";
            if (opts.color_scheme.link) {
                des.setProperty("--calibre-viewer-link-color", opts.color_scheme.link);
            }
            var _Iter0 = _Iterable(_list_decorate([ document.documentElement, document.body ]));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                elem = _Iter0[_Index0];
                elem.style.color = opts.color_scheme.foreground;
                elem.style.backgroundColor = "transparent";
            }
            des.backgroundColor = opts.bg_image_fade;
            ss = document.getElementById("calibre-color-scheme-style-overrides");
            if (!ss) {
                ss = _interpolate_kwargs.call(E, E.style, [_desugar_kwargs({id: styles_id, type: "text/css"})]);
                document.documentElement.appendChild(ss);
            }
            text = "";
            if (runtime.is_standalone_viewer && _in("macos", window.navigator.userAgent)) {
                text += "\n* { -webkit-hyphenate-character: \"-\" !important }\n";
            }
            if (opts.override_book_colors !== "never") {
                text = "body";
                if (opts.override_book_colors === "dark") {
                    text += ".calibre-viewer-dark-colors";
                }
                text += "\n        * {\n            color: " + _str.format("{}", opts.color_scheme.foreground) + " !important; /**/\n            background-color: " + _str.format("{}", opts.color_scheme.background) + " !important; /**/\n            border-color: " + _str.format("{}", opts.color_scheme.foreground) + " !important; /**/\n        }";
            }
            if (opts.color_scheme.link) {
                c = opts.color_scheme.link;
                text += "\nhtml > body :link, html > body :link * { color: " + _str.format("{}", c) + " !important } html > body :visited, html > body :visited * { color: " + _str.format("{}", c) + " !important }";
            }
            _unpack = default_selection_colors();
_unpack = _unpack_asarray(2, _unpack);
            selbg = _unpack[0];
            selfg = _unpack[1];
            selbg = make_selection_background_opaque(selbg);
            text += "\n::selection { background-color: " + _str.format("{}", selbg) + "; color: " + _str.format("{}", selfg) + " }";
            text += "\n::selection:window-inactive { background-color: " + _str.format("{}", selbg) + "; color: " + _str.format("{}", selfg) + " }";
            if (!is_content_popup) {
                text += "\nhtml::-webkit-scrollbar, body::-webkit-scrollbar { display: none !important }";
                text += "\nhtml, body { scrollbar-width: none !important }";
                text += "\n\n\n        .crw-has-dot::after {\n            content: \"\";            vertical-align: text-top;            background-color: currentColor !important;            text-decoration: none !important;            display: inline-block;            height: 0.7ex;            width: 0.7ex;            border-radius: 50%;        }\n        ";
            }
            hints_box_css = "\n            display: inline-block !important;            position: absolute !important;            text-indent: 0 !important;            text-decoration: none !important;            font-weight: bold !important;            color: " + _str.format("{}", selfg) + " !important;            background: " + _str.format("{}", selbg) + " !important;            cursor: default !important;            padding: 1px !important;            border: solid 1px " + _str.format("{}", opts.color_scheme.foreground) + " !important;    ";
            text += "\n\n\n        .calibre-reference-mode [data-calibre-ref-num]::before {\n            content: attr(data-calibre-ref-num) !important;            " + _str.format("{}", hints_box_css) + "\n        }\n    ";
            text += "\n\n\n        .calibre-hint-visible::before {\n            content: attr(data-calibre-hint-render) !important;            " + _str.format("{}", hints_box_css) + "\n        }\n\n        .calibre-hint-enter::before {\n            background: #FF5733 !important;         }\n\n        .calibre-animated-hint {\n            animation-name: calibre-animate-hint;             animation-duration: 0.3s;             animation-timing-function: ease-out;             display: inline-block !important;             text-indent: 0 !important;         }\n        @keyframes calibre-animate-hint {\n            from { transform: scale(1); }\n            to { transform: scale(2); }\n        }\n    ";
            ss.textContent = text;
        };
        if (!apply_colors.__argnames__) Object.defineProperties(apply_colors, {
            __argnames__ : {value: ["is_content_popup"]},
            __module__ : {value: "read_book.settings"}
        });

        function set_selection_style(style) {
            var _unpack, selbg, selfg, sheet, css_text, prop, rule;
            if (!style) {
                _unpack = default_selection_colors();
_unpack = _unpack_asarray(2, _unpack);
                selbg = _unpack[0];
                selfg = _unpack[1];
                style = (function(){
                    var _d = Object.create(null);
                    _d["color"] = selfg;
                    _d["background-color"] = selbg;
                    return _d;
                }).call(this);
            }
            sheet = document.getElementById(styles_id);
            if (!sheet) {
                return;
            }
            css_text = "";
            if (style.selbg) {
                style.selbg = make_selection_background_opaque(style.selbg);
            }
            var _Iter1 = _Iterable(Object.keys(style));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                prop = _Iter1[_Index1];
                css_text += "" + _str.format("{}", prop) + ": " + _str.format("{}", style[(typeof prop === "number" && prop < 0) ? style.length + prop : prop]) + "; ";
            }
            var _Iter2 = _Iterable(sheet.sheet.cssRules);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                rule = _Iter2[_Index2];
                if (rule.type === rule.STYLE_RULE && rule.selectorText.indexOf("selection") > -1) {
                    rule.style.cssText = css_text;
                }
            }
        };
        if (!set_selection_style.__argnames__) Object.defineProperties(set_selection_style, {
            __argnames__ : {value: ["style"]},
            __module__ : {value: "read_book.settings"}
        });

        function set_color_scheme_class() {
            document.documentElement.classList.add("is-calibre-viewer");
            if (opts.is_dark_theme) {
                document.body.classList.add("calibre-viewer-dark-colors");
                document.body.classList.remove("calibre-viewer-light-colors");
            } else {
                document.body.classList.add("calibre-viewer-light-colors");
                document.body.classList.remove("calibre-viewer-dark-colors");
            }
        };
        if (!set_color_scheme_class.__module__) Object.defineProperties(set_color_scheme_class, {
            __module__ : {value: "read_book.settings"}
        });

        function apply_stylesheet() {
            var sid, style;
            sid = "calibre-browser-viewer-user-stylesheet";
            style = document.getElementById(sid);
            if (!style) {
                if (!opts.user_stylesheet) {
                    return;
                }
                style = _interpolate_kwargs.call(E, E.style, [_desugar_kwargs({type: "text/css", id: sid})]);
                document.documentElement.appendChild(style);
            }
            style.textContent = opts.user_stylesheet;
        };
        if (!apply_stylesheet.__module__) Object.defineProperties(apply_stylesheet, {
            __module__ : {value: "read_book.settings"}
        });

        function apply_settings(is_content_popup) {
            apply_font_size();
            apply_colors(is_content_popup);
            apply_stylesheet();
        };
        if (!apply_settings.__argnames__) Object.defineProperties(apply_settings, {
            __argnames__ : {value: ["is_content_popup"]},
            __module__ : {value: "read_book.settings"}
        });

        _modules["read_book.settings"].opts = opts;
        _modules["read_book.settings"].styles_id = styles_id;
        _modules["read_book.settings"].update_settings = update_settings;
        _modules["read_book.settings"].apply_font_size = apply_font_size;
        _modules["read_book.settings"].default_selection_colors = default_selection_colors;
        _modules["read_book.settings"].make_selection_background_opaque = make_selection_background_opaque;
        _modules["read_book.settings"].apply_colors = apply_colors;
        _modules["read_book.settings"].set_selection_style = set_selection_style;
        _modules["read_book.settings"].set_color_scheme_class = set_color_scheme_class;
        _modules["read_book.settings"].apply_stylesheet = apply_stylesheet;
        _modules["read_book.settings"].apply_settings = apply_settings;
    })();

    (function(){
        var __name__ = "read_book.flow_mode";
        var small_scroll_events, last_change_spine_item_request, DIRECTION, scroll_animator, flick_animator, drag_scroller, anchor_funcs;
        var set_css = _modules.dom.set_css;

        var wrap_range = _modules.range_utils.wrap_range;
        var unwrap = _modules.range_utils.unwrap;

        var cfi_scroll_to = _modules["read_book.cfi"].scroll_to;

        var current_spine_item = _modules["read_book.globals"].current_spine_item;
        var get_boss = _modules["read_book.globals"].get_boss;
        var rtl_page_progression = _modules["read_book.globals"].rtl_page_progression;
        var ltr_page_progression = _modules["read_book.globals"].ltr_page_progression;

        var opts = _modules["read_book.settings"].opts;

        var line_height = _modules["read_book.viewport"].line_height;
        var rem_size = _modules["read_book.viewport"].rem_size;
        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;

        function flow_to_scroll_fraction(frac, on_initial_load) {
            scroll_viewport.scroll_to_in_block_direction(scroll_viewport.document_block_size() * frac);
        };
        if (!flow_to_scroll_fraction.__argnames__) Object.defineProperties(flow_to_scroll_fraction, {
            __argnames__ : {value: ["frac", "on_initial_load"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        small_scroll_events = [];
        function clear_small_scrolls() {
            small_scroll_events = [];
        };
        if (!clear_small_scrolls.__module__) Object.defineProperties(clear_small_scrolls, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function dispatch_small_scrolls() {
            var now, amt, x;
            if (small_scroll_events.length) {
                now = window.performance.now();
                if (now - small_scroll_events[small_scroll_events.length-1].time <= 2e3) {
                    window.setTimeout(dispatch_small_scrolls, 100);
                    return;
                }
                amt = 0;
                var _Iter0 = _Iterable(small_scroll_events);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    x = _Iter0[_Index0];
                    amt += x.amt;
                }
                clear_small_scrolls();
                get_boss().report_human_scroll(amt / scroll_viewport.document_block_size());
            }
        };
        if (!dispatch_small_scrolls.__module__) Object.defineProperties(dispatch_small_scrolls, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function add_small_scroll(amt) {
            small_scroll_events.push((function(){
                var _d = Object.create(null);
                _d["amt"] = amt;
                _d["time"] = window.performance.now();
                return _d;
            }).call(this));
            window.setTimeout(dispatch_small_scrolls, 100);
        };
        if (!add_small_scroll.__argnames__) Object.defineProperties(add_small_scroll, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function report_human_scroll(amt) {
            var h, is_large_scroll;
            h = scroll_viewport.height();
            is_large_scroll = abs(amt) / h >= .5;
            if (amt > 0) {
                if (is_large_scroll) {
                    clear_small_scrolls();
                    get_boss().report_human_scroll(amt / scroll_viewport.document_block_size());
                } else {
                    add_small_scroll(amt);
                }
            } else if (amt === 0 || is_large_scroll) {
                clear_small_scrolls();
            }
        };
        if (!report_human_scroll.__argnames__) Object.defineProperties(report_human_scroll, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        last_change_spine_item_request = Object.create(null);
        function _check_for_scroll_end(func, obj, args, report) {
            var before, should_flip_progression_direction, now, csi, go_to_previous_page;
            before = scroll_viewport.block_pos();
            should_flip_progression_direction = func.apply(obj, args);
            now = window.performance.now();
            scroll_animator.sync(now);
            if (scroll_viewport.block_pos() === before) {
                csi = current_spine_item();
                if (last_change_spine_item_request.name === csi.name && now - last_change_spine_item_request.at < 2e3) {
                    return false;
                }
                last_change_spine_item_request.name = csi.name;
                last_change_spine_item_request.at = now;
                go_to_previous_page = args[0] < 0;
                if (should_flip_progression_direction) {
                    go_to_previous_page = !go_to_previous_page;
                }
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_spine_item"].concat([_desugar_kwargs({previous: go_to_previous_page})])));
                return false;
            }
            if (report) {
                report_human_scroll(scroll_viewport.block_pos() - before);
            }
            return true;
        };
        if (!_check_for_scroll_end.__argnames__) Object.defineProperties(_check_for_scroll_end, {
            __argnames__ : {value: ["func", "obj", "args", "report"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function check_for_scroll_end(func) {
            return (function() {
                var _anonfunc = function () {
                    return _check_for_scroll_end(func, this, arguments, false);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })();
        };
        if (!check_for_scroll_end.__argnames__) Object.defineProperties(check_for_scroll_end, {
            __argnames__ : {value: ["func"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function check_for_scroll_end_and_report(func) {
            return (function() {
                var _anonfunc = function () {
                    return _check_for_scroll_end(func, this, arguments, true);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })();
        };
        if (!check_for_scroll_end_and_report.__argnames__) Object.defineProperties(check_for_scroll_end_and_report, {
            __argnames__ : {value: ["func"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        
        var scroll_by_and_check_next_page = check_for_scroll_end_and_report((function() {
            var _anonfunc = function scroll_by_and_check_next_page(y) {
                scroll_viewport.scroll_by_in_block_direction(y);
                return false;
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["y"]},
                __module__ : {value: "read_book.flow_mode"}
            });
            return _anonfunc;
        })());

        function flow_onwheel(evt) {
            var di, db, WheelEvent, dx;
            di = db = 0;
            WheelEvent = window.WheelEvent;
            if (evt.deltaY) {
                if (evt.deltaMode === WheelEvent.DOM_DELTA_PIXEL) {
                    db = evt.deltaY;
                } else if (evt.deltaMode === WheelEvent.DOM_DELTA_LINE) {
                    db = line_height() * evt.deltaY;
                }
                if (evt.deltaMode === WheelEvent.DOM_DELTA_PAGE) {
                    db = (scroll_viewport.block_size() - 30) * evt.deltaY;
                }
            }
            if (evt.deltaX) {
                if (evt.deltaMode === WheelEvent.DOM_DELTA_PIXEL) {
                    dx = evt.deltaX;
                } else if (evt.deltaMode === WheelEvent.DOM_DELTA_LINE) {
                    dx = line_height() * evt.deltaX;
                } else {
                    dx = (scroll_viewport.block_size() - 30) * evt.deltaX;
                }
                if (scroll_viewport.horizontal_writing_mode) {
                    di = dx;
                } else {
                    if (scroll_viewport.rtl) {
                        db = -dx;
                    } else {
                        db = dx;
                    }
                }
            }
            if (Math.abs(di) >= 1) {
                scroll_viewport.scroll_by_in_inline_direction(di);
            }
            if (Math.abs(db) >= 1) {
                scroll_by_and_check_next_page(db);
            }
        };
        if (!flow_onwheel.__argnames__) Object.defineProperties(flow_onwheel, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        
        var goto_boundary = check_for_scroll_end((function() {
            var _anonfunc = function goto_boundary(dir) {
                var position;
                position = (dir === DIRECTION.Up) ? 0 : scroll_viewport.document_block_size();
                scroll_viewport.scroll_to_in_block_direction(position);
                get_boss().report_human_scroll();
                return false;
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["dir"]},
                __module__ : {value: "read_book.flow_mode"}
            });
            return _anonfunc;
        })());

        
        var scroll_by_page = check_for_scroll_end_and_report((function() {
            var _anonfunc = function scroll_by_page(direction, flip_if_rtl_page_progression) {
                var b;
                b = scroll_viewport.block_size() - 10;
                scroll_viewport.scroll_by_in_block_direction(b * direction);
                return flip_if_rtl_page_progression && rtl_page_progression();
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["direction", "flip_if_rtl_page_progression"]},
                __module__ : {value: "read_book.flow_mode"}
            });
            return _anonfunc;
        })());

        function scroll_to_extend_annotation(backward, horizontal, by_page) {
            var direction, h, before;
            direction = (backward) ? -1 : 1;
            h = line_height();
            if (by_page) {
                h = ((horizontal) ? window.innerWidth : window.innerHeight) - h;
            }
            if (horizontal) {
                before = window.pageXOffset;
                window.scrollBy(h * direction, 0);
                return window.pageXOffset !== before;
            }
            before = window.pageYOffset;
            window.scrollBy(0, h * direction);
            return window.pageYOffset !== before;
        };
        if (!scroll_to_extend_annotation.__argnames__) Object.defineProperties(scroll_to_extend_annotation, {
            __argnames__ : {value: ["backward", "horizontal", "by_page"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function is_auto_scroll_active() {
            return scroll_animator.is_active();
        };
        if (!is_auto_scroll_active.__module__) Object.defineProperties(is_auto_scroll_active, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function start_autoscroll() {
            scroll_animator.start(DIRECTION.Down, true);
        };
        if (!start_autoscroll.__module__) Object.defineProperties(start_autoscroll, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function toggle_autoscroll() {
            var running;
            if (is_auto_scroll_active()) {
                cancel_scroll();
                running = false;
            } else {
                start_autoscroll();
                running = true;
            }
            (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["autoscroll_state_changed"].concat([_desugar_kwargs({running: running})])));
        };
        if (!toggle_autoscroll.__module__) Object.defineProperties(toggle_autoscroll, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function handle_shortcut(sc_name, evt) {
            if (sc_name === "down") {
                scroll_animator.start(DIRECTION.Down, false);
                return true;
            }
            if (sc_name === "up") {
                scroll_animator.start(DIRECTION.Up, false);
                return true;
            }
            if (sc_name === "start_of_file") {
                goto_boundary(DIRECTION.Up);
                return true;
            }
            if (sc_name === "end_of_file") {
                goto_boundary(DIRECTION.Down);
                return true;
            }
            if (sc_name === "left") {
                scroll_by_and_check_next_page((ltr_page_progression()) ? -15 : 15, 0);
                return true;
            }
            if (sc_name === "right") {
                scroll_by_and_check_next_page((ltr_page_progression()) ? 15 : -15, 0);
                return true;
            }
            if (sc_name === "start_of_book") {
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["goto_doc_boundary"].concat([_desugar_kwargs({start: true})])));
                return true;
            }
            if (sc_name === "end_of_book") {
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["goto_doc_boundary"].concat([_desugar_kwargs({start: false})])));
                return true;
            }
            if (sc_name === "pageup") {
                scroll_by_page(-1, false);
                return true;
            }
            if (sc_name === "pagedown") {
                scroll_by_page(1, false);
                return true;
            }
            if (sc_name === "toggle_autoscroll") {
                toggle_autoscroll();
                return true;
            }
            if (sc_name.startsWith("scrollspeed_")) {
                scroll_animator.sync();
            }
            return false;
        };
        if (!handle_shortcut.__argnames__) Object.defineProperties(handle_shortcut, {
            __argnames__ : {value: ["sc_name", "evt"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function layout(is_single_page) {
            var body_style;
            add_visibility_listener();
            line_height(true);
            rem_size(true);
            _interpolate_kwargs.call(this, set_css, [document.body].concat([_desugar_kwargs({margin: "0", border_width: "0", padding: "0"})]));
            body_style = window.getComputedStyle(document.body);
            scroll_viewport.initialize_on_layout(body_style);
            document.documentElement.style.overflow = (scroll_viewport.vertical_writing_mode) ? "visible" : "hidden";
        };
        if (!layout.__argnames__) Object.defineProperties(layout, {
            __argnames__ : {value: ["is_single_page"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function auto_scroll_resume() {
            scroll_animator.wait = false;
            scroll_animator.sync();
        };
        if (!auto_scroll_resume.__module__) Object.defineProperties(auto_scroll_resume, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function add_visibility_listener() {
            if (add_visibility_listener.done) {
                return;
            }
            add_visibility_listener.done = true;
            document.addEventListener("visibilitychange", (function() {
                var _anonfunc = function () {
                    if (document.visibilityState === "visible") {
                        scroll_animator.sync();
                    } else {
                        scroll_animator.pause();
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })());
        };
        if (!add_visibility_listener.__module__) Object.defineProperties(add_visibility_listener, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function cancel_scroll() {
            scroll_animator.stop();
        };
        if (!cancel_scroll.__module__) Object.defineProperties(cancel_scroll, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function is_scroll_end(pos) {
            return !((0 <= pos && pos <= scroll_viewport.document_block_size() - scroll_viewport.block_size()));
        };
        if (!is_scroll_end.__argnames__) Object.defineProperties(is_scroll_end, {
            __argnames__ : {value: ["pos"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        DIRECTION = (function(){
            var _d = Object.create(null);
            _d["Up"] = -1;
            _d["up"] = -1;
            _d["Down"] = 1;
            _d["down"] = 1;
            _d["UP"] = -1;
            _d["DOWN"] = 1;
            return _d;
        }).call(this);
        function ScrollAnimator() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ScrollAnimator.prototype.__bind_methods__.call(this);
            ScrollAnimator.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ScrollAnimator.prototype, "__bind_methods__", {value: function () {
            this.is_running = ScrollAnimator.prototype.is_running.bind(this);
            this.is_active = ScrollAnimator.prototype.is_active.bind(this);
            this.start = ScrollAnimator.prototype.start.bind(this);
            this.smooth_scroll = ScrollAnimator.prototype.smooth_scroll.bind(this);
            this.auto_scroll = ScrollAnimator.prototype.auto_scroll.bind(this);
            this.request_next_spine_item = ScrollAnimator.prototype.request_next_spine_item.bind(this);
            this.report = ScrollAnimator.prototype.report.bind(this);
            this.sync = ScrollAnimator.prototype.sync.bind(this);
            this.stop = ScrollAnimator.prototype.stop.bind(this);
            this.stop_auto_spine_transition = ScrollAnimator.prototype.stop_auto_spine_transition.bind(this);
            this.pause = ScrollAnimator.prototype.pause.bind(this);
            this.resume = ScrollAnimator.prototype.resume.bind(this);
        }});
        ScrollAnimator.prototype.__init__ = function __init__() {
            var self = this;
            self.animation_id = null;
            self.auto = false;
            self.auto_timer = null;
            self.paused = false;
        };
        if (!ScrollAnimator.prototype.__init__.__module__) Object.defineProperties(ScrollAnimator.prototype.__init__, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.__argnames__ = ScrollAnimator.prototype.__init__.__argnames__;
        ScrollAnimator.__handles_kwarg_interpolation__ = ScrollAnimator.prototype.__init__.__handles_kwarg_interpolation__;
        ScrollAnimator.prototype.is_running = function is_running() {
            var self = this;
            return self.animation_id !== null || self.auto_timer !== null;
        };
        if (!ScrollAnimator.prototype.is_running.__module__) Object.defineProperties(ScrollAnimator.prototype.is_running, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.is_active = function is_active() {
            var self = this;
            return self.is_running() && (self.auto || self.auto_timer !== null);
        };
        if (!ScrollAnimator.prototype.is_active.__module__) Object.defineProperties(ScrollAnimator.prototype.is_active, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.start = function start(direction, auto) {
            var self = this;
            var now;
            cancel_drag_scroll();
            if (self.wait) {
                return;
            }
            now = window.performance.now();
            self.end_time = now + self.DURATION;
            self.stop_auto_spine_transition();
            if (!self.is_running() || direction !== self.direction || auto !== self.auto) {
                if (self.auto && !auto) {
                    self.pause();
                }
                self.stop();
                self.auto = auto;
                self.direction = direction;
                self.start_time = now;
                self.start_offset = scroll_viewport.block_pos();
                self.csi_idx = current_spine_item().index;
                self.animation_id = window.requestAnimationFrame((auto) ? self.auto_scroll : self.smooth_scroll);
            }
        };
        if (!ScrollAnimator.prototype.start.__argnames__) Object.defineProperties(ScrollAnimator.prototype.start, {
            __argnames__ : {value: ["direction", "auto"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.smooth_scroll = function smooth_scroll(ts) {
            var self = this;
            var duration, progress, scroll_target, amt;
            duration = self.end_time - self.start_time;
            if (duration <= 0) {
                self.animation_id = null;
                return;
            }
            progress = max(0, min(1, (ts - self.start_time) / duration));
            scroll_target = self.start_offset;
            scroll_target += Math.trunc(self.direction * progress * duration * line_height() * opts.lines_per_sec_smooth) / 1e3;
            scroll_viewport.scroll_to_in_block_direction(scroll_target);
            amt = scroll_viewport.block_pos() - self.start_offset;
            if (is_scroll_end(scroll_target) && (!opts.scroll_stop_boundaries || abs(amt) < 3 && duration === self.DURATION)) {
                self.animation_id = null;
                self.wait = true;
                report_human_scroll(amt);
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_spine_item"].concat([_desugar_kwargs({previous: self.direction === DIRECTION.Up})])));
            } else if (progress < 1) {
                self.animation_id = window.requestAnimationFrame(self.smooth_scroll);
            } else if (self.paused) {
                self.resume();
            } else {
                self.animation_id = null;
                report_human_scroll(amt);
            }
        };
        if (!ScrollAnimator.prototype.smooth_scroll.__argnames__) Object.defineProperties(ScrollAnimator.prototype.smooth_scroll, {
            __argnames__ : {value: ["ts"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.auto_scroll = function auto_scroll(ts) {
            var self = this;
            var elapsed, scroll_target, scroll_finished;
            elapsed = max(0, ts - self.start_time);
            scroll_target = self.start_offset;
            scroll_target += Math.trunc(self.direction * elapsed * line_height() * opts.lines_per_sec_auto) / 1e3;
            scroll_viewport.scroll_to_in_block_direction(scroll_target);
            scroll_finished = is_scroll_end(scroll_target);
            if (elapsed >= 1e3) {
                self.sync(ts);
            }
            if (scroll_finished) {
                self.pause();
                if (opts.scroll_auto_boundary_delay >= 0) {
                    self.auto_timer = setTimeout(self.request_next_spine_item, opts.scroll_auto_boundary_delay * 1e3);
                }
            } else {
                self.animation_id = window.requestAnimationFrame(self.auto_scroll);
            }
        };
        if (!ScrollAnimator.prototype.auto_scroll.__argnames__) Object.defineProperties(ScrollAnimator.prototype.auto_scroll, {
            __argnames__ : {value: ["ts"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.request_next_spine_item = function request_next_spine_item() {
            var self = this;
            self.auto_timer = null;
            (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_spine_item"].concat([_desugar_kwargs({previous: self.direction === DIRECTION.Up})])));
        };
        if (!ScrollAnimator.prototype.request_next_spine_item.__module__) Object.defineProperties(ScrollAnimator.prototype.request_next_spine_item, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.report = function report() {
            var self = this;
            var amt;
            amt = scroll_viewport.block_pos() - self.start_offset;
            if (abs(amt) > 0 && self.csi_idx === current_spine_item().index) {
                report_human_scroll(amt);
            }
        };
        if (!ScrollAnimator.prototype.report.__module__) Object.defineProperties(ScrollAnimator.prototype.report, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.sync = function sync(ts) {
            var self = this;
            if (self.auto) {
                self.report();
                self.csi_idx = current_spine_item().index;
                self.start_time = ts || window.performance.now();
                self.start_offset = scroll_viewport.block_pos();
            } else {
                self.resume();
            }
        };
        if (!ScrollAnimator.prototype.sync.__argnames__) Object.defineProperties(ScrollAnimator.prototype.sync, {
            __argnames__ : {value: ["ts"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.stop = function stop() {
            var self = this;
            self.auto = false;
            if (self.animation_id !== null) {
                window.cancelAnimationFrame(self.animation_id);
                self.animation_id = null;
                self.report();
            }
            self.stop_auto_spine_transition();
        };
        if (!ScrollAnimator.prototype.stop.__module__) Object.defineProperties(ScrollAnimator.prototype.stop, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.stop_auto_spine_transition = function stop_auto_spine_transition() {
            var self = this;
            if (self.auto_timer !== null) {
                clearTimeout(self.auto_timer);
                self.auto_timer = null;
                self.paused = false;
            }
        };
        if (!ScrollAnimator.prototype.stop_auto_spine_transition.__module__) Object.defineProperties(ScrollAnimator.prototype.stop_auto_spine_transition, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.pause = function pause() {
            var self = this;
            if (self.auto) {
                self.paused = self.direction;
                self.stop();
            } else {
                self.paused = false;
            }
        };
        if (!ScrollAnimator.prototype.pause.__module__) Object.defineProperties(ScrollAnimator.prototype.pause, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.resume = function resume() {
            var self = this;
            if (self.paused) {
                self.start(self.paused, true);
                self.paused = false;
            }
        };
        if (!ScrollAnimator.prototype.resume.__module__) Object.defineProperties(ScrollAnimator.prototype.resume, {
            __module__ : {value: "read_book.flow_mode"}
        });
        ScrollAnimator.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ScrollAnimator.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ScrollAnimator.prototype, "__bases__", {value: []});
        ScrollAnimator.prototype.DURATION = 100;

        scroll_animator = new ScrollAnimator;
        function FlickAnimator() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            FlickAnimator.prototype.__bind_methods__.call(this);
            FlickAnimator.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(FlickAnimator.prototype, "__bind_methods__", {value: function () {
            this.cancel_current_drag_scroll = FlickAnimator.prototype.cancel_current_drag_scroll.bind(this);
            this.start = FlickAnimator.prototype.start.bind(this);
            this.auto_scroll = FlickAnimator.prototype.auto_scroll.bind(this);
            this.scroll_y = FlickAnimator.prototype.scroll_y.bind(this);
            this.scroll_x = FlickAnimator.prototype.scroll_x.bind(this);
            this.stop = FlickAnimator.prototype.stop.bind(this);
        }});
        FlickAnimator.prototype.__init__ = function __init__() {
            var self = this;
            self.animation_id = null;
        };
        if (!FlickAnimator.prototype.__init__.__module__) Object.defineProperties(FlickAnimator.prototype.__init__, {
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.__argnames__ = FlickAnimator.prototype.__init__.__argnames__;
        FlickAnimator.__handles_kwarg_interpolation__ = FlickAnimator.prototype.__init__.__handles_kwarg_interpolation__;
        FlickAnimator.prototype.cancel_current_drag_scroll = function cancel_current_drag_scroll() {
            var self = this;
            cancel_drag_scroll();
        };
        if (!FlickAnimator.prototype.cancel_current_drag_scroll.__module__) Object.defineProperties(FlickAnimator.prototype.cancel_current_drag_scroll, {
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.prototype.start = function start(gesture) {
            var self = this;
            var now, points, times, _unpack, i, t, elapsed, delta, velocity;
            self.cancel_current_drag_scroll();
            self.vertical = gesture.axis === "vertical";
            now = window.performance.now();
            points = times = null;
            var _Iter1 = _Iterable(enumerate(gesture.times));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                _unpack = _Iter1[_Index1];
                i = _unpack[0];
                t = _unpack[1];
                if (now - t < self.VELOCITY_HISTORY) {
                    _unpack = [gesture.points.slice(i), gesture.times.slice(i)];
                    points = _unpack[0];
                    times = _unpack[1];
                    break;
                }
            }
            if (times && times.length > 1) {
                elapsed = (times[times.length-1] - times[0]) / 1e3;
                if (elapsed > 0 && points.length > 1) {
                    delta = points[0] - points[points.length-1];
                    velocity = delta / elapsed;
                    if (abs(velocity) > self.MIMUMUM_VELOCITY) {
                        self.amplitude = self.SPEED_FACTOR * velocity;
                        self.start_time = now;
                        self.animation_id = window.requestAnimationFrame(self.auto_scroll);
                    }
                }
            }
        };
        if (!FlickAnimator.prototype.start.__argnames__) Object.defineProperties(FlickAnimator.prototype.start, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.prototype.auto_scroll = function auto_scroll(ts) {
            var self = this;
            var elapsed, delta;
            if (self.animation_id === null) {
                return;
            }
            elapsed = window.performance.now() - self.start_time;
            delta = self.amplitude * Math.exp(-elapsed / self.DECEL_TIME_CONSTANT);
            if (abs(delta) >= 1) {
                delta = Math.round(delta);
                if (self.vertical) {
                    self.scroll_y(delta);
                } else {
                    self.scroll_x(delta);
                }
                self.animation_id = window.requestAnimationFrame(self.auto_scroll);
            }
        };
        if (!FlickAnimator.prototype.auto_scroll.__argnames__) Object.defineProperties(FlickAnimator.prototype.auto_scroll, {
            __argnames__ : {value: ["ts"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.prototype.scroll_y = function scroll_y(delta) {
            var self = this;
            window.scrollBy(0, delta);
        };
        if (!FlickAnimator.prototype.scroll_y.__argnames__) Object.defineProperties(FlickAnimator.prototype.scroll_y, {
            __argnames__ : {value: ["delta"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.prototype.scroll_x = function scroll_x(delta) {
            var self = this;
            window.scrollBy(delta, 0);
        };
        if (!FlickAnimator.prototype.scroll_x.__argnames__) Object.defineProperties(FlickAnimator.prototype.scroll_x, {
            __argnames__ : {value: ["delta"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.prototype.stop = function stop() {
            var self = this;
            if (self.animation_id !== null) {
                window.cancelAnimationFrame(self.animation_id);
                self.animation_id = null;
            }
        };
        if (!FlickAnimator.prototype.stop.__module__) Object.defineProperties(FlickAnimator.prototype.stop, {
            __module__ : {value: "read_book.flow_mode"}
        });
        FlickAnimator.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        FlickAnimator.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(FlickAnimator.prototype, "__bases__", {value: []});
        FlickAnimator.prototype.SPEED_FACTOR = .04;
        FlickAnimator.prototype.DECEL_TIME_CONSTANT = 325;
        FlickAnimator.prototype.VELOCITY_HISTORY = 300;
        FlickAnimator.prototype.MIMUMUM_VELOCITY = 100;

        flick_animator = new FlickAnimator;
        function DragScroller() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            DragScroller.prototype.__bind_methods__.call(this);
            DragScroller.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(DragScroller.prototype, "__bind_methods__", {value: function () {
            this.is_running = DragScroller.prototype.is_running.bind(this);
            this.smooth_scroll = DragScroller.prototype.smooth_scroll.bind(this);
            this.start = DragScroller.prototype.start.bind(this);
            this.stop = DragScroller.prototype.stop.bind(this);
        }});
        DragScroller.prototype.__init__ = function __init__() {
            var self = this;
            self.animation_id = null;
            self.direction = 1;
            self.speed_factor = 1;
            self.start_time = self.end_time = 0;
            self.start_offset = 0;
        };
        if (!DragScroller.prototype.__init__.__module__) Object.defineProperties(DragScroller.prototype.__init__, {
            __module__ : {value: "read_book.flow_mode"}
        });
        DragScroller.__argnames__ = DragScroller.prototype.__init__.__argnames__;
        DragScroller.__handles_kwarg_interpolation__ = DragScroller.prototype.__init__.__handles_kwarg_interpolation__;
        DragScroller.prototype.is_running = function is_running() {
            var self = this;
            return self.animation_id !== null;
        };
        if (!DragScroller.prototype.is_running.__module__) Object.defineProperties(DragScroller.prototype.is_running, {
            __module__ : {value: "read_book.flow_mode"}
        });
        DragScroller.prototype.smooth_scroll = function smooth_scroll(ts) {
            var self = this;
            var duration, progress, scroll_target;
            duration = self.end_time - self.start_time;
            if (duration <= 0) {
                self.animation_id = null;
                self.start(self.direction, self.speed_factor);
                return;
            }
            progress = max(0, min(1, (ts - self.start_time) / duration));
            scroll_target = self.start_offset;
            scroll_target += Math.trunc(self.direction * progress * duration * line_height() * opts.lines_per_sec_smooth * self.speed_factor) / 1e3;
            scroll_viewport.scroll_to_in_block_direction(scroll_target);
            if (progress < 1) {
                self.animation_id = window.requestAnimationFrame(self.smooth_scroll);
            } else {
                self.animation_id = null;
                self.start(self.direction, self.speed_factor);
            }
        };
        if (!DragScroller.prototype.smooth_scroll.__argnames__) Object.defineProperties(DragScroller.prototype.smooth_scroll, {
            __argnames__ : {value: ["ts"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        DragScroller.prototype.start = function start(direction, speed_factor) {
            var self = this;
            var now;
            now = window.performance.now();
            self.end_time = now + self.DURATION;
            if (!self.is_running() || direction !== self.direction || speed_factor !== self.speed_factor) {
                self.stop();
                self.direction = direction;
                self.speed_factor = speed_factor;
                self.start_time = now;
                self.start_offset = scroll_viewport.block_pos();
                self.animation_id = window.requestAnimationFrame(self.smooth_scroll);
            }
        };
        if (!DragScroller.prototype.start.__argnames__) Object.defineProperties(DragScroller.prototype.start, {
            __argnames__ : {value: ["direction", "speed_factor"]},
            __module__ : {value: "read_book.flow_mode"}
        });
        DragScroller.prototype.stop = function stop() {
            var self = this;
            if (self.animation_id !== null) {
                window.cancelAnimationFrame(self.animation_id);
                self.animation_id = null;
            }
        };
        if (!DragScroller.prototype.stop.__module__) Object.defineProperties(DragScroller.prototype.stop, {
            __module__ : {value: "read_book.flow_mode"}
        });
        DragScroller.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        DragScroller.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(DragScroller.prototype, "__bases__", {value: []});
        DragScroller.prototype.DURATION = 100;

        drag_scroller = new DragScroller;
        function cancel_drag_scroll() {
            drag_scroller.stop();
        };
        if (!cancel_drag_scroll.__module__) Object.defineProperties(cancel_drag_scroll, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function start_drag_scroll(delta) {
            var limit, direction, speed_factor;
            limit = (delta < 0) ? opts.margin_top : opts.margin_bottom;
            direction = (delta >= 0) ? 1 : -1;
            speed_factor = min(abs(delta), limit) / limit;
            speed_factor *= 2 - speed_factor;
            drag_scroller.start(direction, 2 * speed_factor);
        };
        if (!start_drag_scroll.__argnames__) Object.defineProperties(start_drag_scroll, {
            __argnames__ : {value: ["delta"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function handle_gesture(gesture) {
            var delta;
            flick_animator.stop();
            if (gesture.resolved_action === "animated_scroll") {
                flick_animator.start(gesture);
            } else if (gesture.resolved_action === "pan") {
                if (gesture.points.length > 1 && !gesture.is_held) {
                    delta = (_expr_temp = gesture.points)[_expr_temp.length-2] - (_expr_temp = gesture.points)[_expr_temp.length-1];
                    if (Math.abs(delta) >= 1) {
                        if (gesture.axis === "vertical") {
                            if (scroll_viewport.vertical_writing_mode) {
                                scroll_viewport.scroll_by(delta, 0);
                            } else {
                                scroll_by_and_check_next_page(delta);
                            }
                        } else {
                            if (scroll_viewport.vertical_writing_mode) {
                                scroll_by_and_check_next_page(delta);
                            } else {
                                scroll_viewport.scroll_by(delta, 0);
                            }
                        }
                    }
                }
            } else if (gesture.resolved_action === "prev_page" || gesture.resolved_action === "prev_screen") {
                scroll_by_page(-1, false);
            } else if (gesture.resolved_action === "next_page" || gesture.resolved_action === "next_screen") {
                scroll_by_page(1, false);
            }
        };
        if (!handle_gesture.__argnames__) Object.defineProperties(handle_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        anchor_funcs = (function(){
            var _d = Object.create(null);
            _d["pos_for_elem"] = (function() {
                var _anonfunc = function pos_for_elem(elem) {
                    var br;
                    if (!elem) {
                        return (function(){
                            var _d = Object.create(null);
                            _d["block"] = 0;
                            _d["inline"] = 0;
                            return _d;
                        }).call(this);
                    }
                    br = elem.getBoundingClientRect();
                    return (function(){
                        var _d = Object.create(null);
                        _d["block"] = scroll_viewport.viewport_to_document_block(scroll_viewport.rect_block_start(br), elem.ownerDocument);
                        _d["inline"] = scroll_viewport.viewport_to_document_inline(scroll_viewport.rect_inline_start(br), elem.ownerDocument);
                        return _d;
                    }).call(this);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["elem"]},
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })();
            _d["visibility"] = (function() {
                var _anonfunc = function visibility(pos) {
                    var q;
                    q = pos.block;
                    if (scroll_viewport.vertical_writing_mode && scroll_viewport.rtl) {
                        q = -q;
                    }
                    if (q + 1 < scroll_viewport.block_pos()) {
                        return -1;
                    }
                    if (q <= scroll_viewport.block_pos() + scroll_viewport.block_size()) {
                        return 0;
                    }
                    return 1;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["pos"]},
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })();
            _d["cmp"] = (function() {
                var _anonfunc = function cmp(a, b) {
                    return a.block - b.block || a.inline - b.inline;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })();
            _d["get_bounding_client_rect"] = (function() {
                var _anonfunc = function (elem) {
                    return elem.getBoundingClientRect();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["elem"]},
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })();
            return _d;
        }).call(this);
        function auto_scroll_action(action) {
            if (action === "toggle") {
                toggle_autoscroll();
            } else if (action === "start") {
                if (!is_auto_scroll_active()) {
                    toggle_autoscroll();
                }
            } else if (action === "stop") {
                if (is_auto_scroll_active()) {
                    toggle_autoscroll();
                }
            } else if (action === "resume") {
                auto_scroll_resume();
            }
            return is_auto_scroll_active();
        };
        if (!auto_scroll_action.__argnames__) Object.defineProperties(auto_scroll_action, {
            __argnames__ : {value: ["action"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function closest_preceding_element(p) {
            while (p && !p.scrollIntoView) {
                p = p.previousSibling || p.parentNode;
            }
            return p;
        };
        if (!closest_preceding_element.__argnames__) Object.defineProperties(closest_preceding_element, {
            __argnames__ : {value: ["p"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function ensure_selection_visible() {
            var s, p, r, rect, wrapper;
            s = window.getSelection();
            p = s.anchorNode;
            if (!p) {
                return;
            }
            p = closest_preceding_element(p);
            if ((typeof p !== "undefined" && p !== null ? p : Object.create(null)).scrollIntoView) {
                p.scrollIntoView();
            }
            r = s.getRangeAt(0);
            if (!r) {
                return;
            }
            rect = r.getBoundingClientRect();
            if (!rect) {
                return;
            }
            if (rect.top < 0 || rect.top >= window.innerHeight || rect.left < 0 || rect.left >= window.innerWidth) {
                wrapper = document.createElement("span");
                wrap_range(r, wrapper);
                wrapper.scrollIntoView();
                unwrap(wrapper);
            }
        };
        if (!ensure_selection_visible.__module__) Object.defineProperties(ensure_selection_visible, {
            __module__ : {value: "read_book.flow_mode"}
        });

        function ensure_selection_boundary_visible(use_end) {
            var sel, rr, r, node, x, y;
            sel = window.getSelection();
            try {
                rr = sel.getRangeAt(0);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    rr = null;
                } 
            }
            if (rr) {
                r = rr.getBoundingClientRect();
                if (r) {
                    node = (use_end) ? sel.focusNode : sel.anchorNode;
                    x = (use_end) ? scroll_viewport.rect_inline_end(r) : scroll_viewport.rect_inline_start(r);
                    if (x < 0 || x >= window.innerWidth) {
                        x = _interpolate_kwargs.call(scroll_viewport, scroll_viewport.viewport_to_document_inline, [x].concat([_desugar_kwargs({doc: node.ownerDocument})]));
                        if (use_end) {
                            x -= line_height();
                        }
                        scroll_viewport.scroll_to_in_inline_direction(x, true);
                    }
                    y = (use_end) ? scroll_viewport.rect_block_end(r) : scroll_viewport.rect_block_start(r);
                    if (y < 0 || y >= window.innerHeight) {
                        y = _interpolate_kwargs.call(scroll_viewport, scroll_viewport.viewport_to_document_block, [y].concat([_desugar_kwargs({doc: node.ownerDocument})]));
                        if (use_end) {
                            y -= line_height();
                        }
                        scroll_viewport.scroll_to_in_block_direction(y, true);
                    }
                }
            }
        };
        if (!ensure_selection_boundary_visible.__argnames__) Object.defineProperties(ensure_selection_boundary_visible, {
            __argnames__ : {value: ["use_end"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        function jump_to_cfi(cfi) {
            cfi_scroll_to(cfi, (function() {
                var _anonfunc = function (x, y) {
                    if (scroll_viewport.horizontal_writing_mode) {
                        scroll_viewport.scroll_to_in_block_direction(y);
                    } else {
                        scroll_viewport.scroll_to_in_block_direction(x);
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x", "y"]},
                    __module__ : {value: "read_book.flow_mode"}
                });
                return _anonfunc;
            })());
        };
        if (!jump_to_cfi.__argnames__) Object.defineProperties(jump_to_cfi, {
            __argnames__ : {value: ["cfi"]},
            __module__ : {value: "read_book.flow_mode"}
        });

        _modules["read_book.flow_mode"].small_scroll_events = small_scroll_events;
        _modules["read_book.flow_mode"].last_change_spine_item_request = last_change_spine_item_request;
        _modules["read_book.flow_mode"].DIRECTION = DIRECTION;
        _modules["read_book.flow_mode"].scroll_animator = scroll_animator;
        _modules["read_book.flow_mode"].flick_animator = flick_animator;
        _modules["read_book.flow_mode"].drag_scroller = drag_scroller;
        _modules["read_book.flow_mode"].anchor_funcs = anchor_funcs;
        _modules["read_book.flow_mode"].flow_to_scroll_fraction = flow_to_scroll_fraction;
        _modules["read_book.flow_mode"].clear_small_scrolls = clear_small_scrolls;
        _modules["read_book.flow_mode"].dispatch_small_scrolls = dispatch_small_scrolls;
        _modules["read_book.flow_mode"].add_small_scroll = add_small_scroll;
        _modules["read_book.flow_mode"].report_human_scroll = report_human_scroll;
        _modules["read_book.flow_mode"]._check_for_scroll_end = _check_for_scroll_end;
        _modules["read_book.flow_mode"].check_for_scroll_end = check_for_scroll_end;
        _modules["read_book.flow_mode"].check_for_scroll_end_and_report = check_for_scroll_end_and_report;
        _modules["read_book.flow_mode"].scroll_by_and_check_next_page = scroll_by_and_check_next_page;
        _modules["read_book.flow_mode"].flow_onwheel = flow_onwheel;
        _modules["read_book.flow_mode"].goto_boundary = goto_boundary;
        _modules["read_book.flow_mode"].scroll_by_page = scroll_by_page;
        _modules["read_book.flow_mode"].scroll_to_extend_annotation = scroll_to_extend_annotation;
        _modules["read_book.flow_mode"].is_auto_scroll_active = is_auto_scroll_active;
        _modules["read_book.flow_mode"].start_autoscroll = start_autoscroll;
        _modules["read_book.flow_mode"].toggle_autoscroll = toggle_autoscroll;
        _modules["read_book.flow_mode"].handle_shortcut = handle_shortcut;
        _modules["read_book.flow_mode"].layout = layout;
        _modules["read_book.flow_mode"].auto_scroll_resume = auto_scroll_resume;
        _modules["read_book.flow_mode"].add_visibility_listener = add_visibility_listener;
        _modules["read_book.flow_mode"].cancel_scroll = cancel_scroll;
        _modules["read_book.flow_mode"].is_scroll_end = is_scroll_end;
        _modules["read_book.flow_mode"].ScrollAnimator = ScrollAnimator;
        _modules["read_book.flow_mode"].FlickAnimator = FlickAnimator;
        _modules["read_book.flow_mode"].DragScroller = DragScroller;
        _modules["read_book.flow_mode"].cancel_drag_scroll = cancel_drag_scroll;
        _modules["read_book.flow_mode"].start_drag_scroll = start_drag_scroll;
        _modules["read_book.flow_mode"].handle_gesture = handle_gesture;
        _modules["read_book.flow_mode"].auto_scroll_action = auto_scroll_action;
        _modules["read_book.flow_mode"].closest_preceding_element = closest_preceding_element;
        _modules["read_book.flow_mode"].ensure_selection_visible = ensure_selection_visible;
        _modules["read_book.flow_mode"].ensure_selection_boundary_visible = ensure_selection_boundary_visible;
        _modules["read_book.flow_mode"].jump_to_cfi = jump_to_cfi;
    })();

    (function(){
        var __name__ = "read_book.resources";
        var JSON_XHTML_MIMETYPE, mathjax_data, js_types, k, resource_tag_names, ns_rmap, ns_count, hide_tooltips;
        var E = _modules.elementmaker.E;

        var base64decode = _modules.encodings.base64decode;
        var utf8_decode = _modules.encodings.utf8_decode;

        var clear = _modules.dom.clear;
        var remove_all_attributes = _modules.dom.remove_all_attributes;

        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var opts = _modules["read_book.settings"].opts;

        JSON_XHTML_MIMETYPE = "application/calibre+xhtml+json";
        function decode_component(x) {
            return utf8_decode(base64decode(x));
        };
        if (!decode_component.__argnames__) Object.defineProperties(decode_component, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "read_book.resources"}
        });

        function decode_url(x) {
            var parts;
            parts = x.split("#", 1);
            return [decode_component(parts[0]), parts[1] || ""];
        };
        if (!decode_url.__argnames__) Object.defineProperties(decode_url, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "read_book.resources"}
        });

        function create_link_pat(book) {
            return new RegExp(book.manifest.link_uid + "\\|([^|]+)\\|", "g");
        };
        if (!create_link_pat.__argnames__) Object.defineProperties(create_link_pat, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.resources"}
        });

        function load_resources(book, root_name, previous_resources, proceed) {
            var ans, pending_resources, link_pat;
            ans = Object.create(null);
            pending_resources = [root_name];
            link_pat = create_link_pat(book);
            function do_one() {
                var name, k, data;
                name = pending_resources.shift();
                if (!name) {
                    var _Iter0 = _Iterable(previous_resources);
                    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                        k = _Iter0[_Index0];
                        delete previous_resources[k];
                    }
                    if ((_expr_temp = book.manifest.files)[(typeof root_name === "number" && root_name < 0) ? _expr_temp.length + root_name : root_name].has_maths) {
                        return load_mathjax(book, ans, proceed);
                    }
                    return proceed(ans);
                }
                if (ans[(typeof name === "number" && name < 0) ? ans.length + name : name]) {
                    return setTimeout(do_one, 0);
                }
                if (previous_resources[(typeof name === "number" && name < 0) ? previous_resources.length + name : name]) {
                    ans[(typeof name === "number" && name < 0) ? ans.length + name : name] = data = previous_resources[(typeof name === "number" && name < 0) ? previous_resources.length + name : name];
                    if (typeof data[0] === "string") {
                        find_virtualized_resources(data[0]);
                    }
                    return setTimeout(do_one, 0);
                }
                ui_operations.get_file(book, name, got_one);
            };
            if (!do_one.__module__) Object.defineProperties(do_one, {
                __module__ : {value: "read_book.resources"}
            });

            function got_one(data, name, mimetype) {
                ans[(typeof name === "number" && name < 0) ? ans.length + name : name] = [data, mimetype];
                if (typeof data === "string" && _exists.d((_expr_temp = book.manifest.files)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]).is_virtualized) {
                    find_virtualized_resources(data);
                }
                return setTimeout(do_one, 0);
            };
            if (!got_one.__argnames__) Object.defineProperties(got_one, {
                __argnames__ : {value: ["data", "name", "mimetype"]},
                __module__ : {value: "read_book.resources"}
            });

            function find_virtualized_resources(text) {
                var seen, already_pending, x, m, name;
                seen = set();
                already_pending = (function() {
                    var _Iter = _Iterable(pending_resources), _Result = _set(), x;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        x = _Iter[_Index];
                        _Result.add(x.name);
                    }
                    return _Result;
                })();
                link_pat.lastIndex = 0;
                while (true) {
                    m = link_pat.exec(text);
                    if (!m) {
                        break;
                    }
                    name = decode_url(m[1])[0];
                    if (_in(name, seen) || _in(name, already_pending)) {
                        continue;
                    }
                    seen.add(name);
                    pending_resources.push(name);
                }
            };
            if (!find_virtualized_resources.__argnames__) Object.defineProperties(find_virtualized_resources, {
                __argnames__ : {value: ["text"]},
                __module__ : {value: "read_book.resources"}
            });

            do_one();
        };
        if (!load_resources.__argnames__) Object.defineProperties(load_resources, {
            __argnames__ : {value: ["book", "root_name", "previous_resources", "proceed"]},
            __module__ : {value: "read_book.resources"}
        });

        mathjax_data = null;
        function load_mathjax(book, resource_data, proceed) {
            if (mathjax_data === null) {
                ui_operations.get_mathjax_files((function() {
                    var _anonfunc = function (data) {
                        mathjax_data = data;
                        resource_data["..mathjax-files.."] = data;
                        proceed(resource_data);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["data"]},
                        __module__ : {value: "read_book.resources"}
                    });
                    return _anonfunc;
                })());
            } else {
                resource_data["..mathjax-files.."] = mathjax_data;
                proceed(resource_data);
            }
        };
        if (!load_mathjax.__argnames__) Object.defineProperties(load_mathjax, {
            __argnames__ : {value: ["book", "resource_data", "proceed"]},
            __module__ : {value: "read_book.resources"}
        });

        function finalize_resources(book, root_name, resource_data) {
            var blob_url_map, root_data, link_pat, mathjax, _unpack, data, mimetype, name, unresolved_deps_map, resolved, num, text, unresolved_deps, unresolved;
            blob_url_map = Object.create(null);
            root_data = null;
            link_pat = create_link_pat(book);
            mathjax = resource_data["..mathjax-files.."];
            delete resource_data["..mathjax-files.."];
            var _Iter1 = _Iterable(resource_data);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                name = _Iter1[_Index1];
                _unpack = resource_data[(typeof name === "number" && name < 0) ? resource_data.length + name : name];
_unpack = _unpack_asarray(2, _unpack);
                data = _unpack[0];
                mimetype = _unpack[1];
                if (typeof data !== "string") {
                    blob_url_map[(typeof name === "number" && name < 0) ? blob_url_map.length + name : name] = window.URL.createObjectURL(data);
                }
            }
            var _Iter2 = _Iterable(blob_url_map);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                name = _Iter2[_Index2];
                delete resource_data[name];
            }
            function add_virtualized_resource(name, text, mimetype) {
                if (name === root_name) {
                    root_data = JSON.parse(text);
                } else {
                    blob_url_map[(typeof name === "number" && name < 0) ? blob_url_map.length + name : name] = window.URL.createObjectURL(new Blob(_list_decorate([ text ]), (function(){
                        var _d = Object.create(null);
                        _d["type"] = mimetype;
                        return _d;
                    }).call(this)));
                }
            };
            if (!add_virtualized_resource.__argnames__) Object.defineProperties(add_virtualized_resource, {
                __argnames__ : {value: ["name", "text", "mimetype"]},
                __module__ : {value: "read_book.resources"}
            });

            function replace_deps(text) {
                var replacements, unresolved_deps, m, _unpack, dname, frag, rtext, index, sz, repl;
                replacements = [];
                unresolved_deps = set();
                link_pat.lastIndex = 0;
                while (true) {
                    m = link_pat.exec(text);
                    if (!m) {
                        break;
                    }
                    _unpack = decode_url(m[1]);
_unpack = _unpack_asarray(2, _unpack);
                    dname = _unpack[0];
                    frag = _unpack[1];
                    if (blob_url_map[(typeof dname === "number" && dname < 0) ? blob_url_map.length + dname : dname]) {
                        rtext = blob_url_map[(typeof dname === "number" && dname < 0) ? blob_url_map.length + dname : dname];
                        if (frag) {
                            rtext += "#" + frag;
                        }
                        replacements.push([m.index, m[0].length, rtext]);
                    } else {
                        unresolved_deps.add(dname);
                    }
                }
                var _Iter3 = _Iterable(reversed(replacements));
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    _unpack = _flatten(_Iter3[_Index3]);
                    index = _unpack[0];
                    sz = _unpack[1];
                    repl = _unpack[2];
                    text = text.slice(0, index) + repl + text.slice(index + sz);
                }
                return [unresolved_deps, text];
            };
            if (!replace_deps.__argnames__) Object.defineProperties(replace_deps, {
                __argnames__ : {value: ["text"]},
                __module__ : {value: "read_book.resources"}
            });

            unresolved_deps_map = Object.create(null);
            function has_unresolvable_deps(name) {
                var deps, x;
                deps = unresolved_deps_map[(typeof name === "number" && name < 0) ? unresolved_deps_map.length + name : name];
                if (!deps || !deps.length) {
                    return false;
                }
                var _Iter4 = _Iterable(deps);
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    x = _Iter4[_Index4];
                    if (!blob_url_map[(typeof x === "number" && x < 0) ? blob_url_map.length + x : x]) {
                        return true;
                    }
                }
                return false;
            };
            if (!has_unresolvable_deps.__argnames__) Object.defineProperties(has_unresolvable_deps, {
                __argnames__ : {value: ["name"]},
                __module__ : {value: "read_book.resources"}
            });

            while (true) {
                resolved = [];
                num = 0;
                var _Iter5 = _Iterable(resource_data);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    name = _Iter5[_Index5];
                    if (!blob_url_map[(typeof name === "number" && name < 0) ? blob_url_map.length + name : name]) {
                        num += 1;
                        _unpack = resource_data[(typeof name === "number" && name < 0) ? resource_data.length + name : name];
_unpack = _unpack_asarray(2, _unpack);
                        text = _unpack[0];
                        mimetype = _unpack[1];
                        if (!has_unresolvable_deps(name)) {
                            _unpack = replace_deps(text);
_unpack = _unpack_asarray(2, _unpack);
                            unresolved_deps = _unpack[0];
                            text = _unpack[1];
                            unresolved_deps_map[(typeof name === "number" && name < 0) ? unresolved_deps_map.length + name : name] = unresolved_deps;
                            if (!unresolved_deps.length) {
                                add_virtualized_resource(name, text, mimetype);
                                resolved.push(name);
                            }
                        }
                    }
                }
                if (!num) {
                    break;
                }
                if (!resolved.length) {
                    unresolved = (function() {
                        var _Iter = _Iterable(resource_data), _Result = [], name;
                        for (var _Index = 0; _Index < _Iter.length; _Index++) {
                            name = _Iter[_Index];
                            if (!blob_url_map[(typeof name === "number" && name < 0) ? blob_url_map.length + name : name]) {
                                _Result.push(name);
                            }
                        }
                        _Result = _list_constructor(_Result);
                        return _Result;
                    })();
                    print("ERROR: Could not resolve all dependencies of {} because of a cyclic dependency. Remaining deps: {}".format(root_name, unresolved));
                    var _Iter6 = _Iterable(resource_data);
                    for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                        name = _Iter6[_Index6];
                        if (!blob_url_map[(typeof name === "number" && name < 0) ? blob_url_map.length + name : name]) {
                            _unpack = resource_data[(typeof name === "number" && name < 0) ? resource_data.length + name : name];
_unpack = _unpack_asarray(2, _unpack);
                            text = _unpack[0];
                            mimetype = _unpack[1];
                            text = replace_deps(text)[1];
                            add_virtualized_resource(name, text, mimetype);
                        }
                    }
                    break;
                }
                var _Iter7 = _Iterable(resolved);
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    name = _Iter7[_Index7];
                    delete resource_data[name];
                }
            }
            return [root_data, mathjax, blob_url_map];
        };
        if (!finalize_resources.__argnames__) Object.defineProperties(finalize_resources, {
            __argnames__ : {value: ["book", "root_name", "resource_data"]},
            __module__ : {value: "read_book.resources"}
        });

        js_types = (function() {
            var _Iter = _Iterable("text/javascript text/ecmascript application/javascript application/ecmascript".split(" ")), _Result = Object.create(null), k;
            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                k = _Iter[_Index];
                _Result[k] = (true);
            }
            return _Result;
        })();
        resource_tag_names = (function(){
            var _d = Object.create(null);
            _d["script"] = "src";
            _d["link"] = "href";
            _d["img"] = "src";
            _d["image"] = "xlink:href";
            return _d;
        }).call(this);
        ns_rmap = (function(){
            var _d = Object.create(null);
            _d["http://www.w3.org/2000/svg"] = "svg";
            _d["http://www.w3.org/1999/xlink"] = "xlink";
            _d["http://www.w3.org/1998/Math/MathML"] = "math";
            _d["http://www.w3.org/XML/1998/namespace"] = "xml";
            _d["http://www.idpf.org/2007/ops"] = "epub";
            return _d;
        }).call(this);
        ns_count = 0;
        hide_tooltips = false;
        function get_prefix(ns) {
            var ans;
            ans = ns_rmap[(typeof ns === "number" && ns < 0) ? ns_rmap.length + ns : ns];
            if (!ans) {
                ns_rmap[(typeof ns === "number" && ns < 0) ? ns_rmap.length + ns : ns] = ans = "ns" + ns_count;
                ns_count += 1;
            }
            return ans + ":";
        };
        if (!get_prefix.__argnames__) Object.defineProperties(get_prefix, {
            __argnames__ : {value: ["ns"]},
            __module__ : {value: "read_book.resources"}
        });

        function apply_attributes(src, elem, ns_map) {
            var attributes, ns, name, a;
            attributes = src.a;
            if (!attributes) {
                return;
            }
            var _Iter8 = _Iterable(attributes);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                a = _Iter8[_Index8];
                if (a[2]) {
                    ns = ns_map[_bound_index(a[2], ns_map)];
                    elem.setAttributeNS(ns, get_prefix(ns) + a[0], a[1]);
                } else {
                    name = a[0];
                    if (hide_tooltips && (name === "title" || name === "alt")) {
                        continue;
                    }
                    elem.setAttribute(name, a[1]);
                }
            }
        };
        if (!apply_attributes.__argnames__) Object.defineProperties(apply_attributes, {
            __argnames__ : {value: ["src", "elem", "ns_map"]},
            __module__ : {value: "read_book.resources"}
        });

        function is_loadable_link(attributes) {
            var x, a;
            var _Iter9 = _Iterable(attributes);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                a = _Iter9[_Index9];
                if (a[0].toLowerCase() === "rel" && a[1]) {
                    var _Iter10 = _Iterable(a[1].split(" "));
                    for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                        x = _Iter10[_Index10];
                        if (x.toLowerCase() === "stylesheet") {
                            return true;
                        }
                    }
                }
            }
            return false;
        };
        if (!is_loadable_link.__argnames__) Object.defineProperties(is_loadable_link, {
            __argnames__ : {value: ["attributes"]},
            __module__ : {value: "read_book.resources"}
        });

        function process_stack(stack, tag_map, ns_map, load_required, onload) {
            var _unpack, node, parent, tag_id, src, elem, loadable, attr, a, load_callback;
            while (stack.length) {
                _unpack = stack.pop();
_unpack = _unpack_asarray(2, _unpack);
                node = _unpack[0];
                parent = _unpack[1];
                if (tag_map) {
                    tag_id = node[0];
                    src = tag_map[(typeof tag_id === "number" && tag_id < 0) ? tag_map.length + tag_id : tag_id];
                } else {
                    src = node;
                    tag_id = process_stack.tag_id++;
                }
                if (src.s) {
                    if (src.n) {
                        elem = document.createElementNS(ns_map[_bound_index(src.s, ns_map)], src.n);
                    } else {
                        if (src.l) {
                            parent.appendChild(document.createTextNode(src.l));
                        }
                        continue;
                    }
                } else {
                    elem = document.createElement(src.n);
                }
                loadable = false;
                attr = resource_tag_names[_bound_index(src.n, resource_tag_names)];
                if (attr) {
                    if (_not_equals(attr.indexOf(":"), -1)) {
                        attr = attr.replace("xlink:", "");
                    }
                    if (src.a) {
                        var _Iter11 = _Iterable(src.a);
                        for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                            a = _Iter11[_Index11];
                            if (a[0] === attr) {
                                loadable = (src.n === "link") ? is_loadable_link(src.a) : true;
                                break;
                            }
                        }
                    }
                }
                if (loadable) {
                    load_required.add(tag_id);
                    load_callback = onload.bind(tag_id);
                    elem.addEventListener("load", load_callback);
                    elem.addEventListener("error", load_callback);
                }
                apply_attributes(src, elem, ns_map);
                parent.appendChild(elem);
                if (src.x) {
                    if (src.n === "script" && js_types[_bound_index((elem.getAttribute("type") || "text/javascript").toLowerCase(), js_types)] === true) {
                        elem.text = src.x;
                    } else {
                        elem.appendChild(document.createTextNode(src.x));
                    }
                }
                if (src.l) {
                    parent.appendChild(document.createTextNode(src.l));
                }
                if (tag_map) {
                    for (var i = node.length - 1; i >= 1; i--) {
                        stack.push([node[i], elem]);
                    }
                } else if (node.c) {
                    for (var i = node.c.length; i-- > 0;) {
                        stack.push([node.c[i], elem]);
                    }
                }
            }
        };
        if (!process_stack.__argnames__) Object.defineProperties(process_stack, {
            __argnames__ : {value: ["stack", "tag_map", "ns_map", "load_required", "onload"]},
            __module__ : {value: "read_book.resources"}
        });

        function unserialize_html(serialized_data, proceed, postprocess_dom, root_name) {
            var html, ns_map, base, load_required, proceeded, hang_timeout, body_done, child, ev;
            hide_tooltips = opts.hide_tooltips;
            if (serialized_data.tag_map) {
                return unserialize_html_legacy(serialized_data, proceed, postprocess_dom, root_name);
            }
            html = serialized_data.tree;
            ns_map = serialized_data.ns_map;
            remove_all_attributes(document.documentElement, document.head, document.body);
            clear(document.head, document.body);
            apply_attributes(html, document.documentElement, ns_map);
            document.head.appendChild(_interpolate_kwargs.call(E, E.style, ["html::-webkit-scrollbar, body::-webkit-scrollbar { display: none !important }"].concat([_desugar_kwargs({type: "text/css"})])));
            if (runtime.is_standalone_viewer && root_name) {
                if (root_name.indexOf("/") > -1) {
                    base = window.location.pathname.rpartition("/")[0];
                    base = "" + _str.format("{}", window.location.protocol) + "//" + _str.format("{}", window.location.hostname) + "" + _str.format("{}", base) + "/" + root_name;
                    document.head.appendChild(_interpolate_kwargs.call(E, E.base, [_desugar_kwargs({href: base})]));
                }
            }
            if (!runtime.is_standalone_viewer) {
                document.head.appendChild(_interpolate_kwargs.call(E, E.style, ["html {{ font-family: {} }}".format(window.default_font_family || "sans-serif")].concat([_desugar_kwargs({type: "text/css"})])));
            }
            load_required = set();
            proceeded = false;
            hang_timeout = 5;
            function hangcheck() {
                if (!proceeded) {
                    proceeded = true;
                    print("WARNING: All resources did not load in " + _str.format("{}", hang_timeout) + " seconds, proceeding anyway (" + _str.format("{}", load_required.length) + " resources left)");
                    proceed();
                }
            };
            if (!hangcheck.__module__) Object.defineProperties(hangcheck, {
                __module__ : {value: "read_book.resources"}
            });

            function onload() {
                load_required.discard(this);
                if (!load_required.length && !proceeded) {
                    proceeded = true;
                    proceed();
                }
            };
            if (!onload.__module__) Object.defineProperties(onload, {
                __module__ : {value: "read_book.resources"}
            });

            function process_children(node, parent) {
                var stack, child;
                if (!node.c) {
                    return;
                }
                stack = [];
                for (var i = node.c.length; i-- > 0;) {
                    child = node.c[i];
                    if (child.n !== "meta" && child.n !== "base") {
                        stack.push([child, parent]);
                    }
                }
                process_stack(stack, null, ns_map, load_required, onload);
            };
            if (!process_children.__argnames__) Object.defineProperties(process_children, {
                __argnames__ : {value: ["node", "parent"]},
                __module__ : {value: "read_book.resources"}
            });

            body_done = false;
            process_stack.tag_id = 1;
            var _Iter12 = _Iterable(html.c);
            for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                child = _Iter12[_Index12];
                if (child.n === "head") {
                    process_children(child, document.head);
                } else if (child.n === "body") {
                    if (!document.body) {
                        document.documentElement.appendChild(document.createElement("body"));
                    }
                    if (!body_done) {
                        body_done = true;
                        apply_attributes(child, document.body, ns_map);
                    }
                    if (child.x) {
                        document.body.appendChild(document.createTextNode(child.x));
                    }
                    process_children(child, document.body);
                }
            }
            if (postprocess_dom) {
                postprocess_dom();
            }
            ev = document.createEvent("Event");
            ev.initEvent("DOMContentLoaded", true, true);
            document.dispatchEvent(ev);
            if (load_required.length) {
                setTimeout(hangcheck, hang_timeout * 1e3);
            } else {
                proceeded = true;
                proceed();
            }
        };
        if (!unserialize_html.__argnames__) Object.defineProperties(unserialize_html, {
            __argnames__ : {value: ["serialized_data", "proceed", "postprocess_dom", "root_name"]},
            __module__ : {value: "read_book.resources"}
        });

        function unserialize_html_legacy(serialized_data, proceed, postprocess_dom, root_name) {
            var tag_map, tree, ns_map, html, _unpack, head, body, base, load_required, proceeded, hang_timeout, stack, bnode, ev;
            tag_map = serialized_data.tag_map;
            tree = serialized_data.tree;
            ns_map = serialized_data.ns_map;
            html = tag_map[0];
            remove_all_attributes(document.documentElement);
            apply_attributes(html, document.documentElement, ns_map);
            _unpack = [tree[1], tree[2]];
            head = _unpack[0];
            body = _unpack[1];
            clear(document.head, document.body);
            remove_all_attributes(document.head, document.body);
            document.head.appendChild(_interpolate_kwargs.call(E, E.style, ["html::-webkit-scrollbar, body::-webkit-scrollbar { display: none !important }"].concat([_desugar_kwargs({type: "text/css"})])));
            if (runtime.is_standalone_viewer && root_name) {
                if (root_name.indexOf("/") > -1) {
                    base = window.location.pathname.rpartition("/")[0];
                    base = "" + _str.format("{}", window.location.protocol) + "//" + _str.format("{}", window.location.hostname) + "" + _str.format("{}", base) + "/" + root_name;
                    document.head.appendChild(_interpolate_kwargs.call(E, E.base, [_desugar_kwargs({href: base})]));
                }
            }
            if (!runtime.is_standalone_viewer) {
                document.head.appendChild(_interpolate_kwargs.call(E, E.style, ["html {{ font-family: {} }}".format(window.default_font_family || "sans-serif")].concat([_desugar_kwargs({type: "text/css"})])));
            }
            load_required = set();
            proceeded = false;
            hang_timeout = 5;
            function hangcheck() {
                if (!proceeded) {
                    proceeded = true;
                    print("WARNING: All resources did not load in " + _str.format("{}", hang_timeout) + " seconds, proceeding anyway (" + _str.format("{}", load_required.length) + " resources left)");
                    proceed();
                }
            };
            if (!hangcheck.__module__) Object.defineProperties(hangcheck, {
                __module__ : {value: "read_book.resources"}
            });

            function onload() {
                load_required.discard(this);
                if (!load_required.length && !proceeded) {
                    proceeded = true;
                    proceed();
                }
            };
            if (!onload.__module__) Object.defineProperties(onload, {
                __module__ : {value: "read_book.resources"}
            });

            stack = [];
            for (var i = head.length - 1; i >= 1; i--) {
                stack.push([head[i], document.head]);
            }
            process_stack(stack, tag_map, ns_map, load_required, onload);
            bnode = tag_map[_bound_index(body[0], tag_map)];
            apply_attributes(bnode, document.body, ns_map);
            if (bnode.x) {
                document.body.appendChild(document.createTextNode(bnode.x));
            }
            for (var i = body.length - 1; i >= 1; i--) {
                stack.push([body[i], document.body]);
            }
            process_stack(stack, tag_map, ns_map, load_required, onload);
            if (postprocess_dom) {
                postprocess_dom();
            }
            ev = document.createEvent("Event");
            ev.initEvent("DOMContentLoaded", true, true);
            document.dispatchEvent(ev);
            if (load_required.length) {
                setTimeout(hangcheck, hang_timeout * 1e3);
            } else {
                proceeded = true;
                proceed();
            }
        };
        if (!unserialize_html_legacy.__argnames__) Object.defineProperties(unserialize_html_legacy, {
            __argnames__ : {value: ["serialized_data", "proceed", "postprocess_dom", "root_name"]},
            __module__ : {value: "read_book.resources"}
        });

        function text_from_serialized_html(data, get_anchor_offset_map) {
            var serialized_data, tag_map, ans, no_visit, ignore_text, stack, child, anchor_offset_map, text_pos, _unpack, node, text_ignored_in_parent, src, x, aid, ignore_text_in_node_and_children;
            serialized_data = JSON.parse(data);
            tag_map = serialized_data.tag_map;
            ans = [];
            no_visit = (function(){
                var _d = Object.create(null);
                _d["script"] = true;
                _d["style"] = true;
                _d["title"] = true;
                _d["head"] = true;
                return _d;
            }).call(this);
            ignore_text = (function(){
                var _d = Object.create(null);
                _d["img"] = true;
                _d["math"] = true;
                _d["rt"] = true;
                _d["rp"] = true;
                _d["rtc"] = true;
                return _d;
            }).call(this);
            ignore_text;
            if (tag_map) {
                stack = [[serialized_data.tree[2], false]];
            } else {
                stack = [];
                var _Iter13 = _Iterable(serialized_data.tree.c);
                for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                    child = _Iter13[_Index13];
                    if (child.n === "body") {
                        stack.push([child, false]);
                    }
                }
            }
            anchor_offset_map = Object.create(null);
            text_pos = 0;
            while (stack.length) {
                _unpack = stack.pop();
_unpack = _unpack_asarray(2, _unpack);
                node = _unpack[0];
                text_ignored_in_parent = _unpack[1];
                if (typeof node === "string") {
                    ans.push(node);
                    text_pos += node.length;
                    continue;
                }
                src = (tag_map) ? tag_map[_bound_index(node[0], tag_map)] : node;
                if (get_anchor_offset_map && src.a) {
                    for (var i = 0; i < src.a.length; i++) {
                        x = (_expr_temp = src.a)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                        if (x[0] === "id") {
                            aid = x[1];
                            if (typeof anchor_offset_map[(typeof aid === "number" && aid < 0) ? anchor_offset_map.length + aid : aid] !== "number") {
                                anchor_offset_map[(typeof aid === "number" && aid < 0) ? anchor_offset_map.length + aid : aid] = text_pos;
                            }
                        }
                    }
                }
                if (no_visit[_bound_index(src.n, no_visit)]) {
                    continue;
                }
                ignore_text_in_node_and_children = text_ignored_in_parent || !!ignore_text[src.n];
                if (!ignore_text_in_node_and_children && src.x) {
                    ans.push(src.x);
                    text_pos += src.x.length;
                }
                if (!text_ignored_in_parent && src.l) {
                    stack.push([src.l, ignore_text_in_node_and_children]);
                }
                if (tag_map) {
                    for (var i = node.length - 1; i >= 1; i--) {
                        stack.push([node[i], ignore_text_in_node_and_children]);
                    }
                } else {
                    if (src.c) {
                        for (var i = src.c.length; i-- > 0;) {
                            stack.push([src.c[i], ignore_text_in_node_and_children]);
                        }
                    }
                }
            }
            ans = ans.join("");
            if (get_anchor_offset_map) {
                return [ans, anchor_offset_map];
            }
            return ans;
        };
        if (!text_from_serialized_html.__argnames__) Object.defineProperties(text_from_serialized_html, {
            __argnames__ : {value: ["data", "get_anchor_offset_map"]},
            __module__ : {value: "read_book.resources"}
        });

        _modules["read_book.resources"].JSON_XHTML_MIMETYPE = JSON_XHTML_MIMETYPE;
        _modules["read_book.resources"].mathjax_data = mathjax_data;
        _modules["read_book.resources"].js_types = js_types;
        _modules["read_book.resources"].k = k;
        _modules["read_book.resources"].resource_tag_names = resource_tag_names;
        _modules["read_book.resources"].ns_rmap = ns_rmap;
        _modules["read_book.resources"].ns_count = ns_count;
        _modules["read_book.resources"].hide_tooltips = hide_tooltips;
        _modules["read_book.resources"].decode_component = decode_component;
        _modules["read_book.resources"].decode_url = decode_url;
        _modules["read_book.resources"].create_link_pat = create_link_pat;
        _modules["read_book.resources"].load_resources = load_resources;
        _modules["read_book.resources"].load_mathjax = load_mathjax;
        _modules["read_book.resources"].finalize_resources = finalize_resources;
        _modules["read_book.resources"].get_prefix = get_prefix;
        _modules["read_book.resources"].apply_attributes = apply_attributes;
        _modules["read_book.resources"].is_loadable_link = is_loadable_link;
        _modules["read_book.resources"].process_stack = process_stack;
        _modules["read_book.resources"].unserialize_html = unserialize_html;
        _modules["read_book.resources"].unserialize_html_legacy = unserialize_html_legacy;
        _modules["read_book.resources"].text_from_serialized_html = text_from_serialized_html;
    })();

    (function(){
        var __name__ = "read_book.footnotes";
        var block_names, block_display_styles, ok_list_types;
        var clear = _modules.dom.clear;

        var IframeClient = _modules.iframe_comm.IframeClient;

        var runtime = _modules["read_book.globals"].runtime;
        var current_spine_item = _modules["read_book.globals"].current_spine_item;
        var set_current_spine_item = _modules["read_book.globals"].set_current_spine_item;

        var finalize_resources = _modules["read_book.resources"].finalize_resources;
        var unserialize_html = _modules["read_book.resources"].unserialize_html;

        var apply_settings = _modules["read_book.settings"].apply_settings;
        var set_color_scheme_class = _modules["read_book.settings"].set_color_scheme_class;
        var update_settings = _modules["read_book.settings"].update_settings;

        block_names = dict.fromkeys(['p', 'div', 'li', 'td', 'h1', 'h2', 'h2', 'h3', 'h4', 'h5', 'h6', 'body'], true).as_object();
        block_display_styles = dict.fromkeys(['block', 'list-item', 'table-cell', 'table'], true).as_object();
        function elem_roles(elem) {
            return (function() {
                var _Iter = _Iterable((elem.getAttribute("role") || "").split(" ")), _Result = Object.create(null), k;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    k = _Iter[_Index];
                    _Result[k.toLowerCase()] = (true);
                }
                return _Result;
            })();
        };
        if (!elem_roles.__argnames__) Object.defineProperties(elem_roles, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function epub_type(elem) {
            var a;
            var _Iter0 = _Iterable(elem.attributes);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                a = _Iter0[_Index0];
                if (_equals(a.nodeName.toLowerCase(), "epub:type") && a.nodeValue) {
                    return a.nodeValue;
                }
            }
        };
        if (!epub_type.__argnames__) Object.defineProperties(epub_type, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function get_containing_block(node) {
            while (node && node.tagName && block_names[_bound_index(node.tagName.toLowerCase(), block_names)] !== true) {
                node = node.parentNode;
            }
            return node;
        };
        if (!get_containing_block.__argnames__) Object.defineProperties(get_containing_block, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function is_footnote_link(a, dest_name, dest_frag, src_name, link_to_map) {
            var roles, _unpack, x, num, style, children, text_children, eid, files_linking_to_self, files_linking_to_anchor, cb, ltext, ctext;
            roles = elem_roles(a);
            if (roles["doc-noteref"] || roles["doc-biblioref"] || roles["doc-glossref"]) {
                return true;
            }
            if (roles["doc-link"]) {
                return false;
            }
            if (epub_type(a) === "noteref") {
                return true;
            }
            _unpack = [a, 3];
            x = _unpack[0];
            num = _unpack[1];
            while (x && num > 0) {
                style = window.getComputedStyle(x);
                if (!(_expr_temp = is_footnote_link.inline_displays)[_bound_index(style.display, _expr_temp)]) {
                    break;
                }
                if ((_expr_temp = is_footnote_link.vert_aligns)[_bound_index(style.verticalAlign, _expr_temp)]) {
                    return true;
                }
                x = x.parentNode;
                num -= 1;
            }
            children = (function() {
                var _Iter = _Iterable(a.childNodes), _Result = [], x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    if (x.nodeType === Node.ELEMENT_NODE) {
                        _Result.push(x);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            if ((children.length === 1 || typeof children.length === "object" && _equals(children.length, 1))) {
                style = window.getComputedStyle(children[0]);
                if ((_expr_temp = is_footnote_link.inline_displays)[_bound_index(style.display, _expr_temp)] && (_expr_temp = is_footnote_link.vert_aligns)[_bound_index(style.verticalAlign, _expr_temp)]) {
                    text_children = (function() {
                        var _Iter = _Iterable(a.childNodes), _Result = [], x;
                        for (var _Index = 0; _Index < _Iter.length; _Index++) {
                            x = _Iter[_Index];
                            if (x.nodeType === Node.TEXT_NODE && x.nodeValue && /\S+/.test(x.nodeValue)) {
                                _Result.push(x);
                            }
                        }
                        _Result = _list_constructor(_Result);
                        return _Result;
                    })();
                    if (!text_children.length) {
                        return true;
                    }
                }
            }
            eid = a.getAttribute("id") || a.getAttribute("name");
            files_linking_to_self = link_to_map[(typeof src_name === "number" && src_name < 0) ? link_to_map.length + src_name : src_name];
            if (eid && files_linking_to_self) {
                files_linking_to_anchor = files_linking_to_self[(typeof eid === "number" && eid < 0) ? files_linking_to_self.length + eid : eid] || [];
                if (files_linking_to_anchor.length > 1 || (files_linking_to_anchor.length === 1 || typeof files_linking_to_anchor.length === "object" && _equals(files_linking_to_anchor.length, 1)) && files_linking_to_anchor[0] !== src_name) {
                    cb = get_containing_block(a);
                    if (!cb || _equals(cb.tagName.toLowerCase(), "body")) {
                        return false;
                    }
                    ltext = a.textContent;
                    if (!ltext) {
                        return false;
                    }
                    ctext = cb.textContent;
                    if (!ctext) {
                        return false;
                    }
                    if (ctext.strip() === ltext.strip()) {
                        return false;
                    }
                    return true;
                }
            }
            return false;
        };
        if (!is_footnote_link.__argnames__) Object.defineProperties(is_footnote_link, {
            __argnames__ : {value: ["a", "dest_name", "dest_frag", "src_name", "link_to_map"]},
            __module__ : {value: "read_book.footnotes"}
        });

        is_footnote_link.inline_displays = (function(){
            var _d = Object.create(null);
            _d["inline"] = true;
            _d["inline-block"] = true;
            return _d;
        }).call(this);
        is_footnote_link.vert_aligns = (function(){
            var _d = Object.create(null);
            _d["sub"] = true;
            _d["super"] = true;
            _d["top"] = true;
            _d["bottom"] = true;
            return _d;
        }).call(this);
        function is_epub_footnote(node) {
            var et, roles;
            et = epub_type(node);
            if (et) {
                et = et.toLowerCase();
                if (et === "note" || et === "footnote" || et === "rearnote") {
                    return true;
                }
            }
            roles = elem_roles(node);
            if (roles["doc-note"] || roles["doc-footnote"] || roles["doc-rearnote"]) {
                return true;
            }
            return false;
        };
        if (!is_epub_footnote.__argnames__) Object.defineProperties(is_epub_footnote, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function get_note_container(node) {
            while (node && block_names[_bound_index(node.tagName.toLowerCase(), block_names)] !== true && block_display_styles[_bound_index(window.getComputedStyle(node).display, block_display_styles)] !== true) {
                node = node.parentNode;
            }
            return node;
        };
        if (!get_note_container.__argnames__) Object.defineProperties(get_note_container, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function get_parents_and_self(node) {
            var ans;
            ans = [];
            while (node && node !== document.body) {
                ans.push(node);
                node = node.parentNode;
            }
            return ans;
        };
        if (!get_parents_and_self.__argnames__) Object.defineProperties(get_parents_and_self, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function get_page_break(node) {
            var style;
            style = window.getComputedStyle(node);
            return (function(){
                var _d = Object.create(null);
                _d["before"] = (_expr_temp = get_page_break.on)[_bound_index(style.getPropertyValue("page-break-before"), _expr_temp)] === true;
                _d["after"] = (_expr_temp = get_page_break.on)[_bound_index(style.getPropertyValue("page-break-after"), _expr_temp)] === true;
                return _d;
            }).call(this);
        };
        if (!get_page_break.__argnames__) Object.defineProperties(get_page_break, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.footnotes"}
        });

        get_page_break.on = (function(){
            var _d = Object.create(null);
            _d["always"] = true;
            _d["left"] = true;
            _d["right"] = true;
            return _d;
        }).call(this);
        function hide_children(node) {
            var child;
            var _Iter1 = _Iterable(node.childNodes);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                child = _Iter1[_Index1];
                if (child.nodeType === Node.ELEMENT_NODE) {
                    if (child.do_not_hide) {
                        hide_children(child);
                        delete child.do_not_hide;
                    } else {
                        child.style.display = "none";
                    }
                }
            }
        };
        if (!hide_children.__argnames__) Object.defineProperties(hide_children, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function unhide_tree(elem) {
            var c;
            elem.do_not_hide = true;
            var _Iter2 = _Iterable(elem.getElementsByTagName("*"));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                c = _Iter2[_Index2];
                c.do_not_hide = true;
            }
        };
        if (!unhide_tree.__argnames__) Object.defineProperties(unhide_tree, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.footnotes"}
        });

        ok_list_types = (function(){
            var _d = Object.create(null);
            _d["disc"] = true;
            _d["circle"] = true;
            _d["square"] = true;
            return _d;
        }).call(this);
        function is_new_footnote_start(elem, start_elem) {
            var c;
            c = get_note_container(elem);
            return c !== start_elem && c !== start_elem.firstElementChild;
        };
        if (!is_new_footnote_start.__argnames__) Object.defineProperties(is_new_footnote_start, {
            __argnames__ : {value: ["elem", "start_elem"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function show_footnote(target, known_anchors) {
            var start_elem, style, elem, found_note_start, eid, pb;
            if (!target) {
                return;
            }
            start_elem = document.getElementById(target);
            if (!start_elem) {
                return;
            }
            start_elem = get_note_container(start_elem);
            var _Iter3 = _Iterable(get_parents_and_self(start_elem));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                elem = _Iter3[_Index3];
                elem.do_not_hide = true;
                style = window.getComputedStyle(elem);
                if (style.display === "list-item" && ok_list_types[_bound_index(style.listStyleType, ok_list_types)] !== true) {
                    elem.style.listStyleType = "none";
                }
            }
            if (is_epub_footnote(start_elem)) {
                unhide_tree(start_elem);
            } else {
                found_note_start = false;
                var _Iter4 = _Iterable(document.documentElement.getElementsByTagName("*"));
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    elem = _Iter4[_Index4];
                    if (found_note_start) {
                        eid = elem.getAttribute("id");
                        if (eid !== target && known_anchors[(typeof eid === "number" && eid < 0) ? known_anchors.length + eid : eid] && is_new_footnote_start(elem, start_elem)) {
                            delete get_note_container(elem).do_not_hide;
                            break;
                        }
                        pb = get_page_break(elem);
                        if (pb.before) {
                            break;
                        }
                        if (pb.after) {
                            unhide_tree(elem);
                            break;
                        }
                        elem.do_not_hide = true;
                    } else if (elem === start_elem) {
                        found_note_start = true;
                    }
                }
            }
            hide_children(document.body);
            window.location.hash = "#" + target;
        };
        if (!show_footnote.__argnames__) Object.defineProperties(show_footnote, {
            __argnames__ : {value: ["target", "known_anchors"]},
            __module__ : {value: "read_book.footnotes"}
        });

        function PopupIframeBoss() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            PopupIframeBoss.prototype.__bind_methods__.call(this);
            PopupIframeBoss.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(PopupIframeBoss.prototype, "__bind_methods__", {value: function () {
            this.initialize = PopupIframeBoss.prototype.initialize.bind(this);
            this.on_error = PopupIframeBoss.prototype.on_error.bind(this);
            this.display = PopupIframeBoss.prototype.display.bind(this);
            this.connect_links = PopupIframeBoss.prototype.connect_links.bind(this);
            this.link_activated = PopupIframeBoss.prototype.link_activated.bind(this);
            this.activate_link = PopupIframeBoss.prototype.activate_link.bind(this);
            this.on_clear = PopupIframeBoss.prototype.on_clear.bind(this);
            this.show_only_footnote = PopupIframeBoss.prototype.show_only_footnote.bind(this);
            this.content_loaded = PopupIframeBoss.prototype.content_loaded.bind(this);
        }});
        PopupIframeBoss.prototype.__init__ = function __init__() {
            var self = this;
            var handlers;
            handlers = (function(){
                var _d = Object.create(null);
                _d["initialize"] = self.initialize;
                _d["clear"] = self.on_clear;
                _d["display"] = self.display;
                return _d;
            }).call(this);
            self.comm = new IframeClient(handlers, "popup-iframe");
            self.blob_url_map = Object.create(null);
            self.name = null;
            self.frag = null;
            self.link_attr = null;
        };
        if (!PopupIframeBoss.prototype.__init__.__module__) Object.defineProperties(PopupIframeBoss.prototype.__init__, {
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.__argnames__ = PopupIframeBoss.prototype.__init__.__argnames__;
        PopupIframeBoss.__handles_kwarg_interpolation__ = PopupIframeBoss.prototype.__init__.__handles_kwarg_interpolation__;
        PopupIframeBoss.prototype.initialize = function initialize(data) {
            var self = this;
            window.addEventListener("error", self.on_error);
        };
        if (!PopupIframeBoss.prototype.initialize.__argnames__) Object.defineProperties(PopupIframeBoss.prototype.initialize, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.on_error = function on_error(evt) {
            var self = this;
            var msg, script_url, line_number, column_number, error_object;
            msg = evt.message;
            script_url = evt.filename;
            line_number = evt.lineno;
            column_number = evt.colno;
            error_object = evt.error;
            [evt.stopPropagation(), evt.preventDefault()];
            if (error_object === null) {
                console.log("Unhandled error from external javascript, ignoring: " + _str.format("{}", msg) + " " + _str.format("{}", script_url) + " " + _str.format("{}", line_number) + ":" + _str.format("{}", column_number) + "");
            } else {
                console.log(error_object);
            }
        };
        if (!PopupIframeBoss.prototype.on_error.__argnames__) Object.defineProperties(PopupIframeBoss.prototype.on_error, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.display = function display(data) {
            var self = this;
            var spine, index, name, _unpack, root_data;
            self.book = data.book;
            self.name = data.name;
            self.frag = data.frag;
            self.link_attr = "data-" + self.book.manifest.link_uid;
            spine = self.book.manifest.spine;
            index = spine.indexOf(data.name);
            set_current_spine_item((function(){
                var _d = Object.create(null);
                _d["name"] = data.name;
                _d["is_first"] = index === 0;
                _d["is_last"] = index === spine.length - 1;
                _d["index"] = index;
                _d["initial_position"] = data.initial_position;
                return _d;
            }).call(this));
            update_settings(data.settings);
            var _Iter5 = _Iterable(self.blob_url_map);
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                name = _Iter5[_Index5];
                window.URL.revokeObjectURL((_expr_temp = self.blob_url_map)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]);
            }
            document.body.style.removeProperty("font-family");
            _unpack = finalize_resources(self.book, data.name, data.resource_data);
_unpack = _unpack_asarray(3, _unpack);
            root_data = _unpack[0];
            self.mathjax = _unpack[1];
            self.blob_url_map = _unpack[2];
            self.resource_urls = unserialize_html(root_data, self.content_loaded, self.show_only_footnote, data.name);
        };
        if (!PopupIframeBoss.prototype.display.__argnames__) Object.defineProperties(PopupIframeBoss.prototype.display, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.connect_links = function connect_links() {
            var self = this;
            var a;
            var _Iter6 = _Iterable(document.body.querySelectorAll("a[" + _str.format("{}", self.link_attr) + "]"));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                a = _Iter6[_Index6];
                a.addEventListener("click", self.link_activated);
            }
            if (runtime.is_standalone_viewer) {
                var _Iter7 = _Iterable(document.body.querySelectorAll("a[target]"));
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    a = _Iter7[_Index7];
                    a.removeAttribute("target");
                }
            }
        };
        if (!PopupIframeBoss.prototype.connect_links.__module__) Object.defineProperties(PopupIframeBoss.prototype.connect_links, {
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.link_activated = function link_activated(evt) {
            var self = this;
            var data;
            try {
                data = JSON.parse(evt.currentTarget.getAttribute(self.link_attr));
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    print("WARNING: Failed to parse link data {}, ignoring".format(_exists.c(_exists.d(evt.currentTarget).getAttribute)(self.link_attr)));
                    return;
                } 
            }
            self.activate_link(data.name, data.frag, evt.currentTarget);
        };
        if (!PopupIframeBoss.prototype.link_activated.__argnames__) Object.defineProperties(PopupIframeBoss.prototype.link_activated, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.activate_link = function activate_link(name, frag, target_elem) {
            var self = this;
            var is_popup, title;
            if (!name) {
                name = current_spine_item().name;
            }
            try {
                is_popup = is_footnote_link(target_elem, name, frag, current_spine_item().name, self.book.manifest.link_to_map || Object.create(null));
                title = target_elem.textContent;
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    var traceback = _modules.traceback;

                    traceback.print_exc();
                    is_popup = false;
                    title = "";
                } 
            }
            _interpolate_kwargs.call(self.comm, self.comm.send_message, ["link_activated"].concat([_desugar_kwargs({is_popup: is_popup, name: name, frag: frag, title: title})]));
        };
        if (!PopupIframeBoss.prototype.activate_link.__argnames__) Object.defineProperties(PopupIframeBoss.prototype.activate_link, {
            __argnames__ : {value: ["name", "frag", "target_elem"]},
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.on_clear = function on_clear(data) {
            var self = this;
            clear(document.head);
            clear(document.body);
            document.body.textContent = data.text;
            self.name = null;
            self.frag = null;
        };
        if (!PopupIframeBoss.prototype.on_clear.__argnames__) Object.defineProperties(PopupIframeBoss.prototype.on_clear, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.show_only_footnote = function show_only_footnote() {
            var self = this;
            var known_anchors, ltm, k;
            known_anchors = Object.create(null);
            ltm = (_expr_temp = _exists.d(self.book.manifest.link_to_map))[_bound_index(self.name, _expr_temp)];
            if (ltm) {
                known_anchors = (function() {
                    var _Iter = _Iterable(Object.keys(ltm)), _Result = Object.create(null), k;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        k = _Iter[_Index];
                        _Result[k] = (true);
                    }
                    return _Result;
                })();
            }
            show_footnote(self.frag, known_anchors);
        };
        if (!PopupIframeBoss.prototype.show_only_footnote.__module__) Object.defineProperties(PopupIframeBoss.prototype.show_only_footnote, {
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.content_loaded = function content_loaded() {
            var self = this;
            if (!self.comm.encrypted_communications) {
                window.setTimeout(self.content_loaded, 2);
                return;
            }
            self.connect_links();
            document.head.removeChild(document.head.firstChild);
            document.body.classList.add("calibre-footnote-container");
            set_color_scheme_class();
            apply_settings(true);
            _interpolate_kwargs.call(self.comm, self.comm.send_message, ["content_loaded"].concat([_desugar_kwargs({height: document.documentElement.scrollHeight + 25})]));
        };
        if (!PopupIframeBoss.prototype.content_loaded.__module__) Object.defineProperties(PopupIframeBoss.prototype.content_loaded, {
            __module__ : {value: "read_book.footnotes"}
        });
        PopupIframeBoss.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        PopupIframeBoss.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(PopupIframeBoss.prototype, "__bases__", {value: []});

        function main() {
            main.boss = new PopupIframeBoss;
        };
        if (!main.__module__) Object.defineProperties(main, {
            __module__ : {value: "read_book.footnotes"}
        });

        _modules["read_book.footnotes"].block_names = block_names;
        _modules["read_book.footnotes"].block_display_styles = block_display_styles;
        _modules["read_book.footnotes"].ok_list_types = ok_list_types;
        _modules["read_book.footnotes"].elem_roles = elem_roles;
        _modules["read_book.footnotes"].epub_type = epub_type;
        _modules["read_book.footnotes"].get_containing_block = get_containing_block;
        _modules["read_book.footnotes"].is_footnote_link = is_footnote_link;
        _modules["read_book.footnotes"].is_epub_footnote = is_epub_footnote;
        _modules["read_book.footnotes"].get_note_container = get_note_container;
        _modules["read_book.footnotes"].get_parents_and_self = get_parents_and_self;
        _modules["read_book.footnotes"].get_page_break = get_page_break;
        _modules["read_book.footnotes"].hide_children = hide_children;
        _modules["read_book.footnotes"].unhide_tree = unhide_tree;
        _modules["read_book.footnotes"].is_new_footnote_start = is_new_footnote_start;
        _modules["read_book.footnotes"].show_footnote = show_footnote;
        _modules["read_book.footnotes"].PopupIframeBoss = PopupIframeBoss;
        _modules["read_book.footnotes"].main = main;
    })();

    (function(){
        var __name__ = "read_book.touch";
        var HOLD_THRESHOLD, TAP_THRESHOLD, SWIPE_THRESHOLD, TAP_LINK_THRESHOLD, PINCH_THRESHOLD, GESTURE, k, gesture_id, main_touch_handler, left_margin_handler, right_margin_handler;
        var _ = _modules.gettext.gettext;

        var get_boss = _modules["read_book.globals"].get_boss;
        var ltr_page_progression = _modules["read_book.globals"].ltr_page_progression;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var opts = _modules["read_book.settings"].opts;

        var get_unit_size_in_pixels = _modules["read_book.viewport"].get_unit_size_in_pixels;
        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;

        HOLD_THRESHOLD = 750;
        TAP_THRESHOLD = 8;
        SWIPE_THRESHOLD = 64;
        TAP_LINK_THRESHOLD = 5;
        PINCH_THRESHOLD = 20;
        GESTURE = (function() {
            var _Iter = _Iterable([
    'back_zone_tap',
    'forward_zone_tap',
    'control_zone_tap',
    'long_tap',
    'two_finger_tap',
    'pinch_in',
    'pinch_out',

    'flick_inline_backward',
    'flick_inline_forward',
    'flick_block_backward',
    'flick_block_forward',

    'swipe_inline_backward_in_progress',
    'swipe_inline_forward_in_progress',
    'swipe_block_backward_in_progress',
    'swipe_block_forward_in_progress',

    'swipe_inline_backward_hold',
    'swipe_inline_forward_hold',
    'swipe_block_backward_hold',
    'swipe_block_forward_hold',

    'tap',
    'swipe',
    'pinch',
]), _Result = Object.create(null), k;
            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                k = _Iter[_Index];
                _Result[k] = (k);
            }
            return _Result;
        })();
        function GESTURE_NAMES() {
            var ans;
            ans = GESTURE_NAMES.ans;
            if (!ans) {
                GESTURE_NAMES.ans = ans = (function(){
                    var _d = Object.create(null);
                    _d["back_zone_tap"] = _("Tap on back zone");
                    _d["forward_zone_tap"] = _("Tap on forward zone");
                    _d["control_zone_tap"] = _("Tap in the controls zone");
                    _d["long_tap"] = _("Long tap");
                    _d["two_finger_tap"] = _("Two finger tap");
                    _d["pinch_in"] = _("Pinch in");
                    _d["pinch_out"] = _("Pinch out");
                    _d["flick_inline_backward"] = _("Flick in writing direction, to go back");
                    _d["flick_inline_forward"] = _("Flick in writing direction, to go forward");
                    _d["flick_block_backward"] = _("Flick perpendicular to writing direction, to go forward");
                    _d["flick_block_forward"] = _("Flick perpendicular to writing direction, to go back");
                    _d["swipe_inline_backward_in_progress"] = _("Drag finger in writing direction, to go back");
                    _d["swipe_inline_forward_in_progress"] = _("Drag finger in writing direction, to go forward");
                    _d["swipe_block_backward_in_progress"] = _("Drag finger perpendicular to writing direction, to go back");
                    _d["swipe_block_forward_in_progress"] = _("Drag finger perpendicular to writing direction, to go forward");
                    _d["swipe_inline_backward_hold"] = _("Drag and hold finger in writing direction, to go back");
                    _d["swipe_inline_forward_hold"] = _("Drag and hold finger in writing direction, to go forward");
                    _d["swipe_block_backward_hold"] = _("Drag and hold finger perpendicular to writing direction, to go back");
                    _d["swipe_block_forward_hold"] = _("Drag and hold finger perpendicular to writing direction, to go forward");
                    return _d;
                }).call(this);
            }
            return ans;
        };
        if (!GESTURE_NAMES.__module__) Object.defineProperties(GESTURE_NAMES, {
            __module__ : {value: "read_book.touch"}
        });

        gesture_id = 0;
        function touch_id(touch) {
            return touch.identifier + "";
        };
        if (!touch_id.__argnames__) Object.defineProperties(touch_id, {
            __argnames__ : {value: ["touch"]},
            __module__ : {value: "read_book.touch"}
        });

        function copy_touch(t) {
            var now;
            now = window.performance.now();
            return (function(){
                var _d = Object.create(null);
                _d["identifier"] = touch_id(t);
                _d["page_x"] = [t.pageX];
                _d["page_y"] = [t.pageY];
                _d["viewport_x"] = [t.clientX];
                _d["viewport_y"] = [t.clientY];
                _d["active"] = true;
                _d["mtimes"] = [now];
                _d["ctime"] = now;
                _d["is_held"] = false;
                _d["x_velocity"] = 0;
                _d["y_velocity"] = 0;
                return _d;
            }).call(this);
        };
        if (!copy_touch.__argnames__) Object.defineProperties(copy_touch, {
            __argnames__ : {value: ["t"]},
            __module__ : {value: "read_book.touch"}
        });

        function update_touch(t, touch) {
            var now;
            now = window.performance.now();
            t.mtimes.push(now);
            [t.page_x.push(touch.pageX), t.page_y.push(touch.pageY)];
            [t.viewport_x.push(touch.clientX), t.viewport_y.push(touch.clientY)];
        };
        if (!update_touch.__argnames__) Object.defineProperties(update_touch, {
            __argnames__ : {value: ["t", "touch"]},
            __module__ : {value: "read_book.touch"}
        });

        function max_displacement(points) {
            var ans, first, delta, p;
            ans = 0;
            first = points[0];
            if (!(typeof first !== "undefined" && first !== null)) {
                return ans;
            }
            var _Iter0 = _Iterable(points);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                p = _Iter0[_Index0];
                delta = abs(p - first);
                if (delta > ans) {
                    ans = delta;
                }
            }
            return ans;
        };
        if (!max_displacement.__argnames__) Object.defineProperties(max_displacement, {
            __argnames__ : {value: ["points"]},
            __module__ : {value: "read_book.touch"}
        });

        function interpret_single_gesture(touch, gesture_id) {
            var max_x_displacement, max_y_displacement, ans, delta_x, delta_y, max_disp, pts, positive;
            max_x_displacement = max_displacement(touch.viewport_x);
            max_y_displacement = max_displacement(touch.viewport_y);
            ans = (function(){
                var _d = Object.create(null);
                _d["active"] = touch.active;
                _d["is_held"] = touch.is_held;
                _d["id"] = gesture_id;
                _d["start_time"] = touch.ctime;
                return _d;
            }).call(this);
            if (max(max_x_displacement, max_y_displacement) < TAP_THRESHOLD) {
                ans.type = GESTURE.tap;
                ans.viewport_x = touch.viewport_x[0];
                ans.viewport_y = touch.viewport_y[0];
                return ans;
            }
            if (touch.viewport_y.length < 2) {
                return ans;
            }
            delta_x = abs((_expr_temp = touch.viewport_x)[_expr_temp.length-1] - touch.viewport_x[0]);
            delta_y = abs((_expr_temp = touch.viewport_y)[_expr_temp.length-1] - touch.viewport_y[0]);
            max_disp = max(delta_y, delta_x);
            if (max_disp > SWIPE_THRESHOLD && min(delta_x, delta_y) / max_disp < .35) {
                ans.type = GESTURE.swipe;
                ans.axis = (delta_y > delta_x) ? "vertical" : "horizontal";
                ans.points = pts = (ans.axis === "vertical") ? touch.viewport_y : touch.viewport_x;
                ans.times = touch.mtimes;
                positive = pts[pts.length-1] > pts[0];
                if (ans.axis === "vertical") {
                    ans.direction = (positive) ? "down" : "up";
                    ans.velocity = touch.y_velocity;
                } else {
                    ans.direction = (positive) ? "right" : "left";
                    ans.velocity = touch.x_velocity;
                }
                return ans;
            }
            return ans;
        };
        if (!interpret_single_gesture.__argnames__) Object.defineProperties(interpret_single_gesture, {
            __argnames__ : {value: ["touch", "gesture_id"]},
            __module__ : {value: "read_book.touch"}
        });

        function interpret_double_gesture(touch1, touch2, gesture_id) {
            var ans, max_x_displacement1, max_x_displacement2, max_y_displacement1, max_y_displacement2, initial_distance, final_distance, distance;
            ans = (function(){
                var _d = Object.create(null);
                _d["active"] = touch1.active || touch2.active;
                _d["is_held"] = touch1.is_held || touch2.is_held;
                _d["id"] = gesture_id;
                return _d;
            }).call(this);
            max_x_displacement1 = max_displacement(touch1.viewport_x);
            max_x_displacement2 = max_displacement(touch2.viewport_x);
            max_y_displacement1 = max_displacement(touch1.viewport_y);
            max_y_displacement2 = max_displacement(touch2.viewport_y);
            if (max(max_x_displacement1, max_y_displacement1) < TAP_THRESHOLD && max(max_x_displacement2, max_y_displacement2) < TAP_THRESHOLD) {
                ans.type = GESTURE.two_finger_tap;
                ans.viewport_x1 = touch1.viewport_x[0];
                ans.viewport_y1 = touch1.viewport_y[0];
                ans.viewport_x2 = touch2.viewport_x[0];
                ans.viewport_y2 = touch2.viewport_y[0];
                return ans;
            }
            initial_distance = Math.sqrt(Math.pow((touch1.viewport_x[0] - touch2.viewport_x[0]), 2) + Math.pow((touch1.viewport_y[0] - touch2.viewport_y[0]), 2));
            final_distance = Math.sqrt(Math.pow(((_expr_temp = touch1.viewport_x)[_expr_temp.length-1] - (_expr_temp = touch2.viewport_x)[_expr_temp.length-1]), 2) + Math.pow(((_expr_temp = touch1.viewport_y)[_expr_temp.length-1] - (_expr_temp = touch2.viewport_y)[_expr_temp.length-1]), 2));
            distance = abs(final_distance - initial_distance);
            if (distance > PINCH_THRESHOLD) {
                ans.type = GESTURE.pinch;
                ans.direction = (final_distance < initial_distance) ? "in" : "out";
                ans.distance = distance;
                return ans;
            }
            return ans;
        };
        if (!interpret_double_gesture.__argnames__) Object.defineProperties(interpret_double_gesture, {
            __argnames__ : {value: ["touch1", "touch2", "gesture_id"]},
            __module__ : {value: "read_book.touch"}
        });

        function element_from_point(x, y) {
            return document.elementFromPoint(x, y);
        };
        if (!element_from_point.__argnames__) Object.defineProperties(element_from_point, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.touch"}
        });

        function find_link(x, y) {
            var p;
            p = element_from_point(x, y);
            while (p) {
                if (p.tagName && p.tagName.toLowerCase() === "a" && p.hasAttribute("href")) {
                    return p;
                }
                p = p.parentNode;
            }
        };
        if (!find_link.__argnames__) Object.defineProperties(find_link, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "read_book.touch"}
        });

        function tap_on_link(gesture) {
            var x, y, link, delta_y, delta_x;
            var _Iter1 = _Iterable(_list_decorate([ 0, TAP_LINK_THRESHOLD, -TAP_LINK_THRESHOLD ]));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                delta_x = _Iter1[_Index1];
                var _Iter2 = _Iterable(_list_decorate([ 0, TAP_LINK_THRESHOLD, -TAP_LINK_THRESHOLD ]));
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    delta_y = _Iter2[_Index2];
                    x = gesture.viewport_x + delta_x;
                    y = gesture.viewport_y + delta_y;
                    link = find_link(x, y);
                    if (link) {
                        link.click();
                        return true;
                    }
                }
            }
            return false;
        };
        if (!tap_on_link.__argnames__) Object.defineProperties(tap_on_link, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.touch"}
        });

        function TouchHandler() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            TouchHandler.prototype.__bind_methods__.call(this);
            TouchHandler.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(TouchHandler.prototype, "__bind_methods__", {value: function () {
            this.prune_expired_touches = TouchHandler.prototype.prune_expired_touches.bind(this);
            this.reset_handlers = TouchHandler.prototype.reset_handlers.bind(this);
            this.start_hold_timer = TouchHandler.prototype.start_hold_timer.bind(this);
            this.stop_hold_timer = TouchHandler.prototype.stop_hold_timer.bind(this);
            this.check_for_hold = TouchHandler.prototype.check_for_hold.bind(this);
            this.handle_touchstart = TouchHandler.prototype.handle_touchstart.bind(this);
            this.handle_touchmove = TouchHandler.prototype.handle_touchmove.bind(this);
            this.handle_touchend = TouchHandler.prototype.handle_touchend.bind(this);
            this.handle_touchcancel = TouchHandler.prototype.handle_touchcancel.bind(this);
            this.dispatch_gesture = TouchHandler.prototype.dispatch_gesture.bind(this);
        }});
        Object.defineProperties(TouchHandler.prototype,  {
            "has_active_touches": {
                "enumerable": true, 
                "get": function has_active_touches() {
                    var self = this;
                    var t, tid;
                    var _Iter3 = _Iterable(self.ongoing_touches);
                    for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                        tid = _Iter3[_Index3];
                        t = (_expr_temp = self.ongoing_touches)[(typeof tid === "number" && tid < 0) ? _expr_temp.length + tid : tid];
                        if (t.active) {
                            return true;
                        }
                    }
                    return false;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        TouchHandler.prototype.__init__ = function __init__() {
            var self = this;
            self.ongoing_touches = Object.create(null);
            self.gesture_id = null;
            self.hold_timer = null;
            self.handled_tap_hold = false;
        };
        if (!TouchHandler.prototype.__init__.__module__) Object.defineProperties(TouchHandler.prototype.__init__, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.__argnames__ = TouchHandler.prototype.__init__.__argnames__;
        TouchHandler.__handles_kwarg_interpolation__ = TouchHandler.prototype.__init__.__handles_kwarg_interpolation__;
        TouchHandler.prototype.prune_expired_touches = function prune_expired_touches() {
            var self = this;
            var now, expired, t, tid;
            now = window.performance.now();
            expired = [];
            var _Iter4 = _Iterable(self.ongoing_touches);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                tid = _Iter4[_Index4];
                t = (_expr_temp = self.ongoing_touches)[(typeof tid === "number" && tid < 0) ? _expr_temp.length + tid : tid];
                if (t.active) {
                    if (now - (_expr_temp = t.mtimes)[_expr_temp.length-1] > 3e3) {
                        expired.push(touch_id(t));
                    }
                }
            }
            var _Iter5 = _Iterable(expired);
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                tid = _Iter5[_Index5];
                delete self.ongoing_touches[tid];
            }
        };
        if (!TouchHandler.prototype.prune_expired_touches.__module__) Object.defineProperties(TouchHandler.prototype.prune_expired_touches, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.reset_handlers = function reset_handlers() {
            var self = this;
            self.stop_hold_timer();
            self.ongoing_touches = Object.create(null);
            self.gesture_id = null;
            self.handled_tap_hold = false;
        };
        if (!TouchHandler.prototype.reset_handlers.__module__) Object.defineProperties(TouchHandler.prototype.reset_handlers, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.start_hold_timer = function start_hold_timer() {
            var self = this;
            self.stop_hold_timer();
            self.hold_timer = window.setTimeout(self.check_for_hold, 50);
        };
        if (!TouchHandler.prototype.start_hold_timer.__module__) Object.defineProperties(TouchHandler.prototype.start_hold_timer, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.stop_hold_timer = function stop_hold_timer() {
            var self = this;
            if (self.hold_timer !== null) {
                window.clearTimeout(self.hold_timer);
                self.hold_timer = null;
            }
        };
        if (!TouchHandler.prototype.stop_hold_timer.__module__) Object.defineProperties(TouchHandler.prototype.stop_hold_timer, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.check_for_hold = function check_for_hold() {
            var self = this;
            var now, found_hold, touch, touchid;
            if (len(self.ongoing_touches) > 0) {
                now = window.performance.now();
                found_hold = false;
                var _Iter6 = _Iterable(self.ongoing_touches);
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    touchid = _Iter6[_Index6];
                    touch = (_expr_temp = self.ongoing_touches)[(typeof touchid === "number" && touchid < 0) ? _expr_temp.length + touchid : touchid];
                    if (touch.active && now - (_expr_temp = touch.mtimes)[_expr_temp.length-1] > HOLD_THRESHOLD) {
                        touch.is_held = true;
                        found_hold = true;
                    }
                }
                if (found_hold) {
                    self.dispatch_gesture();
                }
                self.start_hold_timer();
            }
        };
        if (!TouchHandler.prototype.check_for_hold.__module__) Object.defineProperties(TouchHandler.prototype.check_for_hold, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.handle_touchstart = function handle_touchstart(ev) {
            var self = this;
            var touch;
            if (typeof ev.cancelable !== "boolean" || ev.cancelable) {
                ev.preventDefault();
            }
            ev.stopPropagation();
            self.prune_expired_touches();
            var _Iter7 = _Iterable(ev.changedTouches);
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                touch = _Iter7[_Index7];
                (_expr_temp = self.ongoing_touches)[_bound_index(touch_id(touch), _expr_temp)] = copy_touch(touch);
                if (self.gesture_id === null) {
                    gesture_id += 1;
                    self.gesture_id = gesture_id;
                    self.handled_tap_hold = false;
                }
            }
            if (len(self.ongoing_touches) > 0) {
                self.start_hold_timer();
            }
        };
        if (!TouchHandler.prototype.handle_touchstart.__argnames__) Object.defineProperties(TouchHandler.prototype.handle_touchstart, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.handle_touchmove = function handle_touchmove(ev) {
            var self = this;
            var t, touch;
            if (typeof ev.cancelable !== "boolean" || ev.cancelable) {
                ev.preventDefault();
            }
            ev.stopPropagation();
            var _Iter8 = _Iterable(ev.changedTouches);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                touch = _Iter8[_Index8];
                t = (_expr_temp = self.ongoing_touches)[_bound_index(touch_id(touch), _expr_temp)];
                if (t) {
                    update_touch(t, touch);
                    self.dispatch_gesture();
                }
            }
        };
        if (!TouchHandler.prototype.handle_touchmove.__argnames__) Object.defineProperties(TouchHandler.prototype.handle_touchmove, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.handle_touchend = function handle_touchend(ev) {
            var self = this;
            var t, touch;
            if (typeof ev.cancelable !== "boolean" || ev.cancelable) {
                ev.preventDefault();
            }
            ev.stopPropagation();
            var _Iter9 = _Iterable(ev.changedTouches);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                touch = _Iter9[_Index9];
                t = (_expr_temp = self.ongoing_touches)[_bound_index(touch_id(touch), _expr_temp)];
                if (t) {
                    t.active = false;
                    update_touch(t, touch);
                }
            }
            self.prune_expired_touches();
            if (!self.has_active_touches) {
                self.dispatch_gesture();
                self.reset_handlers();
            }
        };
        if (!TouchHandler.prototype.handle_touchend.__argnames__) Object.defineProperties(TouchHandler.prototype.handle_touchend, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.handle_touchcancel = function handle_touchcancel(ev) {
            var self = this;
            var tid, touch;
            if (typeof ev.cancelable !== "boolean" || ev.cancelable) {
                ev.preventDefault();
            }
            ev.stopPropagation();
            var _Iter10 = _Iterable(ev.changedTouches);
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                touch = _Iter10[_Index10];
                tid = touch_id(touch);
                delete self.ongoing_touches[tid];
            }
            self.gesture_id = null;
            self.handled_tap_hold = false;
        };
        if (!TouchHandler.prototype.handle_touchcancel.__argnames__) Object.defineProperties(TouchHandler.prototype.handle_touchcancel, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.dispatch_gesture = function dispatch_gesture() {
            var self = this;
            var touches, num, gesture, t;
            touches = self.ongoing_touches;
            num = len(touches);
            gesture = Object.create(null);
            if (num === 1) {
                gesture = interpret_single_gesture(touches[_bound_index(Object.keys(touches)[0], touches)], self.gesture_id);
            } else if (num === 2) {
                t = Object.keys(touches);
                gesture = interpret_double_gesture(touches[_bound_index(t[0], touches)], touches[_bound_index(t[1], touches)], self.gesture_id);
            }
            if (!(typeof gesture !== "undefined" && gesture !== null ? gesture : Object.create(null)).type) {
                return;
            }
            self.handle_gesture(gesture);
        };
        if (!TouchHandler.prototype.dispatch_gesture.__module__) Object.defineProperties(TouchHandler.prototype.dispatch_gesture, {
            __module__ : {value: "read_book.touch"}
        });
        TouchHandler.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        TouchHandler.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(TouchHandler.prototype, "__bases__", {value: []});
        

        function inch_in_pixels() {
            var ans;
            ans = inch_in_pixels.ans;
            if (!ans) {
                ans = inch_in_pixels.ans = max(2, get_unit_size_in_pixels("in"));
            }
            return ans;
        };
        if (!inch_in_pixels.__module__) Object.defineProperties(inch_in_pixels, {
            __module__ : {value: "read_book.touch"}
        });

        function BookTouchHandler() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            BookTouchHandler.prototype.__bind_methods__.call(this);
            BookTouchHandler.prototype.__init__.apply(this, arguments);
        }
        _extends(BookTouchHandler, TouchHandler);
        Object.defineProperty(BookTouchHandler.prototype, "__bind_methods__", {value: function () {
            TouchHandler.prototype.__bind_methods__ && TouchHandler.prototype.__bind_methods__.call(this);
            this.handle_gesture = BookTouchHandler.prototype.handle_gesture.bind(this);
            this.__repr__ = BookTouchHandler.prototype.__repr__.bind(this);
        }});
        BookTouchHandler.prototype.__init__ = function __init__() {
            var self = this;
            var for_side_margin = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.for_side_margin : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "for_side_margin")){
                for_side_margin = _kwargs_obj.for_side_margin;
            }
            self.for_side_margin = for_side_margin;
            TouchHandler.prototype.__init__.call(self);
        };
        if (!BookTouchHandler.prototype.__init__.__defaults__) Object.defineProperties(BookTouchHandler.prototype.__init__, {
            __defaults__ : {value: {for_side_margin:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["for_side_margin"]},
            __module__ : {value: "read_book.touch"}
        });
        BookTouchHandler.__argnames__ = BookTouchHandler.prototype.__init__.__argnames__;
        BookTouchHandler.__handles_kwarg_interpolation__ = BookTouchHandler.prototype.__init__.__handles_kwarg_interpolation__;
        BookTouchHandler.prototype.handle_gesture = function handle_gesture(gesture) {
            var self = this;
            var inch, limit, backward_dir, direction, inline_dir, axis;
            if (gesture.type === GESTURE.tap) {
                if (gesture.is_held) {
                    if (!self.for_side_margin && !self.handled_tap_hold && window.performance.now() - gesture.start_time >= HOLD_THRESHOLD) {
                        self.handled_tap_hold = true;
                        gesture.type = GESTURE.long_tap;
                        get_boss().handle_gesture(gesture);
                    }
                    return;
                }
                if (!gesture.active) {
                    if (self.for_side_margin || !tap_on_link(gesture)) {
                        inch = inch_in_pixels();
                        if (gesture.viewport_y < min(100, scroll_viewport.height() / 4)) {
                            gesture.type = GESTURE.control_zone_tap;
                        } else {
                            limit = inch;
                            if (ltr_page_progression() && !opts.reverse_page_turn_zones) {
                                if (gesture.viewport_x < min(limit, scroll_viewport.width() / 4)) {
                                    gesture.type = GESTURE.back_zone_tap;
                                } else {
                                    gesture.type = GESTURE.forward_zone_tap;
                                }
                            } else {
                                if (gesture.viewport_x > max(scroll_viewport.width() - limit, scroll_viewport.width() * (3 / 4))) {
                                    gesture.type = GESTURE.back_zone_tap;
                                } else {
                                    gesture.type = GESTURE.forward_zone_tap;
                                }
                            }
                        }
                    }
                }
            } else if (gesture.type === GESTURE.pinch) {
                if (gesture.active) {
                    return;
                }
                gesture.type = (gesture.direction === "in") ? GESTURE.pinch_in : GESTURE.pinch_out;
            } else if (gesture.type === GESTURE.two_finger_tap) {
                if (gesture.active) {
                    return;
                }
            } else if (gesture.type === "swipe") {
                backward_dir = (gesture.axis === "vertical") ? "down" : (ltr_page_progression()) ? "right" : "left";
                direction = (gesture.direction === backward_dir) ? "backward" : "forward";
                inline_dir = (scroll_viewport.vertical_writing_mode) ? "vertical" : "horizontal";
                axis = (gesture.axis === inline_dir) ? "inline" : "block";
                if (gesture.active) {
                    gesture.type = GESTURE[_bound_index("swipe_" + _str.format("{}", axis) + "_" + _str.format("{}", direction) + "" + ((gesture.is_held) ? "_hold" : "_in_progress"), GESTURE)];
                } else if (!gesture.is_held) {
                    gesture.type = GESTURE[_bound_index("flick_" + _str.format("{}", axis) + "_" + _str.format("{}", direction) + "", GESTURE)];
                }
            }
            if (self.for_side_margin) {
                ui_operations.forward_gesture(gesture);
            } else {
                get_boss().handle_gesture(gesture);
            }
        };
        if (!BookTouchHandler.prototype.handle_gesture.__argnames__) Object.defineProperties(BookTouchHandler.prototype.handle_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.touch"}
        });
        BookTouchHandler.prototype.__repr__ = function __repr__() {
            var self = this;
            return "BookTouchHandler:for_side_margin:" + self.for_side_margin;
        };
        if (!BookTouchHandler.prototype.__repr__.__module__) Object.defineProperties(BookTouchHandler.prototype.__repr__, {
            __module__ : {value: "read_book.touch"}
        });
        BookTouchHandler.prototype.__str__ = function __str__ () {
            if(TouchHandler.prototype.__str__) return TouchHandler.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(BookTouchHandler.prototype, "__bases__", {value: [TouchHandler]});

        main_touch_handler = new BookTouchHandler;
        left_margin_handler = new BookTouchHandler("left");
        right_margin_handler = new BookTouchHandler("right");
        function install_handlers(elem, handler, passive) {
            var options;
            options = (function(){
                var _d = Object.create(null);
                _d["capture"] = true;
                _d["passive"] = !!passive;
                return _d;
            }).call(this);
            elem.addEventListener("touchstart", handler.handle_touchstart, options);
            elem.addEventListener("touchmove", handler.handle_touchmove, options);
            elem.addEventListener("touchend", handler.handle_touchend, options);
            elem.addEventListener("touchcancel", handler.handle_touchcancel, options);
        };
        if (!install_handlers.__argnames__) Object.defineProperties(install_handlers, {
            __argnames__ : {value: ["elem", "handler", "passive"]},
            __module__ : {value: "read_book.touch"}
        });

        function create_handlers() {
            install_handlers(document, main_touch_handler);
            document.body.style.touchAction = "none";
        };
        if (!create_handlers.__module__) Object.defineProperties(create_handlers, {
            __module__ : {value: "read_book.touch"}
        });

        function reset_handlers() {
            main_touch_handler.reset_handlers();
        };
        if (!reset_handlers.__module__) Object.defineProperties(reset_handlers, {
            __module__ : {value: "read_book.touch"}
        });

        function set_left_margin_handler(elem) {
            install_handlers(elem, left_margin_handler);
        };
        if (!set_left_margin_handler.__argnames__) Object.defineProperties(set_left_margin_handler, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.touch"}
        });

        function set_right_margin_handler(elem) {
            install_handlers(elem, right_margin_handler);
        };
        if (!set_right_margin_handler.__argnames__) Object.defineProperties(set_right_margin_handler, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.touch"}
        });

        _modules["read_book.touch"].HOLD_THRESHOLD = HOLD_THRESHOLD;
        _modules["read_book.touch"].TAP_THRESHOLD = TAP_THRESHOLD;
        _modules["read_book.touch"].SWIPE_THRESHOLD = SWIPE_THRESHOLD;
        _modules["read_book.touch"].TAP_LINK_THRESHOLD = TAP_LINK_THRESHOLD;
        _modules["read_book.touch"].PINCH_THRESHOLD = PINCH_THRESHOLD;
        _modules["read_book.touch"].GESTURE = GESTURE;
        _modules["read_book.touch"].k = k;
        _modules["read_book.touch"].gesture_id = gesture_id;
        _modules["read_book.touch"].main_touch_handler = main_touch_handler;
        _modules["read_book.touch"].left_margin_handler = left_margin_handler;
        _modules["read_book.touch"].right_margin_handler = right_margin_handler;
        _modules["read_book.touch"].GESTURE_NAMES = GESTURE_NAMES;
        _modules["read_book.touch"].touch_id = touch_id;
        _modules["read_book.touch"].copy_touch = copy_touch;
        _modules["read_book.touch"].update_touch = update_touch;
        _modules["read_book.touch"].max_displacement = max_displacement;
        _modules["read_book.touch"].interpret_single_gesture = interpret_single_gesture;
        _modules["read_book.touch"].interpret_double_gesture = interpret_double_gesture;
        _modules["read_book.touch"].element_from_point = element_from_point;
        _modules["read_book.touch"].find_link = find_link;
        _modules["read_book.touch"].tap_on_link = tap_on_link;
        _modules["read_book.touch"].TouchHandler = TouchHandler;
        _modules["read_book.touch"].inch_in_pixels = inch_in_pixels;
        _modules["read_book.touch"].BookTouchHandler = BookTouchHandler;
        _modules["read_book.touch"].install_handlers = install_handlers;
        _modules["read_book.touch"].create_handlers = create_handlers;
        _modules["read_book.touch"].reset_handlers = reset_handlers;
        _modules["read_book.touch"].set_left_margin_handler = set_left_margin_handler;
        _modules["read_book.touch"].set_right_margin_handler = set_right_margin_handler;
    })();

    (function(){
        var __name__ = "read_book.gestures";
        var only_flow_swipe_mode_actions, only_tap_actions, default_actions_for_gesture, allowed_actions_for_two_fingers;
        var GESTURE = _modules["read_book.touch"].GESTURE;

        var opts = _modules["read_book.settings"].opts;

        var _ = _modules.gettext.gettext;

        function get_action_descriptions() {
            if (!get_action_descriptions.ans) {
                get_action_descriptions.ans = (function(){
                    var _d = Object.create(null);
                    _d["prev_page"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Previous page");
                        _d["long"] = _("Scroll to the previous page, if more than one page is displayed on the screen only a single page is scrolled");
                        return _d;
                    }).call(this);
                    _d["next_page"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Next page");
                        _d["long"] = _("Scroll to the next page, if more than one page is displayed on the screen only a single page is scrolled");
                        return _d;
                    }).call(this);
                    _d["prev_screen"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Previous screen");
                        _d["long"] = _("Scroll to the previous screen, if more than one page is displayed on the screen all pages are scrolled");
                        return _d;
                    }).call(this);
                    _d["next_screen"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Next screen");
                        _d["long"] = _("Scroll to the next screen, if more than one page is displayed on the screen all pages are scrolled");
                        return _d;
                    }).call(this);
                    _d["show_chrome"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Show controls");
                        _d["long"] = _("Show the controls for the viewer including Preferences, Go to, etc.");
                        return _d;
                    }).call(this);
                    _d["highlight_or_inspect"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Highlight or inspect");
                        _d["long"] = _("Highlight the word under the tap point or view the image under the tap or select the highlight under the tap");
                        return _d;
                    }).call(this);
                    _d["decrease_font_size"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Make text smaller");
                        _d["long"] = _("Decrease the font size");
                        return _d;
                    }).call(this);
                    _d["increase_font_size"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Make text bigger");
                        _d["long"] = _("Increase the font size");
                        return _d;
                    }).call(this);
                    _d["next_section"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Next chapter");
                        _d["long"] = _("Scroll to the start of the next section or chapter in the book");
                        return _d;
                    }).call(this);
                    _d["prev_section"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Previous chapter");
                        _d["long"] = _("Scroll to the start of the previous section or chapter in the book");
                        return _d;
                    }).call(this);
                    _d["pan"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Pan the contents");
                        _d["long"] = _("Scroll the screen contents in tandem with finger movement");
                        return _d;
                    }).call(this);
                    _d["animated_scroll"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("Flick scroll");
                        _d["long"] = _("Scroll the screen contents with momentum based on how fast you flick your finger");
                        return _d;
                    }).call(this);
                    _d["none"] = (function(){
                        var _d = Object.create(null);
                        _d["short"] = _("No action");
                        _d["long"] = _("Ignore this gesture performing no action in response to it");
                        return _d;
                    }).call(this);
                    return _d;
                }).call(this);
            }
            return get_action_descriptions.ans;
        };
        if (!get_action_descriptions.__module__) Object.defineProperties(get_action_descriptions, {
            __module__ : {value: "read_book.gestures"}
        });

        only_flow_swipe_mode_actions = (function(){
            var _d = Object.create(null);
            _d["pan"] = true;
            _d["animated_scroll"] = true;
            return _d;
        }).call(this);
        only_tap_actions = (function(){
            var _d = Object.create(null);
            _d["highlight_or_inspect"] = true;
            return _d;
        }).call(this);
        default_actions_for_gesture = (function(){
            var _d = Object.create(null);
            _d["common"] = (function(){
                var _d = Object.create(null);
                _d[GESTURE.back_zone_tap] = "prev_page";
                _d[GESTURE.forward_zone_tap] = "next_page";
                _d[GESTURE.control_zone_tap] = "show_chrome";
                _d[GESTURE.long_tap] = "highlight_or_inspect";
                _d[GESTURE.two_finger_tap] = "show_chrome";
                _d[GESTURE.pinch_in] = "decrease_font_size";
                _d[GESTURE.pinch_out] = "increase_font_size";
                return _d;
            }).call(this);
            _d["flow_mode"] = (function(){
                var _d = Object.create(null);
                _d[GESTURE.swipe_inline_backward_in_progress] = "pan";
                _d[GESTURE.swipe_inline_forward_in_progress] = "pan";
                _d[GESTURE.swipe_block_backward_in_progress] = "pan";
                _d[GESTURE.swipe_block_forward_in_progress] = "pan";
                _d[GESTURE.flick_block_forward] = "animated_scroll";
                _d[GESTURE.flick_block_backward] = "animated_scroll";
                _d[GESTURE.flick_inline_forward] = "animated_scroll";
                _d[GESTURE.flick_inline_backward] = "animated_scroll";
                return _d;
            }).call(this);
            _d["paged_mode"] = (function(){
                var _d = Object.create(null);
                _d[GESTURE.flick_block_forward] = "next_section";
                _d[GESTURE.flick_block_backward] = "prev_section";
                _d[GESTURE.flick_inline_forward] = "next_screen";
                _d[GESTURE.flick_inline_backward] = "prev_screen";
                _d[GESTURE.swipe_inline_forward_hold] = "next_screen";
                _d[GESTURE.swipe_inline_backward_hold] = "prev_screen";
                return _d;
            }).call(this);
            return _d;
        }).call(this);
        function current_action_for_gesture_type(overrides, gesture_type, in_flow_mode) {
            var mode, mode_overrides, common_overrides;
            mode = (in_flow_mode) ? "flow_mode" : "paged_mode";
            mode_overrides = overrides[(typeof mode === "number" && mode < 0) ? overrides.length + mode : mode] || Object.create(null);
            if (mode_overrides[(typeof gesture_type === "number" && gesture_type < 0) ? mode_overrides.length + gesture_type : gesture_type]) {
                return mode_overrides[(typeof gesture_type === "number" && gesture_type < 0) ? mode_overrides.length + gesture_type : gesture_type];
            }
            common_overrides = overrides.common || Object.create(null);
            if (common_overrides[(typeof gesture_type === "number" && gesture_type < 0) ? common_overrides.length + gesture_type : gesture_type]) {
                return common_overrides[(typeof gesture_type === "number" && gesture_type < 0) ? common_overrides.length + gesture_type : gesture_type];
            }
            if ((_expr_temp = default_actions_for_gesture[(typeof mode === "number" && mode < 0) ? default_actions_for_gesture.length + mode : mode])[(typeof gesture_type === "number" && gesture_type < 0) ? _expr_temp.length + gesture_type : gesture_type]) {
                return (_expr_temp = default_actions_for_gesture[(typeof mode === "number" && mode < 0) ? default_actions_for_gesture.length + mode : mode])[(typeof gesture_type === "number" && gesture_type < 0) ? _expr_temp.length + gesture_type : gesture_type];
            }
            return (_expr_temp = default_actions_for_gesture.common)[(typeof gesture_type === "number" && gesture_type < 0) ? _expr_temp.length + gesture_type : gesture_type] || "none";
        };
        if (!current_action_for_gesture_type.__argnames__) Object.defineProperties(current_action_for_gesture_type, {
            __argnames__ : {value: ["overrides", "gesture_type", "in_flow_mode"]},
            __module__ : {value: "read_book.gestures"}
        });

        function action_for_gesture(gesture, in_flow_mode) {
            return current_action_for_gesture_type(opts.gesture_overrides, gesture.type, in_flow_mode);
        };
        if (!action_for_gesture.__argnames__) Object.defineProperties(action_for_gesture, {
            __argnames__ : {value: ["gesture", "in_flow_mode"]},
            __module__ : {value: "read_book.gestures"}
        });

        function allowed_actions_for_tap() {
            return (function() {
                var _Iter = _Iterable(Object.keys(get_action_descriptions())), _Result = [], ac;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    ac = _Iter[_Index];
                    if (!only_flow_swipe_mode_actions[(typeof ac === "number" && ac < 0) ? only_flow_swipe_mode_actions.length + ac : ac]) {
                        _Result.push(ac);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!allowed_actions_for_tap.__module__) Object.defineProperties(allowed_actions_for_tap, {
            __module__ : {value: "read_book.gestures"}
        });

        function allowed_actions_for_paged_mode_swipe() {
            return (function() {
                var _Iter = _Iterable(Object.keys(get_action_descriptions())), _Result = [], ac;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    ac = _Iter[_Index];
                    if (!only_flow_swipe_mode_actions[(typeof ac === "number" && ac < 0) ? only_flow_swipe_mode_actions.length + ac : ac] && !only_tap_actions[(typeof ac === "number" && ac < 0) ? only_tap_actions.length + ac : ac]) {
                        _Result.push(ac);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!allowed_actions_for_paged_mode_swipe.__module__) Object.defineProperties(allowed_actions_for_paged_mode_swipe, {
            __module__ : {value: "read_book.gestures"}
        });

        allowed_actions_for_two_fingers = allowed_actions_for_paged_mode_swipe;
        function allowed_actions_for_flow_mode_flick() {
            return (function() {
                var _Iter = _Iterable(Object.keys(get_action_descriptions())), _Result = [], ac;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    ac = _Iter[_Index];
                    if (!only_tap_actions[(typeof ac === "number" && ac < 0) ? only_tap_actions.length + ac : ac]) {
                        _Result.push(ac);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!allowed_actions_for_flow_mode_flick.__module__) Object.defineProperties(allowed_actions_for_flow_mode_flick, {
            __module__ : {value: "read_book.gestures"}
        });

        function allowed_actions_for_flow_mode_drag() {
            return _list_decorate([ "pan", "none" ]);
        };
        if (!allowed_actions_for_flow_mode_drag.__module__) Object.defineProperties(allowed_actions_for_flow_mode_drag, {
            __module__ : {value: "read_book.gestures"}
        });

        _modules["read_book.gestures"].only_flow_swipe_mode_actions = only_flow_swipe_mode_actions;
        _modules["read_book.gestures"].only_tap_actions = only_tap_actions;
        _modules["read_book.gestures"].default_actions_for_gesture = default_actions_for_gesture;
        _modules["read_book.gestures"].allowed_actions_for_two_fingers = allowed_actions_for_two_fingers;
        _modules["read_book.gestures"].get_action_descriptions = get_action_descriptions;
        _modules["read_book.gestures"].current_action_for_gesture_type = current_action_for_gesture_type;
        _modules["read_book.gestures"].action_for_gesture = action_for_gesture;
        _modules["read_book.gestures"].allowed_actions_for_tap = allowed_actions_for_tap;
        _modules["read_book.gestures"].allowed_actions_for_paged_mode_swipe = allowed_actions_for_paged_mode_swipe;
        _modules["read_book.gestures"].allowed_actions_for_flow_mode_flick = allowed_actions_for_flow_mode_flick;
        _modules["read_book.gestures"].allowed_actions_for_flow_mode_drag = allowed_actions_for_flow_mode_drag;
    })();

    (function(){
        var __name__ = "complete";
        var ensure_id = _modules.dom.ensure_id;
        var unique_id = _modules.dom.unique_id;
        var clear = _modules.dom.clear;

        var E = _modules.elementmaker.E;

        var local_storage = _modules.session.local_storage;

        var CompletionPopup = _modules.popups.CompletionPopup;

        var uniq = _modules.utils.uniq;

        function EditWithComplete() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            EditWithComplete.prototype.__bind_methods__.call(this);
            EditWithComplete.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(EditWithComplete.prototype, "__bind_methods__", {value: function () {
            this.apply_completion = EditWithComplete.prototype.apply_completion.bind(this);
            this.onkeydown = EditWithComplete.prototype.onkeydown.bind(this);
            this.oninput = EditWithComplete.prototype.oninput.bind(this);
            this.hide_completion_popup = EditWithComplete.prototype.hide_completion_popup.bind(this);
            this.add_associated_widget = EditWithComplete.prototype.add_associated_widget.bind(this);
            this.set_all_items = EditWithComplete.prototype.set_all_items.bind(this);
        }});
        Object.defineProperties(EditWithComplete.prototype,  {
            "text_input": {
                "enumerable": true, 
                "get": function text_input() {
                    var self = this;
                    return document.getElementById(self.input_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        EditWithComplete.prototype.__init__ = function __init__() {
            var self = this;
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var placeholder = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.placeholder : arguments[1];
            var tooltip = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.tooltip : arguments[2];
            var parent = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.parent : arguments[3];
            var input_type = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.input_type : arguments[4];
            var onenterkey = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? __init__.__defaults__.onenterkey : arguments[5];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "placeholder")){
                placeholder = _kwargs_obj.placeholder;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "parent")){
                parent = _kwargs_obj.parent;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "input_type")){
                input_type = _kwargs_obj.input_type;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "onenterkey")){
                onenterkey = _kwargs_obj.onenterkey;
            }
            var inpt;
            inpt = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: input_type, name: name, title: tooltip || "", placeholder: placeholder || "", autocomplete: "off"})]);
            self.input_id = ensure_id(inpt);
            self.onenterkey = onenterkey;
            self.completion_popup = _interpolate_kwargs_constructor.call(Object.create(CompletionPopup.prototype), false, CompletionPopup, [_desugar_kwargs({parent: parent, onselect: self.apply_completion})]);
            inpt.addEventListener("keydown", self.onkeydown);
            inpt.addEventListener("input", self.oninput);
            self.completion_popup.add_associated_widget(inpt);
            if (parent) {
                parent.appendChild(inpt);
            }
        };
        if (!EditWithComplete.prototype.__init__.__defaults__) Object.defineProperties(EditWithComplete.prototype.__init__, {
            __defaults__ : {value: {placeholder:null, tooltip:null, parent:null, input_type:"text", onenterkey:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "placeholder", "tooltip", "parent", "input_type", "onenterkey"]},
            __module__ : {value: "complete"}
        });
        EditWithComplete.__argnames__ = EditWithComplete.prototype.__init__.__argnames__;
        EditWithComplete.__handles_kwarg_interpolation__ = EditWithComplete.prototype.__init__.__handles_kwarg_interpolation__;
        EditWithComplete.prototype.apply_completion = function apply_completion(text) {
            var self = this;
            var ti;
            if (text) {
                ti = self.text_input;
                ti.value = text;
                ti.focus();
                return true;
            }
        };
        if (!EditWithComplete.prototype.apply_completion.__argnames__) Object.defineProperties(EditWithComplete.prototype.apply_completion, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "complete"}
        });
        EditWithComplete.prototype.onkeydown = function onkeydown(event) {
            var self = this;
            var ti;
            if (self.completion_popup.is_visible && self.completion_popup.handle_keydown(event)) {
                [event.preventDefault(), event.stopPropagation()];
                return;
            }
            if (event.key === "Enter") {
                if (self.completion_popup.is_visible) {
                    if (self.apply_completion(self.completion_popup.current_text)) {
                        self.completion_popup.hide();
                        [event.preventDefault(), event.stopPropagation()];
                        return;
                    }
                }
                if (self.onenterkey) {
                    [event.preventDefault(), event.stopPropagation()];
                    self.onenterkey();
                }
            } else if (event.key === "Tab") {
                if (self.completion_popup.is_visible) {
                    if (self.apply_completion(self.completion_popup.current_text)) {
                        self.completion_popup.hide();
                    } else {
                        self.completion_popup.move_highlight();
                    }
                    [event.preventDefault(), event.stopPropagation()];
                }
            } else if (event.key === "ArrowDown") {
                ti = self.text_input;
                if (!ti.value) {
                    self.completion_popup.set_query("");
                    self.completion_popup.popup(ti);
                    [event.preventDefault(), event.stopPropagation()];
                }
            }
        };
        if (!EditWithComplete.prototype.onkeydown.__argnames__) Object.defineProperties(EditWithComplete.prototype.onkeydown, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "complete"}
        });
        EditWithComplete.prototype.oninput = function oninput(event) {
            var self = this;
            var ti;
            ti = self.text_input;
            self.completion_popup.set_query(ti.value || "");
            self.completion_popup.popup(ti);
        };
        if (!EditWithComplete.prototype.oninput.__argnames__) Object.defineProperties(EditWithComplete.prototype.oninput, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "complete"}
        });
        EditWithComplete.prototype.hide_completion_popup = function hide_completion_popup() {
            var self = this;
            self.completion_popup.hide();
        };
        if (!EditWithComplete.prototype.hide_completion_popup.__module__) Object.defineProperties(EditWithComplete.prototype.hide_completion_popup, {
            __module__ : {value: "complete"}
        });
        EditWithComplete.prototype.add_associated_widget = function add_associated_widget(widget_or_id) {
            var self = this;
            self.completion_popup.add_associated_widget(widget_or_id);
        };
        if (!EditWithComplete.prototype.add_associated_widget.__argnames__) Object.defineProperties(EditWithComplete.prototype.add_associated_widget, {
            __argnames__ : {value: ["widget_or_id"]},
            __module__ : {value: "complete"}
        });
        EditWithComplete.prototype.set_all_items = function set_all_items(items) {
            var self = this;
            self.completion_popup.set_all_items(items);
        };
        if (!EditWithComplete.prototype.set_all_items.__argnames__) Object.defineProperties(EditWithComplete.prototype.set_all_items, {
            __argnames__ : {value: ["items"]},
            __module__ : {value: "complete"}
        });
        EditWithComplete.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        EditWithComplete.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(EditWithComplete.prototype, "__bases__", {value: []});
        

        function create_search_bar() {
            var action = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var name = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var tooltip = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_search_bar.__defaults__.tooltip : arguments[2];
            var placeholder = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_search_bar.__defaults__.placeholder : arguments[3];
            var button = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_search_bar.__defaults__.button : arguments[4];
            var history_size = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_search_bar.__defaults__.history_size : arguments[5];
            var associated_widgets = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_search_bar.__defaults__.associated_widgets : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "placeholder")){
                placeholder = _kwargs_obj.placeholder;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "button")){
                button = _kwargs_obj.button;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "history_size")){
                history_size = _kwargs_obj.history_size;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "associated_widgets")){
                associated_widgets = _kwargs_obj.associated_widgets;
            }
            var parent, ewc, history_name, w;
            parent = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:flex"})]);
            ewc = _interpolate_kwargs_constructor.call(Object.create(EditWithComplete.prototype), false, EditWithComplete, [name].concat([_desugar_kwargs({parent: parent, tooltip: tooltip, placeholder: placeholder, input_type: "search"})]));
            parent.lastChild.style.width = "100%";
            history_name = "search-bar-history-" + name;
            function update_completion_items() {
                var items;
                items = local_storage().get(history_name);
                if ((typeof items !== "undefined" && items !== null ? items : Object.create(null)).length) {
                    ewc.set_all_items(items);
                }
            };
            if (!update_completion_items.__module__) Object.defineProperties(update_completion_items, {
                __module__ : {value: "complete"}
            });

            update_completion_items();
            function trigger() {
                var text, items, idx;
                text = ewc.text_input.value;
                ewc.hide_completion_popup();
                action(text);
                if (text && text.strip()) {
                    items = local_storage().get(history_name) || [];
                    idx = items.indexOf(text);
                    if (idx > -1) {
                        items.splice(idx, 1);
                    }
                    items.unshift(text);
                    local_storage().set(history_name, uniq(items.slice(0, history_size)));
                    update_completion_items();
                }
            };
            if (!trigger.__module__) Object.defineProperties(trigger, {
                __module__ : {value: "complete"}
            });

            ewc.onenterkey = trigger;
            parent.querySelector("input").addEventListener("search", trigger);
            if (button) {
                ewc.add_associated_widget(button);
                button.addEventListener("click", trigger);
            }
            if (associated_widgets !== null) {
                var _Iter0 = _Iterable(associated_widgets);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    w = _Iter0[_Index0];
                    ewc.add_associated_widget(w);
                }
            }
            return parent;
        };
        if (!create_search_bar.__defaults__) Object.defineProperties(create_search_bar, {
            __defaults__ : {value: {tooltip:null, placeholder:null, button:null, history_size:100, associated_widgets:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["action", "name", "tooltip", "placeholder", "button", "history_size", "associated_widgets"]},
            __module__ : {value: "complete"}
        });

        function create_simple_input_with_history_native() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var tooltip = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history_native.__defaults__.tooltip : arguments[1];
            var placeholder = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history_native.__defaults__.placeholder : arguments[2];
            var history_size = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history_native.__defaults__.history_size : arguments[3];
            var input_type = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history_native.__defaults__.input_type : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "placeholder")){
                placeholder = _kwargs_obj.placeholder;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "history_size")){
                history_size = _kwargs_obj.history_size;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "input_type")){
                input_type = _kwargs_obj.input_type;
            }
            var dl_id, dl, history_name, ans;
            dl_id = unique_id();
            dl = document.createElement("datalist");
            dl.id = dl_id;
            history_name = "simple_input_history_" + _str.format("{}", name) + "";
            function update_completion_items(x) {
                var items, dl, item;
                items = local_storage().get(history_name);
                dl = x || document.getElementById(dl_id);
                if (dl) {
                    clear(dl);
                    if ((typeof items !== "undefined" && items !== null ? items : Object.create(null)).length) {
                        var _Iter1 = _Iterable(items);
                        for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                            item = _Iter1[_Index1];
                            dl.appendChild(_interpolate_kwargs.call(E, E.option, [_desugar_kwargs({value: item})]));
                        }
                    }
                }
            };
            if (!update_completion_items.__argnames__) Object.defineProperties(update_completion_items, {
                __argnames__ : {value: ["x"]},
                __module__ : {value: "complete"}
            });

            function save_completion_items() {
                var text, items, idx;
                text = document.getElementById(dl_id).nextSibling.value;
                if (text && text.strip()) {
                    items = local_storage().get(history_name) || [];
                    idx = items.indexOf(text);
                    if (idx > -1) {
                        items.splice(idx, 1);
                    }
                    items.unshift(text);
                    local_storage().set(history_name, uniq(items.slice(0, history_size)));
                    update_completion_items();
                }
            };
            if (!save_completion_items.__module__) Object.defineProperties(save_completion_items, {
                __module__ : {value: "complete"}
            });

            update_completion_items(dl);
            ans = _interpolate_kwargs.call(E, E.span, [dl, _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: input_type, name: name, list: dl_id, title: tooltip || "", placeholder: placeholder || ""})])].concat([_desugar_kwargs({data_calibre_history_input: "1"})]));
            ans.addEventListener("save_history", save_completion_items);
            return ans;
        };
        if (!create_simple_input_with_history_native.__defaults__) Object.defineProperties(create_simple_input_with_history_native, {
            __defaults__ : {value: {tooltip:null, placeholder:null, history_size:100, input_type:"text"}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "tooltip", "placeholder", "history_size", "input_type"]},
            __module__ : {value: "complete"}
        });

        function create_simple_input_with_history() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var tooltip = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history.__defaults__.tooltip : arguments[1];
            var placeholder = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history.__defaults__.placeholder : arguments[2];
            var history_size = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history.__defaults__.history_size : arguments[3];
            var input_type = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_simple_input_with_history.__defaults__.input_type : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "placeholder")){
                placeholder = _kwargs_obj.placeholder;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "history_size")){
                history_size = _kwargs_obj.history_size;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "input_type")){
                input_type = _kwargs_obj.input_type;
            }
            var parent, ewc, history_name;
            parent = _interpolate_kwargs.call(E, E.span, [_desugar_kwargs({data_calibre_history_input: "1"})]);
            ewc = _interpolate_kwargs_constructor.call(Object.create(EditWithComplete.prototype), false, EditWithComplete, [name].concat([_desugar_kwargs({parent: parent, tooltip: tooltip, placeholder: placeholder, input_type: input_type})]));
            history_name = "simple_input_history_" + _str.format("{}", name) + "";
            function update_completion_items() {
                var items;
                items = local_storage().get(history_name);
                if ((typeof items !== "undefined" && items !== null ? items : Object.create(null)).length) {
                    ewc.set_all_items(items);
                }
            };
            if (!update_completion_items.__module__) Object.defineProperties(update_completion_items, {
                __module__ : {value: "complete"}
            });

            update_completion_items();
            function save_completion_items() {
                var text, items, idx;
                text = ewc.text_input.value;
                if (text && text.strip()) {
                    items = local_storage().get(history_name) || [];
                    idx = items.indexOf(text);
                    if (idx > -1) {
                        items.splice(idx, 1);
                    }
                    items.unshift(text);
                    local_storage().set(history_name, uniq(items.slice(0, history_size)));
                    update_completion_items();
                }
            };
            if (!save_completion_items.__module__) Object.defineProperties(save_completion_items, {
                __module__ : {value: "complete"}
            });

            parent.addEventListener("save_history", save_completion_items);
            return parent;
        };
        if (!create_simple_input_with_history.__defaults__) Object.defineProperties(create_simple_input_with_history, {
            __defaults__ : {value: {tooltip:null, placeholder:null, history_size:100, input_type:"text"}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "tooltip", "placeholder", "history_size", "input_type"]},
            __module__ : {value: "complete"}
        });

        function main(container) {
            container.appendChild(_interpolate_kwargs.call(this, create_search_bar, [print, "test-search-bar"].concat([_desugar_kwargs({placeholder: "Testing search bar"})])));
            container.firstChild.lastChild.focus();
        };
        if (!main.__argnames__) Object.defineProperties(main, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "complete"}
        });

        _modules.complete.EditWithComplete = EditWithComplete;
        _modules.complete.create_search_bar = create_search_bar;
        _modules.complete.create_simple_input_with_history_native = create_simple_input_with_history_native;
        _modules.complete.create_simple_input_with_history = create_simple_input_with_history;
        _modules.complete.main = main;
    })();

    (function(){
        var __name__ = "read_book.highlights";
        var ICON_SIZE_VAL, ICON_SIZE_UNIT, ICON_SIZE, builtin_colors_light, builtin_colors_dark, builtin_decorations_light, builtin_decorations_dark, all_style_keys, url_pat, closing_bracket_map, opening_brackets;
        var E = _modules.elementmaker.E;

        var encode_query = _modules.ajax.encode_query;

        var get_current_query = _modules["book_list.globals"].get_current_query;
        var get_session_data = _modules["book_list.globals"].get_session_data;

        var get_color = _modules["book_list.theme"].get_color;

        var create_search_bar = _modules.complete.create_search_bar;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;
        var ngettext = _modules.gettext.ngettext;

        var create_custom_dialog = _modules.modals.create_custom_dialog;
        var error_dialog = _modules.modals.error_dialog;
        var get_text_dialog = _modules.modals.get_text_dialog;
        var question_dialog = _modules.modals.question_dialog;
        var warning_dialog = _modules.modals.warning_dialog;

        var current_book = _modules["read_book.globals"].current_book;
        var is_dark_theme = _modules["read_book.globals"].is_dark_theme;
        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button = _modules.widgets.create_button;

        ICON_SIZE_VAL = 3;
        ICON_SIZE_UNIT = "ex";
        ICON_SIZE = "" + _str.format("{}", ICON_SIZE_VAL) + "" + _str.format("{}", ICON_SIZE_UNIT) + "";
        builtin_colors_light = {"yellow": "#ffeb6b", "green": "#c0ed72", "blue": "#add8ff", "red": "#ffb0ca", "purple": "#d9b2ff"};
        builtin_colors_dark = {"yellow": "#906e00", "green": "#306f50", "blue": "#265589", "red": "#a23e5a", "purple": "#505088"};
        builtin_decorations_light = builtin_decorations_dark = {"wavy": {"text-decoration-style": "wavy", "text-decoration-color": "red", "text-decoration-line": "underline"}, "strikeout": {"text-decoration-line": "line-through", "text-decoration-color": "red"}};
        function builtin_friendly_name(kind, which) {
            if (kind === "color") {
                return (_expr_temp = (function(){
                    var _d = Object.create(null);
                    _d["yellow"] = _("Yellow highlight");
                    _d["green"] = _("Green highlight");
                    _d["blue"] = _("Blue highlight");
                    _d["red"] = _("Pink highlight");
                    _d["purple"] = _("Purple highlight");
                    return _d;
                }).call(this))[(typeof which === "number" && which < 0) ? _expr_temp.length + which : which] || _("Unknown highlight");
            }
            return (_expr_temp = (function(){
                var _d = Object.create(null);
                _d["wavy"] = _("Red wavy underline");
                _d["strikeout"] = _("Red strikeout");
                return _d;
            }).call(this))[(typeof which === "number" && which < 0) ? _expr_temp.length + which : which] || _("Unknown underline");
        };
        if (!builtin_friendly_name.__argnames__) Object.defineProperties(builtin_friendly_name, {
            __argnames__ : {value: ["kind", "which"]},
            __module__ : {value: "read_book.highlights"}
        });

        function builtin_color(which, is_dark) {
            return ((is_dark) ? builtin_colors_dark[(typeof which === "number" && which < 0) ? builtin_colors_dark.length + which : which] : builtin_colors_light[(typeof which === "number" && which < 0) ? builtin_colors_light.length + which : which]) || builtin_colors_light.yellow;
        };
        if (!builtin_color.__argnames__) Object.defineProperties(builtin_color, {
            __argnames__ : {value: ["which", "is_dark"]},
            __module__ : {value: "read_book.highlights"}
        });

        function default_color(is_dark) {
            return builtin_color("yellow", is_dark);
        };
        if (!default_color.__argnames__) Object.defineProperties(default_color, {
            __argnames__ : {value: ["is_dark"]},
            __module__ : {value: "read_book.highlights"}
        });

        function all_builtin_styles() {
            var ans, col, which;
            ans = [];
            var _Iter0 = _Iterable(builtin_colors_light);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                col = _Iter0[_Index0];
                ans.push((function(){
                    var _d = Object.create(null);
                    _d["type"] = "builtin";
                    _d["kind"] = "color";
                    _d["which"] = col;
                    return _d;
                }).call(this));
            }
            var _Iter1 = _Iterable(builtin_decorations_light);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                which = _Iter1[_Index1];
                ans.push((function(){
                    var _d = Object.create(null);
                    _d["type"] = "builtin";
                    _d["kind"] = "decoration";
                    _d["which"] = which;
                    return _d;
                }).call(this));
            }
            return ans;
        };
        if (!all_builtin_styles.__module__) Object.defineProperties(all_builtin_styles, {
            __module__ : {value: "read_book.highlights"}
        });

        all_style_keys = 'type kind which light dark background-color text-decoration-line text-decoration-color text-decoration-style'.split(' ');
        function custom_color_theme(name, lightbg, darkbg) {
            return (function(){
                var _d = Object.create(null);
                _d["type"] = "custom";
                _d["kind"] = "color";
                _d["light"] = lightbg;
                _d["dark"] = darkbg;
                _d["friendly_name"] = name;
                return _d;
            }).call(this);
        };
        if (!custom_color_theme.__argnames__) Object.defineProperties(custom_color_theme, {
            __argnames__ : {value: ["name", "lightbg", "darkbg"]},
            __module__ : {value: "read_book.highlights"}
        });

        function custom_decoration_theme(name, line_position, line_style, line_color) {
            return (function(){
                var _d = Object.create(null);
                _d["type"] = "custom";
                _d["kind"] = "decoration";
                _d["text-decoration-line"] = line_position;
                _d["text-decoration-style"] = line_style;
                _d["text-decoration-color"] = line_color;
                _d["friendly_name"] = name;
                return _d;
            }).call(this);
        };
        if (!custom_decoration_theme.__argnames__) Object.defineProperties(custom_decoration_theme, {
            __argnames__ : {value: ["name", "line_position", "line_style", "line_color"]},
            __module__ : {value: "read_book.highlights"}
        });

        function style_key(style) {
            return (function() {
                var _Iter = _Iterable(all_style_keys), _Result = [], k;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    k = _Iter[_Index];
                    _Result.push("" + _str.format("{}", k) + ":" + _str.format("{}", style[(typeof k === "number" && k < 0) ? style.length + k : k]) + "");
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })().join(";");
        };
        if (!style_key.__argnames__) Object.defineProperties(style_key, {
            __argnames__ : {value: ["style"]},
            __module__ : {value: "read_book.highlights"}
        });

        function HighlightStyle() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            HighlightStyle.prototype.__bind_methods__.call(this);
            HighlightStyle.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(HighlightStyle.prototype, "__bind_methods__", {value: function () {
            this.make_swatch = HighlightStyle.prototype.make_swatch.bind(this);
            this.highlight_shade = HighlightStyle.prototype.highlight_shade.bind(this);
            this.serialized = HighlightStyle.prototype.serialized.bind(this);
        }});
        Object.defineProperties(HighlightStyle.prototype,  {
            "friendly_name": {
                "enumerable": true, 
                "get": function friendly_name() {
                    var self = this;
                    var s;
                    s = self.style;
                    if (s.type === "builtin") {
                        return builtin_friendly_name(s.kind, s.which);
                    }
                    return s.friendly_name || _("Custom style");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        HighlightStyle.prototype.__init__ = function __init__(style) {
            var self = this;
            if (typeof style === "string") {
                style = JSON.parse(style);
            }
            self.style = style || (function(){
                var _d = Object.create(null);
                _d["type"] = "builtin";
                _d["kind"] = "color";
                _d["which"] = "yellow";
                return _d;
            }).call(this);
            self.key = style_key(self.style);
        };
        if (!HighlightStyle.prototype.__init__.__argnames__) Object.defineProperties(HighlightStyle.prototype.__init__, {
            __argnames__ : {value: ["style"]},
            __module__ : {value: "read_book.highlights"}
        });
        HighlightStyle.__argnames__ = HighlightStyle.prototype.__init__.__argnames__;
        HighlightStyle.__handles_kwarg_interpolation__ = HighlightStyle.prototype.__init__.__handles_kwarg_interpolation__;
        HighlightStyle.prototype.make_swatch = function make_swatch(container, is_dark) {
            var self = this;
            var style, s, br, tdl, tds, tdc, q, bg;
            style = container.style;
            style.width = style.height = style.minimumWidth = style.minimumHeight = style.maximumWidth = style.maximumHeight = ICON_SIZE;
            s = self.style;
            br = ICON_SIZE_VAL / 4;
            if (s.kind === "decoration") {
                tdl = tds = tdc = null;
                if (s.type === "builtin") {
                    q = (is_dark) ? builtin_decorations_dark[_bound_index(s.which, builtin_decorations_dark)] : builtin_decorations_dark[_bound_index(s.which, builtin_decorations_dark)];
                } else {
                    q = s;
                }
                tdl = q["text-decoration-line"] || null;
                tds = q["text-decoration-style"] || null;
                tdc = q["text-decoration-color"] || null;
                container.textContent = "ab";
                style.paddingLeft = style.paddingRight = style.paddingTop = style.paddingBottom = "0.25ex";
                style.borderStyle = "solid";
                style.borderWidth = "1px";
                style.borderRadius = "" + _str.format("{}", br) + "" + _str.format("{}", ICON_SIZE_UNIT) + "";
                style.fontSize = "smaller";
                style.fontWeight = "bold";
                if (tdl) {
                    style.textDecorationLine = tdl;
                }
                if (tds) {
                    style.textDecorationStyle = tds;
                }
                if (tdc) {
                    style.textDecorationColor = tdc;
                }
                return container;
            }
            bg = null;
            if (s.type === "builtin") {
                bg = builtin_color(s.which, is_dark);
            } else if (s.type === "custom") {
                bg = (is_dark) ? s.dark : s.light;
            }
            if (bg === null && s["background-color"]) {
                bg = s["background-color"];
            }
            if (bg) {
                style.backgroundColor = bg;
                style.borderRadius = "" + _str.format("{}", br) + "" + _str.format("{}", ICON_SIZE_UNIT) + "";
            }
            return container;
        };
        if (!HighlightStyle.prototype.make_swatch.__argnames__) Object.defineProperties(HighlightStyle.prototype.make_swatch, {
            __argnames__ : {value: ["container", "is_dark"]},
            __module__ : {value: "read_book.highlights"}
        });
        HighlightStyle.prototype.highlight_shade = function highlight_shade(is_dark) {
            var self = this;
            var s, defs;
            s = self.style;
            if (s.kind === "decoration") {
                if (s.type === "builtin") {
                    defs = (is_dark) ? builtin_decorations_dark[_bound_index(s.which, builtin_decorations_dark)] : builtin_decorations_light[_bound_index(s.which, builtin_decorations_light)];
                } else {
                    defs = s;
                }
                return defs["text-decoration-color"] || "red";
            }
            if (s.type === "builtin") {
                return builtin_color(s.which, is_dark);
            }
            if (s.type === "custom") {
                return (is_dark) ? s.dark : s.light;
            }
            return s["background-color"] || default_color(is_dark);
        };
        if (!HighlightStyle.prototype.highlight_shade.__argnames__) Object.defineProperties(HighlightStyle.prototype.highlight_shade, {
            __argnames__ : {value: ["is_dark"]},
            __module__ : {value: "read_book.highlights"}
        });
        HighlightStyle.prototype.serialized = function serialized() {
            var self = this;
            return JSON.stringify(self.style);
        };
        if (!HighlightStyle.prototype.serialized.__module__) Object.defineProperties(HighlightStyle.prototype.serialized, {
            __module__ : {value: "read_book.highlights"}
        });
        HighlightStyle.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        HighlightStyle.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(HighlightStyle.prototype, "__bases__", {value: []});
        

        function highlight_style_as_css(s, is_dark, foreground) {
            function styler(node) {
                var keys, bg, fg;
                function set(name, val) {
                    if (val) {
                        node.style.setProperty(name, val, "important");
                    }
                };
                if (!set.__argnames__) Object.defineProperties(set, {
                    __argnames__ : {value: ["name", "val"]},
                    __module__ : {value: "read_book.highlights"}
                });

                if (s.kind === "decoration") {
                    if (s.type === "builtin") {
                        keys = (is_dark) ? builtin_decorations_dark[_bound_index(s.which, builtin_decorations_dark)] : builtin_decorations_light[_bound_index(s.which, builtin_decorations_light)];
                    } else {
                        keys = s;
                    }
                    set("text-decoration-line", keys["text-decoration-line"]);
                    set("text-decoration-color", keys["text-decoration-color"]);
                    set("text-decoration-style", keys["text-decoration-style"]);
                    return;
                }
                bg = null;
                fg = foreground || null;
                if (s.type === "builtin") {
                    bg = builtin_color(s.which, is_dark);
                } else if (s.type === "custom") {
                    bg = (is_dark) ? s.dark : s.light;
                } else if (s.color) {
                    fg = s.color;
                }
                set("background-color", bg || s["background-color"] || default_color(is_dark));
                set("color", fg || s.color || foreground);
            };
            if (!styler.__argnames__) Object.defineProperties(styler, {
                __argnames__ : {value: ["node"]},
                __module__ : {value: "read_book.highlights"}
            });

            return styler;
        };
        if (!highlight_style_as_css.__argnames__) Object.defineProperties(highlight_style_as_css, {
            __argnames__ : {value: ["s", "is_dark", "foreground"]},
            __module__ : {value: "read_book.highlights"}
        });

        function custom_styles_equal(a, b) {
            var seen, k;
            seen = Object.create(null);
            var _Iter2 = _Iterable(a);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                k = _Iter2[_Index2];
                seen[(typeof k === "number" && k < 0) ? seen.length + k : k] = true;
                if (a[(typeof k === "number" && k < 0) ? a.length + k : k] !== b[(typeof k === "number" && k < 0) ? b.length + k : k]) {
                    return false;
                }
            }
            var _Iter3 = _Iterable(b);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                k = _Iter3[_Index3];
                if (!seen[(typeof k === "number" && k < 0) ? seen.length + k : k]) {
                    if (a[(typeof k === "number" && k < 0) ? a.length + k : k] !== b[(typeof k === "number" && k < 0) ? b.length + k : k]) {
                        return false;
                    }
                }
            }
            return true;
        };
        if (!custom_styles_equal.__argnames__) Object.defineProperties(custom_styles_equal, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "read_book.highlights"}
        });

        function all_styles() {
            var ans, custom_highlight_styles, raw;
            ans = [];
            custom_highlight_styles = get_session_data().get("custom_highlight_styles");
            var _Iter4 = _Iterable(custom_highlight_styles);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                raw = _Iter4[_Index4];
                ans.push(new HighlightStyle(raw));
            }
            var _Iter5 = _Iterable(all_builtin_styles());
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                raw = _Iter5[_Index5];
                ans.push(new HighlightStyle(raw));
            }
            return ans;
        };
        if (!all_styles.__module__) Object.defineProperties(all_styles, {
            __module__ : {value: "read_book.highlights"}
        });

        function AddStyle() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            AddStyle.prototype.__bind_methods__.call(this);
            AddStyle.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(AddStyle.prototype, "__bind_methods__", {value: function () {
            this.focus = AddStyle.prototype.focus.bind(this);
            this.init = AddStyle.prototype.init.bind(this);
            this.change_type = AddStyle.prototype.change_type.bind(this);
        }});
        Object.defineProperties(AddStyle.prototype,  {
            "style_type": {
                "enumerable": true, 
                "get": function style_type() {
                    var self = this;
                    return self.get_container().querySelector("input[name=style_type]:checked").value;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "color_type": {
                "enumerable": true, 
                "get": function color_type() {
                    var self = this;
                    return self.get_container().querySelector("input[name=color_type]:checked").value;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "friendly_name": {
                "enumerable": true, 
                "get": function friendly_name() {
                    var self = this;
                    return self.get_container().querySelector("input[name=friendly_name]").value;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "created_style": {
                "enumerable": true, 
                "get": function created_style() {
                    var self = this;
                    var c, name, col;
                    c = self.get_container();
                    name = self.friendly_name;
                    if (self.style_type === "color") {
                        return custom_color_theme(name, c.querySelector("input[name=light_color]").value, c.querySelector("input[name=dark_color]").value);
                    }
                    if (self.color_type === "currentColor") {
                        col = "currentColor";
                    } else {
                        col = c.querySelector("input[name=decoration_color]").value;
                    }
                    return custom_decoration_theme(name, c.querySelector("select[name=text_decoration_line]").value, c.querySelector("select[name=text_decoration_style]").value, col);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        AddStyle.prototype.__init__ = function __init__(get_container, hide_self) {
            var self = this;
            self.get_container = get_container;
            self.hide_self = hide_self;
            function onkeydown(ev) {
                ev.stopPropagation();
                if (ev.key === "Escape") {
                    hide_self(null);
                }
            };
            if (!onkeydown.__argnames__) Object.defineProperties(onkeydown, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "read_book.highlights"}
            });

            get_container().appendChild(_interpolate_kwargs.call(E, E.div, [E.div(_("Style name:"), " ", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "friendly_name", onkeydown: onkeydown, placeholder: _("Name for this style")})])), E.div(""), E.div(_("Type of style:"), " ", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "style_type", value: "color", onchange: self.change_type, checked: true})]), _("Color")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "style_type", value: "decoration", onchange: self.change_type})]), _("Underline"))), _interpolate_kwargs.call(E, E.div, [E.div(E.label(_("Color for light color themes: "), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "color", name: "light_color", value: "#ffff00"})]))), E.div(""), E.div(E.label(_("Color for dark color themes: "), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "color", name: "dark_color", value: "#cccc00"})])))].concat([_desugar_kwargs({name: "color-container", style: "margin-top:1rem; border-top: solid; padding-top: 1rem"})])), _interpolate_kwargs.call(E, E.div, [E.div(_("Color for the line: "), E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "color_type", value: "currentColor", checked: true})]), _("Text color")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "color_type", value: "custom_color"})]), _("Custom color:")), "", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "color", name: "decoration_color", value: "#ff0000", onchange: (function() {
                var _anonfunc = function () {
                    self.get_container().querySelector("input[value=custom_color]").checked = true;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })()})])), E.div(""), E.div(E.label(_("Position of line: "), _interpolate_kwargs.call(E, E.select, [_interpolate_kwargs.call(E, E.option, [_("Underline")].concat([_desugar_kwargs({value: "underline"})])), _interpolate_kwargs.call(E, E.option, [_("Over-line")].concat([_desugar_kwargs({value: "overline"})])), _interpolate_kwargs.call(E, E.option, [_("Strikeout")].concat([_desugar_kwargs({value: "strike-through"})]))].concat([_desugar_kwargs({name: "text_decoration_line"})])))), E.div(""), E.div(E.label(_("Style of line: "), _interpolate_kwargs.call(E, E.select, [_interpolate_kwargs.call(E, E.option, [_("Solid")].concat([_desugar_kwargs({value: "solid"})])), _interpolate_kwargs.call(E, E.option, [_("Double")].concat([_desugar_kwargs({value: "double"})])), _interpolate_kwargs.call(E, E.option, [_("Dotted")].concat([_desugar_kwargs({value: "dotted"})])), _interpolate_kwargs.call(E, E.option, [_("Dashed")].concat([_desugar_kwargs({value: "dashed"})])), _interpolate_kwargs.call(E, E.option, [_("Wavy")].concat([_desugar_kwargs({value: "wavy"})]))].concat([_desugar_kwargs({name: "text_decoration_style"})]))))].concat([_desugar_kwargs({name: "decoration-container", style: "margin-top:1rem; border-top: solid; padding-top: 1rem"})])), _interpolate_kwargs.call(E, E.div, [create_button(_("Discard"), "close", (function() {
                var _anonfunc = function (ev) {
                    ev.stopPropagation();
                    hide_self(null);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })()), create_button(_("Save"), "check", (function() {
                var _anonfunc = function (ev) {
                    ev.stopPropagation();
                    if (!self.friendly_name) {
                        return _interpolate_kwargs.call(this, error_dialog, [_("No name specified"), _("You must give your custom style a name")].concat([_desugar_kwargs({on_close: self.focus})]));
                    }
                    hide_self(self.created_style);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })())].concat([_desugar_kwargs({style: "margin-top:1rem; border-top: solid; padding-top: 1rem; display: flex; width: 100%; justify-content: space-between"})]))].concat([_desugar_kwargs({style: "margin: 1rem; text-align: left"})])));
            self.change_type();
        };
        if (!AddStyle.prototype.__init__.__argnames__) Object.defineProperties(AddStyle.prototype.__init__, {
            __argnames__ : {value: ["get_container", "hide_self"]},
            __module__ : {value: "read_book.highlights"}
        });
        AddStyle.__argnames__ = AddStyle.prototype.__init__.__argnames__;
        AddStyle.__handles_kwarg_interpolation__ = AddStyle.prototype.__init__.__handles_kwarg_interpolation__;
        AddStyle.prototype.focus = function focus() {
            var self = this;
            self.get_container().querySelector("input[name=friendly_name]").focus();
        };
        if (!AddStyle.prototype.focus.__module__) Object.defineProperties(AddStyle.prototype.focus, {
            __module__ : {value: "read_book.highlights"}
        });
        AddStyle.prototype.init = function init() {
            var self = this;
            self.get_container().querySelector("input[name=friendly_name]").value = "";
            self.focus();
        };
        if (!AddStyle.prototype.init.__module__) Object.defineProperties(AddStyle.prototype.init, {
            __module__ : {value: "read_book.highlights"}
        });
        AddStyle.prototype.change_type = function change_type() {
            var self = this;
            var c, q;
            c = self.get_container();
            q = self.style_type;
            c.querySelector("[name=color-container]").style.display = (q === "color") ? "block" : "none";
            c.querySelector("[name=decoration-container]").style.display = (q === "decoration") ? "block" : "none";
        };
        if (!AddStyle.prototype.change_type.__module__) Object.defineProperties(AddStyle.prototype.change_type, {
            __module__ : {value: "read_book.highlights"}
        });
        AddStyle.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        AddStyle.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(AddStyle.prototype, "__bases__", {value: []});
        
        
        
        

        function EditNotesAndColors() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            EditNotesAndColors.prototype.__bind_methods__.call(this);
            EditNotesAndColors.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(EditNotesAndColors.prototype, "__bind_methods__", {value: function () {
            this.hide_add_style = EditNotesAndColors.prototype.hide_add_style.bind(this);
            this.add_new_style = EditNotesAndColors.prototype.add_new_style.bind(this);
            this.set_visibility_of_remove_button = EditNotesAndColors.prototype.set_visibility_of_remove_button.bind(this);
            this.add_color = EditNotesAndColors.prototype.add_color.bind(this);
            this.remove_custom_color = EditNotesAndColors.prototype.remove_custom_color.bind(this);
            this.do_remove_custom_color = EditNotesAndColors.prototype.do_remove_custom_color.bind(this);
            this.change_color = EditNotesAndColors.prototype.change_color.bind(this);
            this.make_swatch_current = EditNotesAndColors.prototype.make_swatch_current.bind(this);
        }});
        Object.defineProperties(EditNotesAndColors.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.container_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "notes_edit": {
                "enumerable": true, 
                "get": function notes_edit() {
                    var self = this;
                    return self.container.getElementsByTagName("textarea")[0];
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_notes": {
                "enumerable": true, 
                "get": function current_notes() {
                    var self = this;
                    return self.notes_edit.value || "";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_style": {
                "enumerable": true, 
                "get": function current_style() {
                    var self = this;
                    var style;
                    style = self.container.getElementsByClassName("current-swatch")[0].dataset.style;
                    return new HighlightStyle(JSON.parse(style));
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        EditNotesAndColors.prototype.__init__ = function __init__(container, is_dark_theme, current_notes, current_style, annot_id, close_editor) {
            var self = this;
            var remove_button, apply_button, stop_propagation, c, custom_highlight_styles, raw, parent;
            self.initial_style = current_style;
            self.is_dark_theme = is_dark_theme;
            self.annot_id = annot_id;
            function finish() {
                close_editor(true);
            };
            if (!finish.__module__) Object.defineProperties(finish, {
                __module__ : {value: "read_book.highlights"}
            });

            function abort() {
                close_editor(false);
            };
            if (!abort.__module__) Object.defineProperties(abort, {
                __module__ : {value: "read_book.highlights"}
            });

            function handle_keypress(ev) {
                ev.stopPropagation();
                if (ev.key === "Escape") {
                    abort();
                } else if (ev.key === "Enter" && ev.ctrlKey) {
                    finish();
                }
            };
            if (!handle_keypress.__argnames__) Object.defineProperties(handle_keypress, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "read_book.highlights"}
            });

            remove_button = create_button(_("Remove style"), "trash", self.remove_custom_color, _("Remove this custom highlight style"));
            remove_button.classList.add("remove-custom-color");
            apply_button = create_button((self.annot_id) ? _("Apply") : _("Create"), "check", finish, ((self.annot_id) ? _("Finish editing highlight") : _("Create highlight")) + " [Ctrl+Enter]", true);
            apply_button.style.marginLeft = apply_button.style.marginTop = "auto";
            stop_propagation = (function() {
                var _anonfunc = function (ev) {
                    ev.stopPropagation();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })();
            c = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.textarea, [_desugar_kwargs({placeholder: _("Add notes for this highlight. Double click or long tap on a highlight to read its notes."), rows: "10", spellcheck: "true", style: "width: 90%;", onkeydown: handle_keypress})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "color-block", style: "display: flex; flex-wrap: wrap; width: 100%; justify-content: center"})]), _interpolate_kwargs.call(E, E.div, [create_button(_("Cancel"), "close", abort, _("Abort") + " [Esc]"), E.span(""), remove_button, apply_button].concat([_desugar_kwargs({style: "width: 100%; display: flex; flex-wrap: wrap"})]))].concat([_desugar_kwargs({ontouchstart: stop_propagation, ontouchmove: stop_propagation, ontouchend: stop_propagation, ontouchcancel: stop_propagation, oncontextmenu: stop_propagation})]))].concat([_desugar_kwargs({style: "background: " + _str.format("{}", get_color("window-background")) + "; margin: auto; text-align: center; padding: 1ex;", onclick: stop_propagation, id: unique_id()})]));
            self.container_id = c.id;
            container.appendChild(c);
            container.style.maxWidth = "40rem";
            container.style.width = "90%";
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:none"})]));
            self.add_style = new AddStyle((function() {
                var _anonfunc = function () {
                    return self.container.lastChild;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })(), self.hide_add_style);
            self.seen_colors = Object.create(null);
            custom_highlight_styles = get_session_data().get("custom_highlight_styles");
            var _Iter6 = _Iterable(custom_highlight_styles);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                raw = _Iter6[_Index6];
                self.add_color(new HighlightStyle(raw)).classList.add("custom-style");
            }
            var _Iter7 = _Iterable(all_builtin_styles());
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                raw = _Iter7[_Index7];
                self.add_color(new HighlightStyle(raw));
            }
            if (!c.querySelector(".current-swatch")) {
                self.add_color(self.initial_style, true);
            }
            parent = c.getElementsByClassName("color-block")[0];
            parent.appendChild(_interpolate_kwargs.call(E, E.div, [svgicon("plus", ICON_SIZE, ICON_SIZE)].concat([_desugar_kwargs({style: "padding: 4px; margin: 4px;", title: _("Add a new highlight style"), class_: "simple-link", onclick: (function() {
                var _anonfunc = function (ev) {
                    var c;
                    ev.stopPropagation();
                    c = self.container;
                    c.firstChild.style.display = "none";
                    c.lastChild.style.display = "block";
                    self.add_style.init();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })()})])));
            self.set_visibility_of_remove_button();
            window.setTimeout(self.notes_edit.focus.bind(self.notes_edit), 0);
            if (current_notes) {
                self.notes_edit.value = current_notes;
            }
        };
        if (!EditNotesAndColors.prototype.__init__.__argnames__) Object.defineProperties(EditNotesAndColors.prototype.__init__, {
            __argnames__ : {value: ["container", "is_dark_theme", "current_notes", "current_style", "annot_id", "close_editor"]},
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.__argnames__ = EditNotesAndColors.prototype.__init__.__argnames__;
        EditNotesAndColors.__handles_kwarg_interpolation__ = EditNotesAndColors.prototype.__init__.__handles_kwarg_interpolation__;
        EditNotesAndColors.prototype.hide_add_style = function hide_add_style(new_style) {
            var self = this;
            var c;
            c = self.container;
            c.firstChild.style.display = "block";
            c.lastChild.style.display = "none";
            if (new_style) {
                self.add_new_style(new_style);
            }
            self.notes_edit.focus();
        };
        if (!EditNotesAndColors.prototype.hide_add_style.__argnames__) Object.defineProperties(EditNotesAndColors.prototype.hide_add_style, {
            __argnames__ : {value: ["new_style"]},
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.add_new_style = function add_new_style(new_style) {
            var self = this;
            var hs, item, q, sd, new_styles, seen, hso, style;
            hs = new HighlightStyle(new_style);
            item = self.add_color(hs, true);
            if (!item) {
                var _Iter8 = _Iterable(self.container.getElementsByClassName("swatch"));
                for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                    q = _Iter8[_Index8];
                    if (q.dataset.key === hs.key) {
                        item = q;
                        break;
                    }
                }
            }
            if (item) {
                item.classList.add("custom-style");
                self.make_swatch_current(item);
                sd = get_session_data();
                new_styles = [new_style];
                seen = (function(){
                    var _d = Object.create(null);
                    _d[hs.key] = true;
                    return _d;
                }).call(this);
                var _Iter9 = _Iterable(sd.get("custom_highlight_styles"));
                for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                    style = _Iter9[_Index9];
                    hso = new HighlightStyle(style);
                    if (!seen[_bound_index(hso.key, seen)]) {
                        new_styles.push(style);
                    }
                }
                sd.set("custom_highlight_styles", new_styles);
            }
        };
        if (!EditNotesAndColors.prototype.add_new_style.__argnames__) Object.defineProperties(EditNotesAndColors.prototype.add_new_style, {
            __argnames__ : {value: ["new_style"]},
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.set_visibility_of_remove_button = function set_visibility_of_remove_button() {
            var self = this;
            var c, item;
            c = self.container;
            item = c.querySelector(".current-swatch.custom-style");
            c.querySelector(".remove-custom-color").style.display = (item) ? "flex" : "none";
        };
        if (!EditNotesAndColors.prototype.set_visibility_of_remove_button.__module__) Object.defineProperties(EditNotesAndColors.prototype.set_visibility_of_remove_button, {
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.add_color = function add_color(hs, at_start) {
            var self = this;
            var ic, is_current, sqbg, item, parent;
            if ((_expr_temp = self.seen_colors)[_bound_index(hs.key, _expr_temp)]) {
                return;
            }
            (_expr_temp = self.seen_colors)[_bound_index(hs.key, _expr_temp)] = true;
            ic = E.div();
            hs.make_swatch(ic, self.is_dark_theme);
            ic.classList.add("simple-link");
            is_current = hs.key === self.initial_style.key;
            sqbg = (is_current) ? get_color("window-background2") : "unset";
            item = _interpolate_kwargs.call(E, E.div, [ic].concat([_desugar_kwargs({style: "padding: 4px; background-color: " + _str.format("{}", sqbg) + "; margin: 4px; border-radius: " + _str.format("{}", ICON_SIZE_VAL / 4) + "" + _str.format("{}", ICON_SIZE_UNIT) + "", onclick: self.change_color, title: hs.friendly_name})]));
            if (is_current) {
                item.classList.add("current-swatch");
            }
            item.classList.add("swatch");
            item.dataset.style = hs.serialized();
            item.dataset.key = hs.key;
            parent = self.container.getElementsByClassName("color-block")[0];
            if (at_start) {
                parent.insertBefore(item, parent.firstChild);
            } else {
                parent.appendChild(item);
            }
            return item;
        };
        if (!EditNotesAndColors.prototype.add_color.__argnames__) Object.defineProperties(EditNotesAndColors.prototype.add_color, {
            __argnames__ : {value: ["hs", "at_start"]},
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.remove_custom_color = function remove_custom_color() {
            var self = this;
            question_dialog(_("Are you sure?"), _("Do you want to permanently delete this highlighting style?"), (function() {
                var _anonfunc = function (yes) {
                    if (yes) {
                        self.do_remove_custom_color();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })());
        };
        if (!EditNotesAndColors.prototype.remove_custom_color.__module__) Object.defineProperties(EditNotesAndColors.prototype.remove_custom_color, {
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.do_remove_custom_color = function do_remove_custom_color() {
            var self = this;
            var item, cct, p, sd, custom_highlight_styles, ans, x;
            item = self.container.getElementsByClassName("current-swatch")[0];
            cct = JSON.parse(item.dataset.style);
            p = item.parentNode;
            p.removeChild(item);
            self.make_swatch_current(p.firstChild);
            sd = get_session_data();
            custom_highlight_styles = sd.get("custom_highlight_styles");
            ans = [];
            var _Iter10 = _Iterable(custom_highlight_styles);
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                x = _Iter10[_Index10];
                if (!custom_styles_equal(x, cct)) {
                    ans.push(x);
                }
            }
            sd.set("custom_highlight_styles", ans);
        };
        if (!EditNotesAndColors.prototype.do_remove_custom_color.__module__) Object.defineProperties(EditNotesAndColors.prototype.do_remove_custom_color, {
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.change_color = function change_color(evt) {
            var self = this;
            evt.stopPropagation();
            self.make_swatch_current(evt.currentTarget);
        };
        if (!EditNotesAndColors.prototype.change_color.__argnames__) Object.defineProperties(EditNotesAndColors.prototype.change_color, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.make_swatch_current = function make_swatch_current(item) {
            var self = this;
            var child;
            var _Iter11 = _Iterable(item.parentNode.childNodes);
            for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                child = _Iter11[_Index11];
                child.style.backgroundColor = "unset";
                child.classList.remove("current-swatch");
            }
            item.style.backgroundColor = get_color("window-background2");
            item.classList.add("current-swatch");
            self.notes_edit.focus();
            self.set_visibility_of_remove_button();
        };
        if (!EditNotesAndColors.prototype.make_swatch_current.__argnames__) Object.defineProperties(EditNotesAndColors.prototype.make_swatch_current, {
            __argnames__ : {value: ["item"]},
            __module__ : {value: "read_book.highlights"}
        });
        EditNotesAndColors.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        EditNotesAndColors.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(EditNotesAndColors.prototype, "__bases__", {value: []});
        
        
        
        

        function get_container_id() {
            if (!get_container_id.ans) {
                get_container_id.ans = unique_id();
            }
            return get_container_id.ans;
        };
        if (!get_container_id.__module__) Object.defineProperties(get_container_id, {
            __module__ : {value: "read_book.highlights"}
        });

        function get_container() {
            return document.getElementById(get_container_id());
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.highlights"}
        });

        function get_current_link_prefix() {
            var link_prefix;
            if (runtime.is_standalone_viewer) {
                return current_book().calibre_book_url;
            }
            link_prefix = window.location.href;
            return link_prefix.slice(0, link_prefix.indexOf("#") + 1);
        };
        if (!get_current_link_prefix.__module__) Object.defineProperties(get_current_link_prefix, {
            __module__ : {value: "read_book.highlights"}
        });

        function link_to_epubcfi(epubcfi, link_prefix, current_query) {
            var link;
            if (runtime.is_standalone_viewer) {
                current_query = (function(){
                    var _d = Object.create(null);
                    _d["open_at"] = epubcfi;
                    return _d;
                }).call(this);
                link = encode_query(current_query);
            } else {
                if (!current_query) {
                    current_query = Object.assign(Object.create(null), get_current_query());
                }
                current_query.bookpos = epubcfi;
                link = encode_query(current_query).slice(1);
            }
            return link_prefix + link.replace(/\)/g, "%29").replace(/\(/g, "%28");
        };
        if (!link_to_epubcfi.__argnames__) Object.defineProperties(link_to_epubcfi, {
            __argnames__ : {value: ["epubcfi", "link_prefix", "current_query"]},
            __module__ : {value: "read_book.highlights"}
        });

        function render_highlight_as_text() {
            var hl = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var lines = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var link_prefix = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var current_query = ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[3];
            var as_markdown = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? render_highlight_as_text.__defaults__.as_markdown : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "as_markdown")){
                as_markdown = _kwargs_obj.as_markdown;
            }
            var date, cfi, spine_index, link, notes;
            lines.push(hl.highlighted_text);
            date = new Date(hl.timestamp).toLocaleString();
            if (as_markdown) {
                cfi = hl.start_cfi;
                spine_index = (1 + hl.spine_index) * 2;
                link = link_to_epubcfi("epubcfi(/" + _str.format("{}", spine_index) + "" + _str.format("{}", cfi) + ")", link_prefix, current_query);
                date = "[" + _str.format("{}", date) + "](" + _str.format("{}", link) + ")";
            }
            lines.push(date);
            notes = hl.notes;
            if (notes) {
                lines.push("");
                lines.push(notes);
            }
            lines.push("");
            if (as_markdown) {
                lines.push("-".repeat(20));
            } else {
                lines.push("");
            }
            lines.push("");
        };
        if (!render_highlight_as_text.__defaults__) Object.defineProperties(render_highlight_as_text, {
            __defaults__ : {value: {as_markdown:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["hl", "lines", "link_prefix", "current_query", "as_markdown"]},
            __module__ : {value: "read_book.highlights"}
        });

        function ChapterGroup() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ChapterGroup.prototype.__bind_methods__.call(this);
            ChapterGroup.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ChapterGroup.prototype, "__bind_methods__", {value: function () {
            this.add_annot = ChapterGroup.prototype.add_annot.bind(this);
            this.group_for_title = ChapterGroup.prototype.group_for_title.bind(this);
            this.render_as_text = ChapterGroup.prototype.render_as_text.bind(this);
        }});
        ChapterGroup.prototype.__init__ = function __init__(title, level) {
            var self = this;
            self.level = level || 0;
            self.title = title || "";
            self.subgroups = {};
            self.subgroups_in_order = [];
            self.annotations = [];
        };
        if (!ChapterGroup.prototype.__init__.__argnames__) Object.defineProperties(ChapterGroup.prototype.__init__, {
            __argnames__ : {value: ["title", "level"]},
            __module__ : {value: "read_book.highlights"}
        });
        ChapterGroup.__argnames__ = ChapterGroup.prototype.__init__.__argnames__;
        ChapterGroup.__handles_kwarg_interpolation__ = ChapterGroup.prototype.__init__.__handles_kwarg_interpolation__;
        ChapterGroup.prototype.add_annot = function add_annot(a) {
            var self = this;
            var titles, node, title;
            titles = a["toc_family_titles"];
            if (!titles) {
                titles = _list_decorate([ _("Unknown chapter") ]);
            }
            node = self;
            var _Iter12 = _Iterable(titles);
            for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                title = _Iter12[_Index12];
                node = node.group_for_title(title);
            }
            node.annotations.push(a);
        };
        if (!ChapterGroup.prototype.add_annot.__argnames__) Object.defineProperties(ChapterGroup.prototype.add_annot, {
            __argnames__ : {value: ["a"]},
            __module__ : {value: "read_book.highlights"}
        });
        ChapterGroup.prototype.group_for_title = function group_for_title(title) {
            var self = this;
            var ans;
            ans = (_expr_temp = self.subgroups)[(typeof title === "number" && title < 0) ? _expr_temp.length + title : title];
            if (!ans) {
                ans = new ChapterGroup(title, self.level + 1);
                (_expr_temp = self.subgroups)[(typeof title === "number" && title < 0) ? _expr_temp.length + title : title] = ans;
                self.subgroups_in_order.push(title);
            }
            return ans;
        };
        if (!ChapterGroup.prototype.group_for_title.__argnames__) Object.defineProperties(ChapterGroup.prototype.group_for_title, {
            __argnames__ : {value: ["title"]},
            __module__ : {value: "read_book.highlights"}
        });
        ChapterGroup.prototype.render_as_text = function render_as_text(lines, link_prefix, current_query, as_markdown) {
            var self = this;
            var hl, sg, title;
            if (self.title) {
                lines.push("#".repeat(self.level) + " " + self.title);
                lines.push("");
            }
            var _Iter13 = _Iterable(self.annotations);
            for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                hl = _Iter13[_Index13];
                render_highlight_as_text(hl, lines, link_prefix, current_query, as_markdown);
            }
            var _Iter14 = _Iterable(self.subgroups_in_order);
            for (var _Index14 = 0; _Index14 < _Iter14.length; _Index14++) {
                title = _Iter14[_Index14];
                sg = (_expr_temp = self.subgroups)[(typeof title === "number" && title < 0) ? _expr_temp.length + title : title];
                sg.render_as_text(lines, link_prefix, current_query, as_markdown);
            }
        };
        if (!ChapterGroup.prototype.render_as_text.__argnames__) Object.defineProperties(ChapterGroup.prototype.render_as_text, {
            __argnames__ : {value: ["lines", "link_prefix", "current_query", "as_markdown"]},
            __module__ : {value: "read_book.highlights"}
        });
        ChapterGroup.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ChapterGroup.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ChapterGroup.prototype, "__bases__", {value: []});

        function show_export_dialog(annotations_manager, book_metadata) {
            var sd, fmt, all_highlights, selected_highlight_items, key, e, h, ta_id, href, idx, current_query, link_prefix;
            sd = get_session_data();
            fmt = sd.get("highlights_export_format");
            if (['text', 'markdown', 'calibre_annotations_collection'].indexOf(fmt) < 0) {
                fmt = "text";
            }
            all_highlights = annotations_manager.all_highlights();
            selected_highlight_items = all_selected_entries();
            if (selected_highlight_items.length) {
                key = (function() {
                    var _Iter = _Iterable(selected_highlight_items), _Result = Object.create(null), e;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        e = _Iter[_Index];
                        _Result[e.dataset.uuid] = (true);
                    }
                    return _Result;
                })();
                all_highlights = (function() {
                    var _Iter = _Iterable(all_highlights), _Result = [], h;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        h = _Iter[_Index];
                        if (key[_bound_index(h.uuid, key)]) {
                            _Result.push(h);
                        }
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })();
            }
            ta_id = unique_id();
            href = window.location.href;
            idx = href.indexOf("#");
            href = href.slice(0, idx + 1);
            current_query = Object.assign(Object.create(null), get_current_query());
            link_prefix = get_current_link_prefix();
            function update_text() {
                var data, as_markdown, lines, root, a;
                if (fmt === "calibre_annotations_collection") {
                    data = (function(){
                        var _d = Object.create(null);
                        _d["version"] = 1;
                        _d["type"] = "calibre_annotation_collection";
                        _d["annotations"] = all_highlights;
                        return _d;
                    }).call(this);
                    document.getElementById(ta_id).textContent = JSON.stringify(data, null, 2);
                    return;
                }
                as_markdown = fmt === "markdown";
                lines = [];
                root = new ChapterGroup;
                var _Iter15 = _Iterable(all_highlights);
                for (var _Index15 = 0; _Index15 < _Iter15.length; _Index15++) {
                    a = _Iter15[_Index15];
                    root.add_annot(a);
                }
                root.render_as_text(lines, link_prefix, current_query, as_markdown);
                document.getElementById(ta_id).textContent = lines.join("\n");
            };
            if (!update_text.__module__) Object.defineProperties(update_text, {
                __module__ : {value: "read_book.highlights"}
            });

            function fmt_item(text, val) {
                var ans;
                ans = E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "format", value: val, checked: val === fmt})]), "", text);
                ans.style.marginRight = "1rem";
                ans.firstChild.addEventListener("change", (function() {
                    var _anonfunc = function (ev) {
                        fmt = this.value;
                        sd.set("highlights_export_format", this.value);
                        update_text();
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.highlights"}
                    });
                    return _anonfunc;
                })());
                return ans;
            };
            if (!fmt_item.__argnames__) Object.defineProperties(fmt_item, {
                __argnames__ : {value: ["text", "val"]},
                __module__ : {value: "read_book.highlights"}
            });

            create_custom_dialog(_("Export highlights"), (function() {
                var _anonfunc = function (modal_container, close_modal) {
                    modal_container.appendChild(E.div(E.div(_("Format for exported highlights:")), E.div(fmt_item(_("Plain text"), "text"), fmt_item(_("Markdown"), "markdown"), fmt_item("calibre", "calibre_annotations_collection")), _interpolate_kwargs.call(E, E.textarea, [_desugar_kwargs({style: "margin-top: 1ex; resize: none; max-height: 25vh", readonly: true, rows: "20", cols: "80", id: ta_id})]), _interpolate_kwargs.call(E, E.div, [create_button(_("Copy"), "copy", (function() {
                        var _anonfunc = function (ev) {
                            var x;
                            x = document.getElementById(ta_id);
                            x.focus();
                            x.select();
                            document.execCommand("copy");
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["ev"]},
                            __module__ : {value: "read_book.highlights"}
                        });
                        return _anonfunc;
                    })()), "", create_button(_("Download"), "cloud-download", (function() {
                        var _anonfunc = function (ev) {
                            var text, ext, mt, title, filename, file, url, a;
                            text = document.getElementById(ta_id).textContent;
                            ext = (fmt === "markdown") ? "md" : (fmt === "text") ? "txt" : "json";
                            mt = (fmt === "markdown") ? "text/markdown" : (fmt === "text") ? "text/plain" : "application/json";
                            title = (typeof book_metadata !== "undefined" && book_metadata !== null ? book_metadata : Object.create(null)).title || _("Unknown");
                            filename = (_expr_temp = _("{title} - highlights"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({title: title})])) + ("." + _str.format("{}", ext) + "");
                            file = new Blob(_list_decorate([ text ]), (function(){
                                var _d = Object.create(null);
                                _d["type"] = mt;
                                return _d;
                            }).call(this));
                            url = window.URL.createObjectURL(file);
                            a = _interpolate_kwargs.call(E, E.a, [_desugar_kwargs({href: url, download: filename})]);
                            document.body.appendChild(a);
                            a.click();
                            window.setTimeout((function() {
                                var _anonfunc = function () {
                                    document.body.removeChild(a);
                                    window.URL.revokeObjectURL(url);
                                };
                                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                    __module__ : {value: "read_book.highlights"}
                                });
                                return _anonfunc;
                            })(), 0);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["ev"]},
                            __module__ : {value: "read_book.highlights"}
                        });
                        return _anonfunc;
                    })())].concat([_desugar_kwargs({class_: "button-box"})]))));
                    window.setTimeout(update_text, 0);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["modal_container", "close_modal"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })());
        };
        if (!show_export_dialog.__argnames__) Object.defineProperties(show_export_dialog, {
            __argnames__ : {value: ["annotations_manager", "book_metadata"]},
            __module__ : {value: "read_book.highlights"}
        });

        function focus_search() {
            var c;
            c = get_container();
            c.querySelector("input").focus();
        };
        if (!focus_search.__module__) Object.defineProperties(focus_search, {
            __module__ : {value: "read_book.highlights"}
        });

        function find(backwards) {
            var c, text, all_highlights, current, start, q, h;
            c = get_container();
            text = c.querySelector("input").value;
            if (!text) {
                return false;
            }
            all_highlights = list(c.querySelectorAll(".highlight")).as_array();
            current = c.querySelector(".highlight.current");
            if (current) {
                start = all_highlights.indexOf(current);
                if (backwards) {
                    all_highlights = all_highlights.slice(0, start).reverse().concat(all_highlights.slice(start).reverse());
                } else {
                    all_highlights = all_highlights.slice(start + 1).concat(all_highlights.slice(0, start + 1));
                }
            } else if (backwards) {
                all_highlights.reverse();
            }
            q = text.toLowerCase();
            var _Iter16 = _Iterable(all_highlights);
            for (var _Index16 = 0; _Index16 < _Iter16.length; _Index16++) {
                h = _Iter16[_Index16];
                if (h.dataset.title.toLowerCase().indexOf(q) > -1 || h.dataset.notes.toLowerCase().indexOf(q) > -1) {
                    set_current_highlight_entry(h);
                    h.scrollIntoView();
                    if (h === current) {
                        _interpolate_kwargs.call(this, warning_dialog, [_("Not found"), _("No other matches found for: {}").format(text)].concat([_desugar_kwargs({on_close: focus_search})]));
                    }
                    return true;
                }
            }
            _interpolate_kwargs.call(this, warning_dialog, [_("Not found"), _("No matches found for: {}").format(text)].concat([_desugar_kwargs({on_close: focus_search})]));
            return false;
        };
        if (!find.__argnames__) Object.defineProperties(find, {
            __argnames__ : {value: ["backwards"]},
            __module__ : {value: "read_book.highlights"}
        });

        function find_previous() {
            return find(true);
        };
        if (!find_previous.__module__) Object.defineProperties(find_previous, {
            __module__ : {value: "read_book.highlights"}
        });

        function find_next() {
            return find(false);
        };
        if (!find_next.__module__) Object.defineProperties(find_next, {
            __module__ : {value: "read_book.highlights"}
        });

        add_extra_css((function() {
            var _anonfunc = function () {
                var ans, sel, qsel, current;
                ans = "";
                sel = "#" + get_container_id();
                ans += _interpolate_kwargs.call(this, build_rule, [sel + " .ac-button"].concat([_desugar_kwargs({margin_left: "1rem", margin_top: "1ex"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + " .sel-button"].concat([_desugar_kwargs({display: "none"})]));
                sel += " .toc-group";
                ans += _interpolate_kwargs.call(this, build_rule, [sel + " h3"].concat([_desugar_kwargs({display: "flex", align_items: "center", cursor: "pointer", margin_top: "1ex"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ".expanded .caret-right"].concat([_desugar_kwargs({display: "none"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ".collapsed .caret-down"].concat([_desugar_kwargs({display: "none"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ".collapsed > div"].concat([_desugar_kwargs({display: "none"})]));
                qsel = sel + " .highlight";
                ans += _interpolate_kwargs.call(this, build_rule, [qsel].concat([_desugar_kwargs({margin_top: "1ex", border_top: "solid 1px", padding_top: "1ex", cursor: "pointer"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [qsel + " .notes"].concat([_desugar_kwargs({display: "none", margin_top: "1ex", max_height: "20ex", overflow: "auto"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [qsel + " .actions"].concat([_desugar_kwargs({display: "none", margin_top: "1ex", justify_content: "space-between"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [qsel + " .title"].concat([_desugar_kwargs({display: "flex", align_items: "center"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [qsel + " .title-row"].concat([_desugar_kwargs({display: "flex", align_items: "center", justify_content: "space-between"})]));
                current = qsel + ".current";
                ans += _interpolate_kwargs.call(this, build_rule, [current + " .title"].concat([_desugar_kwargs({font_weight: "bold", font_size: "larger"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [current + " .notes"].concat([_desugar_kwargs({display: "block"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [current + " .actions"].concat([_desugar_kwargs({display: "flex"})]));
                return ans;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.highlights"}
            });
            return _anonfunc;
        })());
        url_pat = /\bhttps?:\/\/\S{3,}/gi;
        closing_bracket_map = (function(){
            var _d = Object.create(null);
            _d["("] = ")";
            _d["["] = "]";
            _d["{"] = "}";
            _d["<"] = ">";
            _d["*"] = "*";
            _d["\""] = "\"";
            _d["'"] = "'";
            return _d;
        }).call(this);
        opening_brackets = Object.keys(closing_bracket_map).join("");
        function url(text, s, e) {
            var q, idx;
            while (".,?!".indexOf(text[_bound_index(e - 1, text)]) > -1 && e > 1) {
                e -= 1;
            }
            if (s > 0 && e <= text.length && closing_bracket_map[_bound_index(text[_bound_index(s - 1, text)], closing_bracket_map)]) {
                q = closing_bracket_map[_bound_index(text[_bound_index(s - 1, text)], closing_bracket_map)];
                idx = text.indexOf(q, s);
                if (idx > s) {
                    e = idx;
                }
            }
            return [s, e];
        };
        if (!url.__annotations__) Object.defineProperties(url, {
            __annotations__ : {value: {text: str, s: int, e: int}},
            __argnames__ : {value: ["text", "s", "e"]},
            __module__ : {value: "read_book.highlights"}
        });

        function render_notes(notes, container, make_urls_clickable) {
            var current_para, line;
            current_para = E.p();
            function add_para() {
                container.appendChild(current_para);
                if (container.childNodes.length > 1) {
                    container.lastChild.style.marginTop = "2ex";
                }
                current_para = E.p();
            };
            if (!add_para.__module__) Object.defineProperties(add_para, {
                __module__ : {value: "read_book.highlights"}
            });

            function add_line(line) {
                var urls, m, pos, _unpack, s, e;
                url_pat.lastIndex = 0;
                urls = [];
                while (make_urls_clickable) {
                    m = url_pat.exec(line);
                    if (!m) {
                        break;
                    }
                    urls.push(url(line, m.index, url_pat.lastIndex));
                }
                if (!urls.length) {
                    current_para.appendChild(document.createTextNode(line));
                    return;
                }
                pos = 0;
                var _Iter17 = _Iterable(urls);
                for (var _Index17 = 0; _Index17 < _Iter17.length; _Index17++) {
                    _unpack = _Iter17[_Index17];
                    s = _unpack[0];
                    e = _unpack[1];
                    if (s > pos) {
                        current_para.appendChild(document.createTextNode(line.slice(pos, s)));
                    }
                    current_para.appendChild(_interpolate_kwargs.call(E, E.a, [line.slice(s, e)].concat([_desugar_kwargs({href: "javascript: void(0)", class_: "blue-link", onclick: ui_operations.open_url.bind(null, line.slice(s, e))})])));
                }
                if (urls[urls.length-1][1] < line.length) {
                    current_para.appendChild(document.createTextNode(line.slice(urls[urls.length-1][1])));
                }
            };
            if (!add_line.__argnames__) Object.defineProperties(add_line, {
                __argnames__ : {value: ["line"]},
                __module__ : {value: "read_book.highlights"}
            });

            var _Iter18 = _Iterable(notes.splitlines());
            for (var _Index18 = 0; _Index18 < _Iter18.length; _Index18++) {
                line = _Iter18[_Index18];
                if (!line || !line.strip()) {
                    if (current_para.childNodes.length) {
                        add_para();
                        continue;
                    }
                }
                add_line(line);
            }
            if (current_para.childNodes.length) {
                add_para();
            }
            return container;
        };
        if (!render_notes.__argnames__) Object.defineProperties(render_notes, {
            __argnames__ : {value: ["notes", "container", "make_urls_clickable"]},
            __module__ : {value: "read_book.highlights"}
        });

        function highlight_entry_clicked(ev) {
            set_current_highlight_entry(ev.currentTarget);
        };
        if (!highlight_entry_clicked.__argnames__) Object.defineProperties(highlight_entry_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.highlights"}
        });

        function set_current_highlight_entry(entry) {
            var c, h;
            c = get_container();
            var _Iter19 = _Iterable(c.querySelectorAll(".highlight"));
            for (var _Index19 = 0; _Index19 < _Iter19.length; _Index19++) {
                h = _Iter19[_Index19];
                h.classList.remove("current");
            }
            entry.classList.add("current");
        };
        if (!set_current_highlight_entry.__argnames__) Object.defineProperties(set_current_highlight_entry, {
            __argnames__ : {value: ["entry"]},
            __module__ : {value: "read_book.highlights"}
        });

        function show_in_text(annot_id, view) {
            view.highlight_action(annot_id, "goto");
        };
        if (!show_in_text.__argnames__) Object.defineProperties(show_in_text, {
            __argnames__ : {value: ["annot_id", "view"]},
            __module__ : {value: "read_book.highlights"}
        });

        function remove_highlight(annot_id, view, ev) {
            var entry;
            entry = ev.currentTarget.closest(".highlight");
            question_dialog(_("Are you sure?"), _("Do you want to permanently delete this highlight?"), (function() {
                var _anonfunc = function (yes) {
                    if (yes) {
                        entry.style.display = "none";
                        view.highlight_action(annot_id, "delete");
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })());
        };
        if (!remove_highlight.__argnames__) Object.defineProperties(remove_highlight, {
            __argnames__ : {value: ["annot_id", "view", "ev"]},
            __module__ : {value: "read_book.highlights"}
        });

        function edit_notes(annot_id, notes, view, ev) {
            var entry;
            entry = ev.currentTarget.closest(".highlight");
            _interpolate_kwargs.call(this, get_text_dialog, [_("Notes"), (function() {
                var _anonfunc = function (ok, text) {
                    var nc;
                    if (!ok) {
                        return;
                    }
                    text = text || "";
                    nc = entry.querySelector(".notes");
                    clear(nc);
                    view.set_notes_for_highlight(annot_id, text);
                    render_notes(text, nc);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ok", "text"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({initial_text: notes || null})]));
        };
        if (!edit_notes.__argnames__) Object.defineProperties(edit_notes, {
            __argnames__ : {value: ["annot_id", "notes", "view", "ev"]},
            __module__ : {value: "read_book.highlights"}
        });

        function all_selected_entries() {
            return (function() {
                var _Iter = _Iterable(document.querySelectorAll(".highlight input:checked")), _Result = [], e;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    e = _Iter[_Index];
                    _Result.push(e.closest(".highlight"));
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!all_selected_entries.__module__) Object.defineProperties(all_selected_entries, {
            __module__ : {value: "read_book.highlights"}
        });

        function item_select_toggled() {
            var entries, e;
            entries = all_selected_entries();
            var _Iter20 = _Iterable(document.querySelectorAll("#" + _str.format("{}", get_container_id()) + " .sel-button"));
            for (var _Index20 = 0; _Index20 < _Iter20.length; _Index20++) {
                e = _Iter20[_Index20];
                e.style.display = (entries.length) ? "block" : "none";
            }
        };
        if (!item_select_toggled.__module__) Object.defineProperties(item_select_toggled, {
            __module__ : {value: "read_book.highlights"}
        });

        function clear_selection() {
            var e;
            var _Iter21 = _Iterable(document.querySelectorAll(".highlight input:checked"));
            for (var _Index21 = 0; _Index21 < _Iter21.length; _Index21++) {
                e = _Iter21[_Index21];
                e.checked = false;
            }
            item_select_toggled();
        };
        if (!clear_selection.__module__) Object.defineProperties(clear_selection, {
            __module__ : {value: "read_book.highlights"}
        });

        function select_all() {
            var e;
            var _Iter22 = _Iterable(document.querySelectorAll(".highlight input"));
            for (var _Index22 = 0; _Index22 < _Iter22.length; _Index22++) {
                e = _Iter22[_Index22];
                e.checked = true;
            }
        };
        if (!select_all.__module__) Object.defineProperties(select_all, {
            __module__ : {value: "read_book.highlights"}
        });

        function delete_selection(annotations_manager, view) {
            var selected_highlight_items, text;
            selected_highlight_items = all_selected_entries();
            if (!selected_highlight_items.length) {
                return;
            }
            text = ngettext("Do you want to permanently delete the selected highlight?", "Do you want to permanently delete the {} selected highlights?", selected_highlight_items.length).format(selected_highlight_items.length);
            question_dialog(_("Are you sure?"), text, (function() {
                var _anonfunc = function (yes) {
                    var entry;
                    if (yes) {
                        var _Iter23 = _Iterable(selected_highlight_items);
                        for (var _Index23 = 0; _Index23 < _Iter23.length; _Index23++) {
                            entry = _Iter23[_Index23];
                            entry.style.display = "none";
                            view.highlight_action(entry.dataset.uuid, "delete");
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })());
        };
        if (!delete_selection.__argnames__) Object.defineProperties(delete_selection, {
            __argnames__ : {value: ["annotations_manager", "view"]},
            __module__ : {value: "read_book.highlights"}
        });

        function highlight_entry(h, onclick, view, hide_panel) {
            var hs, swatch, ans;
            function action(func, ev) {
                [ev.stopPropagation(), ev.preventDefault()];
                onclick(func);
            };
            if (!action.__argnames__) Object.defineProperties(action, {
                __argnames__ : {value: ["func", "ev"]},
                __module__ : {value: "read_book.highlights"}
            });

            function button(text, func) {
                return _interpolate_kwargs.call(E, E.a, [text].concat([_desugar_kwargs({class_: "blue-link", onclick: func})]));
            };
            if (!button.__argnames__) Object.defineProperties(button, {
                __argnames__ : {value: ["text", "func"]},
                __module__ : {value: "read_book.highlights"}
            });

            hs = new HighlightStyle(h.style);
            swatch = E.div();
            hs.make_swatch(swatch, is_dark_theme());
            ans = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [swatch, _interpolate_kwargs.call(E, E.div, [h.highlighted_text].concat([_desugar_kwargs({style: "margin-left: 1rem"})]))].concat([_desugar_kwargs({class_: "title"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", onchange: item_select_toggled, onkeydown: (function() {
                var _anonfunc = function (ev) {
                    if (ev.key === "Escape") {
                        ev.stopPropagation();
                        ev.preventDefault();
                        hide_panel();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })()})])].concat([_desugar_kwargs({style: "margin-left: 1rem", onclick: (function() {
                var _anonfunc = function (ev) {
                    ev.stopPropagation();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })()})]))].concat([_desugar_kwargs({class_: "title-row"})])), _interpolate_kwargs.call(E, E.div, [button(_("Show in book"), action.bind(null, show_in_text.bind(null, h.uuid))), E.span(""), button(_("Edit notes"), edit_notes.bind(null, h.uuid, h.notes, view)), E.span(""), button(_("Remove highlight"), remove_highlight.bind(null, h.uuid, view))].concat([_desugar_kwargs({class_: "actions"})])), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "notes"})])].concat([_desugar_kwargs({class_: "highlight", data_uuid: h.uuid, onclick: highlight_entry_clicked})]));
            if (h.notes) {
                render_notes(h.notes, ans.querySelector(".notes"), true);
            }
            ans.dataset.notes = h.notes || "";
            ans.dataset.title = h.highlighted_text || "";
            return ans;
        };
        if (!highlight_entry.__argnames__) Object.defineProperties(highlight_entry, {
            __argnames__ : {value: ["h", "onclick", "view", "hide_panel"]},
            __module__ : {value: "read_book.highlights"}
        });

        function create_highlights_panel(annotations_manager, hide_panel, book, container, onclick) {
            var next_button, prev_button, sb, clear_button, delete_button, all_button, export_button, c, toc_groups, toc_tt, toc, lines, _unpack, i, node, tt, h, highlights, g, ic, group;
            next_button = _interpolate_kwargs.call(E, E.div, [svgicon("chevron-down")].concat([_desugar_kwargs({class_: "simple-link ac-button", title: _("Next match")})]));
            prev_button = _interpolate_kwargs.call(E, E.div, [svgicon("chevron-up")].concat([_desugar_kwargs({class_: "simple-link ac-button", title: _("Previous match")})]));
            prev_button.addEventListener("click", (function() {
                var _anonfunc = function (ev) {
                    find_previous();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.highlights"}
                });
                return _anonfunc;
            })());
            sb = _interpolate_kwargs.call(this, create_search_bar, [find_next, "search-in-highlights"].concat([_desugar_kwargs({placeholder: _("Search") + "", button: next_button, associated_widgets: _list_decorate([ prev_button ])})]));
            sb.style.flexGrow = "10";
            sb.classList.add("ac-button");
            clear_button = _interpolate_kwargs.call(this, create_button, [_("Clear"), "close", clear_selection, _("Clear selection")].concat([_desugar_kwargs({class_: "ac-button sel-button"})]));
            delete_button = _interpolate_kwargs.call(this, create_button, [_("Remove"), "trash", delete_selection.bind(null, annotations_manager, annotations_manager.view), _("Remove selected highlights")].concat([_desugar_kwargs({class_: "ac-button sel-button"})]));
            all_button = _interpolate_kwargs.call(this, create_button, [_("All"), "plus", select_all, _("Select all highlights")].concat([_desugar_kwargs({class_: "ac-button sel-button"})]));
            export_button = _interpolate_kwargs.call(this, create_button, [_("Export"), "cloud-download", show_export_dialog.bind(null, annotations_manager, book.metadata), _("Export all or selected highlights")].concat([_desugar_kwargs({class_: "ac-button"})]));
            c = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [sb, next_button, prev_button, clear_button, all_button, delete_button, export_button].concat([_desugar_kwargs({style: "display: flex; flex-wrap: wrap; margin-top: -1ex; align-items: center"})]))].concat([_desugar_kwargs({style: "padding: 1rem", id: get_container_id()})]));
            container.appendChild(c);
            toc_groups = Object.create(null);
            toc_tt = Object.create(null);
            var _Iter24 = _Iterable(annotations_manager.all_highlights());
            for (var _Index24 = 0; _Index24 < _Iter24.length; _Index24++) {
                h = _Iter24[_Index24];
                toc = _("Unknown");
                if (_exists.d(h.toc_family_titles).length) {
                    toc = (_expr_temp = h.toc_family_titles)[_expr_temp.length-1];
                }
                if (!toc_groups[(typeof toc === "number" && toc < 0) ? toc_groups.length + toc : toc]) {
                    toc_groups[(typeof toc === "number" && toc < 0) ? toc_groups.length + toc : toc] = [];
                    if (_exists.d(h.toc_family_titles).length) {
                        lines = [];
                        var _Iter25 = _Iterable(enumerate(h.toc_family_titles));
                        for (var _Index25 = 0; _Index25 < _Iter25.length; _Index25++) {
                            _unpack = _Iter25[_Index25];
                            i = _unpack[0];
                            node = _unpack[1];
                            lines.push("".repeat(i) + " " + node);
                        }
                        tt = ngettext("Table of Contents section:", "Table of Contents sections:", lines.length);
                        tt += "\n" + "\n".join(lines);
                        toc_tt[(typeof toc === "number" && toc < 0) ? toc_tt.length + toc : toc] = tt;
                    }
                }
                toc_groups[(typeof toc === "number" && toc < 0) ? toc_groups.length + toc : toc].push(h);
            }
            function tree_icon(which) {
                var ans;
                ans = svgicon(which);
                ans.classList.add(which);
                return ans;
            };
            if (!tree_icon.__argnames__) Object.defineProperties(tree_icon, {
                __argnames__ : {value: ["which"]},
                __module__ : {value: "read_book.highlights"}
            });

            var _Iter26 = _Iterable(Object.keys(toc_groups));
            for (var _Index26 = 0; _Index26 < _Iter26.length; _Index26++) {
                group = _Iter26[_Index26];
                highlights = toc_groups[(typeof group === "number" && group < 0) ? toc_groups.length + group : group];
                g = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.h3, [tree_icon("caret-right"), tree_icon("caret-down"), E.div("" + group)].concat([_desugar_kwargs({title: toc_tt[(typeof group === "number" && group < 0) ? toc_tt.length + group : group] || "", onclick: (function() {
                    var _anonfunc = function (ev) {
                        var tg;
                        tg = ev.currentTarget.closest(".toc-group");
                        if (tg.classList.contains("expanded")) {
                            tg.classList.remove("expanded");
                            tg.classList.add("collapsed");
                        } else {
                            tg.classList.remove("collapsed");
                            tg.classList.add("expanded");
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.highlights"}
                    });
                    return _anonfunc;
                })()})])), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-left: 1rem"})])].concat([_desugar_kwargs({class_: "toc-group expanded"})]));
                c.appendChild(g);
                ic = g.lastChild;
                var _Iter27 = _Iterable(highlights);
                for (var _Index27 = 0; _Index27 < _Iter27.length; _Index27++) {
                    h = _Iter27[_Index27];
                    ic.appendChild(highlight_entry(h, onclick, annotations_manager.view, hide_panel));
                }
            }
        };
        if (!create_highlights_panel.__argnames__) Object.defineProperties(create_highlights_panel, {
            __argnames__ : {value: ["annotations_manager", "hide_panel", "book", "container", "onclick"]},
            __module__ : {value: "read_book.highlights"}
        });

        _modules["read_book.highlights"].ICON_SIZE_VAL = ICON_SIZE_VAL;
        _modules["read_book.highlights"].ICON_SIZE_UNIT = ICON_SIZE_UNIT;
        _modules["read_book.highlights"].ICON_SIZE = ICON_SIZE;
        _modules["read_book.highlights"].builtin_colors_light = builtin_colors_light;
        _modules["read_book.highlights"].builtin_colors_dark = builtin_colors_dark;
        _modules["read_book.highlights"].builtin_decorations_light = builtin_decorations_light;
        _modules["read_book.highlights"].builtin_decorations_dark = builtin_decorations_dark;
        _modules["read_book.highlights"].all_style_keys = all_style_keys;
        _modules["read_book.highlights"].url_pat = url_pat;
        _modules["read_book.highlights"].closing_bracket_map = closing_bracket_map;
        _modules["read_book.highlights"].opening_brackets = opening_brackets;
        _modules["read_book.highlights"].builtin_friendly_name = builtin_friendly_name;
        _modules["read_book.highlights"].builtin_color = builtin_color;
        _modules["read_book.highlights"].default_color = default_color;
        _modules["read_book.highlights"].all_builtin_styles = all_builtin_styles;
        _modules["read_book.highlights"].custom_color_theme = custom_color_theme;
        _modules["read_book.highlights"].custom_decoration_theme = custom_decoration_theme;
        _modules["read_book.highlights"].style_key = style_key;
        _modules["read_book.highlights"].HighlightStyle = HighlightStyle;
        _modules["read_book.highlights"].highlight_style_as_css = highlight_style_as_css;
        _modules["read_book.highlights"].custom_styles_equal = custom_styles_equal;
        _modules["read_book.highlights"].all_styles = all_styles;
        _modules["read_book.highlights"].AddStyle = AddStyle;
        _modules["read_book.highlights"].EditNotesAndColors = EditNotesAndColors;
        _modules["read_book.highlights"].get_container_id = get_container_id;
        _modules["read_book.highlights"].get_container = get_container;
        _modules["read_book.highlights"].get_current_link_prefix = get_current_link_prefix;
        _modules["read_book.highlights"].link_to_epubcfi = link_to_epubcfi;
        _modules["read_book.highlights"].render_highlight_as_text = render_highlight_as_text;
        _modules["read_book.highlights"].ChapterGroup = ChapterGroup;
        _modules["read_book.highlights"].show_export_dialog = show_export_dialog;
        _modules["read_book.highlights"].focus_search = focus_search;
        _modules["read_book.highlights"].find = find;
        _modules["read_book.highlights"].find_previous = find_previous;
        _modules["read_book.highlights"].find_next = find_next;
        _modules["read_book.highlights"].url = url;
        _modules["read_book.highlights"].render_notes = render_notes;
        _modules["read_book.highlights"].highlight_entry_clicked = highlight_entry_clicked;
        _modules["read_book.highlights"].set_current_highlight_entry = set_current_highlight_entry;
        _modules["read_book.highlights"].show_in_text = show_in_text;
        _modules["read_book.highlights"].remove_highlight = remove_highlight;
        _modules["read_book.highlights"].edit_notes = edit_notes;
        _modules["read_book.highlights"].all_selected_entries = all_selected_entries;
        _modules["read_book.highlights"].item_select_toggled = item_select_toggled;
        _modules["read_book.highlights"].clear_selection = clear_selection;
        _modules["read_book.highlights"].select_all = select_all;
        _modules["read_book.highlights"].delete_selection = delete_selection;
        _modules["read_book.highlights"].highlight_entry = highlight_entry;
        _modules["read_book.highlights"].create_highlights_panel = create_highlights_panel;
    })();

    (function(){
        var __name__ = "read_book.shortcuts";
        var capital_letters, x;
        var _ = _modules.gettext.gettext;

        var runtime = _modules["read_book.globals"].runtime;

        function parse_key_repr(sc) {
            var parts, key, ans, q, modifier;
            parts = sc.split("+");
            if (sc.endsWith("++")) {
                parts = parts.slice(0, -2);
                parts.push("+");
            }
            key = parts[parts.length-1];
            ans = (function(){
                var _d = Object.create(null);
                _d["key"] = key;
                _d["altKey"] = false;
                _d["ctrlKey"] = false;
                _d["metaKey"] = false;
                _d["shiftKey"] = false;
                return _d;
            }).call(this);
            var _Iter0 = _Iterable(parts.slice(0, -1));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                modifier = _Iter0[_Index0];
                q = modifier.toLowerCase();
                if (q === "ctrl") {
                    ans.ctrlKey = true;
                } else if (q === "alt") {
                    ans.altKey = true;
                } else if (q === "meta" || q === "cmd") {
                    ans.metaKey = true;
                } else if (q === "shift") {
                    ans.shiftKey = true;
                }
            }
            return ans;
        };
        if (!parse_key_repr.__argnames__) Object.defineProperties(parse_key_repr, {
            __argnames__ : {value: ["sc"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function desc(sc, group, short, long) {
            var pkey, x;
            if (typeof sc === "string") {
                sc = [sc];
            }
            pkey = [];
            var _Iter1 = _Iterable(sc);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                x = _Iter1[_Index1];
                pkey.push(parse_key_repr(x));
            }
            return (function(){
                var _d = Object.create(null);
                _d["group"] = group;
                _d["short"] = short;
                _d["long"] = long;
                _d["shortcuts"] = pkey;
                return _d;
            }).call(this);
        };
        if (!desc.__argnames__) Object.defineProperties(desc, {
            __argnames__ : {value: ["sc", "group", "short", "long"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function keyevent_as_shortcut(evt) {
            var key;
            key = evt.key;
            if (capital_letters[(typeof key === "number" && key < 0) ? capital_letters.length + key : key] && evt.shiftKey) {
                key = key.toLowerCase();
            }
            return (function(){
                var _d = Object.create(null);
                _d["key"] = key;
                _d["altKey"] = evt.altKey;
                _d["ctrlKey"] = evt.ctrlKey;
                _d["metaKey"] = evt.metaKey;
                _d["shiftKey"] = evt.shiftKey;
                return _d;
            }).call(this);
        };
        if (!keyevent_as_shortcut.__argnames__) Object.defineProperties(keyevent_as_shortcut, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function shortcut_differs(a, b) {
            return !((a.key === b.key && a.altKey === b.altKey && a.ctrlKey === b.ctrlKey && a.metaKey === b.metaKey && a.shiftKey === b.shiftKey));
        };
        if (!shortcut_differs.__argnames__) Object.defineProperties(shortcut_differs, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        capital_letters = (function() {
            var _Iter = _Iterable("ABCDEFGHIJKLMNOPQRSTUVWXYZ"), _Result = Object.create(null), x;
            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                x = _Iter[_Index];
                _Result[x] = (true);
            }
            return _Result;
        })();
        function get_key_text(evt) {
            var key;
            key = evt.key;
            if (key) {
                if (evt.code && key.toLowerCase() !== key && evt.code.startsWith("Key") && capital_letters[(typeof key === "number" && key < 0) ? capital_letters.length + key : key]) {
                    key = key.toLowerCase();
                }
            }
            return key;
        };
        if (!get_key_text.__argnames__) Object.defineProperties(get_key_text, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function keyevent_to_index(evt) {
            var parts, mod;
            parts = [];
            var _Iter2 = _Iterable(['altKey', 'ctrlKey', 'metaKey', 'shiftKey']);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                mod = _Iter2[_Index2];
                parts.push((evt[(typeof mod === "number" && mod < 0) ? evt.length + mod : mod]) ? "y" : "n");
            }
            return parts.join("") + get_key_text(evt);
        };
        if (!keyevent_to_index.__argnames__) Object.defineProperties(keyevent_to_index, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function key_as_text(evt) {
            var mods, x, key;
            mods = [];
            var _Iter3 = _Iterable(_list_decorate([ "alt", "ctrl", "meta", "shift" ]));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                x = _Iter3[_Index3];
                if (evt[_bound_index(x + "Key", evt)]) {
                    if (_in("macos", window.navigator.userAgent)) {
                        if (x === "alt") {
                            x = "option";
                        } else if (x === "meta") {
                            x = "";
                        }
                    }
                    mods.push(x.capitalize());
                }
            }
            mods = "+".join(mods);
            if (mods) {
                mods += "+";
            }
            key = get_key_text(evt);
            if (key === " ") {
                key = "Space";
            }
            return mods + key;
        };
        if (!key_as_text.__argnames__) Object.defineProperties(key_as_text, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function common_shortcuts() {
            return (function(){
                var _d = Object.create(null);
                _d["start_of_file"] = desc(['Ctrl+ArrowUp', 'Ctrl+ArrowLeft', 'Home'], "scroll", _("Scroll to the beginning of the current file"), _("When the e-book is made of multiple individual files, scroll to the start of the current file"));
                _d["start_of_book"] = desc("Ctrl+Home", "scroll", _("Scroll to the beginning of the book"));
                _d["end_of_book"] = desc("Ctrl+End", "scroll", _("Scroll to the end of the book"));
                _d["end_of_file"] = desc(['Ctrl+ArrowDown', 'Ctrl+ArrowRight', 'End'], "scroll", _("Scroll to the end of the current file"), _("When the e-book is made of multiple individual files, scroll to the end of the current file"));
                _d["up"] = desc("ArrowUp", "scroll", _("Scroll backwards smoothly (by screen-fulls in paged mode)"), _("Scroll backwards, smoothly in flow mode and by screen fulls in paged mode"));
                _d["down"] = desc("ArrowDown", "scroll", _("Scroll forwards smoothly (by screen-fulls in paged mode)"), _("Scroll forwards, smoothly in flow mode and by screen fulls in paged mode"));
                _d["left"] = desc("ArrowLeft", "scroll", _("Scroll left"), _("Scroll leftwards by a little in flow mode and by a page in paged mode"));
                _d["right"] = desc("ArrowRight", "scroll", _("Scroll right"), _("Scroll rightwards by a little in flow mode and by a page in paged mode"));
                _d["pageup"] = desc(['PageUp', 'Shift+ '], "scroll", _("Scroll backwards by screen-fulls"));
                _d["pagedown"] = desc([' ', 'PageDown'], "scroll", _("Scroll forwards by screen-fulls"));
                _d["previous_section"] = desc("Ctrl+PageUp", "scroll", _("Scroll to the previous section"));
                _d["next_section"] = desc("Ctrl+PageDown", "scroll", _("Scroll to the next section"));
                _d["back"] = desc(['Alt+ArrowLeft'], "scroll", _("Back"));
                _d["forward"] = desc(['Alt+ArrowRight'], "scroll", _("Forward"));
                _d["toggle_toc"] = desc("Ctrl+t", "ui", _("Show/hide Table of Contents"));
                _d["read_aloud"] = desc("Ctrl+s", "ui", _("Read aloud"));
                _d["toggle_hints"] = desc("Alt+f", "ui", _("Follow links with the keyboard"));
                _d["copy_to_clipboard"] = desc(['Ctrl+c', 'Meta+c'], "ui", _("Copy to clipboard"));
                _d["copy_location_to_clipboard"] = desc(['Alt+c'], "ui", _("Copy current location to clipboard"));
                _d["copy_location_as_url_to_clipboard"] = desc(['Ctrl+Shift+c'], "ui", _("Copy current location as calibre:// URL to clipboard"));
                _d["start_search"] = desc(['/', 'Ctrl+f', 'Cmd+f'], "ui", _("Start search"));
                _d["next_match"] = desc(['F3', 'Enter'], "ui", _("Find next"));
                _d["previous_match"] = desc(['Shift+F3', 'Shift+Enter'], "ui", _("Find previous"));
                _d["increase_font_size"] = desc(['Ctrl+=', 'Ctrl++', 'Ctrl+Shift++', 'Ctrl+Shift+=', 'Meta++', 'Meta+Shift++', 'Meta+Shift+='], "ui", _("Increase font size"));
                _d["decrease_font_size"] = desc(['Ctrl+-', 'Ctrl+_', 'Ctrl+Shift+-', 'Ctrl+Shift+_', 'Meta+-', 'Meta+_'], "ui", _("Decrease font size"));
                _d["default_font_size"] = desc("Ctrl+0", "ui", _("Restore default font size"));
                _d["increase_number_of_columns"] = desc(['Ctrl+]'], "ui", _("Increase number of pages per screen"));
                _d["decrease_number_of_columns"] = desc(['Ctrl+['], "ui", _("Decrease number of pages per screen"));
                _d["reset_number_of_columns"] = desc(['Ctrl+Alt+c'], "ui", _("Make number of pages per screen automatic"));
                _d["toggle_full_screen"] = desc(['F11', 'Ctrl+Shift+f'], "ui", _("Toggle full screen"));
                _d["toggle_paged_mode"] = desc("Ctrl+m", "ui", _("Toggle between Paged mode and Flow mode for text layout"));
                _d["toggle_scrollbar"] = desc("Ctrl+w", "ui", _("Toggle the scrollbar"));
                _d["toggle_reference_mode"] = desc("Ctrl+x", "ui", _("Toggle the Reference mode"));
                _d["toggle_bookmarks"] = desc(['Ctrl+b'], "ui", _("Show/hide bookmarks"));
                _d["new_bookmark"] = desc(['Ctrl+Alt+b'], "ui", _("Create a new bookmark"));
                _d["metadata"] = desc(['Ctrl+n', 'Ctrl+e'], "ui", _("Show the book metadata"));
                _d["show_profiles"] = desc(['Alt+p'], "ui", _("Change settings quickly by creating and switching to \"profiles\""));
                _d["reload_book"] = desc(['Ctrl+Alt+F5', 'Ctrl+Alt+r'], "ui", _("Reload book"));
                _d["extend_selection_by_word"] = desc(['Ctrl+Shift+ArrowRight'], "ui", _("Alter the current selection forward by a word"));
                _d["shrink_selection_by_word"] = desc(['Ctrl+Shift+ArrowLeft'], "ui", _("Alter the current selection backwards by a word"));
                _d["extend_selection_by_character"] = desc(['Shift+ArrowRight'], "ui", _("Alter the current selection forward by a character"));
                _d["shrink_selection_by_character"] = desc(['Shift+ArrowLeft'], "ui", _("Alter the current selection backwards by a character"));
                _d["extend_selection_by_line"] = desc(['Shift+ArrowDown'], "ui", _("Alter the current selection forward by a line"));
                _d["extend_selection_to_start_of_line"] = desc(['Shift+Home'], "ui", _("Extend the current selection to the start of the line"));
                _d["extend_selection_to_end_of_line"] = desc(['Shift+End'], "ui", _("Extend the current selection to the end of the line"));
                _d["select_all"] = desc(["Ctrl+a"], "ui", _("Select all"));
                _d["shrink_selection_by_line"] = desc(['Shift+ArrowUp'], "ui", _("Alter the current selection backwards by a line"));
                _d["extend_selection_by_paragraph"] = desc(['Ctrl+Shift+ArrowDown'], "ui", _("Alter the current selection forward by a paragraph"));
                _d["shrink_selection_by_paragraph"] = desc(['Ctrl+Shift+ArrowUp'], "ui", _("Alter the current selection backwards by a paragraph"));
                _d["show_chrome"] = desc(['Escape', 'ContextMenu'], "ui", _("Show the E-book viewer controls"));
                _d["preferences"] = desc(['Ctrl+,', 'Ctrl+Escape', 'Meta+Escape', 'Meta+,'], "ui", _("Show E-book viewer preferences"));
                _d["goto_location"] = desc([';', ':', 'Shift+:', 'Shift+;', 'Ctrl+g'], "ui", _("Go to a specified book location or position"));
                _d["toggle_autoscroll"] = desc("Ctrl+ ", "scroll", _("Toggle auto-scroll"));
                _d["scrollspeed_increase"] = desc("Alt+ArrowUp", "scroll", _("Auto scroll faster"));
                _d["scrollspeed_decrease"] = desc("Alt+ArrowDown", "scroll", _("Auto scroll slower"));
                return _d;
            }).call(this);
        };
        if (!common_shortcuts.__module__) Object.defineProperties(common_shortcuts, {
            __module__ : {value: "read_book.shortcuts"}
        });

        function shortcuts_definition() {
            var ans;
            ans = shortcuts_definition.ans;
            if (!ans) {
                ans = shortcuts_definition.ans = common_shortcuts();
                if (runtime.is_standalone_viewer) {
                    add_standalone_viewer_shortcuts(ans);
                } else {
                    ans["sync_book"] = desc([], "ui", _("Sync last read position/annotations"));
                }
            }
            return ans;
        };
        if (!shortcuts_definition.__module__) Object.defineProperties(shortcuts_definition, {
            __module__ : {value: "read_book.shortcuts"}
        });

        function shortcuts_group_desc() {
            var ans;
            ans = shortcuts_group_desc.ans;
            if (!ans) {
                ans = shortcuts_group_desc.ans = (function(){
                    var _d = Object.create(null);
                    _d["scroll"] = _("Navigation");
                    _d["ui"] = _("Interface");
                    return _d;
                }).call(this);
            }
            return ans;
        };
        if (!shortcuts_group_desc.__module__) Object.defineProperties(shortcuts_group_desc, {
            __module__ : {value: "read_book.shortcuts"}
        });

        function add_standalone_viewer_shortcuts(sc) {
            var ismacos, quit_shortcut;
            ismacos = _in("macos", window.navigator.userAgent);
            sc["toggle_inspector"] = desc(['Ctrl+i'], "ui", _("Show/hide Inspector"));
            sc["toggle_lookup"] = desc(['Ctrl+l'], "ui", _("Show/hide the word lookup panel"));
            quit_shortcut = (ismacos) ? "Meta+q" : "Ctrl+q";
            sc["quit"] = desc(quit_shortcut, "ui", _("Quit the E-book viewer"));
            sc["print"] = desc("Ctrl+p", "ui", _("Print book to PDF"));
            sc["toggle_toolbar"] = desc("Ctrl+F11", "ui", _("Toggle the toolbar"));
            sc["toggle_highlights"] = desc("Ctrl+h", "ui", _("Toggle the highlights panel"));
            sc["edit_book"] = desc("Ctrl+d", "ui", _("Edit this book"));
        };
        if (!add_standalone_viewer_shortcuts.__argnames__) Object.defineProperties(add_standalone_viewer_shortcuts, {
            __argnames__ : {value: ["sc"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function create_shortcut_map(custom_shortcuts) {
            var ans, scd, entry, shortcuts, sc, sc_name;
            ans = Object.create(null);
            scd = shortcuts_definition();
            var _Iter4 = _Iterable(Object.keys(scd));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                sc_name = _Iter4[_Index4];
                entry = scd[(typeof sc_name === "number" && sc_name < 0) ? scd.length + sc_name : sc_name];
                shortcuts = entry.shortcuts;
                if (custom_shortcuts && custom_shortcuts[(typeof sc_name === "number" && sc_name < 0) ? custom_shortcuts.length + sc_name : sc_name]) {
                    shortcuts = custom_shortcuts[(typeof sc_name === "number" && sc_name < 0) ? custom_shortcuts.length + sc_name : sc_name];
                }
                var _Iter5 = _Iterable(shortcuts);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    sc = _Iter5[_Index5];
                    ans[_bound_index(keyevent_to_index(sc), ans)] = sc_name;
                }
            }
            return ans;
        };
        if (!create_shortcut_map.__argnames__) Object.defineProperties(create_shortcut_map, {
            __argnames__ : {value: ["custom_shortcuts"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        function shortcut_for_key_event(evt, shortcut_map) {
            var idx;
            idx = keyevent_to_index(evt);
            return shortcut_map[(typeof idx === "number" && idx < 0) ? shortcut_map.length + idx : idx];
        };
        if (!shortcut_for_key_event.__argnames__) Object.defineProperties(shortcut_for_key_event, {
            __argnames__ : {value: ["evt", "shortcut_map"]},
            __module__ : {value: "read_book.shortcuts"}
        });

        _modules["read_book.shortcuts"].capital_letters = capital_letters;
        _modules["read_book.shortcuts"].x = x;
        _modules["read_book.shortcuts"].parse_key_repr = parse_key_repr;
        _modules["read_book.shortcuts"].desc = desc;
        _modules["read_book.shortcuts"].keyevent_as_shortcut = keyevent_as_shortcut;
        _modules["read_book.shortcuts"].shortcut_differs = shortcut_differs;
        _modules["read_book.shortcuts"].get_key_text = get_key_text;
        _modules["read_book.shortcuts"].keyevent_to_index = keyevent_to_index;
        _modules["read_book.shortcuts"].key_as_text = key_as_text;
        _modules["read_book.shortcuts"].common_shortcuts = common_shortcuts;
        _modules["read_book.shortcuts"].shortcuts_definition = shortcuts_definition;
        _modules["read_book.shortcuts"].shortcuts_group_desc = shortcuts_group_desc;
        _modules["read_book.shortcuts"].add_standalone_viewer_shortcuts = add_standalone_viewer_shortcuts;
        _modules["read_book.shortcuts"].create_shortcut_map = create_shortcut_map;
        _modules["read_book.shortcuts"].shortcut_for_key_event = shortcut_for_key_event;
    })();

    (function(){
        var __name__ = "read_book.hints";
        var clear = _modules.dom.clear;

        var E = _modules.elementmaker.E;

        var get_color = _modules["book_list.theme"].get_color;

        var _ = _modules.gettext.gettext;

        var shortcut_for_key_event = _modules["read_book.shortcuts"].shortcut_for_key_event;

        function Hints() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Hints.prototype.__bind_methods__.call(this);
            Hints.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Hints.prototype, "__bind_methods__", {value: function () {
            this.reset = Hints.prototype.reset.bind(this);
            this.focus = Hints.prototype.focus.bind(this);
            this.hide = Hints.prototype.hide.bind(this);
            this.show = Hints.prototype.show.bind(this);
            this.on_keydown = Hints.prototype.on_keydown.bind(this);
            this.container_clicked = Hints.prototype.container_clicked.bind(this);
            this.apply_prefix = Hints.prototype.apply_prefix.bind(this);
            this.send_message = Hints.prototype.send_message.bind(this);
            this.handle_message = Hints.prototype.handle_message.bind(this);
            this.no_hints_found = Hints.prototype.no_hints_found.bind(this);
        }});
        Object.defineProperties(Hints.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById("book-hints-overlay");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        Hints.prototype.__init__ = function __init__(view) {
            var self = this;
            var container;
            self.view = view;
            container = self.container;
            container.setAttribute("tabindex", "0");
            container.style.overflow = "hidden";
            container.addEventListener("keydown", self.on_keydown, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("click", self.container_clicked, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            self.reset();
        };
        if (!Hints.prototype.__init__.__argnames__) Object.defineProperties(Hints.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.hints"}
        });
        Hints.__argnames__ = Hints.prototype.__init__.__argnames__;
        Hints.__handles_kwarg_interpolation__ = Hints.prototype.__init__.__handles_kwarg_interpolation__;
        Hints.prototype.reset = function reset() {
            var self = this;
            self.hints_map = Object.create(null);
            self.current_prefix = "";
        };
        if (!Hints.prototype.reset.__module__) Object.defineProperties(Hints.prototype.reset, {
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.focus = function focus() {
            var self = this;
            self.container.focus();
        };
        if (!Hints.prototype.focus.__module__) Object.defineProperties(Hints.prototype.focus, {
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.hide = function hide() {
            var self = this;
            if (self.is_visible) {
                self.container.style.display = "none";
                self.send_message("hide");
                self.reset();
                self.view.focus_iframe();
            }
        };
        if (!Hints.prototype.hide.__module__) Object.defineProperties(Hints.prototype.hide, {
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.show = function show() {
            var self = this;
            var c;
            if (!self.is_visible) {
                self.reset();
                c = self.container;
                c.style.display = "block";
                clear(c);
                self.focus();
                self.send_message("show");
            }
        };
        if (!Hints.prototype.show.__module__) Object.defineProperties(Hints.prototype.show, {
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.on_keydown = function on_keydown(ev) {
            var self = this;
            var hint_keys, q, sc_name;
            [ev.preventDefault(), ev.stopPropagation()];
            if (ev.key === "Escape") {
                self.hide();
                return;
            }
            if (ev.key === "Enter") {
                if (self.current_prefix) {
                    self.apply_prefix(true);
                }
                return;
            }
            if (ev.key === "Backspace") {
                if (self.current_prefix) {
                    self.current_prefix = self.current_prefix.slice(0, -1);
                    self.apply_prefix();
                }
                return;
            }
            hint_keys = list("1234567890abcdefghijklmnopqrstuvwxyz");
            q = ev.key.toLowerCase();
            if (hint_keys.indexOf(q) > -1) {
                self.current_prefix += q;
                self.apply_prefix();
            }
            sc_name = shortcut_for_key_event(ev, self.view.keyboard_shortcut_map);
            if (!sc_name) {
                return;
            }
        };
        if (!Hints.prototype.on_keydown.__argnames__) Object.defineProperties(Hints.prototype.on_keydown, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.container_clicked = function container_clicked(ev) {
            var self = this;
            [ev.stopPropagation(), ev.preventDefault()];
            self.hide();
        };
        if (!Hints.prototype.container_clicked.__argnames__) Object.defineProperties(Hints.prototype.container_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.apply_prefix = function apply_prefix(accept_full_match) {
            var self = this;
            var matches, q, k;
            matches = [];
            if (self.current_prefix) {
                var _Iter0 = _Iterable(Object.keys(self.hints_map));
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    k = _Iter0[_Index0];
                    if (k === "_length") {
                        continue;
                    }
                    q = encode(int(k));
                    if (accept_full_match) {
                        if (q === self.current_prefix) {
                            matches.push(k);
                            break;
                        }
                    } else if (q.startswith(self.current_prefix)) {
                        matches.push(k);
                    }
                }
            }
            if (matches.length === 1) {
                _interpolate_kwargs.call(self, self.send_message, ["activate"].concat([_desugar_kwargs({hint: (_expr_temp = self.hints_map)[_bound_index(matches[0], _expr_temp)]})]));
                self.hide();
            } else {
                _interpolate_kwargs.call(self, self.send_message, ["apply_prefix"].concat([_desugar_kwargs({prefix: self.current_prefix})]));
            }
        };
        if (!Hints.prototype.apply_prefix.__argnames__) Object.defineProperties(Hints.prototype.apply_prefix, {
            __argnames__ : {value: ["accept_full_match"]},
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.send_message = function send_message() {
            var self = this;
            var type = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            _interpolate_kwargs.call(self.view.iframe_wrapper, self.view.iframe_wrapper.send_message, ["hints"].concat([_desugar_kwargs(kw, {type: type})]));
        };
        if (!Hints.prototype.send_message.__handles_kwarg_interpolation__) Object.defineProperties(Hints.prototype.send_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["type"]},
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.handle_message = function handle_message(msg) {
            var self = this;
            if (msg.type === "shown") {
                self.reset();
                self.hints_map = msg.hints_map;
                if (!self.hints_map._length) {
                    self.no_hints_found();
                }
            }
        };
        if (!Hints.prototype.handle_message.__argnames__) Object.defineProperties(Hints.prototype.handle_message, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.no_hints_found = function no_hints_found() {
            var self = this;
            var c;
            c = self.container;
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_("No links found. Press Esc to close")].concat([_desugar_kwargs({style: "position: absolute; margin: auto; top: 50%; left: 50%; background: " + _str.format("{}", get_color("window-background")) + ";" + " padding: 1rem; border: solid 1px currentColor; border-radius: 4px; transform: translate(-50%, -50%);"})])));
        };
        if (!Hints.prototype.no_hints_found.__module__) Object.defineProperties(Hints.prototype.no_hints_found, {
            __module__ : {value: "read_book.hints"}
        });
        Hints.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Hints.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Hints.prototype, "__bases__", {value: []});
        
        

        function is_visible(a) {
            var rect;
            if (!a.offsetParent) {
                return false;
            }
            rect = a.getBoundingClientRect();
            return rect.left >= 0 && rect.top >= 0 && rect.left < window.innerWidth && rect.top < window.innerHeight;
        };
        if (!is_visible.__argnames__) Object.defineProperties(is_visible, {
            __argnames__ : {value: ["a"]},
            __module__ : {value: "read_book.hints"}
        });

        function encode(i) {
            return i.toString(36).toLowerCase();
        };
        if (!encode.__argnames__) Object.defineProperties(encode, {
            __argnames__ : {value: ["i"]},
            __module__ : {value: "read_book.hints"}
        });

        function hint_visible_links() {
            var i, hint_map, h, a;
            i = 0;
            hint_map = Object.create(null);
            var _Iter1 = _Iterable(document.body.querySelectorAll("a[href]"));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                a = _Iter1[_Index1];
                if (is_visible(a)) {
                    i += 1;
                    h = i + "";
                    a.dataset.calibreHintRender = encode(i);
                    a.dataset.calibreHintValue = h;
                    a.classList.add("calibre-hint-visible");
                    hint_map[(typeof h === "number" && h < 0) ? hint_map.length + h : h] = (function(){
                        var _d = Object.create(null);
                        _d["type"] = "link";
                        _d["value"] = i;
                        return _d;
                    }).call(this);
                }
            }
            hint_map._length = i;
            return hint_map;
        };
        if (!hint_visible_links.__module__) Object.defineProperties(hint_visible_links, {
            __module__ : {value: "read_book.hints"}
        });

        function unhint_links() {
            var a;
            var _Iter2 = _Iterable(document.body.querySelectorAll("a[href]"));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                a = _Iter2[_Index2];
                a.classList.remove("calibre-hint-visible", "calibre-hint-enter");
                delete a.dataset.calibreHintRender;
                delete a.dataset.calibreHintValue;
            }
        };
        if (!unhint_links.__module__) Object.defineProperties(unhint_links, {
            __module__ : {value: "read_book.hints"}
        });

        function apply_prefix_to_hints(prefix) {
            var val, r, leftover, a;
            var _Iter3 = _Iterable(document.body.querySelectorAll("[data-calibre-hint-value]"));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                a = _Iter3[_Index3];
                val = int(a.dataset.calibreHintValue);
                r = encode(val);
                a.classList.remove("calibre-hint-enter");
                if (!prefix || r.startsWith(prefix)) {
                    a.classList.add("calibre-hint-visible");
                    a.dataset.calibreHintRender = leftover = r.slice(prefix.length) || "";
                    if (leftover === "") {
                        a.classList.add("calibre-hint-enter");
                    }
                } else {
                    a.classList.remove("calibre-hint-visible");
                }
            }
        };
        if (!apply_prefix_to_hints.__argnames__) Object.defineProperties(apply_prefix_to_hints, {
            __argnames__ : {value: ["prefix"]},
            __module__ : {value: "read_book.hints"}
        });

        _modules["read_book.hints"].Hints = Hints;
        _modules["read_book.hints"].is_visible = is_visible;
        _modules["read_book.hints"].encode = encode;
        _modules["read_book.hints"].hint_visible_links = hint_visible_links;
        _modules["read_book.hints"].unhint_links = unhint_links;
        _modules["read_book.hints"].apply_prefix_to_hints = apply_prefix_to_hints;
    })();

    (function(){
        var __name__ = "read_book.mathjax";
        var standalone_proceed_data;
        var E = _modules.elementmaker.E;

        var runtime = _modules["read_book.globals"].runtime;

        function get_url(mathjax_files, name) {
            var ans;
            ans = mathjax_files[(typeof name === "number" && name < 0) ? mathjax_files.length + name : name];
            if (!ans) {
                return name;
            }
            if (typeof ans !== "string") {
                ans = mathjax_files[(typeof name === "number" && name < 0) ? mathjax_files.length + name : name] = window.URL.createObjectURL(ans);
            }
            return ans;
        };
        if (!get_url.__argnames__) Object.defineProperties(get_url, {
            __argnames__ : {value: ["mathjax_files", "name"]},
            __module__ : {value: "read_book.mathjax"}
        });

        function postprocess(link_uid) {
            var href, a;
            var _Iter0 = _Iterable(document.getElementsByTagName("a"));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                a = _Iter0[_Index0];
                href = a.getAttribute("href");
                if (href && href.startswith("#")) {
                    a.setAttribute("href", "javascript: void(0)");
                    a.setAttribute("data-" + link_uid, JSON.stringify((function(){
                        var _d = Object.create(null);
                        _d["frag"] = href.slice(1);
                        return _d;
                    }).call(this)));
                }
            }
        };
        if (!postprocess.__argnames__) Object.defineProperties(postprocess, {
            __argnames__ : {value: ["link_uid"]},
            __module__ : {value: "read_book.mathjax"}
        });

        function load_mathjax(src) {
            var script;
            script = _interpolate_kwargs.call(E, E.script, [_desugar_kwargs({type: "text/javascript"})]);
            script.async = true;
            script.src = src;
            document.head.appendChild(script);
        };
        if (!load_mathjax.__argnames__) Object.defineProperties(load_mathjax, {
            __argnames__ : {value: ["src"]},
            __module__ : {value: "read_book.mathjax"}
        });

        standalone_proceed_data = (function(){
            var _d = Object.create(null);
            _d["link_uid"] = null;
            _d["proceed"] = null;
            _d["event_listender_added"] = false;
            return _d;
        }).call(this);
        function standalone_proceed() {
            if (standalone_proceed_data.proceed) {
                postprocess(standalone_proceed_data.link_uid);
                standalone_proceed_data.proceed();
                standalone_proceed_data.proceed = null;
            }
        };
        if (!standalone_proceed.__module__) Object.defineProperties(standalone_proceed, {
            __module__ : {value: "read_book.mathjax"}
        });

        function apply_mathjax(mathjax_files, link_uid, proceed) {
            var es, s;
            if (runtime.is_standalone_viewer) {
                if (!standalone_proceed_data.event_listender_added) {
                    standalone_proceed_data.event_listender_added = true;
                    document.documentElement.addEventListener("calibre-mathjax-typeset-done", standalone_proceed);
                }
                if (standalone_proceed_data.proceed) {
                    print("MathJax apply called while a previous apply is still running");
                }
                standalone_proceed_data.link_uid = link_uid;
                standalone_proceed_data.proceed = proceed;
                load_mathjax("" + _str.format("{}", runtime.FAKE_PROTOCOL) + "://" + _str.format("{}", runtime.SANDBOX_HOST) + "/mathjax/startup.js");
                return;
            }
            window.MathJax = {};
            window.MathJax.startup = (function(){
                var _d = Object.create(null);
                _d["ready"] = (function() {
                    var _anonfunc = function () {
                        window.MathJax.startup.defaultReady();
                        window.MathJax.startup.output.font.addFontURLs = (function() {
                            var _anonfunc = function (styles, fonts, url) {
                                var base, clone, font, key, font_name, full_name, src, name;
                                base = url.partition("/")[2];
                                var _Iter1 = _Iterable(fonts);
                                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                                    name = _Iter1[_Index1];
                                    clone = {};
                                    font = fonts[(typeof name === "number" && name < 0) ? fonts.length + name : name];
                                    var _Iter2 = _Iterable(Object.keys(font));
                                    for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                                        key = _Iter2[_Index2];
                                        clone[(typeof key === "number" && key < 0) ? clone.length + key : key] = font[(typeof key === "number" && key < 0) ? font.length + key : key];
                                    }
                                    font_name = clone.src.partition("/")[2].partition("\"")[0];
                                    full_name = base + "/" + font_name;
                                    src = get_url(mathjax_files, full_name);
                                    clone.src = clone.src.replace(/".+?"/, "\"" + _str.format("{}", src) + "\"");
                                    styles[(typeof name === "number" && name < 0) ? styles.length + name : name] = clone;
                                }
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["styles", "fonts", "url"]},
                                __module__ : {value: "read_book.mathjax"}
                            });
                            return _anonfunc;
                        })();
                        window.MathJax.startup.promise.then((function() {
                            var _anonfunc = function () {
                                postprocess(link_uid);
                                proceed();
                            };
                            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                __module__ : {value: "read_book.mathjax"}
                            });
                            return _anonfunc;
                        })());
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.mathjax"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
            window.MathJax.loader = (function(){
                var _d = Object.create(null);
                _d["load"] = ['input/tex-full', 'input/asciimath', 'input/mml', 'output/chtml'];
                _d["require"] = (function() {
                    var _anonfunc = function (url) {
                        return new Promise((function() {
                            var _anonfunc = function (resolve, reject) {
                                var name, script;
                                name = url.partition("/")[2];
                                script = document.createElement("script");
                                script.charset = "UTF-8";
                                script.onload = (function() {
                                    var _anonfunc = function () {
                                        resolve(url);
                                    };
                                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                        __module__ : {value: "read_book.mathjax"}
                                    });
                                    return _anonfunc;
                                })();
                                script.onerror = (function() {
                                    var _anonfunc = function () {
                                        reject(url);
                                    };
                                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                        __module__ : {value: "read_book.mathjax"}
                                    });
                                    return _anonfunc;
                                })();
                                script.src = get_url(mathjax_files, name);
                                document.head.appendChild(script);
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["resolve", "reject"]},
                                __module__ : {value: "read_book.mathjax"}
                            });
                            return _anonfunc;
                        })());
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["url"]},
                        __module__ : {value: "read_book.mathjax"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
            var _Iter3 = _Iterable(document.scripts);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                s = _Iter3[_Index3];
                if (s.type === "text/x-mathjax-config") {
                    es = document.createElement("script");
                    es.text = s.text;
                    document.head.appendChild(es);
                    document.head.removeChild(es);
                }
            }
            load_mathjax(get_url(mathjax_files, "startup.js"));
        };
        if (!apply_mathjax.__argnames__) Object.defineProperties(apply_mathjax, {
            __argnames__ : {value: ["mathjax_files", "link_uid", "proceed"]},
            __module__ : {value: "read_book.mathjax"}
        });

        _modules["read_book.mathjax"].standalone_proceed_data = standalone_proceed_data;
        _modules["read_book.mathjax"].get_url = get_url;
        _modules["read_book.mathjax"].postprocess = postprocess;
        _modules["read_book.mathjax"].load_mathjax = load_mathjax;
        _modules["read_book.mathjax"].standalone_proceed = standalone_proceed;
        _modules["read_book.mathjax"].apply_mathjax = apply_mathjax;
    })();

    (function(){
        var __name__ = "read_book.paged_mode";
        var _in_paged_mode, col_size, screen_inline, screen_block, cols_per_screen, gap, col_and_gap, last_scrolled_to_column, is_full_screen_layout, scroll_resize_bug_watcher, wheel_handler, onwheel, anchor_funcs, resize_manager, drag_scroller;
        var traceback = _modules.traceback;

        var E = _modules.elementmaker.E;

        var set_important_css = _modules.dom.set_important_css;

        var cfi_at_current = _modules["read_book.cfi"].at_current;
        var cfi_at_point = _modules["read_book.cfi"].at_point;
        var cfi_scroll_to = _modules["read_book.cfi"].scroll_to;

        var current_spine_item = _modules["read_book.globals"].current_spine_item;
        var get_boss = _modules["read_book.globals"].get_boss;
        var rtl_page_progression = _modules["read_book.globals"].rtl_page_progression;

        var opts = _modules["read_book.settings"].opts;

        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;
        var line_height = _modules["read_book.viewport"].line_height;
        var rem_size = _modules["read_book.viewport"].rem_size;
        var get_unit_size_in_pixels = _modules["read_book.viewport"].get_unit_size_in_pixels;

        var get_elem_data = _modules.utils.get_elem_data;
        var set_elem_data = _modules.utils.set_elem_data;

        function first_child(parent) {
            var c, count;
            c = parent.firstChild;
            count = 0;
            while ((typeof c !== "undefined" && c !== null ? c : Object.create(null)).nodeType !== Node.ELEMENT_NODE && count < 20) {
                c = (typeof c !== "undefined" && c !== null ? c : Object.create(null)).nextSibling;
                count += 1;
            }
            if ((typeof c !== "undefined" && c !== null ? c : Object.create(null)).nodeType === Node.ELEMENT_NODE) {
                return c;
            }
        };
        if (!first_child.__argnames__) Object.defineProperties(first_child, {
            __argnames__ : {value: ["parent"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function has_start_text(elem) {
            var c;
            var _Iter0 = _Iterable(elem.childNodes);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                c = _Iter0[_Index0];
                if (c.nodeType !== Node.TEXT_NODE) {
                    break;
                }
                if (c.nodeType === Node.TEXT_NODE && c.nodeValue && /\S/.test(c.nodeValue)) {
                    return true;
                }
            }
            return false;
        };
        if (!has_start_text.__argnames__) Object.defineProperties(has_start_text, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function handle_rtl_body(body_style) {
            if (body_style.direction === "rtl") {
                document.documentElement.style.overflow = "visible";
            }
        };
        if (!handle_rtl_body.__argnames__) Object.defineProperties(handle_rtl_body, {
            __argnames__ : {value: ["body_style"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function create_page_div(elem) {
            var div;
            div = E("blank-page-div", " \n    ");
            document.body.appendChild(div);
            _interpolate_kwargs.call(this, set_important_css, [div].concat([_desugar_kwargs({break_before: "column", break_inside: "avoid", display: "block", white_space: "pre", background_color: "transparent", background_image: "none", border_width: "0", float: "none", position: "static", min_height: "100vh"})]));
        };
        if (!create_page_div.__argnames__) Object.defineProperties(create_page_div, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        _in_paged_mode = false;
        function in_paged_mode() {
            return _in_paged_mode;
        };
        if (!in_paged_mode.__module__) Object.defineProperties(in_paged_mode, {
            __module__ : {value: "read_book.paged_mode"}
        });

        col_size = screen_inline = screen_block = cols_per_screen = gap = col_and_gap = last_scrolled_to_column = 0;
        is_full_screen_layout = false;
        function get_number_of_cols(dont_return_integer) {
            var ans;
            if (is_full_screen_layout) {
                return 1;
            }
            ans = (scroll_viewport.paged_content_inline_size() + gap) / col_and_gap;
            if (!dont_return_integer) {
                ans = Math.floor(ans);
            }
            return ans;
        };
        if (!get_number_of_cols.__argnames__) Object.defineProperties(get_number_of_cols, {
            __argnames__ : {value: ["dont_return_integer"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function reset_paged_mode_globals() {
            scroll_viewport.reset_globals();
            col_size = screen_inline = screen_block = cols_per_screen = gap = col_and_gap = last_scrolled_to_column = 0;
            is_full_screen_layout = _in_paged_mode = false;
            resize_manager.reset();
        };
        if (!reset_paged_mode_globals.__module__) Object.defineProperties(reset_paged_mode_globals, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function column_at(pos) {
            var si;
            si = scroll_viewport.paged_content_inline_size();
            if (pos >= si - col_and_gap) {
                pos = si - col_size + 10;
            }
            return Math.floor(max(0, pos + gap - 1) / col_and_gap);
        };
        if (!column_at.__argnames__) Object.defineProperties(column_at, {
            __argnames__ : {value: ["pos"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function fit_images() {
            var inline_limited_images, block_limited_images, img_tags, bounding_rects, img_tag, maxb, img, br, previously_limited, data, image_start, col_start, column_start_to_image_start, image_block_size, image_inline_size, image_inline_end, i, _unpack, max_inline_size;
            inline_limited_images = [];
            block_limited_images = [];
            img_tags = document.getElementsByTagName("img");
            bounding_rects = [];
            var _Iter1 = _Iterable(img_tags);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                img_tag = _Iter1[_Index1];
                bounding_rects.push(get_bounding_client_rect(img_tag));
            }
            maxb = screen_block;
            for (var _Index2 = 0; _Index2 < img_tags.length; _Index2++) {
                i = _Index2;
                img = img_tags[(typeof i === "number" && i < 0) ? img_tags.length + i : i];
                br = bounding_rects[(typeof i === "number" && i < 0) ? bounding_rects.length + i : i];
                previously_limited = get_elem_data(img, "inline-limited", false);
                data = get_elem_data(img, "img-data", null);
                if (data === null) {
                    data = (function(){
                        var _d = Object.create(null);
                        _d["left"] = br.left;
                        _d["right"] = br.right;
                        _d["height"] = br.height;
                        _d["display"] = img.style.display;
                        return _d;
                    }).call(this);
                    set_elem_data(img, "img-data", data);
                }
                image_start = scroll_viewport.viewport_to_document_inline(scroll_viewport.rect_inline_start(br), img.ownerDocument);
                col_start = column_at(image_start) * col_and_gap;
                column_start_to_image_start = image_start - col_start;
                image_block_size = scroll_viewport.rect_block_size(br);
                image_inline_size = scroll_viewport.rect_inline_size(br);
                image_inline_end = column_start_to_image_start + image_inline_size;
                if (previously_limited || image_inline_end > col_size) {
                    inline_limited_images.push([img, col_size - column_start_to_image_start]);
                }
                previously_limited = get_elem_data(img, "block-limited", false);
                if (previously_limited || image_block_size > maxb || image_block_size === maxb && image_inline_size > col_size) {
                    block_limited_images.push(img);
                }
                if (previously_limited) {
                    _interpolate_kwargs.call(this, set_important_css, [img].concat([_desugar_kwargs({break_before: "auto", display: data.display})]));
                }
                _interpolate_kwargs.call(this, set_important_css, [img].concat([_desugar_kwargs({break_inside: "avoid"})]));
            }
            var _Iter3 = _Iterable(inline_limited_images);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                _unpack = _Iter3[_Index3];
                img_tag = _unpack[0];
                max_inline_size = _unpack[1];
                if (scroll_viewport.vertical_writing_mode) {
                    img_tag.style.setProperty("max-height", max_inline_size + "px");
                } else {
                    img_tag.style.setProperty("max-width", max_inline_size + "px");
                }
                set_elem_data(img_tag, "inline-limited", true);
            }
            var _Iter4 = _Iterable(block_limited_images);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                img_tag = _Iter4[_Index4];
                if (scroll_viewport.vertical_writing_mode) {
                    _interpolate_kwargs.call(this, set_important_css, [img_tag].concat([_desugar_kwargs({break_before: "always", max_width: "100vw"})]));
                } else {
                    _interpolate_kwargs.call(this, set_important_css, [img_tag].concat([_desugar_kwargs({break_before: "always", max_height: "100vh"})]));
                }
                set_elem_data(img_tag, "block-limited", true);
            }
        };
        if (!fit_images.__module__) Object.defineProperties(fit_images, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function cps_by_em_size() {
            var ans, fs;
            ans = cps_by_em_size.ans;
            fs = window.getComputedStyle(document.body).fontSize;
            if (!ans || cps_by_em_size.at_font_size !== fs) {
                if (fs === 0) {
                    ans = cps_by_em_size.ans = 16;
                } else {
                    ans = cps_by_em_size.ans = max(2, get_unit_size_in_pixels("rem"));
                }
                cps_by_em_size.at_font_size = fs;
            }
            return ans;
        };
        if (!cps_by_em_size.__module__) Object.defineProperties(cps_by_em_size, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function calc_columns_per_screen() {
            var cps;
            cps = opts.columns_per_screen || Object.create(null);
            cps = (scroll_viewport.width() > scroll_viewport.height()) ? cps.landscape : cps.portrait;
            try {
                cps = int(cps);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    cps = 0;
                } 
            }
            if (!cps) {
                cps = int(Math.floor(scroll_viewport.inline_size() / (35 * cps_by_em_size())));
            }
            cps = max(1, min(cps || 1, 20));
            return cps;
        };
        if (!calc_columns_per_screen.__module__) Object.defineProperties(calc_columns_per_screen, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function get_columns_per_screen_data() {
            var which;
            which = (scroll_viewport.width() > scroll_viewport.height()) ? "landscape" : "portrait";
            return (function(){
                var _d = Object.create(null);
                _d["which"] = which;
                _d["cps"] = calc_columns_per_screen();
                return _d;
            }).call(this);
        };
        if (!get_columns_per_screen_data.__module__) Object.defineProperties(get_columns_per_screen_data, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function will_columns_per_screen_change() {
            return _not_equals(calc_columns_per_screen(), cols_per_screen);
        };
        if (!will_columns_per_screen_change.__module__) Object.defineProperties(will_columns_per_screen_change, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function ScrollResizeBugWatcher() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ScrollResizeBugWatcher.prototype.__bind_methods__.call(this);
            ScrollResizeBugWatcher.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ScrollResizeBugWatcher.prototype, "__bind_methods__", {value: function () {
            this.layout_done = ScrollResizeBugWatcher.prototype.layout_done.bind(this);
            this.scrolled = ScrollResizeBugWatcher.prototype.scrolled.bind(this);
            this.cancel_timer = ScrollResizeBugWatcher.prototype.cancel_timer.bind(this);
            this.check_for_resize_bug = ScrollResizeBugWatcher.prototype.check_for_resize_bug.bind(this);
            this.redo_scroll = ScrollResizeBugWatcher.prototype.redo_scroll.bind(this);
        }});
        ScrollResizeBugWatcher.prototype.__init__ = function __init__() {
            var self = this;
            self.max_time = 750;
            self.last_layout_at = 0;
            self.last_command = null;
            self.doc_size = 0;
            self.timer = null;
        };
        if (!ScrollResizeBugWatcher.prototype.__init__.__module__) Object.defineProperties(ScrollResizeBugWatcher.prototype.__init__, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ScrollResizeBugWatcher.__argnames__ = ScrollResizeBugWatcher.prototype.__init__.__argnames__;
        ScrollResizeBugWatcher.__handles_kwarg_interpolation__ = ScrollResizeBugWatcher.prototype.__init__.__handles_kwarg_interpolation__;
        ScrollResizeBugWatcher.prototype.layout_done = function layout_done() {
            var self = this;
            self.last_layout_at = window.performance.now();
            self.last_command = null;
            self.cancel_timer();
        };
        if (!ScrollResizeBugWatcher.prototype.layout_done.__module__) Object.defineProperties(ScrollResizeBugWatcher.prototype.layout_done, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ScrollResizeBugWatcher.prototype.scrolled = function scrolled(pos, limit) {
            var self = this;
            var now;
            self.cancel_timer();
            now = window.performance.now();
            if (now - self.last_layout_at < self.max_time && self.last_command !== null) {
                self.doc_size = scroll_viewport.paged_content_inline_size();
                self.check_for_resize_bug();
            }
        };
        if (!ScrollResizeBugWatcher.prototype.scrolled.__argnames__) Object.defineProperties(ScrollResizeBugWatcher.prototype.scrolled, {
            __argnames__ : {value: ["pos", "limit"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        ScrollResizeBugWatcher.prototype.cancel_timer = function cancel_timer() {
            var self = this;
            if (self.timer !== null) {
                window.clearTimeout(self.timer);
                self.timer = null;
            }
        };
        if (!ScrollResizeBugWatcher.prototype.cancel_timer.__module__) Object.defineProperties(ScrollResizeBugWatcher.prototype.cancel_timer, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ScrollResizeBugWatcher.prototype.check_for_resize_bug = function check_for_resize_bug() {
            var self = this;
            var sz, now;
            sz = scroll_viewport.paged_content_inline_size();
            if ((sz !== self.doc_size && (typeof sz !== "object" || _not_equals(sz, self.doc_size)))) {
                return self.redo_scroll();
            }
            now = window.performance.now();
            if (now - self.last_layout_at < self.max_time) {
                window.setTimeout(self.check_for_resize_bug, 10);
            } else {
                self.timer = null;
            }
        };
        if (!ScrollResizeBugWatcher.prototype.check_for_resize_bug.__module__) Object.defineProperties(ScrollResizeBugWatcher.prototype.check_for_resize_bug, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ScrollResizeBugWatcher.prototype.redo_scroll = function redo_scroll() {
            var self = this;
            if (self.last_command) {
                self.last_command();
                self.last_command = null;
            }
            self.timer = null;
            self.doc_size = 0;
        };
        if (!ScrollResizeBugWatcher.prototype.redo_scroll.__module__) Object.defineProperties(ScrollResizeBugWatcher.prototype.redo_scroll, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ScrollResizeBugWatcher.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ScrollResizeBugWatcher.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ScrollResizeBugWatcher.prototype, "__bases__", {value: []});

        scroll_resize_bug_watcher = new ScrollResizeBugWatcher;
        function layout(is_single_page, on_resize) {
            var body_style, first_layout, cps, single_screen, svgs, has_svg, imgs, only_img, num, elems, n, margin_size, overhang, c, c2, has_no_more_than_two_columns;
            line_height(true);
            rem_size(true);
            body_style = window.getComputedStyle(document.body);
            scroll_viewport.initialize_on_layout(body_style);
            first_layout = !_in_paged_mode;
            cps = calc_columns_per_screen();
            if (first_layout) {
                handle_rtl_body(body_style);
                single_screen = scroll_viewport.document_block_size() < scroll_viewport.block_size() + 75;
                first_layout = true;
                svgs = document.getElementsByTagName("svg");
                has_svg = svgs.length > 0;
                imgs = document.getElementsByTagName("img");
                only_img = imgs.length === 1 && document.getElementsByTagName("div").length < 3 && document.getElementsByTagName("p").length < 2;
                if (only_img && window.getComputedStyle(imgs[0]).zIndex < 0) {
                    imgs[0].style.zIndex = "0";
                }
                if (!single_screen && cps > 1) {
                    num = cps - 1;
                    elems = document.querySelectorAll("body > *");
                    if (elems.length === 1) {
                        elems[0].style.height = "auto";
                    }
                    while (num > 0) {
                        num -= 1;
                        create_page_div();
                    }
                }
            }
            n = cols_per_screen = cps;
            col_size = screen_inline = scroll_viewport.inline_size();
            margin_size = (scroll_viewport.horizontal_writing_mode) ? opts.margin_left + opts.margin_right : opts.margin_top + opts.margin_bottom;
            margin_size = max(1, margin_size);
            gap = margin_size;
            if (n > 1) {
                overhang = (screen_inline + gap) % n;
                if (overhang !== 0) {
                    gap += n - overhang;
                }
                col_size = Math.floor((screen_inline + gap) / n) - gap;
            }
            screen_block = scroll_viewport.block_size();
            col_and_gap = col_size + gap;
            _interpolate_kwargs.call(this, set_important_css, [document.body].concat([_desugar_kwargs({column_gap: gap + "px", column_width: col_size + "px", column_rule: "0px inset blue", min_width: "0", max_width: "none", min_height: "0", max_height: "100vh", column_fill: "auto", margin: "0", border_width: "0", padding: "0", box_sizing: "content-box", width: scroll_viewport.width() + "px", height: scroll_viewport.height() + "px", overflow_wrap: "break-word"})]));
            document.body.style.setProperty("-webkit-margin-collapse", "separate");
            c = first_child(document.body);
            if (c) {
                _interpolate_kwargs.call(this, set_important_css, [c].concat([_desugar_kwargs({break_before: "avoid"})]));
                if (c.tagName.toLowerCase() === "div") {
                    c2 = first_child(c);
                    if (c2 && !has_start_text(c)) {
                        _interpolate_kwargs.call(this, set_important_css, [c2].concat([_desugar_kwargs({break_before: "avoid"})]));
                    }
                }
            }
            if (first_layout) {
                is_full_screen_layout = is_single_page;
                if (!is_full_screen_layout) {
                    has_no_more_than_two_columns = scroll_viewport.paged_content_inline_size() < 2 * screen_inline + 10;
                    if (has_no_more_than_two_columns && single_screen) {
                        if (only_img && imgs.length && get_bounding_client_rect(imgs[0]).left < screen_inline) {
                            is_full_screen_layout = true;
                        }
                        if (has_svg && (svgs.length === 1 || typeof svgs.length === "object" && _equals(svgs.length, 1)) && get_bounding_client_rect(svgs[0]).left < screen_inline) {
                            is_full_screen_layout = true;
                        }
                    }
                }
                if (is_full_screen_layout && only_img && cols_per_screen > 1) {
                    cols_per_screen = 1;
                    col_size = screen_inline;
                    col_and_gap = col_size + gap;
                    document.body.style.columnWidth = "100vw";
                }
            }
            function check_column_sizes() {
                var nc, data;
                nc = get_number_of_cols(true);
                if (Math.floor(nc) !== nc) {
                    data = (function(){
                        var _d = Object.create(null);
                        _d["col_size"] = col_size;
                        _d["gap"] = gap;
                        _d["scrollWidth"] = scroll_viewport.paged_content_inline_size();
                        _d["ncols"] = nc;
                        _d["screen_inline"] = screen_inline;
                        return _d;
                    }).call(this);
                    print("WARNING: column layout broken, probably because there is some non-reflowable content in the book whose inline size is greater than the column size", data);
                }
            };
            if (!check_column_sizes.__module__) Object.defineProperties(check_column_sizes, {
                __module__ : {value: "read_book.paged_mode"}
            });

            check_column_sizes();
            _in_paged_mode = true;
            fit_images();
            scroll_resize_bug_watcher.layout_done();
            return gap;
        };
        if (!layout.__argnames__) Object.defineProperties(layout, {
            __argnames__ : {value: ["is_single_page", "on_resize"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function current_scroll_offset() {
            return scroll_viewport.inline_pos();
        };
        if (!current_scroll_offset.__module__) Object.defineProperties(current_scroll_offset, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_offset(offset) {
            scroll_viewport.scroll_to_in_inline_direction(offset);
        };
        if (!scroll_to_offset.__argnames__) Object.defineProperties(scroll_to_offset, {
            __argnames__ : {value: ["offset"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_column() {
            var number = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var notify = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? scroll_to_column.__defaults__.notify : arguments[1];
            var duration = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? scroll_to_column.__defaults__.duration : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "notify")){
                notify = _kwargs_obj.notify;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "duration")){
                duration = _kwargs_obj.duration;
            }
            var pos, limit;
            last_scrolled_to_column = number;
            pos = number * col_and_gap;
            limit = scroll_viewport.paged_content_inline_size() - scroll_viewport.inline_size();
            pos = min(pos, limit);
            scroll_to_offset(pos);
            scroll_resize_bug_watcher.scrolled(pos, limit);
        };
        if (!scroll_to_column.__defaults__) Object.defineProperties(scroll_to_column, {
            __defaults__ : {value: {notify:false, duration:1e3}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["number", "notify", "duration"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_pos() {
            var pos = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var notify = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? scroll_to_pos.__defaults__.notify : arguments[1];
            var duration = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? scroll_to_pos.__defaults__.duration : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "notify")){
                notify = _kwargs_obj.notify;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "duration")){
                duration = _kwargs_obj.duration;
            }
            if (typeof pos !== "number") {
                print(pos, "is not a number, cannot scroll to it!");
                return;
            }
            if (is_full_screen_layout) {
                scroll_to_offset(0);
                last_scrolled_to_column = 0;
                return;
            }
            _interpolate_kwargs.call(this, scroll_to_column, [column_at(pos)].concat([_desugar_kwargs({notify: notify, duration: duration})]));
        };
        if (!scroll_to_pos.__defaults__) Object.defineProperties(scroll_to_pos, {
            __defaults__ : {value: {notify:false, duration:1e3}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["pos", "notify", "duration"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_previous_position(fsd) {
            fsd = fsd || next_spine_item.forward_scroll_data;
            next_spine_item.forward_scroll_data = null;
            if (0 < (_cond_temp = fsd.cols_left) && _cond_temp < cols_per_screen && cols_per_screen < get_number_of_cols()) {
                scroll_resize_bug_watcher.last_command = scroll_to_previous_position.bind(null, fsd);
                scroll_to_column(fsd.current_col);
                return true;
            }
        };
        if (!scroll_to_previous_position.__argnames__) Object.defineProperties(scroll_to_previous_position, {
            __argnames__ : {value: ["fsd"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_fraction(frac, on_initial_load) {
            var pos;
            if (on_initial_load && frac === 1 && is_return() && scroll_to_previous_position()) {
                return;
            }
            scroll_resize_bug_watcher.last_command = scroll_to_fraction.bind(null, frac, false);
            pos = Math.floor(scroll_viewport.paged_content_inline_size() * frac);
            scroll_to_pos(pos);
        };
        if (!scroll_to_fraction.__argnames__) Object.defineProperties(scroll_to_fraction, {
            __argnames__ : {value: ["frac", "on_initial_load"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function column_boundaries() {
            var l;
            l = column_at(current_scroll_offset() + 10);
            return [l, l + cols_per_screen];
        };
        if (!column_boundaries.__module__) Object.defineProperties(column_boundaries, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function column_at_current_scroll_offset() {
            return column_at(current_scroll_offset() + 10);
        };
        if (!column_at_current_scroll_offset.__module__) Object.defineProperties(column_at_current_scroll_offset, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function current_column_location() {
            if (is_full_screen_layout) {
                return 0;
            }
            return column_at_current_scroll_offset() * col_and_gap;
        };
        if (!current_column_location.__module__) Object.defineProperties(current_column_location, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function number_of_cols_left() {
            var current_col, cols_left;
            current_col = column_at(current_scroll_offset() + 10);
            cols_left = get_number_of_cols() - (current_col + cols_per_screen);
            return Math.max(0, cols_left);
        };
        if (!number_of_cols_left.__module__) Object.defineProperties(number_of_cols_left, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function next_screen_location() {
            var cc, ans, limit, current_pos;
            if (is_full_screen_layout) {
                return -1;
            }
            cc = current_column_location();
            ans = cc + screen_inline + 1;
            if (cols_per_screen > 1 && 0 < (_cond_temp = number_of_cols_left()) && _cond_temp < cols_per_screen) {
                return -1;
            }
            limit = scroll_viewport.paged_content_inline_size() - scroll_viewport.inline_size();
            if (limit < col_and_gap) {
                return -1;
            }
            if (ans > limit) {
                current_pos = Math.ceil(current_scroll_offset());
                ans = (current_pos < limit) ? limit : -1;
                if (cols_per_screen === 1 && ans !== -1 && ans - current_pos < col_size) {
                    ans = -1;
                }
            }
            return ans;
        };
        if (!next_screen_location.__module__) Object.defineProperties(next_screen_location, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function previous_screen_location() {
            var cc, ans;
            if (is_full_screen_layout) {
                return -1;
            }
            cc = current_column_location();
            ans = cc - cols_per_screen * col_and_gap;
            if (ans < 0) {
                ans = (current_scroll_offset() > 15) ? 0 : -1;
            }
            return ans;
        };
        if (!previous_screen_location.__module__) Object.defineProperties(previous_screen_location, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function next_col_location() {
            var cc, ans, limit;
            if (is_full_screen_layout) {
                return -1;
            }
            cc = current_column_location();
            ans = cc + col_and_gap;
            limit = scroll_viewport.paged_content_inline_size() - scroll_viewport.inline_size();
            if (ans > limit) {
                if (Math.ceil(current_scroll_offset()) < limit && column_at(limit) > column_at_current_scroll_offset()) {
                    ans = limit;
                } else {
                    ans = -1;
                }
            }
            return ans;
        };
        if (!next_col_location.__module__) Object.defineProperties(next_col_location, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function previous_col_location() {
            var cc, ans;
            if (is_full_screen_layout) {
                return -1;
            }
            cc = current_column_location();
            ans = cc - col_and_gap;
            if (ans < 0) {
                if (Math.floor(current_scroll_offset()) > 0 && column_at(0) < column_at_current_scroll_offset()) {
                    ans = 0;
                } else {
                    ans = -1;
                }
            }
            return ans;
        };
        if (!previous_col_location.__module__) Object.defineProperties(previous_col_location, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function jump_to_anchor(name) {
            var elem, elems;
            elem = document.getElementById(name);
            if (!elem) {
                elems = document.getElementsByName(name);
                if (elems) {
                    elem = elems[0];
                }
            }
            if (!elem) {
                return;
            }
            scroll_to_elem(elem);
        };
        if (!jump_to_anchor.__argnames__) Object.defineProperties(jump_to_anchor, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scrollable_element(elem) {
            if (!in_paged_mode() || window.getComputedStyle(elem).display.indexOf("inline") < 0 || !elem.firstElementChild) {
                return elem;
            }
            if (window.getComputedStyle(elem.firstElementChild).display.indexOf("block") > -1 && elem.getBoundingClientRect().top < -100) {
                return elem.firstElementChild;
            }
            return elem;
        };
        if (!scrollable_element.__argnames__) Object.defineProperties(scrollable_element, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_elem(elem) {
            var br, inline_start;
            elem = scrollable_element(elem);
            scroll_viewport.scroll_into_view(elem);
            if (in_paged_mode()) {
                br = get_bounding_client_rect(elem);
                if (br.top < -100) {
                    if (scroll_viewport.horizontal_writing_mode) {
                        inline_start = (scroll_viewport.ltr) ? elem.scrollLeft : elem.scrollRight;
                    } else {
                        inline_start = elem.scrollTop;
                    }
                } else {
                    inline_start = scroll_viewport.rect_inline_start(br);
                }
                scroll_to_pos(scroll_viewport.viewport_to_document_inline(inline_start + 2, elem.ownerDocument));
            }
        };
        if (!scroll_to_elem.__argnames__) Object.defineProperties(scroll_to_elem, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function snap_to_selection() {
            var sel, r, node, pos;
            if (in_paged_mode()) {
                sel = window.getSelection();
                r = sel.getRangeAt(0).getBoundingClientRect();
                node = sel.anchorNode;
                pos = _interpolate_kwargs.call(scroll_viewport, scroll_viewport.viewport_to_document_inline, [scroll_viewport.rect_inline_start(r)].concat([_desugar_kwargs({doc: node.ownerDocument})]));
                scroll_to_pos(pos + 5);
            }
        };
        if (!snap_to_selection.__module__) Object.defineProperties(snap_to_selection, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function ensure_selection_boundary_visible(use_end) {
            var sel, rr, r, cnum, node, x, pos;
            sel = window.getSelection();
            try {
                rr = sel.getRangeAt(0);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    rr = null;
                } 
            }
            if (rr) {
                r = rr.getBoundingClientRect();
                if (r) {
                    cnum = column_at_current_scroll_offset();
                    scroll_to_column(cnum);
                    node = (use_end) ? sel.focusNode : sel.anchorNode;
                    x = (use_end) ? scroll_viewport.rect_inline_end(r) : scroll_viewport.rect_inline_start(r);
                    if (x < 0 || x >= scroll_viewport.inline_size()) {
                        pos = _interpolate_kwargs.call(scroll_viewport, scroll_viewport.viewport_to_document_inline, [x].concat([_desugar_kwargs({doc: node.ownerDocument})]));
                        scroll_to_pos(pos + 5);
                    }
                }
            }
        };
        if (!ensure_selection_boundary_visible.__argnames__) Object.defineProperties(ensure_selection_boundary_visible, {
            __argnames__ : {value: ["use_end"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function jump_to_cfi(cfi) {
            scroll_resize_bug_watcher.last_command = jump_to_cfi.bind(null, cfi);
            cfi_scroll_to(cfi, (function() {
                var _anonfunc = function (x, y) {
                    if (scroll_viewport.horizontal_writing_mode) {
                        scroll_to_pos(x);
                    } else {
                        scroll_to_pos(y);
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x", "y"]},
                    __module__ : {value: "read_book.paged_mode"}
                });
                return _anonfunc;
            })());
        };
        if (!jump_to_cfi.__argnames__) Object.defineProperties(jump_to_cfi, {
            __argnames__ : {value: ["cfi"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function current_cfi() {
            var ans, left, right, _unpack, top, bottom, midx, deltax, deltay, midy, yidx, yb, ya, ys, xidx, xb, xa, xs, cfi, curx, cury, cnum;
            ans = null;
            if (in_paged_mode()) {
                for (var _Index5 = 0; _Index5 < cols_per_screen; _Index5++) {
                    cnum = _Index5;
                    left = cnum * (col_and_gap + gap);
                    right = left + col_size;
                    _unpack = [0, scroll_viewport.height()];
                    top = _unpack[0];
                    bottom = _unpack[1];
                    midx = Math.floor((right - left) / 2);
                    deltax = Math.floor((right - left) / 24);
                    deltay = Math.floor((bottom - top) / 24);
                    midy = Math.floor((bottom - top) / 2);
                    yidx = 0;
                    while (true) {
                        _unpack = [midy - yidx * deltay, midy + yidx * deltay];
                        yb = _unpack[0];
                        ya = _unpack[1];
                        if (yb <= top || ya >= bottom) {
                            break;
                        }
                        yidx += 1;
                        ys = (ya === yb) ? [ya] : [yb, ya];
                        var _Iter6 = _Iterable(ys);
                        for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                            cury = _Iter6[_Index6];
                            xidx = 0;
                            while (true) {
                                _unpack = [midx - xidx * deltax, midx + xidx * deltax];
                                xb = _unpack[0];
                                xa = _unpack[1];
                                if (xb <= left || xa >= right) {
                                    break;
                                }
                                xidx += 1;
                                xs = (xa === xb) ? [xa] : [xb, xa];
                                var _Iter7 = _Iterable(xs);
                                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                                    curx = _Iter7[_Index7];
                                    cfi = cfi_at_point(curx, cury);
                                    if (cfi) {
                                        return cfi;
                                    }
                                }
                            }
                        }
                    }
                }
            } else {
                try {
                    ans = cfi_at_current() || null;
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        traceback.print_exc();
                    } 
                }
            }
            return ans;
        };
        if (!current_cfi.__module__) Object.defineProperties(current_cfi, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function progress_frac(frac) {
            var limit;
            if (in_paged_mode()) {
                limit = scroll_viewport.paged_content_inline_size() - scroll_viewport.inline_size();
                if (limit <= 0) {
                    return 1;
                }
                return current_scroll_offset() / limit;
            }
            limit = scroll_viewport.document_block_size() - scroll_viewport.block_size();
            if (limit <= 0) {
                return 1;
            }
            return Math.max(0, Math.min(scroll_viewport.block_pos() / limit, 1));
        };
        if (!progress_frac.__argnames__) Object.defineProperties(progress_frac, {
            __argnames__ : {value: ["frac"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function page_counts() {
            var doc_size, screen_size, pos;
            if (in_paged_mode()) {
                return (function(){
                    var _d = Object.create(null);
                    _d["current"] = column_at_current_scroll_offset();
                    _d["total"] = get_number_of_cols();
                    _d["pages_per_screen"] = cols_per_screen;
                    return _d;
                }).call(this);
            }
            doc_size = scroll_viewport.document_block_size();
            screen_size = scroll_viewport.block_size();
            pos = scroll_viewport.block_pos();
            return (function(){
                var _d = Object.create(null);
                _d["current"] = Math.floor((pos + 10) / screen_size);
                _d["total"] = Math.floor(doc_size / screen_size);
                _d["pages_per_screen"] = 1;
                return _d;
            }).call(this);
        };
        if (!page_counts.__module__) Object.defineProperties(page_counts, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function next_spine_item(backward) {
            var csi;
            if (!backward) {
                csi = current_spine_item();
                next_spine_item.forward_scroll_data = (function(){
                    var _d = Object.create(null);
                    _d["cols_per_screen"] = cols_per_screen;
                    _d["cols_left"] = number_of_cols_left();
                    _d["spine_index"] = csi.index;
                    _d["spine_name"] = csi.name;
                    _d["current_col"] = column_at(current_scroll_offset() + 10);
                    return _d;
                }).call(this);
            }
            (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_spine_item"].concat([_desugar_kwargs({previous: backward})])));
        };
        if (!next_spine_item.__argnames__) Object.defineProperties(next_spine_item, {
            __argnames__ : {value: ["backward"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function is_return() {
            var fsd, csi;
            fsd = next_spine_item.forward_scroll_data;
            csi = current_spine_item();
            return fsd && fsd.cols_per_screen === cols_per_screen && fsd.spine_index === csi.index && fsd.spine_name === csi.name;
        };
        if (!is_return.__module__) Object.defineProperties(is_return, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function WheelState() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            WheelState.prototype.__bind_methods__.call(this);
            WheelState.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(WheelState.prototype, "__bind_methods__", {value: function () {
            this.reset = WheelState.prototype.reset.bind(this);
            this.add_pixel_scroll = WheelState.prototype.add_pixel_scroll.bind(this);
        }});
        WheelState.prototype.__init__ = function __init__ () {
                    };
        WheelState.prototype.reset = function reset() {
            var self = this;
            self.last_event_mode = WheelState.prototype.last_event_mode;
            self.last_event_at = WheelState.prototype.last_event_at;
            self.last_event_backwards = WheelState.prototype.last_event_backwards;
            self.accumulated_scroll = WheelState.prototype.accumulated_scroll;
        };
        if (!WheelState.prototype.reset.__module__) Object.defineProperties(WheelState.prototype.reset, {
            __module__ : {value: "read_book.paged_mode"}
        });
        WheelState.prototype.add_pixel_scroll = function add_pixel_scroll(backward, delta, scroll_func) {
            var self = this;
            var now;
            now = window.performance.now();
            if (now - self.last_event_at > 1e3 || self.last_event_backwards !== backward || self.last_event_mode !== "pixel") {
                self.accumulated_scroll = 0;
            }
            self.last_event_mode = "pixel";
            self.last_event_at = now;
            self.last_event_backwards = backward;
            self.accumulated_scroll += delta;
            if (self.accumulated_scroll > opts.paged_pixel_scroll_threshold) {
                self.reset();
                scroll_func(backward);
            }
        };
        if (!WheelState.prototype.add_pixel_scroll.__argnames__) Object.defineProperties(WheelState.prototype.add_pixel_scroll, {
            __argnames__ : {value: ["backward", "delta", "scroll_func"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        WheelState.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        WheelState.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(WheelState.prototype, "__bases__", {value: []});
        WheelState.prototype.last_event_mode = "page";
        WheelState.prototype.last_event_at = -1e4;
        WheelState.prototype.last_event_backwards = false;
        WheelState.prototype.accumulated_scroll = 0;

        function HandleWheel() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            HandleWheel.prototype.__bind_methods__.call(this);
            HandleWheel.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(HandleWheel.prototype, "__bind_methods__", {value: function () {
            this.onwheel = HandleWheel.prototype.onwheel.bind(this);
            this.do_scroll = HandleWheel.prototype.do_scroll.bind(this);
            this.do_section_jump = HandleWheel.prototype.do_section_jump.bind(this);
        }});
        HandleWheel.prototype.__init__ = function __init__() {
            var self = this;
            self.vertical_state = new WheelState;
            self.horizontal_state = new WheelState;
        };
        if (!HandleWheel.prototype.__init__.__module__) Object.defineProperties(HandleWheel.prototype.__init__, {
            __module__ : {value: "read_book.paged_mode"}
        });
        HandleWheel.__argnames__ = HandleWheel.prototype.__init__.__argnames__;
        HandleWheel.__handles_kwarg_interpolation__ = HandleWheel.prototype.__init__.__handles_kwarg_interpolation__;
        HandleWheel.prototype.onwheel = function onwheel(evt) {
            var self = this;
            var major_axis_vertical, backward;
            if (!((evt.deltaY || evt.deltaX))) {
                return;
            }
            major_axis_vertical = true;
            if (evt.deltaY) {
                if (evt.deltaX) {
                    major_axis_vertical = Math.abs(evt.deltaY) >= Math.abs(evt.deltaX);
                }
            } else {
                major_axis_vertical = false;
            }
            if (major_axis_vertical) {
                backward = evt.deltaY < 0;
                if (evt.deltaMode === window.WheelEvent.DOM_DELTA_PIXEL) {
                    self.vertical_state.add_pixel_scroll(backward, Math.abs(evt.deltaY), self.do_scroll);
                } else {
                    self.vertical_state.reset();
                    self.do_scroll(backward);
                }
            } else {
                if (opts.paged_wheel_section_jumps) {
                    backward = evt.deltaX < 0;
                    if (evt.deltaMode === window.WheelEvent.DOM_DELTA_PIXEL) {
                        self.horizontal_state.add_pixel_scroll(backward, Math.abs(evt.deltaX), self.do_section_jump);
                    } else {
                        self.horizontal_state.reset();
                        self.do_section_jump(backward);
                    }
                }
            }
        };
        if (!HandleWheel.prototype.onwheel.__argnames__) Object.defineProperties(HandleWheel.prototype.onwheel, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        HandleWheel.prototype.do_scroll = function do_scroll(backward) {
            var self = this;
            var pos;
            if (opts.paged_wheel_scrolls_by_screen) {
                pos = (backward) ? previous_screen_location() : next_screen_location();
            } else {
                pos = (backward) ? previous_col_location() : next_col_location();
            }
            if (pos === -1) {
                next_spine_item(backward);
            } else {
                scroll_to_pos(pos);
            }
        };
        if (!HandleWheel.prototype.do_scroll.__argnames__) Object.defineProperties(HandleWheel.prototype.do_scroll, {
            __argnames__ : {value: ["backward"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        HandleWheel.prototype.do_section_jump = function do_section_jump(backward) {
            var self = this;
            (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_section"].concat([_desugar_kwargs({forward: !backward})])));
        };
        if (!HandleWheel.prototype.do_section_jump.__argnames__) Object.defineProperties(HandleWheel.prototype.do_section_jump, {
            __argnames__ : {value: ["backward"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        HandleWheel.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        HandleWheel.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(HandleWheel.prototype, "__bases__", {value: []});

        wheel_handler = new HandleWheel;
        onwheel = wheel_handler.onwheel;
        function scroll_by_page(backward, by_screen, flip_if_rtl_page_progression) {
            var pos, pages, nc, scrolled_frac;
            if (flip_if_rtl_page_progression && rtl_page_progression()) {
                backward = !backward;
            }
            if (by_screen) {
                pos = (backward) ? previous_screen_location() : next_screen_location();
                pages = cols_per_screen;
            } else {
                pos = (backward) ? previous_col_location() : next_col_location();
                pages = 1;
            }
            if (pos === -1) {
                next_spine_item(backward);
            } else {
                if (!backward) {
                    nc = get_number_of_cols();
                    scrolled_frac = (nc > 0) ? pages / nc : 0;
                    get_boss().report_human_scroll(scrolled_frac);
                } else {
                    get_boss().report_human_scroll();
                }
                scroll_to_pos(pos);
            }
        };
        if (!scroll_by_page.__argnames__) Object.defineProperties(scroll_by_page, {
            __argnames__ : {value: ["backward", "by_screen", "flip_if_rtl_page_progression"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function scroll_to_extend_annotation(backward) {
            var pos;
            pos = (backward) ? previous_col_location() : next_col_location();
            if (pos === -1) {
                return false;
            }
            scroll_to_pos(pos);
            return true;
        };
        if (!scroll_to_extend_annotation.__argnames__) Object.defineProperties(scroll_to_extend_annotation, {
            __argnames__ : {value: ["backward"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function handle_shortcut(sc_name, evt) {
            if (sc_name === "up") {
                _interpolate_kwargs.call(this, scroll_by_page, [_desugar_kwargs({backward: true, by_screen: true, flip_if_rtl_page_progression: false})]);
                return true;
            }
            if (sc_name === "down") {
                _interpolate_kwargs.call(this, scroll_by_page, [_desugar_kwargs({backward: false, by_screen: true, flip_if_rtl_page_progression: false})]);
                return true;
            }
            if (sc_name === "start_of_file") {
                get_boss().report_human_scroll();
                scroll_to_offset(0);
                return true;
            }
            if (sc_name === "end_of_file") {
                get_boss().report_human_scroll();
                scroll_to_offset(scroll_viewport.document_inline_size());
                return true;
            }
            if (sc_name === "left") {
                _interpolate_kwargs.call(this, scroll_by_page, [_desugar_kwargs({backward: true, by_screen: false, flip_if_rtl_page_progression: true})]);
                return true;
            }
            if (sc_name === "right") {
                _interpolate_kwargs.call(this, scroll_by_page, [_desugar_kwargs({backward: false, by_screen: false, flip_if_rtl_page_progression: true})]);
                return true;
            }
            if (sc_name === "start_of_book") {
                get_boss().report_human_scroll();
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["goto_doc_boundary"].concat([_desugar_kwargs({start: true})])));
                return true;
            }
            if (sc_name === "end_of_book") {
                get_boss().report_human_scroll();
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["goto_doc_boundary"].concat([_desugar_kwargs({start: false})])));
                return true;
            }
            if (sc_name === "pageup") {
                _interpolate_kwargs.call(this, scroll_by_page, [_desugar_kwargs({backward: true, by_screen: true, flip_if_rtl_page_progression: false})]);
                return true;
            }
            if (sc_name === "pagedown") {
                _interpolate_kwargs.call(this, scroll_by_page, [_desugar_kwargs({backward: false, by_screen: true, flip_if_rtl_page_progression: false})]);
                return true;
            }
            if (sc_name === "toggle_autoscroll") {
                auto_scroll_action("toggle");
                return true;
            }
            return false;
        };
        if (!handle_shortcut.__argnames__) Object.defineProperties(handle_shortcut, {
            __argnames__ : {value: ["sc_name", "evt"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function handle_gesture(gesture) {
            if (gesture.resolved_action === "next_section") {
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_section"].concat([_desugar_kwargs({forward: true})])));
            } else if (gesture.resolved_action === "prev_section") {
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["next_section"].concat([_desugar_kwargs({forward: false})])));
            } else if (gesture.resolved_action === "next_screen") {
                scroll_by_page(false, true);
            } else if (gesture.resolved_action === "prev_screen") {
                scroll_by_page(true, true);
            } else if (gesture.resolved_action === "prev_page") {
                scroll_by_page(true, false);
            } else if (gesture.resolved_action === "next_page") {
                scroll_by_page(false, false);
            }
        };
        if (!handle_gesture.__argnames__) Object.defineProperties(handle_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function get_bounding_client_rect(elem) {
            var br, r;
            br = elem.getBoundingClientRect();
            if (br.width === 0 && br.height === 0) {
                r = document.createRange();
                r.selectNodeContents(elem);
                br = r.getBoundingClientRect();
            }
            return br;
        };
        if (!get_bounding_client_rect.__argnames__) Object.defineProperties(get_bounding_client_rect, {
            __argnames__ : {value: ["elem"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        anchor_funcs = (function(){
            var _d = Object.create(null);
            _d["pos_for_elem"] = (function() {
                var _anonfunc = function pos_for_elem(elem) {
                    var br, pos;
                    if (!elem) {
                        return 0;
                    }
                    elem = scrollable_element(elem);
                    br = get_bounding_client_rect(elem);
                    pos = scroll_viewport.viewport_to_document_inline(scroll_viewport.rect_inline_start(br));
                    return column_at(pos);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["elem"]},
                    __module__ : {value: "read_book.paged_mode"}
                });
                return _anonfunc;
            })();
            _d["visibility"] = (function() {
                var _anonfunc = function visibility(pos) {
                    var first;
                    first = column_at(current_scroll_offset() + 10);
                    if (pos < first) {
                        return -1;
                    }
                    if (pos < first + cols_per_screen) {
                        return 0;
                    }
                    return 1;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["pos"]},
                    __module__ : {value: "read_book.paged_mode"}
                });
                return _anonfunc;
            })();
            _d["cmp"] = (function() {
                var _anonfunc = function cmp(a, b) {
                    return a - b;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "read_book.paged_mode"}
                });
                return _anonfunc;
            })();
            _d["get_bounding_client_rect"] = get_bounding_client_rect;
            return _d;
        }).call(this);
        function ResizeManager() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ResizeManager.prototype.__bind_methods__.call(this);
            ResizeManager.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ResizeManager.prototype, "__bind_methods__", {value: function () {
            this.reset = ResizeManager.prototype.reset.bind(this);
            this.start_resize = ResizeManager.prototype.start_resize.bind(this);
            this.end_resize = ResizeManager.prototype.end_resize.bind(this);
            this.is_inverse_transition = ResizeManager.prototype.is_inverse_transition.bind(this);
        }});
        ResizeManager.prototype.__init__ = function __init__() {
            var self = this;
            self.reset();
        };
        if (!ResizeManager.prototype.__init__.__module__) Object.defineProperties(ResizeManager.prototype.__init__, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ResizeManager.__argnames__ = ResizeManager.prototype.__init__.__argnames__;
        ResizeManager.__handles_kwarg_interpolation__ = ResizeManager.prototype.__init__.__handles_kwarg_interpolation__;
        ResizeManager.prototype.reset = function reset() {
            var self = this;
            self.resize_in_progress = null;
            self.last_transition = null;
        };
        if (!ResizeManager.prototype.reset.__module__) Object.defineProperties(ResizeManager.prototype.reset, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ResizeManager.prototype.start_resize = function start_resize(width, height) {
            var self = this;
            self.resize_in_progress = (function(){
                var _d = Object.create(null);
                _d["width"] = width;
                _d["height"] = height;
                _d["column"] = last_scrolled_to_column;
                return _d;
            }).call(this);
        };
        if (!ResizeManager.prototype.start_resize.__argnames__) Object.defineProperties(ResizeManager.prototype.start_resize, {
            __argnames__ : {value: ["width", "height"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        ResizeManager.prototype.end_resize = function end_resize() {
            var self = this;
            var _unpack, rp, transition;
            if (!self.resize_in_progress) {
                return;
            }
            _unpack = [self.resize_in_progress, null];
            rp = _unpack[0];
            self.resize_in_progress = _unpack[1];
            transition = (function(){
                var _d = Object.create(null);
                _d["before"] = rp;
                _d["after"] = (function(){
                    var _d = Object.create(null);
                    _d["width"] = scroll_viewport.width();
                    _d["height"] = scroll_viewport.height();
                    _d["column"] = last_scrolled_to_column;
                    return _d;
                }).call(this);
                return _d;
            }).call(this);
            if (self.is_inverse_transition(transition)) {
                if (transition.after.column !== self.last_transition.before.column) {
                    scroll_to_column(transition.after.column);
                    transition.after.column = last_scrolled_to_column;
                }
            }
            self.last_transition = transition;
        };
        if (!ResizeManager.prototype.end_resize.__module__) Object.defineProperties(ResizeManager.prototype.end_resize, {
            __module__ : {value: "read_book.paged_mode"}
        });
        ResizeManager.prototype.is_inverse_transition = function is_inverse_transition(transition) {
            var self = this;
            var p, n;
            p = self.last_transition;
            if (!p) {
                return false;
            }
            p = p.after;
            n = transition.before;
            return p.column === n.column && p.width === n.width && p.height === n.height;
        };
        if (!ResizeManager.prototype.is_inverse_transition.__argnames__) Object.defineProperties(ResizeManager.prototype.is_inverse_transition, {
            __argnames__ : {value: ["transition"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        ResizeManager.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ResizeManager.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ResizeManager.prototype, "__bases__", {value: []});

        resize_manager = new ResizeManager;
        function prepare_for_resize(width, height) {
            resize_manager.start_resize(width, height);
        };
        if (!prepare_for_resize.__argnames__) Object.defineProperties(prepare_for_resize, {
            __argnames__ : {value: ["width", "height"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function resize_done() {
            resize_manager.end_resize();
        };
        if (!resize_done.__module__) Object.defineProperties(resize_done, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function auto_scroll_action(action) {
            if (action === "toggle") {
                (_expr_temp = get_boss(), _interpolate_kwargs.call(_expr_temp, _expr_temp.send_message, ["error"].concat([_desugar_kwargs({errkey: "no-auto-scroll-in-paged-mode", is_non_critical: true})])));
            }
            return false;
        };
        if (!auto_scroll_action.__argnames__) Object.defineProperties(auto_scroll_action, {
            __argnames__ : {value: ["action"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        function DragScroller() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            DragScroller.prototype.__bind_methods__.call(this);
            DragScroller.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(DragScroller.prototype, "__bind_methods__", {value: function () {
            this.is_running = DragScroller.prototype.is_running.bind(this);
            this.start = DragScroller.prototype.start.bind(this);
            this.do_one_page_turn = DragScroller.prototype.do_one_page_turn.bind(this);
            this.stop = DragScroller.prototype.stop.bind(this);
        }});
        DragScroller.prototype.__init__ = function __init__() {
            var self = this;
            self.backward = false;
            self.timer_id = null;
        };
        if (!DragScroller.prototype.__init__.__module__) Object.defineProperties(DragScroller.prototype.__init__, {
            __module__ : {value: "read_book.paged_mode"}
        });
        DragScroller.__argnames__ = DragScroller.prototype.__init__.__argnames__;
        DragScroller.__handles_kwarg_interpolation__ = DragScroller.prototype.__init__.__handles_kwarg_interpolation__;
        DragScroller.prototype.is_running = function is_running() {
            var self = this;
            return self.timer_id !== null;
        };
        if (!DragScroller.prototype.is_running.__module__) Object.defineProperties(DragScroller.prototype.is_running, {
            __module__ : {value: "read_book.paged_mode"}
        });
        DragScroller.prototype.start = function start(backward) {
            var self = this;
            if (!self.is_running() || backward !== self.backward) {
                self.stop();
                self.backward = backward;
                self.timer_id = window.setTimeout(self.do_one_page_turn, self.INTERVAL);
            }
        };
        if (!DragScroller.prototype.start.__argnames__) Object.defineProperties(DragScroller.prototype.start, {
            __argnames__ : {value: ["backward"]},
            __module__ : {value: "read_book.paged_mode"}
        });
        DragScroller.prototype.do_one_page_turn = function do_one_page_turn() {
            var self = this;
            var pos;
            pos = (self.backward) ? previous_col_location() : next_col_location();
            if (pos >= 0) {
                scroll_to_pos(pos);
                self.timer_id = window.setTimeout(self.do_one_page_turn, self.INTERVAL * 2);
            } else {
                self.stop();
            }
        };
        if (!DragScroller.prototype.do_one_page_turn.__module__) Object.defineProperties(DragScroller.prototype.do_one_page_turn, {
            __module__ : {value: "read_book.paged_mode"}
        });
        DragScroller.prototype.stop = function stop() {
            var self = this;
            if (self.timer_id !== null) {
                window.clearTimeout(self.timer_id);
                self.timer_id = null;
            }
        };
        if (!DragScroller.prototype.stop.__module__) Object.defineProperties(DragScroller.prototype.stop, {
            __module__ : {value: "read_book.paged_mode"}
        });
        DragScroller.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        DragScroller.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(DragScroller.prototype, "__bases__", {value: []});
        DragScroller.prototype.INTERVAL = 500;

        drag_scroller = new DragScroller;
        function cancel_drag_scroll() {
            drag_scroller.stop();
        };
        if (!cancel_drag_scroll.__module__) Object.defineProperties(cancel_drag_scroll, {
            __module__ : {value: "read_book.paged_mode"}
        });

        function start_drag_scroll(delta) {
            drag_scroller.start(delta < 0);
        };
        if (!start_drag_scroll.__argnames__) Object.defineProperties(start_drag_scroll, {
            __argnames__ : {value: ["delta"]},
            __module__ : {value: "read_book.paged_mode"}
        });

        _modules["read_book.paged_mode"]._in_paged_mode = _in_paged_mode;
        _modules["read_book.paged_mode"].col_size = col_size;
        _modules["read_book.paged_mode"].screen_inline = screen_inline;
        _modules["read_book.paged_mode"].screen_block = screen_block;
        _modules["read_book.paged_mode"].cols_per_screen = cols_per_screen;
        _modules["read_book.paged_mode"].gap = gap;
        _modules["read_book.paged_mode"].col_and_gap = col_and_gap;
        _modules["read_book.paged_mode"].last_scrolled_to_column = last_scrolled_to_column;
        _modules["read_book.paged_mode"].is_full_screen_layout = is_full_screen_layout;
        _modules["read_book.paged_mode"].scroll_resize_bug_watcher = scroll_resize_bug_watcher;
        _modules["read_book.paged_mode"].wheel_handler = wheel_handler;
        _modules["read_book.paged_mode"].onwheel = onwheel;
        _modules["read_book.paged_mode"].anchor_funcs = anchor_funcs;
        _modules["read_book.paged_mode"].resize_manager = resize_manager;
        _modules["read_book.paged_mode"].drag_scroller = drag_scroller;
        _modules["read_book.paged_mode"].first_child = first_child;
        _modules["read_book.paged_mode"].has_start_text = has_start_text;
        _modules["read_book.paged_mode"].handle_rtl_body = handle_rtl_body;
        _modules["read_book.paged_mode"].create_page_div = create_page_div;
        _modules["read_book.paged_mode"].in_paged_mode = in_paged_mode;
        _modules["read_book.paged_mode"].get_number_of_cols = get_number_of_cols;
        _modules["read_book.paged_mode"].reset_paged_mode_globals = reset_paged_mode_globals;
        _modules["read_book.paged_mode"].column_at = column_at;
        _modules["read_book.paged_mode"].fit_images = fit_images;
        _modules["read_book.paged_mode"].cps_by_em_size = cps_by_em_size;
        _modules["read_book.paged_mode"].calc_columns_per_screen = calc_columns_per_screen;
        _modules["read_book.paged_mode"].get_columns_per_screen_data = get_columns_per_screen_data;
        _modules["read_book.paged_mode"].will_columns_per_screen_change = will_columns_per_screen_change;
        _modules["read_book.paged_mode"].ScrollResizeBugWatcher = ScrollResizeBugWatcher;
        _modules["read_book.paged_mode"].layout = layout;
        _modules["read_book.paged_mode"].current_scroll_offset = current_scroll_offset;
        _modules["read_book.paged_mode"].scroll_to_offset = scroll_to_offset;
        _modules["read_book.paged_mode"].scroll_to_column = scroll_to_column;
        _modules["read_book.paged_mode"].scroll_to_pos = scroll_to_pos;
        _modules["read_book.paged_mode"].scroll_to_previous_position = scroll_to_previous_position;
        _modules["read_book.paged_mode"].scroll_to_fraction = scroll_to_fraction;
        _modules["read_book.paged_mode"].column_boundaries = column_boundaries;
        _modules["read_book.paged_mode"].column_at_current_scroll_offset = column_at_current_scroll_offset;
        _modules["read_book.paged_mode"].current_column_location = current_column_location;
        _modules["read_book.paged_mode"].number_of_cols_left = number_of_cols_left;
        _modules["read_book.paged_mode"].next_screen_location = next_screen_location;
        _modules["read_book.paged_mode"].previous_screen_location = previous_screen_location;
        _modules["read_book.paged_mode"].next_col_location = next_col_location;
        _modules["read_book.paged_mode"].previous_col_location = previous_col_location;
        _modules["read_book.paged_mode"].jump_to_anchor = jump_to_anchor;
        _modules["read_book.paged_mode"].scrollable_element = scrollable_element;
        _modules["read_book.paged_mode"].scroll_to_elem = scroll_to_elem;
        _modules["read_book.paged_mode"].snap_to_selection = snap_to_selection;
        _modules["read_book.paged_mode"].ensure_selection_boundary_visible = ensure_selection_boundary_visible;
        _modules["read_book.paged_mode"].jump_to_cfi = jump_to_cfi;
        _modules["read_book.paged_mode"].current_cfi = current_cfi;
        _modules["read_book.paged_mode"].progress_frac = progress_frac;
        _modules["read_book.paged_mode"].page_counts = page_counts;
        _modules["read_book.paged_mode"].next_spine_item = next_spine_item;
        _modules["read_book.paged_mode"].is_return = is_return;
        _modules["read_book.paged_mode"].WheelState = WheelState;
        _modules["read_book.paged_mode"].HandleWheel = HandleWheel;
        _modules["read_book.paged_mode"].scroll_by_page = scroll_by_page;
        _modules["read_book.paged_mode"].scroll_to_extend_annotation = scroll_to_extend_annotation;
        _modules["read_book.paged_mode"].handle_shortcut = handle_shortcut;
        _modules["read_book.paged_mode"].handle_gesture = handle_gesture;
        _modules["read_book.paged_mode"].get_bounding_client_rect = get_bounding_client_rect;
        _modules["read_book.paged_mode"].ResizeManager = ResizeManager;
        _modules["read_book.paged_mode"].prepare_for_resize = prepare_for_resize;
        _modules["read_book.paged_mode"].resize_done = resize_done;
        _modules["read_book.paged_mode"].auto_scroll_action = auto_scroll_action;
        _modules["read_book.paged_mode"].DragScroller = DragScroller;
        _modules["read_book.paged_mode"].cancel_drag_scroll = cancel_drag_scroll;
        _modules["read_book.paged_mode"].start_drag_scroll = start_drag_scroll;
    })();

    (function(){
        var __name__ = "read_book.referencing";
        var current_spine_item = _modules["read_book.globals"].current_spine_item;

        function elem_for_ref(refnum) {
            refnum = int(refnum);
            return (_expr_temp = document.getElementsByTagName("p"))[_bound_index(refnum - 1, _expr_temp)];
        };
        if (!elem_for_ref.__argnames__) Object.defineProperties(elem_for_ref, {
            __argnames__ : {value: ["refnum"]},
            __module__ : {value: "read_book.referencing"}
        });

        function start_reference_mode() {
            var si, _unpack, i, p;
            si = current_spine_item().index;
            var _Iter0 = _Iterable(enumerate(document.getElementsByTagName("p")));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                _unpack = _Iter0[_Index0];
                i = _unpack[0];
                p = _unpack[1];
                p.dataset.calibreRefNum = "" + _str.format("{}", si) + "." + _str.format("{}", i + 1) + "";
            }
            document.body.classList.add("calibre-reference-mode");
        };
        if (!start_reference_mode.__module__) Object.defineProperties(start_reference_mode, {
            __module__ : {value: "read_book.referencing"}
        });

        function end_reference_mode() {
            document.body.classList.remove("calibre-reference-mode");
        };
        if (!end_reference_mode.__module__) Object.defineProperties(end_reference_mode, {
            __module__ : {value: "read_book.referencing"}
        });

        _modules["read_book.referencing"].elem_for_ref = elem_for_ref;
        _modules["read_book.referencing"].start_reference_mode = start_reference_mode;
        _modules["read_book.referencing"].end_reference_mode = end_reference_mode;
    })();

    (function(){
        var __name__ = "read_book.smil";
        var is_anchor_on_screen = _modules["read_book.anchor_visibility"].is_anchor_on_screen;

        var get_boss = _modules["read_book.globals"].get_boss;

        function flatten_seq(seq, par_list) {
            var par, child;
            if (seq.par) {
                var _Iter0 = _Iterable(seq.par);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    par = _Iter0[_Index0];
                    if (par.anchor) {
                        par_list.push(par);
                    }
                }
            }
            if (seq.seq) {
                var _Iter1 = _Iterable(seq.seq);
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    child = _Iter1[_Index1];
                    flatten_seq(child, par_list);
                }
            }
        };
        if (!flatten_seq.__argnames__) Object.defineProperties(flatten_seq, {
            __argnames__ : {value: ["seq", "par_list"]},
            __module__ : {value: "read_book.smil"}
        });

        function flatten_smil_map(smil_map) {
            var anchor_map, par_list, i;
            anchor_map = Object.create(null);
            par_list = [];
            if (smil_map) {
                flatten_seq(smil_map, par_list);
            }
            par_list.sort((function() {
                var _anonfunc = function (a, b) {
                    return a.num - b.num;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "read_book.smil"}
                });
                return _anonfunc;
            })());
            for (var _Index2 = 0; _Index2 < par_list.length; _Index2++) {
                i = _Index2;
                anchor_map[_bound_index(par_list[(typeof i === "number" && i < 0) ? par_list.length + i : i].anchor, anchor_map)] = i;
            }
            return [anchor_map, par_list];
        };
        if (!flatten_smil_map.__argnames__) Object.defineProperties(flatten_smil_map, {
            __argnames__ : {value: ["smil_map"]},
            __module__ : {value: "read_book.smil"}
        });

        function get_smil_audio_map(smil_map) {
            var audio_map, v;
            audio_map = Object.create(null);
            function flatten(seq) {
                var a, par, child;
                if (seq.par) {
                    var _Iter3 = _Iterable(seq.par);
                    for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                        par = _Iter3[_Index3];
                        if (par.audio) {
                            a = audio_map[_bound_index(par.audio, audio_map)];
                            if (!a) {
                                a = audio_map[_bound_index(par.audio, audio_map)] = [];
                            }
                            a.push(par);
                        }
                    }
                }
                if (seq.seq) {
                    var _Iter4 = _Iterable(seq.seq);
                    for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                        child = _Iter4[_Index4];
                        flatten(child);
                    }
                }
            };
            if (!flatten.__argnames__) Object.defineProperties(flatten, {
                __argnames__ : {value: ["seq"]},
                __module__ : {value: "read_book.smil"}
            });

            if (smil_map) {
                flatten(smil_map);
                var _Iter5 = _Iterable(Object.values(audio_map));
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    v = _Iter5[_Index5];
                    v.sort((function() {
                        var _anonfunc = function (a, b) {
                            return a.start - b.start;
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["a", "b"]},
                            __module__ : {value: "read_book.smil"}
                        });
                        return _anonfunc;
                    })());
                }
            }
            return (function(){
                var _d = Object.create(null);
                _d["audio_files"] = audio_map;
                return _d;
            }).call(this);
        };
        if (!get_smil_audio_map.__argnames__) Object.defineProperties(get_smil_audio_map, {
            __argnames__ : {value: ["smil_map"]},
            __module__ : {value: "read_book.smil"}
        });

        function get_smil_id_for_timestamp(audio_file_name, timestamp, smil_audio_map, prev_idx) {
            var pars, i;
            pars = (_expr_temp = smil_audio_map.audio_files)[(typeof audio_file_name === "number" && audio_file_name < 0) ? _expr_temp.length + audio_file_name : audio_file_name];
            if (!pars) {
                return [null, null];
            }
            prev_idx = prev_idx || 0;
            if (prev_idx >= pars.length || prev_idx < 0) {
                prev_idx = 0;
            }
            for (var _Index6 = prev_idx; _Index6 < pars.length; _Index6++) {
                i = _Index6;
                if (pars[(typeof i === "number" && i < 0) ? pars.length + i : i].start <= timestamp && timestamp <= pars[(typeof i === "number" && i < 0) ? pars.length + i : i].end) {
                    return [pars[(typeof i === "number" && i < 0) ? pars.length + i : i].anchor, i];
                }
            }
            for (var _Index7 = 0; _Index7 < prev_idx; _Index7++) {
                i = _Index7;
                if (pars[(typeof i === "number" && i < 0) ? pars.length + i : i].start <= timestamp && timestamp <= pars[(typeof i === "number" && i < 0) ? pars.length + i : i].end) {
                    return [pars[(typeof i === "number" && i < 0) ? pars.length + i : i].anchor, i];
                }
            }
            return [null, null];
        };
        if (!get_smil_id_for_timestamp.__argnames__) Object.defineProperties(get_smil_id_for_timestamp, {
            __argnames__ : {value: ["audio_file_name", "timestamp", "smil_audio_map", "prev_idx"]},
            __module__ : {value: "read_book.smil"}
        });

        function next_audio_file_for_spine_item(audio_file_name, smil_audio_map) {
            var keys, idx;
            if (audio_file_name) {
                keys = Object.keys(smil_audio_map);
                idx = keys.indexOf(audio_file_name);
                if (0 <= idx && idx < keys.length - 1) {
                    return [keys[_bound_index(idx + 1, keys)], smil_audio_map[_bound_index(keys[_bound_index(idx + 1, keys)], smil_audio_map)]];
                }
            }
            return [null, null];
        };
        if (!next_audio_file_for_spine_item.__argnames__) Object.defineProperties(next_audio_file_for_spine_item, {
            __argnames__ : {value: ["audio_file_name", "smil_audio_map"]},
            __module__ : {value: "read_book.smil"}
        });

        function first_par(smil_map) {
            var par_list, par;
            par_list = flatten_smil_map(smil_map)[1];
            var _Iter8 = _Iterable(par_list);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                par = _Iter8[_Index8];
                if (par.anchor) {
                    return par;
                }
            }
            return null;
        };
        if (!first_par.__argnames__) Object.defineProperties(first_par, {
            __argnames__ : {value: ["smil_map"]},
            __module__ : {value: "read_book.smil"}
        });

        function find_next_audio_in_spine(spine_idx, book_manifest) {
            var spine, file_map, q, f, par, i;
            spine = book_manifest.spine;
            file_map = book_manifest.files;
            for (var _Index9 = spine_idx + 1; _Index9 < spine.length; _Index9++) {
                i = _Index9;
                q = spine[(typeof i === "number" && i < 0) ? spine.length + i : i];
                f = file_map[(typeof q === "number" && q < 0) ? file_map.length + q : q];
                if (f && f.smil_map) {
                    par = first_par(f.smil_map);
                    if (par) {
                        return [q, par];
                    }
                }
            }
            return [null, null];
        };
        if (!find_next_audio_in_spine.__argnames__) Object.defineProperties(find_next_audio_in_spine, {
            __argnames__ : {value: ["spine_idx", "book_manifest"]},
            __module__ : {value: "read_book.smil"}
        });

        function smil_element_at(pos, anchor_map, par_list) {
            var elem, af, br, par;
            if (pos) {
                elem = document.elementFromPoint(pos.x, pos.y);
                if (elem && elem.id && _exists.n(anchor_map[_bound_index(elem.id, anchor_map)])) {
                    return par_list[_bound_index(anchor_map[_bound_index(elem.id, anchor_map)], par_list)];
                }
                af = get_boss().anchor_funcs;
                var _Iter10 = _Iterable(par_list);
                for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                    par = _Iter10[_Index10];
                    if (par.anchor && par.audio) {
                        elem = document.getElementById(par.anchor);
                        if (elem) {
                            br = af.get_bounding_client_rect(elem);
                            if (br.x <= (_cond_temp = pos.x) && _cond_temp <= br.x + br.width && br.y <= (_cond_temp = pos.y) && _cond_temp <= br.y + br.height) {
                                return par;
                            }
                        }
                    }
                }
                return null;
            } else {
                var _Iter11 = _Iterable(par_list);
                for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                    par = _Iter11[_Index11];
                    if (par.anchor && par.audio && is_anchor_on_screen(par.anchor)) {
                        return par;
                    }
                }
                var _Iter12 = _Iterable(par_list);
                for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                    par = _Iter12[_Index12];
                    if (par.audio) {
                        return par;
                    }
                }
                return null;
            }
        };
        if (!smil_element_at.__argnames__) Object.defineProperties(smil_element_at, {
            __argnames__ : {value: ["pos", "anchor_map", "par_list"]},
            __module__ : {value: "read_book.smil"}
        });

        function mark_smil_element(anchor) {
            var elem, sel;
            elem = document.getElementById(anchor);
            if (elem) {
                sel = window.getSelection();
                sel.selectAllChildren(elem);
                return bool(sel.rangeCount && sel.toString());
            }
            return false;
        };
        if (!mark_smil_element.__argnames__) Object.defineProperties(mark_smil_element, {
            __argnames__ : {value: ["anchor"]},
            __module__ : {value: "read_book.smil"}
        });

        _modules["read_book.smil"].flatten_seq = flatten_seq;
        _modules["read_book.smil"].flatten_smil_map = flatten_smil_map;
        _modules["read_book.smil"].get_smil_audio_map = get_smil_audio_map;
        _modules["read_book.smil"].get_smil_id_for_timestamp = get_smil_id_for_timestamp;
        _modules["read_book.smil"].next_audio_file_for_spine_item = next_audio_file_for_spine_item;
        _modules["read_book.smil"].first_par = first_par;
        _modules["read_book.smil"].find_next_audio_in_spine = find_next_audio_in_spine;
        _modules["read_book.smil"].smil_element_at = smil_element_at;
        _modules["read_book.smil"].mark_smil_element = mark_smil_element;
    })();

    (function(){
        var __name__ = "read_book.toc";
        var E = _modules.elementmaker.E;

        var create_search_bar = _modules.complete.create_search_bar;

        var ensure_id = _modules.dom.ensure_id;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;

        var _ = _modules.gettext.gettext;

        var error_dialog = _modules.modals.error_dialog;

        var position_for_anchor = _modules["read_book.anchor_visibility"].position_for_anchor;

        var current_book = _modules["read_book.globals"].current_book;
        var current_layout_mode = _modules["read_book.globals"].current_layout_mode;
        var current_spine_item = _modules["read_book.globals"].current_spine_item;
        var get_boss = _modules["read_book.globals"].get_boss;
        var set_toc_anchor_map = _modules["read_book.globals"].set_toc_anchor_map;
        var toc_anchor_map = _modules["read_book.globals"].toc_anchor_map;

        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;

        var create_tree = _modules.widgets.create_tree;
        var find_text_in_tree = _modules.widgets.find_text_in_tree;
        var scroll_tree_item_into_view = _modules.widgets.scroll_tree_item_into_view;

        function update_visible_toc_nodes(visible_anchors) {
            update_visible_toc_nodes.data = visible_anchors;
        };
        if (!update_visible_toc_nodes.__argnames__) Object.defineProperties(update_visible_toc_nodes, {
            __argnames__ : {value: ["visible_anchors"]},
            __module__ : {value: "read_book.toc"}
        });

        update_visible_toc_nodes.data = Object.create(null);
        function iter_toc_descendants(node, callback) {
            var child;
            var _Iter0 = _Iterable(node.children);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                child = _Iter0[_Index0];
                if (callback(child)) {
                    return;
                }
                iter_toc_descendants(child, callback);
            }
        };
        if (!iter_toc_descendants.__argnames__) Object.defineProperties(iter_toc_descendants, {
            __argnames__ : {value: ["node", "callback"]},
            __module__ : {value: "read_book.toc"}
        });

        function get_toc_nodes_bordering_spine_item(toc, csi) {
            var spine, _unpack, spine_before, spine_after, which, before, after, prev, name;
            toc = toc || current_book().manifest.toc;
            csi = csi || current_spine_item();
            spine = current_book().manifest.spine;
            _unpack = [Object.create(null), Object.create(null)];
            spine_before = _unpack[0];
            spine_after = _unpack[1];
            which = spine_before;
            before = after = prev = null;
            var _Iter1 = _Iterable(spine);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                name = _Iter1[_Index1];
                if (name === csi) {
                    which = spine_after;
                } else {
                    which[(typeof name === "number" && name < 0) ? which.length + name : name] = true;
                }
            }
            iter_toc_descendants(toc, (function() {
                var _anonfunc = function (node) {
                    if (node.dest) {
                        if (spine_before[_bound_index(node.dest, spine_before)]) {
                            prev = node;
                        } else if (spine_after[_bound_index(node.dest, spine_after)]) {
                            if (!before) {
                                before = prev;
                            }
                            if (!after) {
                                after = node;
                            }
                            return true;
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["node"]},
                    __module__ : {value: "read_book.toc"}
                });
                return _anonfunc;
            })());
            if (!before && prev !== null) {
                before = prev;
            }
            return [before, after];
        };
        if (!get_toc_nodes_bordering_spine_item.__argnames__) Object.defineProperties(get_toc_nodes_bordering_spine_item, {
            __argnames__ : {value: ["toc", "csi"]},
            __module__ : {value: "read_book.toc"}
        });

        function get_border_nodes(toc, id_map) {
            var data, _unpack, before, after, sb, sa;
            data = update_visible_toc_nodes.data;
            _unpack = [data.before, data.after];
            before = _unpack[0];
            after = _unpack[1];
            if (before) {
                before = id_map[(typeof before === "number" && before < 0) ? id_map.length + before : before];
            }
            if (after) {
                after = id_map[(typeof after === "number" && after < 0) ? id_map.length + after : after];
            }
            if (before && after) {
                return [before, after];
            }
            _unpack = get_toc_nodes_bordering_spine_item(toc);
_unpack = _unpack_asarray(2, _unpack);
            sb = _unpack[0];
            sa = _unpack[1];
            before = before || sb;
            after = after || sa;
            return [before, after];
        };
        if (!get_border_nodes.__argnames__) Object.defineProperties(get_border_nodes, {
            __argnames__ : {value: ["toc", "id_map"]},
            __module__ : {value: "read_book.toc"}
        });

        function family_for_toc_node(toc_node_id, parent_map, id_map) {
            var toc, _unpack, family, node, parent;
            if (!id_map || !parent_map) {
                toc = current_book().manifest.toc;
                _unpack = get_toc_maps(toc);
_unpack = _unpack_asarray(2, _unpack);
                parent_map = _unpack[0];
                id_map = _unpack[1];
            }
            family = [];
            node = id_map[(typeof toc_node_id === "number" && toc_node_id < 0) ? id_map.length + toc_node_id : toc_node_id];
            while (node && node.title) {
                family.unshift(node);
                parent = parent_map[_bound_index(node.id, parent_map)];
                node = null;
                if (parent) {
                    node = id_map[_bound_index(parent.id, id_map)];
                }
            }
            return family;
        };
        if (!family_for_toc_node.__argnames__) Object.defineProperties(family_for_toc_node, {
            __argnames__ : {value: ["toc_node_id", "parent_map", "id_map"]},
            __module__ : {value: "read_book.toc"}
        });

        function get_current_toc_nodes() {
            var toc, _unpack, parent_map, id_map, data, ans, before, r, fam, x;
            toc = current_book().manifest.toc;
            _unpack = get_toc_maps(toc);
_unpack = _unpack_asarray(2, _unpack);
            parent_map = _unpack[0];
            id_map = _unpack[1];
            data = update_visible_toc_nodes.data;
            ans = Object.create(null);
            if (data.has_visible) {
                ans = data.visible_anchors;
            } else {
                if (data.before) {
                    ans[_bound_index(data.before, ans)] = true;
                } else {
                    before = get_border_nodes(toc, id_map)[0];
                    if (before) {
                        ans[_bound_index(before.id, ans)] = true;
                    }
                }
            }
            r = [];
            var _Iter2 = _Iterable(Object.keys(ans));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                x = _Iter2[_Index2];
                fam = family_for_toc_node(x, parent_map, id_map);
                if ((typeof fam !== "undefined" && fam !== null ? fam : Object.create(null)).length) {
                    r.push(fam);
                }
            }
            return r;
        };
        if (!get_current_toc_nodes.__module__) Object.defineProperties(get_current_toc_nodes, {
            __module__ : {value: "read_book.toc"}
        });

        function get_highlighted_toc_nodes(toc, parent_map, id_map, skip_parents) {
            var data, ans, before, p, node_id;
            data = update_visible_toc_nodes.data;
            ans = Object.create(null);
            if (data.has_visible) {
                ans = data.visible_anchors;
            } else {
                if (data.before) {
                    ans[_bound_index(data.before, ans)] = true;
                } else {
                    before = get_border_nodes(toc, id_map)[0];
                    if (before) {
                        ans[_bound_index(before.id, ans)] = true;
                    }
                }
            }
            if (!skip_parents) {
                var _Iter3 = _Iterable(Object.keys(ans));
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    node_id = _Iter3[_Index3];
                    p = parent_map[(typeof node_id === "number" && node_id < 0) ? parent_map.length + node_id : node_id];
                    while (p && p.title) {
                        ans[_bound_index(p.id, ans)] = true;
                        p = parent_map[_bound_index(p.id, parent_map)];
                    }
                }
            }
            return ans;
        };
        if (!get_highlighted_toc_nodes.__argnames__) Object.defineProperties(get_highlighted_toc_nodes, {
            __argnames__ : {value: ["toc", "parent_map", "id_map", "skip_parents"]},
            __module__ : {value: "read_book.toc"}
        });

        function get_toc_maps(toc) {
            var _unpack, parent_map, id_map;
            if (!toc) {
                toc = current_book().manifest.toc;
            }
            _unpack = [Object.create(null), Object.create(null)];
            parent_map = _unpack[0];
            id_map = _unpack[1];
            function process_node(node, parent) {
                var c;
                id_map[_bound_index(node.id, id_map)] = node;
                parent_map[_bound_index(node.id, parent_map)] = parent;
                var _Iter4 = _Iterable(node.children);
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    c = _Iter4[_Index4];
                    process_node(c, node);
                }
            };
            if (!process_node.__argnames__) Object.defineProperties(process_node, {
                __argnames__ : {value: ["node", "parent"]},
                __module__ : {value: "read_book.toc"}
            });

            process_node(toc);
            return [parent_map, id_map];
        };
        if (!get_toc_maps.__argnames__) Object.defineProperties(get_toc_maps, {
            __argnames__ : {value: ["toc"]},
            __module__ : {value: "read_book.toc"}
        });

        function get_book_mark_title() {
            var toc, _unpack, parent_map, id_map, highlighted_toc_nodes, node, node_id;
            toc = current_book().manifest.toc;
            _unpack = get_toc_maps(toc);
_unpack = _unpack_asarray(2, _unpack);
            parent_map = _unpack[0];
            id_map = _unpack[1];
            highlighted_toc_nodes = get_highlighted_toc_nodes(toc, parent_map, id_map, true);
            var _Iter5 = _Iterable(Object.keys(highlighted_toc_nodes));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                node_id = _Iter5[_Index5];
                node = id_map[(typeof node_id === "number" && node_id < 0) ? id_map.length + node_id : node_id];
                if (node.title) {
                    return node.title;
                }
            }
            return "";
        };
        if (!get_book_mark_title.__module__) Object.defineProperties(get_book_mark_title, {
            __module__ : {value: "read_book.toc"}
        });

        function create_toc_tree(toc, onclick) {
            var _unpack, parent_map, id_map, highlighted_toc_nodes;
            _unpack = get_toc_maps(toc);
_unpack = _unpack_asarray(2, _unpack);
            parent_map = _unpack[0];
            id_map = _unpack[1];
            highlighted_toc_nodes = get_highlighted_toc_nodes(toc, parent_map, id_map);
            function populate_data(node, li, a) {
                var title;
                li.dataset.tocDest = node.dest || "";
                li.dataset.tocFrag = node.frag || "";
                title = node.title || "";
                if (highlighted_toc_nodes[_bound_index(node.id, highlighted_toc_nodes)]) {
                    a.appendChild(E.b(E.i(title)));
                } else {
                    a.textContent = title;
                }
            };
            if (!populate_data.__argnames__) Object.defineProperties(populate_data, {
                __argnames__ : {value: ["node", "li", "a"]},
                __module__ : {value: "read_book.toc"}
            });

            return create_tree(toc, populate_data, onclick);
        };
        if (!create_toc_tree.__argnames__) Object.defineProperties(create_toc_tree, {
            __argnames__ : {value: ["toc", "onclick"]},
            __module__ : {value: "read_book.toc"}
        });

        function do_search(text) {
            var container, a;
            container = document.getElementById(this);
            a = find_text_in_tree(container, text);
            if (!text) {
                return;
            }
            if (!a) {
                return error_dialog(_("No matches found"), _("The text \"{}\" was not found in the Table of Contents").format(text));
            }
            scroll_tree_item_into_view(a);
        };
        if (!do_search.__argnames__) Object.defineProperties(do_search, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "read_book.toc"}
        });

        function create_toc_panel(book, container, onclick) {
            var toc_panel, toc_panel_id, search_button, t, search_bar, child;
            function handle_click(event, li) {
                if (event.button === 0) {
                    onclick(li.dataset.tocDest, li.dataset.tocFrag);
                }
            };
            if (!handle_click.__argnames__) Object.defineProperties(handle_click, {
                __argnames__ : {value: ["event", "li"]},
                __module__ : {value: "read_book.toc"}
            });

            toc_panel = create_toc_tree(book.manifest.toc, handle_click);
            toc_panel_id = ensure_id(toc_panel);
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({display: "flex", flex_direction: "column", height: "100%", min_height: "100%", overflow: "hidden", max_height: "100vh", max_width: "100vw"})]));
            _interpolate_kwargs.call(this, set_css, [toc_panel].concat([_desugar_kwargs({flex_grow: "10"})]));
            container.appendChild(toc_panel);
            search_button = _interpolate_kwargs.call(E, E.div, [svgicon("search")].concat([_desugar_kwargs({class_: "simple-link"})]));
            t = _("Search Table of Contents");
            search_bar = _interpolate_kwargs.call(this, create_search_bar, [do_search.bind(toc_panel_id), "search-book-toc"].concat([_desugar_kwargs({button: search_button, placeholder: t})]));
            _interpolate_kwargs.call(this, set_css, [search_bar].concat([_desugar_kwargs({flex_grow: "10", margin_right: "1em"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [search_bar, search_button].concat([_desugar_kwargs({style: "margin: 1ex 1em; display: flex; align-items: center"})])));
            var _Iter6 = _Iterable(container.childNodes);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                child = _Iter6[_Index6];
                child.style.flexShrink = "0";
            }
            toc_panel.style.flexGrow = "100";
            toc_panel.style.flexShrink = "1";
            toc_panel.style.overflow = "auto";
        };
        if (!create_toc_panel.__argnames__) Object.defineProperties(create_toc_panel, {
            __argnames__ : {value: ["book", "container", "onclick"]},
            __module__ : {value: "read_book.toc"}
        });

        function recalculate_toc_anchor_positions(tam) {
            var name, am, anchors, pos_map, _unpack, i, anchor, anchor_funcs, current_map;
            name = current_spine_item().name;
            am = Object.create(null);
            anchors = [];
            pos_map = Object.create(null);
            var _Iter7 = _Iterable(enumerate(tam[(typeof name === "number" && name < 0) ? tam.length + name : name] || []));
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                _unpack = _Iter7[_Index7];
                i = _unpack[0];
                anchor = _unpack[1];
                am[_bound_index(anchor.id, am)] = position_for_anchor(anchor.frag);
                anchors.push(anchor.id);
                pos_map[_bound_index(anchor.id, pos_map)] = i;
            }
            anchor_funcs = get_boss().anchor_funcs;
            anchors.sort((function() {
                var _anonfunc = function (a, b) {
                    return anchor_funcs.cmp(am[(typeof a === "number" && a < 0) ? am.length + a : a], am[(typeof b === "number" && b < 0) ? am.length + b : b]) || pos_map[(typeof a === "number" && a < 0) ? pos_map.length + a : a] - pos_map[(typeof b === "number" && b < 0) ? pos_map.length + b : b];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "read_book.toc"}
                });
                return _anonfunc;
            })());
            current_map = (function(){
                var _d = Object.create(null);
                _d["layout_mode"] = current_layout_mode();
                _d["width"] = scroll_viewport.width();
                _d["height"] = scroll_viewport.height();
                _d["pos_map"] = am;
                _d["sorted_anchors"] = anchors;
                return _d;
            }).call(this);
            set_toc_anchor_map(current_map);
            return current_map;
        };
        if (!recalculate_toc_anchor_positions.__argnames__) Object.defineProperties(recalculate_toc_anchor_positions, {
            __argnames__ : {value: ["tam"]},
            __module__ : {value: "read_book.toc"}
        });

        function current_toc_anchor_map(tam) {
            var current_map;
            current_map = toc_anchor_map();
            if (!((current_map && current_map.layout_mode === current_layout_mode() && current_map.width === scroll_viewport.width() && current_map.height === scroll_viewport.height()))) {
                current_map = recalculate_toc_anchor_positions(tam);
            }
            return current_map;
        };
        if (!current_toc_anchor_map.__argnames__) Object.defineProperties(current_toc_anchor_map, {
            __argnames__ : {value: ["tam"]},
            __module__ : {value: "read_book.toc"}
        });

        function update_visible_toc_anchors(toc_anchor_map, recalculate) {
            var tam, before, after, visible_anchors, has_visible, anchor_funcs, pos, visibility, anchor_id;
            if (recalculate) {
                recalculate_toc_anchor_positions(toc_anchor_map);
            }
            tam = current_toc_anchor_map(toc_anchor_map);
            before = after = null;
            visible_anchors = Object.create(null);
            has_visible = false;
            anchor_funcs = get_boss().anchor_funcs;
            var _Iter8 = _Iterable(tam.sorted_anchors);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                anchor_id = _Iter8[_Index8];
                pos = (_expr_temp = tam.pos_map)[(typeof anchor_id === "number" && anchor_id < 0) ? _expr_temp.length + anchor_id : anchor_id];
                visibility = anchor_funcs.visibility(pos);
                if (visibility < 0) {
                    before = anchor_id;
                } else if (visibility === 0) {
                    has_visible = true;
                    visible_anchors[(typeof anchor_id === "number" && anchor_id < 0) ? visible_anchors.length + anchor_id : anchor_id] = true;
                } else if (visibility > 0) {
                    after = anchor_id;
                    break;
                }
            }
            return (function(){
                var _d = Object.create(null);
                _d["visible_anchors"] = visible_anchors;
                _d["has_visible"] = has_visible;
                _d["before"] = before;
                _d["after"] = after;
                _d["sorted_anchors"] = tam.sorted_anchors;
                return _d;
            }).call(this);
        };
        if (!update_visible_toc_anchors.__argnames__) Object.defineProperties(update_visible_toc_anchors, {
            __argnames__ : {value: ["toc_anchor_map", "recalculate"]},
            __module__ : {value: "read_book.toc"}
        });

        function find_anchor_before_range(r, toc_anchor_map) {
            var name, prev_anchor, tam, anchors, amap, x, anchor, is_before, elem, q, anchor_id;
            name = current_spine_item().name;
            prev_anchor = null;
            tam = current_toc_anchor_map(toc_anchor_map);
            anchors = toc_anchor_map[(typeof name === "number" && name < 0) ? toc_anchor_map.length + name : name];
            if (anchors) {
                amap = (function() {
                    var _Iter = _Iterable(anchors), _Result = Object.create(null), x;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        x = _Iter[_Index];
                        _Result[x.id] = (x);
                    }
                    return _Result;
                })();
                var _Iter9 = _Iterable(tam.sorted_anchors);
                for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                    anchor_id = _Iter9[_Index9];
                    anchor = amap[(typeof anchor_id === "number" && anchor_id < 0) ? amap.length + anchor_id : anchor_id];
                    is_before = true;
                    if (anchor.frag) {
                        elem = document.getElementById(anchor.frag);
                        if (elem) {
                            q = document.createRange();
                            q.selectNode(elem);
                            if (q.compareBoundaryPoints(window.Range.START_TO_START, r) > 0) {
                                is_before = false;
                            }
                        }
                    }
                    if (is_before) {
                        prev_anchor = anchor;
                    } else {
                        break;
                    }
                }
            }
            return prev_anchor;
        };
        if (!find_anchor_before_range.__argnames__) Object.defineProperties(find_anchor_before_range, {
            __argnames__ : {value: ["r", "toc_anchor_map"]},
            __module__ : {value: "read_book.toc"}
        });

        _modules["read_book.toc"].update_visible_toc_nodes = update_visible_toc_nodes;
        _modules["read_book.toc"].iter_toc_descendants = iter_toc_descendants;
        _modules["read_book.toc"].get_toc_nodes_bordering_spine_item = get_toc_nodes_bordering_spine_item;
        _modules["read_book.toc"].get_border_nodes = get_border_nodes;
        _modules["read_book.toc"].family_for_toc_node = family_for_toc_node;
        _modules["read_book.toc"].get_current_toc_nodes = get_current_toc_nodes;
        _modules["read_book.toc"].get_highlighted_toc_nodes = get_highlighted_toc_nodes;
        _modules["read_book.toc"].get_toc_maps = get_toc_maps;
        _modules["read_book.toc"].get_book_mark_title = get_book_mark_title;
        _modules["read_book.toc"].create_toc_tree = create_toc_tree;
        _modules["read_book.toc"].do_search = do_search;
        _modules["read_book.toc"].create_toc_panel = create_toc_panel;
        _modules["read_book.toc"].recalculate_toc_anchor_positions = recalculate_toc_anchor_positions;
        _modules["read_book.toc"].current_toc_anchor_map = current_toc_anchor_map;
        _modules["read_book.toc"].update_visible_toc_anchors = update_visible_toc_anchors;
        _modules["read_book.toc"].find_anchor_before_range = find_anchor_before_range;
    })();

    (function(){
        var __name__ = "select";
        var caret_position_from_point, safe_nodes;
        if ((typeof document !== "undefined" && document !== null ? document : Object.create(null)).caretPositionFromPoint) {
            caret_position_from_point = document.caretPositionFromPoint.bind(document);
        } else {
            caret_position_from_point = (function() {
                var _anonfunc = function (x, y) {
                    var r;
                    r = document.caretRangeFromPoint(x, y);
                    if (r) {
                        return (function(){
                            var _d = Object.create(null);
                            _d["offsetNode"] = r.startContainer;
                            _d["offset"] = r.startOffset;
                            return _d;
                        }).call(this);
                    }
                    return null;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x", "y"]},
                    __module__ : {value: "select"}
                });
                return _anonfunc;
            })();
        }
        function word_boundary_regex() {
            var ans;
            ans = word_boundary_regex.ans;
            if (ans === undefined) {
                ans = word_boundary_regex.ans = /[\s!-#%-\x2A,-/:;\x3F@\x5B-\x5D_\x7B}\u00A1\u00A7\u00AB\u00B6\u00B7\u00BB\u00BF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u0AF0\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166D\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E3B\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]/;
            }
            return ans;
        };
        if (!word_boundary_regex.__module__) Object.defineProperties(word_boundary_regex, {
            __module__ : {value: "select"}
        });

        function expand_offset_to_word(string, offset) {
            var start, pat, _unpack, end, sz;
            start = offset;
            pat = word_boundary_regex();
            while (start >= 1 && !pat.test(string.charAt(start - 1))) {
                start -= 1;
            }
            _unpack = [offset, string.length];
            end = _unpack[0];
            sz = _unpack[1];
            while (end < sz && !pat.test(string.charAt(end))) {
                end += 1;
            }
            return (function(){
                var _d = Object.create(null);
                _d["word"] = string.slice(start, end);
                _d["start"] = start;
                _d["end"] = end;
                return _d;
            }).call(this);
        };
        if (!expand_offset_to_word.__argnames__) Object.defineProperties(expand_offset_to_word, {
            __argnames__ : {value: ["string", "offset"]},
            __module__ : {value: "select"}
        });

        function word_at_point(x, y) {
            var p, word_info, r;
            p = caret_position_from_point(x, y);
            if (p && _exists.d(p.offsetNode).nodeType === Node.TEXT_NODE) {
                word_info = expand_offset_to_word(p.offsetNode.data, p.offset);
                if (word_info.word) {
                    r = document.createRange();
                    r.setStart(p.offsetNode, word_info.start);
                    r.setEnd(p.offsetNode, word_info.end);
                    return r;
                }
            }
        };
        if (!word_at_point.__argnames__) Object.defineProperties(word_at_point, {
            __argnames__ : {value: ["x", "y"]},
            __module__ : {value: "select"}
        });

        function first_visible_word() {
            var width, height, xdelta, ydelta, r, x, y;
            width = window.innerWidth;
            height = window.innerHeight;
            xdelta = Math.floor(width / 10);
            ydelta = Math.floor(height / 10);
            var _Iter0 = _Iterable(range(0, height, ydelta));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                y = _Iter0[_Index0];
                var _Iter1 = _Iterable(range(0, width, xdelta));
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    x = _Iter1[_Index1];
                    r = word_at_point(x, y);
                    if ((typeof r !== "undefined" && r !== null)) {
                        return r;
                    }
                }
            }
        };
        if (!first_visible_word.__module__) Object.defineProperties(first_visible_word, {
            __module__ : {value: "select"}
        });

        function empty_range_extents() {
            return (function(){
                var _d = Object.create(null);
                _d["start"] = (function(){
                    var _d = Object.create(null);
                    _d["x"] = 0;
                    _d["y"] = 0;
                    _d["height"] = 0;
                    _d["width"] = 0;
                    _d["onscreen"] = false;
                    _d["selected_prev"] = false;
                    return _d;
                }).call(this);
                _d["end"] = (function(){
                    var _d = Object.create(null);
                    _d["x"] = 0;
                    _d["y"] = 0;
                    _d["height"] = 0;
                    _d["width"] = 0;
                    _d["onscreen"] = false;
                    _d["selected_prev"] = false;
                    return _d;
                }).call(this);
                return _d;
            }).call(this);
        };
        if (!empty_range_extents.__module__) Object.defineProperties(empty_range_extents, {
            __module__ : {value: "select"}
        });

        safe_nodes = (function(){
            var _d = Object.create(null);
            _d["img"] = true;
            _d["br"] = true;
            _d["hr"] = true;
            return _d;
        }).call(this);
        function get_selection_node_at_boundary(node, start) {
            var stack, top, name, c;
            stack = [];
            stack.push((function(){
                var _d = Object.create(null);
                _d["node"] = node;
                _d["visited"] = false;
                return _d;
            }).call(this));
            while (stack.length > 0) {
                top = stack[stack.length-1];
                name = (top.node.nodeName) ? top.node.nodeName.toLowerCase() : "";
                if (top.node.nodeType === Node.TEXT_NODE || safe_nodes[(typeof name === "number" && name < 0) ? safe_nodes.length + name : name]) {
                    return top.node;
                } else if (top.visited) {
                    stack.pop();
                } else {
                    top.visited = true;
                    if (top.node.childNodes) {
                        var _Iter2 = _Iterable((start) ? top.node.childNodes : reversed(top.node.childNodes));
                        for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                            c = _Iter2[_Index2];
                            stack.push((function(){
                                var _d = Object.create(null);
                                _d["node"] = c;
                                _d["visited"] = false;
                                return _d;
                            }).call(this));
                        }
                    }
                }
            }
        };
        if (!get_selection_node_at_boundary.__argnames__) Object.defineProperties(get_selection_node_at_boundary, {
            __argnames__ : {value: ["node", "start"]},
            __module__ : {value: "select"}
        });

        function range_extents(q, in_flow_mode) {
            var ans, start, end, rect;
            ans = empty_range_extents();
            if (!q) {
                return ans;
            }
            start = q.cloneRange();
            end = q.cloneRange();
            function rect_onscreen(r) {
                if (r.right <= window.innerWidth && r.bottom <= window.innerHeight && r.left >= 0 && r.top >= -1) {
                    return true;
                }
                return false;
            };
            if (!rect_onscreen.__argnames__) Object.defineProperties(rect_onscreen, {
                __argnames__ : {value: ["r"]},
                __module__ : {value: "select"}
            });

            function apply_rect_to_ans(rect, ans) {
                ans.x = Math.round(rect.left);
                ans.y = Math.round(rect.top);
                ans.height = Math.round(rect.height);
                ans.width = Math.round(rect.width);
                ans.onscreen = rect_onscreen(rect);
                return ans;
            };
            if (!apply_rect_to_ans.__argnames__) Object.defineProperties(apply_rect_to_ans, {
                __argnames__ : {value: ["rect", "ans"]},
                __module__ : {value: "select"}
            });

            function for_boundary(r, ans, is_start) {
                var rect, node, boundary_node, rects, erect;
                rect = r.getBoundingClientRect();
                if (rect.height === 0 && rect.width === 0) {
                    if (_exists.d(r.startContainer).nodeType === Node.ELEMENT_NODE) {
                        node = r.startContainer;
                        if (r.startOffset && node.childNodes.length > r.startOffset) {
                            node = (_expr_temp = node.childNodes)[_bound_index(r.startOffset, _expr_temp)];
                        }
                        boundary_node = get_selection_node_at_boundary(node, is_start);
                        if (boundary_node) {
                            if (boundary_node.nodeType === Node.TEXT_NODE) {
                                if (is_start) {
                                    r.setStart(boundary_node, boundary_node.length - 1);
                                    r.setEnd(boundary_node, boundary_node.length);
                                } else {
                                    r.setStart(boundary_node, 0);
                                    r.setEnd(boundary_node, 1);
                                }
                                rect = r.getBoundingClientRect();
                            } else {
                                rect = boundary_node.getBoundingClientRect();
                                if (!is_start) {
                                    ans.selected_prev = true;
                                }
                            }
                        } else if (node.getClientRects) {
                            rects = node.getClientRects();
                            if (rects.length) {
                                erect = rects[0];
                                rect = (function(){
                                    var _d = Object.create(null);
                                    _d["left"] = erect.left;
                                    _d["top"] = erect.top;
                                    _d["right"] = erect.left + 2;
                                    _d["bottom"] = erect.top + 2;
                                    _d["width"] = 2;
                                    _d["height"] = 2;
                                    return _d;
                                }).call(this);
                            }
                        }
                    }
                }
                apply_rect_to_ans(rect, ans);
            };
            if (!for_boundary.__argnames__) Object.defineProperties(for_boundary, {
                __argnames__ : {value: ["r", "ans", "is_start"]},
                __module__ : {value: "select"}
            });

            if (q.startContainer.nodeType === Node.ELEMENT_NODE) {
                start.collapse(true);
                for_boundary(start, ans.start, true);
            } else if (q.startOffset === 0 && q.startContainer.length === 0) {
                start.collapse(true);
                for_boundary(start, ans.start, true);
            } else if (q.startOffset === q.startContainer.length) {
                start.setStart(q.startContainer, q.startOffset - 1);
                start.setEnd(q.startContainer, q.startOffset);
                rect = start.getBoundingClientRect();
                apply_rect_to_ans(rect, ans.start).selected_prev = true;
            } else {
                start.setStart(q.startContainer, q.startOffset);
                start.setEnd(q.startContainer, q.startOffset + 1);
                rect = start.getBoundingClientRect();
                apply_rect_to_ans(rect, ans.start);
            }
            if (q.endContainer.nodeType === Node.ELEMENT_NODE) {
                end.collapse(false);
                for_boundary(end, ans.end, false);
            } else if (q.endOffset === 0 && q.endContainer.length === 0) {
                end.collapse(false);
                for_boundary(end, ans.end, false);
            } else if (q.endOffset === q.endContainer.length) {
                end.setStart(q.endContainer, q.endOffset - 1);
                end.setEnd(q.endContainer, q.endOffset);
                rect = end.getBoundingClientRect();
                apply_rect_to_ans(rect, ans.end).selected_prev = true;
            } else {
                end.setStart(q.endContainer, q.endOffset);
                end.setEnd(q.endContainer, q.endOffset + 1);
                rect = end.getBoundingClientRect();
                apply_rect_to_ans(rect, ans.end);
            }
            if (ans.end.height === 2 && ans.start.height > 2) {
                ans.end.height = ans.start.height;
            }
            if (ans.start.height === 2 && ans.end.height > 2) {
                ans.start.height = ans.end.height;
            }
            return ans;
        };
        if (!range_extents.__argnames__) Object.defineProperties(range_extents, {
            __argnames__ : {value: ["q", "in_flow_mode"]},
            __module__ : {value: "select"}
        });

        function selection_extents(in_flow_mode) {
            var sel;
            sel = window.getSelection();
            if (!sel || !sel.rangeCount || sel.isCollapsed) {
                return empty_range_extents();
            }
            return range_extents(sel.getRangeAt(0), in_flow_mode);
        };
        if (!selection_extents.__argnames__) Object.defineProperties(selection_extents, {
            __argnames__ : {value: ["in_flow_mode"]},
            __module__ : {value: "select"}
        });

        function is_start_closer_to_point(pos) {
            var sel, p, r, sr, er;
            sel = window.getSelection();
            if (!sel.rangeCount) {
                return;
            }
            p = caret_position_from_point(pos.x, pos.y);
            if (p) {
                r = sel.getRangeAt(0);
                sr = document.createRange();
                sr.setStart(r.startContainer, r.startOffset);
                sr.setEnd(p.offsetNode, p.offset);
                er = document.createRange();
                er.setStart(p.offsetNode, p.offset);
                er.setEnd(r.endContainer, r.endOffset);
                return sr.toString().length < er.toString().length;
            }
            return false;
        };
        if (!is_start_closer_to_point.__argnames__) Object.defineProperties(is_start_closer_to_point, {
            __argnames__ : {value: ["pos"]},
            __module__ : {value: "select"}
        });

        function move_end_of_selection(pos, start) {
            var sel, p, r, q, new_range, other_boundary_changed;
            sel = window.getSelection();
            if (!sel.rangeCount) {
                return;
            }
            p = caret_position_from_point(pos.x, pos.y);
            if (!p) {
                return;
            }
            r = sel.getRangeAt(0);
            if (start === null) {
                q = document.createRange();
                q.setStart(p.offsetNode, p.offset);
                q.setEnd(p.offsetNode, p.offset);
                if (r.compareBoundaryPoints(window.Range.START_TO_START, q) >= 0) {
                    start = true;
                } else if (r.compareBoundaryPoints(window.Range.END_TO_END, q) <= 0) {
                    start = false;
                } else {
                    start = false;
                }
            }
            new_range = document.createRange();
            if (start) {
                new_range.setStart(p.offsetNode, p.offset);
                new_range.setEnd(r.endContainer, r.endOffset);
                other_boundary_changed = r.endContainer !== new_range.endContainer || r.endOffset !== new_range.endOffset;
            } else {
                new_range.setStart(r.startContainer, r.startOffset);
                new_range.setEnd(p.offsetNode, p.offset);
                other_boundary_changed = r.startContainer !== new_range.startContainer || r.startOffset !== new_range.startOffset;
            }
            if (new_range.collapsed && other_boundary_changed) {
                return;
            }
            sel.removeAllRanges();
            sel.addRange(new_range);
        };
        if (!move_end_of_selection.__argnames__) Object.defineProperties(move_end_of_selection, {
            __argnames__ : {value: ["pos", "start"]},
            __module__ : {value: "select"}
        });

        _modules.select.caret_position_from_point = caret_position_from_point;
        _modules.select.safe_nodes = safe_nodes;
        _modules.select.word_boundary_regex = word_boundary_regex;
        _modules.select.expand_offset_to_word = expand_offset_to_word;
        _modules.select.word_at_point = word_at_point;
        _modules.select.first_visible_word = first_visible_word;
        _modules.select.empty_range_extents = empty_range_extents;
        _modules.select.get_selection_node_at_boundary = get_selection_node_at_boundary;
        _modules.select.range_extents = range_extents;
        _modules.select.selection_extents = selection_extents;
        _modules.select.is_start_closer_to_point = is_start_closer_to_point;
        _modules.select.move_end_of_selection = move_end_of_selection;
    })();

    (function(){
        var __name__ = "read_book.iframe";
        var FORCE_FLOW_MODE, CALIBRE_VERSION, ONSCROLL_DEBOUNCE_TIME, ERS_SUPPORTED_FEATURES, drag_mouse_position;
        var traceback = _modules.traceback;

        var fix_fullscreen_svg_images = _modules.fs_images.fix_fullscreen_svg_images;

        var IframeClient = _modules.iframe_comm.IframeClient;

        var all_annots_in_selection = _modules.range_utils.all_annots_in_selection;
        var highlight_associated_with_selection = _modules.range_utils.highlight_associated_with_selection;
        var last_span_for_crw = _modules.range_utils.last_span_for_crw;
        var reset_highlight_counter = _modules.range_utils.reset_highlight_counter;
        var select_crw = _modules.range_utils.select_crw;
        var unwrap_all_crw = _modules.range_utils.unwrap_all_crw;
        var unwrap_crw = _modules.range_utils.unwrap_crw;
        var wrap_text_in_range = _modules.range_utils.wrap_text_in_range;

        var invalidate_anchor_position_cache = _modules["read_book.anchor_visibility"].invalidate_anchor_position_cache;

        var cfi_for_selection = _modules["read_book.cfi"].cfi_for_selection;
        var range_from_cfi = _modules["read_book.cfi"].range_from_cfi;

        var get_elements = _modules["read_book.extract"].get_elements;

        var reset_find_caches = _modules["read_book.find"].reset_find_caches;
        var select_search_result = _modules["read_book.find"].select_search_result;
        var select_tts_mark = _modules["read_book.find"].select_tts_mark;
        var tts_data = _modules["read_book.find"].tts_data;

        var flow_anchor_funcs = _modules["read_book.flow_mode"].anchor_funcs;
        var flow_auto_scroll_action = _modules["read_book.flow_mode"].auto_scroll_action;
        var cancel_drag_scroll_flow = _modules["read_book.flow_mode"].cancel_drag_scroll;
        var ensure_selection_boundary_visible_flow = _modules["read_book.flow_mode"].ensure_selection_boundary_visible;
        var ensure_selection_visible = _modules["read_book.flow_mode"].ensure_selection_visible;
        var flow_onwheel = _modules["read_book.flow_mode"].flow_onwheel;
        var flow_to_scroll_fraction = _modules["read_book.flow_mode"].flow_to_scroll_fraction;
        var flow_handle_gesture = _modules["read_book.flow_mode"].handle_gesture;
        var flow_handle_shortcut = _modules["read_book.flow_mode"].handle_shortcut;
        var flow_jump_to_cfi = _modules["read_book.flow_mode"].jump_to_cfi;
        var flow_layout = _modules["read_book.flow_mode"].layout;
        var flow_scroll_by_page = _modules["read_book.flow_mode"].scroll_by_page;
        var flow_annotation_scroll = _modules["read_book.flow_mode"].scroll_to_extend_annotation;
        var start_drag_scroll_flow = _modules["read_book.flow_mode"].start_drag_scroll;

        var is_footnote_link = _modules["read_book.footnotes"].is_footnote_link;

        var action_for_gesture = _modules["read_book.gestures"].action_for_gesture;

        var annot_id_uuid_map = _modules["read_book.globals"].annot_id_uuid_map;
        var clear_annot_id_uuid_map = _modules["read_book.globals"].clear_annot_id_uuid_map;
        var current_book = _modules["read_book.globals"].current_book;
        var current_layout_mode = _modules["read_book.globals"].current_layout_mode;
        var current_spine_item = _modules["read_book.globals"].current_spine_item;
        var runtime = _modules["read_book.globals"].runtime;
        var set_boss = _modules["read_book.globals"].set_boss;
        var set_current_spine_item = _modules["read_book.globals"].set_current_spine_item;
        var set_layout_mode = _modules["read_book.globals"].set_layout_mode;
        var set_toc_anchor_map = _modules["read_book.globals"].set_toc_anchor_map;

        var highlight_style_as_css = _modules["read_book.highlights"].highlight_style_as_css;

        var apply_prefix_to_hints = _modules["read_book.hints"].apply_prefix_to_hints;
        var hint_visible_links = _modules["read_book.hints"].hint_visible_links;
        var unhint_links = _modules["read_book.hints"].unhint_links;

        var apply_mathjax = _modules["read_book.mathjax"].apply_mathjax;

        var paged_anchor_funcs = _modules["read_book.paged_mode"].anchor_funcs;
        var paged_auto_scroll_action = _modules["read_book.paged_mode"].auto_scroll_action;
        var calc_columns_per_screen = _modules["read_book.paged_mode"].calc_columns_per_screen;
        var cancel_drag_scroll_paged = _modules["read_book.paged_mode"].cancel_drag_scroll;
        var current_cfi = _modules["read_book.paged_mode"].current_cfi;
        var ensure_selection_boundary_visible_paged = _modules["read_book.paged_mode"].ensure_selection_boundary_visible;
        var get_columns_per_screen_data = _modules["read_book.paged_mode"].get_columns_per_screen_data;
        var paged_handle_gesture = _modules["read_book.paged_mode"].handle_gesture;
        var paged_handle_shortcut = _modules["read_book.paged_mode"].handle_shortcut;
        var paged_jump_to_cfi = _modules["read_book.paged_mode"].jump_to_cfi;
        var paged_layout = _modules["read_book.paged_mode"].layout;
        var paged_onwheel = _modules["read_book.paged_mode"].onwheel;
        var page_counts = _modules["read_book.paged_mode"].page_counts;
        var paged_prepare_for_resize = _modules["read_book.paged_mode"].prepare_for_resize;
        var progress_frac = _modules["read_book.paged_mode"].progress_frac;
        var reset_paged_mode_globals = _modules["read_book.paged_mode"].reset_paged_mode_globals;
        var paged_resize_done = _modules["read_book.paged_mode"].resize_done;
        var paged_scroll_by_page = _modules["read_book.paged_mode"].scroll_by_page;
        var scroll_to_elem = _modules["read_book.paged_mode"].scroll_to_elem;
        var paged_annotation_scroll = _modules["read_book.paged_mode"].scroll_to_extend_annotation;
        var paged_scroll_to_fraction = _modules["read_book.paged_mode"].scroll_to_fraction;
        var snap_to_selection = _modules["read_book.paged_mode"].snap_to_selection;
        var start_drag_scroll_paged = _modules["read_book.paged_mode"].start_drag_scroll;
        var will_columns_per_screen_change = _modules["read_book.paged_mode"].will_columns_per_screen_change;

        var elem_for_ref = _modules["read_book.referencing"].elem_for_ref;
        var end_reference_mode = _modules["read_book.referencing"].end_reference_mode;
        var start_reference_mode = _modules["read_book.referencing"].start_reference_mode;

        var finalize_resources = _modules["read_book.resources"].finalize_resources;
        var unserialize_html = _modules["read_book.resources"].unserialize_html;

        var apply_colors = _modules["read_book.settings"].apply_colors;
        var apply_font_size = _modules["read_book.settings"].apply_font_size;
        var apply_settings = _modules["read_book.settings"].apply_settings;
        var apply_stylesheet = _modules["read_book.settings"].apply_stylesheet;
        var opts = _modules["read_book.settings"].opts;
        var set_color_scheme_class = _modules["read_book.settings"].set_color_scheme_class;
        var set_selection_style = _modules["read_book.settings"].set_selection_style;
        var update_settings = _modules["read_book.settings"].update_settings;

        var create_shortcut_map = _modules["read_book.shortcuts"].create_shortcut_map;
        var keyevent_as_shortcut = _modules["read_book.shortcuts"].keyevent_as_shortcut;
        var shortcut_for_key_event = _modules["read_book.shortcuts"].shortcut_for_key_event;

        var flatten_smil_map = _modules["read_book.smil"].flatten_smil_map;
        var smil_element_at = _modules["read_book.smil"].smil_element_at;
        var mark_smil_element = _modules["read_book.smil"].mark_smil_element;

        var find_anchor_before_range = _modules["read_book.toc"].find_anchor_before_range;
        var update_visible_toc_anchors = _modules["read_book.toc"].update_visible_toc_anchors;

        var create_touch_handlers = _modules["read_book.touch"].create_handlers;
        var reset_touch_handlers = _modules["read_book.touch"].reset_handlers;

        var scroll_viewport = _modules["read_book.viewport"].scroll_viewport;

        var first_visible_word = _modules.select.first_visible_word;
        var is_start_closer_to_point = _modules.select.is_start_closer_to_point;
        var move_end_of_selection = _modules.select.move_end_of_selection;
        var selection_extents = _modules.select.selection_extents;
        var word_at_point = _modules.select.word_at_point;

        var debounce = _modules.utils.debounce;
        var is_ios = _modules.utils.is_ios;

        FORCE_FLOW_MODE = false;
        CALIBRE_VERSION = "7.12.0";
        ONSCROLL_DEBOUNCE_TIME = 1e3;
        ERS_SUPPORTED_FEATURES = (function(){
            var s = _set();
            s.jsset.add("dom-manipulation");
            s.jsset.add("layout-changes");
            s.jsset.add("touch-events");
            s.jsset.add("mouse-events");
            s.jsset.add("keyboard-events");
            s.jsset.add("spine-scripting");
            return s;
        })();
        function layout_style() {
            return (current_layout_mode() === "flow") ? "scrolling" : "paginated";
        };
        if (!layout_style.__module__) Object.defineProperties(layout_style, {
            __module__ : {value: "read_book.iframe"}
        });

        drag_mouse_position = (function(){
            var _d = Object.create(null);
            _d["x"] = null;
            _d["y"] = null;
            return _d;
        }).call(this);
        function cancel_drag_scroll() {
            cancel_drag_scroll_flow();
            cancel_drag_scroll_paged();
        };
        if (!cancel_drag_scroll.__module__) Object.defineProperties(cancel_drag_scroll, {
            __module__ : {value: "read_book.iframe"}
        });

        function EPUBReadingSystem() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            EPUBReadingSystem.prototype.__bind_methods__.call(this);
            EPUBReadingSystem.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(EPUBReadingSystem.prototype, "__bind_methods__", {value: function () {
            this.hasFeature = EPUBReadingSystem.prototype.hasFeature.bind(this);
            this.__repr__ = EPUBReadingSystem.prototype.__repr__.bind(this);
            this.__str__ = EPUBReadingSystem.prototype.__str__.bind(this);
        }});
        Object.defineProperties(EPUBReadingSystem.prototype,  {
            "name": {
                "enumerable": true, 
                "get": function name() {
                    var self = this;
                    return "calibre";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "version": {
                "enumerable": true, 
                "get": function version() {
                    var self = this;
                    return CALIBRE_VERSION;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "layoutStyle": {
                "enumerable": true, 
                "get": function layoutStyle() {
                    var self = this;
                    return layout_style();
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        EPUBReadingSystem.prototype.__init__ = function __init__ () {
                    };
        EPUBReadingSystem.prototype.hasFeature = function hasFeature(feature, version) {
            var self = this;
            return _in(feature, ERS_SUPPORTED_FEATURES);
        };
        if (!EPUBReadingSystem.prototype.hasFeature.__argnames__) Object.defineProperties(EPUBReadingSystem.prototype.hasFeature, {
            __argnames__ : {value: ["feature", "version"]},
            __module__ : {value: "read_book.iframe"}
        });
        EPUBReadingSystem.prototype.__repr__ = function __repr__() {
            var self = this;
            return "{name:" + _str.format("{}", self.name) + ", version:" + _str.format("{}", self.version) + ", layoutStyle:" + _str.format("{}", self.layoutStyle) + "}";
        };
        if (!EPUBReadingSystem.prototype.__repr__.__module__) Object.defineProperties(EPUBReadingSystem.prototype.__repr__, {
            __module__ : {value: "read_book.iframe"}
        });
        EPUBReadingSystem.prototype.__str__ = function __str__() {
            var self = this;
            return self.__repr__();
        };
        if (!EPUBReadingSystem.prototype.__str__.__module__) Object.defineProperties(EPUBReadingSystem.prototype.__str__, {
            __module__ : {value: "read_book.iframe"}
        });
        Object.defineProperty(EPUBReadingSystem.prototype, "__bases__", {value: []});
        
        
        

        function FullBookSearch() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            FullBookSearch.prototype.__init__.apply(this, arguments);
        }
        FullBookSearch.prototype.__init__ = function __init__() {
            var self = this;
            var start_spine_index;
            start_spine_index = _exists.d(current_spine_item()).index;
            if (!(typeof start_spine_index !== "undefined" && start_spine_index !== null)) {
                start_spine_index = -1;
            }
            self.start_spine_index = start_spine_index;
            self.progress_frac_at_start = progress_frac();
            self.first_result_shown = false;
        };
        if (!FullBookSearch.prototype.__init__.__module__) Object.defineProperties(FullBookSearch.prototype.__init__, {
            __module__ : {value: "read_book.iframe"}
        });
        FullBookSearch.__argnames__ = FullBookSearch.prototype.__init__.__argnames__;
        FullBookSearch.__handles_kwarg_interpolation__ = FullBookSearch.prototype.__init__.__handles_kwarg_interpolation__;
        FullBookSearch.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        FullBookSearch.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(FullBookSearch.prototype, "__bases__", {value: []});

        function IframeBoss() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            IframeBoss.prototype.__bind_methods__.call(this);
            IframeBoss.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(IframeBoss.prototype, "__bind_methods__", {value: function () {
            this.on_overlay_visibility_changed = IframeBoss.prototype.on_overlay_visibility_changed.bind(this);
            this.modify_selection = IframeBoss.prototype.modify_selection.bind(this);
            this.initialize = IframeBoss.prototype.initialize.bind(this);
            this.onerror = IframeBoss.prototype.onerror.bind(this);
            this.display = IframeBoss.prototype.display.bind(this);
            this.on_scroll_to_frac = IframeBoss.prototype.on_scroll_to_frac.bind(this);
            this.toggle_autoscroll = IframeBoss.prototype.toggle_autoscroll.bind(this);
            this.handle_gesture = IframeBoss.prototype.handle_gesture.bind(this);
            this.handle_long_tap = IframeBoss.prototype.handle_long_tap.bind(this);
            this.gesture_from_margin = IframeBoss.prototype.gesture_from_margin.bind(this);
            this.fake_wheel_event = IframeBoss.prototype.fake_wheel_event.bind(this);
            this.report_human_scroll = IframeBoss.prototype.report_human_scroll.bind(this);
            this.on_scroll_to_anchor = IframeBoss.prototype.on_scroll_to_anchor.bind(this);
            this.on_next_screen = IframeBoss.prototype.on_next_screen.bind(this);
            this.change_font_size = IframeBoss.prototype.change_font_size.bind(this);
            this.viewer_font_size_changed = IframeBoss.prototype.viewer_font_size_changed.bind(this);
            this.change_number_of_columns = IframeBoss.prototype.change_number_of_columns.bind(this);
            this.relayout_on_font_size_change = IframeBoss.prototype.relayout_on_font_size_change.bind(this);
            this.number_of_columns_changed = IframeBoss.prototype.number_of_columns_changed.bind(this);
            this.change_scroll_speed = IframeBoss.prototype.change_scroll_speed.bind(this);
            this.change_stylesheet = IframeBoss.prototype.change_stylesheet.bind(this);
            this.change_color_scheme = IframeBoss.prototype.change_color_scheme.bind(this);
            this.content_loaded = IframeBoss.prototype.content_loaded.bind(this);
            this.content_loaded_stage2 = IframeBoss.prototype.content_loaded_stage2.bind(this);
            this.calculate_progress_frac = IframeBoss.prototype.calculate_progress_frac.bind(this);
            this.get_current_cfi = IframeBoss.prototype.get_current_cfi.bind(this);
            this.update_cfi = IframeBoss.prototype.update_cfi.bind(this);
            this.update_toc_position = IframeBoss.prototype.update_toc_position.bind(this);
            this.onscroll = IframeBoss.prototype.onscroll.bind(this);
            this.no_latency_onscroll = IframeBoss.prototype.no_latency_onscroll.bind(this);
            this.onresize = IframeBoss.prototype.onresize.bind(this);
            this.onselectionchange = IframeBoss.prototype.onselectionchange.bind(this);
            this.onresize_stage2 = IframeBoss.prototype.onresize_stage2.bind(this);
            this.received_window_size = IframeBoss.prototype.received_window_size.bind(this);
            this.onwheel = IframeBoss.prototype.onwheel.bind(this);
            this.onmousemove = IframeBoss.prototype.onmousemove.bind(this);
            this.onmouseup = IframeBoss.prototype.onmouseup.bind(this);
            this.ondoubleclick = IframeBoss.prototype.ondoubleclick.bind(this);
            this.onkeydown = IframeBoss.prototype.onkeydown.bind(this);
            this.on_handle_navigation_shortcut = IframeBoss.prototype.on_handle_navigation_shortcut.bind(this);
            this.oncontextmenu = IframeBoss.prototype.oncontextmenu.bind(this);
            this.send_message = IframeBoss.prototype.send_message.bind(this);
            this.connect_links = IframeBoss.prototype.connect_links.bind(this);
            this.listen_for_image_double_clicks = IframeBoss.prototype.listen_for_image_double_clicks.bind(this);
            this.image_double_clicked = IframeBoss.prototype.image_double_clicked.bind(this);
            this.link_activated = IframeBoss.prototype.link_activated.bind(this);
            this.activate_link = IframeBoss.prototype.activate_link.bind(this);
            this.on_fake_popup_activation = IframeBoss.prototype.on_fake_popup_activation.bind(this);
            this.scroll_to_anchor = IframeBoss.prototype.scroll_to_anchor.bind(this);
            this.scroll_to_ref = IframeBoss.prototype.scroll_to_ref.bind(this);
            this.on_scroll_to_ref = IframeBoss.prototype.on_scroll_to_ref.bind(this);
            this.show_search_result = IframeBoss.prototype.show_search_result.bind(this);
            this.add_search_result_to_history_stack = IframeBoss.prototype.add_search_result_to_history_stack.bind(this);
            this.ensure_search_result_visible = IframeBoss.prototype.ensure_search_result_visible.bind(this);
            this.set_reference_mode = IframeBoss.prototype.set_reference_mode.bind(this);
            this.apply_highlight = IframeBoss.prototype.apply_highlight.bind(this);
            this.annotations_msg_received = IframeBoss.prototype.annotations_msg_received.bind(this);
            this.apply_highlights_on_load = IframeBoss.prototype.apply_highlights_on_load.bind(this);
            this.replace_highlights = IframeBoss.prototype.replace_highlights.bind(this);
            this.add_highlight_listeners = IframeBoss.prototype.add_highlight_listeners.bind(this);
            this.highlight_wrapper_dblclicked = IframeBoss.prototype.highlight_wrapper_dblclicked.bind(this);
            this.copy_selection = IframeBoss.prototype.copy_selection.bind(this);
            this.tts_msg_received = IframeBoss.prototype.tts_msg_received.bind(this);
            this.mark_word_being_spoken = IframeBoss.prototype.mark_word_being_spoken.bind(this);
            this.audio_ebook_msg_received = IframeBoss.prototype.audio_ebook_msg_received.bind(this);
            this.hints_msg_received = IframeBoss.prototype.hints_msg_received.bind(this);
            this.hint_animation_ended = IframeBoss.prototype.hint_animation_ended.bind(this);
        }});
        IframeBoss.prototype.__init__ = function __init__() {
            var self = this;
            var handlers;
            window.navigator.epubReadingSystem = new EPUBReadingSystem;
            self.last_cfi = null;
            self.last_search_at = -1001;
            self.reference_mode_enabled = false;
            self.replace_history_on_next_cfi_update = true;
            self.blob_url_map = Object.create(null);
            self.content_ready = false;
            self.last_window_width = self.last_window_height = -1;
            self.forward_keypresses = false;
            self.full_book_search_in_progress = null;
            set_boss(self);
            handlers = (function(){
                var _d = Object.create(null);
                _d["change_color_scheme"] = self.change_color_scheme;
                _d["change_font_size"] = self.change_font_size;
                _d["viewer_font_size_changed"] = self.viewer_font_size_changed;
                _d["change_number_of_columns"] = self.change_number_of_columns;
                _d["number_of_columns_changed"] = self.number_of_columns_changed;
                _d["change_scroll_speed"] = self.change_scroll_speed;
                _d["display"] = self.display;
                _d["gesture_from_margin"] = self.gesture_from_margin;
                _d["get_current_cfi"] = self.get_current_cfi;
                _d["initialize"] = self.initialize;
                _d["modify_selection"] = self.modify_selection;
                _d["next_screen"] = self.on_next_screen;
                _d["scroll_to_anchor"] = self.on_scroll_to_anchor;
                _d["scroll_to_frac"] = self.on_scroll_to_frac;
                _d["scroll_to_ref"] = self.on_scroll_to_ref;
                _d["fake_popup_activation"] = self.on_fake_popup_activation;
                _d["set_reference_mode"] = self.set_reference_mode;
                _d["toggle_autoscroll"] = self.toggle_autoscroll;
                _d["fake_wheel_event"] = self.fake_wheel_event;
                _d["window_size"] = self.received_window_size;
                _d["overlay_visibility_changed"] = self.on_overlay_visibility_changed;
                _d["show_search_result"] = self.show_search_result;
                _d["handle_navigation_shortcut"] = self.on_handle_navigation_shortcut;
                _d["annotations"] = self.annotations_msg_received;
                _d["tts"] = self.tts_msg_received;
                _d["audio-ebook"] = self.audio_ebook_msg_received;
                _d["hints"] = self.hints_msg_received;
                _d["copy_selection"] = self.copy_selection;
                _d["replace_highlights"] = self.replace_highlights;
                _d["clear_selection"] = (function() {
                    var _anonfunc = function () {
                        window.getSelection().removeAllRanges();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.iframe"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
            self.comm = new IframeClient(handlers, "main-iframe");
            self.last_window_ypos = 0;
            self.length_before = null;
        };
        if (!IframeBoss.prototype.__init__.__module__) Object.defineProperties(IframeBoss.prototype.__init__, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.__argnames__ = IframeBoss.prototype.__init__.__argnames__;
        IframeBoss.__handles_kwarg_interpolation__ = IframeBoss.prototype.__init__.__handles_kwarg_interpolation__;
        IframeBoss.prototype.on_overlay_visibility_changed = function on_overlay_visibility_changed(data) {
            var self = this;
            cancel_drag_scroll();
            if (data.visible) {
                self.forward_keypresses = true;
                if (self.auto_scroll_action) {
                    self.auto_scroll_active_before_overlay = self.auto_scroll_action("is_active");
                    self.auto_scroll_action("stop");
                }
            } else {
                self.forward_keypresses = false;
                if (self.auto_scroll_active_before_overlay) {
                    self.auto_scroll_active_before_overlay = undefined;
                    self.auto_scroll_action("start");
                }
            }
        };
        if (!IframeBoss.prototype.on_overlay_visibility_changed.__argnames__) Object.defineProperties(IframeBoss.prototype.on_overlay_visibility_changed, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.modify_selection = function modify_selection(data) {
            var self = this;
            var sel, use_end, r;
            sel = window.getSelection();
            use_end = false;
            if (data.granularity === "all") {
                r = document.createRange();
                r.selectNode(document.body);
                sel.removeAllRanges();
                sel.addRange(r);
            } else {
                use_end = data.direction === "forward" || data.direction === "right";
                try {
                    sel.modify("extend", data.direction, data.granularity);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        if (data.granularity === "paragraph") {
                            sel.modify("extend", data.direction, "line");
                        }
                    } 
                }
            }
            self.ensure_selection_boundary_visible(use_end);
        };
        if (!IframeBoss.prototype.modify_selection.__argnames__) Object.defineProperties(IframeBoss.prototype.modify_selection, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.initialize = function initialize(data) {
            var self = this;
            scroll_viewport.update_window_size(data.width, data.height);
            window.addEventListener("error", self.onerror);
            window.addEventListener("scroll", debounce(self.onscroll, ONSCROLL_DEBOUNCE_TIME));
            window.addEventListener("scroll", self.no_latency_onscroll);
            window.addEventListener("resize", debounce(self.onresize, 500));
            window.addEventListener("wheel", self.onwheel, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            window.addEventListener("keydown", self.onkeydown, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            window.addEventListener("mousemove", self.onmousemove, (function(){
                var _d = Object.create(null);
                _d["passive"] = true;
                return _d;
            }).call(this));
            window.addEventListener("mouseup", self.onmouseup, (function(){
                var _d = Object.create(null);
                _d["passive"] = true;
                return _d;
            }).call(this));
            window.addEventListener("dblclick", self.ondoubleclick, (function(){
                var _d = Object.create(null);
                _d["passive"] = true;
                return _d;
            }).call(this));
            document.documentElement.addEventListener("contextmenu", self.oncontextmenu, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            document.addEventListener("selectionchange", self.onselectionchange);
            self.color_scheme = data.color_scheme;
            create_touch_handlers();
        };
        if (!IframeBoss.prototype.initialize.__argnames__) Object.defineProperties(IframeBoss.prototype.initialize, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onerror = function onerror(evt) {
            var self = this;
            var msg, script_url, line_number, column_number, error_object, is_internal_error, fname, details;
            msg = evt.message;
            script_url = evt.filename;
            line_number = evt.lineno;
            column_number = evt.colno;
            error_object = evt.error;
            [evt.stopPropagation(), evt.preventDefault()];
            if (error_object === null) {
                console.log("Unhandled error from external javascript, ignoring: " + _str.format("{}", msg) + " " + _str.format("{}", script_url) + " " + _str.format("{}", line_number) + "");
                return;
            }
            is_internal_error = _in(script_url, ["about:srcdoc", "userscript:viewer.js"]);
            if (is_internal_error) {
                console.log("" + _str.format("{}", script_url) + ": " + _str.format("{}", error_object) + "");
                try {
                    fname = (_expr_temp = script_url.rpartition("/"))[_expr_temp.length-1] || script_url;
                    msg = msg + "<br><span style=\"font-size:smaller\">" + "Error at {}:{}:{}".format(fname, line_number, column_number || "") + "</span>";
                    details = (error_object) ? traceback.format_exception(error_object).join("") : "";
                    if (details) {
                        console.log(details);
                    }
                    _interpolate_kwargs.call(self, self.send_message, ["error"].concat([_desugar_kwargs({errkey: "unhandled-error", details: details, msg: msg})]));
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        console.log("There was an error in the iframe unhandled exception handler");
                    } 
                }
            } else {
                (console.error || console.log)("There was an error in the JavaScript from within the book");
            }
        };
        if (!IframeBoss.prototype.onerror.__argnames__) Object.defineProperties(IframeBoss.prototype.onerror, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.display = function display(data) {
            var self = this;
            var _unpack, spine, index, name, root_data;
            cancel_drag_scroll();
            drag_mouse_position.x = drag_mouse_position.y = null;
            self.length_before = null;
            self.content_ready = false;
            clear_annot_id_uuid_map();
            reset_highlight_counter();
            set_toc_anchor_map();
            self.replace_history_on_next_cfi_update = true;
            self.book = current_book.book = data.book;
            self.smil_map = data.smil_map;
            _unpack = flatten_smil_map(self.smil_map);
_unpack = _unpack_asarray(2, _unpack);
            self.smil_anchor_map = _unpack[0];
            self.smil_par_list = _unpack[1];
            self.link_attr = "data-" + self.book.manifest.link_uid;
            self.reference_mode_enabled = data.reference_mode_enabled;
            self.is_titlepage = data.is_titlepage;
            spine = self.book.manifest.spine;
            index = spine.indexOf(data.name);
            reset_paged_mode_globals();
            set_layout_mode((FORCE_FLOW_MODE) ? "flow" : data.settings.read_mode);
            if (current_layout_mode() === "flow") {
                self.do_layout = flow_layout;
                self.handle_wheel = flow_onwheel;
                self.handle_navigation_shortcut = flow_handle_shortcut;
                self._handle_gesture = flow_handle_gesture;
                self.to_scroll_fraction = flow_to_scroll_fraction;
                self.jump_to_cfi = flow_jump_to_cfi;
                self.anchor_funcs = flow_anchor_funcs;
                self.auto_scroll_action = flow_auto_scroll_action;
                self.scroll_to_extend_annotation = flow_annotation_scroll;
                self.ensure_selection_visible = ensure_selection_visible;
                self.ensure_selection_boundary_visible = ensure_selection_boundary_visible_flow;
                self.start_drag_scroll = start_drag_scroll_flow;
                paged_auto_scroll_action("stop");
            } else {
                self.do_layout = paged_layout;
                self.handle_wheel = paged_onwheel;
                self.handle_navigation_shortcut = paged_handle_shortcut;
                self.to_scroll_fraction = paged_scroll_to_fraction;
                self.jump_to_cfi = paged_jump_to_cfi;
                self._handle_gesture = paged_handle_gesture;
                self.anchor_funcs = paged_anchor_funcs;
                self.auto_scroll_action = paged_auto_scroll_action;
                self.scroll_to_extend_annotation = paged_annotation_scroll;
                self.ensure_selection_visible = snap_to_selection;
                self.ensure_selection_boundary_visible = ensure_selection_boundary_visible_paged;
                self.start_drag_scroll = start_drag_scroll_paged;
                flow_auto_scroll_action("stop");
            }
            update_settings(data.settings);
            self.keyboard_shortcut_map = create_shortcut_map(data.settings.keyboard_shortcuts);
            set_current_spine_item((function(){
                var _d = Object.create(null);
                _d["name"] = data.name;
                _d["is_first"] = index === 0;
                _d["is_last"] = index === spine.length - 1;
                _d["index"] = index;
                _d["initial_position"] = data.initial_position;
                return _d;
            }).call(this));
            self.last_cfi = null;
            var _Iter0 = _Iterable(self.blob_url_map);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                name = _Iter0[_Index0];
                window.URL.revokeObjectURL((_expr_temp = self.blob_url_map)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]);
            }
            document.body.style.removeProperty("font-family");
            _unpack = finalize_resources(self.book, data.name, data.resource_data);
_unpack = _unpack_asarray(3, _unpack);
            root_data = _unpack[0];
            self.mathjax = _unpack[1];
            self.blob_url_map = _unpack[2];
            self.highlights_to_apply = data.highlights;
            unserialize_html(root_data, self.content_loaded, null, data.name);
        };
        if (!IframeBoss.prototype.display.__argnames__) Object.defineProperties(IframeBoss.prototype.display, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.on_scroll_to_frac = function on_scroll_to_frac(data) {
            var self = this;
            self.to_scroll_fraction(data.frac, false);
        };
        if (!IframeBoss.prototype.on_scroll_to_frac.__argnames__) Object.defineProperties(IframeBoss.prototype.on_scroll_to_frac, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.toggle_autoscroll = function toggle_autoscroll() {
            var self = this;
            self.auto_scroll_action("toggle");
        };
        if (!IframeBoss.prototype.toggle_autoscroll.__module__) Object.defineProperties(IframeBoss.prototype.toggle_autoscroll, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.handle_gesture = function handle_gesture(gesture) {
            var self = this;
            gesture.resolved_action = action_for_gesture(gesture, current_layout_mode() === "flow");
            if (gesture.resolved_action === "show_chrome") {
                self.send_message("show_chrome");
            } else if (gesture.resolved_action === "decrease_font_size") {
                _interpolate_kwargs.call(self, self.send_message, ["bump_font_size"].concat([_desugar_kwargs({increase: false})]));
            } else if (gesture.resolved_action === "increase_font_size") {
                _interpolate_kwargs.call(self, self.send_message, ["bump_font_size"].concat([_desugar_kwargs({increase: true})]));
            } else if (gesture.resolved_action === "highlight_or_inspect") {
                self.handle_long_tap(gesture);
            } else {
                self._handle_gesture(gesture);
            }
        };
        if (!IframeBoss.prototype.handle_gesture.__argnames__) Object.defineProperties(IframeBoss.prototype.handle_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.handle_long_tap = function handle_long_tap(gesture) {
            var self = this;
            var elements, r, s;
            elements = get_elements(gesture.viewport_x, gesture.viewport_y);
            if (elements.img) {
                _interpolate_kwargs.call(self, self.send_message, ["view_image"].concat([_desugar_kwargs({calibre_src: elements.img})]));
                return;
            }
            if (elements.highlight) {
                select_crw(elements.crw);
                return;
            }
            r = word_at_point(gesture.viewport_x, gesture.viewport_y);
            if (r) {
                s = document.getSelection();
                s.removeAllRanges();
                s.addRange(r);
            }
        };
        if (!IframeBoss.prototype.handle_long_tap.__argnames__) Object.defineProperties(IframeBoss.prototype.handle_long_tap, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.gesture_from_margin = function gesture_from_margin(data) {
            var self = this;
            self.handle_gesture(data.gesture);
        };
        if (!IframeBoss.prototype.gesture_from_margin.__argnames__) Object.defineProperties(IframeBoss.prototype.gesture_from_margin, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.fake_wheel_event = function fake_wheel_event(data) {
            var self = this;
            self.onwheel(data.evt);
        };
        if (!IframeBoss.prototype.fake_wheel_event.__argnames__) Object.defineProperties(IframeBoss.prototype.fake_wheel_event, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.report_human_scroll = function report_human_scroll(scrolled_by_frac) {
            var self = this;
            _interpolate_kwargs.call(self, self.send_message, ["human_scroll"].concat([_desugar_kwargs({scrolled_by_frac: scrolled_by_frac || null})]));
        };
        if (!IframeBoss.prototype.report_human_scroll.__argnames__) Object.defineProperties(IframeBoss.prototype.report_human_scroll, {
            __argnames__ : {value: ["scrolled_by_frac"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.on_scroll_to_anchor = function on_scroll_to_anchor(data) {
            var self = this;
            var frag;
            frag = data.frag;
            if (frag) {
                self.replace_history_on_next_cfi_update = false;
                self.scroll_to_anchor(frag);
            } else {
                self.to_scroll_fraction(0, false);
            }
        };
        if (!IframeBoss.prototype.on_scroll_to_anchor.__argnames__) Object.defineProperties(IframeBoss.prototype.on_scroll_to_anchor, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.on_next_screen = function on_next_screen(data) {
            var self = this;
            var backwards;
            backwards = data.backwards;
            if (current_layout_mode() === "flow") {
                flow_scroll_by_page((backwards) ? -1 : 1, data.flip_if_rtl_page_progression);
            } else {
                paged_scroll_by_page(backwards, data.all_pages_on_screen, data.flip_if_rtl_page_progression);
            }
        };
        if (!IframeBoss.prototype.on_next_screen.__argnames__) Object.defineProperties(IframeBoss.prototype.on_next_screen, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.change_font_size = function change_font_size(data) {
            var self = this;
            if (_exists.n(data.base_font_size) && (data.base_font_size !== opts.base_font_size && (typeof data.base_font_size !== "object" || _not_equals(data.base_font_size, opts.base_font_size)))) {
                opts.base_font_size = data.base_font_size;
                apply_font_size();
                if (!runtime.is_standalone_viewer) {
                    self.relayout_on_font_size_change();
                }
            }
        };
        if (!IframeBoss.prototype.change_font_size.__argnames__) Object.defineProperties(IframeBoss.prototype.change_font_size, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.viewer_font_size_changed = function viewer_font_size_changed(data) {
            var self = this;
            self.relayout_on_font_size_change();
        };
        if (!IframeBoss.prototype.viewer_font_size_changed.__argnames__) Object.defineProperties(IframeBoss.prototype.viewer_font_size_changed, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.change_number_of_columns = function change_number_of_columns(data) {
            var self = this;
            var cdata, delta, new_val;
            if (current_layout_mode() === "flow") {
                _interpolate_kwargs.call(self, self.send_message, ["error"].concat([_desugar_kwargs({errkey: "changing-columns-in-flow-mode"})]));
                return;
            }
            cdata = get_columns_per_screen_data();
            delta = int(data.delta);
            if (delta === 0) {
                new_val = 0;
            } else {
                new_val = max(1, cdata.cps + delta);
            }
            (_expr_temp = opts.columns_per_screen)[_bound_index(cdata.which, _expr_temp)] = new_val;
            self.relayout_on_font_size_change();
            _interpolate_kwargs.call(self, self.send_message, ["columns_per_screen_changed"].concat([_desugar_kwargs({which: cdata.which, cps: new_val})]));
        };
        if (!IframeBoss.prototype.change_number_of_columns.__argnames__) Object.defineProperties(IframeBoss.prototype.change_number_of_columns, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.relayout_on_font_size_change = function relayout_on_font_size_change() {
            var self = this;
            var cfi;
            if (current_layout_mode() !== "flow" && will_columns_per_screen_change()) {
                self.do_layout(self.is_titlepage);
                if (self.last_cfi) {
                    cfi = self.last_cfi.slice(len("epubcfi(/"), -1).partition("/")[2];
                    if (cfi) {
                        self.jump_to_cfi("/" + cfi);
                    }
                }
                self.update_cfi();
            }
            invalidate_anchor_position_cache();
            self.update_toc_position(true);
        };
        if (!IframeBoss.prototype.relayout_on_font_size_change.__module__) Object.defineProperties(IframeBoss.prototype.relayout_on_font_size_change, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.number_of_columns_changed = function number_of_columns_changed(data) {
            var self = this;
            opts.columns_per_screen = data.columns_per_screen;
            self.relayout_on_font_size_change();
        };
        if (!IframeBoss.prototype.number_of_columns_changed.__argnames__) Object.defineProperties(IframeBoss.prototype.number_of_columns_changed, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.change_scroll_speed = function change_scroll_speed(data) {
            var self = this;
            if (_exists.n(data.lines_per_sec_auto)) {
                opts.lines_per_sec_auto = data.lines_per_sec_auto;
            }
        };
        if (!IframeBoss.prototype.change_scroll_speed.__argnames__) Object.defineProperties(IframeBoss.prototype.change_scroll_speed, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.change_stylesheet = function change_stylesheet(data) {
            var self = this;
            opts.user_stylesheet = data.sheet || "";
            apply_stylesheet();
        };
        if (!IframeBoss.prototype.change_stylesheet.__argnames__) Object.defineProperties(IframeBoss.prototype.change_stylesheet, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.change_color_scheme = function change_color_scheme(data) {
            var self = this;
            if (data.color_scheme && data.color_scheme.foreground && data.color_scheme.background) {
                opts.color_scheme = data.color_scheme;
                apply_colors();
                set_color_scheme_class();
            }
        };
        if (!IframeBoss.prototype.change_color_scheme.__argnames__) Object.defineProperties(IframeBoss.prototype.change_color_scheme, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.content_loaded = function content_loaded() {
            var self = this;
            var _unpack;
            document.documentElement.style.overflow = "hidden";
            if (self.is_titlepage && !opts.cover_preserve_aspect_ratio) {
                document.body.classList.add("cover-fill");
            }
            document.body.classList.add("calibre-viewer-" + _str.format("{}", layout_style()) + "");
            set_color_scheme_class();
            if (self.reference_mode_enabled) {
                start_reference_mode();
            }
            _unpack = [scroll_viewport.width(), scroll_viewport.height()];
            self.last_window_width = _unpack[0];
            self.last_window_height = _unpack[1];
            if (self.highlights_to_apply) {
                self.apply_highlights_on_load(self.highlights_to_apply);
                self.highlights_to_apply = null;
            }
            apply_settings();
            invalidate_anchor_position_cache();
            fix_fullscreen_svg_images();
            self.do_layout(self.is_titlepage);
            if (self.mathjax) {
                return apply_mathjax(self.mathjax, self.book.manifest.link_uid, self.content_loaded_stage2);
            }
            self.content_loaded_stage2();
        };
        if (!IframeBoss.prototype.content_loaded.__module__) Object.defineProperties(IframeBoss.prototype.content_loaded, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.content_loaded_stage2 = function content_loaded_stage2() {
            var self = this;
            var csi, ipos, spine, files, spine_index, si, i, load_event;
            reset_find_caches();
            self.connect_links();
            if (runtime.is_standalone_viewer) {
                self.listen_for_image_double_clicks();
            }
            self.content_ready = true;
            if (_exists.d(document.head).firstChild) {
                document.head.removeChild(document.head.firstChild);
            }
            csi = current_spine_item();
            if (csi.initial_position) {
                ipos = csi.initial_position;
                self.replace_history_on_next_cfi_update = ipos.replace_history || false;
                if (ipos.type === "frac") {
                    self.to_scroll_fraction(ipos.frac, true);
                } else if (ipos.type === "anchor") {
                    self.scroll_to_anchor(ipos.anchor);
                } else if (ipos.type === "ref") {
                    self.scroll_to_ref(ipos.refnum);
                } else if (ipos.type === "cfi") {
                    self.jump_to_cfi(ipos.cfi);
                } else if (ipos.type === "search_result") {
                    self.show_search_result(ipos, true);
                } else if (ipos.type === "edit_annotation") {
                    window.setTimeout((function() {
                        var _anonfunc = function () {
                            self.annotations_msg_received((function(){
                                var _d = Object.create(null);
                                _d["type"] = "edit-highlight";
                                _d["uuid"] = ipos.uuid;
                                return _d;
                            }).call(this));
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.iframe"}
                        });
                        return _anonfunc;
                    })(), 5);
                } else if (ipos.type === "smil_id") {
                    self.audio_ebook_msg_received((function(){
                        var _d = Object.create(null);
                        _d["type"] = "play";
                        _d["anchor"] = ipos.anchor;
                        return _d;
                    }).call(this));
                }
            }
            spine = self.book.manifest.spine;
            files = self.book.manifest.files;
            spine_index = csi.index;
            self.length_before = 0;
            if (spine_index > -1) {
                for (var _Index1 = 0; _Index1 < spine_index; _Index1++) {
                    i = _Index1;
                    si = spine[(typeof i === "number" && i < 0) ? spine.length + i : i];
                    if (si) {
                        self.length_before += _exists.d(files[(typeof si === "number" && si < 0) ? files.length + si : si]).length || 0;
                    }
                }
            }
            _interpolate_kwargs.call(self, self.send_message, ["content_loaded"].concat([_desugar_kwargs({progress_frac: self.calculate_progress_frac(), file_progress_frac: progress_frac(), page_counts: page_counts()})]));
            self.last_cfi = null;
            self.auto_scroll_action("resume");
            reset_touch_handlers();
            window.setTimeout(self.update_cfi, ONSCROLL_DEBOUNCE_TIME);
            window.setTimeout(self.update_toc_position, 0);
            load_event = document.createEvent("Event");
            load_event.initEvent("load", false, false);
            window.dispatchEvent(load_event);
        };
        if (!IframeBoss.prototype.content_loaded_stage2.__module__) Object.defineProperties(IframeBoss.prototype.content_loaded_stage2, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.calculate_progress_frac = function calculate_progress_frac() {
            var self = this;
            var current_name, files, file_length, frac, ans;
            current_name = current_spine_item().name;
            files = self.book.manifest.files;
            file_length = _exists.d(files[(typeof current_name === "number" && current_name < 0) ? files.length + current_name : current_name]).length || 0;
            if (self.length_before === null) {
                return 0;
            }
            frac = progress_frac();
            ans = (self.length_before + file_length * frac) / self.book.manifest.spine_length;
            return ans;
        };
        if (!IframeBoss.prototype.calculate_progress_frac.__module__) Object.defineProperties(IframeBoss.prototype.calculate_progress_frac, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.get_current_cfi = function get_current_cfi(data) {
            var self = this;
            var cfi, csi, index, selection, selcfi, seltext;
            cfi = current_cfi();
            csi = current_spine_item();
            function epubcfi(cfi) {
                return (cfi) ? "epubcfi(/{}{})".format(2 * (index + 1), cfi) : null;
            };
            if (!epubcfi.__argnames__) Object.defineProperties(epubcfi, {
                __argnames__ : {value: ["cfi"]},
                __module__ : {value: "read_book.iframe"}
            });

            if (cfi && csi) {
                index = csi.index;
                if (index > -1) {
                    selection = window.getSelection();
                    selcfi = seltext = null;
                    if (selection && !selection.isCollapsed) {
                        seltext = selection.toString();
                        selcfi = cfi_for_selection();
                        selcfi.start = epubcfi(selcfi.start);
                        selcfi.end = epubcfi(selcfi.end);
                    }
                    cfi = epubcfi(cfi);
                    _interpolate_kwargs.call(self, self.send_message, ["report_cfi"].concat([_desugar_kwargs({cfi: cfi, progress_frac: self.calculate_progress_frac(), file_progress_frac: progress_frac(), request_id: data.request_id, selected_text: seltext, selection_bounds: selcfi, page_counts: page_counts()})]));
                    return;
                }
            }
            _interpolate_kwargs.call(self, self.send_message, ["report_cfi"].concat([_desugar_kwargs({cfi: null, progress_frac: 0, file_progress_frac: 0, page_counts: page_counts(), request_id: data.request_id})]));
        };
        if (!IframeBoss.prototype.get_current_cfi.__argnames__) Object.defineProperties(IframeBoss.prototype.get_current_cfi, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.update_cfi = function update_cfi(force_update) {
            var self = this;
            var cfi, index, pf, fpf;
            cfi = current_cfi();
            if (cfi) {
                index = current_spine_item().index;
                if (index > -1) {
                    cfi = "epubcfi(/{}{})".format(2 * (index + 1), cfi);
                    pf = self.calculate_progress_frac();
                    fpf = progress_frac();
                    if (cfi !== self.last_cfi || force_update) {
                        self.last_cfi = cfi;
                        _interpolate_kwargs.call(self, self.send_message, ["update_cfi"].concat([_desugar_kwargs({cfi: cfi, replace_history: self.replace_history_on_next_cfi_update, progress_frac: pf, file_progress_frac: fpf, page_counts: page_counts()})]));
                        self.replace_history_on_next_cfi_update = true;
                    } else {
                        _interpolate_kwargs.call(self, self.send_message, ["update_progress_frac"].concat([_desugar_kwargs({progress_frac: pf, file_progress_frac: fpf, page_counts: page_counts()})]));
                    }
                }
            }
        };
        if (!IframeBoss.prototype.update_cfi.__argnames__) Object.defineProperties(IframeBoss.prototype.update_cfi, {
            __argnames__ : {value: ["force_update"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.update_toc_position = function update_toc_position(recalculate_toc_anchor_positions) {
            var self = this;
            var visible_anchors;
            visible_anchors = update_visible_toc_anchors(self.book.manifest.toc_anchor_map, bool(recalculate_toc_anchor_positions));
            _interpolate_kwargs.call(self, self.send_message, ["update_toc_position"].concat([_desugar_kwargs({visible_anchors: visible_anchors})]));
        };
        if (!IframeBoss.prototype.update_toc_position.__argnames__) Object.defineProperties(IframeBoss.prototype.update_toc_position, {
            __argnames__ : {value: ["recalculate_toc_anchor_positions"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onscroll = function onscroll() {
            var self = this;
            if (self.content_ready) {
                self.update_cfi();
                self.update_toc_position();
            }
        };
        if (!IframeBoss.prototype.onscroll.__module__) Object.defineProperties(IframeBoss.prototype.onscroll, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.no_latency_onscroll = function no_latency_onscroll() {
            var self = this;
            var pf, fpf, sel;
            pf = self.calculate_progress_frac();
            fpf = progress_frac();
            _interpolate_kwargs.call(self, self.send_message, ["update_progress_frac"].concat([_desugar_kwargs({progress_frac: pf, file_progress_frac: fpf, page_counts: page_counts()})]));
            sel = window.getSelection();
            if (sel && !sel.isCollapsed) {
                _interpolate_kwargs.call(self, self.send_message, ["update_selection_position"].concat([_desugar_kwargs({selection_extents: selection_extents(current_layout_mode() === "flow", true)})]));
            }
        };
        if (!IframeBoss.prototype.no_latency_onscroll.__module__) Object.defineProperties(IframeBoss.prototype.no_latency_onscroll, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onresize = function onresize() {
            var self = this;
            self.send_message("request_size");
            if (self.content_ready) {
                if (is_ios) {
                    return;
                }
                self.onresize_stage2();
            }
        };
        if (!IframeBoss.prototype.onresize.__module__) Object.defineProperties(IframeBoss.prototype.onresize, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onselectionchange = function onselectionchange() {
            var self = this;
            var sel, text, annot_id, collapsed, start_is_anchor, r, now, by_search;
            if (!self.content_ready) {
                return;
            }
            sel = window.getSelection();
            text = "";
            annot_id = null;
            collapsed = !sel || sel.isCollapsed;
            start_is_anchor = true;
            if (!collapsed) {
                text = sel.toString();
                annot_id = highlight_associated_with_selection(sel, annot_id_uuid_map);
                r = sel.getRangeAt(0);
                start_is_anchor = r.startContainer === sel.anchorNode && r.startOffset === sel.anchorOffset;
            }
            now = window.performance.now();
            by_search = now - self.last_search_at < 1e3;
            _interpolate_kwargs.call(self, self.send_message, ["selectionchange"].concat([_desugar_kwargs({text: text, empty: !!collapsed, annot_id: annot_id, drag_mouse_position: drag_mouse_position, selection_change_caused_by_search: by_search, selection_extents: selection_extents(current_layout_mode() === "flow"), rtl: scroll_viewport.rtl, vertical: scroll_viewport.vertical_writing_mode, start_is_anchor: start_is_anchor})]));
        };
        if (!IframeBoss.prototype.onselectionchange.__module__) Object.defineProperties(IframeBoss.prototype.onselectionchange, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onresize_stage2 = function onresize_stage2() {
            var self = this;
            var _unpack, cfi, sel;
            if (scroll_viewport.width() === self.last_window_width && scroll_viewport.height() === self.last_window_height) {
                return;
            }
            if (current_layout_mode() !== "flow") {
                paged_prepare_for_resize(self.last_window_width, self.last_window_height);
                self.do_layout(self.is_titlepage);
            }
            _unpack = [scroll_viewport.width(), scroll_viewport.height()];
            self.last_window_width = _unpack[0];
            self.last_window_height = _unpack[1];
            if (self.last_cfi) {
                cfi = self.last_cfi.slice(len("epubcfi(/"), -1).partition("/")[2];
                if (cfi) {
                    self.jump_to_cfi("/" + cfi);
                }
            }
            if (current_layout_mode() !== "flow") {
                paged_resize_done();
            }
            self.update_cfi();
            self.update_toc_position();
            sel = window.getSelection();
            if (sel && !sel.isCollapsed) {
                _interpolate_kwargs.call(self, self.send_message, ["update_selection_position"].concat([_desugar_kwargs({selection_extents: selection_extents(current_layout_mode() === "flow")})]));
            }
        };
        if (!IframeBoss.prototype.onresize_stage2.__module__) Object.defineProperties(IframeBoss.prototype.onresize_stage2, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.received_window_size = function received_window_size(data) {
            var self = this;
            scroll_viewport.update_window_size(data.width, data.height);
            if (self.content_ready) {
                self.onresize_stage2();
            }
        };
        if (!IframeBoss.prototype.received_window_size.__argnames__) Object.defineProperties(IframeBoss.prototype.received_window_size, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onwheel = function onwheel(evt) {
            var self = this;
            if (self.content_ready) {
                if (evt.preventDefault) {
                    evt.preventDefault();
                }
                if (evt.deltaY && evt.ctrlKey && !evt.shiftKey && !evt.altKey && !evt.metaKey) {
                    _interpolate_kwargs.call(self, self.send_message, ["handle_shortcut"].concat([_desugar_kwargs({name: (evt.deltaY < 0) ? "increase_font_size" : "decrease_font_size"})]));
                } else {
                    self.handle_wheel(evt);
                }
            }
        };
        if (!IframeBoss.prototype.onwheel.__argnames__) Object.defineProperties(IframeBoss.prototype.onwheel, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onmousemove = function onmousemove(evt) {
            var self = this;
            var sel, delta;
            if (evt.buttons !== 1) {
                return;
            }
            drag_mouse_position.x = evt.clientX;
            drag_mouse_position.y = evt.clientY;
            if (0 <= (_cond_temp = evt.clientY) && _cond_temp <= window.innerHeight) {
                cancel_drag_scroll();
                return;
            }
            sel = window.getSelection();
            if (!sel) {
                cancel_drag_scroll();
                return;
            }
            delta = (evt.clientY < 0) ? evt.clientY : evt.clientY - window.innerHeight;
            self.start_drag_scroll(delta);
        };
        if (!IframeBoss.prototype.onmousemove.__argnames__) Object.defineProperties(IframeBoss.prototype.onmousemove, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onmouseup = function onmouseup(evt) {
            var self = this;
            cancel_drag_scroll();
            drag_mouse_position.x = drag_mouse_position.y = null;
            self.onselectionchange();
            if (evt.button === 3 || evt.button === 4) {
                _interpolate_kwargs.call(self, self.send_message, ["handle_shortcut"].concat([_desugar_kwargs({name: (evt.button === 3) ? "back" : "forward"})]));
            }
        };
        if (!IframeBoss.prototype.onmouseup.__argnames__) Object.defineProperties(IframeBoss.prototype.onmouseup, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.ondoubleclick = function ondoubleclick(evt) {
            var self = this;
            _interpolate_kwargs.call(self, self.send_message, ["annotations"].concat([_desugar_kwargs({type: "double-click"})]));
        };
        if (!IframeBoss.prototype.ondoubleclick.__argnames__) Object.defineProperties(IframeBoss.prototype.ondoubleclick, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.onkeydown = function onkeydown(evt) {
            var self = this;
            var sc_name;
            if (current_layout_mode() !== "flow" && evt.key === "Tab") {
                evt.preventDefault();
            }
            if (self.forward_keypresses) {
                _interpolate_kwargs.call(self, self.send_message, ["handle_keypress"].concat([_desugar_kwargs({evt: keyevent_as_shortcut(evt)})]));
                [evt.preventDefault(), evt.stopPropagation()];
                return;
            }
            if (self.content_ready) {
                sc_name = shortcut_for_key_event(evt, self.keyboard_shortcut_map);
                if (sc_name) {
                    evt.preventDefault();
                    if (!self.handle_navigation_shortcut(sc_name, evt)) {
                        _interpolate_kwargs.call(self, self.send_message, ["handle_shortcut"].concat([_desugar_kwargs({name: sc_name})]));
                    }
                }
            }
        };
        if (!IframeBoss.prototype.onkeydown.__argnames__) Object.defineProperties(IframeBoss.prototype.onkeydown, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.on_handle_navigation_shortcut = function on_handle_navigation_shortcut(data) {
            var self = this;
            self.handle_navigation_shortcut(data.name, data.key || (function(){
                var _d = Object.create(null);
                _d["key"] = "";
                _d["altKey"] = false;
                _d["ctrlKey"] = false;
                _d["shiftKey"] = false;
                _d["metaKey"] = false;
                return _d;
            }).call(this));
        };
        if (!IframeBoss.prototype.on_handle_navigation_shortcut.__argnames__) Object.defineProperties(IframeBoss.prototype.on_handle_navigation_shortcut, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.oncontextmenu = function oncontextmenu(evt) {
            var self = this;
            if (self.content_ready) {
                evt.preventDefault();
                _interpolate_kwargs.call(self, self.send_message, ["show_chrome"].concat([_desugar_kwargs({elements: get_elements(evt.clientX, evt.clientY)})]));
            }
        };
        if (!IframeBoss.prototype.oncontextmenu.__argnames__) Object.defineProperties(IframeBoss.prototype.oncontextmenu, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.send_message = function send_message() {
            var self = this;
            var action = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var data = arguments[arguments.length-1];
            if (data === null || typeof data !== "object" || data [_kwargs_symbol] !== true) data = {};
            self.comm.send_message(action, data);
        };
        if (!IframeBoss.prototype.send_message.__handles_kwarg_interpolation__) Object.defineProperties(IframeBoss.prototype.send_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["action"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.connect_links = function connect_links() {
            var self = this;
            var a;
            var _Iter2 = _Iterable(document.body.querySelectorAll("a[" + _str.format("{}", self.link_attr) + "],area[" + _str.format("{}", self.link_attr) + "]"));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                a = _Iter2[_Index2];
                a.addEventListener("click", self.link_activated);
            }
            if (runtime.is_standalone_viewer) {
                var _Iter3 = _Iterable(document.body.querySelectorAll("a[target]"));
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    a = _Iter3[_Index3];
                    a.removeAttribute("target");
                }
            }
        };
        if (!IframeBoss.prototype.connect_links.__module__) Object.defineProperties(IframeBoss.prototype.connect_links, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.listen_for_image_double_clicks = function listen_for_image_double_clicks() {
            var self = this;
            var img;
            var _Iter4 = _Iterable(document.querySelectorAll("img, image"));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                img = _Iter4[_Index4];
                img.addEventListener("dblclick", self.image_double_clicked, (function(){
                    var _d = Object.create(null);
                    _d["passive"] = true;
                    return _d;
                }).call(this));
            }
        };
        if (!IframeBoss.prototype.listen_for_image_double_clicks.__module__) Object.defineProperties(IframeBoss.prototype.listen_for_image_double_clicks, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.image_double_clicked = function image_double_clicked(ev) {
            var self = this;
            var img;
            img = ev.currentTarget;
            if (img.dataset.calibreSrc) {
                _interpolate_kwargs.call(self, self.send_message, ["view_image"].concat([_desugar_kwargs({calibre_src: img.dataset.calibreSrc})]));
            }
        };
        if (!IframeBoss.prototype.image_double_clicked.__argnames__) Object.defineProperties(IframeBoss.prototype.image_double_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.link_activated = function link_activated(evt) {
            var self = this;
            var data;
            try {
                data = JSON.parse(evt.currentTarget.getAttribute(self.link_attr));
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    print("WARNING: Failed to parse link data {}, ignoring".format(_exists.c(_exists.d(evt.currentTarget).getAttribute)(self.link_attr)));
                    return;
                } 
            }
            self.activate_link(data.name, data.frag, evt.currentTarget);
        };
        if (!IframeBoss.prototype.link_activated.__argnames__) Object.defineProperties(IframeBoss.prototype.link_activated, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.activate_link = function activate_link(name, frag, target_elem) {
            var self = this;
            var is_popup;
            if (!name) {
                name = current_spine_item().name;
            }
            try {
                is_popup = is_footnote_link(target_elem, name, frag, current_spine_item().name, self.book.manifest.link_to_map || Object.create(null));
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    var traceback = _modules.traceback;

                    traceback.print_exc();
                    is_popup = false;
                } 
            }
            if (is_popup) {
                self.on_fake_popup_activation((function(){
                    var _d = Object.create(null);
                    _d["name"] = name;
                    _d["frag"] = frag;
                    _d["title"] = target_elem.textContent;
                    return _d;
                }).call(this));
                return;
            }
            if (name === current_spine_item().name) {
                self.replace_history_on_next_cfi_update = false;
                self.scroll_to_anchor(frag);
            } else {
                _interpolate_kwargs.call(self, self.send_message, ["scroll_to_anchor"].concat([_desugar_kwargs({name: name, frag: frag})]));
            }
        };
        if (!IframeBoss.prototype.activate_link.__argnames__) Object.defineProperties(IframeBoss.prototype.activate_link, {
            __argnames__ : {value: ["name", "frag", "target_elem"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.on_fake_popup_activation = function on_fake_popup_activation(data) {
            var self = this;
            _interpolate_kwargs.call(self, self.send_message, ["show_footnote"].concat([_desugar_kwargs({name: data.name, frag: data.frag, title: data.title, cols_per_screen: calc_columns_per_screen(), rtl: scroll_viewport.rtl, vertical_writing_mode: scroll_viewport.vertical_writing_mode})]));
        };
        if (!IframeBoss.prototype.on_fake_popup_activation.__argnames__) Object.defineProperties(IframeBoss.prototype.on_fake_popup_activation, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.scroll_to_anchor = function scroll_to_anchor(frag) {
            var self = this;
            var elem, c;
            if (frag) {
                elem = document.getElementById(frag);
                if (!elem) {
                    c = document.getElementsByName(frag);
                    if (c && c.length) {
                        elem = c[0];
                    }
                }
                if (elem) {
                    scroll_to_elem(elem);
                }
            } else {
                scroll_viewport.scroll_to(0, 0);
            }
        };
        if (!IframeBoss.prototype.scroll_to_anchor.__argnames__) Object.defineProperties(IframeBoss.prototype.scroll_to_anchor, {
            __argnames__ : {value: ["frag"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.scroll_to_ref = function scroll_to_ref(refnum) {
            var self = this;
            var elem;
            refnum = int(refnum);
            elem = elem_for_ref(refnum);
            if (elem) {
                scroll_to_elem(elem);
            }
        };
        if (!IframeBoss.prototype.scroll_to_ref.__argnames__) Object.defineProperties(IframeBoss.prototype.scroll_to_ref, {
            __argnames__ : {value: ["refnum"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.on_scroll_to_ref = function on_scroll_to_ref(data) {
            var self = this;
            var refnum;
            refnum = data.refnum;
            if ((typeof refnum !== "undefined" && refnum !== null)) {
                self.scroll_to_ref(refnum);
            }
        };
        if (!IframeBoss.prototype.on_scroll_to_ref.__argnames__) Object.defineProperties(IframeBoss.prototype.on_scroll_to_ref, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.show_search_result = function show_search_result(data, from_load) {
            var self = this;
            var sr, before_select_pos, need_workaround, discovered;
            if (self.load_search_result_timer) {
                window.clearTimeout(self.load_search_result_timer);
                self.load_search_result_timer = null;
            }
            sr = data.search_result;
            if (sr.on_discovery) {
                if (sr.result_num === 1) {
                    self.full_book_search_in_progress = new FullBookSearch;
                } else if (_exists.d(self.full_book_search_in_progress).first_result_shown) {
                    return;
                }
            }
            self.last_search_at = window.performance.now();
            before_select_pos = (function(){
                var _d = Object.create(null);
                _d["x"] = scroll_viewport.x();
                _d["y"] = scroll_viewport.y();
                return _d;
            }).call(this);
            if (select_search_result(sr)) {
                self.ensure_selection_boundary_visible();
                need_workaround = from_load && current_layout_mode() === "paged";
                if (need_workaround) {
                    self.load_search_result_timer = window.setTimeout(self.ensure_search_result_visible.bind(null, before_select_pos), int(3 * ONSCROLL_DEBOUNCE_TIME / 4));
                }
                if (self.full_book_search_in_progress && !self.full_book_search_in_progress.first_result_shown && sr.on_discovery) {
                    discovered = false;
                    if (sr.force_jump_to || progress_frac() >= self.full_book_search_in_progress.progress_frac_at_start || current_spine_item().index !== self.full_book_search_in_progress.start_spine_index) {
                        self.full_book_search_in_progress.first_result_shown = true;
                        discovered = true;
                    } else {
                        scroll_viewport.scroll_to(before_select_pos.x, before_select_pos.y);
                    }
                    _interpolate_kwargs.call(self, self.send_message, ["search_result_discovered"].concat([_desugar_kwargs({search_result: data.search_result, discovered: discovered})]));
                }
                if (!need_workaround) {
                    self.add_search_result_to_history_stack(before_select_pos);
                }
            } else {
                _interpolate_kwargs.call(self, self.send_message, ["search_result_not_found"].concat([_desugar_kwargs({search_result: data.search_result})]));
            }
        };
        if (!IframeBoss.prototype.show_search_result.__argnames__) Object.defineProperties(IframeBoss.prototype.show_search_result, {
            __argnames__ : {value: ["data", "from_load"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.add_search_result_to_history_stack = function add_search_result_to_history_stack(before_select_pos) {
            var self = this;
            self.replace_history_on_next_cfi_update = false;
            self.update_cfi(true);
        };
        if (!IframeBoss.prototype.add_search_result_to_history_stack.__argnames__) Object.defineProperties(IframeBoss.prototype.add_search_result_to_history_stack, {
            __argnames__ : {value: ["before_select_pos"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.ensure_search_result_visible = function ensure_search_result_visible(before_select_pos) {
            var self = this;
            var sel;
            self.load_search_result_timer = null;
            sel = window.getSelection();
            if (sel.isCollapsed || sel.rangeCount === 0) {
                return;
            }
            self.ensure_selection_boundary_visible();
            self.add_search_result_to_history_stack(before_select_pos);
        };
        if (!IframeBoss.prototype.ensure_search_result_visible.__argnames__) Object.defineProperties(IframeBoss.prototype.ensure_search_result_visible, {
            __argnames__ : {value: ["before_select_pos"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.set_reference_mode = function set_reference_mode(data) {
            var self = this;
            self.reference_mode_enabled = data.enabled;
            if (data.enabled) {
                start_reference_mode();
            } else {
                end_reference_mode();
            }
        };
        if (!IframeBoss.prototype.set_reference_mode.__argnames__) Object.defineProperties(IframeBoss.prototype.set_reference_mode, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.apply_highlight = function apply_highlight(uuid, existing, has_notes, style) {
            var self = this;
            var sel, anchor_before, text, bounds, cls, _unpack, annot_id, intersecting_wrappers, removed_highlights, intersecting_uuids, x, crw;
            sel = window.getSelection();
            if (!sel.rangeCount) {
                return;
            }
            anchor_before = find_anchor_before_range(sel.getRangeAt(0), self.book.manifest.toc_anchor_map);
            text = sel.toString();
            bounds = cfi_for_selection();
            style = highlight_style_as_css(style, opts.is_dark_theme, opts.color_scheme.foreground);
            cls = (has_notes) ? "crw-has-dot" : null;
            _unpack = wrap_text_in_range(style, null, cls, self.add_highlight_listeners);
_unpack = _unpack_asarray(2, _unpack);
            annot_id = _unpack[0];
            intersecting_wrappers = _unpack[1];
            removed_highlights = [];
            if (annot_id !== null) {
                intersecting_uuids = (function() {
                    var _Iter = _Iterable(intersecting_wrappers), _Result = Object.create(null), x;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        x = _Iter[_Index];
                        _Result[annot_id_uuid_map[(typeof x === "number" && x < 0) ? annot_id_uuid_map.length + x : x]] = (true);
                    }
                    return _Result;
                })();
                if (existing && intersecting_uuids[(typeof existing === "number" && existing < 0) ? intersecting_uuids.length + existing : existing]) {
                    uuid = existing;
                } else if (intersecting_wrappers.length === 1 && annot_id_uuid_map[_bound_index(intersecting_wrappers[0], annot_id_uuid_map)]) {
                    uuid = annot_id_uuid_map[_bound_index(intersecting_wrappers[0], annot_id_uuid_map)];
                    intersecting_wrappers = [];
                }
                removed_highlights = Object.create(null);
                var _Iter5 = _Iterable(intersecting_wrappers);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    crw = _Iter5[_Index5];
                    unwrap_crw(crw);
                    if (annot_id_uuid_map[(typeof crw === "number" && crw < 0) ? annot_id_uuid_map.length + crw : crw]) {
                        if (annot_id_uuid_map[(typeof crw === "number" && crw < 0) ? annot_id_uuid_map.length + crw : crw] !== uuid) {
                            removed_highlights[_bound_index(annot_id_uuid_map[(typeof crw === "number" && crw < 0) ? annot_id_uuid_map.length + crw : crw], removed_highlights)] = true;
                        }
                        delete annot_id_uuid_map[crw];
                    }
                }
                removed_highlights = Object.keys(removed_highlights);
                sel.removeAllRanges();
                annot_id_uuid_map[(typeof annot_id === "number" && annot_id < 0) ? annot_id_uuid_map.length + annot_id : annot_id] = uuid;
            }
            _interpolate_kwargs.call(self, self.send_message, ["annotations"].concat([_desugar_kwargs({type: "highlight-applied", uuid: uuid, ok: annot_id !== null, bounds: bounds, removed_highlights: removed_highlights, highlighted_text: text, anchor_before: anchor_before})]));
            reset_find_caches();
        };
        if (!IframeBoss.prototype.apply_highlight.__argnames__) Object.defineProperties(IframeBoss.prototype.apply_highlight, {
            __argnames__ : {value: ["uuid", "existing", "has_notes", "style"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.annotations_msg_received = function annotations_msg_received(data) {
            var self = this;
            var dtype, sel, _unpack, end_node, end_offset, found_highlight_to_edit, qcrw, quuid, cls, node, found_highlight_to_remove, existing, bounds, text;
            dtype = (typeof data !== "undefined" && data !== null ? data : Object.create(null)).type;
            if (dtype === "move-end-of-selection") {
                move_end_of_selection(data.pos, data.start);
            } else if (dtype === "set-highlight-style") {
                set_selection_style(data.style);
            } else if (dtype === "trigger-shortcut") {
                self.on_handle_navigation_shortcut(data);
            } else if (dtype === "extend-to-paragraph") {
                sel = window.getSelection();
                try {
                    try {
                        sel.modify("extend", "forward", "paragraphboundary");
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            sel.modify("extend", "forward", "lineboundary");
                        } 
                    }
                    _unpack = [sel.focusNode, sel.focusOffset];
                    end_node = _unpack[0];
                    end_offset = _unpack[1];
                    try {
                        sel.modify("extend", "backward", "paragraphboundary");
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            sel.modify("extend", "backward", "lineboundary");
                        } 
                    }
                    sel.setBaseAndExtent(sel.focusNode, sel.focusOffset, end_node, end_offset);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        (console.error || console.log)("Failed to extend selection to paragraph");
                    } 
                }
            } else if (dtype === "extend-to-point") {
                move_end_of_selection(data.pos, is_start_closer_to_point(data.pos));
            } else if (dtype === "drag-scroll") {
                self.scroll_to_extend_annotation(data.backwards);
            } else if (dtype === "edit-highlight") {
                found_highlight_to_edit = false;
                var _Iter6 = _Iterable(Object.entries(annot_id_uuid_map));
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    _unpack = _Iter6[_Index6];
                    qcrw = _unpack[0];
                    quuid = _unpack[1];
                    if (quuid === data.uuid && select_crw(qcrw)) {
                        found_highlight_to_edit = true;
                        break;
                    }
                }
                if (found_highlight_to_edit) {
                    self.ensure_selection_visible();
                    window.setTimeout((function() {
                        var _anonfunc = function () {
                            _interpolate_kwargs.call(self, self.send_message, ["annotations"].concat([_desugar_kwargs({type: "edit-highlight"})]));
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.iframe"}
                        });
                        return _anonfunc;
                    })(), 50);
                } else {
                    _interpolate_kwargs.call(self, self.send_message, ["annotations"].concat([_desugar_kwargs({type: "edit-highlight-failed", uuid: data.uuid})]));
                }
            } else if (dtype === "notes-edited") {
                cls = "crw-has-dot";
                var _Iter7 = _Iterable(Object.entries(annot_id_uuid_map));
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    _unpack = _Iter7[_Index7];
                    qcrw = _unpack[0];
                    quuid = _unpack[1];
                    if (quuid === data.uuid) {
                        node = last_span_for_crw(qcrw);
                        if (node) {
                            if (data.has_notes) {
                                node.classList.add(cls);
                            } else {
                                node.classList.remove(cls);
                            }
                        }
                    }
                }
            } else if (dtype === "remove-highlight") {
                found_highlight_to_remove = false;
                var _Iter8 = _Iterable(Object.entries(annot_id_uuid_map));
                for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                    _unpack = _Iter8[_Index8];
                    qcrw = _unpack[0];
                    quuid = _unpack[1];
                    if (quuid === data.uuid) {
                        found_highlight_to_remove = true;
                        unwrap_crw(qcrw);
                        delete annot_id_uuid_map[qcrw];
                    }
                }
                if (found_highlight_to_remove) {
                    window.getSelection().removeAllRanges();
                }
            } else if (dtype === "apply-highlight") {
                existing = all_annots_in_selection(window.getSelection(), annot_id_uuid_map);
                if (existing.length === 0 || existing.length === 1 && existing[0] === data.existing) {
                    self.apply_highlight(data.uuid, data.existing, data.has_notes, data.style);
                } else {
                    _interpolate_kwargs.call(self, self.send_message, ["annotations"].concat([_desugar_kwargs({type: "highlight-overlapped", uuid: data.uuid, existing: data.existing, has_notes: data.has_notes, style: data.style})]));
                }
            } else if (dtype === "apply-highlight-overwrite") {
                self.apply_highlight(data.uuid, data.existing, data.has_notes, data.style);
            } else if (dtype === "cite-current-selection") {
                sel = window.getSelection();
                if (!sel.rangeCount) {
                    return;
                }
                bounds = cfi_for_selection();
                text = sel.toString();
                _interpolate_kwargs.call(self, self.send_message, ["annotations"].concat([_desugar_kwargs({type: "cite-data", bounds: bounds, highlighted_text: text})]));
            } else {
                console.log("Ignoring annotations message to iframe with unknown type: " + dtype);
            }
        };
        if (!IframeBoss.prototype.annotations_msg_received.__argnames__) Object.defineProperties(IframeBoss.prototype.annotations_msg_received, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.apply_highlights_on_load = function apply_highlights_on_load(highlights) {
            var self = this;
            var strcmp, r, style, cls, _unpack, annot_id, intersecting_wrappers, crw, h;
            clear_annot_id_uuid_map();
            reset_highlight_counter();
            strcmp = new Intl.Collator().compare;
            highlights.sort((function() {
                var _anonfunc = function (a, b) {
                    return strcmp(a.timestamp, b.timestamp);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "read_book.iframe"}
                });
                return _anonfunc;
            })());
            var _Iter9 = _Iterable(highlights);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                h = _Iter9[_Index9];
                r = range_from_cfi(h.start_cfi, h.end_cfi);
                if (!r) {
                    continue;
                }
                style = highlight_style_as_css(h.style, opts.is_dark_theme, opts.color_scheme.foreground);
                cls = (h.notes) ? "crw-has-dot" : null;
                _unpack = wrap_text_in_range(style, r, cls, self.add_highlight_listeners);
_unpack = _unpack_asarray(2, _unpack);
                annot_id = _unpack[0];
                intersecting_wrappers = _unpack[1];
                if (annot_id !== null) {
                    annot_id_uuid_map[(typeof annot_id === "number" && annot_id < 0) ? annot_id_uuid_map.length + annot_id : annot_id] = h.uuid;
                    var _Iter10 = _Iterable(intersecting_wrappers);
                    for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                        crw = _Iter10[_Index10];
                        unwrap_crw(crw);
                        delete annot_id_uuid_map[crw];
                    }
                }
            }
        };
        if (!IframeBoss.prototype.apply_highlights_on_load.__argnames__) Object.defineProperties(IframeBoss.prototype.apply_highlights_on_load, {
            __argnames__ : {value: ["highlights"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.replace_highlights = function replace_highlights(data) {
            var self = this;
            var highlights;
            highlights = data.highlights;
            unwrap_all_crw();
            self.apply_highlights_on_load(highlights || []);
        };
        if (!IframeBoss.prototype.replace_highlights.__argnames__) Object.defineProperties(IframeBoss.prototype.replace_highlights, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.add_highlight_listeners = function add_highlight_listeners(wrapper) {
            var self = this;
            wrapper.addEventListener("dblclick", self.highlight_wrapper_dblclicked);
        };
        if (!IframeBoss.prototype.add_highlight_listeners.__argnames__) Object.defineProperties(IframeBoss.prototype.add_highlight_listeners, {
            __argnames__ : {value: ["wrapper"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.highlight_wrapper_dblclicked = function highlight_wrapper_dblclicked(ev) {
            var self = this;
            var crw;
            crw = ev.currentTarget.dataset.calibreRangeWrapper;
            if (crw) {
                [ev.preventDefault(), ev.stopPropagation()];
                select_crw(crw);
            }
        };
        if (!IframeBoss.prototype.highlight_wrapper_dblclicked.__argnames__) Object.defineProperties(IframeBoss.prototype.highlight_wrapper_dblclicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.copy_selection = function copy_selection() {
            var self = this;
            var s, text, container, i;
            try {
                if (document.execCommand("copy")) {
                    return;
                }
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                } 
            }
            s = window.getSelection();
            text = s.toString();
            if (text) {
                container = document.createElement("div");
                for (var _Index11 = 0; _Index11 < s.rangeCount; _Index11++) {
                    i = _Index11;
                    container.appendChild(s.getRangeAt(i).cloneContents());
                }
                _interpolate_kwargs.call(self, self.send_message, ["copy_text_to_clipboard"].concat([_desugar_kwargs({text: text, html: container.innerHTML})]));
            }
        };
        if (!IframeBoss.prototype.copy_selection.__module__) Object.defineProperties(IframeBoss.prototype.copy_selection, {
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.tts_msg_received = function tts_msg_received(data) {
            var self = this;
            var _unpack, text_node, offset, r, marked_text, sel;
            if (data.type === "mark") {
                self.mark_word_being_spoken(data.num);
            } else if (data.type === "play") {
                _unpack = [null, 0];
                text_node = _unpack[0];
                offset = _unpack[1];
                if (data.pos) {
                    r = word_at_point(data.pos.x, data.pos.y);
                    if (!r) {
                        return;
                    }
                } else {
                    r = first_visible_word();
                }
                if (r && _exists.d(r.startContainer).nodeType === Node.TEXT_NODE) {
                    _unpack = [r.startContainer, r.startOffset];
                    text_node = _unpack[0];
                    offset = _unpack[1];
                }
                marked_text = tts_data(text_node, offset);
                sel = window.getSelection();
                sel.removeAllRanges();
                _interpolate_kwargs.call(self, self.send_message, ["tts"].concat([_desugar_kwargs({type: "text-extracted", marked_text: marked_text, pos: data.pos})]));
            }
        };
        if (!IframeBoss.prototype.tts_msg_received.__argnames__) Object.defineProperties(IframeBoss.prototype.tts_msg_received, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.mark_word_being_spoken = function mark_word_being_spoken(occurrence_number) {
            var self = this;
            self.last_search_at = window.performance.now();
            if (select_tts_mark(occurrence_number)) {
                self.ensure_selection_boundary_visible();
            }
        };
        if (!IframeBoss.prototype.mark_word_being_spoken.__argnames__) Object.defineProperties(IframeBoss.prototype.mark_word_being_spoken, {
            __argnames__ : {value: ["occurrence_number"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.audio_ebook_msg_received = function audio_ebook_msg_received(data) {
            var self = this;
            var pos, par;
            if (data.type === "mark") {
                if (data.anchor) {
                    self.last_search_at = window.performance.now();
                    if (mark_smil_element(data.anchor)) {
                        self.ensure_selection_boundary_visible();
                        _interpolate_kwargs.call(self, self.send_message, ["audio_ebook_message"].concat([_desugar_kwargs({type: "marked", anchor: data.anchor, idx: data.idx})]));
                    } else {
                        _interpolate_kwargs.call(self, self.send_message, ["audio_ebook_message"].concat([_desugar_kwargs({type: "marked"})]));
                    }
                } else {
                    window.getSelection().removeAllRanges();
                    _interpolate_kwargs.call(self, self.send_message, ["audio_ebook_message"].concat([_desugar_kwargs({type: "marked"})]));
                }
            } else if (data.type === "play") {
                if (data.anchor) {
                    pos = (_expr_temp = self.smil_anchor_map)[_bound_index(data.anchor, _expr_temp)];
                    if ((typeof pos !== "undefined" && pos !== null)) {
                        par = (_expr_temp = self.smil_par_list)[(typeof pos === "number" && pos < 0) ? _expr_temp.length + pos : pos];
                    } else {
                        par = null;
                    }
                } else {
                    par = smil_element_at(data.pos, self.smil_anchor_map, self.smil_par_list);
                }
                _interpolate_kwargs.call(self, self.send_message, ["audio_ebook_message"].concat([_desugar_kwargs({type: "start_play_at", par: par || null, anchor: data.anchor || null, pos: data.pos || null})]));
            } else {
                console.error("Unknown audio ebook message type from main: " + _str.format("{}", data.type) + "");
            }
        };
        if (!IframeBoss.prototype.audio_ebook_msg_received.__argnames__) Object.defineProperties(IframeBoss.prototype.audio_ebook_msg_received, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.hints_msg_received = function hints_msg_received(data) {
            var self = this;
            var hints_map, hint, a;
            if (data.type === "show") {
                window.getSelection().removeAllRanges();
                hints_map = hint_visible_links();
                _interpolate_kwargs.call(self, self.send_message, ["hints"].concat([_desugar_kwargs({type: "shown", hints_map: hints_map})]));
            } else if (data.type === "hide") {
                unhint_links();
            } else if (data.type === "activate") {
                hint = data.hint;
                if (hint.type === "link") {
                    a = document.body.querySelector("[data-calibre-hint-value=\"" + _str.format("{}", hint.value) + "\"]");
                    a.removeEventListener("animationend", self.hint_animation_ended);
                    a.addEventListener("animationend", self.hint_animation_ended, false);
                    a.classList.add("calibre-animated-hint");
                }
            } else if (data.type === "apply_prefix") {
                apply_prefix_to_hints(data.prefix);
            }
        };
        if (!IframeBoss.prototype.hints_msg_received.__argnames__) Object.defineProperties(IframeBoss.prototype.hints_msg_received, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.hint_animation_ended = function hint_animation_ended(ev) {
            var self = this;
            var a;
            a = ev.currentTarget;
            a.classList.remove("calibre-animated-hint");
            a.click();
        };
        if (!IframeBoss.prototype.hint_animation_ended.__argnames__) Object.defineProperties(IframeBoss.prototype.hint_animation_ended, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.iframe"}
        });
        IframeBoss.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        IframeBoss.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(IframeBoss.prototype, "__bases__", {value: []});

        function main() {
            if (!main.boss) {
                main.boss = new IframeBoss;
            }
        };
        if (!main.__module__) Object.defineProperties(main, {
            __module__ : {value: "read_book.iframe"}
        });

        _modules["read_book.iframe"].FORCE_FLOW_MODE = FORCE_FLOW_MODE;
        _modules["read_book.iframe"].CALIBRE_VERSION = CALIBRE_VERSION;
        _modules["read_book.iframe"].ONSCROLL_DEBOUNCE_TIME = ONSCROLL_DEBOUNCE_TIME;
        _modules["read_book.iframe"].ERS_SUPPORTED_FEATURES = ERS_SUPPORTED_FEATURES;
        _modules["read_book.iframe"].drag_mouse_position = drag_mouse_position;
        _modules["read_book.iframe"].layout_style = layout_style;
        _modules["read_book.iframe"].cancel_drag_scroll = cancel_drag_scroll;
        _modules["read_book.iframe"].EPUBReadingSystem = EPUBReadingSystem;
        _modules["read_book.iframe"].FullBookSearch = FullBookSearch;
        _modules["read_book.iframe"].IframeBoss = IframeBoss;
        _modules["read_book.iframe"].main = main;
    })();

    (function(){
        var __name__ = "book_list.item_list";
        var CLASS_NAME;
        var build_rule = _modules.dom.build_rule;
        var svgicon = _modules.dom.svgicon;
        var add_extra_css = _modules.dom.add_extra_css;
        var clear = _modules.dom.clear;

        var E = _modules.elementmaker.E;

        var get_font_size = _modules["book_list.theme"].get_font_size;
        var get_color = _modules["book_list.theme"].get_color;

        CLASS_NAME = "generic-items-list";
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME + " ";
                style = "";
                style += _interpolate_kwargs.call(this, build_rule, [sel + "li"].concat([_desugar_kwargs({padding: "0", border_bottom: "solid 1px " + get_color("window-foreground"), border_top: "solid 1px " + get_color("window-background"), cursor: "pointer", list_style: "none"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".item-title"].concat([_desugar_kwargs({font_size: get_font_size("item-list-title")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " .item-subtitle"].concat([_desugar_kwargs({font_size: get_font_size("item-list-subtitle"), font_style: "italic"})]));
                sel += " li > div:nth-child(1)";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({padding: "1rem"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":hover"].concat([_desugar_kwargs({color: get_color("list-hover-foreground"), background_color: get_color("list-hover-background"), border_top_color: get_color("list-hover-foreground")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":active"].concat([_desugar_kwargs({transform: "scale(1, 1.5)"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.item_list"}
            });
            return _anonfunc;
        })());
        function side_action(action, ev) {
            var li;
            [ev.stopPropagation(), ev.preventDefault()];
            if (action) {
                li = ev.currentTarget.closest("li");
                action(li);
            }
        };
        if (!side_action.__argnames__) Object.defineProperties(side_action, {
            __argnames__ : {value: ["action", "ev"]},
            __module__ : {value: "book_list.item_list"}
        });

        function build_list(container, items, subtitle) {
            var c, ul, has_icons, item, ic, li, s, x;
            c = container;
            clear(c);
            c.classList.add(CLASS_NAME);
            if (subtitle) {
                c.appendChild(_interpolate_kwargs.call(E, E.p, [subtitle].concat([_desugar_kwargs({style: "font-style:italic; padding: 1em 1ex; border-bottom: solid 1px currentColor"})])));
            }
            ul = E.ul();
            c.appendChild(ul);
            has_icons = false;
            var _Iter0 = _Iterable(items);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                item = _Iter0[_Index0];
                if (item.icon) {
                    has_icons = true;
                    break;
                }
            }
            var _Iter1 = _Iterable(items);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                item = _Iter1[_Index1];
                ic = "";
                if (has_icons) {
                    if (item.icon) {
                        ic = svgicon(item.icon);
                    }
                    ic = E.span(ic, "");
                }
                li = E.li(_interpolate_kwargs.call(E, E.div, [ic, item.title].concat([_desugar_kwargs({class_: "item-title"})])));
                ul.appendChild(li);
                if (item.subtitle) {
                    li.firstChild.appendChild(_interpolate_kwargs.call(E, E.div, [item.subtitle].concat([_desugar_kwargs({class_: "item-subtitle", style: "padding-top:1ex"})])));
                }
                if (item.action) {
                    li.addEventListener("click", item.action);
                }
                if (item.data) {
                    li.dataset.userData = item.data;
                }
                if (_exists.d(item.side_actions).length) {
                    s = li.style;
                    s.display = "flex";
                    s.alignItems = "center";
                    li.firstChild.style.flexGrow = "10";
                    li.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display: flex; align-items: center; margin-left: 0.5rem"})]));
                    var _Iter2 = _Iterable(item.side_actions);
                    for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                        x = _Iter2[_Index2];
                        li.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [svgicon(x.icon)].concat([_desugar_kwargs({class_: "simple-link", style: "padding: 0.5rem", title: x.tooltip || "", onclick: side_action.bind(null, x.action)})])));
                    }
                }
            }
        };
        if (!build_list.__argnames__) Object.defineProperties(build_list, {
            __argnames__ : {value: ["container", "items", "subtitle"]},
            __module__ : {value: "book_list.item_list"}
        });

        function create_side_action() {
            var icon = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var action = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_side_action.__defaults__.action : arguments[1];
            var tooltip = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_side_action.__defaults__.tooltip : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "action")){
                action = _kwargs_obj.action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            return (function(){
                var _d = Object.create(null);
                _d["icon"] = icon;
                _d["action"] = action;
                _d["tooltip"] = tooltip;
                return _d;
            }).call(this);
        };
        if (!create_side_action.__defaults__) Object.defineProperties(create_side_action, {
            __defaults__ : {value: {action:null, tooltip:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["icon", "action", "tooltip"]},
            __module__ : {value: "book_list.item_list"}
        });

        function create_item() {
            var title = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var action = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_item.__defaults__.action : arguments[1];
            var subtitle = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_item.__defaults__.subtitle : arguments[2];
            var icon = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_item.__defaults__.icon : arguments[3];
            var data = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_item.__defaults__.data : arguments[4];
            var side_actions = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_item.__defaults__.side_actions : arguments[5];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "action")){
                action = _kwargs_obj.action;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "subtitle")){
                subtitle = _kwargs_obj.subtitle;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "icon")){
                icon = _kwargs_obj.icon;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "data")){
                data = _kwargs_obj.data;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "side_actions")){
                side_actions = _kwargs_obj.side_actions;
            }
            return (function(){
                var _d = Object.create(null);
                _d["title"] = title;
                _d["action"] = action;
                _d["subtitle"] = subtitle;
                _d["icon"] = icon;
                _d["data"] = data;
                _d["side_actions"] = side_actions || [];
                return _d;
            }).call(this);
        };
        if (!create_item.__defaults__) Object.defineProperties(create_item, {
            __defaults__ : {value: {action:null, subtitle:null, icon:null, data:null, side_actions:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title", "action", "subtitle", "icon", "data", "side_actions"]},
            __module__ : {value: "book_list.item_list"}
        });

        function create_item_list() {
            var container = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var items = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var subtitle = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_item_list.__defaults__.subtitle : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "subtitle")){
                subtitle = _kwargs_obj.subtitle;
            }
            build_list(container, items, subtitle);
        };
        if (!create_item_list.__defaults__) Object.defineProperties(create_item_list, {
            __defaults__ : {value: {subtitle:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["container", "items", "subtitle"]},
            __module__ : {value: "book_list.item_list"}
        });

        _modules["book_list.item_list"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.item_list"].side_action = side_action;
        _modules["book_list.item_list"].build_list = build_list;
        _modules["book_list.item_list"].create_side_action = create_side_action;
        _modules["book_list.item_list"].create_item = create_item;
        _modules["book_list.item_list"].create_item_list = create_item_list;
    })();

    (function(){
        var __name__ = "read_book.bookmarks";
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var build_list = _modules["book_list.item_list"].build_list;
        var create_item = _modules["book_list.item_list"].create_item;
        var create_side_action = _modules["book_list.item_list"].create_side_action;

        var ensure_id = _modules.dom.ensure_id;
        var set_css = _modules.dom.set_css;

        var question_dialog = _modules.modals.question_dialog;

        var create_button = _modules.widgets.create_button;

        var get_book_mark_title = _modules["read_book.toc"].get_book_mark_title;

        function goto_cfi(cfi, view) {
            view.goto_cfi(cfi, true);
        };
        if (!goto_cfi.__argnames__) Object.defineProperties(goto_cfi, {
            __argnames__ : {value: ["cfi", "view"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        function remove_bookmark(annotations_manager, title, list_dom_node) {
            question_dialog(_("Are you sure?"), _("Do you want to permanently delete this bookmark?"), (function() {
                var _anonfunc = function (yes) {
                    if (yes) {
                        annotations_manager.remove_bookmark(title);
                        list_dom_node.style.display = "none";
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "read_book.bookmarks"}
                });
                return _anonfunc;
            })());
        };
        if (!remove_bookmark.__argnames__) Object.defineProperties(remove_bookmark, {
            __argnames__ : {value: ["annotations_manager", "title", "list_dom_node"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        function edit_bookmark(annotations_manager, title, list_dom_node) {
            var new_title;
            new_title = window.prompt(_("Enter new title for bookmark:"), title);
            if (new_title) {
                if (annotations_manager.edit_bookmark(title, new_title)) {
                    console.log(list_dom_node);
                    list_dom_node.querySelector(".item-title").textContent = new_title;
                }
            }
        };
        if (!edit_bookmark.__argnames__) Object.defineProperties(edit_bookmark, {
            __argnames__ : {value: ["annotations_manager", "title", "list_dom_node"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        function create_bookmarks_list(annotations_manager, onclick) {
            var bookmarks, items, sa, ea, bookmark, c;
            bookmarks = _interpolate_kwargs.call(this, sorted, [annotations_manager.all_bookmarks()].concat([_desugar_kwargs({key: (function() {
                var _anonfunc = function (x) {
                    return x.title.toLowerCase();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x"]},
                    __module__ : {value: "read_book.bookmarks"}
                });
                return _anonfunc;
            })()})]));
            items = _list_decorate([]);
            var _Iter0 = _Iterable(bookmarks);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                bookmark = _Iter0[_Index0];
                if (!bookmark.removed) {
                    sa = create_side_action("trash", remove_bookmark.bind(null, annotations_manager, bookmark.title), _("Remove this bookmark"));
                    ea = create_side_action("edit", edit_bookmark.bind(null, annotations_manager, bookmark.title), _("Edit this bookmark"));
                    items.push(_interpolate_kwargs.call(this, create_item, [bookmark.title].concat([_desugar_kwargs({data: bookmark.pos, action: onclick.bind(null, goto_cfi.bind(null, bookmark.pos)), side_actions: _list_decorate([ sa, ea ])})])));
                }
            }
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 1ex"})]);
            build_list(c, items);
            return c;
        };
        if (!create_bookmarks_list.__argnames__) Object.defineProperties(create_bookmarks_list, {
            __argnames__ : {value: ["annotations_manager", "onclick"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        function create_new_bookmark(annotations_manager, data) {
            var base_default_title, title, cfi;
            base_default_title = get_book_mark_title() || _("Bookmark");
            title = window.prompt(_("Enter title for bookmark:"), data.selected_text || annotations_manager.default_bookmark_title(base_default_title));
            if (!title) {
                return false;
            }
            cfi = data.cfi;
            if (_exists.d(data.selection_bounds).start) {
                cfi = data.selection_bounds.start;
            }
            annotations_manager.add_bookmark(title, cfi);
            return true;
        };
        if (!create_new_bookmark.__argnames__) Object.defineProperties(create_new_bookmark, {
            __argnames__ : {value: ["annotations_manager", "data"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        function new_bookmark(container_id, annotations_manager, data, onclick, ev) {
            if (create_new_bookmark(annotations_manager, data)) {
                onclick((function() {
                    var _anonfunc = function () {
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.bookmarks"}
                    });
                    return _anonfunc;
                })());
            }
        };
        if (!new_bookmark.__argnames__) Object.defineProperties(new_bookmark, {
            __argnames__ : {value: ["container_id", "annotations_manager", "data", "onclick", "ev"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        function create_bookmarks_panel(annotations_manager, data, book, container, onclick) {
            var container_id, button;
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({display: "flex", flex_direction: "column"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "padding: 1rem"})]));
            container = container.lastChild;
            container_id = ensure_id(container);
            button = create_button(_("New bookmark"), "plus", new_bookmark.bind(null, container_id, annotations_manager, data, onclick));
            container.appendChild(E.div(button));
            container.appendChild(E.div(create_bookmarks_list(annotations_manager, onclick)));
        };
        if (!create_bookmarks_panel.__argnames__) Object.defineProperties(create_bookmarks_panel, {
            __argnames__ : {value: ["annotations_manager", "data", "book", "container", "onclick"]},
            __module__ : {value: "read_book.bookmarks"}
        });

        _modules["read_book.bookmarks"].goto_cfi = goto_cfi;
        _modules["read_book.bookmarks"].remove_bookmark = remove_bookmark;
        _modules["read_book.bookmarks"].edit_bookmark = edit_bookmark;
        _modules["read_book.bookmarks"].create_bookmarks_list = create_bookmarks_list;
        _modules["read_book.bookmarks"].create_new_bookmark = create_new_bookmark;
        _modules["read_book.bookmarks"].new_bookmark = new_bookmark;
        _modules["read_book.bookmarks"].create_bookmarks_panel = create_bookmarks_panel;
    })();

    (function(){
        var __name__ = "read_book.content_popup";
        var CLASS_NAME, TOP_LEVEL_DISPLAY;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;

        var create_wrapped_iframe = _modules.iframe_comm.create_wrapped_iframe;

        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;
        var is_dark_theme = _modules["read_book.globals"].is_dark_theme;

        var load_resources = _modules["read_book.resources"].load_resources;

        CLASS_NAME = "book-content-popup-container";
        TOP_LEVEL_DISPLAY = "flex";
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME;
                style = "";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({justify_content: "center", align_items: "center", height: "100%"})]));
                sel += " > div";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({border_radius: "8px", border: "solid currentColor 2px", margin: "1rem", padding: "0.5rem", box_shadow: "2px 2px 4px currentColor"})]));
                sel += " > div";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({display: "flex", justify_content: "space-between", align_items: "center"})]));
                sel += " > div";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({display: "flex", justify_content: "space-between", align_items: "center"})]));
                sel += " > a";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin_left: "1ex", cursor: "pointer", display: "inline-block"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":hover"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":active"].concat([_desugar_kwargs({transform: "scale(2)"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.content_popup"}
            });
            return _anonfunc;
        })());
        function ContentPopupOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ContentPopupOverlay.prototype.__bind_methods__.call(this);
            ContentPopupOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ContentPopupOverlay.prototype, "__bind_methods__", {value: function () {
            this.reset = ContentPopupOverlay.prototype.reset.bind(this);
            this.create_iframe = ContentPopupOverlay.prototype.create_iframe.bind(this);
            this.on_print = ContentPopupOverlay.prototype.on_print.bind(this);
            this.on_link_activated = ContentPopupOverlay.prototype.on_link_activated.bind(this);
            this.hide = ContentPopupOverlay.prototype.hide.bind(this);
            this.show = ContentPopupOverlay.prototype.show.bind(this);
            this.on_iframe_ready = ContentPopupOverlay.prototype.on_iframe_ready.bind(this);
            this.apply_color_scheme = ContentPopupOverlay.prototype.apply_color_scheme.bind(this);
            this.create_footnote_header = ContentPopupOverlay.prototype.create_footnote_header.bind(this);
            this.load_doc = ContentPopupOverlay.prototype.load_doc.bind(this);
            this.show_footnote = ContentPopupOverlay.prototype.show_footnote.bind(this);
            this.show_footnote_item = ContentPopupOverlay.prototype.show_footnote_item.bind(this);
            this.do_pending_load = ContentPopupOverlay.prototype.do_pending_load.bind(this);
            this.show_footnote_item_stage2 = ContentPopupOverlay.prototype.show_footnote_item_stage2.bind(this);
            this.on_content_loaded = ContentPopupOverlay.prototype.on_content_loaded.bind(this);
        }});
        Object.defineProperties(ContentPopupOverlay.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById("book-content-popup-overlay");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "iframe": {
                "enumerable": true, 
                "get": function iframe() {
                    var self = this;
                    return self.iframe_wrapper.iframe;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ContentPopupOverlay.prototype.__init__ = function __init__(view) {
            var self = this;
            var c;
            self.view = view;
            self.loaded_resources = Object.create(null);
            c = self.container;
            c.classList.add(CLASS_NAME);
            c.appendChild(E.div(E.div()));
            c.addEventListener("click", self.hide);
            c.firstChild.addEventListener("click", (function() {
                var _anonfunc = function (ev) {
                    [ev.stopPropagation(), ev.preventDefault()];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.content_popup"}
                });
                return _anonfunc;
            })());
            self.pending_load = null;
        };
        if (!ContentPopupOverlay.prototype.__init__.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.__argnames__ = ContentPopupOverlay.prototype.__init__.__argnames__;
        ContentPopupOverlay.__handles_kwarg_interpolation__ = ContentPopupOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        ContentPopupOverlay.prototype.reset = function reset() {
            var self = this;
            if (self.iframe_wrapper) {
                self.iframe_wrapper.reset();
            }
        };
        if (!ContentPopupOverlay.prototype.reset.__module__) Object.defineProperties(ContentPopupOverlay.prototype.reset, {
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.create_iframe = function create_iframe() {
            var self = this;
            var handlers, iframe_kw, entry_point, _unpack, iframe, c;
            handlers = (function(){
                var _d = Object.create(null);
                _d["ready"] = self.on_iframe_ready;
                _d["error"] = self.view.on_iframe_error;
                _d["content_loaded"] = self.on_content_loaded;
                _d["print"] = self.on_print;
                _d["link_activated"] = self.on_link_activated;
                return _d;
            }).call(this);
            iframe_kw = (function(){
                var _d = Object.create(null);
                _d["seamless"] = true;
                _d["sandbox"] = "allow-scripts";
                _d["style"] = "width: 100%; max-height: 70vh";
                return _d;
            }).call(this);
            if (runtime.is_standalone_viewer) {
                entry_point = "" + _str.format("{}", runtime.FAKE_PROTOCOL) + "://" + _str.format("{}", runtime.SANDBOX_HOST) + "/book/__popup__";
            } else {
                entry_point = "read_book.footnotes";
            }
            _unpack = create_wrapped_iframe(handlers, _("Loading data, please wait..."), entry_point, iframe_kw);
_unpack = _unpack_asarray(2, _unpack);
            iframe = _unpack[0];
            self.iframe_wrapper = _unpack[1];
            iframe.style.colorScheme = (is_dark_theme()) ? "dark" : "light";
            c = self.container;
            c.firstChild.appendChild(iframe);
        };
        if (!ContentPopupOverlay.prototype.create_iframe.__module__) Object.defineProperties(ContentPopupOverlay.prototype.create_iframe, {
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.on_print = function on_print(data) {
            var self = this;
            print(data.string);
        };
        if (!ContentPopupOverlay.prototype.on_print.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.on_print, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.on_link_activated = function on_link_activated(data) {
            var self = this;
            self.view.link_in_content_popup_activated(data.name, data.frag, data.is_popup, data.title);
        };
        if (!ContentPopupOverlay.prototype.on_link_activated.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.on_link_activated, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.hide = function hide() {
            var self = this;
            self.container.style.display = "none";
            ui_operations.focus_iframe();
        };
        if (!ContentPopupOverlay.prototype.hide.__module__) Object.defineProperties(ContentPopupOverlay.prototype.hide, {
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.show = function show() {
            var self = this;
            var c;
            c = self.container;
            c.style.display = TOP_LEVEL_DISPLAY;
        };
        if (!ContentPopupOverlay.prototype.show.__module__) Object.defineProperties(ContentPopupOverlay.prototype.show, {
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.on_iframe_ready = function on_iframe_ready(msg) {
            var self = this;
            return self.do_pending_load();
        };
        if (!ContentPopupOverlay.prototype.on_iframe_ready.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.on_iframe_ready, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.apply_color_scheme = function apply_color_scheme(bg, fg) {
            var self = this;
            var c;
            c = self.container.firstChild;
            c.style.backgroundColor = bg;
            c.style.color = fg;
            try {
                self.iframe.style.colorScheme = (is_dark_theme()) ? "dark" : "light";
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                } 
            }
        };
        if (!ContentPopupOverlay.prototype.apply_color_scheme.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.apply_color_scheme, {
            __argnames__ : {value: ["bg", "fg"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.create_footnote_header = function create_footnote_header(header) {
            var self = this;
            var bc;
            clear(header);
            header.appendChild(E.h3(self.current_footnote_data.title || _("Footnote")));
            bc = E.div(_interpolate_kwargs.call(E, E.a, [svgicon("arrow-right")].concat([_desugar_kwargs({title: _("Go to this footnote in the main view"), href: "javascript:void(0)"})])), _interpolate_kwargs.call(E, E.a, [svgicon("close")].concat([_desugar_kwargs({title: _("Close the footnotes window"), href: "javascript:void(0)"})])));
            bc.firstChild.addEventListener("click", (function() {
                var _anonfunc = function () {
                    self.hide();
                    self.view.goto_named_destination(self.current_footnote_data.name, self.current_footnote_data.frag);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.content_popup"}
                });
                return _anonfunc;
            })());
            bc.lastChild.addEventListener("click", self.hide);
            header.appendChild(bc);
        };
        if (!ContentPopupOverlay.prototype.create_footnote_header.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.create_footnote_header, {
            __argnames__ : {value: ["header"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.load_doc = function load_doc(name, done_callback) {
            var self = this;
            function cb(resource_data) {
                self.loaded_resources = resource_data;
                done_callback(resource_data);
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["resource_data"]},
                __module__ : {value: "read_book.content_popup"}
            });

            load_resources(self.view.book, name, self.loaded_resources, cb);
        };
        if (!ContentPopupOverlay.prototype.load_doc.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.load_doc, {
            __argnames__ : {value: ["name", "done_callback"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.show_footnote = function show_footnote(data) {
            var self = this;
            var c, header, s, bs;
            if (!self.iframe_wrapper) {
                self.create_iframe();
            }
            self.current_footnote_data = data;
            c = self.container.firstChild;
            header = c.firstChild;
            s = header.style;
            s.paddingLeft = s.paddingRight = s.paddingBottom = s.paddingTop = "0";
            s.marginLeft = s.marginRight = s.marginBottom = s.marginTop = "0";
            s.borderBottom = s.borderTop = s.borderLeft = s.borderRight = "solid currentColor 0";
            bs = "solid currentColor 2px";
            if (self.current_footnote_data.vertical_writing_mode) {
                c.style.width = str(Math.floor(50 / data.cols_per_screen)) + "vw";
                self.iframe.style.height = "80vh";
                c.style.writingMode = (self.current_footnote_data.rtl) ? "vertical-rl" : "vertical-lr";
                if (self.current_footnote_data.rtl) {
                    s.paddingLeft = s.marginLeft = "1ex";
                    s.borderLeft = bs;
                } else {
                    s.paddingRight = s.marginRight = "1ex";
                    s.borderRight = bs;
                }
            } else {
                c.style.width = str(Math.floor(100 / data.cols_per_screen)) + "vw";
                self.iframe.style.height = "12ex";
                c.style.writingMode = (self.current_footnote_data.rtl) ? "horizontal-rl" : "horizontal-lr";
                s.paddingBottom = s.marginBottom = "1ex";
                s.borderBottom = bs;
            }
            self.create_footnote_header(header);
            self.load_doc(data.name, self.show_footnote_item);
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["clear"].concat([_desugar_kwargs({text: _("Loading note, please wait...")})]));
        };
        if (!ContentPopupOverlay.prototype.show_footnote.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.show_footnote, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.show_footnote_item = function show_footnote_item(resource_data) {
            var self = this;
            self.pending_load = [resource_data, self.show_footnote_item_stage2];
            if (self.iframe_wrapper.ready) {
                self.do_pending_load();
            } else {
                self.iframe_wrapper.init();
            }
        };
        if (!ContentPopupOverlay.prototype.show_footnote_item.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.show_footnote_item, {
            __argnames__ : {value: ["resource_data"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.do_pending_load = function do_pending_load() {
            var self = this;
            var _unpack, data, func;
            if (self.pending_load) {
                _unpack = self.pending_load;
_unpack = _unpack_asarray(2, _unpack);
                data = _unpack[0];
                func = _unpack[1];
                self.pending_load = null;
                func(data);
            }
        };
        if (!ContentPopupOverlay.prototype.do_pending_load.__module__) Object.defineProperties(ContentPopupOverlay.prototype.do_pending_load, {
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.show_footnote_item_stage2 = function show_footnote_item_stage2(resource_data) {
            var self = this;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_unencrypted_message, ["display"].concat([_desugar_kwargs({resource_data: resource_data, book: self.view.book, name: self.current_footnote_data.name, frag: self.current_footnote_data.frag, settings: self.view.currently_showing.settings})]));
        };
        if (!ContentPopupOverlay.prototype.show_footnote_item_stage2.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.show_footnote_item_stage2, {
            __argnames__ : {value: ["resource_data"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.on_content_loaded = function on_content_loaded(data) {
            var self = this;
            self.iframe.style.height = "" + _str.format("{}", data.height) + "px";
        };
        if (!ContentPopupOverlay.prototype.on_content_loaded.__argnames__) Object.defineProperties(ContentPopupOverlay.prototype.on_content_loaded, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.content_popup"}
        });
        ContentPopupOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ContentPopupOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ContentPopupOverlay.prototype, "__bases__", {value: []});
        
        
        

        _modules["read_book.content_popup"].CLASS_NAME = CLASS_NAME;
        _modules["read_book.content_popup"].TOP_LEVEL_DISPLAY = TOP_LEVEL_DISPLAY;
        _modules["read_book.content_popup"].ContentPopupOverlay = ContentPopupOverlay;
    })();

    (function(){
        var __name__ = "read_book.prefs";

    })();

    (function(){
        var __name__ = "read_book.prefs.utils";
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var create_button = _modules.widgets.create_button;

        function create_button_box(restore_defaults_func, apply_func, cancel_func) {
            var cbutton, rbutton, obutton, b;
            cbutton = _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: cancel_func})]));
            if (restore_defaults_func) {
                rbutton = _interpolate_kwargs.call(this, create_button, [_("Restore defaults")].concat([_desugar_kwargs({action: restore_defaults_func})]));
            } else {
                rbutton = E.div("");
            }
            obutton = _interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({action: apply_func})]));
            var _Iter0 = _Iterable(_list_decorate([ rbutton, obutton, cbutton ]));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                b = _Iter0[_Index0];
                b.style.marginTop = "1ex";
            }
            return _interpolate_kwargs.call(E, E.div, [rbutton, _interpolate_kwargs.call(E, E.div, [obutton, E.div(""), cbutton].concat([_desugar_kwargs({style: "margin-left: 1rem; display: flex; align-items: flex-start; flex-wrap: wrap"})]))].concat([_desugar_kwargs({style: "margin-top: 1rem; display: flex; justify-content: space-between; align-items: flex-start"})]));
        };
        if (!create_button_box.__argnames__) Object.defineProperties(create_button_box, {
            __argnames__ : {value: ["restore_defaults_func", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.utils"}
        });

        _modules["read_book.prefs.utils"].create_button_box = create_button_box;
    })();

    (function(){
        var __name__ = "read_book.prefs.head_foot";
        var CONTAINER, time_formatter;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ngettext = _modules.gettext.ngettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var clear = _modules.dom.clear;
        var unique_id = _modules.dom.unique_id;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var get_interface_data = _modules.session.get_interface_data;
        var session_defaults = _modules.session.session_defaults;

        var fmt_sidx = _modules.utils.fmt_sidx;

        CONTAINER = unique_id("reader-hf-prefs");
        function create_item(region, label, style) {
            function sep() {
                return _interpolate_kwargs.call(E, E.option, [""].concat([_desugar_kwargs({disabled: true})]));
            };
            if (!sep.__module__) Object.defineProperties(sep, {
                __module__ : {value: "read_book.prefs.head_foot"}
            });

            function opt(label, name, selected) {
                return _interpolate_kwargs.call(E, E.option, [label].concat([_desugar_kwargs({id: name, value: name, selected: bool(selected)})]));
            };
            if (!opt.__argnames__) Object.defineProperties(opt, {
                __argnames__ : {value: ["label", "name", "selected"]},
                __module__ : {value: "read_book.prefs.head_foot"}
            });

            return _interpolate_kwargs.call(E, E.tr, [_interpolate_kwargs.call(E, E.td, [label + ":"].concat([_desugar_kwargs({style: "padding: 1ex 1rem"})])), E.td(_interpolate_kwargs.call(E, E.select, [opt(_("Empty"), "empty", true), sep(), opt(_("Book title"), "title"), opt(_("Authors"), "authors"), opt(_("Series"), "series"), sep(), opt(_("Top level section"), "top-section"), opt(_("Current section"), "section"), opt(_("View mode"), "view-mode"), opt(_("View mode as icon"), "view-mode-icon"), sep(), opt(_("Clock"), "clock"), opt(_("Controls button on hover"), "menu-icon-on-hover"), sep(), opt(_("Progress"), "progress"), opt(_("Time to read book"), "time-book"), opt(_("Time to read chapter"), "time-chapter"), opt(_("Time to read chapter and book"), "time-chapter-book"), opt(_("Position in book"), "pos-book"), opt(_("Position in chapter"), "pos-chapter"), opt(_("Pages in chapter"), "pages-progress")].concat([_desugar_kwargs({data_region: region})])))].concat([_desugar_kwargs({style: style || ""})]));
        };
        if (!create_item.__argnames__) Object.defineProperties(create_item, {
            __argnames__ : {value: ["region", "label", "style"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function create_items(which) {
            var ans;
            if (which === "header" || which === "footer") {
                ans = _interpolate_kwargs.call(E, E.table, [create_item("left", _("Left")), create_item("middle", _("Middle")), create_item("right", _("Right"))].concat([_desugar_kwargs({data_which: which})]));
            } else if (which === "controls_footer") {
                ans = _interpolate_kwargs.call(E, E.table, [create_item("left", _("Left"), "display: none"), create_item("middle", _("Middle")), create_item("right", _("Right"))].concat([_desugar_kwargs({data_which: which})]));
            } else {
                ans = _interpolate_kwargs.call(E, E.table, [create_item("left", _("Top")), create_item("middle", _("Middle")), create_item("right", _("Bottom"))].concat([_desugar_kwargs({data_which: which})]));
            }
            return ans;
        };
        if (!create_items.__argnames__) Object.defineProperties(create_items, {
            __argnames__ : {value: ["which"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function apply_setting(table, val) {
            var sel, opt, x, region;
            var _Iter0 = _Iterable("left middle right".split(" "));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                region = _Iter0[_Index0];
                sel = table.querySelector("select[data-region=" + _str.format("{}", region) + "]");
                var _Iter1 = _Iterable(sel.selectedOptions);
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    opt = _Iter1[_Index1];
                    opt.selected = false;
                }
                x = val[(typeof region === "number" && region < 0) ? val.length + region : region] || "empty";
                opt = sel.namedItem(x);
                if (opt) {
                    opt.selected = true;
                } else {
                    sel.selectedIndex = 0;
                }
            }
        };
        if (!apply_setting.__argnames__) Object.defineProperties(apply_setting, {
            __argnames__ : {value: ["table", "val"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function get_setting(table) {
            var ans, sel, region;
            ans = Object.create(null);
            var _Iter2 = _Iterable("left middle right".split(" "));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                region = _Iter2[_Index2];
                sel = table.querySelector("select[data-region=" + _str.format("{}", region) + "]");
                if (sel.selectedIndex > -1) {
                    ans[(typeof region === "number" && region < 0) ? ans.length + region : region] = (_expr_temp = sel.options)[_bound_index(sel.selectedIndex, _expr_temp)].value;
                }
            }
            return ans;
        };
        if (!get_setting.__argnames__) Object.defineProperties(get_setting, {
            __argnames__ : {value: ["table"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function groups() {
            return (function(){
                var _d = Object.create(null);
                _d["header"] = _("Header");
                _d["footer"] = _("Footer");
                _d["left-margin"] = _("Left margin");
                _d["right-margin"] = _("Right margin");
                _d["controls_footer"] = _("Controls footer");
                return _d;
            }).call(this);
        };
        if (!groups.__module__) Object.defineProperties(groups, {
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function restore_defaults() {
            var container, table, which;
            container = document.getElementById(CONTAINER);
            var _Iter3 = _Iterable(Object.keys(groups()));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                which = _Iter3[_Index3];
                table = container.querySelector("table[data-which=" + _str.format("{}", which) + "]");
                apply_setting(table, (_expr_temp = session_defaults())[(typeof which === "number" && which < 0) ? _expr_temp.length + which : which] || Object.create(null));
            }
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function create_head_foot_panel(container, apply_func, cancel_func) {
            var gr, s, key, sd, table, which;
            gr = groups();
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER})]));
            container = container.lastChild;
            var _Iter4 = _Iterable(gr);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                key = _Iter4[_Index4];
                s = "margin: 1rem;";
                if (container.childNodes.length > 0) {
                    s += "margin-top: 0;";
                }
                container.appendChild(_interpolate_kwargs.call(E, E.h4, [gr[(typeof key === "number" && key < 0) ? gr.length + key : key]].concat([_desugar_kwargs({style: s})])));
                container.appendChild(create_items(key));
                container.appendChild(E.hr());
            }
            container.removeChild(container.lastChild);
            sd = get_session_data();
            var _Iter5 = _Iterable(Object.keys(gr));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                which = _Iter5[_Index5];
                table = container.querySelector("table[data-which=" + _str.format("{}", which) + "]");
                apply_setting(table, sd.get(which) || Object.create(null));
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [create_button_box(restore_defaults, apply_func, cancel_func)].concat([_desugar_kwargs({style: "margin: 1rem"})])));
        };
        if (!create_head_foot_panel.__argnames__) Object.defineProperties(create_head_foot_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function commit_head_foot(onchange, container) {
            var sd, changed, prev, table, current, region, which;
            sd = get_session_data();
            changed = false;
            var _Iter6 = _Iterable(Object.keys(groups()));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                which = _Iter6[_Index6];
                prev = sd.get(which) || Object.create(null);
                table = container.querySelector("table[data-which=" + _str.format("{}", which) + "]");
                current = get_setting(table);
                var _Iter7 = _Iterable("left middle right".split(" "));
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    region = _Iter7[_Index7];
                    if (prev[(typeof region === "number" && region < 0) ? prev.length + region : region] !== current[(typeof region === "number" && region < 0) ? current.length + region : region]) {
                        changed = true;
                    }
                }
                sd.set(which, get_setting(table));
            }
            if (changed) {
                onchange();
            }
        };
        if (!commit_head_foot.__argnames__) Object.defineProperties(commit_head_foot, {
            __argnames__ : {value: ["onchange", "container"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        if (_exists.d((typeof window !== "undefined" && window !== null ? window : Object.create(null)).Intl).DateTimeFormat) {
            time_formatter = window.Intl.DateTimeFormat(undefined, (function(){
                var _d = Object.create(null);
                _d["hour"] = "numeric";
                _d["minute"] = "numeric";
                return _d;
            }).call(this));
        } else {
            time_formatter = (function(){
                var _d = Object.create(null);
                _d["format"] = (function() {
                    var _anonfunc = function (date) {
                        return "{}:{}".format(date.getHours(), date.getMinutes());
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["date"]},
                        __module__ : {value: "read_book.prefs.head_foot"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
        }
        function set_time_formatter(func) {
            time_formatter = (function(){
                var _d = Object.create(null);
                _d["format"] = func;
                return _d;
            }).call(this);
        };
        if (!set_time_formatter.__argnames__) Object.defineProperties(set_time_formatter, {
            __argnames__ : {value: ["func"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function format_time_left(seconds) {
            var _unpack, hours, minutes;
            _unpack = divmod(int(seconds / 60), 60);
_unpack = _unpack_asarray(2, _unpack);
            hours = _unpack[0];
            minutes = _unpack[1];
            if (hours <= 0) {
                if (minutes < 1) {
                    return _("almost done");
                }
                minutes = minutes;
                return ngettext("{} min", "{} mins", minutes).format(minutes);
            }
            if (!minutes) {
                return ngettext("{} hour", "{} hours", hours).format(hours);
            }
            return _("{} h {} mins").format(hours, minutes);
        };
        if (!format_time_left.__argnames__) Object.defineProperties(format_time_left, {
            __argnames__ : {value: ["seconds"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function format_pos(progress_frac, length) {
            var pages, pos;
            if (length < 1) {
                return "";
            }
            pages = Math.ceil(length / 1e3);
            pos = progress_frac * pages;
            return "" + _str.format("{:.1f}", pos) + " / " + _str.format("{}", pages) + "";
        };
        if (!format_pos.__argnames__) Object.defineProperties(format_pos, {
            __argnames__ : {value: ["progress_frac", "length"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        function render_head_foot(div, which, region, metadata, current_toc_node, current_toc_toplevel_node, book_time, chapter_time, pos, override, view_mode) {
            var template, field, interface_data, text, has_clock, percent, ival;
            template = get_session_data().get(which) || Object.create(null);
            field = template[(typeof region === "number" && region < 0) ? template.length + region : region] || "empty";
            interface_data = get_interface_data();
            text = "";
            has_clock = false;
            if (override) {
                text = override;
            } else if (field === "menu-icon-on-hover") {
                clear(div);
                div.appendChild(_interpolate_kwargs.call(E, E.div, [E.span(_("Show controls"))].concat([_desugar_kwargs({class_: "visible-on-hover", title: _("Show viewer controls"), style: "cursor: pointer"})])));
                return has_clock;
            } else if (field === "progress") {
                percent = min(100, max(Math.round(pos.progress_frac * 100), 0));
                text = percent + "%";
            } else if (field === "title") {
                text = metadata.title || _("Untitled");
            } else if (field === "authors") {
                text = " & ".join(metadata.authors || []);
            } else if (field === "series") {
                if (metadata.series) {
                    ival = _interpolate_kwargs.call(this, fmt_sidx, [metadata.series_index].concat([_desugar_kwargs({use_roman: interface_data.use_roman_numerals_for_series_number})]));
                    text = _("{0} of {1}").format(ival, metadata.series);
                }
            } else if (field === "clock") {
                text = time_formatter.format(new Date);
                has_clock = true;
            } else if (field === "section") {
                text = (current_toc_node) ? current_toc_node.title : "";
            } else if (field === "top-section") {
                text = (current_toc_toplevel_node) ? current_toc_toplevel_node.title : "";
                if (!text) {
                    text = (current_toc_node) ? current_toc_node.title : "";
                }
            } else if (field === "view-mode") {
                text = (view_mode === "paged") ? _("Paged") : _("Flow");
            } else if (field === "view-mode-icon") {
                text = (view_mode === "paged") ? "" : "";
            } else if (field.startswith("time-")) {
                if (book_time === null || chapter_time === null) {
                    text = _("Calculating...");
                } else {
                    if (field === "time-book") {
                        text = format_time_left(book_time);
                    } else if (field === "time-chapter") {
                        text = format_time_left(chapter_time);
                    } else {
                        text = "{} ({})".format(format_time_left(chapter_time), format_time_left(book_time));
                    }
                }
            } else if (field.startswith("pos-")) {
                if (field === "pos-book") {
                    text = format_pos(pos.progress_frac, pos.book_length);
                } else {
                    text = format_pos(pos.file_progress_frac, pos.chapter_length);
                }
            } else if (field === "pages-progress") {
                if (pos.page_counts) {
                    text = "" + _str.format("{}", pos.page_counts.current + 1) + " / " + _str.format("{}", pos.page_counts.total) + "";
                } else {
                    text = _("Unknown");
                }
            }
            if (!text) {
                text = "";
            }
            if (text !== div.textContent) {
                div.textContent = text;
            }
            return has_clock;
        };
        if (!render_head_foot.__argnames__) Object.defineProperties(render_head_foot, {
            __argnames__ : {value: ["div", "which", "region", "metadata", "current_toc_node", "current_toc_toplevel_node", "book_time", "chapter_time", "pos", "override", "view_mode"]},
            __module__ : {value: "read_book.prefs.head_foot"}
        });

        _modules["read_book.prefs.head_foot"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.head_foot"].time_formatter = time_formatter;
        _modules["read_book.prefs.head_foot"].create_item = create_item;
        _modules["read_book.prefs.head_foot"].create_items = create_items;
        _modules["read_book.prefs.head_foot"].apply_setting = apply_setting;
        _modules["read_book.prefs.head_foot"].get_setting = get_setting;
        _modules["read_book.prefs.head_foot"].groups = groups;
        _modules["read_book.prefs.head_foot"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.head_foot"].create_head_foot_panel = create_head_foot_panel;
        _modules["read_book.prefs.head_foot"].commit_head_foot = commit_head_foot;
        _modules["read_book.prefs.head_foot"].set_time_formatter = set_time_formatter;
        _modules["read_book.prefs.head_foot"].format_time_left = format_time_left;
        _modules["read_book.prefs.head_foot"].format_pos = format_pos;
        _modules["read_book.prefs.head_foot"].render_head_foot = render_head_foot;
    })();

    (function(){
        var __name__ = "read_book.goto";
        var traceback = _modules.traceback;

        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var encode_query_component = _modules.ajax.encode_query_component;

        var build_list = _modules["book_list.item_list"].build_list;
        var create_item = _modules["book_list.item_list"].create_item;

        var ensure_id = _modules.dom.ensure_id;
        var set_css = _modules.dom.set_css;

        var error_dialog = _modules.modals.error_dialog;

        var current_book = _modules["read_book.globals"].current_book;
        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var format_pos = _modules["read_book.prefs.head_foot"].format_pos;

        var get_border_nodes = _modules["read_book.toc"].get_border_nodes;
        var get_toc_maps = _modules["read_book.toc"].get_toc_maps;

        var create_button = _modules.widgets.create_button;

        function create_goto_list(onclick, current_position_data) {
            var ans, items, location_text, landmarks, toc, id_map, _unpack, before, after, l;
            ans = E.div();
            items = [];
            location_text = format_pos(current_position_data.progress_frac, current_position_data.book_length) + " :: ";
            if (current_position_data.cfi) {
                location_text += current_position_data.cfi;
            }
            landmarks = current_book().manifest.landmarks;
            toc = current_book().manifest.toc;
            id_map = get_toc_maps(toc)[1];
            _unpack = get_border_nodes(toc, id_map);
_unpack = _unpack_asarray(2, _unpack);
            before = _unpack[0];
            after = _unpack[1];
            if (after) {
                items.push(_interpolate_kwargs.call(this, create_item, [_("Next section")].concat([_desugar_kwargs({icon: "caret-right", subtitle: after.title, action: onclick.bind(null, after.dest, after.frag)})])));
            }
            if (before) {
                items.push(_interpolate_kwargs.call(this, create_item, [_("Previous section")].concat([_desugar_kwargs({icon: "caret-left", subtitle: before.title, action: onclick.bind(null, before.dest, before.frag)})])));
            }
            items.push(_interpolate_kwargs.call(this, create_item, [_("Book start")].concat([_desugar_kwargs({action: onclick.bind(null, (function() {
                var _anonfunc = function (view) {
                    view.goto_doc_boundary(true);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["view"]},
                    __module__ : {value: "read_book.goto"}
                });
                return _anonfunc;
            })())})])));
            items.push(_interpolate_kwargs.call(this, create_item, [_("Book end")].concat([_desugar_kwargs({action: onclick.bind(null, (function() {
                var _anonfunc = function (view) {
                    view.goto_doc_boundary(false);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["view"]},
                    __module__ : {value: "read_book.goto"}
                });
                return _anonfunc;
            })())})])));
            items.push(_interpolate_kwargs.call(this, create_item, [_("Metadata")].concat([_desugar_kwargs({subtitle: _("Details about this book"), action: onclick.bind(null, (function() {
                var _anonfunc = function (view) {
                    view.overlay.show_metadata();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["view"]},
                    __module__ : {value: "read_book.goto"}
                });
                return _anonfunc;
            })())})])));
            if (!runtime.is_standalone_viewer) {
                items.push(_interpolate_kwargs.call(this, create_item, [_("Book page in library")].concat([_desugar_kwargs({subtitle: _("The page for this book in the calibre library"), action: onclick.bind(null, (function() {
                    var _anonfunc = function (view) {
                        view.open_book_page();
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["view"]},
                        __module__ : {value: "read_book.goto"}
                    });
                    return _anonfunc;
                })())})])));
            }
            items.push(_interpolate_kwargs.call(this, create_item, [_("Location")].concat([_desugar_kwargs({subtitle: location_text, action: onclick.bind(null, (function() {
                var _anonfunc = function (view) {
                    view.overlay.show_ask_for_location();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["view"]},
                    __module__ : {value: "read_book.goto"}
                });
                return _anonfunc;
            })())})])));
            var _Iter0 = _Iterable(landmarks);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                l = _Iter0[_Index0];
                items.push(_interpolate_kwargs.call(this, create_item, [l.title].concat([_desugar_kwargs({action: onclick.bind(null, l.dest, l.frag)})])));
            }
            build_list(ans, items);
            return ans;
        };
        if (!create_goto_list.__argnames__) Object.defineProperties(create_goto_list, {
            __argnames__ : {value: ["onclick", "current_position_data"]},
            __module__ : {value: "read_book.goto"}
        });

        function get_next_section(forward) {
            var toc, id_map, _unpack, before, after;
            toc = current_book().manifest.toc;
            id_map = get_toc_maps(toc)[1];
            _unpack = get_border_nodes(toc, id_map);
_unpack = _unpack_asarray(2, _unpack);
            before = _unpack[0];
            after = _unpack[1];
            return (forward) ? after : before;
        };
        if (!get_next_section.__argnames__) Object.defineProperties(get_next_section, {
            __argnames__ : {value: ["forward"]},
            __module__ : {value: "read_book.goto"}
        });

        function create_goto_panel(current_position_data, book, container, onclick) {
            var panel;
            panel = create_goto_list(onclick, current_position_data);
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({display: "flex", flex_direction: "column"})]));
            _interpolate_kwargs.call(this, set_css, [panel].concat([_desugar_kwargs({flex_grow: "10"})]));
            container.appendChild(panel);
        };
        if (!create_goto_panel.__argnames__) Object.defineProperties(create_goto_panel, {
            __argnames__ : {value: ["current_position_data", "book", "container", "onclick"]},
            __module__ : {value: "read_book.goto"}
        });

        function create_location_overlay(current_position_data, book, overlay, container) {
            var container_id, current_cfi, calibre_book_url;
            container_id = ensure_id(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 0 1rem"})]));
            container = container.lastChild;
            current_cfi = current_position_data.cfi;
            calibre_book_url = (typeof book !== "undefined" && book !== null ? book : Object.create(null)).calibre_book_url;
            function copy_button(text_to_copy) {
                return _interpolate_kwargs.call(this, create_button, [_("Copy")].concat([_desugar_kwargs({action: (function() {
                    var _anonfunc = function () {
                        var src, orig;
                        src = document.querySelector("#" + _str.format("{}", container_id) + " input");
                        orig = src.value;
                        src.value = text_to_copy;
                        src.focus();
                        src.select();
                        try {
                            document.execCommand("copy");
                        } finally {
                            src.value = orig;
                        }
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.goto"}
                    });
                    return _anonfunc;
                })()})]));
            };
            if (!copy_button.__argnames__) Object.defineProperties(copy_button, {
                __argnames__ : {value: ["text_to_copy"]},
                __module__ : {value: "read_book.goto"}
            });

            function display_and_copy(label, text) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [label, " ", _interpolate_kwargs.call(E, E.span, [text].concat([_desugar_kwargs({style: "font-size: smaller; font-family: monospace"})]))].concat([_desugar_kwargs({style: "flex-grow: 10; text-overflow: ellipsis; margin-bottom: 1ex"})])), copy_button(text)].concat([_desugar_kwargs({style: "margin: 1rem; margin-bottom: calc(1rem - 1ex); display: flex; align-items: baseline; flex-wrap: wrap"})])));
            };
            if (!display_and_copy.__argnames__) Object.defineProperties(display_and_copy, {
                __argnames__ : {value: ["label", "text"]},
                __module__ : {value: "read_book.goto"}
            });

            if (current_cfi) {
                display_and_copy(_("Current location:"), current_cfi);
            }
            function goto_cfi(cfi) {
                if (ui_operations.goto_cfi(cfi)) {
                    overlay.hide();
                } else {
                    error_dialog(_("No such location"), _("No location {} found").format(cfi));
                }
            };
            if (!goto_cfi.__argnames__) Object.defineProperties(goto_cfi, {
                __argnames__ : {value: ["cfi"]},
                __module__ : {value: "read_book.goto"}
            });

            function goto_ref(ref) {
                ref = ref.replace(/,/g, ".");
                if (ui_operations.goto_reference(ref)) {
                    overlay.hide();
                } else {
                    error_dialog(_("No such reference"), _("No reference {} found").format(ref));
                }
            };
            if (!goto_ref.__argnames__) Object.defineProperties(goto_ref, {
                __argnames__ : {value: ["ref"]},
                __module__ : {value: "read_book.goto"}
            });

            if (current_position_data.book_length > 0) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Current position: {}").format(format_pos(current_position_data.progress_frac, current_position_data.book_length))].concat([_desugar_kwargs({style: "margin: 1rem"})])));
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Type the position, location or reference below. For a reference type ref: followed by the reference:")].concat([_desugar_kwargs({style: "margin: 1rem"})])));
            function goto_pos() {
                var src;
                src = document.querySelector("#" + _str.format("{}", container_id) + " [name=newpos]").value;
                if (!src) {
                    return;
                }
                if (src.indexOf("epubcfi(") === 0) {
                    return goto_cfi(src);
                }
                if (src.indexOf("ref:") === 0) {
                    return goto_ref(src.slice(len("ref:")));
                }
                var _try_else_1 = false;
                try {
                    ui_operations.goto_book_position(float(src));
                    _try_else_1 = true;
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        error_dialog(_("Not a valid book position"), _("{} is not a valid book position").format(src), traceback.format_exc());
                    } 
                }
                if (_try_else_1) {
                    overlay.hide();
                }
            };
            if (!goto_pos.__module__) Object.defineProperties(goto_pos, {
                __module__ : {value: "read_book.goto"}
            });

            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.label, [_("Go to:")].concat([_desugar_kwargs({style: "margin-right: 1rem"})])), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "newpos", type: "text", min: "0", max: str(current_position_data.book_length), step: "0.1", style: "flex-grow: 10; margin-right: 1rem", onkeydown: (function() {
                var _anonfunc = function (ev) {
                    if (ev.key === "Enter") {
                        goto_pos();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.goto"}
                });
                return _anonfunc;
            })()})]), E.span(" "), _interpolate_kwargs.call(this, create_button, [_("Go")].concat([_desugar_kwargs({action: goto_pos})]))].concat([_desugar_kwargs({style: "display: flex; align-items: baseline; flex-wrap: wrap"})]))].concat([_desugar_kwargs({style: "margin: 1rem;"})])));
            if (calibre_book_url) {
                if (current_cfi) {
                    calibre_book_url += "?open_at=" + encode_query_component(current_cfi);
                }
                display_and_copy(_("URL for this position:"), calibre_book_url);
            } else if (!runtime.is_standalone_viewer) {
                display_and_copy(_("URL for this position:"), window.top.location.toString());
            }
            window.setTimeout((function() {
                var _anonfunc = function () {
                    var container;
                    container = document.getElementById(container_id);
                    if (container) {
                        container.querySelector("[name=newpos]").focus();
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.goto"}
                });
                return _anonfunc;
            })(), 10);
        };
        if (!create_location_overlay.__argnames__) Object.defineProperties(create_location_overlay, {
            __argnames__ : {value: ["current_position_data", "book", "overlay", "container"]},
            __module__ : {value: "read_book.goto"}
        });

        _modules["read_book.goto"].create_goto_list = create_goto_list;
        _modules["read_book.goto"].get_next_section = get_next_section;
        _modules["read_book.goto"].create_goto_panel = create_goto_panel;
        _modules["read_book.goto"].create_location_overlay = create_location_overlay;
    })();

    (function(){
        var __name__ = "read_book.open_book";
        var current_container_id, current_opened_book_path;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_item = _modules["book_list.item_list"].create_item;
        var create_item_list = _modules["book_list.item_list"].create_item_list;

        var clear = _modules.dom.clear;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button = _modules.widgets.create_button;

        current_container_id = null;
        current_opened_book_path = null;
        function create_open_book(container, book) {
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 1rem", id: unique_id()})]));
            container = container.lastChild;
            current_container_id = container.id;
            current_opened_book_path = null;
            if (book) {
                current_opened_book_path = book.manifest.pathtoebook;
            }
            rebuild_open_list(container);
        };
        if (!create_open_book.__argnames__) Object.defineProperties(create_open_book, {
            __argnames__ : {value: ["container", "book"]},
            __module__ : {value: "read_book.open_book"}
        });

        function rebuild_open_list(container) {
            var sd, rl, c, items, fname, entry;
            clear(container);
            container.appendChild(_interpolate_kwargs.call(this, create_button, [_("Open a book from your computer")].concat([_desugar_kwargs({action: ui_operations.ask_for_open.bind(null, null)})])));
            sd = get_session_data();
            rl = sd.get("standalone_recently_opened");
            if ((typeof rl !== "undefined" && rl !== null ? rl : Object.create(null)).length) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: unique_id()})]));
                c = container.lastChild;
                items = _list_decorate([]);
                c.appendChild(_interpolate_kwargs.call(E, E.h2, [_("Recently viewed books")].concat([_desugar_kwargs({style: "margin-top: 1rem"})])));
                c.appendChild(E.div());
                var _Iter0 = _Iterable(rl);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    entry = _Iter0[_Index0];
                    if (current_opened_book_path && current_opened_book_path === entry.pathtoebook) {
                        continue;
                    }
                    if (typeof entry.pathtoebook !== "string") {
                        continue;
                    }
                    fname = entry.pathtoebook.replace(/\\/g, "/");
                    if (_in("/", fname)) {
                        fname = (_expr_temp = fname.rpartition("/"))[_expr_temp.length-1];
                    }
                    items.push(create_item(entry.title || _("Unknown"), ui_operations.ask_for_open.bind(null, entry.pathtoebook), fname));
                }
                create_item_list(c.lastChild, items);
                c.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 1rem"})]));
                c.lastChild.appendChild(_interpolate_kwargs.call(this, create_button, [_("Clear recent list")].concat([_desugar_kwargs({action: clear_recent_list.bind(null, c.id)})])));
            }
        };
        if (!rebuild_open_list.__argnames__) Object.defineProperties(rebuild_open_list, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.open_book"}
        });

        function clear_recent_list(container_id) {
            var sd;
            sd = get_session_data();
            sd.set("standalone_recently_opened", []);
            document.getElementById(container_id).style.display = "none";
        };
        if (!clear_recent_list.__argnames__) Object.defineProperties(clear_recent_list, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "read_book.open_book"}
        });

        function add_book_to_recently_viewed(book) {
            var sd, rl, key, new_entry, ans, entry;
            sd = get_session_data();
            rl = sd.get("standalone_recently_opened");
            key = book.manifest.pathtoebook;
            new_entry = (function(){
                var _d = Object.create(null);
                _d["key"] = key;
                _d["pathtoebook"] = book.manifest.pathtoebook;
                _d["title"] = book.metadata.title;
                _d["authors"] = book.metadata.authors;
                _d["timestamp"] = (new Date).toISOString();
                return _d;
            }).call(this);
            ans = [];
            ans.push(new_entry);
            var _Iter1 = _Iterable(rl);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                entry = _Iter1[_Index1];
                if (entry.key !== key) {
                    ans.push(entry);
                }
            }
            sd.set("standalone_recently_opened", ans.slice(0, 25));
            return ans;
        };
        if (!add_book_to_recently_viewed.__argnames__) Object.defineProperties(add_book_to_recently_viewed, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.open_book"}
        });

        function remove_recently_opened(path) {
            var sd, rl, newl, entry, container;
            sd = get_session_data();
            rl = sd.get("standalone_recently_opened");
            newl = [];
            if (path) {
                var _Iter2 = _Iterable(rl);
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    entry = _Iter2[_Index2];
                    if (entry.key !== path) {
                        newl.push(entry);
                    }
                }
            }
            sd.set("standalone_recently_opened", newl);
            if (current_container_id) {
                container = document.getElementById(current_container_id);
                if (container) {
                    rebuild_open_list(container);
                }
            }
        };
        if (!remove_recently_opened.__argnames__) Object.defineProperties(remove_recently_opened, {
            __argnames__ : {value: ["path"]},
            __module__ : {value: "read_book.open_book"}
        });

        _modules["read_book.open_book"].current_container_id = current_container_id;
        _modules["read_book.open_book"].current_opened_book_path = current_opened_book_path;
        _modules["read_book.open_book"].create_open_book = create_open_book;
        _modules["read_book.open_book"].rebuild_open_list = rebuild_open_list;
        _modules["read_book.open_book"].clear_recent_list = clear_recent_list;
        _modules["read_book.open_book"].add_book_to_recently_viewed = add_book_to_recently_viewed;
        _modules["read_book.open_book"].remove_recently_opened = remove_recently_opened;
    })();

    (function(){
        var __name__ = "file_uploads";
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ensure_id = _modules.dom.ensure_id;

        var human_readable = _modules.utils.human_readable;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        function upload_files_widget() {
            var container = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var proceed = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var msg = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
            var single_file = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? upload_files_widget.__defaults__.single_file : arguments[3];
            var accept_extensions = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? upload_files_widget.__defaults__.accept_extensions : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "single_file")){
                single_file = _kwargs_obj.single_file;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "accept_extensions")){
                accept_extensions = _kwargs_obj.accept_extensions;
            }
            var container_id, c, a;
            container_id = ensure_id(container, "upload-files");
            function files_selected() {
                var files, container;
                files = this.files;
                container = document.getElementById(container_id);
                container.removeChild(container.lastChild);
                if (callable(proceed) && files.length) {
                    proceed(container_id, files);
                }
            };
            if (!files_selected.__module__) Object.defineProperties(files_selected, {
                __module__ : {value: "file_uploads"}
            });

            msg = msg || _("Upload books by either <a>selecting the book files</a> or drag and drop the files here");
            c = E.div(E.span(), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "file", style: "display:none", onchange: files_selected})]));
            if (!single_file) {
                c.lastChild.setAttribute("multiple", "multiple");
            }
            if (accept_extensions) {
                c.lastChild.setAttribute("accept", ", ".join((function() {
                    var _Iter = _Iterable(accept_extensions.split(" ")), _Result = [], x;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        x = _Iter[_Index];
                        _Result.push("." + x);
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })()));
            }
            c.style.minHeight = "80vh";
            c.style.padding = "1rem";
            c.style.borderBottom = "solid 1px currentColor";
            safe_set_inner_html(c.firstChild, msg);
            a = c.getElementsByTagName("a")[0];
            a.setAttribute("href", "javascript: void(0)");
            a.classList.add("blue-link");
            a.addEventListener("click", (function() {
                var _anonfunc = function () {
                    document.getElementById(container_id).querySelector("input[type=file]").click();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "file_uploads"}
                });
                return _anonfunc;
            })(), false);
            container.appendChild(c);
            function stop(e) {
                [e.stopPropagation(), e.preventDefault()];
            };
            if (!stop.__argnames__) Object.defineProperties(stop, {
                __argnames__ : {value: ["e"]},
                __module__ : {value: "file_uploads"}
            });

            function drop(e) {
                var dt;
                stop(e);
                dt = e.dataTransfer;
                files_selected.call(dt);
            };
            if (!drop.__argnames__) Object.defineProperties(drop, {
                __argnames__ : {value: ["e"]},
                __module__ : {value: "file_uploads"}
            });

            c.addEventListener("dragenter", stop, false);
            c.addEventListener("dragover", stop, false);
            c.addEventListener("drop", drop, false);
            return c;
        };
        if (!upload_files_widget.__defaults__) Object.defineProperties(upload_files_widget, {
            __defaults__ : {value: {single_file:false, accept_extensions:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["container", "proceed", "msg", "single_file", "accept_extensions"]},
            __module__ : {value: "file_uploads"}
        });

        function update_status_widget(w, sent, total) {
            var p;
            if (total) {
                p = w.getElementsByTagName("progress")[0];
                p.setAttribute("value", "" + sent);
                p.setAttribute("max", "" + total);
                w.lastChild.textContent = (_expr_temp = _(" {percent:.0%} of {total}"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({percent: sent / total, total: human_readable(total)})]));
            }
        };
        if (!update_status_widget.__argnames__) Object.defineProperties(update_status_widget, {
            __argnames__ : {value: ["w", "sent", "total"]},
            __module__ : {value: "file_uploads"}
        });

        function upload_status_widget(name, job_id) {
            var ans;
            ans = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "padding: 1rem 1ex;", data_job: "" + job_id})]);
            if (name) {
                ans.appendChild(E.h3(E.b(name)));
            }
            ans.appendChild(E.progress());
            ans.appendChild(E.span());
            return ans;
        };
        if (!upload_status_widget.__argnames__) Object.defineProperties(upload_status_widget, {
            __argnames__ : {value: ["name", "job_id"]},
            __module__ : {value: "file_uploads"}
        });

        _modules.file_uploads.upload_files_widget = upload_files_widget;
        _modules.file_uploads.update_status_widget = update_status_widget;
        _modules.file_uploads.upload_status_widget = upload_status_widget;
    })();

    (function(){
        var __name__ = "book_list.add";
        var state;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ajax_send_file = _modules.ajax.ajax_send_file;

        var force_refresh_on_next_load = _modules["book_list.library_data"].force_refresh_on_next_load;
        var loaded_books_query = _modules["book_list.library_data"].loaded_books_query;

        var back = _modules["book_list.router"].back;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var query_as_href = _modules["book_list.ui"].query_as_href;
        var show_panel = _modules["book_list.ui"].show_panel;

        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;

        var update_status_widget = _modules.file_uploads.update_status_widget;
        var upload_files_widget = _modules.file_uploads.upload_files_widget;
        var upload_status_widget = _modules.file_uploads.upload_status_widget;

        var get_interface_data = _modules.session.get_interface_data;

        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;
        var enable_escape_key = _modules.widgets.enable_escape_key;

        state = (function(){
            var _d = Object.create(null);
            _d["in_progress"] = false;
            _d["container_id"] = null;
            _d["counter"] = 0;
            _d["number"] = 0;
            _d["fake_send"] = false;
            _d["transfers"] = [];
            return _d;
        }).call(this);
        function cancel_in_progress() {
            var xhr;
            var _Iter0 = _Iterable(state.transfers);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                xhr = _Iter0[_Index0];
                xhr.abort();
            }
            state.transfers = [];
            state.in_progress = false;
        };
        if (!cancel_in_progress.__module__) Object.defineProperties(cancel_in_progress, {
            __module__ : {value: "book_list.add"}
        });

        function on_close() {
            cancel_in_progress();
            back();
        };
        if (!on_close.__module__) Object.defineProperties(on_close, {
            __module__ : {value: "book_list.add"}
        });

        function get_job_container(container_id, job_id) {
            var container;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            return container.querySelector("[data-job=\"" + _str.format("{}", job_id) + "\"]");
        };
        if (!get_job_container.__argnames__) Object.defineProperties(get_job_container, {
            __argnames__ : {value: ["container_id", "job_id"]},
            __module__ : {value: "book_list.add"}
        });

        function on_progress(container_id, job_id, loaded, total, xhr) {
            var container;
            container = get_job_container(container_id, job_id);
            if (container === null) {
                return;
            }
            if (total) {
                update_status_widget(container, loaded, total);
            }
        };
        if (!on_progress.__argnames__) Object.defineProperties(on_progress, {
            __argnames__ : {value: ["container_id", "job_id", "loaded", "total", "xhr"]},
            __module__ : {value: "book_list.add"}
        });

        function list_added_book(container, data) {
            var q, a;
            container.appendChild(E.h3(E.b(data.title), E.span(" " + _("by") + " "), E.i(" & ".join(data.authors))));
            container.appendChild(E.span(_("Added successfully") + " "));
            q = (function(){
                var _d = Object.create(null);
                _d["book_id"] = data.book_id + "";
                return _d;
            }).call(this);
            a = _interpolate_kwargs.call(this, create_button, [_("Open")].concat([_desugar_kwargs({action: query_as_href(q, "book_details")})]));
            if (state.number > 1) {
                a.setAttribute("target", "_blank");
            } else {
                a.addEventListener("click", (function() {
                    var _anonfunc = function (e) {
                        e.preventDefault();
                        show_panel("book_details", (function(){
                            var _d = Object.create(null);
                            _d["book_id"] = data.book_id + "";
                            return _d;
                        }).call(this), true);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["e"]},
                        __module__ : {value: "book_list.add"}
                    });
                    return _anonfunc;
                })());
            }
            container.appendChild(a);
        };
        if (!list_added_book.__argnames__) Object.defineProperties(list_added_book, {
            __argnames__ : {value: ["container", "data"]},
            __module__ : {value: "book_list.add"}
        });

        function list_duplicate_book(container, container_id, job_id, data, file) {
            var b;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("A book with the title \"{0}\" already exists in the library.").format(data.title)].concat([_desugar_kwargs({style: "padding: 1rem 1ex"})])));
            b = _interpolate_kwargs.call(this, create_button, [_("Add anyway")].concat([_desugar_kwargs({action: (function() {
                var _anonfunc = function () {
                    var c, w;
                    c = get_job_container(container_id, job_id);
                    clear(c);
                    w = upload_status_widget(file.name, job_id);
                    c.appendChild(w);
                    send_file(file, container_id, job_id, true);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.add"}
                });
                return _anonfunc;
            })()})]));
            function list_duplicates() {
                var ans, item;
                ans = _interpolate_kwargs.call(E, E.ol, [_desugar_kwargs({style: "margin-left: 2rem"})]);
                var _Iter1 = _Iterable(data.duplicates);
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    item = _Iter1[_Index1];
                    ans.appendChild(E.li(_("{0} by {1}").format(item.title, " & ".join(item.authors))));
                }
                return ans;
            };
            if (!list_duplicates.__module__) Object.defineProperties(list_duplicates, {
                __module__ : {value: "book_list.add"}
            });

            container.appendChild(b);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("The book you are trying to add is:"), E.span(" ", E.b(data.title), " ", _("by"), " ", E.i(" & ".join(data.authors))), _(". Books already in the library with that title are:"), _interpolate_kwargs.call(E, E.div, [list_duplicates()].concat([_desugar_kwargs({style: "padding-top:1ex"})]))].concat([_desugar_kwargs({style: "margin: 1rem 1ex; border-top: solid 1px currentColor; padding-top: 1ex"})])));
        };
        if (!list_duplicate_book.__argnames__) Object.defineProperties(list_duplicate_book, {
            __argnames__ : {value: ["container", "container_id", "job_id", "data", "file"]},
            __module__ : {value: "book_list.add"}
        });

        function write_access_error(msg, xhr) {
            var html, un;
            html = msg + "<br>";
            if (xhr.status === 403) {
                un = get_interface_data().username;
                if (un) {
                    html += _("You are not allowed to make changes to the library") + "<hr>";
                } else {
                    html += _("You must be logged in to make changes to the library") + "<hr>";
                }
            }
            return html + "<br>" + xhr.error_html;
        };
        if (!write_access_error.__argnames__) Object.defineProperties(write_access_error, {
            __argnames__ : {value: ["msg", "xhr"]},
            __module__ : {value: "book_list.add"}
        });

        function on_complete(container_id, job_id, end_type, xhr, ev) {
            var idx, container, data, html;
            idx = state.transfers.indexOf(xhr);
            if (idx > -1) {
                state.transfers.splice(idx, 1);
            }
            container = get_job_container(container_id, job_id);
            if (container === null) {
                return;
            }
            clear(container);
            if (end_type === "load") {
                data = JSON.parse(xhr.responseText);
                if (data.book_id) {
                    list_added_book(container, data);
                    force_refresh_on_next_load();
                } else {
                    list_duplicate_book(container, container_id, job_id, data, this);
                }
            } else if (end_type === "abort") {
                return;
            } else {
                html = write_access_error(_("Failed to upload the file: {}").format(this.name), xhr);
                safe_set_inner_html(container, html);
            }
        };
        if (!on_complete.__argnames__) Object.defineProperties(on_complete, {
            __argnames__ : {value: ["container_id", "job_id", "end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.add"}
        });

        function fake_send(container_id, job_id) {
            var container, prev;
            container = get_job_container(container_id, job_id);
            prev = parseInt(container.dataset.fake || "0");
            container.dataset.fake = prev + 10;
            update_status_widget(container, container.dataset.fake, 100);
            if (parseInt(container.dataset.fake || "0") < 100) {
                setTimeout(fake_send.bind(null, container_id, job_id), 1e3);
            }
        };
        if (!fake_send.__argnames__) Object.defineProperties(fake_send, {
            __argnames__ : {value: ["container_id", "job_id"]},
            __module__ : {value: "book_list.add"}
        });

        function send_file(file, container_id, job_id, add_duplicates) {
            var lid, ad, xhr;
            lid = loaded_books_query().library_id;
            ad = (add_duplicates) ? "y" : "n";
            xhr = ajax_send_file("cdb/add-book/" + _str.format("{}", job_id) + "/" + _str.format("{}", ad) + "/" + _str.format("{}", encodeURIComponent(file.name)) + "/" + _str.format("{}", lid) + "", file, on_complete.bind(file, container_id, job_id), on_progress.bind(null, container_id, job_id));
            state.transfers.push(xhr);
            return xhr;
        };
        if (!send_file.__argnames__) Object.defineProperties(send_file, {
            __argnames__ : {value: ["file", "container_id", "job_id", "add_duplicates"]},
            __module__ : {value: "book_list.add"}
        });

        function files_chosen(container_id, files) {
            var container, job_id, w, file;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            state.number = 0;
            var _Iter2 = _Iterable(files);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                file = _Iter2[_Index2];
                state.counter += 1;
                state.number += 1;
                job_id = state.counter;
                w = upload_status_widget(file.name, job_id);
                container.appendChild(w);
                w.style.borderBottom = "solid 1px currentColor";
                if (state.fake_send) {
                    setTimeout(fake_send.bind(null, container_id, job_id), 100);
                } else {
                    send_file(file, container_id, job_id);
                }
            }
        };
        if (!files_chosen.__argnames__) Object.defineProperties(files_chosen, {
            __argnames__ : {value: ["container_id", "files"]},
            __module__ : {value: "book_list.add"}
        });

        function add_books_panel(container_id) {
            var container;
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Add books"), action: on_close, icon: "close"})]));
            cancel_in_progress();
            state.in_progress = true;
            state.container_id = container_id;
            state.fake_send = false;
            enable_escape_key(container, on_close);
            return upload_files_widget(container, files_chosen);
        };
        if (!add_books_panel.__argnames__) Object.defineProperties(add_books_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.add"}
        });

        function develop(container) {
            add_books_panel(ensure_id(container));
        };
        if (!develop.__argnames__) Object.defineProperties(develop, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.add"}
        });

        _modules["book_list.add"].state = state;
        _modules["book_list.add"].cancel_in_progress = cancel_in_progress;
        _modules["book_list.add"].on_close = on_close;
        _modules["book_list.add"].get_job_container = get_job_container;
        _modules["book_list.add"].on_progress = on_progress;
        _modules["book_list.add"].list_added_book = list_added_book;
        _modules["book_list.add"].list_duplicate_book = list_duplicate_book;
        _modules["book_list.add"].write_access_error = write_access_error;
        _modules["book_list.add"].on_complete = on_complete;
        _modules["book_list.add"].fake_send = fake_send;
        _modules["book_list.add"].send_file = send_file;
        _modules["book_list.add"].files_chosen = files_chosen;
        _modules["book_list.add"].add_books_panel = add_books_panel;
        _modules["book_list.add"].develop = develop;
    })();

    (function(){
        var __name__ = "book_list.delete_book";
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ajax = _modules.ajax.ajax;

        var write_access_error = _modules["book_list.add"].write_access_error;

        var book_after = _modules["book_list.library_data"].book_after;
        var force_refresh_on_next_load = _modules["book_list.library_data"].force_refresh_on_next_load;
        var remove_book = _modules["book_list.library_data"].remove_book;

        var back = _modules["book_list.router"].back;

        var show_panel = _modules["book_list.ui"].show_panel;

        var clear = _modules.dom.clear;

        var create_custom_dialog = _modules.modals.create_custom_dialog;

        var get_db = _modules["read_book.db"].get_db;

        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;

        function delete_from_cache(library_id, book_id, title) {
            var db;
            db = get_db();
            db.delete_books_matching(library_id, book_id);
        };
        if (!delete_from_cache.__argnames__) Object.defineProperties(delete_from_cache, {
            __argnames__ : {value: ["library_id", "book_id", "title"]},
            __module__ : {value: "book_list.delete_book"}
        });

        function refresh_after_delete(book_id, library_id) {
            var next_book_id;
            force_refresh_on_next_load();
            next_book_id = book_after(book_id);
            remove_book(book_id);
            if (next_book_id) {
                show_panel("book_details", (function(){
                    var _d = Object.create(null);
                    _d["book_id"] = str(next_book_id);
                    _d["library_id"] = library_id;
                    return _d;
                }).call(this), true);
            } else {
                back();
            }
        };
        if (!refresh_after_delete.__argnames__) Object.defineProperties(refresh_after_delete, {
            __argnames__ : {value: ["book_id", "library_id"]},
            __module__ : {value: "book_list.delete_book"}
        });

        function do_delete_from_library(parent, close_modal, library_id, book_id, title) {
            parent.appendChild(E.div(_("Deleting {0} from library, please wait...").format(title)));
            function oncomplete(end_type, xhr, ev) {
                var msg;
                if (end_type === "load" || end_type === "abort") {
                    close_modal();
                    if (end_type === "load") {
                        refresh_after_delete(book_id, library_id);
                    }
                    return;
                }
                clear(parent);
                msg = E.div();
                safe_set_inner_html(msg, write_access_error(_("Failed to delete {0}, with error:").format(title), xhr));
                parent.appendChild(E.div(msg, _interpolate_kwargs.call(E, E.div, [create_button(_("Close"), null, close_modal, true)].concat([_desugar_kwargs({class_: "button-box"})]))));
            };
            if (!oncomplete.__argnames__) Object.defineProperties(oncomplete, {
                __argnames__ : {value: ["end_type", "xhr", "ev"]},
                __module__ : {value: "book_list.delete_book"}
            });

            _interpolate_kwargs.call(this, ajax, ["cdb/delete-books/" + _str.format("{}", book_id) + "/" + _str.format("{}", library_id) + "", oncomplete].concat([_desugar_kwargs({method: "POST"})])).send();
        };
        if (!do_delete_from_library.__argnames__) Object.defineProperties(do_delete_from_library, {
            __argnames__ : {value: ["parent", "close_modal", "library_id", "book_id", "title"]},
            __module__ : {value: "book_list.delete_book"}
        });

        function confirm_delete_from_library(library_id, book_id, title) {
            create_custom_dialog(_("Are you sure?"), (function() {
                var _anonfunc = function (parent, close_modal) {
                    var msg, m;
                    function action(doit) {
                        if (doit) {
                            clear(parent);
                            do_delete_from_library(parent, close_modal, library_id, book_id, title);
                        } else {
                            close_modal();
                        }
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["doit"]},
                        __module__ : {value: "book_list.delete_book"}
                    });

                    msg = _("This will <b>permanently delete</b> <i>{0}</i> from your calibre library. Are you sure?").format(title);
                    m = E.div();
                    safe_set_inner_html(m, msg);
                    parent.appendChild(E.div(m, _interpolate_kwargs.call(E, E.div, [create_button(_("OK"), null, action.bind(null, true)), "", _interpolate_kwargs.call(this, create_button, [_("Cancel"), null, action.bind(null, false)].concat([_desugar_kwargs({highlight: true})]))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.delete_book"}
                });
                return _anonfunc;
            })());
        };
        if (!confirm_delete_from_library.__argnames__) Object.defineProperties(confirm_delete_from_library, {
            __argnames__ : {value: ["library_id", "book_id", "title"]},
            __module__ : {value: "book_list.delete_book"}
        });

        function choose_which_delete(library_id, book_id, title) {
            create_custom_dialog(_("Delete from?"), (function() {
                var _anonfunc = function (parent, close_modal) {
                    function action(from_cache, from_library) {
                        close_modal();
                        if (from_cache) {
                            delete_from_cache(library_id, book_id, title);
                        }
                        if (from_library) {
                            confirm_delete_from_library(library_id, book_id, title);
                        }
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["from_cache", "from_library"]},
                        __module__ : {value: "book_list.delete_book"}
                    });

                    parent.appendChild(E.div(E.div(_("{0} is available both in the browser cache for offline reading and in your calibre library. Where do you want to delete it from?").format(title)), _interpolate_kwargs.call(E, E.div, [create_button(_("Cache"), null, action.bind(null, true, false)), "", create_button(_("Library and cache"), null, action.bind(null, true, true))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.delete_book"}
                });
                return _anonfunc;
            })());
        };
        if (!choose_which_delete.__argnames__) Object.defineProperties(choose_which_delete, {
            __argnames__ : {value: ["library_id", "book_id", "title"]},
            __module__ : {value: "book_list.delete_book"}
        });

        function delete_book_stage2(library_id, book_id, title, has_offline_copies) {
            if (has_offline_copies) {
                choose_which_delete(library_id, book_id, title);
            } else {
                confirm_delete_from_library(library_id, book_id, title);
            }
        };
        if (!delete_book_stage2.__argnames__) Object.defineProperties(delete_book_stage2, {
            __argnames__ : {value: ["library_id", "book_id", "title", "has_offline_copies"]},
            __module__ : {value: "book_list.delete_book"}
        });

        function start_delete_book(library_id, book_id, title) {
            var db;
            book_id = int(book_id);
            db = get_db();
            db.has_book_matching(library_id, book_id, delete_book_stage2.bind(null, library_id, book_id, title));
        };
        if (!start_delete_book.__argnames__) Object.defineProperties(start_delete_book, {
            __argnames__ : {value: ["library_id", "book_id", "title"]},
            __module__ : {value: "book_list.delete_book"}
        });

        _modules["book_list.delete_book"].delete_from_cache = delete_from_cache;
        _modules["book_list.delete_book"].refresh_after_delete = refresh_after_delete;
        _modules["book_list.delete_book"].do_delete_from_library = do_delete_from_library;
        _modules["book_list.delete_book"].confirm_delete_from_library = confirm_delete_from_library;
        _modules["book_list.delete_book"].choose_which_delete = choose_which_delete;
        _modules["book_list.delete_book"].delete_book_stage2 = delete_book_stage2;
        _modules["book_list.delete_book"].start_delete_book = start_delete_book;
    })();

    (function(){
        var __name__ = "book_list.details_list";
        var DETAILS_LIST_CLASS, ITEM_CLASS, THUMBNAIL_MAX_WIDTH, THUMBNAIL_MAX_HEIGHT, BORDER_RADIUS;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var browser_in_dark_mode = _modules["book_list.theme"].browser_in_dark_mode;
        var css_for_variables = _modules["book_list.theme"].css_for_variables;
        var get_color = _modules["book_list.theme"].get_color;

        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;

        var get_interface_data = _modules.session.get_interface_data;

        var fmt_sidx = _modules.utils.fmt_sidx;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var sandboxed_html = _modules.utils.sandboxed_html;

        DETAILS_LIST_CLASS = "book-list-details-list";
        ITEM_CLASS = DETAILS_LIST_CLASS + "-item";
        function description() {
            return _("A list with thumbnails and some book details");
        };
        if (!description.__module__) Object.defineProperties(description, {
            __module__ : {value: "book_list.details_list"}
        });

        THUMBNAIL_MAX_WIDTH = 35 * 3;
        THUMBNAIL_MAX_HEIGHT = 35 * 4;
        BORDER_RADIUS = 6;
        function details_list_css() {
            var ans, sel, s, top, extra_data, narrow_style;
            ans = "";
            sel = "." + DETAILS_LIST_CLASS;
            ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({cursor: "pointer", user_select: "none"})]));
            ans += _interpolate_kwargs.call(this, build_rule, [sel + " > div"].concat([_desugar_kwargs({margin: "1ex 1em", padding_bottom: "1ex", border_bottom: "solid 1px currentColor"})]));
            ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + " ." + _str.format("{}", ITEM_CLASS) + ":hover .details-list-left"].concat([_desugar_kwargs({transform: "scale(1.2)"})]));
            ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + " ." + _str.format("{}", ITEM_CLASS) + ":active .details-list-left"].concat([_desugar_kwargs({transform: "scale(2)"})]));
            s = sel + " .details-list-left";
            ans += _interpolate_kwargs.call(this, build_rule, [s].concat([_desugar_kwargs({margin_right: "1em", min_width: "" + _str.format("{}", THUMBNAIL_MAX_WIDTH) + "px"})]));
            ans += _interpolate_kwargs.call(this, build_rule, [s + " > img"].concat([_desugar_kwargs({border_radius: BORDER_RADIUS + "px", max_height: "" + _str.format("{}", THUMBNAIL_MAX_HEIGHT) + "px", max_width: "" + _str.format("{}", THUMBNAIL_MAX_WIDTH) + "px"})]));
            s = sel + " .details-list-right";
            ans += _interpolate_kwargs.call(this, build_rule, [s].concat([_desugar_kwargs({flex_grow: "10", overflow: "hidden", display: "flex", flex_direction: "column"})]));
            top = s + " > div:first-child";
            extra_data = top + " > div:last-child";
            ans += "" + _str.format("{}", extra_data) + " { text-align: right }";
            narrow_style = "" + _str.format("{}", s) + " iframe { display: none } " + _str.format("{}", top) + " { flex-direction: column } " + _str.format("{}", extra_data) + " { text-align: left; margin-top: 1ex }";
            ans += "@media (max-width: 450px) { " + _str.format("{}", narrow_style) + " }";
            s += " iframe";
            ans += _interpolate_kwargs.call(this, build_rule, [s].concat([_desugar_kwargs({flex_grow: "10", height: "50px", cursor: "pointer", pointer_events: "none"})]));
            return ans;
        };
        if (!details_list_css.__module__) Object.defineProperties(details_list_css, {
            __module__ : {value: "book_list.details_list"}
        });

        function init(container) {
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: DETAILS_LIST_CLASS})]));
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.details_list"}
        });

        function on_img_load(img, load_type) {
            var div;
            div = img.parentNode;
            if (!div) {
                return;
            }
            if (load_type !== "load") {
                clear(div);
                div.appendChild(E.div(_interpolate_kwargs.call(E, E.h2, [img.dataset.title].concat([_desugar_kwargs({style: "text-align:center; font-size:larger; font-weight: bold"})])), _interpolate_kwargs.call(E, E.div, [_("by")].concat([_desugar_kwargs({style: "text-align: center"})])), _interpolate_kwargs.call(E, E.h2, [img.dataset.authors].concat([_desugar_kwargs({style: "text-align:center; font-size:larger; font-weight: bold"})]))));
                _interpolate_kwargs.call(this, set_css, [div].concat([_desugar_kwargs({border: "dashed 1px currentColor", border_radius: BORDER_RADIUS + "px"})]));
            }
        };
        if (!on_img_load.__argnames__) Object.defineProperties(on_img_load, {
            __argnames__ : {value: ["img", "load_type"]},
            __module__ : {value: "book_list.details_list"}
        });

        function sandbox_css() {
            var is_dark_theme;
            is_dark_theme = browser_in_dark_mode();
            if (!sandbox_css.ans || sandbox_css.is_dark_theme !== is_dark_theme) {
                sandbox_css.ans = css_for_variables() + "\n\n";
                sandbox_css.ans += "html {{ overflow: hidden; color: {} }}".format(get_color("window-foreground"));
                sandbox_css.is_dark_theme = is_dark_theme;
            }
            return sandbox_css.ans;
        };
        if (!sandbox_css.__module__) Object.defineProperties(sandbox_css, {
            __module__ : {value: "book_list.details_list"}
        });

        function create_item(book_id, metadata, create_image, show_book_details, href) {
            var authors, img, _unpack, img_div, extra_data, comments, interface_data, stars, i, ival, right, ans;
            authors = (metadata.authors) ? metadata.authors.join(" & ") : _("Unknown");
            img = create_image(book_id, THUMBNAIL_MAX_WIDTH, THUMBNAIL_MAX_HEIGHT, on_img_load);
            img.setAttribute("alt", _("{} by {}").format(metadata.title, authors));
            _unpack = [metadata.title, authors];
            img.dataset.title = _unpack[0];
            img.dataset.authors = _unpack[1];
            img_div = _interpolate_kwargs.call(E, E.div, [img].concat([_desugar_kwargs({class_: "details-list-left"})]));
            extra_data = E.div();
            comments = sandboxed_html(metadata.comments, sandbox_css());
            if (!metadata.comments) {
                comments.style.display = "none";
            }
            comments.style.marginTop = "1ex";
            interface_data = get_interface_data();
            if (metadata.rating) {
                stars = _interpolate_kwargs.call(E, E.span, [_desugar_kwargs({style: "white-space:nowrap"})]);
                var _Iter0 = _Iterable(range(Math.floor(int(metadata.rating) / 2)));
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    i = _Iter0[_Index0];
                    stars.appendChild(svgicon("star"));
                }
                [extra_data.appendChild(stars), extra_data.appendChild(E.br())];
            }
            if (metadata.series) {
                try {
                    ival = float(metadata.series_index);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        ival = 1;
                    } else {
                        throw _Exception;
                    }
                }
                ival = _interpolate_kwargs.call(this, fmt_sidx, [ival].concat([_desugar_kwargs({use_roman: interface_data.use_roman_numerals_for_series_number})]));
                extra_data.appendChild(safe_set_inner_html(E.span(), _("{0} of <i>{1}</i>").format(ival, metadata.series)));
            }
            right = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [E.div(E.b(metadata.title || _("Unknown")), E.br(), authors), extra_data].concat([_desugar_kwargs({style: "display:flex; justify-content: space-between; overflow: hidden"})])), comments].concat([_desugar_kwargs({class_: "details-list-right"})]));
            ans = E.div(_interpolate_kwargs.call(E, E.a, [img_div, right].concat([_desugar_kwargs({href: href, style: "height:" + _str.format("{}", THUMBNAIL_MAX_HEIGHT) + "px; display: flex", class_: ITEM_CLASS})])));
            ans.addEventListener("click", show_book_details, true);
            return ans;
        };
        if (!create_item.__argnames__) Object.defineProperties(create_item, {
            __argnames__ : {value: ["book_id", "metadata", "create_image", "show_book_details", "href"]},
            __module__ : {value: "book_list.details_list"}
        });

        function append_item(container, item) {
            container.lastChild.appendChild(item);
        };
        if (!append_item.__argnames__) Object.defineProperties(append_item, {
            __argnames__ : {value: ["container", "item"]},
            __module__ : {value: "book_list.details_list"}
        });

        _modules["book_list.details_list"].DETAILS_LIST_CLASS = DETAILS_LIST_CLASS;
        _modules["book_list.details_list"].ITEM_CLASS = ITEM_CLASS;
        _modules["book_list.details_list"].THUMBNAIL_MAX_WIDTH = THUMBNAIL_MAX_WIDTH;
        _modules["book_list.details_list"].THUMBNAIL_MAX_HEIGHT = THUMBNAIL_MAX_HEIGHT;
        _modules["book_list.details_list"].BORDER_RADIUS = BORDER_RADIUS;
        _modules["book_list.details_list"].description = description;
        _modules["book_list.details_list"].details_list_css = details_list_css;
        _modules["book_list.details_list"].init = init;
        _modules["book_list.details_list"].on_img_load = on_img_load;
        _modules["book_list.details_list"].sandbox_css = sandbox_css;
        _modules["book_list.details_list"].create_item = create_item;
        _modules["book_list.details_list"].append_item = append_item;
    })();

    (function(){
        var __name__ = "date";
        var UNDEFINED_DATE_ISO, UNDEFINED_DATE, lcdata, supports_locales, fd_function_index;
        UNDEFINED_DATE_ISO = "0101-01-01T00:00:00+00:00";
        UNDEFINED_DATE = new Date(UNDEFINED_DATE_ISO);
        function is_date_undefined(date) {
            var _unpack, dy, uy;
            _unpack = [date.getUTCFullYear(), UNDEFINED_DATE.getUTCFullYear()];
            dy = _unpack[0];
            uy = _unpack[1];
            return dy < uy || dy === uy && date.getUTCMonth() === UNDEFINED_DATE.getUTCMonth() && date.getUTCDate() <= UNDEFINED_DATE.getUTCDate() + 1;
        };
        if (!is_date_undefined.__argnames__) Object.defineProperties(is_date_undefined, {
            __argnames__ : {value: ["date"]},
            __module__ : {value: "date"}
        });

        lcdata = (function(){
            var _d = Object.create(null);
            _d["abday"] = _list_decorate([ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" ]);
            _d["abmon"] = _list_decorate([ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ]);
            _d["day"] = _list_decorate([ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ]);
            _d["mon"] = _list_decorate([ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ]);
            return _d;
        }).call(this);
        supports_locales = false;
        try {
            (new Date).toLocaleString("dfkjghdfkgj");
        } catch (_Exception) {
            _last_exception = _Exception;
            if (_Exception instanceof RangeError) {
                supports_locales = true;
            } else {
            } 
        }
        function fmt_date_pat() {
            var ans;
            ans = fmt_date_pat.ans;
            if (!(typeof ans !== "undefined" && ans !== null)) {
                ans = fmt_date_pat.ans = /(s{1,2})|(m{1,2})|(h{1,2})|(H{1,2})|(zzz)|(z)|(ap)|(AP)|(a)|(A)|(t)|(d{1,4}|M{1,4}|(?:yyyy|yy))/g;
            }
            return ans;
        };
        if (!fmt_date_pat.__module__) Object.defineProperties(fmt_date_pat, {
            __module__ : {value: "date"}
        });

        function fd_format_hour(dt, ampm, hr, as_utc) {
            var h;
            h = (as_utc) ? dt.getUTCHours() : dt.getHours();
            if (ampm) {
                h %= 12;
                if (h === 0) {
                    h = 12;
                }
            }
            return (hr.length === 1) ? h.toString() : str.format("{:02d}", h);
        };
        if (!fd_format_hour.__argnames__) Object.defineProperties(fd_format_hour, {
            __argnames__ : {value: ["dt", "ampm", "hr", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_hour24(dt, ampm, hr, as_utc) {
            return fd_format_hour(dt, false, hr, as_utc);
        };
        if (!fd_format_hour24.__argnames__) Object.defineProperties(fd_format_hour24, {
            __argnames__ : {value: ["dt", "ampm", "hr", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_minute(dt, ampm, min, as_utc) {
            var m;
            m = (as_utc) ? dt.getUTCMinutes() : dt.getMinutes();
            return (min.length === 1) ? m.toString() : str.format("{:02d}", m);
        };
        if (!fd_format_minute.__argnames__) Object.defineProperties(fd_format_minute, {
            __argnames__ : {value: ["dt", "ampm", "min", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_second(dt, ampm, min, as_utc) {
            var s;
            s = (as_utc) ? dt.getUTCSeconds() : dt.getSeconds();
            return (min.length === 1) ? s.toString() : str.format("{:02d}", s);
        };
        if (!fd_format_second.__argnames__) Object.defineProperties(fd_format_second, {
            __argnames__ : {value: ["dt", "ampm", "min", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_ms(dt, ampm, min, as_utc) {
            var s;
            s = (as_utc) ? dt.getUTCMilliseconds() : dt.getSeconds();
            return (min.length === 1) ? s.toString() : str.format("{:03d}", s);
        };
        if (!fd_format_ms.__argnames__) Object.defineProperties(fd_format_ms, {
            __argnames__ : {value: ["dt", "ampm", "min", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_timezone(dt, ampm, t, as_utc) {
            var short, full, idx;
            short = dt.toLocaleTimeString();
            full = dt.toLocaleTimeString([], (function(){
                var _d = Object.create(null);
                _d["timeZoneName"] = "long";
                return _d;
            }).call(this));
            idx = full.indexOf(short);
            if (idx > -1) {
                return full.slice(idx + short.length).strip();
            }
            return window.Intl.DateTimeFormat().resolvedOptions().timeZone;
        };
        if (!fd_format_timezone.__argnames__) Object.defineProperties(fd_format_timezone, {
            __argnames__ : {value: ["dt", "ampm", "t", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_ampm(dt, ampm, ap, as_utc) {
            var h, ans;
            h = (as_utc) ? dt.getUTCHours() : dt.getHours();
            ans = (h < 12) ? "am" : "pm";
            return (ap === "ap" || ap === "a") ? ans : ans.toUpperCase();
        };
        if (!fd_format_ampm.__argnames__) Object.defineProperties(fd_format_ampm, {
            __argnames__ : {value: ["dt", "ampm", "ap", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_day(dt, ampm, dy, as_utc) {
            var d, options, w;
            d = (as_utc) ? dt.getUTCDate() : dt.getDate();
            if (dy.length === 1) {
                return d.toString();
            }
            if (dy.length === 2) {
                return str.format("{:02d}", d);
            }
            if (supports_locales) {
                options = (function(){
                    var _d = Object.create(null);
                    _d["weekday"] = (dy.length === 3) ? "short" : "long";
                    return _d;
                }).call(this);
                if (as_utc) {
                    options["timeZone"] = "UTC";
                }
                return dt.toLocaleString(window.navigator.language, options);
            }
            w = (as_utc) ? dt.getUTCDay() : dt.getDay();
            return (_expr_temp = lcdata[_bound_index((dy.length === 3) ? "abday" : "day", lcdata)])[_bound_index((w + 1) % 7, _expr_temp)];
        };
        if (!fd_format_day.__argnames__) Object.defineProperties(fd_format_day, {
            __argnames__ : {value: ["dt", "ampm", "dy", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_month(dt, ampm, mo, as_utc) {
            var m, options;
            m = (as_utc) ? dt.getUTCMonth() : dt.getMonth();
            if (mo.length === 1) {
                return (m + 1).toString();
            }
            if (mo.length === 2) {
                return str.format("{:02d}", m + 1);
            }
            if (supports_locales) {
                options = (function(){
                    var _d = Object.create(null);
                    _d["month"] = (_expr_temp = (function(){
                        var _d = Object.create(null);
                        _d[1] = "numeric";
                        _d[2] = "2-digit";
                        _d[3] = "short";
                        _d[4] = "long";
                        return _d;
                    }).call(this))[_bound_index(mo.length, _expr_temp)] || "long";
                    return _d;
                }).call(this);
                if (as_utc) {
                    options["timeZone"] = "UTC";
                }
                return dt.toLocaleString(window.navigator.language, options);
            }
            return (_expr_temp = lcdata[_bound_index((mo.length === 3) ? "abmon" : "mon", lcdata)])[(typeof m === "number" && m < 0) ? _expr_temp.length + m : m];
        };
        if (!fd_format_month.__argnames__) Object.defineProperties(fd_format_month, {
            __argnames__ : {value: ["dt", "ampm", "mo", "as_utc"]},
            __module__ : {value: "date"}
        });

        function fd_format_year(dt, ampm, yr, as_utc) {
            var y;
            y = (as_utc) ? dt.getUTCFullYear() : dt.getFullYear();
            if (yr.length === 2) {
                return str.format("{:02d}", y % 100);
            }
            return str.format("{:04d}", y);
        };
        if (!fd_format_year.__argnames__) Object.defineProperties(fd_format_year, {
            __argnames__ : {value: ["dt", "ampm", "yr", "as_utc"]},
            __module__ : {value: "date"}
        });

        fd_function_index = (function(){
            var _d = Object.create(null);
            _d["d"] = fd_format_day;
            _d["M"] = fd_format_month;
            _d["y"] = fd_format_year;
            _d["h"] = fd_format_hour;
            _d["H"] = fd_format_hour24;
            _d["m"] = fd_format_minute;
            _d["s"] = fd_format_second;
            _d["a"] = fd_format_ampm;
            _d["A"] = fd_format_ampm;
            _d["z"] = fd_format_ms;
            _d["t"] = fd_format_timezone;
            return _d;
        }).call(this);
        function am_pm_pat() {
            var ans;
            ans = am_pm_pat.ans;
            if (!(typeof ans !== "undefined" && ans !== null)) {
                ans = am_pm_pat.ans = /(ap)|(a)|(AP)|(A)/;
            }
            return ans;
        };
        if (!am_pm_pat.__module__) Object.defineProperties(am_pm_pat, {
            __module__ : {value: "date"}
        });

        function as_iso(date) {
            var tzo, dif;
            tzo = -date.getTimezoneOffset();
            dif = (tzo >= 0) ? "+" : "-";
            function pad(num) {
                return ((num < 10) ? "0" : "") + num;
            };
            if (!pad.__argnames__) Object.defineProperties(pad, {
                __argnames__ : {value: ["num"]},
                __module__ : {value: "date"}
            });

            return date.getFullYear() + "-" + pad(date.getMonth() + 1) + "-" + pad(date.getDate()) + " " + pad(date.getHours()) + ":" + pad(date.getMinutes()) + ":" + pad(date.getSeconds()) + dif + pad(Math.floor(Math.abs(tzo) / 60)) + ":" + pad(Math.abs(tzo) % 60);
        };
        if (!as_iso.__argnames__) Object.defineProperties(as_iso, {
            __argnames__ : {value: ["date"]},
            __module__ : {value: "date"}
        });

        function format_date() {
            var date = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? format_date.__defaults__.date : arguments[0];
            var fmt = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? format_date.__defaults__.fmt : arguments[1];
            var as_utc = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? format_date.__defaults__.as_utc : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "date")){
                date = _kwargs_obj.date;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "fmt")){
                fmt = _kwargs_obj.fmt;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "as_utc")){
                as_utc = _kwargs_obj.as_utc;
            }
            var ampm;
            fmt = fmt || "dd MMM yyyy";
            ampm = am_pm_pat().test(fmt);
            if (typeof date === "string") {
                date = new Date(date);
            }
            date = date || new Date;
            if (is_date_undefined(date)) {
                return "";
            }
            if (fmt === "iso") {
                return as_iso(date);
            }
            return fmt.replace(fmt_date_pat(), (function() {
                var _anonfunc = function (match) {
                    if (!match) {
                        return "";
                    }
                    try {
                        return fd_function_index[_bound_index(match[0], fd_function_index)](date, ampm, match, as_utc);
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        if (_Exception instanceof Error) {
                            print(str.format("Failed to format date with format: {} and match: {}", fmt, match));
                            return "";
                        } else {
                            throw _Exception;
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["match"]},
                    __module__ : {value: "date"}
                });
                return _anonfunc;
            })());
        };
        if (!format_date.__defaults__) Object.defineProperties(format_date, {
            __defaults__ : {value: {date:null, fmt:"dd MMM yyyy", as_utc:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["date", "fmt", "as_utc"]},
            __module__ : {value: "date"}
        });

        _modules.date.UNDEFINED_DATE_ISO = UNDEFINED_DATE_ISO;
        _modules.date.UNDEFINED_DATE = UNDEFINED_DATE;
        _modules.date.lcdata = lcdata;
        _modules.date.supports_locales = supports_locales;
        _modules.date.fd_function_index = fd_function_index;
        _modules.date.is_date_undefined = is_date_undefined;
        _modules.date.fmt_date_pat = fmt_date_pat;
        _modules.date.fd_format_hour = fd_format_hour;
        _modules.date.fd_format_hour24 = fd_format_hour24;
        _modules.date.fd_format_minute = fd_format_minute;
        _modules.date.fd_format_second = fd_format_second;
        _modules.date.fd_format_ms = fd_format_ms;
        _modules.date.fd_format_timezone = fd_format_timezone;
        _modules.date.fd_format_ampm = fd_format_ampm;
        _modules.date.fd_format_day = fd_format_day;
        _modules.date.fd_format_month = fd_format_month;
        _modules.date.fd_format_year = fd_format_year;
        _modules.date.am_pm_pat = am_pm_pat;
        _modules.date.as_iso = as_iso;
        _modules.date.format_date = format_date;
    })();

    (function(){
        var __name__ = "book_list.custom_list";
        var CUSTOM_LIST_CLASS, ITEM_CLASS;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var sandbox_css = _modules["book_list.details_list"].sandbox_css;
        var BORDER_RADIUS = _modules["book_list.details_list"].BORDER_RADIUS;

        var library_data = _modules["book_list.library_data"].library_data;

        var format_date = _modules.date.format_date;

        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;

        var get_interface_data = _modules.session.get_interface_data;

        var fmt_sidx = _modules.utils.fmt_sidx;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var sandboxed_html = _modules.utils.sandboxed_html;

        CUSTOM_LIST_CLASS = "book-list-custom-list";
        ITEM_CLASS = CUSTOM_LIST_CLASS + "-item";
        function description() {
            return _("A customizable list (see Preferences->Sharing over the net->Book list template)");
        };
        if (!description.__module__) Object.defineProperties(description, {
            __module__ : {value: "book_list.custom_list"}
        });

        function custom_list_css() {
            var ans, sel, s;
            ans = "";
            sel = "." + CUSTOM_LIST_CLASS;
            ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({cursor: "pointer", user_select: "none"})]));
            sel += " ." + ITEM_CLASS;
            ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin: "1ex 1em", padding_bottom: "1ex", border_bottom: "solid 1px currentColor"})]));
            ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + ":hover .custom-list-left"].concat([_desugar_kwargs({transform: "scale(1.2)"})]));
            ans += _interpolate_kwargs.call(this, build_rule, ["" + _str.format("{}", sel) + ":active .custom-list-left"].concat([_desugar_kwargs({transform: "scale(2)"})]));
            s = sel + " .custom-list-left";
            ans += _interpolate_kwargs.call(this, build_rule, [s].concat([_desugar_kwargs({margin_right: "1em"})]));
            ans += _interpolate_kwargs.call(this, build_rule, [s + " > img"].concat([_desugar_kwargs({border_radius: BORDER_RADIUS + "px"})]));
            sel += " iframe";
            ans += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({flex_grow: "10", cursor: "pointer", pointer_events: "none"})]));
            return ans;
        };
        if (!custom_list_css.__module__) Object.defineProperties(custom_list_css, {
            __module__ : {value: "book_list.custom_list"}
        });

        function default_template() {
            if (!default_template.ans) {
                default_template.ans = (function(){
                    var _d = Object.create(null);
                    _d["thumbnail"] = true;
                    _d["thumbnail_height"] = 140;
                    _d["height"] = "auto";
                    _d["comments_fields"] = ['comments'];
                    _d["lines"] = _list_decorate([ _("<b>{title}</b> by {authors}"), _("{series_index} of <i>{series}</i>") + "|||{rating}", "{tags}", _("Date: {timestamp}") + "|||" + _("Published: {pubdate}") + "|||" + _("Publisher: {publisher}"), "" ]);
                    return _d;
                }).call(this);
            }
            return default_template.ans;
        };
        if (!default_template.__module__) Object.defineProperties(default_template, {
            __module__ : {value: "book_list.custom_list"}
        });

        function render_field(field, mi, book_id) {
            var field_metadata, fm, val, interface_data, name, datatype, func, ans, join, fmt;
            if (field === "id") {
                return book_id + "";
            }
            field_metadata = library_data.field_metadata;
            fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
            if (!fm) {
                return;
            }
            val = mi[(typeof field === "number" && field < 0) ? mi.length + field : field];
            if (val === undefined || val === null) {
                return;
            }
            interface_data = get_interface_data();
            function add_val() {
                var val = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
                var is_html = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_val.__defaults__.is_html : arguments[1];
                var join = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_val.__defaults__.join : arguments[2];
                var _kwargs_obj = arguments[arguments.length-1];
                if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "is_html")){
                    is_html = _kwargs_obj.is_html;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "join")){
                    join = _kwargs_obj.join;
                }
                if (is_html && /[<>]/.test(val + "")) {
                    return safe_set_inner_html(E.span(), val);
                }
                if (join) {
                    val = val.join(join);
                } else {
                    val += "";
                }
                return val;
            };
            if (!add_val.__defaults__) Object.defineProperties(add_val, {
                __defaults__ : {value: {is_html:false, join:null}},
                __handles_kwarg_interpolation__ : {value: true},
                __argnames__ : {value: ["val", "is_html", "join"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_composite(field, fm, name, val) {
                var all_vals;
                if (fm.display && fm.display.contains_html) {
                    return _interpolate_kwargs.call(this, add_val, [val].concat([_desugar_kwargs({is_html: true})]));
                }
                if (fm.is_multiple && fm.is_multiple.list_to_ui) {
                    all_vals = filter(null, map(str.strip, val.split(fm.is_multiple.list_to_ui)));
                    return _interpolate_kwargs.call(this, add_val, [all_vals].concat([_desugar_kwargs({join: fm.is_multiple.list_to_ui})]));
                }
                return add_val(val);
            };
            if (!process_composite.__argnames__) Object.defineProperties(process_composite, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_authors(field, fm, name, val) {
                return _interpolate_kwargs.call(this, add_val, [val].concat([_desugar_kwargs({join: " & "})]));
            };
            if (!process_authors.__argnames__) Object.defineProperties(process_authors, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_publisher(field, fm, name, val) {
                return add_val(val);
            };
            if (!process_publisher.__argnames__) Object.defineProperties(process_publisher, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_formats(field, fm, name, val) {
                return _interpolate_kwargs.call(this, add_val, [val].concat([_desugar_kwargs({join: ", "})]));
            };
            if (!process_formats.__argnames__) Object.defineProperties(process_formats, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_rating(field, fm, name, val) {
                var stars, i;
                stars = E.span();
                val = int(val || 0);
                if (val > 0) {
                    for (var _Index0 = 0; _Index0 < Math.floor(val / 2); _Index0++) {
                        i = _Index0;
                        stars.appendChild(svgicon("star"));
                    }
                    if (fm.display.allow_half_stars && val % 2) {
                        stars.appendChild(svgicon("star-half"));
                    }
                    return stars;
                }
            };
            if (!process_rating.__argnames__) Object.defineProperties(process_rating, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_identifiers(field, fm, name, val) {
                var keys, ans, key;
                if (val) {
                    keys = Object.keys(val);
                    if (keys.length) {
                        ans = [];
                        var _Iter1 = _Iterable(keys);
                        for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                            key = _Iter1[_Index1];
                            ans.push(key + ":" + val[(typeof key === "number" && key < 0) ? val.length + key : key]);
                        }
                        return _interpolate_kwargs.call(this, add_val, [ans].concat([_desugar_kwargs({join: ", "})]));
                    }
                }
            };
            if (!process_identifiers.__argnames__) Object.defineProperties(process_identifiers, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_languages(field, fm, name, val) {
                var langs, k;
                if (val && val.length) {
                    langs = (function() {
                        var _Iter = _Iterable(val), _Result = [], k;
                        for (var _Index = 0; _Index < _Iter.length; _Index++) {
                            k = _Iter[_Index];
                            _Result.push((_expr_temp = mi.lang_names)[(typeof k === "number" && k < 0) ? _expr_temp.length + k : k]);
                        }
                        _Result = _list_constructor(_Result);
                        return _Result;
                    })();
                    return _interpolate_kwargs.call(this, add_val, [langs].concat([_desugar_kwargs({join: ", "})]));
                }
            };
            if (!process_languages.__argnames__) Object.defineProperties(process_languages, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_datetime(field, fm, name, val) {
                var fmt;
                if (val) {
                    fmt = interface_data[_bound_index("gui_" + field + "_display_format", interface_data)] || (fm["display"] || Object.create(null)).date_format;
                    return add_val(format_date(val, fmt));
                }
            };
            if (!process_datetime.__argnames__) Object.defineProperties(process_datetime, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_series(field, fm, name, val) {
                if (val) {
                    return add_val(val);
                }
            };
            if (!process_series.__argnames__) Object.defineProperties(process_series, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_series_index(field, fm, name, val) {
                var sval;
                sval = mi[_bound_index(field.slice(0, -6), mi)];
                if (sval) {
                    if (val === null || val === undefined) {
                        val = 1;
                    }
                    return _interpolate_kwargs.call(this, fmt_sidx, [val].concat([_desugar_kwargs({use_roman: interface_data.use_roman_numerals_for_series_number})]));
                }
            };
            if (!process_series_index.__argnames__) Object.defineProperties(process_series_index, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            function process_size(field, fm, name, val) {
                var mb;
                val = val || 0;
                mb = 1024 * 1024;
                function fmt(val, suffix) {
                    var ans;
                    ans = "" + _str.format("{:.1f}", val) + "";
                    if (ans.endsWith(".0")) {
                        ans = ans.slice(0, -2);
                    }
                    return ans + suffix;
                };
                if (!fmt.__argnames__) Object.defineProperties(fmt, {
                    __argnames__ : {value: ["val", "suffix"]},
                    __module__ : {value: "book_list.custom_list"}
                });

                if (val < mb) {
                    return fmt(val / 1024, "KB");
                }
                return fmt(val / mb, "MB");
            };
            if (!process_size.__argnames__) Object.defineProperties(process_size, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.custom_list"}
            });

            name = fm.name || field;
            datatype = fm.datatype;
            if (field === "comments") {
                return;
            }
            if (datatype === "composite") {
                func = process_composite;
            } else if (field === "formats") {
                func = process_formats;
            } else if (datatype === "rating") {
                func = process_rating;
            } else if (field === "identifiers") {
                func = process_identifiers;
            } else if (field === "authors") {
                func = process_authors;
            } else if (field === "publisher") {
                func = process_publisher;
            } else if (field === "languages") {
                func = process_languages;
            } else if (datatype === "datetime") {
                func = process_datetime;
            } else if (datatype === "series") {
                func = process_series;
            } else if (datatype === "comments") {
                if (_exists.d(fm.display).interpret_as === "short-text") {
                    return add_val(val);
                } else {
                    return;
                }
            } else if (field.endswith("_index")) {
                func = process_series_index;
            } else if (field === "size") {
                func = process_size;
            }
            ans = null;
            if (func) {
                ans = func(field, fm, name, val);
            } else {
                if (datatype === "text" || datatype === "enumeration") {
                    if (val !== undefined && val !== null) {
                        join = (fm.is_multiple) ? fm.is_multiple.list_to_ui : null;
                        ans = _interpolate_kwargs.call(this, add_val, [val].concat([_desugar_kwargs({join: join})]));
                    }
                } else if (datatype === "bool") {
                    ans = add_val((val) ? _("Yes") : _("No"));
                } else if (datatype === "int" || datatype === "float") {
                    if (val !== undefined && val !== null) {
                        fmt = (fm.display || Object.create(null)).number_format;
                        if (fmt) {
                            val = fmt.format(val);
                        } else {
                            val += "";
                        }
                        ans = add_val(val);
                    }
                }
            }
            return ans;
        };
        if (!render_field.__argnames__) Object.defineProperties(render_field, {
            __argnames__ : {value: ["field", "mi", "book_id"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function render_part(part, template, book_id, metadata) {
            var count, rendered_count, ans, iterator, replacements, n, rendered, val, field, _unpack, new_child, old_child;
            count = rendered_count = 0;
            ans = E.div();
            ans.innerHTML = part;
            iterator = document.createNodeIterator(ans, NodeFilter.SHOW_TEXT);
            replacements = [];
            while (true) {
                n = iterator.nextNode();
                if (!n) {
                    break;
                }
                rendered = E.span();
                var _Iter2 = _Iterable(n.nodeValue.split(/({#?[_a-z0-9]+})/));
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    field = _Iter2[_Index2];
                    if (field[0] === "{" && field[field.length-1] === "}") {
                        count += 1;
                        val = render_field(field.slice(1, -1), metadata, book_id);
                        if (val) {
                            rendered_count += 1;
                            if (typeof val === "string") {
                                val = document.createTextNode(val);
                            }
                            rendered.appendChild(val);
                        }
                    } else {
                        rendered.appendChild(document.createTextNode(field));
                    }
                }
                replacements.push([rendered, n]);
            }
            var _Iter3 = _Iterable(replacements);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                _unpack = _Iter3[_Index3];
                new_child = _unpack[0];
                old_child = _unpack[1];
                old_child.parentNode.replaceChild(new_child, old_child);
            }
            if (count && !rendered_count) {
                return;
            }
            return ans;
        };
        if (!render_part.__argnames__) Object.defineProperties(render_part, {
            __argnames__ : {value: ["part", "template", "book_id", "metadata"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function render_line(line, template, book_id, metadata) {
            var parts, part, p, ans;
            parts = [];
            line = line || "";
            var _Iter4 = _Iterable(line.split(/\|\|\|/));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                p = _Iter4[_Index4];
                part = render_part(p, template, book_id, metadata);
                if (part) {
                    parts.push(part);
                }
            }
            if (!parts.length) {
                return;
            }
            ans = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "custom-line"})]);
            var _Iter5 = _Iterable(parts);
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                p = _Iter5[_Index5];
                ans.appendChild(p);
            }
            if (parts.length > 1) {
                _interpolate_kwargs.call(this, set_css, [ans].concat([_desugar_kwargs({display: "flex", justify_content: "space-between"})]));
            }
            return ans;
        };
        if (!render_line.__argnames__) Object.defineProperties(render_line, {
            __argnames__ : {value: ["line", "template", "book_id", "metadata"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function render_template_text(template, book_id, metadata) {
            var ans, ldiv, line, html, val, f, comments;
            ans = E.div();
            var _Iter6 = _Iterable(template.lines);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                line = _Iter6[_Index6];
                ldiv = render_line(line, template, book_id, metadata);
                if (ldiv) {
                    ans.appendChild(ldiv);
                }
            }
            if (template.comments_fields.length) {
                html = "";
                var _Iter7 = _Iterable(template.comments_fields);
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    f = _Iter7[_Index7];
                    val = metadata[(typeof f === "number" && f < 0) ? metadata.length + f : f];
                    if (val) {
                        html += "<div style=\"margin-bottom:1.5ex\">" + _str.format("{}", val) + "</div>";
                    }
                }
                if (html) {
                    comments = sandboxed_html(html, sandbox_css());
                    ans.appendChild(comments);
                }
            }
            return ans;
        };
        if (!render_template_text.__argnames__) Object.defineProperties(render_template_text, {
            __argnames__ : {value: ["template", "book_id", "metadata"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function init(container) {
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CUSTOM_LIST_CLASS})]));
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function on_img_load(img, load_type) {
            var div;
            div = img.parentNode;
            if (!div) {
                return;
            }
            if (load_type !== "load") {
                clear(div);
                div.appendChild(E.div(_interpolate_kwargs.call(E, E.h2, [img.dataset.title].concat([_desugar_kwargs({style: "text-align:center; font-size:larger; font-weight: bold"})])), _interpolate_kwargs.call(E, E.div, [_("by")].concat([_desugar_kwargs({style: "text-align: center"})])), _interpolate_kwargs.call(E, E.h2, [img.dataset.authors].concat([_desugar_kwargs({style: "text-align:center; font-size:larger; font-weight: bold"})]))));
                _interpolate_kwargs.call(this, set_css, [div].concat([_desugar_kwargs({border: "dashed 1px currentColor", border_radius: BORDER_RADIUS + "px"})]));
            }
        };
        if (!on_img_load.__argnames__) Object.defineProperties(on_img_load, {
            __argnames__ : {value: ["img", "load_type"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function create_item(book_id, metadata, create_image, show_book_details, href) {
            var template, text_data, height, extra, ans, h, w, img, authors, _unpack, img_div;
            template = get_interface_data().custom_list_template || default_template();
            text_data = render_template_text(template, book_id, metadata);
            text_data.style.flexGrow = "10";
            text_data.style.overflow = "hidden";
            if (template.thumbnail) {
                height = "" + _str.format("{}", template.thumbnail_height) + "px";
            } else {
                if (template.height === "auto") {
                    extra = (template.comments_fields.length) ? 5 : 1;
                    height = template.lines.length * 2.5 + extra + "ex";
                } else {
                    height = template.height;
                    if (typeof height === "number") {
                        height += "px";
                    }
                }
            }
            ans = _interpolate_kwargs.call(E, E.a, [_desugar_kwargs({style: "height:" + _str.format("{}", height) + "; display: flex", class_: ITEM_CLASS, href: href})]);
            if (template.thumbnail) {
                h = template.thumbnail_height;
                w = int(.75 * h);
                img = create_image(book_id, w, h, on_img_load);
                authors = (metadata.authors) ? metadata.authors.join(" & ") : _("Unknown");
                img.setAttribute("alt", _("{} by {}").format(metadata.title, authors));
                _unpack = [metadata.title, authors];
                img.dataset.title = _unpack[0];
                img.dataset.authors = _unpack[1];
                img.style.maxWidth = w + "px";
                img.style.maxHeight = h + "px";
                img_div = _interpolate_kwargs.call(E, E.div, [img].concat([_desugar_kwargs({class_: "custom-list-left", style: "min-width: " + _str.format("{}", w) + "px"})]));
                ans.appendChild(img_div);
            }
            ans.appendChild(text_data);
            ans.addEventListener("click", show_book_details, true);
            return ans;
        };
        if (!create_item.__argnames__) Object.defineProperties(create_item, {
            __argnames__ : {value: ["book_id", "metadata", "create_image", "show_book_details", "href"]},
            __module__ : {value: "book_list.custom_list"}
        });

        function append_item(container, item) {
            container.lastChild.appendChild(item);
        };
        if (!append_item.__argnames__) Object.defineProperties(append_item, {
            __argnames__ : {value: ["container", "item"]},
            __module__ : {value: "book_list.custom_list"}
        });

        _modules["book_list.custom_list"].CUSTOM_LIST_CLASS = CUSTOM_LIST_CLASS;
        _modules["book_list.custom_list"].ITEM_CLASS = ITEM_CLASS;
        _modules["book_list.custom_list"].description = description;
        _modules["book_list.custom_list"].custom_list_css = custom_list_css;
        _modules["book_list.custom_list"].default_template = default_template;
        _modules["book_list.custom_list"].render_field = render_field;
        _modules["book_list.custom_list"].render_part = render_part;
        _modules["book_list.custom_list"].render_line = render_line;
        _modules["book_list.custom_list"].render_template_text = render_template_text;
        _modules["book_list.custom_list"].init = init;
        _modules["book_list.custom_list"].on_img_load = on_img_load;
        _modules["book_list.custom_list"].create_item = create_item;
        _modules["book_list.custom_list"].append_item = append_item;
    })();

    (function(){
        var __name__ = "book_list.prefs";
        var pp_counter, widget_counter, state;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;

        var E = _modules.elementmaker.E;

        var create_button = _modules.widgets.create_button;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var back = _modules["book_list.router"].back;

        pp_counter = 0;
        widget_counter = 0;
        function ConfigItem() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ConfigItem.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperties(ConfigItem.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.widget_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "control": {
                "enumerable": true, 
                "get": function control() {
                    var self = this;
                    return self.container.lastChild;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ConfigItem.prototype.__init__ = function __init__(item_data) {
            var self = this;
            widget_counter += 1;
            self.widget_id = "pref-widget-" + widget_counter;
            self.item_data = item_data;
            self.ignore_ui_value_changed = false;
        };
        if (!ConfigItem.prototype.__init__.__argnames__) Object.defineProperties(ConfigItem.prototype.__init__, {
            __argnames__ : {value: ["item_data"]},
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.__argnames__ = ConfigItem.prototype.__init__.__argnames__;
        ConfigItem.__handles_kwarg_interpolation__ = ConfigItem.prototype.__init__.__handles_kwarg_interpolation__;
        ConfigItem.prototype.initialize = function initialize() {
            var self = this;
            self.ignore_ui_value_changed = true;
            try {
                self.to_ui(self.from_storage());
            } finally {
                self.ignore_ui_value_changed = false;
            }
            return self;
        };
        if (!ConfigItem.prototype.initialize.__module__) Object.defineProperties(ConfigItem.prototype.initialize, {
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.from_storage = function from_storage() {
            var self = this;
            var val;
            val = get_session_data().get(self.item_data.name);
            if (self.item_data.from_storage) {
                val = self.item_data.from_storage(val);
            }
            return val;
        };
        if (!ConfigItem.prototype.from_storage.__module__) Object.defineProperties(ConfigItem.prototype.from_storage, {
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.to_storage = function to_storage(val) {
            var self = this;
            if (self.item_data.to_storage) {
                val = self.item_data.to_storage(val);
            }
            get_session_data().set(self.item_data.name, val);
        };
        if (!ConfigItem.prototype.to_storage.__argnames__) Object.defineProperties(ConfigItem.prototype.to_storage, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.defval = function defval() {
            var self = this;
            var val;
            val = get_session_data().defval(self.item_data.name);
            if (self.item_data.from_storage) {
                val = self.item_data.from_storage(val);
            }
            return val;
        };
        if (!ConfigItem.prototype.defval.__module__) Object.defineProperties(ConfigItem.prototype.defval, {
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.ui_value_changed = function ui_value_changed() {
            var self = this;
            if (self.ignore_ui_value_changed) {
                return;
            }
            self.to_storage(self.from_ui());
        };
        if (!ConfigItem.prototype.ui_value_changed.__module__) Object.defineProperties(ConfigItem.prototype.ui_value_changed, {
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.reset_to_default = function reset_to_default() {
            var self = this;
            self.to_ui(self.defval());
            self.ui_value_changed();
        };
        if (!ConfigItem.prototype.reset_to_default.__module__) Object.defineProperties(ConfigItem.prototype.reset_to_default, {
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.to_ui = function to_ui(val) {
            var self = this;
        };
        if (!ConfigItem.prototype.to_ui.__argnames__) Object.defineProperties(ConfigItem.prototype.to_ui, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.from_ui = function from_ui() {
            var self = this;
        };
        if (!ConfigItem.prototype.from_ui.__module__) Object.defineProperties(ConfigItem.prototype.from_ui, {
            __module__ : {value: "book_list.prefs"}
        });
        ConfigItem.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ConfigItem.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ConfigItem.prototype, "__bases__", {value: []});
        
        

        function Choices() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Choices.prototype.__init__.apply(this, arguments);
        }
        _extends(Choices, ConfigItem);
        Choices.prototype.__init__ = function __init__(item_data, container, onfocus) {
            var self = this;
            var div, select, _unpack, choice, text;
            ConfigItem.prototype.__init__.call(self, item_data);
            div = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [item_data.text + ": "].concat([_desugar_kwargs({style: "white-space:pre"})])), _interpolate_kwargs.call(E, E.select, [_desugar_kwargs({required: "1"})])].concat([_desugar_kwargs({id: self.widget_id})]));
            container.appendChild(div);
            select = div.lastChild;
            var _Iter0 = _Iterable(item_data.choices);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                _unpack = _Iter0[_Index0];
                choice = _unpack[0];
                text = _unpack[1];
                select.appendChild(_interpolate_kwargs.call(E, E.option, [text].concat([_desugar_kwargs({value: choice})])));
            }
            select.addEventListener("change", self.ui_value_changed.bind(self));
            select.addEventListener("focus", onfocus);
            div.addEventListener("click", onfocus);
        };
        if (!Choices.prototype.__init__.__argnames__) Object.defineProperties(Choices.prototype.__init__, {
            __argnames__ : {value: ["item_data", "container", "onfocus"]},
            __module__ : {value: "book_list.prefs"}
        });
        Choices.__argnames__ = Choices.prototype.__init__.__argnames__;
        Choices.__handles_kwarg_interpolation__ = Choices.prototype.__init__.__handles_kwarg_interpolation__;
        Choices.prototype.to_ui = function to_ui(val) {
            var self = this;
            self.control.value = val;
        };
        if (!Choices.prototype.to_ui.__argnames__) Object.defineProperties(Choices.prototype.to_ui, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.prefs"}
        });
        Choices.prototype.from_ui = function from_ui() {
            var self = this;
            return self.control.value;
        };
        if (!Choices.prototype.from_ui.__module__) Object.defineProperties(Choices.prototype.from_ui, {
            __module__ : {value: "book_list.prefs"}
        });
        Choices.prototype.__repr__ = function __repr__ () {
            if(ConfigItem.prototype.__repr__) return ConfigItem.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Choices.prototype.__str__ = function __str__ () {
            if(ConfigItem.prototype.__str__) return ConfigItem.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(Choices.prototype, "__bases__", {value: [ConfigItem]});

        function CheckBox() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            CheckBox.prototype.__init__.apply(this, arguments);
        }
        _extends(CheckBox, ConfigItem);
        Object.defineProperties(CheckBox.prototype,  {
            "control": {
                "enumerable": true, 
                "get": function control() {
                    var self = this;
                    return self.container.firstChild;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        CheckBox.prototype.__init__ = function __init__(item_data, container, onfocus) {
            var self = this;
            var div, control;
            ConfigItem.prototype.__init__.call(self, item_data);
            div = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox"})]), _interpolate_kwargs.call(E, E.span, [" " + item_data.text].concat([_desugar_kwargs({style: "white-space:pre"})]))].concat([_desugar_kwargs({id: self.widget_id})]));
            container.appendChild(div);
            control = div.firstChild;
            control.addEventListener("change", self.ui_value_changed.bind(self));
            control.addEventListener("focus", onfocus);
            div.addEventListener("click", onfocus);
            div.lastChild.addEventListener("click", self.toggle.bind(self));
        };
        if (!CheckBox.prototype.__init__.__argnames__) Object.defineProperties(CheckBox.prototype.__init__, {
            __argnames__ : {value: ["item_data", "container", "onfocus"]},
            __module__ : {value: "book_list.prefs"}
        });
        CheckBox.__argnames__ = CheckBox.prototype.__init__.__argnames__;
        CheckBox.__handles_kwarg_interpolation__ = CheckBox.prototype.__init__.__handles_kwarg_interpolation__;
        CheckBox.prototype.to_ui = function to_ui(val) {
            var self = this;
            self.control.checked = bool(val);
        };
        if (!CheckBox.prototype.to_ui.__argnames__) Object.defineProperties(CheckBox.prototype.to_ui, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.prefs"}
        });
        CheckBox.prototype.from_ui = function from_ui() {
            var self = this;
            return bool(self.control.checked);
        };
        if (!CheckBox.prototype.from_ui.__module__) Object.defineProperties(CheckBox.prototype.from_ui, {
            __module__ : {value: "book_list.prefs"}
        });
        CheckBox.prototype.toggle = function toggle() {
            var self = this;
            self.to_ui(!self.from_ui());
            self.ui_value_changed();
        };
        if (!CheckBox.prototype.toggle.__module__) Object.defineProperties(CheckBox.prototype.toggle, {
            __module__ : {value: "book_list.prefs"}
        });
        CheckBox.prototype.__repr__ = function __repr__ () {
            if(ConfigItem.prototype.__repr__) return ConfigItem.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        CheckBox.prototype.__str__ = function __str__ () {
            if(ConfigItem.prototype.__str__) return ConfigItem.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(CheckBox.prototype, "__bases__", {value: [ConfigItem]});
        

        function SpinBox() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            SpinBox.prototype.__init__.apply(this, arguments);
        }
        _extends(SpinBox, ConfigItem);
        SpinBox.prototype.__init__ = function __init__(item_data, container, onfocus) {
            var self = this;
            var div, control, val, attr;
            ConfigItem.prototype.__init__.call(self, item_data);
            div = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [item_data.text + ": "].concat([_desugar_kwargs({style: "white-space:pre"})])), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", step: "any", min: "1", max: "100"})])].concat([_desugar_kwargs({id: self.widget_id})]));
            container.appendChild(div);
            control = div.lastChild;
            var _Iter1 = _Iterable("min max step".split(" "));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                attr = _Iter1[_Index1];
                val = item_data[(typeof attr === "number" && attr < 0) ? item_data.length + attr : attr];
                if (val !== undefined && val !== null) {
                    control.setAttribute(attr, "" + val);
                }
            }
            control.addEventListener("change", self.ui_value_changed.bind(self));
            control.addEventListener("focus", onfocus);
            div.addEventListener("click", onfocus);
        };
        if (!SpinBox.prototype.__init__.__argnames__) Object.defineProperties(SpinBox.prototype.__init__, {
            __argnames__ : {value: ["item_data", "container", "onfocus"]},
            __module__ : {value: "book_list.prefs"}
        });
        SpinBox.__argnames__ = SpinBox.prototype.__init__.__argnames__;
        SpinBox.__handles_kwarg_interpolation__ = SpinBox.prototype.__init__.__handles_kwarg_interpolation__;
        SpinBox.prototype.to_ui = function to_ui(val) {
            var self = this;
            self.control.value = val;
        };
        if (!SpinBox.prototype.to_ui.__argnames__) Object.defineProperties(SpinBox.prototype.to_ui, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.prefs"}
        });
        SpinBox.prototype.from_ui = function from_ui() {
            var self = this;
            return self.control.value;
        };
        if (!SpinBox.prototype.from_ui.__module__) Object.defineProperties(SpinBox.prototype.from_ui, {
            __module__ : {value: "book_list.prefs"}
        });
        SpinBox.prototype.__repr__ = function __repr__ () {
            if(ConfigItem.prototype.__repr__) return ConfigItem.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        SpinBox.prototype.__str__ = function __str__ () {
            if(ConfigItem.prototype.__str__) return ConfigItem.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(SpinBox.prototype, "__bases__", {value: [ConfigItem]});

        function LineEdit() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            LineEdit.prototype.__init__.apply(this, arguments);
        }
        _extends(LineEdit, ConfigItem);
        LineEdit.prototype.__init__ = function __init__(item_data, container, onfocus) {
            var self = this;
            var div, control;
            ConfigItem.prototype.__init__.call(self, item_data);
            div = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [item_data.text + ": "].concat([_desugar_kwargs({style: "white-space:pre"})])), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text"})])].concat([_desugar_kwargs({id: self.widget_id})]));
            container.appendChild(div);
            control = div.lastChild;
            control.addEventListener("change", self.ui_value_changed.bind(self));
            control.addEventListener("focus", onfocus);
            div.addEventListener("click", onfocus);
        };
        if (!LineEdit.prototype.__init__.__argnames__) Object.defineProperties(LineEdit.prototype.__init__, {
            __argnames__ : {value: ["item_data", "container", "onfocus"]},
            __module__ : {value: "book_list.prefs"}
        });
        LineEdit.__argnames__ = LineEdit.prototype.__init__.__argnames__;
        LineEdit.__handles_kwarg_interpolation__ = LineEdit.prototype.__init__.__handles_kwarg_interpolation__;
        LineEdit.prototype.to_ui = function to_ui(val) {
            var self = this;
            self.control.value = val || "";
        };
        if (!LineEdit.prototype.to_ui.__argnames__) Object.defineProperties(LineEdit.prototype.to_ui, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.prefs"}
        });
        LineEdit.prototype.from_ui = function from_ui() {
            var self = this;
            return self.control.value || "";
        };
        if (!LineEdit.prototype.from_ui.__module__) Object.defineProperties(LineEdit.prototype.from_ui, {
            __module__ : {value: "book_list.prefs"}
        });
        LineEdit.prototype.__repr__ = function __repr__ () {
            if(ConfigItem.prototype.__repr__) return ConfigItem.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        LineEdit.prototype.__str__ = function __str__ () {
            if(ConfigItem.prototype.__str__) return ConfigItem.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(LineEdit.prototype, "__bases__", {value: [ConfigItem]});

        state = Object.create(null);
        function onfocus(name) {
            return (function() {
                var _anonfunc = function (ev) {
                    var c, div;
                    c = document.getElementById(state.container_id);
                    div = c.querySelector("div[data-name=\"{}\"]".format(name));
                    div.lastChild.style.display = "block";
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "book_list.prefs"}
                });
                return _anonfunc;
            })();
        };
        if (!onfocus.__argnames__) Object.defineProperties(onfocus, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.prefs"}
        });

        function create_prefs_widget(container, prefs_data) {
            var div, val, cls, item;
            state = Object.create(null);
            state.container_id = ensure_id(container);
            state.widgets = _list_decorate([]);
            clear(container);
            var _Iter2 = _Iterable(prefs_data);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                item = _Iter2[_Index2];
                div = _interpolate_kwargs.call(E, E.div, [E.div(), _interpolate_kwargs.call(E, E.div, [item.tooltip || ""].concat([_desugar_kwargs({style: "font-size:0.8rem; font-style: italic; margin-top:1ex; display:none"})]))].concat([_desugar_kwargs({style: "margin-bottom:1ex; padding: 1ex 1em; border-bottom: solid 1px currentColor", title: item.tooltip, data_name: item.name})]));
                container.appendChild(div);
                val = get_session_data().get(item.name);
                if (item.from_storage) {
                    val = item.from_storage(val);
                }
                if (item.choices) {
                    cls = Choices;
                } else if (val === true || val === false) {
                    cls = CheckBox;
                } else if (typeof val === "number") {
                    cls = SpinBox;
                } else {
                    cls = LineEdit;
                }
                state.widgets.push(new cls(item, div.firstChild, onfocus(item.name)).initialize());
            }
            if (state.widgets.length) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [create_button(_("Restore default settings"), "refresh", reset_to_defaults)].concat([_desugar_kwargs({style: "margin:1rem;"})])));
            }
        };
        if (!create_prefs_widget.__argnames__) Object.defineProperties(create_prefs_widget, {
            __argnames__ : {value: ["container", "prefs_data"]},
            __module__ : {value: "book_list.prefs"}
        });

        function reset_to_defaults() {
            var w;
            var _Iter3 = _Iterable(state.widgets);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                w = _Iter3[_Index3];
                w.reset_to_default();
            }
        };
        if (!reset_to_defaults.__module__) Object.defineProperties(reset_to_defaults, {
            __module__ : {value: "book_list.prefs"}
        });

        function prefs_panel_handler() {
            var title_func = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var get_prefs_data = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var on_close = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? prefs_panel_handler.__defaults__.on_close : arguments[2];
            var icon = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? prefs_panel_handler.__defaults__.icon : arguments[3];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "on_close")){
                on_close = _kwargs_obj.on_close;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "icon")){
                icon = _kwargs_obj.icon;
            }
            function onkeydown(container_id, close_action, ev) {
                if (ev.key === "Escape") {
                    [ev.preventDefault(), ev.stopPropagation()];
                    close_action();
                }
            };
            if (!onkeydown.__argnames__) Object.defineProperties(onkeydown, {
                __argnames__ : {value: ["container_id", "close_action", "ev"]},
                __module__ : {value: "book_list.prefs"}
            });

            function close_action() {
                if (on_close !== null) {
                    on_close();
                }
                back();
            };
            if (!close_action.__module__) Object.defineProperties(close_action, {
                __module__ : {value: "book_list.prefs"}
            });

            function init_prefs_panel(container_id) {
                var container;
                container = document.getElementById(container_id);
                container.addEventListener("keydown", onkeydown.bind(null, container_id, close_action), (function(){
                    var _d = Object.create(null);
                    _d["passive"] = false;
                    _d["capture"] = true;
                    return _d;
                }).call(this));
                container.setAttribute("tabindex", "0");
                _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: title_func(), action: close_action, icon: icon})]));
                container.appendChild(E.div());
                create_prefs_widget(container.lastChild, get_prefs_data());
                container.focus();
            };
            if (!init_prefs_panel.__argnames__) Object.defineProperties(init_prefs_panel, {
                __argnames__ : {value: ["container_id"]},
                __module__ : {value: "book_list.prefs"}
            });

            return init_prefs_panel;
        };
        if (!prefs_panel_handler.__defaults__) Object.defineProperties(prefs_panel_handler, {
            __defaults__ : {value: {on_close:null, icon:"close"}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["title_func", "get_prefs_data", "on_close", "icon"]},
            __module__ : {value: "book_list.prefs"}
        });

        _modules["book_list.prefs"].pp_counter = pp_counter;
        _modules["book_list.prefs"].widget_counter = widget_counter;
        _modules["book_list.prefs"].state = state;
        _modules["book_list.prefs"].ConfigItem = ConfigItem;
        _modules["book_list.prefs"].Choices = Choices;
        _modules["book_list.prefs"].CheckBox = CheckBox;
        _modules["book_list.prefs"].SpinBox = SpinBox;
        _modules["book_list.prefs"].LineEdit = LineEdit;
        _modules["book_list.prefs"].onfocus = onfocus;
        _modules["book_list.prefs"].create_prefs_widget = create_prefs_widget;
        _modules["book_list.prefs"].reset_to_defaults = reset_to_defaults;
        _modules["book_list.prefs"].prefs_panel_handler = prefs_panel_handler;
    })();

    (function(){
        var __name__ = "book_list.search";
        var apply_search, sp_counter, CLASS_NAME, state, last_accepted_search;
        var ajax = _modules.ajax.ajax;
        var absolute_path = _modules.ajax.absolute_path;

        var create_search_bar = _modules.complete.create_search_bar;

        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var build_rule = _modules.dom.build_rule;
        var svgicon = _modules.dom.svgicon;
        var add_extra_css = _modules.dom.add_extra_css;
        var ensure_id = _modules.dom.ensure_id;

        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var create_button = _modules.widgets.create_button;
        var create_spinner = _modules.widgets.create_spinner;
        var Breadcrumbs = _modules.widgets.Breadcrumbs;

        var show_modal = _modules.modals.show_modal;
        var create_custom_dialog = _modules.modals.create_custom_dialog;

        var rating_to_stars = _modules.utils.rating_to_stars;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var is_ios = _modules.utils.is_ios;

        var get_interface_data = _modules.session.get_interface_data;

        var library_data = _modules["book_list.library_data"].library_data;
        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var current_virtual_library = _modules["book_list.library_data"].current_virtual_library;

        var show_panel = _modules["book_list.ui"].show_panel;

        var back = _modules["book_list.router"].back;
        var show_note = _modules["book_list.router"].show_note;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;
        var add_button = _modules["book_list.top_bar"].add_button;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var get_color = _modules["book_list.theme"].get_color;
        var get_font_size = _modules["book_list.theme"].get_font_size;

        var prefs_panel_handler = _modules["book_list.prefs"].prefs_panel_handler;

        apply_search = null;
        function set_apply_search(func) {
            apply_search = func;
        };
        if (!set_apply_search.__argnames__) Object.defineProperties(set_apply_search, {
            __argnames__ : {value: ["func"]},
            __module__ : {value: "book_list.search"}
        });

        sp_counter = 0;
        CLASS_NAME = "book-search-panel";
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME + " ";
                style = _interpolate_kwargs.call(this, build_rule, [sel + " div.tag-name > span"].concat([_desugar_kwargs({word_break: "break-all", hyphens: "auto", padding_left: "1ex"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " div.tag-name:hover"].concat([_desugar_kwargs({color: get_color("list-hover-foreground"), background_color: get_color("list-hover-background")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " div.tag-menu:hover"].concat([_desugar_kwargs({color: get_color("list-hover-foreground"), background_color: get_color("list-hover-background")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " div.tag-name:active"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " div.tag-menu:active"].concat([_desugar_kwargs({transform: "scale(2)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " ul.search-items"].concat([_desugar_kwargs({margin_top: "1ex", list_style_type: "none", text_align: "left"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " ul.search-items > li"].concat([_desugar_kwargs({display: "inline-block", cursor: "pointer", background_color: get_color("window-background2"), border_radius: "10px", padding: "0.5ex", margin_right: "1em"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " ul.search-items > li:hover"].concat([_desugar_kwargs({color: get_color("window-hover-foreground")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " ul.search-items > li:active"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                style += _interpolate_kwargs.call(this, build_rule, ["#modal-container ul.tb-action-list > li:hover"].concat([_desugar_kwargs({color: get_color("list-hover-foreground"), background_color: get_color("list-hover-background")})]));
                style += _interpolate_kwargs.call(this, build_rule, ["#modal-container ul.tb-action-list > li:active"].concat([_desugar_kwargs({color: get_color("window-hover-foreground"), color: get_color("list-hover-foreground"), background_color: get_color("list-hover-background")})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.search"}
            });
            return _anonfunc;
        })());
        state = Object.create(null);
        last_accepted_search = null;
        function component(container, name) {
            return container.querySelector("[data-component=\"" + _str.format("{}", name) + "\"]");
        };
        if (!component.__argnames__) Object.defineProperties(component, {
            __argnames__ : {value: ["container", "name"]},
            __module__ : {value: "book_list.search"}
        });

        function icon_for_node(node) {
            var interface_data, ans;
            interface_data = get_interface_data();
            ans = (_expr_temp = interface_data.icon_map)[_bound_index(node.data.category, _expr_temp)] || "column.png";
            return absolute_path(interface_data.icon_path + "/" + ans);
        };
        if (!icon_for_node.__argnames__) Object.defineProperties(icon_for_node, {
            __argnames__ : {value: ["node"]},
            __module__ : {value: "book_list.search"}
        });

        function node_for_path(path) {
            var ans, child_index;
            path = path || state.tag_path;
            ans = state.tag_browser_data;
            var _Iter0 = _Iterable(path);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                child_index = _Iter0[_Index0];
                ans = (_expr_temp = ans.children)[(typeof child_index === "number" && child_index < 0) ? _expr_temp.length + child_index : child_index];
            }
            return ans;
        };
        if (!node_for_path.__argnames__) Object.defineProperties(node_for_path, {
            __argnames__ : {value: ["path"]},
            __module__ : {value: "book_list.search"}
        });

        function execute_search(text) {
            if (state.tag_path && state.tag_path.length) {
                last_accepted_search = (function(){
                    var _d = Object.create(null);
                    _d["library_id"] = current_library_id();
                    _d["vl"] = current_virtual_library();
                    _d["tag_path"] = list(state.tag_path);
                    return _d;
                }).call(this);
            }
            apply_search(text);
        };
        if (!execute_search.__argnames__) Object.defineProperties(execute_search, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "book_list.search"}
        });

        function ask_about_smart_quotes(text) {
            create_custom_dialog(_("Search contains smart quotes"), (function() {
                var _anonfunc = function (parent, close_modal) {
                    function action(replace) {
                        close_modal();
                        if (replace) {
                            text = text.replace(/[]/g, "\"");
                        }
                        execute_search(text);
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["replace"]},
                        __module__ : {value: "book_list.search"}
                    });

                    parent.appendChild(E.div(E.div(_("The search expression {} contains smart quotes. By default, Apple inserts smart quotes instead of normal quotes when tapping the quote button. This will prevent the search from working, if you intended to use normal quotes. You can type normal quotes by long-tapping the quotes button. Do you want to keep the smart quotes or replace them with normal quotes?").format(text)), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Replace"), null, action.bind(null, true)].concat([_desugar_kwargs({highlight: true})])), "", create_button(_("Keep"), null, action.bind(null, false))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.search"}
                });
                return _anonfunc;
            })());
        };
        if (!ask_about_smart_quotes.__argnames__) Object.defineProperties(ask_about_smart_quotes, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "book_list.search"}
        });

        function execute_search_interactive(text) {
            var container, search_control;
            if (!text) {
                container = document.getElementById(state.container_id);
                search_control = container.querySelector("input[name=\"search-books\"]");
                text = search_control.value || "";
            }
            if (is_ios && /[]/.test(text)) {
                ask_about_smart_quotes(text);
            } else {
                execute_search(text);
            }
        };
        if (!execute_search_interactive.__argnames__) Object.defineProperties(execute_search_interactive, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "book_list.search"}
        });

        function search_expression_for_item(node, node_state) {
            var item, search_state, stars, category, letters_seen, child, charclass, expr, rnum, fm, suffix, name;
            item = node.data;
            if (item.is_searchable === false || !node_state || node_state === "clear") {
                return "";
            }
            search_state = (_expr_temp = (function(){
                var _d = Object.create(null);
                _d["plus"] = "true";
                _d["plusplus"] = ".true";
                _d["minus"] = "false";
                _d["minusminus"] = ".false";
                return _d;
            }).call(this))[(typeof node_state === "number" && node_state < 0) ? _expr_temp.length + node_state : node_state];
            stars = rating_to_stars(3, true);
            if (item.is_category) {
                category = item.category;
                if (item.is_first_letter) {
                    letters_seen = Object.create(null);
                    var _Iter1 = _Iterable(node.children);
                    for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                        child = _Iter1[_Index1];
                        if (child.data.sort) {
                            letters_seen[_bound_index(child.data.sort[0], letters_seen)] = true;
                        }
                    }
                    letters_seen = Object.keys(letters_seen);
                    if (letters_seen.length) {
                        charclass = letters_seen.join("");
                        if (category === "authors") {
                            expr = "author_sort:\"~(^[{0}])|(&\\s*[{0}])\"".format(charclass);
                        } else if (category === "series") {
                            expr = "series_sort:\"~^[{0}]\"".format(charclass);
                        } else {
                            expr = "{0}:\"~^[{1}]\"".format(category, charclass);
                        }
                    } else {
                        expr = "{}:false".format(category);
                    }
                } else if (category === "news") {
                    expr = "tags:\"={}\"".format(item.name);
                } else {
                    return "{}:{}".format(category, search_state);
                }
                if (_in("false", search_state)) {
                    expr = "(not " + expr + ")";
                }
                return expr;
            }
            category = (item.category === "news") ? "tags" : item.category;
            if (item.name && _in(item.name[0], stars)) {
                rnum = item.name.length;
                if (item.name.endswith(stars[stars.length-1])) {
                    rnum = "{}.5".format(rnum - 1);
                }
                expr = "{}:{}".format(category, rnum);
            } else {
                fm = (_expr_temp = library_data.field_metadata)[_bound_index(item.category, _expr_temp)];
                suffix = (fm && fm.is_csp) ? ":" : "";
                name = item.original_name || item.name || item.sort;
                if (!name) {
                    return "";
                }
                name = str.replace(name, "\"", "\\\"");
                if (name[0] === ".") {
                    name = "." + name;
                }
                if (search_state === ".true" || search_state === ".false") {
                    name = "." + name;
                }
                expr = "{}:\"={}{}\"".format(category, name, suffix);
            }
            if (_in("false", search_state)) {
                expr = "(not " + expr + ")";
            }
            return expr;
        };
        if (!search_expression_for_item.__argnames__) Object.defineProperties(search_expression_for_item, {
            __argnames__ : {value: ["node", "node_state"]},
            __module__ : {value: "book_list.search"}
        });

        function node_clicked(i) {
            var node, expr;
            node = (_expr_temp = node_for_path().children)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
            if (node.children && node.children.length) {
                state.tag_path.append(i);
                render_tag_browser();
            } else {
                expr = search_expression_for_item(node, "plus");
                execute_search(expr);
            }
        };
        if (!node_clicked.__argnames__) Object.defineProperties(node_clicked, {
            __argnames__ : {value: ["i"]},
            __module__ : {value: "book_list.search"}
        });

        function add_to_search(node, search_type) {
            var anded;
            anded = get_session_data().get("and_search_terms");
            (_expr_temp = state.active_nodes)[_bound_index(node.id, _expr_temp)] = _list_decorate([ search_type, anded ]);
            render_search_expression();
        };
        if (!add_to_search.__argnames__) Object.defineProperties(add_to_search, {
            __argnames__ : {value: ["node", "search_type"]},
            __module__ : {value: "book_list.search"}
        });

        function remove_expression(node_id) {
            delete state.active_nodes[node_id];
            render_search_expression();
        };
        if (!remove_expression.__argnames__) Object.defineProperties(remove_expression, {
            __argnames__ : {value: ["node_id"]},
            __module__ : {value: "book_list.search"}
        });

        function render_search_expression() {
            var parts, container, sic, _unpack, search_type, anded, node, expr, name, c, node_id, search_control;
            parts = [];
            container = document.getElementById(state.container_id);
            sic = component(container, "search_expression");
            clear(sic);
            var _Iter2 = _Iterable(Object.keys(state.active_nodes));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                node_id = _Iter2[_Index2];
                _unpack = (_expr_temp = state.active_nodes)[(typeof node_id === "number" && node_id < 0) ? _expr_temp.length + node_id : node_id];
_unpack = _unpack_asarray(2, _unpack);
                search_type = _unpack[0];
                anded = _unpack[1];
                node = (_expr_temp = state.node_id_map)[(typeof node_id === "number" && node_id < 0) ? _expr_temp.length + node_id : node_id];
                expr = search_expression_for_item(node, search_type);
                name = node.data.original_name || node.data.name || node.data.sort || "";
                if (expr) {
                    c = E.li(svgicon("remove"), "" + name);
                    sic.appendChild(c);
                    c.addEventListener("click", remove_expression.bind(null, node_id));
                    if (parts.length) {
                        expr = ((anded) ? "and" : "or") + " " + expr;
                    }
                    parts.push(expr);
                }
            }
            search_control = container.querySelector("input[name=\"search-books\"]");
            search_control.value = parts.join(" ");
        };
        if (!render_search_expression.__module__) Object.defineProperties(render_search_expression, {
            __module__ : {value: "book_list.search"}
        });

        function menu_clicked(i) {
            function create_details(container, hide_modal) {
                var node, data, name, title, ul, items, interface_data, li, _unpack, text, search_type, f, and_control, about_items, footer;
                node = (_expr_temp = node_for_path().children)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                data = node.data;
                name = data.original_name || data.name || data.sort;
                title = _interpolate_kwargs.call(E, E.h2, [_interpolate_kwargs.call(E, E.img, [_desugar_kwargs({src: icon_for_node(node), style: "height:2ex; margin-right: 0.5rem"})]), E.span(name)].concat([_desugar_kwargs({style: "display:flex; align-items: center; border-bottom: solid 1px currentColor; font-weight:bold; font-size:" + get_font_size("title")})]));
                function edit_note(field, item_name) {
                    hide_modal();
                    _interpolate_kwargs.call(this, show_note, [field, 0, item_name].concat([_desugar_kwargs({panel: "edit_note"})]));
                };
                if (!edit_note.__argnames__) Object.defineProperties(edit_note, {
                    __argnames__ : {value: ["field", "item_name"]},
                    __module__ : {value: "book_list.search"}
                });

                if (data.category && data.name && library_data.fields_that_support_notes.indexOf(data.category)) {
                    title.appendChild(_interpolate_kwargs.call(E, E.a, [svgicon("pencil")].concat([_desugar_kwargs({class_: "blue-link", style: "margin-left: 0.5em", href: "javascript:void(0)", onclick: edit_note.bind(null, data.category, data.name), title: _("Edit or add notes for {}").format(data.name)})])));
                }
                container.appendChild(title);
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Search for books based on this category (a search term will be added to the search field)")].concat([_desugar_kwargs({style: "margin-top:1ex; margin-bottom: 1ex"})])));
                ul = _interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({style: "list-style:none; overflow:hidden", class_: "tb-action-list"})]);
                container.appendChild(ul);
                items = _list_decorate([ [_("Books matching this category"), "plus"], [_("Books that do not match this category"), 
                "minus"] ]);
                if (node.data.is_hierarchical === 5) {
                    items.extend(_list_decorate([ [_("Books that match this category and all sub-categories"), 
                    "plusplus"], [_("Books that do not match this category or any of its sub-categories"), 
                    "minusminus"] ]));
                }
                interface_data = get_interface_data();
                var _Iter3 = _Iterable(items);
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    _unpack = _Iter3[_Index3];
                    text = _unpack[0];
                    search_type = _unpack[1];
                    li = _interpolate_kwargs.call(E, E.li, [_interpolate_kwargs.call(E, E.img, [_desugar_kwargs({src: absolute_path("{}/{}.png".format(interface_data.icon_path, search_type)), style: "max-height: 2.5ex; margin-right:0.5rem"})]), E.span(text)].concat([_desugar_kwargs({style: "display:flex; align-items: center; margin-bottom:0.5ex; padding: 0.5ex; cursor:pointer"})]));
                    li.addEventListener("click", add_to_search.bind(null, node, search_type));
                    li.addEventListener("click", hide_modal);
                    ul.appendChild(li);
                }
                f = _interpolate_kwargs.call(E, E.form, [E.span(_("Add to the search expression with:")), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "expr_join", value: "OR", checked: ""})]), E.span("OR"), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "expr_join", value: "AND"})]), E.span("AND")].concat([_desugar_kwargs({style: "text-align:left; border-top: solid 1px currentColor; padding-top:1ex; margin-top:0.5ex; display:flex; align-items:center"})]));
                and_control = f.lastChild.previousSibling;
                and_control.checked = get_session_data().get("and_search_terms");
                container.appendChild(f);
                and_control.addEventListener("change", (function() {
                    var _anonfunc = function (ev) {
                        get_session_data().set("and_search_terms", bool(ev.target.checked));
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "book_list.search"}
                    });
                    return _anonfunc;
                })());
                f.firstChild.nextSibling.addEventListener("change", (function() {
                    var _anonfunc = function (ev) {
                        get_session_data().set("and_search_terms", !ev.target.checked);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "book_list.search"}
                    });
                    return _anonfunc;
                })());
                about_items = [];
                if (data.count !== undefined) {
                    about_items.push(_("Number of books: {}").format(data.count));
                }
                if (data.avg_rating !== undefined) {
                    about_items.push(_("Average rating of books: {:.1f}").format(data.avg_rating));
                }
                footer = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "text-align:left; border-top: solid 1px currentColor; padding-top:1ex; margin-top:0.5ex;"})]);
                if (about_items.length) {
                    footer.appendChild(_interpolate_kwargs.call(E, E.div, [" ".join(about_items)].concat([_desugar_kwargs({style: "font-size: smaller"})])));
                }
                if (footer.firstChild) {
                    container.appendChild(footer);
                }
            };
            if (!create_details.__argnames__) Object.defineProperties(create_details, {
                __argnames__ : {value: ["container", "hide_modal"]},
                __module__ : {value: "book_list.search"}
            });

            show_modal(create_details);
        };
        if (!menu_clicked.__argnames__) Object.defineProperties(menu_clicked, {
            __argnames__ : {value: ["i"]},
            __module__ : {value: "book_list.search"}
        });

        function render_children(container, children) {
            var data, tooltip, div, _unpack, i, node;
            var _Iter4 = _Iterable(enumerate(children));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                _unpack = _Iter4[_Index4];
                i = _unpack[0];
                node = _unpack[1];
                data = node.data;
                tooltip = "";
                if (data.count !== undefined) {
                    tooltip += "\n" + _("Number of books in this category: {}").format(data.count);
                }
                if (data.avg_rating !== undefined) {
                    tooltip += "\n" + _("Average rating for books in this category: {:.1f}").format(data.avg_rating);
                }
                div = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.img, [_desugar_kwargs({src: icon_for_node(node), style: "display:inline-block; max-height:2.5ex"})]), E.span(data.name)].concat([_desugar_kwargs({class_: "tag-name", style: "border-right:solid 1px currentColor; padding: 1ex; display:flex; align-items: center"})])), _interpolate_kwargs.call(E, E.div, [E.div(svgicon("angle-down"))].concat([_desugar_kwargs({class_: "tag-menu", style: "padding: 1ex; display:flex; align-items:center"})]))].concat([_desugar_kwargs({title: tooltip.lstrip(), style: "display:flex; align-items: stretch"})]));
                _interpolate_kwargs.call(this, set_css, [div].concat([_desugar_kwargs({max_width: "95vw", border: "solid 1px currentColor", border_radius: "20px", margin: "0.5rem", cursor: "pointer", overflow: "hidden", user_select: "none"})]));
                div.firstChild.addEventListener("click", node_clicked.bind(null, i));
                div.lastChild.addEventListener("click", menu_clicked.bind(null, i));
                container.appendChild(div);
            }
        };
        if (!render_children.__argnames__) Object.defineProperties(render_children, {
            __argnames__ : {value: ["container", "children"]},
            __module__ : {value: "book_list.search"}
        });

        function render_breadcrumbs() {
            var container, parent, _unpack, i, index;
            container = state.breadcrumbs.container;
            if (!state.tag_path.length) {
                container.style.display = "none";
                return;
            }
            container.style.display = "inline-block";
            state.breadcrumbs.reset();
            function onclick(i) {
                return (function() {
                    var _anonfunc = function (ev) {
                        state.tag_path = state.tag_path.slice(0, i + 1);
                        render_tag_browser();
                        ev.preventDefault();
                        return true;
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "book_list.search"}
                    });
                    return _anonfunc;
                })();
            };
            if (!onclick.__argnames__) Object.defineProperties(onclick, {
                __argnames__ : {value: ["i"]},
                __module__ : {value: "book_list.search"}
            });

            function create_breadcrumb() {
                var index = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_breadcrumb.__defaults__.index : arguments[0];
                var item = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? create_breadcrumb.__defaults__.item : arguments[1];
                var _kwargs_obj = arguments[arguments.length-1];
                if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "index")){
                    index = _kwargs_obj.index;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "item")){
                    item = _kwargs_obj.item;
                }
                var li;
                li = state.breadcrumbs.add_crumb(onclick(index));
                if (item) {
                    li.appendChild(E.span(item.name));
                } else {
                    li.appendChild(svgicon("home", "2.2ex", "2.2ex"));
                }
            };
            if (!create_breadcrumb.__defaults__) Object.defineProperties(create_breadcrumb, {
                __defaults__ : {value: {index:-1, item:null}},
                __handles_kwarg_interpolation__ : {value: true},
                __argnames__ : {value: ["index", "item"]},
                __module__ : {value: "book_list.search"}
            });

            create_breadcrumb();
            parent = state.tag_browser_data;
            var _Iter5 = _Iterable(enumerate(state.tag_path));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                _unpack = _Iter5[_Index5];
                i = _unpack[0];
                index = _unpack[1];
                parent = (_expr_temp = parent.children)[(typeof index === "number" && index < 0) ? _expr_temp.length + index : index];
                create_breadcrumb(i, parent.data);
            }
        };
        if (!render_breadcrumbs.__module__) Object.defineProperties(render_breadcrumbs, {
            __module__ : {value: "book_list.search"}
        });

        function render_tag_browser() {
            var container, node;
            container = component(document.getElementById(state.container_id), "tag_browser");
            clear(container);
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({padding: "1ex 1em", display: "flex", flex_wrap: "wrap", margin_left: "-0.5rem"})]));
            try {
                node = node_for_path();
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    state.tag_path = _list_decorate([]);
                    node = node_for_path();
                } 
            }
            render_children(container, node.children);
            render_breadcrumbs();
        };
        if (!render_tag_browser.__module__) Object.defineProperties(render_tag_browser, {
            __module__ : {value: "book_list.search"}
        });

        function on_data_fetched(end_type, xhr, ev) {
            var container, loading_panel, tag_browser_data;
            state.currently_loading = null;
            if (end_type === "abort") {
                return;
            }
            container = document.getElementById(state.container_id);
            if (!container) {
                return;
            }
            loading_panel = component(container, "loading");
            loading_panel.style.display = "none";
            container = component(container, "tag_browser");
            container.style.display = "block";
            clear(container);
            function show_error(error_html) {
                var ediv;
                ediv = E.div();
                container.appendChild(ediv);
                safe_set_inner_html(ediv, "<h3>" + _("Failed to load Tag browser data") + "</h3>" + error_html);
            };
            if (!show_error.__argnames__) Object.defineProperties(show_error, {
                __argnames__ : {value: ["error_html"]},
                __module__ : {value: "book_list.search"}
            });

            function process_node(node, item_map) {
                var child;
                (_expr_temp = state.node_id_map)[_bound_index(node.id, _expr_temp)] = node;
                node.data = item_map[_bound_index(node.id, item_map)];
                var _Iter6 = _Iterable(node.children);
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    child = _Iter6[_Index6];
                    child.parent = node;
                    process_node(child, item_map);
                }
            };
            if (!process_node.__argnames__) Object.defineProperties(process_node, {
                __argnames__ : {value: ["node", "item_map"]},
                __module__ : {value: "book_list.search"}
            });

            if (end_type === "load") {
                try {
                    tag_browser_data = JSON.parse(xhr.responseText);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        var err = _Exception;
                        show_error(err + "");
                        return;
                    } else {
                        throw _Exception;
                    }
                }
                state.tag_browser_data = tag_browser_data.root;
                state.node_id_map = Object.create(null);
                state.active_nodes = Object.create(null);
                process_node(state.tag_browser_data, tag_browser_data.item_map);
                if (last_accepted_search && last_accepted_search.library_id === current_library_id() && last_accepted_search.vl === current_virtual_library()) {
                    if (last_accepted_search.tag_path.length) {
                        state.tag_path = list(last_accepted_search.tag_path);
                    }
                }
                render_tag_browser();
            } else {
                show_error(xhr.error_html);
            }
        };
        if (!on_data_fetched.__argnames__) Object.defineProperties(on_data_fetched, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.search"}
        });

        function refresh() {
            var sd, query, k, xhr;
            if (state.currently_loading !== null) {
                state.currently_loading.abort();
                state.currently_loading = null;
            }
            sd = get_session_data();
            query = (function(){
                var _d = Object.create(null);
                _d["library_id"] = current_library_id();
                _d["vl"] = current_virtual_library();
                return _d;
            }).call(this);
            var _Iter7 = _Iterable("sort_tags_by partition_method collapse_at dont_collapse hide_empty_categories".split(" "));
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                k = _Iter7[_Index7];
                query[(typeof k === "number" && k < 0) ? query.length + k : k] = sd.get(k) + "";
            }
            xhr = _interpolate_kwargs.call(this, ajax, ["interface-data/tag-browser", on_data_fetched].concat([_desugar_kwargs({query: query, bypass_cache: false})]));
            xhr.send();
            state.currently_loading = xhr;
        };
        if (!refresh.__module__) Object.defineProperties(refresh, {
            __module__ : {value: "book_list.search"}
        });

        function create_search_panel(container) {
            var search_container, search_button, search_bar, loading_panel;
            state = Object.create(null);
            container.classList.add(CLASS_NAME);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "search", style: "text-align:center; padding:1ex 1em; border-bottom: solid 1px currentColor; margin-bottom: 0.5ex"})]));
            container.appendChild(E.div(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "loading"})]), _interpolate_kwargs.call(E, E.ol, [_desugar_kwargs({style: "display:none", data_component: "breadcrumbs"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:none", data_component: "tag_browser"})])));
            search_container = component(container, "search");
            search_button = _interpolate_kwargs.call(this, create_button, [_("Search")].concat([_desugar_kwargs({icon: "search", tooltip: _("Do the search")})]));
            search_bar = _interpolate_kwargs.call(this, create_search_bar, [execute_search_interactive, "search-books"].concat([_desugar_kwargs({tooltip: _("Search for books"), placeholder: _("Enter the search query"), button: search_button})]));
            _interpolate_kwargs.call(this, set_css, [search_bar].concat([_desugar_kwargs({flex_grow: "10", margin_right: "0.5em"})]));
            search_container.appendChild(_interpolate_kwargs.call(E, E.div, [search_bar, search_button].concat([_desugar_kwargs({style: "display: flex; width: 100%;"})])));
            search_container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [svgicon("fts"), "", _("Search the full text of books instead")].concat([_desugar_kwargs({class_: "blue-link", href: "javascript: void(0)", onclick: show_panel.bind(null, "fts")})]))].concat([_desugar_kwargs({style: "text-align: left; padding-top: 1ex"})])));
            search_container.appendChild(_interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({class_: "search-items", data_component: "search_expression"})]));
            loading_panel = component(container, "loading");
            loading_panel.appendChild(_interpolate_kwargs.call(E, E.div, [create_spinner(), "" + _("Fetching data for the Tag browser, please wait") + ""].concat([_desugar_kwargs({style: "margin-left:auto; margin-right:auto; font-size: 1.5rem; font-weight; bold; text-align:center; margin-top:30vh"})])));
            state.breadcrumbs = new Breadcrumbs(component(container, "breadcrumbs"));
            state.currently_loading = null;
            state.tag_browser_data = null;
            state.node_id_map = Object.create(null);
            state.active_nodes = Object.create(null);
            state.tag_path = _list_decorate([]);
            state.container_id = ensure_id(container);
            refresh();
        };
        if (!create_search_panel.__argnames__) Object.defineProperties(create_search_panel, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.search"}
        });

        function get_prefs() {
            return _list_decorate([ (function(){
                var _d = Object.create(null);
                _d["name"] = "sort_tags_by";
                _d["text"] = _("Sort tags by");
                _d["choices"] = _list_decorate([ ["name", _("Name")], ["popularity", _("Popularity (number of books)")], ["rating", 
                _("Average rating")] ]);
                _d["tooltip"] = _("Change how the tags/authors/etc. are sorted in the \"Tag browser\"");
                return _d;
            }).call(this), (function(){
                var _d = Object.create(null);
                _d["name"] = "partition_method";
                _d["text"] = _("Category partitioning method");
                _d["choices"] = _list_decorate([ ["first letter", _("First Letter")], ["disable", 
                _("Disable")], ["partition", _("Partition")] ]);
                _d["tooltip"] = _("Choose how Tag browser subcategories are displayed when there are more items than the limit. Select by first letter to see an A, B, C list. Choose partitioned to have a list of fixed-sized groups. Set to disabled if you never want subcategories.");
                return _d;
            }).call(this), (function(){
                var _d = Object.create(null);
                _d["name"] = "collapse_at";
                _d["text"] = _("Collapse when more items than");
                _d["min"] = 5;
                _d["max"] = 1e4;
                _d["step"] = 5;
                _d["from_storage"] = int;
                _d["to_storage"] = int;
                _d["tooltip"] = _("If a \"Tag browser\" category has more than this number of items, it is divided up into subcategories. If the partition method is set to disable, this value is ignored.");
                return _d;
            }).call(this), (function(){
                var _d = Object.create(null);
                _d["name"] = "dont_collapse";
                _d["text"] = _("Categories not to partition");
                _d["tooltip"] = _("A comma-separated list of categories in which items containing periods are displayed in the Tag browser trees. For example, if this box contains 'tags' then tags of the form 'Mystery.English' and 'Mystery.Thriller' will be displayed with English and Thriller both under 'Mystery'. If 'tags' is not in this box, then the tags will be displayed each on their own line.");
                return _d;
            }).call(this), (function(){
                var _d = Object.create(null);
                _d["name"] = "hide_empty_categories";
                _d["text"] = _("Hide empty categories (columns)");
                _d["from_storage"] = (function() {
                    var _anonfunc = function (x) {
                        return x.toLowerCase() === "yes";
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["x"]},
                        __module__ : {value: "book_list.search"}
                    });
                    return _anonfunc;
                })();
                _d["to_storage"] = (function() {
                    var _anonfunc = function (x) {
                        return (x) ? "yes" : "no";
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["x"]},
                        __module__ : {value: "book_list.search"}
                    });
                    return _anonfunc;
                })();
                _d["tooltip"] = _("When checked, calibre will automatically hide any category (a column, custom or standard) that has no items to show. For example, some categories might not have values when using Virtual libraries. Checking this box will cause these empty categories to be hidden.");
                return _d;
            }).call(this) ]);
        };
        if (!get_prefs.__module__) Object.defineProperties(get_prefs, {
            __module__ : {value: "book_list.search"}
        });

        function tb_config_panel_handler() {
            return prefs_panel_handler((function() {
                var _anonfunc = function () {
                    return _("Configure Tag browser");
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.search"}
                });
                return _anonfunc;
            })(), get_prefs);
        };
        if (!tb_config_panel_handler.__module__) Object.defineProperties(tb_config_panel_handler, {
            __module__ : {value: "book_list.search"}
        });

        function onkeydown(container_id, close_action, ev) {
            if (ev.key === "Escape") {
                [ev.preventDefault(), ev.stopPropagation()];
                close_action();
            }
        };
        if (!onkeydown.__argnames__) Object.defineProperties(onkeydown, {
            __argnames__ : {value: ["container_id", "close_action", "ev"]},
            __module__ : {value: "book_list.search"}
        });

        function init(container_id) {
            var container;
            if (!library_data.sortable_fields) {
                _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({replace: true})]));
                return;
            }
            container = document.getElementById(container_id);
            container.setAttribute("tabindex", "0");
            container.addEventListener("keydown", onkeydown.bind(null, container_id, back), (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                _d["capture"] = true;
                return _d;
            }).call(this));
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Search for books"), action: back, icon: "close"})]));
            _interpolate_kwargs.call(this, add_button, [container].concat([_desugar_kwargs({icon: "cogs", action: show_panel.bind(null, "book_list^search^prefs"), tooltip: _("Configure Tag browser")})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME})]));
            create_search_panel(container.lastChild);
            container.focus();
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.search"}
        });

        _modules["book_list.search"].apply_search = apply_search;
        _modules["book_list.search"].sp_counter = sp_counter;
        _modules["book_list.search"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.search"].state = state;
        _modules["book_list.search"].last_accepted_search = last_accepted_search;
        _modules["book_list.search"].set_apply_search = set_apply_search;
        _modules["book_list.search"].component = component;
        _modules["book_list.search"].icon_for_node = icon_for_node;
        _modules["book_list.search"].node_for_path = node_for_path;
        _modules["book_list.search"].execute_search = execute_search;
        _modules["book_list.search"].ask_about_smart_quotes = ask_about_smart_quotes;
        _modules["book_list.search"].execute_search_interactive = execute_search_interactive;
        _modules["book_list.search"].search_expression_for_item = search_expression_for_item;
        _modules["book_list.search"].node_clicked = node_clicked;
        _modules["book_list.search"].add_to_search = add_to_search;
        _modules["book_list.search"].remove_expression = remove_expression;
        _modules["book_list.search"].render_search_expression = render_search_expression;
        _modules["book_list.search"].menu_clicked = menu_clicked;
        _modules["book_list.search"].render_children = render_children;
        _modules["book_list.search"].render_breadcrumbs = render_breadcrumbs;
        _modules["book_list.search"].render_tag_browser = render_tag_browser;
        _modules["book_list.search"].on_data_fetched = on_data_fetched;
        _modules["book_list.search"].refresh = refresh;
        _modules["book_list.search"].create_search_panel = create_search_panel;
        _modules["book_list.search"].get_prefs = get_prefs;
        _modules["book_list.search"].tb_config_panel_handler = tb_config_panel_handler;
        _modules["book_list.search"].onkeydown = onkeydown;
        _modules["book_list.search"].init = init;
    })();

    (function(){
        var __name__ = "book_list.views";
        var CLASS_NAME, ITEM_CLASS_NAME, ALLOWED_MODES, DEFAULT_MODE, book_list_data;
        var traceback = _modules.traceback;

        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ajax_send = _modules.ajax.ajax_send;

        var add_books_panel = _modules["book_list.add"].add_books_panel;

        var cover_grid_append_item = _modules["book_list.cover_grid"].append_item;
        var cover_grid_css = _modules["book_list.cover_grid"].cover_grid_css;
        var create_cover_grid_item = _modules["book_list.cover_grid"].create_item;
        var COVER_GRID_DESCRIPTION = _modules["book_list.cover_grid"].description;
        var init_cover_grid = _modules["book_list.cover_grid"].init;

        var custom_list_append_item = _modules["book_list.custom_list"].append_item;
        var create_custom_list_item = _modules["book_list.custom_list"].create_item;
        var custom_list_css = _modules["book_list.custom_list"].custom_list_css;
        var CUSTOM_LIST_DESCRIPTION = _modules["book_list.custom_list"].description;
        var init_custom_list = _modules["book_list.custom_list"].init;

        var details_list_append_item = _modules["book_list.details_list"].append_item;
        var create_details_list_item = _modules["book_list.details_list"].create_item;
        var DETAILS_LIST_DESCRIPTION = _modules["book_list.details_list"].description;
        var details_list_css = _modules["book_list.details_list"].details_list_css;
        var init_details_list = _modules["book_list.details_list"].init;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_item = _modules["book_list.item_list"].create_item;
        var create_item_list = _modules["book_list.item_list"].create_item_list;

        var add_more_books = _modules["book_list.library_data"].add_more_books;
        var all_virtual_libraries = _modules["book_list.library_data"].all_virtual_libraries;
        var book_metadata = _modules["book_list.library_data"].book_metadata;
        var current_book_ids = _modules["book_list.library_data"].current_book_ids;
        var current_sorted_field = _modules["book_list.library_data"].current_sorted_field;
        var ensure_current_library_data = _modules["book_list.library_data"].ensure_current_library_data;
        var library_data = _modules["book_list.library_data"].library_data;
        var load_status = _modules["book_list.library_data"].load_status;
        var loaded_books_query = _modules["book_list.library_data"].loaded_books_query;
        var thumbnail_cache = _modules["book_list.library_data"].thumbnail_cache;
        var url_books_query = _modules["book_list.library_data"].url_books_query;

        var back = _modules["book_list.router"].back;
        var home = _modules["book_list.router"].home;
        var push_state = _modules["book_list.router"].push_state;
        var update_window_title = _modules["book_list.router"].update_window_title;

        var init_search_panel = _modules["book_list.search"].init;
        var set_apply_search = _modules["book_list.search"].set_apply_search;
        var tb_config_panel_handler = _modules["book_list.search"].tb_config_panel_handler;

        var add_button = _modules["book_list.top_bar"].add_button;
        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;
        var set_title_tooltip = _modules["book_list.top_bar"].set_title_tooltip;

        var query_as_href = _modules["book_list.ui"].query_as_href;
        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;
        var show_panel = _modules["book_list.ui"].show_panel;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;
        var set_css = _modules.dom.set_css;

        var error_dialog = _modules.modals.error_dialog;

        var get_interface_data = _modules.session.get_interface_data;

        var conditional_timeout = _modules.utils.conditional_timeout;
        var parse_url_params = _modules.utils.parse_url_params;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;
        var create_spinner = _modules.widgets.create_spinner;
        var enable_escape_key = _modules.widgets.enable_escape_key;

        CLASS_NAME = "book-list-container";
        ITEM_CLASS_NAME = "book-list-item";
        ALLOWED_MODES = (function(){
            var s = _set();
            s.jsset.add("cover_grid");
            s.jsset.add("details_list");
            s.jsset.add("custom_list");
            return s;
        })();
        DEFAULT_MODE = "cover_grid";
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, ans;
                sel = "." + CLASS_NAME + " ";
                ans = _interpolate_kwargs.call(this, build_rule, [sel + "[data-component=\"top_message\"]"].concat([_desugar_kwargs({margin: "1ex 1em"})]));
                ans += cover_grid_css();
                ans += details_list_css();
                ans += custom_list_css();
                return ans;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.views"}
            });
            return _anonfunc;
        })());
        book_list_data = (function(){
            var _d = Object.create(null);
            _d["container_id"] = null;
            _d["shown_book_ids"] = set();
            _d["mode"] = null;
            _d["fetching_more_books"] = null;
            return _d;
        }).call(this);
        function component(name) {
            return document.getElementById(book_list_data.container_id).querySelector("[data-component=\"" + _str.format("{}", name) + "\"]");
        };
        if (!component.__argnames__) Object.defineProperties(component, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.views"}
        });

        function clear_grid() {
            var container, e, bl;
            container = document.getElementById(book_list_data.container_id);
            e = component("book_list");
            bl = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "book_list"})]);
            container.insertBefore(bl, e);
            container.removeChild(e);
            book_list_data.init_grid(bl);
        };
        if (!clear_grid.__module__) Object.defineProperties(clear_grid, {
            __module__ : {value: "book_list.views"}
        });

        function has_parent_with_class(elem, cls) {
            while (elem) {
                if (elem.classList && elem.classList.contains(cls)) {
                    return elem;
                }
                elem = elem.parentNode;
            }
        };
        if (!has_parent_with_class.__argnames__) Object.defineProperties(has_parent_with_class, {
            __argnames__ : {value: ["elem", "cls"]},
            __module__ : {value: "book_list.views"}
        });

        function save_scroll_position() {
            var container, _unpack, left, top, elem, p, q, x, y;
            container = document.getElementById(book_list_data.container_id);
            if (container) {
                _unpack = [container.offsetLeft, container.offsetTop];
                left = _unpack[0];
                top = _unpack[1];
                for (var _Index0 = 5; _Index0 < 100; _Index0+=5) {
                    y = _Index0;
                    for (var _Index1 = 25; _Index1 < 125; _Index1+=5) {
                        x = _Index1;
                        elem = document.elementFromPoint(left + x, top + y);
                        p = has_parent_with_class(elem, ITEM_CLASS_NAME);
                        if (p) {
                            q = parse_url_params();
                            q.book_id = p.dataset.bookId;
                            _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: true, call_handler: false})]));
                            return;
                        }
                    }
                }
            }
        };
        if (!save_scroll_position.__module__) Object.defineProperties(save_scroll_position, {
            __module__ : {value: "book_list.views"}
        });

        function show_subsequent_panel() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var query = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_subsequent_panel.__defaults__.query : arguments[1];
            var replace = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_subsequent_panel.__defaults__.replace : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "query")){
                query = _kwargs_obj.query;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            save_scroll_position();
            show_panel(name, query, replace);
        };
        if (!show_subsequent_panel.__defaults__) Object.defineProperties(show_subsequent_panel, {
            __defaults__ : {value: {query:null, replace:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "query", "replace"]},
            __module__ : {value: "book_list.views"}
        });

        function on_book_click(book_id, evt) {
            evt.preventDefault();
            show_subsequent_panel("book_details", (function(){
                var _d = Object.create(null);
                _d["book_id"] = book_id;
                return _d;
            }).call(this));
        };
        if (!on_book_click.__argnames__) Object.defineProperties(on_book_click, {
            __argnames__ : {value: ["book_id", "evt"]},
            __module__ : {value: "book_list.views"}
        });

        function create_image(book_id, max_width, max_height, on_load) {
            return thumbnail_cache.get(book_id, max_width, max_height, on_load);
        };
        if (!create_image.__argnames__) Object.defineProperties(create_image, {
            __argnames__ : {value: ["book_id", "max_width", "max_height", "on_load"]},
            __module__ : {value: "book_list.views"}
        });

        function render_id(book_id) {
            var l, metadata, ans;
            l = book_list_data.shown_book_ids.length;
            book_list_data.shown_book_ids.add(book_id);
            if (l < book_list_data.shown_book_ids.length) {
                metadata = book_metadata(book_id);
                ans = book_list_data.render_book(book_id, metadata, create_image, on_book_click.bind(null, book_id), query_as_href((function(){
                    var _d = Object.create(null);
                    _d["book_id"] = book_id + "";
                    return _d;
                }).call(this), "book_details"));
                ans.classList.add(ITEM_CLASS_NAME);
                ans.dataset.bookId = str(book_id);
                return ans;
            }
        };
        if (!render_id.__argnames__) Object.defineProperties(render_id, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.views"}
        });

        function render_ids(book_ids) {
            var div, child, book_id;
            book_ids = book_ids || current_book_ids();
            div = component("book_list");
            if (div) {
                var _Iter2 = _Iterable(book_ids);
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    book_id = _Iter2[_Index2];
                    child = render_id(book_id);
                    if (child) {
                        book_list_data.append_item(div, child);
                    }
                }
            }
        };
        if (!render_ids.__argnames__) Object.defineProperties(render_ids, {
            __argnames__ : {value: ["book_ids"]},
            __module__ : {value: "book_list.views"}
        });

        function get_view_mode() {
            var idata, mode;
            idata = get_interface_data();
            mode = get_session_data().get("view_mode", idata.default_book_list_mode);
            if (!_in(mode, ["cover_grid", "details_list", "custom_list"])) {
                mode = DEFAULT_MODE;
            }
            return mode;
        };
        if (!get_view_mode.__module__) Object.defineProperties(get_view_mode, {
            __module__ : {value: "book_list.views"}
        });

        function setup_view_mode(mode, book_list_data) {
            if (!_in(mode, ALLOWED_MODES)) {
                mode = DEFAULT_MODE;
            }
            book_list_data.mode = mode;
            if (mode === "cover_grid") {
                book_list_data.render_book = create_cover_grid_item;
                book_list_data.init_grid = init_cover_grid;
                book_list_data.append_item = cover_grid_append_item;
            } else if (mode === "details_list") {
                book_list_data.render_book = create_details_list_item;
                book_list_data.init_grid = init_details_list;
                book_list_data.append_item = details_list_append_item;
            } else if (mode === "custom_list") {
                book_list_data.render_book = create_custom_list_item;
                book_list_data.init_grid = init_custom_list;
                book_list_data.append_item = custom_list_append_item;
            }
            return mode;
        };
        if (!setup_view_mode.__argnames__) Object.defineProperties(setup_view_mode, {
            __argnames__ : {value: ["mode", "book_list_data"]},
            __module__ : {value: "book_list.views"}
        });

        function apply_view_mode() {
            var mode = (arguments[0] === undefined || ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? apply_view_mode.__defaults__.mode : arguments[0];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "mode")){
                mode = _kwargs_obj.mode;
            }
            if (book_list_data.mode === mode) {
                return;
            }
            setup_view_mode(mode, book_list_data);
            clear_grid();
            render_ids();
        };
        if (!apply_view_mode.__defaults__) Object.defineProperties(apply_view_mode, {
            __defaults__ : {value: {mode:DEFAULT_MODE}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["mode"]},
            __module__ : {value: "book_list.views"}
        });

        function update_fetching_status() {
            var more;
            more = component("more_button");
            if (!more) {
                return;
            }
            if (book_list_data.fetching_more_books) {
                more.firstChild.style.display = "none";
                more.lastChild.style.display = "block";
            } else if (library_data.search_result.total_num > book_list_data.shown_book_ids.length) {
                more.firstChild.style.display = "block";
                more.lastChild.style.display = "none";
            } else {
                more.firstChild.style.display = "none";
                more.lastChild.style.display = "none";
            }
        };
        if (!update_fetching_status.__module__) Object.defineProperties(update_fetching_status, {
            __module__ : {value: "book_list.views"}
        });

        function abort_get_more_books(no_update) {
            if (book_list_data.fetching_more_books) {
                book_list_data.fetching_more_books.abort();
                book_list_data.fetching_more_books = null;
                if (!no_update) {
                    update_fetching_status();
                }
            }
        };
        if (!abort_get_more_books.__argnames__) Object.defineProperties(abort_get_more_books, {
            __argnames__ : {value: ["no_update"]},
            __module__ : {value: "book_list.views"}
        });

        function got_more_books(end_type, xhr, event) {
            var data;
            if (book_list_data.fetching_more_books !== xhr) {
                return;
            }
            book_list_data.fetching_more_books = null;
            update_fetching_status();
            if (end_type === "load") {
                try {
                    data = JSON.parse(xhr.responseText);
                    if (!data.search_result.book_ids) {
                        throw new Exception("No books ids object in search result from server");
                    }
                    add_more_books(data);
                    render_ids(data.search_result.book_ids);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        error_dialog(_("Could not get more books"), _("Server returned an invalid response"), traceback.format_exc());
                    } else {
                        throw _Exception;
                    }
                }
            } else if (end_type !== "abort") {
                error_dialog(_("Could not get more books"), xhr.error_html);
            }
        };
        if (!got_more_books.__argnames__) Object.defineProperties(got_more_books, {
            __argnames__ : {value: ["end_type", "xhr", "event"]},
            __module__ : {value: "book_list.views"}
        });

        function get_more_books() {
            var data, key;
            data = (function(){
                var _d = Object.create(null);
                _d["offset"] = book_list_data.shown_book_ids.length;
                return _d;
            }).call(this);
            var _Iter3 = _Iterable(_list_decorate([ "query", "sort", "sort_order", "vl" ]));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                key = _Iter3[_Index3];
                data[(typeof key === "number" && key < 0) ? data.length + key : key] = (_expr_temp = library_data.search_result)[(typeof key === "number" && key < 0) ? _expr_temp.length + key : key];
            }
            book_list_data.fetching_more_books = _interpolate_kwargs.call(this, ajax_send, ["interface-data/more-books", data, got_more_books].concat([_desugar_kwargs({query: (function(){
                var _d = Object.create(null);
                _d["library_id"] = loaded_books_query().library_id;
                return _d;
            }).call(this)})]));
            update_fetching_status();
        };
        if (!get_more_books.__module__) Object.defineProperties(get_more_books, {
            __module__ : {value: "book_list.views"}
        });

        function create_more_button(more) {
            more.appendChild(create_button(_("Show more books"), "cloud-download", get_more_books));
            more.lastChild.setAttribute("rel", "next");
            _interpolate_kwargs.call(this, set_css, [more.firstChild].concat([_desugar_kwargs({display: "block", margin_left: "auto", margin_right: "auto", margin_top: "1rem"})]));
            _interpolate_kwargs.call(this, set_css, [more].concat([_desugar_kwargs({font_size: "1.5rem", padding_top: "1.5rem", margin_bottom: "1.5rem", text_align: "center", display: "flex"})]));
            more.appendChild(_interpolate_kwargs.call(E, E.div, [create_spinner(), "" + _("Fetching metadata for more books, please wait") + ""].concat([_desugar_kwargs({style: "margin-left:auto; margin-right:auto; display:none"})])));
            update_fetching_status();
        };
        if (!create_more_button.__argnames__) Object.defineProperties(create_more_button, {
            __argnames__ : {value: ["more"]},
            __module__ : {value: "book_list.views"}
        });

        function fts() {
            var q;
            q = (function(){
                var _d = Object.create(null);
                _d["restricted"] = "y";
                _d["restriction"] = library_data.search_result.query;
                return _d;
            }).call(this);
            show_panel("fts", q);
        };
        if (!fts.__module__) Object.defineProperties(fts, {
            __module__ : {value: "book_list.views"}
        });

        function show_top_message() {
            var container, q, c;
            container = component("top_message");
            q = loaded_books_query();
            if (!q.search && !q.vl) {
                container.style.display = "none";
                return;
            }
            if (q.vl) {
                container.appendChild(E.span(E.span(_("Showing Virtual library: {} ").format(q.vl)), create_button(_("Close"), "close", (function() {
                    var _anonfunc = function () {
                        show_vl();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.views"}
                    });
                    return _anonfunc;
                })(), _("Show all books in library"))));
                if (q.search) {
                    container.appendChild(E.br());
                }
            }
            if (q.search) {
                c = E.span();
                if (library_data.search_result.total_num) {
                    c.appendChild(E.span(_("Showing books matching:"), " ", E.i(library_data.search_result.query), " ", _("(total matches: {}) ").format(library_data.search_result.total_num)));
                    c.appendChild(E.span(" ", _interpolate_kwargs.call(E, E.a, [_("Clear search")].concat([_desugar_kwargs({class_: "blue-link", onclick: (function() {
                        var _anonfunc = function () {
                            search();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "book_list.views"}
                        });
                        return _anonfunc;
                    })()})]))));
                    if (library_data.fts_enabled) {
                        c.appendChild(E.span(_(" or "), _interpolate_kwargs.call(E, E.a, [_("Search the text of these books")].concat([_desugar_kwargs({class_: "blue-link", onclick: (function() {
                            var _anonfunc = function () {
                                fts();
                            };
                            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                __module__ : {value: "book_list.views"}
                            });
                            return _anonfunc;
                        })()})]))));
                    }
                } else {
                    c.appendChild(E.span(_("No books matching:"), " ", E.i(library_data.search_result.query)));
                }
                container.appendChild(c);
            }
        };
        if (!show_top_message.__module__) Object.defineProperties(show_top_message, {
            __module__ : {value: "book_list.views"}
        });

        function create_books_list(container) {
            var q, scrolled, e, div;
            book_list_data.container_id = ensure_id(container);
            book_list_data.shown_book_ids = set();
            book_list_data.mode = null;
            abort_get_more_books(true);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "top_message"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "book_list"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "more_button"})]));
            show_top_message();
            apply_view_mode(get_view_mode());
            create_more_button(container.lastChild);
            _interpolate_kwargs.call(this, add_button, [container.parentNode].concat([_desugar_kwargs({icon: "plus", action: show_subsequent_panel.bind(null, "book_list^add"), tooltip: _("Add books")})]));
            _interpolate_kwargs.call(this, add_button, [container.parentNode].concat([_desugar_kwargs({icon: "sort-amount-desc", action: show_subsequent_panel.bind(null, "book_list^sort"), tooltip: _("Sort books")})]));
            _interpolate_kwargs.call(this, add_button, [container.parentNode].concat([_desugar_kwargs({icon: "search", action: show_subsequent_panel.bind(null, "book_list^search"), tooltip: _("Search for books")})]));
            _interpolate_kwargs.call(this, add_button, [container.parentNode].concat([_desugar_kwargs({icon: "ellipsis-v", action: show_subsequent_panel.bind(null, "book_list^more_actions"), tooltip: _("More actions")})]));
            q = parse_url_params();
            scrolled = false;
            if (q.book_id) {
                e = container.querySelector("." + _str.format("{}", ITEM_CLASS_NAME) + "[data-book-id=\"" + _str.format("{}", q.book_id) + "\"]");
                if (e && e.scrollIntoView) {
                    e.scrollIntoView(true);
                    window.scrollBy(0, -container.offsetTop);
                    scrolled = true;
                }
            }
            if (!scrolled) {
                window.scrollTo(0, 0);
            }
            q = loaded_books_query();
            if (!q.search && library_data.search_result.total_num < 1) {
                div = component("book_list");
                div.appendChild(_interpolate_kwargs.call(E, E.div, [_("No books found")].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
            }
        };
        if (!create_books_list.__argnames__) Object.defineProperties(create_books_list, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.views"}
        });

        function check_for_books_loaded() {
            var container, container_id, err;
            container = this;
            container_id = container.id;
            if (load_status.loading) {
                conditional_timeout(container_id, 5, check_for_books_loaded);
                return;
            }
            container = container.lastChild;
            clear(container);
            if (!load_status.ok) {
                if (load_status.http_error_code === 401) {
                    container.appendChild(E.div(_("Username/password required, retrying...")));
                    ensure_current_library_data();
                    conditional_timeout(container_id, 100, check_for_books_loaded);
                    return;
                }
                err = E.div();
                safe_set_inner_html(err, load_status.error_html);
                container.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(_("Failed to load books from calibre library, with error:")), err, _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Go back to the home page")].concat([_desugar_kwargs({onclick: (function() {
                    var _anonfunc = function () {
                        _interpolate_kwargs.call(this, home, [_desugar_kwargs({replace: true})]);
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.views"}
                    });
                    return _anonfunc;
                })(), href: "javascript: void(0)", class_: "blue-link"})]))].concat([_desugar_kwargs({style: "margin-top: 1em; border-top: solid 1px currentColor; padding-top: 1ex;"})]))].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
                return;
            }
            create_books_list(container);
            if (library_data.search_result && typeof library_data.search_result.num_books_without_search === "number") {
                set_title_tooltip(this, _("Total number of books: {}").format(library_data.search_result.num_books_without_search));
            }
        };
        if (!check_for_books_loaded.__module__) Object.defineProperties(check_for_books_loaded, {
            __module__ : {value: "book_list.views"}
        });

        function init(container_id) {
            var interface_data, container, lid, title;
            interface_data = get_interface_data();
            ensure_current_library_data();
            container = document.getElementById(container_id);
            lid = container.dataset.library_id = url_books_query().library_id;
            title = (_expr_temp = interface_data.library_map)[(typeof lid === "number" && lid < 0) ? _expr_temp.length + lid : lid];
            update_window_title(title);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: title, action: (function() {
                var _anonfunc = function () {
                    [save_scroll_position(), home()];
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.views"}
                });
                return _anonfunc;
            })(), icon: "home"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME})]));
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading books from the {} calibre library, please wait...").format(title)].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
            conditional_timeout(container_id, 5, check_for_books_loaded);
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.views"}
        });

        function change_sort(field, order) {
            var sd, so, q;
            abort_get_more_books();
            sd = get_session_data();
            so = sd.get("last_sort_order");
            order = order || so[(typeof field === "number" && field < 0) ? so.length + field : field] || "asc";
            order = (order === "asc") ? "asc" : "desc";
            q = loaded_books_query();
            q.sort = field + "." + order;
            so[(typeof field === "number" && field < 0) ? so.length + field : field] = order;
            sd.set("last_sort_order", so);
            sd.set_library_option(q.library_id, "sort", q.sort);
            _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({query: q, replace: true})]));
        };
        if (!change_sort.__argnames__) Object.defineProperties(change_sort, {
            __argnames__ : {value: ["field", "order"]},
            __module__ : {value: "book_list.views"}
        });

        function create_sort_panel(container_id) {
            var container, _unpack, close_action, close_icon, items, csf, csf_order, new_sort_order, subtitle, icon_name, action, field, name;
            if (!library_data.sortable_fields) {
                _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({replace: true})]));
                return;
            }
            container = document.getElementById(container_id);
            _unpack = [back, "close"];
            close_action = _unpack[0];
            close_icon = _unpack[1];
            if (parse_url_params().close_action === "home") {
                _unpack = [(function() {
                    var _anonfunc = function () {
                        home();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.views"}
                    });
                    return _anonfunc;
                })(), "home"];
                close_action = _unpack[0];
                close_icon = _unpack[1];
            }
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Sort books by"), action: close_action, icon: close_icon})]));
            items = _list_decorate([]);
            _unpack = current_sorted_field();
_unpack = _unpack_asarray(2, _unpack);
            csf = _unpack[0];
            csf_order = _unpack[1];
            new_sort_order = (csf_order === "asc") ? "desc" : "asc";
            if (csf === "date") {
                csf = "timestamp";
            }
            var _Iter4 = _Iterable(library_data.sortable_fields);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                _unpack = _Iter4[_Index4];
                field = _unpack[0];
                name = _unpack[1];
                subtitle = icon_name = null;
                if (field === csf) {
                    subtitle = _("Reverse current sort order");
                    icon_name = (csf_order === "asc") ? "sort-amount-asc" : "sort-amount-desc";
                    action = change_sort.bind(null, field, new_sort_order);
                } else {
                    action = change_sort.bind(null, field, null);
                }
                items.push(_interpolate_kwargs.call(this, create_item, [name].concat([_desugar_kwargs({subtitle: subtitle, icon: icon_name, action: action})])));
            }
            container.appendChild(E.div());
            create_item_list(container.lastChild, items, _("Change how the list of books is sorted"));
            enable_escape_key(container, close_action);
        };
        if (!create_sort_panel.__argnames__) Object.defineProperties(create_sort_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.views"}
        });

        function search_query_for(query) {
            var q;
            q = loaded_books_query();
            if (query) {
                q.search = query;
            } else {
                delete q.search;
            }
            return q;
        };
        if (!search_query_for.__argnames__) Object.defineProperties(search_query_for, {
            __argnames__ : {value: ["query"]},
            __module__ : {value: "book_list.views"}
        });

        function search() {
            var query = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var replace = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? search.__defaults__.replace : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({query: search_query_for(query), replace: replace})]));
        };
        if (!search.__defaults__) Object.defineProperties(search, {
            __defaults__ : {value: {replace:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["query", "replace"]},
            __module__ : {value: "book_list.views"}
        });

        set_apply_search((function() {
            var _anonfunc = function (query) {
                search(query, true);
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["query"]},
                __module__ : {value: "book_list.views"}
            });
            return _anonfunc;
        })());
        function create_vl_panel(container_id) {
            var container, items, vls, vl_names, name;
            if (!library_data.sortable_fields) {
                _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({replace: true})]));
                return;
            }
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Choose Virtual library"), action: back, icon: "close"})]));
            items = _list_decorate([]);
            vls = all_virtual_libraries();
            vl_names = Object.keys(vls).sort((function() {
                var _anonfunc = function (a, b) {
                    return a.toLowerCase().localeCompare(b.toLowerCase());
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a", "b"]},
                    __module__ : {value: "book_list.views"}
                });
                return _anonfunc;
            })());
            var _Iter5 = _Iterable(vl_names);
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                name = _Iter5[_Index5];
                items.push(_interpolate_kwargs.call(this, create_item, [name].concat([_desugar_kwargs({subtitle: vls[(typeof name === "number" && name < 0) ? vls.length + name : name], action: show_vl.bind(null, name, true)})])));
            }
            container.appendChild(E.div());
            create_item_list(container.lastChild, items, _("Choose a Virtual library to browse from the list below"));
            enable_escape_key(container, back);
        };
        if (!create_vl_panel.__argnames__) Object.defineProperties(create_vl_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.views"}
        });

        function show_vl(vl_name, replace) {
            var q;
            q = loaded_books_query();
            q.vl = vl_name || null;
            _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({query: q, replace: replace || false})]));
        };
        if (!show_vl.__argnames__) Object.defineProperties(show_vl, {
            __argnames__ : {value: ["vl_name", "replace"]},
            __module__ : {value: "book_list.views"}
        });

        function create_mode_panel(container_id) {
            var container, items, current_mode;
            if (!library_data.sortable_fields) {
                _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({replace: true})]));
                return;
            }
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Choose book list mode"), action: back, icon: "close"})]));
            items = _list_decorate([]);
            current_mode = get_view_mode();
            function ci(title, desc, name) {
                var ic;
                ic = (name === current_mode) ? "check" : null;
                items.push(_interpolate_kwargs.call(this, create_item, [title].concat([_desugar_kwargs({subtitle: desc, icon: ic, action: (function() {
                    var _anonfunc = function () {
                        if (name !== current_mode) {
                            get_session_data().set("view_mode", name);
                        }
                        back();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.views"}
                    });
                    return _anonfunc;
                })()})])));
            };
            if (!ci.__argnames__) Object.defineProperties(ci, {
                __argnames__ : {value: ["title", "desc", "name"]},
                __module__ : {value: "book_list.views"}
            });

            ci(_("Cover grid"), COVER_GRID_DESCRIPTION(), "cover_grid");
            ci(_("Detailed list"), DETAILS_LIST_DESCRIPTION(), "details_list");
            ci(_("Custom list"), CUSTOM_LIST_DESCRIPTION(), "custom_list");
            container.appendChild(E.div());
            create_item_list(container.lastChild, items, _("Choose a display mode for the list of books from below"));
            enable_escape_key(container, back);
        };
        if (!create_mode_panel.__argnames__) Object.defineProperties(create_mode_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.views"}
        });

        function create_more_actions_panel(container_id) {
            var container, items, vls;
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("More actions"), action: back, icon: "close"})]));
            items = _list_decorate([ _interpolate_kwargs.call(this, create_item, [_("Book list mode")].concat([_desugar_kwargs({subtitle: _("Change how the list of books is displayed"), action: (function() {
                var _anonfunc = function () {
                    _interpolate_kwargs.call(this, show_panel, ["book_list^choose_mode"].concat([_desugar_kwargs({replace: true})]));
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.views"}
                });
                return _anonfunc;
            })()})])), _interpolate_kwargs.call(this, create_item, [_("A random book")].concat([_desugar_kwargs({subtitle: _("Choose a random book from the library"), action: (function() {
                var _anonfunc = function () {
                    var query;
                    query = (function(){
                        var _d = Object.create(null);
                        _d["book_id"] = "0";
                        return _d;
                    }).call(this);
                    _interpolate_kwargs.call(this, show_panel, ["book_details"].concat([_desugar_kwargs({query: query, replace: true})]));
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.views"}
                });
                return _anonfunc;
            })()})])) ]);
            vls = all_virtual_libraries();
            if (vls && Object.keys(vls).length > 0) {
                items.insert(1, _interpolate_kwargs.call(this, create_item, [_("Choose Virtual library")].concat([_desugar_kwargs({subtitle: _("Browse books in a Virtual library"), action: (function() {
                    var _anonfunc = function () {
                        _interpolate_kwargs.call(this, show_panel, ["book_list^vl"].concat([_desugar_kwargs({replace: true})]));
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.views"}
                    });
                    return _anonfunc;
                })()})])));
            }
            container.appendChild(E.div());
            create_item_list(container.lastChild, items);
            enable_escape_key(container, back);
        };
        if (!create_more_actions_panel.__argnames__) Object.defineProperties(create_more_actions_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.views"}
        });

        function create_add_panel(container_id) {
            if (!library_data.sortable_fields) {
                _interpolate_kwargs.call(this, show_panel, ["book_list"].concat([_desugar_kwargs({replace: true})]));
                return;
            }
            add_books_panel(container_id);
        };
        if (!create_add_panel.__argnames__) Object.defineProperties(create_add_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.views"}
        });

        set_panel_handler("book_list", init);
        set_panel_handler("book_list^add", create_add_panel);
        set_panel_handler("book_list^sort", create_sort_panel);
        set_panel_handler("book_list^vl", create_vl_panel);
        set_panel_handler("book_list^search", init_search_panel);
        set_panel_handler("book_list^choose_mode", create_mode_panel);
        set_panel_handler("book_list^search^prefs", tb_config_panel_handler());
        set_panel_handler("book_list^more_actions", create_more_actions_panel);
        _modules["book_list.views"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.views"].ITEM_CLASS_NAME = ITEM_CLASS_NAME;
        _modules["book_list.views"].ALLOWED_MODES = ALLOWED_MODES;
        _modules["book_list.views"].DEFAULT_MODE = DEFAULT_MODE;
        _modules["book_list.views"].book_list_data = book_list_data;
        _modules["book_list.views"].component = component;
        _modules["book_list.views"].clear_grid = clear_grid;
        _modules["book_list.views"].has_parent_with_class = has_parent_with_class;
        _modules["book_list.views"].save_scroll_position = save_scroll_position;
        _modules["book_list.views"].show_subsequent_panel = show_subsequent_panel;
        _modules["book_list.views"].on_book_click = on_book_click;
        _modules["book_list.views"].create_image = create_image;
        _modules["book_list.views"].render_id = render_id;
        _modules["book_list.views"].render_ids = render_ids;
        _modules["book_list.views"].get_view_mode = get_view_mode;
        _modules["book_list.views"].setup_view_mode = setup_view_mode;
        _modules["book_list.views"].apply_view_mode = apply_view_mode;
        _modules["book_list.views"].update_fetching_status = update_fetching_status;
        _modules["book_list.views"].abort_get_more_books = abort_get_more_books;
        _modules["book_list.views"].got_more_books = got_more_books;
        _modules["book_list.views"].get_more_books = get_more_books;
        _modules["book_list.views"].create_more_button = create_more_button;
        _modules["book_list.views"].fts = fts;
        _modules["book_list.views"].show_top_message = show_top_message;
        _modules["book_list.views"].create_books_list = create_books_list;
        _modules["book_list.views"].check_for_books_loaded = check_for_books_loaded;
        _modules["book_list.views"].init = init;
        _modules["book_list.views"].change_sort = change_sort;
        _modules["book_list.views"].create_sort_panel = create_sort_panel;
        _modules["book_list.views"].search_query_for = search_query_for;
        _modules["book_list.views"].search = search;
        _modules["book_list.views"].create_vl_panel = create_vl_panel;
        _modules["book_list.views"].show_vl = show_vl;
        _modules["book_list.views"].create_mode_panel = create_mode_panel;
        _modules["book_list.views"].create_more_actions_panel = create_more_actions_panel;
        _modules["book_list.views"].create_add_panel = create_add_panel;
    })();

    (function(){
        var __name__ = "book_list.book_details";
        var bd_counter, CLASS_NAME, SEARCH_INTERNET_CLASS, COPY_TO_LIBRARY_CLASS, FORMAT_PRIORITIES, IGNORED_FIELDS, default_sort, _unpack, i, f, current_fetch;
        var E = _modules.elementmaker.E;

        var traceback = _modules.traceback;

        var ajax = _modules.ajax.ajax;
        var ajax_send = _modules.ajax.ajax_send;
        var encode_query_component = _modules.ajax.encode_query_component;

        var refresh_after_delete = _modules["book_list.delete_book"].refresh_after_delete;
        var start_delete_book = _modules["book_list.delete_book"].start_delete_book;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_item = _modules["book_list.item_list"].create_item;
        var create_item_list = _modules["book_list.item_list"].create_item_list;

        var all_libraries = _modules["book_list.library_data"].all_libraries;
        var book_after = _modules["book_list.library_data"].book_after;
        var book_metadata = _modules["book_list.library_data"].book_metadata;
        var cover_url = _modules["book_list.library_data"].cover_url;
        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var current_virtual_library = _modules["book_list.library_data"].current_virtual_library;
        var download_url = _modules["book_list.library_data"].download_url;
        var library_data = _modules["book_list.library_data"].library_data;
        var load_status = _modules["book_list.library_data"].load_status;
        var set_book_metadata = _modules["book_list.library_data"].set_book_metadata;

        var back = _modules["book_list.router"].back;
        var home = _modules["book_list.router"].home;
        var open_book = _modules["book_list.router"].open_book;
        var report_a_load_failure = _modules["book_list.router"].report_a_load_failure;
        var show_note = _modules["book_list.router"].show_note;

        var color_scheme = _modules["book_list.theme"].color_scheme;
        var get_color = _modules["book_list.theme"].get_color;
        var get_color_as_rgba = _modules["book_list.theme"].get_color_as_rgba;
        var get_font_size = _modules["book_list.theme"].get_font_size;

        var add_button = _modules["book_list.top_bar"].add_button;
        var clear_buttons = _modules["book_list.top_bar"].clear_buttons;
        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;
        var set_title = _modules["book_list.top_bar"].set_title;

        var query_as_href = _modules["book_list.ui"].query_as_href;
        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;
        var show_panel = _modules["book_list.ui"].show_panel;

        var search_query_for = _modules["book_list.views"].search_query_for;

        var format_date = _modules.date.format_date;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var create_custom_dialog = _modules.modals.create_custom_dialog;
        var error_dialog = _modules.modals.error_dialog;
        var warning_dialog = _modules.modals.warning_dialog;

        var copy_touch = _modules["read_book.touch"].copy_touch;
        var install_handlers = _modules["read_book.touch"].install_handlers;
        var interpret_single_gesture = _modules["read_book.touch"].interpret_single_gesture;
        var touch_id = _modules["read_book.touch"].touch_id;
        var update_touch = _modules["read_book.touch"].update_touch;

        var get_interface_data = _modules.session.get_interface_data;

        var conditional_timeout = _modules.utils.conditional_timeout;
        var debounce = _modules.utils.debounce;
        var fmt_sidx = _modules.utils.fmt_sidx;
        var human_readable = _modules.utils.human_readable;
        var parse_url_params = _modules.utils.parse_url_params;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var sandboxed_html = _modules.utils.sandboxed_html;

        var create_button = _modules.widgets.create_button;
        var create_spinner = _modules.widgets.create_spinner;

        bd_counter = 0;
        CLASS_NAME = "book-details-panel";
        SEARCH_INTERNET_CLASS = "book-details-search-internet";
        COPY_TO_LIBRARY_CLASS = "book-details-copy-to-library";
        FORMAT_PRIORITIES = _list_decorate([ "EPUB", "AZW3", "DOCX", "LIT", "MOBI", "ODT", "RTF", "MD", "MARKDOWN", "TXT", "PDF" ]);
        function sort_formats_key(fmt) {
            var ans;
            ans = FORMAT_PRIORITIES.indexOf(fmt);
            if (ans < 0) {
                ans = FORMAT_PRIORITIES.length;
            }
            return ans;
        };
        if (!sort_formats_key.__argnames__) Object.defineProperties(sort_formats_key, {
            __argnames__ : {value: ["fmt"]},
            __module__ : {value: "book_list.book_details"}
        });

        function get_preferred_format(metadata, output_format, input_formats, for_download) {
            var formats, f, fmt, found, q;
            formats = metadata && metadata.formats || [];
            formats = (function() {
                var _Iter = _Iterable(formats), _Result = [], f;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    f = _Iter[_Index];
                    _Result.push(f.toUpperCase());
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            fmt = (output_format === "PDF") ? "EPUB" : output_format;
            if (formats.length && formats.indexOf(fmt) === -1) {
                found = false;
                formats = _interpolate_kwargs.call(this, sorted, [formats].concat([_desugar_kwargs({key: sort_formats_key})]));
                var _Iter0 = _Iterable(formats);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    q = _Iter0[_Index0];
                    if (input_formats[(typeof q === "number" && q < 0) ? input_formats.length + q : q]) {
                        fmt = q;
                        found = true;
                        break;
                    }
                }
                if (for_download && !found && formats.length) {
                    fmt = formats[0];
                }
            }
            return fmt.toUpperCase();
        };
        if (!get_preferred_format.__argnames__) Object.defineProperties(get_preferred_format, {
            __argnames__ : {value: ["metadata", "output_format", "input_formats", "for_download"]},
            __module__ : {value: "book_list.book_details"}
        });

        IGNORED_FIELDS = (function(){
            var s = _set();
            s.jsset.add("title");
            s.jsset.add("sort");
            s.jsset.add("uuid");
            s.jsset.add("id");
            s.jsset.add("urls_from_identifiers");
            s.jsset.add("lang_names");
            s.jsset.add("last_modified");
            s.jsset.add("path");
            return s;
        })();
        default_sort = (function() {
            var _Iter = _Iterable(enumerate(["title", "title_sort", "authors", "author_sort", 
            "series", "rating", "pubdate", "tags", "timestamp", "pubdate", "identifiers", "languages", 
            "publisher", "last_modified"])), _Result = Object.create(null), i, f;
            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                _unpack = _Iter[_Index];
                i = _unpack[0];
                f = _unpack[1];
                _Result[f] = (i + 1);
            }
            return _Result;
        })();
        default_sort["formats"] = 999;
        function field_sorter(field_metadata) {
            return (function() {
                var _anonfunc = function (field) {
                    var lvl, fm;
                    lvl = "{:03d}".format(default_sort[(typeof field === "number" && field < 0) ? default_sort.length + field : field] || 998);
                    fm = (_expr_temp = (field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field] || Object.create(null)))[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] || Object.create(null);
                    return lvl + (fm.name || "zzzzz");
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["field"]},
                    __module__ : {value: "book_list.book_details"}
                });
                return _anonfunc;
            })();
        };
        if (!field_sorter.__argnames__) Object.defineProperties(field_sorter, {
            __argnames__ : {value: ["field_metadata"]},
            __module__ : {value: "book_list.book_details"}
        });

        function href_for_search() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var val = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var use_quotes = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? href_for_search.__defaults__.use_quotes : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "use_quotes")){
                use_quotes = _kwargs_obj.use_quotes;
            }
            var query, q;
            query = ((use_quotes) ? "{}:\"={}\"" : "{}:{}").format(name, str.replace(val, "\"", "\\\""));
            q = search_query_for(query);
            return query_as_href(q);
        };
        if (!href_for_search.__defaults__) Object.defineProperties(href_for_search, {
            __defaults__ : {value: {use_quotes:true}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "val", "use_quotes"]},
            __module__ : {value: "book_list.book_details"}
        });

        function on_fmt_click(ev) {
            var fmt, book_id, _unpack, title, sz;
            fmt = ev.currentTarget.dataset.format;
            book_id = int(ev.currentTarget.dataset.bookId);
            _unpack = this;
_unpack = _unpack_asarray(2, _unpack);
            title = _unpack[0];
            sz = _unpack[1];
            create_custom_dialog(title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    var read_button;
                    function action(which) {
                        close_modal();
                        which(book_id, fmt);
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["which"]},
                        __module__ : {value: "book_list.book_details"}
                    });

                    if (fmt.lower() === "pdf") {
                        read_button = download_url(book_id, fmt, "inline");
                    } else {
                        read_button = action.bind(null, read_format);
                    }
                    parent.appendChild(E.div(E.div(_("What would you like to do with the {} format?").format(fmt)), _interpolate_kwargs.call(E, E.div, [create_button(_("Read"), "book", read_button), "", _interpolate_kwargs.call(this, create_button, [_("Download"), "cloud-download", download_url(book_id, fmt), _("File size: {}").format(human_readable(sz))].concat([_desugar_kwargs({download_filename: "" + _str.format("{}", title) + "." + _str.format("{}", fmt.toLowerCase()) + ""})]))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.book_details"}
                });
                return _anonfunc;
            })());
        };
        if (!on_fmt_click.__argnames__) Object.defineProperties(on_fmt_click, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "book_list.book_details"}
        });

        function adjust_iframe_height(iframe) {
            var de;
            de = iframe.contentWindow.document.documentElement;
            iframe.style.height = de.offsetHeight + 5 + "px";
            iframe.dataset.last_window_width = window.innerWidth + "";
            return de;
        };
        if (!adjust_iframe_height.__argnames__) Object.defineProperties(adjust_iframe_height, {
            __argnames__ : {value: ["iframe"]},
            __module__ : {value: "book_list.book_details"}
        });

        function setup_iframe(iframe) {
            var de, a, key;
            de = adjust_iframe_height(iframe);
            var _Iter1 = _Iterable(de.querySelectorAll("a[href]"));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                a = _Iter1[_Index1];
                a.setAttribute("target", "_parent");
            }
            function forward_touch_events(ev) {
                var container, dup;
                container = window.top.document.getElementById(render_book.container_id);
                if (container) {
                    dup = new ev.constructor(ev.type, ev);
                    container.dispatchEvent(dup);
                }
            };
            if (!forward_touch_events.__argnames__) Object.defineProperties(forward_touch_events, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "book_list.book_details"}
            });

            var _Iter2 = _Iterable(_list_decorate([ "start", "move", "end", "cancel" ]));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                key = _Iter2[_Index2];
                iframe.contentWindow.addEventListener("touch" + _str.format("{}", key) + "", forward_touch_events);
            }
        };
        if (!setup_iframe.__argnames__) Object.defineProperties(setup_iframe, {
            __argnames__ : {value: ["iframe"]},
            __module__ : {value: "book_list.book_details"}
        });

        function adjust_all_iframes(ev) {
            var ww, iframe;
            var _Iter3 = _Iterable(document.querySelectorAll("." + _str.format("{}", CLASS_NAME) + " iframe"));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                iframe = _Iter3[_Index3];
                ww = parseInt(iframe.dataset.last_window_width);
                if (ww !== window.innerWidth) {
                    adjust_iframe_height(iframe);
                }
            }
        };
        if (!adjust_all_iframes.__argnames__) Object.defineProperties(adjust_all_iframes, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "book_list.book_details"}
        });

        function add_stars_to(stars, val, allow_half_stars) {
            var i;
            for (var _Index4 = 0; _Index4 < Math.floor(val / 2); _Index4++) {
                i = _Index4;
                stars.appendChild(svgicon("star"));
            }
            if (allow_half_stars && val % 2) {
                stars.appendChild(svgicon("star-half"));
            }
        };
        if (!add_stars_to.__argnames__) Object.defineProperties(add_stars_to, {
            __argnames__ : {value: ["stars", "val", "allow_half_stars"]},
            __module__ : {value: "book_list.book_details"}
        });

        if ((typeof window !== "undefined" && window !== null)) {
            window.addEventListener("resize", debounce(adjust_all_iframes, 250));
        }
        function adjusting_sandboxed_html(html, extra_css) {
            var color, css, ans;
            color = get_color_as_rgba("window-foreground");
            css = "\n\n:root { color-scheme: " + _str.format("{}", color_scheme()) + " }\n\nhtml, body { overflow: hidden; color: rgba(" + _str.format("{}", color[0]) + ", " + _str.format("{}", color[1]) + ", " + _str.format("{}", color[2]) + ", " + _str.format("{}", color[3]) + ") }";
            if (extra_css) {
                css += "\n\n" + extra_css;
            }
            ans = sandboxed_html(html, css, "allow-same-origin allow-top-navigation-by-user-activation");
            ans.addEventListener("load", (function() {
                var _anonfunc = function (ev) {
                    setup_iframe(ev.target);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "book_list.book_details"}
                });
                return _anonfunc;
            })());
            ans.style.height = "50vh";
            ans.dataset.last_window_width = "0";
            return ans;
        };
        if (!adjusting_sandboxed_html.__argnames__) Object.defineProperties(adjusting_sandboxed_html, {
            __argnames__ : {value: ["html", "extra_css"]},
            __module__ : {value: "book_list.book_details"}
        });

        function render_metadata(mi, table, book_id, iframe_css) {
            var field_metadata, interface_data, fields, vertical_categories, x, comments, link_maps, fm, field, all_html, name, _unpack, comment, iframe;
            field_metadata = library_data.field_metadata;
            interface_data = get_interface_data();
            function allowed_fields(field) {
                var fm;
                if (field.endswith("_index")) {
                    fm = field_metadata[_bound_index(field.slice(0, -len("_index")), field_metadata)];
                    if (fm && fm.datatype === "series") {
                        return false;
                    }
                }
                if (field.startswith("#")) {
                    return true;
                }
                if (_in(field, IGNORED_FIELDS) || field.endswith("_sort")) {
                    return false;
                }
                if (mi[(typeof field === "number" && field < 0) ? mi.length + field : field] === undefined) {
                    return false;
                }
                return true;
            };
            if (!allowed_fields.__argnames__) Object.defineProperties(allowed_fields, {
                __argnames__ : {value: ["field"]},
                __module__ : {value: "book_list.book_details"}
            });

            fields = library_data.book_display_fields;
            vertical_categories = (function() {
                var _Iter = _Iterable(library_data.book_details_vertical_categories || []), _Result = Object.create(null), x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    _Result[x] = (true);
                }
                return _Result;
            })();
            if (!fields || !fields.length || get_session_data().get("show_all_metadata")) {
                fields = _interpolate_kwargs.call(this, sorted, [filter(allowed_fields, mi)].concat([_desugar_kwargs({key: field_sorter(field_metadata)})]));
            } else {
                fields = filter(allowed_fields, fields);
            }
            comments = [];
            link_maps = mi.link_maps || {};
            function show_note_action(field, item_id, item_val) {
                show_note(field, item_id, item_val);
            };
            if (!show_note_action.__argnames__) Object.defineProperties(show_note_action, {
                __argnames__ : {value: ["field", "item_id", "item_val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function add_note_link(field, name, val, parent) {
                if (mi.items_with_notes && (_expr_temp = mi.items_with_notes)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] && (_expr_temp = (_expr_temp = mi.items_with_notes)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field])[(typeof val === "number" && val < 0) ? _expr_temp.length + val : val]) {
                    parent.appendChild(document.createTextNode(" "));
                    parent.appendChild(_interpolate_kwargs.call(E, E.a, [svgicon("pencil")].concat([_desugar_kwargs({title: _("Show notes for: {}").format(val), href: "javascript:void(0)", onclick: show_note_action.bind(null, field, (_expr_temp = (_expr_temp = mi.items_with_notes)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field])[(typeof val === "number" && val < 0) ? _expr_temp.length + val : val], val), class_: "blue-link"})])));
                }
            };
            if (!add_note_link.__argnames__) Object.defineProperties(add_note_link, {
                __argnames__ : {value: ["field", "name", "val", "parent"]},
                __module__ : {value: "book_list.book_details"}
            });

            function add_row() {
                var field = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
                var name = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
                var val = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
                var is_searchable = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.is_searchable : arguments[3];
                var is_html = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.is_html : arguments[4];
                var join = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.join : arguments[5];
                var search_text = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.search_text : arguments[6];
                var use_quotes = (arguments[7] === undefined || ( 7 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.use_quotes : arguments[7];
                var _kwargs_obj = arguments[arguments.length-1];
                if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "is_searchable")){
                    is_searchable = _kwargs_obj.is_searchable;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "is_html")){
                    is_html = _kwargs_obj.is_html;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "join")){
                    join = _kwargs_obj.join;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "search_text")){
                    search_text = _kwargs_obj.search_text;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "use_quotes")){
                    use_quotes = _kwargs_obj.use_quotes;
                }
                var is_vertical, v;
                if (val === undefined || val === null) {
                    return;
                }
                is_vertical = vertical_categories[(typeof field === "number" && field < 0) ? vertical_categories.length + field : field];
                function add_val(v) {
                    var parent, text_rep, url;
                    if (!v.appendChild) {
                        v += "";
                    }
                    parent = table.lastChild.lastChild;
                    if (is_searchable) {
                        text_rep = search_text || v;
                        parent.appendChild(_interpolate_kwargs.call(E, E.a, [v].concat([_desugar_kwargs({title: _("Click to see books with {0}: {1}").format(name, text_rep), class_: "blue-link", href: _interpolate_kwargs.call(this, href_for_search, [is_searchable, text_rep].concat([_desugar_kwargs({use_quotes: use_quotes})]))})])));
                        if (link_maps[(typeof field === "number" && field < 0) ? link_maps.length + field : field] && (_expr_temp = link_maps[(typeof field === "number" && field < 0) ? link_maps.length + field : field])[(typeof text_rep === "number" && text_rep < 0) ? _expr_temp.length + text_rep : text_rep]) {
                            url = (_expr_temp = link_maps[(typeof field === "number" && field < 0) ? link_maps.length + field : field])[(typeof text_rep === "number" && text_rep < 0) ? _expr_temp.length + text_rep : text_rep];
                            if (url.startswith("https://") || url.startswith("http://")) {
                                parent.appendChild(document.createTextNode(" "));
                                parent.appendChild(_interpolate_kwargs.call(E, E.a, [svgicon("external-link")].concat([_desugar_kwargs({title: _("Click to open") + ": " + url, href: url, target: "_new", class_: "blue-link"})])));
                            }
                        }
                    } else {
                        if (v.appendChild) {
                            parent.appendChild(v);
                        } else {
                            parent.appendChild(document.createTextNode(v));
                        }
                    }
                    if (typeof v === "string" && !is_html) {
                        add_note_link(field, name, v, parent);
                    }
                };
                if (!add_val.__argnames__) Object.defineProperties(add_val, {
                    __argnames__ : {value: ["v"]},
                    __module__ : {value: "book_list.book_details"}
                });

                table.appendChild(E.tr(E.td(name), E.td()));
                if (is_html && /[<>]/.test(val + "")) {
                    table.lastChild.lastChild.appendChild(adjusting_sandboxed_html(val + "", iframe_css));
                } else {
                    if (!join) {
                        add_val(val);
                    } else {
                        var _Iter5 = _Iterable(val);
                        for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                            v = _Iter5[_Index5];
                            add_val(v);
                            if (v !== val[val.length-1]) {
                                if (is_vertical) {
                                    table.lastChild.lastChild.appendChild(E.br());
                                } else {
                                    table.lastChild.lastChild.appendChild(document.createTextNode(join));
                                }
                            }
                        }
                    }
                }
                return table.lastChild.lastChild;
            };
            if (!add_row.__defaults__) Object.defineProperties(add_row, {
                __defaults__ : {value: {is_searchable:false, is_html:false, join:null, search_text:null, use_quotes:true}},
                __handles_kwarg_interpolation__ : {value: true},
                __argnames__ : {value: ["field", "name", "val", "is_searchable", "is_html", "join", "search_text", "use_quotes"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_composite(field, fm, name, val) {
                var all_vals;
                if (fm.display && fm.display.contains_html) {
                    _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({is_html: true})]));
                    return;
                }
                if (fm.is_multiple && fm.is_multiple.list_to_ui) {
                    all_vals = filter(null, map(str.strip, val.split(fm.is_multiple.list_to_ui)));
                    _interpolate_kwargs.call(this, add_row, [field, name, all_vals].concat([_desugar_kwargs({is_searchable: field, join: fm.is_multiple.list_to_ui})]));
                } else {
                    _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({is_searchable: field})]));
                }
            };
            if (!process_composite.__argnames__) Object.defineProperties(process_composite, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_authors(field, fm, name, val) {
                _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({is_searchable: field, join: " & "})]));
            };
            if (!process_authors.__argnames__) Object.defineProperties(process_authors, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_publisher(field, fm, name, val) {
                _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({is_searchable: field})]));
            };
            if (!process_publisher.__argnames__) Object.defineProperties(process_publisher, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_formats(field, fm, name, val) {
                var td, fmt;
                if (val.length && (typeof book_id !== "undefined" && book_id !== null)) {
                    table.appendChild(E.tr(E.td(name), E.td()));
                    td = table.lastChild.lastChild;
                    var _Iter6 = _Iterable(val);
                    for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                        fmt = _Iter6[_Index6];
                        fmt = fmt.toUpperCase();
                        td.appendChild(_interpolate_kwargs.call(E, E.a, [fmt].concat([_desugar_kwargs({class_: "blue-link", href: "javascript:void(0)", title: _("Read or download this book in the {} format").format(fmt), onclick: on_fmt_click.bind([mi.title, mi.format_sizes[fmt] || 0]), data_format: fmt, data_book_id: "" + book_id})])));
                        if (fmt !== val[val.length-1]) {
                            td.appendChild(document.createTextNode(", "));
                        }
                    }
                }
            };
            if (!process_formats.__argnames__) Object.defineProperties(process_formats, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_rating(field, fm, name, val) {
                var stars;
                stars = E.span();
                val = int(val || 0);
                if (val > 0) {
                    add_stars_to(stars, val, _exists.d(fm.display).allow_half_stars);
                    _interpolate_kwargs.call(this, add_row, [field, name, stars].concat([_desugar_kwargs({is_searchable: field, search_text: val / 2 + ""})]));
                }
            };
            if (!process_rating.__argnames__) Object.defineProperties(process_rating, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_identifiers(field, fm, name, val) {
                var td, _unpack, text, k, idval, url;
                function ids_sorter(x) {
                    return (x[0] || "").toLowerCase();
                };
                if (!ids_sorter.__argnames__) Object.defineProperties(ids_sorter, {
                    __argnames__ : {value: ["x"]},
                    __module__ : {value: "book_list.book_details"}
                });

                if (val && mi.urls_from_identifiers && mi.urls_from_identifiers.length > 0) {
                    td = E.td();
                    var _Iter7 = _Iterable(_interpolate_kwargs.call(this, sorted, [mi.urls_from_identifiers || []].concat([_desugar_kwargs({key: ids_sorter})])));
                    for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                        _unpack = _flatten(_Iter7[_Index7]);
                        text = _unpack[0];
                        k = _unpack[1];
                        idval = _unpack[2];
                        url = _unpack[3];
                        if (td.childNodes.length) {
                            td.appendChild(document.createTextNode(", "));
                        }
                        td.appendChild(_interpolate_kwargs.call(E, E.a, [text].concat([_desugar_kwargs({class_: "blue-link", title: "{}:{}".format(k, idval), target: "_new", href: url})])));
                    }
                    if (td.childNodes.length) {
                        table.appendChild(E.tr(E.td(name), td));
                    }
                }
            };
            if (!process_identifiers.__argnames__) Object.defineProperties(process_identifiers, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_size(field, fm, name, val) {
                if (val) {
                    try {
                        add_row(field, name, human_readable(int(val)));
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            add_row(field, name, val + "");
                        } 
                    }
                }
            };
            if (!process_size.__argnames__) Object.defineProperties(process_size, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_languages(field, fm, name, val) {
                var td, lang, k;
                if (val && val.length) {
                    table.appendChild(E.tr(E.td(name), E.td()));
                    td = table.lastChild.lastChild;
                    var _Iter8 = _Iterable(val);
                    for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                        k = _Iter8[_Index8];
                        if (mi.lang_names) {
                            lang = (_expr_temp = mi.lang_names)[(typeof k === "number" && k < 0) ? _expr_temp.length + k : k] || k;
                        } else {
                            lang = k;
                        }
                        td.appendChild(_interpolate_kwargs.call(E, E.a, [lang].concat([_desugar_kwargs({class_: "blue-link", title: _("Click to see books with language: {}").format(lang), href: href_for_search(field, k)})])));
                        if (k !== val[val.length-1]) {
                            td.appendChild(document.createTextNode(", "));
                        }
                    }
                }
            };
            if (!process_languages.__argnames__) Object.defineProperties(process_languages, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_datetime(field, fm, name, val) {
                var fmt, formatted_val;
                if (val) {
                    fmt = interface_data[_bound_index("gui_" + field + "_display_format", interface_data)] || (fm["display"] || Object.create(null)).date_format;
                    formatted_val = format_date(val, fmt);
                    if (formatted_val) {
                        _interpolate_kwargs.call(this, add_row, [field, name, formatted_val].concat([_desugar_kwargs({is_searchable: field, search_text: val})]));
                    }
                }
            };
            if (!process_datetime.__argnames__) Object.defineProperties(process_datetime, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_series(field, fm, name, val) {
                var ifield, ival, s, a;
                if (val) {
                    ifield = field + "_index";
                    try {
                        ival = float(mi[(typeof ifield === "number" && ifield < 0) ? mi.length + ifield : ifield]);
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        if (_Exception instanceof Error) {
                            ival = 1;
                        } else {
                            throw _Exception;
                        }
                    }
                    ival = _interpolate_kwargs.call(this, fmt_sidx, [ival].concat([_desugar_kwargs({use_roman: interface_data.use_roman_numerals_for_series_number})]));
                    table.appendChild(E.tr(E.td(name), E.td()));
                    s = safe_set_inner_html(E.span(), _("{0} of <a>{1}</a>").format(ival, val));
                    a = s.getElementsByTagName("a");
                    if (a && a.length) {
                        a = a[0];
                        a.setAttribute("href", href_for_search(field, val));
                        a.setAttribute("title", _("Click to see books with {0}: {1}").format(name, val));
                        a.setAttribute("class", "blue-link");
                    } else {
                        print("WARNING: Translation of series template is incorrect as it does not have an <a> tag");
                    }
                    table.lastChild.lastChild.appendChild(s);
                    add_note_link(field, name, val, table.lastChild.lastChild);
                }
            };
            if (!process_series.__argnames__) Object.defineProperties(process_series, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.book_details"}
            });

            function process_field(field, fm) {
                var name, datatype, val, ias, hp, func, join, v, fmt, formatted_val;
                name = fm.name || field;
                datatype = fm.datatype;
                val = mi[(typeof field === "number" && field < 0) ? mi.length + field : field];
                if (field === "comments" || datatype === "comments" || _exists.d(fm.display).composite_show_in_comments) {
                    if (!val) {
                        return;
                    }
                    ias = _exists.d(fm.display).interpret_as || "html";
                    hp = _exists.d(fm.display).heading_position || "hide";
                    if (ias === "long-text") {
                        if (hp === "side") {
                            add_row(field, name, val).style.whiteSpace = "pre-wrap";
                            return;
                        }
                        val = _interpolate_kwargs.call(E, E.pre, [val].concat([_desugar_kwargs({style: "white-space:pre-wrap"})])).outerHTML;
                    } else if (ias === "short-text") {
                        if (hp === "side") {
                            add_row(field, name, val);
                            return;
                        }
                        val = E.span(val).outerHTML;
                    } else {
                        if (field === "comments" && !_in("<", val)) {
                            val = "\n".join((function() {
                                var _Iter = _Iterable(val.split("\n\n")), _Result = [], x;
                                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                                    x = _Iter[_Index];
                                    _Result.push("<p class=\"description\">{}</p>".format(x.replace(/\n/g, "<br>")));
                                }
                                _Result = _list_constructor(_Result);
                                return _Result;
                            })());
                        }
                    }
                    if (hp === "side") {
                        _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({is_html: true})]));
                        return;
                    }
                    comments.push([field, val]);
                    return;
                }
                func = null;
                if (datatype === "composite") {
                    func = process_composite;
                } else if (field === "formats") {
                    func = process_formats;
                } else if (datatype === "rating") {
                    func = process_rating;
                } else if (field === "identifiers") {
                    func = process_identifiers;
                } else if (field === "authors") {
                    func = process_authors;
                } else if (field === "publisher") {
                    func = process_publisher;
                } else if (field === "languages") {
                    func = process_languages;
                } else if (field === "size") {
                    func = process_size;
                } else if (datatype === "datetime") {
                    func = process_datetime;
                } else if (datatype === "series") {
                    func = process_series;
                }
                if (func) {
                    func(field, fm, name, val);
                } else {
                    if (datatype === "text" || datatype === "enumeration") {
                        if (val !== undefined && val !== null) {
                            join = (fm.is_multiple) ? fm.is_multiple.list_to_ui : null;
                            _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({join: join, is_searchable: field})]));
                        }
                    } else if (datatype === "bool") {
                        if (library_data.bools_are_tristate) {
                            v = (val) ? _("Yes") : (val === undefined || val === null) ? "" : _("No");
                        } else {
                            v = (val) ? _("Yes") : _("No");
                        }
                        if (v) {
                            _interpolate_kwargs.call(this, add_row, [field, name, v].concat([_desugar_kwargs({is_searchable: field, use_quotes: false})]));
                        }
                    } else if (datatype === "int" || datatype === "float") {
                        if (val !== undefined && val !== null) {
                            fmt = (fm.display || Object.create(null)).number_format;
                            if (fmt) {
                                formatted_val = fmt.format(val);
                                if (formatted_val) {
                                    val += "";
                                    _interpolate_kwargs.call(this, add_row, [field, name, formatted_val].concat([_desugar_kwargs({is_searchable: field, search_text: val})]));
                                }
                            } else {
                                val += "";
                                _interpolate_kwargs.call(this, add_row, [field, name, val].concat([_desugar_kwargs({is_searchable: field, search_text: val})]));
                            }
                        }
                    }
                }
            };
            if (!process_field.__argnames__) Object.defineProperties(process_field, {
                __argnames__ : {value: ["field", "fm"]},
                __module__ : {value: "book_list.book_details"}
            });

            var _Iter9 = _Iterable(fields);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                field = _Iter9[_Index9];
                fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
                if (!fm) {
                    continue;
                }
                try {
                    process_field(field, fm);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        print("Failed to render metadata field: " + field);
                        traceback.print_exc();
                    } else {
                        throw _Exception;
                    }
                }
            }
            all_html = "";
            var _Iter10 = _Iterable(comments);
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                _unpack = _Iter10[_Index10];
                field = _unpack[0];
                comment = _unpack[1];
                if (comment) {
                    fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
                    if (_exists.d(fm.display).heading_position === "above") {
                        name = fm.name || field;
                        all_html += "<h3>" + _str.format("{}", name) + "</h3>";
                    }
                    all_html += comment;
                }
            }
            iframe = adjusting_sandboxed_html(all_html, iframe_css);
            iframe.style.marginTop = "2ex";
            table.parentNode.appendChild(iframe);
        };
        if (!render_metadata.__argnames__) Object.defineProperties(render_metadata, {
            __argnames__ : {value: ["mi", "table", "book_id", "iframe_css"]},
            __module__ : {value: "book_list.book_details"}
        });

        function basic_table_rules(sel) {
            var style;
            style = "";
            style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata td"].concat([_desugar_kwargs({vertical_align: "top"})]));
            style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata td:first-of-type"].concat([_desugar_kwargs({font_style: "italic", color: "var(--calibre-color-faded-text)", padding_right: "0.5em", white_space: "nowrap", text_align: "right"})]));
            style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata td:last-of-type"].concat([_desugar_kwargs({overflow_wrap: "break-word"})]));
            return style;
        };
        if (!basic_table_rules.__argnames__) Object.defineProperties(basic_table_rules, {
            __argnames__ : {value: ["sel"]},
            __module__ : {value: "book_list.book_details"}
        });

        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME + " ";
                style = basic_table_rules(sel);
                style += _interpolate_kwargs.call(this, build_rule, [sel + " .next-book-button:hover"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                sel = "." + SEARCH_INTERNET_CLASS;
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin: "1ex 1em"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " ul > li"].concat([_desugar_kwargs({list_style_type: "none"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " ul > li > a"].concat([_desugar_kwargs({padding: "2ex 1em", display: "block", width: "100%"})]));
                sel = "." + COPY_TO_LIBRARY_CLASS;
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin: "1ex 1em"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.book_details"}
            });
            return _anonfunc;
        })());
        current_fetch = null;
        function no_book(container) {
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("No book found")].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
        };
        if (!no_book.__argnames__) Object.defineProperties(no_book, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.book_details"}
        });

        function on_img_err(err) {
            var img;
            img = err.target;
            if (img.parentNode) {
                img.parentNode.style.display = "none";
            }
        };
        if (!on_img_err.__argnames__) Object.defineProperties(on_img_err, {
            __argnames__ : {value: ["err"]},
            __module__ : {value: "book_list.book_details"}
        });

        function preferred_format(book_id, for_download) {
            var interface_data;
            interface_data = get_interface_data();
            return get_preferred_format(book_metadata(book_id), interface_data.output_format, interface_data.input_formats, for_download);
        };
        if (!preferred_format.__argnames__) Object.defineProperties(preferred_format, {
            __argnames__ : {value: ["book_id", "for_download"]},
            __module__ : {value: "book_list.book_details"}
        });

        function read_format(book_id, fmt) {
            open_book(book_id, fmt);
        };
        if (!read_format.__argnames__) Object.defineProperties(read_format, {
            __argnames__ : {value: ["book_id", "fmt"]},
            __module__ : {value: "book_list.book_details"}
        });

        function read_book(book_id) {
            var fmt;
            fmt = preferred_format(book_id);
            if (fmt && fmt.lower() === "pdf") {
                window.open(download_url(book_id, fmt, "inline"), "_blank");
            } else {
                read_format(book_id, fmt);
            }
        };
        if (!read_book.__argnames__) Object.defineProperties(read_book, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function download_format(book_id, fmt) {
            window.location = download_url(book_id, fmt);
        };
        if (!download_format.__argnames__) Object.defineProperties(download_format, {
            __argnames__ : {value: ["book_id", "fmt"]},
            __module__ : {value: "book_list.book_details"}
        });

        function download_book(book_id) {
            var fmt;
            fmt = preferred_format(book_id, true);
            download_format(book_id, fmt);
        };
        if (!download_book.__argnames__) Object.defineProperties(download_book, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function next_book(book_id, delta) {
            var next_book_id, q;
            next_book_id = book_after(book_id, delta);
            if (next_book_id) {
                q = parse_url_params();
                q.book_id = next_book_id + "";
                _interpolate_kwargs.call(this, show_panel, ["book_details"].concat([_desugar_kwargs({query: q, replace: true})]));
            }
        };
        if (!next_book.__argnames__) Object.defineProperties(next_book, {
            __argnames__ : {value: ["book_id", "delta"]},
            __module__ : {value: "book_list.book_details"}
        });

        function render_book(container_id, book_id) {
            var is_random, c, metadata, authors, alt, border_radius, button_style, imgdiv, img, container, read_button, fmt, download_button, row, md, table;
            render_book.book_id = book_id;
            render_book.container_id = container_id;
            is_random = parse_url_params().book_id === "0";
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            install_touch_handlers(c, book_id);
            metadata = book_metadata(book_id);
            render_book.title = metadata.title;
            set_title(c, metadata.title);
            authors = (metadata.authors) ? metadata.authors.join(" & ") : _("Unknown");
            alt = _("{} by {}\n\nClick to read").format(metadata.title, authors);
            border_radius = 20;
            button_style = "cursor: pointer; border-radius: " + _str.format("{}", Math.floor(border_radius / 5)) + "px;";
            button_style += "color: #ccc; background-color:rgba(0, 0, 0, 0.75);";
            button_style += "display: flex; justify-content: center; align-items: center; padding: 2px;";
            if (is_random) {
                button_style += "display: none;";
            }
            function prev_next_button(is_prev) {
                var delta, nbid, s;
                delta = (is_prev) ? -1 : 1;
                nbid = book_after(book_id, delta);
                s = button_style;
                if (!nbid || nbid === book_id) {
                    s += "; display: none";
                }
                return _interpolate_kwargs.call(E, E.div, [svgicon((is_prev) ? "chevron-left" : "chevron-right")].concat([_desugar_kwargs({style: s, title: (is_prev) ? _("Previous book [Ctrl+Left]") : _("Next book [Ctrl+Right]"), class_: "next-book-button", onclick: next_book.bind(null, book_id, delta)})]));
            };
            if (!prev_next_button.__argnames__) Object.defineProperties(prev_next_button, {
                __argnames__ : {value: ["is_prev"]},
                __module__ : {value: "book_list.book_details"}
            });

            imgdiv = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.img, [_desugar_kwargs({alt: alt, title: alt, data_title: metadata.title, data_authors: authors, onclick: read_book.bind(null, book_id), style: "cursor: pointer; border-radius: 20px; max-width: calc(100vw - 2em); max-height: calc(100vh - 4ex - {}); display: block; width:auto; height:auto; border-radius: {}px".format(get_font_size("title"), border_radius)})]), _interpolate_kwargs.call(E, E.div, [prev_next_button(true), prev_next_button()].concat([_desugar_kwargs({style: "position: absolute; top:0; width: 100%; padding: " + _str.format("{}", Math.floor(border_radius / 2)) + "px; box-sizing: border-box; font-size: 2rem; display: flex; justify-content: space-between; color: " + _str.format("{}", get_color("button-text")) + ""})]))].concat([_desugar_kwargs({style: "position: relative"})]));
            img = imgdiv.getElementsByTagName("img")[0];
            img.onerror = on_img_err;
            img.src = cover_url(book_id);
            c = c.lastChild;
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-right: 1em; flex-grow: 3; max-width: 500px", data_book_id: "" + book_id})]), imgdiv].concat([_desugar_kwargs({style: "display:flex; padding: 1ex 1em; align-items: flex-start; justify-content: flex-start; flex-wrap: wrap"})])));
            container = c.lastChild.firstChild;
            read_button = create_button(_("Read"), "book", read_book.bind(null, book_id), _("Read this book [V]"));
            fmt = preferred_format(book_id, true);
            download_button = _interpolate_kwargs.call(this, create_button, [_("Download"), "cloud-download", download_url(book_id, fmt), _("Download this book in the {0} format ({1})").format(fmt, human_readable((_expr_temp = metadata.format_sizes)[(typeof fmt === "number" && fmt < 0) ? _expr_temp.length + fmt : fmt] || 0))].concat([_desugar_kwargs({download_filename: "" + _str.format("{}", metadata.title) + "." + _str.format("{}", fmt.toLowerCase()) + ""})]));
            row = _interpolate_kwargs.call(E, E.div, [read_button, "", download_button].concat([_desugar_kwargs({style: "margin-bottom: 1ex"})]));
            if (!metadata.formats || !metadata.formats.length) {
                row.style.display = "none";
            }
            container.appendChild(row);
            md = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-bottom: 2ex"})]);
            table = _interpolate_kwargs.call(E, E.table, [_desugar_kwargs({class_: "metadata"})]);
            container.appendChild(md);
            md.appendChild(table);
            render_metadata(metadata, table, book_id);
        };
        if (!render_book.__argnames__) Object.defineProperties(render_book, {
            __argnames__ : {value: ["container_id", "book_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function add_top_bar_buttons(container_id) {
            var container, book_id;
            container = document.getElementById(container_id);
            if (container) {
                clear_buttons(container);
                _interpolate_kwargs.call(this, add_button, [container, "convert"].concat([_desugar_kwargs({action: convert_book, tooltip: _("Convert this book to another format [C]")})]));
                _interpolate_kwargs.call(this, add_button, [container, "edit"].concat([_desugar_kwargs({action: edit_metadata, tooltip: _("Edit the metadata for this book [E]")})]));
                _interpolate_kwargs.call(this, add_button, [container, "trash"].concat([_desugar_kwargs({action: delete_book, tooltip: _("Delete this book")})]));
                book_id = parse_url_params().book_id;
                if (book_id === "0") {
                    _interpolate_kwargs.call(this, add_button, [container, "random"].concat([_desugar_kwargs({tooltip: _("Show a random book"), action: (function() {
                        var _anonfunc = function () {
                            fetch_metadata(container_id, 0, proceed_after_succesful_fetch_metadata);
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "book_list.book_details"}
                        });
                        return _anonfunc;
                    })()})]));
                }
                _interpolate_kwargs.call(this, add_button, [container, "ellipsis-v"].concat([_desugar_kwargs({action: show_subsequent_panel.bind(null, "more_actions"), tooltip: _("More actions")})]));
            }
        };
        if (!add_top_bar_buttons.__argnames__) Object.defineProperties(add_top_bar_buttons, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function proceed_after_succesful_fetch_metadata(container_id, book_id) {
            render_book(container_id, book_id);
            add_top_bar_buttons(container_id);
        };
        if (!proceed_after_succesful_fetch_metadata.__argnames__) Object.defineProperties(proceed_after_succesful_fetch_metadata, {
            __argnames__ : {value: ["container_id", "book_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function metadata_fetched(container_id, book_id, proceed, end_type, xhr, event) {
            var c, data;
            if (current_fetch === null || current_fetch !== xhr) {
                return;
            }
            current_fetch = null;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            c = c.lastChild;
            if (end_type === "load") {
                try {
                    data = JSON.parse(xhr.responseText);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        var err = _Exception;
                        error_dialog(_("Could not fetch metadata for book"), _("Server returned an invalid response"), err.toString());
                        return;
                    } else {
                        throw _Exception;
                    }
                }
                clear(c);
                book_id = int(data["id"]);
                set_book_metadata(book_id, data);
                proceed(container_id, book_id);
            } else if (end_type !== "abort") {
                clear(c);
                c.appendChild(_interpolate_kwargs.call(E, E.div, [_("Could not fetch metadata for book"), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 1ex 1em"})])].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
                safe_set_inner_html(c.lastChild.lastChild, xhr.error_html);
            }
        };
        if (!metadata_fetched.__argnames__) Object.defineProperties(metadata_fetched, {
            __argnames__ : {value: ["container_id", "book_id", "proceed", "end_type", "xhr", "event"]},
            __module__ : {value: "book_list.book_details"}
        });

        function fetch_metadata(container_id, book_id, proceed) {
            var container;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            if (current_fetch) {
                current_fetch.abort();
            }
            current_fetch = _interpolate_kwargs.call(this, ajax, ["interface-data/book-metadata/" + book_id, metadata_fetched.bind(null, container_id, book_id, proceed)].concat([_desugar_kwargs({query: (function(){
                var _d = Object.create(null);
                _d["library_id"] = current_library_id();
                _d["vl"] = current_virtual_library();
                return _d;
            }).call(this)})]));
            current_fetch.send();
            container = container.lastChild;
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [create_spinner(), "" + _("Fetching metadata for the book, please wait") + ""].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
        };
        if (!fetch_metadata.__argnames__) Object.defineProperties(fetch_metadata, {
            __argnames__ : {value: ["container_id", "book_id", "proceed"]},
            __module__ : {value: "book_list.book_details"}
        });

        function install_touch_handlers(container, book_id) {
            var ongoing_touches, gesture_id, container_id;
            ongoing_touches = Object.create(null);
            gesture_id = 0;
            container_id = container.id;
            function has_active_touches() {
                var t, tid;
                var _Iter11 = _Iterable(ongoing_touches);
                for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                    tid = _Iter11[_Index11];
                    t = ongoing_touches[(typeof tid === "number" && tid < 0) ? ongoing_touches.length + tid : tid];
                    if (t.active) {
                        return true;
                    }
                }
                return false;
            };
            if (!has_active_touches.__module__) Object.defineProperties(has_active_touches, {
                __module__ : {value: "book_list.book_details"}
            });

            function handle_touch(ev) {
                var container, touch, t, touches, num, gesture, delta;
                container = document.getElementById(container_id);
                if (!container) {
                    return;
                }
                if (ev.type === "touchstart") {
                    var _Iter12 = _Iterable(ev.changedTouches);
                    for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                        touch = _Iter12[_Index12];
                        ongoing_touches[_bound_index(touch_id(touch), ongoing_touches)] = copy_touch(touch);
                        gesture_id += 1;
                    }
                } else if (ev.type === "touchmove") {
                    var _Iter13 = _Iterable(ev.changedTouches);
                    for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                        touch = _Iter13[_Index13];
                        t = ongoing_touches[_bound_index(touch_id(touch), ongoing_touches)];
                        if (t) {
                            update_touch(t, touch);
                        }
                    }
                } else if (ev.type === "touchcancel") {
                    var _Iter14 = _Iterable(ev.changedTouches);
                    for (var _Index14 = 0; _Index14 < _Iter14.length; _Index14++) {
                        touch = _Iter14[_Index14];
                        delete ongoing_touches[touch_id(touch)];
                    }
                } else if (ev.type === "touchend") {
                    var _Iter15 = _Iterable(ev.changedTouches);
                    for (var _Index15 = 0; _Index15 < _Iter15.length; _Index15++) {
                        touch = _Iter15[_Index15];
                        t = ongoing_touches[_bound_index(touch_id(touch), ongoing_touches)];
                        if (t) {
                            t.active = false;
                            update_touch(t, touch);
                            if (!has_active_touches()) {
                                touches = ongoing_touches;
                                ongoing_touches = Object.create(null);
                                num = len(touches);
                                if (num === 1) {
                                    gesture = interpret_single_gesture(touches[_bound_index(Object.keys(touches)[0], touches)], gesture_id);
                                    if (gesture.type === "swipe" && gesture.axis === "horizontal") {
                                        delta = (gesture.direction === "right") ? -1 : 1;
                                        next_book(book_id, delta);
                                    }
                                }
                            }
                        }
                    }
                }
            };
            if (!handle_touch.__argnames__) Object.defineProperties(handle_touch, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "book_list.book_details"}
            });

            install_handlers(container, (function(){
                var _d = Object.create(null);
                _d["handle_touchstart"] = handle_touch;
                _d["handle_touchmove"] = handle_touch;
                _d["handle_touchend"] = handle_touch;
                _d["handle_touchcancel"] = handle_touch;
                return _d;
            }).call(this), true);
        };
        if (!install_touch_handlers.__argnames__) Object.defineProperties(install_touch_handlers, {
            __argnames__ : {value: ["container", "book_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function create_book_details(container) {
            var q, current_book_id, container_id;
            q = parse_url_params();
            current_book_id = q.book_id;
            if (current_book_id === undefined || current_book_id === null) {
                no_book(container);
                return;
            }
            current_book_id = int(current_book_id);
            container_id = container.parentNode.id;
            if (current_book_id !== 0 && book_metadata(current_book_id)) {
                render_book(container_id, current_book_id);
                add_top_bar_buttons(container_id);
            } else {
                fetch_metadata(container_id, current_book_id, proceed_after_succesful_fetch_metadata);
            }
        };
        if (!create_book_details.__argnames__) Object.defineProperties(create_book_details, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.book_details"}
        });

        function report_load_failure(container) {
            report_a_load_failure(container, _("Failed to load books from calibre library, with error:"), load_status.error_html);
        };
        if (!report_load_failure.__argnames__) Object.defineProperties(report_load_failure, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.book_details"}
        });

        function check_for_books_loaded() {
            var container;
            container = this;
            if (load_status.loading) {
                conditional_timeout(container.id, 5, check_for_books_loaded);
                return;
            }
            container = container.lastChild;
            clear(container);
            if (!load_status.ok) {
                report_load_failure(container);
                return;
            }
            create_book_details(container);
        };
        if (!check_for_books_loaded.__module__) Object.defineProperties(check_for_books_loaded, {
            __module__ : {value: "book_list.book_details"}
        });

        function onkeydown(container_id, close_action, ev) {
            if (render_book.book_id) {
                if (ev.ctrlKey) {
                    if (ev.key === "ArrowLeft") {
                        next_book(render_book.book_id, -1);
                        [ev.preventDefault(), ev.stopPropagation()];
                    } else if (ev.key === "ArrowRight") {
                        next_book(render_book.book_id, 1);
                        [ev.preventDefault(), ev.stopPropagation()];
                    }
                } else if (!ev.ctrlKey && !ev.metaKey && !ev.shiftKey) {
                    if (ev.key === "Escape") {
                        [ev.preventDefault(), ev.stopPropagation()];
                        close_action();
                    } else if (ev.key === "Delete") {
                        [ev.preventDefault(), ev.stopPropagation()];
                        delete_book();
                    } else if (ev.key === "v" || ev.key === "V") {
                        read_book(render_book.book_id);
                    } else if (ev.key === "c" || ev.key === "C") {
                        convert_book();
                    } else if (ev.key === "e" || ev.key === "E") {
                        edit_metadata();
                    }
                }
            }
        };
        if (!onkeydown.__argnames__) Object.defineProperties(onkeydown, {
            __argnames__ : {value: ["container_id", "close_action", "ev"]},
            __module__ : {value: "book_list.book_details"}
        });

        function init(container_id) {
            var container, _unpack, close_action, close_icon, q, ca;
            container = document.getElementById(container_id);
            _unpack = [back, "close"];
            close_action = _unpack[0];
            close_icon = _unpack[1];
            q = parse_url_params();
            ca = q.close_action;
            if (ca === "home") {
                _unpack = [(function() {
                    var _anonfunc = function () {
                        home();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.book_details"}
                    });
                    return _anonfunc;
                })(), "home"];
                close_action = _unpack[0];
                close_icon = _unpack[1];
            } else if (ca === "book_list") {
                close_action = (function() {
                    var _anonfunc = function () {
                        show_panel("book_list", (function(){
                            var _d = Object.create(null);
                            _d["book_id"] = q.book_id;
                            return _d;
                        }).call(this));
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.book_details"}
                    });
                    return _anonfunc;
                })();
            }
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Book details"), action: close_action, icon: close_icon})]));
            window.scrollTo(0, 0);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME, tabindex: "0"})]));
            container.lastChild.addEventListener("keydown", onkeydown.bind(null, container_id, close_action), (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                _d["capture"] = true;
                return _d;
            }).call(this));
            container.lastChild.focus();
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading books from the calibre library, please wait...")].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
            conditional_timeout(container_id, 5, check_for_books_loaded);
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function show_subsequent_panel() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var replace = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_subsequent_panel.__defaults__.replace : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "replace")){
                replace = _kwargs_obj.replace;
            }
            var q;
            q = parse_url_params();
            q.book_id = (render_book.book_id || q.book_id) + "";
            _interpolate_kwargs.call(this, show_panel, ["book_details^" + name].concat([_desugar_kwargs({query: q, replace: replace})]));
        };
        if (!show_subsequent_panel.__defaults__) Object.defineProperties(show_subsequent_panel, {
            __defaults__ : {value: {replace:false}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "replace"]},
            __module__ : {value: "book_list.book_details"}
        });

        function edit_metadata() {
            var q;
            q = parse_url_params();
            q.book_id = (render_book.book_id || q.book_id) + "";
            _interpolate_kwargs.call(this, show_panel, ["edit_metadata"].concat([_desugar_kwargs({query: q, replace: false})]));
        };
        if (!edit_metadata.__module__) Object.defineProperties(edit_metadata, {
            __module__ : {value: "book_list.book_details"}
        });

        function convert_book() {
            var q;
            q = parse_url_params();
            q.book_id = (render_book.book_id || q.book_id) + "";
            _interpolate_kwargs.call(this, show_panel, ["convert_book"].concat([_desugar_kwargs({query: q, replace: false})]));
        };
        if (!convert_book.__module__) Object.defineProperties(convert_book, {
            __module__ : {value: "book_list.book_details"}
        });

        function create_more_actions_panel(container_id) {
            var container, _unpack, title, subtitle, items;
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("More actions"), action: back, icon: "close"})]));
            if (get_session_data().get("show_all_metadata")) {
                _unpack = [_("Show important metadata"), _("Show only the important metadata fields in the book details")];
                title = _unpack[0];
                subtitle = _unpack[1];
            } else {
                _unpack = [_("Show all metadata"), _("Show all metadata fields in the book details")];
                title = _unpack[0];
                subtitle = _unpack[1];
            }
            items = _list_decorate([ _interpolate_kwargs.call(this, create_item, [_("Search the internet")].concat([_desugar_kwargs({subtitle: _("Search for this author or book on various websites"), action: (function() {
                var _anonfunc = function () {
                    _interpolate_kwargs.call(this, show_subsequent_panel, ["search_internet"].concat([_desugar_kwargs({replace: true})]));
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.book_details"}
                });
                return _anonfunc;
            })()})])), _interpolate_kwargs.call(this, create_item, [title].concat([_desugar_kwargs({subtitle: subtitle, action: toggle_fields})])), _interpolate_kwargs.call(this, create_item, [_("Copy to library")].concat([_desugar_kwargs({subtitle: _("Copy or move this book to another calibre library"), action: (function() {
                var _anonfunc = function () {
                    _interpolate_kwargs.call(this, show_subsequent_panel, ["copy_to_library"].concat([_desugar_kwargs({replace: true})]));
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.book_details"}
                });
                return _anonfunc;
            })()})])) ]);
            container.appendChild(E.div());
            create_item_list(container.lastChild, items);
        };
        if (!create_more_actions_panel.__argnames__) Object.defineProperties(create_more_actions_panel, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function return_to_book_details() {
            var q;
            q = parse_url_params();
            _interpolate_kwargs.call(this, show_panel, ["book_details"].concat([_desugar_kwargs({query: q, replace: true})]));
        };
        if (!return_to_book_details.__module__) Object.defineProperties(return_to_book_details, {
            __module__ : {value: "book_list.book_details"}
        });

        function toggle_fields() {
            var sd;
            sd = get_session_data();
            sd.set("show_all_metadata", (sd.get("show_all_metadata")) ? false : true);
            return_to_book_details();
        };
        if (!toggle_fields.__module__) Object.defineProperties(toggle_fields, {
            __module__ : {value: "book_list.book_details"}
        });

        function url_for(template, data) {
            function eqc(x) {
                return encode_query_component(x).replace(/%20/g, "+");
            };
            if (!eqc.__argnames__) Object.defineProperties(eqc, {
                __argnames__ : {value: ["x"]},
                __module__ : {value: "book_list.book_details"}
            });

            return _interpolate_kwargs.call(template, template.format, [_desugar_kwargs({title: eqc(data.title), author: eqc(data.author)})]);
        };
        if (!url_for.__argnames__) Object.defineProperties(url_for, {
            __argnames__ : {value: ["template", "data"]},
            __module__ : {value: "book_list.book_details"}
        });

        function search_internet(container_id) {
            var container, mi, data, interface_data, author_links, book_links, links, entry, _unpack, name, url;
            if (!render_book.book_id || !book_metadata(render_book.book_id)) {
                return return_to_book_details();
            }
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Search the internet"), action: back, icon: "close"})]));
            mi = book_metadata(render_book.book_id);
            data = (function(){
                var _d = Object.create(null);
                _d["title"] = mi.title;
                _d["author"] = (mi.authors) ? mi.authors[0] : _("Unknown");
                return _d;
            }).call(this);
            interface_data = get_interface_data();
            function link_for(name, template) {
                return _interpolate_kwargs.call(E, E.a, [name].concat([_desugar_kwargs({class_: "simple-link", href: url_for(template, data), target: "_blank"})]));
            };
            if (!link_for.__argnames__) Object.defineProperties(link_for, {
                __argnames__ : {value: ["name", "template"]},
                __module__ : {value: "book_list.book_details"}
            });

            author_links = E.ul();
            book_links = E.ul();
            if (interface_data.search_the_net_urls) {
                var _Iter16 = _Iterable(interface_data.search_the_net_urls);
                for (var _Index16 = 0; _Index16 < _Iter16.length; _Index16++) {
                    entry = _Iter16[_Index16];
                    links = (entry.type === "book") ? book_links : author_links;
                    links.appendChild(E.li(link_for(entry.name, entry.url)));
                }
            }
            var _Iter17 = _Iterable(_list_decorate([ [_("Goodreads"), "https://www.goodreads.com/book/author/{author}"], [_("Wikipedia"), 
            "https://en.wikipedia.org/w/index.php?search={author}"], [_("Google Books"), "https://www.google.com/search?tbm=bks&q=inauthor:%22{author}%22"] ]));
            for (var _Index17 = 0; _Index17 < _Iter17.length; _Index17++) {
                _unpack = _Iter17[_Index17];
                name = _unpack[0];
                url = _unpack[1];
                author_links.appendChild(E.li(link_for(name, url)));
            }
            var _Iter18 = _Iterable(_list_decorate([ [_("Goodreads"), "https://www.goodreads.com/search?q={author}+{title}&search%5Bsource%5D=goodreads&search_type=books&tab=books"], [_("Google Books"), 
            "https://www.google.com/search?tbm=bks&q=inauthor:%22{author}%22+intitle:%22{title}%22"], [_("Amazon"), 
            "https://www.amazon.com/s/ref=nb_sb_noss?url=search-alias%3Dstripbooks&field-keywords={author}+{title}"] ]));
            for (var _Index18 = 0; _Index18 < _Iter18.length; _Index18++) {
                _unpack = _Iter18[_Index18];
                name = _unpack[0];
                url = _unpack[1];
                book_links.appendChild(E.li(link_for(name, url)));
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [safe_set_inner_html(E.h2(), _("Search for the author <i>{}</i> at:").format(data.author)), author_links, E.hr(), safe_set_inner_html(E.h2(), _("Search for the book <i>{}</i> at:").format(data.title)), book_links].concat([_desugar_kwargs({class_: SEARCH_INTERNET_CLASS})])));
        };
        if (!search_internet.__argnames__) Object.defineProperties(search_internet, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function do_copy_to_library(book_id, target_library_id, target_library_name) {
            var title, dupes_id, sd, saved_value;
            function handle_result(move, close_func, end_type, xhr, ev) {
                var title, response;
                close_func();
                title = book_metadata(book_id).title;
                return_to_book_details();
                if (end_type === "abort") {
                    return;
                }
                if (end_type !== "load") {
                    error_dialog(_("Failed to copy book"), _("Failed to copy the book \"{}\". Click \"Show details\" for more information.").format(title), xhr.error_html);
                    return;
                }
                try {
                    response = (_expr_temp = JSON.parse(xhr.responseText))[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id];
                    if (!response) {
                        throw new Exception("bad");
                    }
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        error_dialog(_("Failed to copy book"), _("Failed to copy the book \"{}\" because of an invalid response from calibre").format(title));
                        return;
                    } 
                }
                if (!response.ok) {
                    error_dialog(_("Failed to copy book"), _("Failed to copy the book \"{}\". Click \"Show details\" for more information.").format(title), response.payload);
                    return;
                }
                if (response.action === "duplicate") {
                    warning_dialog(_("Book already exists"), _("Could not copy as a book with the same title and authors already exists in the {} library").format(target_library_name));
                } else if (response.action === "automerge") {
                    warning_dialog(_("Book merged"), _("The files from the book were merged into a book with the same title and authors in the {} library").format(target_library_name));
                }
                if (move) {
                    refresh_after_delete(book_id, current_library_id());
                }
            };
            if (!handle_result.__argnames__) Object.defineProperties(handle_result, {
                __argnames__ : {value: ["move", "close_func", "end_type", "xhr", "ev"]},
                __module__ : {value: "book_list.book_details"}
            });

            function trigger_copy(container_id, move, close_func) {
                var choice, _unpack, duplicate_action, automerge_action, data, container;
                try {
                    choice = document.querySelector("#" + _str.format("{}", dupes_id) + " input[name=\"dupes\"]:checked").value;
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        choice = document.querySelector("#" + _str.format("{}", dupes_id) + " input[name=\"dupes\"]").value;
                    } 
                }
                sd.set("copy_to_library_dupes", choice);
                _unpack = choice.split(";", 2);
_unpack = _unpack_asarray(2, _unpack);
                duplicate_action = _unpack[0];
                automerge_action = _unpack[1];
                data = (function(){
                    var _d = Object.create(null);
                    _d["book_ids"] = [book_id];
                    _d["move"] = move;
                    _d["duplicate_action"] = duplicate_action;
                    _d["automerge_action"] = automerge_action;
                    return _d;
                }).call(this);
                container = document.getElementById(container_id);
                clear(container);
                container.appendChild(E.div(_("Contacting calibre to copy book, please wait...")));
                ajax_send("cdb/copy-to-library/" + _str.format("{}", target_library_id) + "/" + _str.format("{}", current_library_id()) + "", data, handle_result.bind(null, move, close_func));
            };
            if (!trigger_copy.__argnames__) Object.defineProperties(trigger_copy, {
                __argnames__ : {value: ["container_id", "move", "close_func"]},
                __module__ : {value: "book_list.book_details"}
            });

            function radio(value, text) {
                return _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "dupes", value: value, checked: value === saved_value})]), "", E.span(text)].concat([_desugar_kwargs({style: "margin-top: 1rem"})]));
            };
            if (!radio.__argnames__) Object.defineProperties(radio, {
                __argnames__ : {value: ["value", "text"]},
                __module__ : {value: "book_list.book_details"}
            });

            title = book_metadata(book_id).title;
            dupes_id = unique_id();
            sd = get_session_data();
            saved_value = sd.get("copy_to_library_dupes");
            create_custom_dialog((_expr_temp = _("Copy book to \"{target_library_name}\""), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({target_library_name: target_library_name})])), (function() {
                var _anonfunc = function (container, close_func) {
                    var container_id;
                    container_id = ensure_id(container);
                    container.appendChild(E.div(E.div(_("Copying: {}").format(title)), _interpolate_kwargs.call(E, E.div, [E.p(_("If there are already existing books in \"{}\" with the same title and authors, how would you like to handle them?").format(target_library_name)), radio("add;overwrite", _("Copy anyway")), radio("ignore;overwrite", _("Do not copy")), radio("add_formats_to_existing;overwrite", _("Merge into existing books, overwriting existing files")), radio("add_formats_to_existing;ignore", _("Merge into existing books, keeping existing files")), radio("add_formats_to_existing;new record", _("Merge into existing books, putting conflicting files into a new book record"))].concat([_desugar_kwargs({id: dupes_id})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Copy"), null, trigger_copy.bind(null, container_id, false, close_func)].concat([_desugar_kwargs({highlight: true})])), "", create_button(_("Move"), null, trigger_copy.bind(null, container_id, true, close_func)), "", create_button(_("Cancel"), null, close_func)].concat([_desugar_kwargs({class_: "button-box"})]))));
                    if (!container.querySelector("#" + _str.format("{}", dupes_id) + " input[name=\"dupes\"]:checked")) {
                        container.querySelector("#" + _str.format("{}", dupes_id) + " input[name=\"dupes\"]").checked = true;
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["container", "close_func"]},
                    __module__ : {value: "book_list.book_details"}
                });
                return _anonfunc;
            })());
        };
        if (!do_copy_to_library.__argnames__) Object.defineProperties(do_copy_to_library, {
            __argnames__ : {value: ["book_id", "target_library_id", "target_library_name"]},
            __module__ : {value: "book_list.book_details"}
        });

        function copy_to_library(container_id) {
            var container, libraries, items, _unpack, library_id, library_name;
            if (!render_book.book_id || !book_metadata(render_book.book_id)) {
                return return_to_book_details();
            }
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Copy to library"), action: back, icon: "close"})]));
            libraries = all_libraries();
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: COPY_TO_LIBRARY_CLASS})]));
            container = container.lastChild;
            if (libraries.length < 2) {
                container.appendChild(E.div(_("There are no other calibre libraries available to copy the book to")));
                return;
            }
            container.appendChild(E.h2(_("Choose the library to copy to below")));
            items = _list_decorate([]);
            var _Iter19 = _Iterable(libraries);
            for (var _Index19 = 0; _Index19 < _Iter19.length; _Index19++) {
                _unpack = _Iter19[_Index19];
                library_id = _unpack[0];
                library_name = _unpack[1];
                if (library_id === current_library_id()) {
                    continue;
                }
                items.push(_interpolate_kwargs.call(this, create_item, [library_name].concat([_desugar_kwargs({action: do_copy_to_library.bind(null, render_book.book_id, library_id, library_name)})])));
            }
            container.appendChild(E.div());
            create_item_list(container.lastChild, items);
        };
        if (!copy_to_library.__argnames__) Object.defineProperties(copy_to_library, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.book_details"}
        });

        function delete_book() {
            start_delete_book(current_library_id(), render_book.book_id, render_book.title || _("Unknown"));
        };
        if (!delete_book.__module__) Object.defineProperties(delete_book, {
            __module__ : {value: "book_list.book_details"}
        });

        set_panel_handler("book_details", init);
        set_panel_handler("book_details^more_actions", create_more_actions_panel);
        set_panel_handler("book_details^search_internet", search_internet);
        set_panel_handler("book_details^copy_to_library", copy_to_library);
        _modules["book_list.book_details"].bd_counter = bd_counter;
        _modules["book_list.book_details"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.book_details"].SEARCH_INTERNET_CLASS = SEARCH_INTERNET_CLASS;
        _modules["book_list.book_details"].COPY_TO_LIBRARY_CLASS = COPY_TO_LIBRARY_CLASS;
        _modules["book_list.book_details"].FORMAT_PRIORITIES = FORMAT_PRIORITIES;
        _modules["book_list.book_details"].IGNORED_FIELDS = IGNORED_FIELDS;
        _modules["book_list.book_details"].default_sort = default_sort;
        _modules["book_list.book_details"]._unpack = _unpack;
        _modules["book_list.book_details"].i = i;
        _modules["book_list.book_details"].f = f;
        _modules["book_list.book_details"].current_fetch = current_fetch;
        _modules["book_list.book_details"].sort_formats_key = sort_formats_key;
        _modules["book_list.book_details"].get_preferred_format = get_preferred_format;
        _modules["book_list.book_details"].field_sorter = field_sorter;
        _modules["book_list.book_details"].href_for_search = href_for_search;
        _modules["book_list.book_details"].on_fmt_click = on_fmt_click;
        _modules["book_list.book_details"].adjust_iframe_height = adjust_iframe_height;
        _modules["book_list.book_details"].setup_iframe = setup_iframe;
        _modules["book_list.book_details"].adjust_all_iframes = adjust_all_iframes;
        _modules["book_list.book_details"].add_stars_to = add_stars_to;
        _modules["book_list.book_details"].adjusting_sandboxed_html = adjusting_sandboxed_html;
        _modules["book_list.book_details"].render_metadata = render_metadata;
        _modules["book_list.book_details"].basic_table_rules = basic_table_rules;
        _modules["book_list.book_details"].no_book = no_book;
        _modules["book_list.book_details"].on_img_err = on_img_err;
        _modules["book_list.book_details"].preferred_format = preferred_format;
        _modules["book_list.book_details"].read_format = read_format;
        _modules["book_list.book_details"].read_book = read_book;
        _modules["book_list.book_details"].download_format = download_format;
        _modules["book_list.book_details"].download_book = download_book;
        _modules["book_list.book_details"].next_book = next_book;
        _modules["book_list.book_details"].render_book = render_book;
        _modules["book_list.book_details"].add_top_bar_buttons = add_top_bar_buttons;
        _modules["book_list.book_details"].proceed_after_succesful_fetch_metadata = proceed_after_succesful_fetch_metadata;
        _modules["book_list.book_details"].metadata_fetched = metadata_fetched;
        _modules["book_list.book_details"].fetch_metadata = fetch_metadata;
        _modules["book_list.book_details"].install_touch_handlers = install_touch_handlers;
        _modules["book_list.book_details"].create_book_details = create_book_details;
        _modules["book_list.book_details"].report_load_failure = report_load_failure;
        _modules["book_list.book_details"].check_for_books_loaded = check_for_books_loaded;
        _modules["book_list.book_details"].onkeydown = onkeydown;
        _modules["book_list.book_details"].init = init;
        _modules["book_list.book_details"].show_subsequent_panel = show_subsequent_panel;
        _modules["book_list.book_details"].edit_metadata = edit_metadata;
        _modules["book_list.book_details"].convert_book = convert_book;
        _modules["book_list.book_details"].create_more_actions_panel = create_more_actions_panel;
        _modules["book_list.book_details"].return_to_book_details = return_to_book_details;
        _modules["book_list.book_details"].toggle_fields = toggle_fields;
        _modules["book_list.book_details"].url_for = url_for;
        _modules["book_list.book_details"].search_internet = search_internet;
        _modules["book_list.book_details"].do_copy_to_library = do_copy_to_library;
        _modules["book_list.book_details"].copy_to_library = copy_to_library;
        _modules["book_list.book_details"].delete_book = delete_book;
    })();

    (function(){
        var __name__ = "read_book.profiles";
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_item = _modules["book_list.item_list"].create_item;
        var create_item_list = _modules["book_list.item_list"].create_item_list;
        var create_side_action = _modules["book_list.item_list"].create_side_action;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var clear = _modules.dom.clear;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var question_dialog = _modules.modals.question_dialog;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var apply_reader_profile = _modules.session.apply_reader_profile;
        var settings_for_reader_profile = _modules.session.settings_for_reader_profile;

        var create_button = _modules.widgets.create_button;

        function save_profile(container_id, hide_panel) {
            var container, name, sd, settings;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            name = container.querySelector("[name=profile_name]").value;
            sd = get_session_data();
            settings = settings_for_reader_profile(sd);
            ui_operations.save_profile(name, settings, (function() {
                var _anonfunc = function () {
                    var container, r;
                    container = document.getElementById(container_id);
                    if (container) {
                        r = container.querySelector(".saved_msg");
                        if (r) {
                            clear(r);
                            r.appendChild(_interpolate_kwargs.call(E, E.div, [E.i(_("Saved: ") + name)].concat([_desugar_kwargs({style: "margin-top: 1rem; margin-bottom: 1rem"})])));
                            load_profiles(container_id);
                        }
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.profiles"}
                });
                return _anonfunc;
            })());
        };
        if (!save_profile.__argnames__) Object.defineProperties(save_profile, {
            __argnames__ : {value: ["container_id", "hide_panel"]},
            __module__ : {value: "read_book.profiles"}
        });

        function use_profile(container_id, profile_name, profile_data) {
            var container, sd;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            sd = get_session_data();
            apply_reader_profile(sd, profile_data);
            if (ui_operations.apply_profile) {
                ui_operations.apply_profile(profile_data);
            }
            container.dispatchEvent(new Event("settings_changed"));
            container.dispatchEvent(new Event("close_panel"));
        };
        if (!use_profile.__argnames__) Object.defineProperties(use_profile, {
            __argnames__ : {value: ["container_id", "profile_name", "profile_data"]},
            __module__ : {value: "read_book.profiles"}
        });

        function delete_profile(container_id, profile_name) {
            question_dialog(_("Are you sure?"), _("Are you sure you want to delete the saved profile named: {}?").format(profile_name), (function() {
                var _anonfunc = function (ok) {
                    if (ok) {
                        ui_operations.save_profile(profile_name, null, (function() {
                            var _anonfunc = function () {
                                load_profiles(container_id);
                            };
                            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                __module__ : {value: "read_book.profiles"}
                            });
                            return _anonfunc;
                        })());
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ok"]},
                    __module__ : {value: "read_book.profiles"}
                });
                return _anonfunc;
            })());
        };
        if (!delete_profile.__argnames__) Object.defineProperties(delete_profile, {
            __argnames__ : {value: ["container_id", "profile_name"]},
            __module__ : {value: "read_book.profiles"}
        });

        function got_all_profiles(container_id, all_profiles) {
            var container, names, pl, items, display_name, side_actions, name;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            all_profiles["__default__"] = Object.create(null);
            names = list_wrap(Object.keys(all_profiles));
            names.pysort((function() {
                var _anonfunc = function (x) {
                    return (x === "__default__") ? "" : x.toLowerCase();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x"]},
                    __module__ : {value: "read_book.profiles"}
                });
                return _anonfunc;
            })());
            pl = container.querySelector(".profiles_list_container");
            clear(pl);
            pl.appendChild(E.div(_("Load settings from one of the previously saved profiles below")));
            pl.appendChild(E.div());
            items = _list_decorate([]);
            var _Iter0 = _Iterable(names);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                name = _Iter0[_Index0];
                display_name = name;
                if (name === "__default__") {
                    display_name = _("Restore settings to default values");
                    side_actions = _list_decorate([]);
                } else {
                    side_actions = _list_decorate([ create_side_action("trash", delete_profile.bind(null, container_id, name), _("Delete this profile")) ]);
                }
                items.push(_interpolate_kwargs.call(this, create_item, [display_name].concat([_desugar_kwargs({action: use_profile.bind(null, container_id, name, all_profiles[(typeof name === "number" && name < 0) ? all_profiles.length + name : name]), side_actions: side_actions})])));
            }
            create_item_list(pl.lastChild, items);
        };
        if (!got_all_profiles.__argnames__) Object.defineProperties(got_all_profiles, {
            __argnames__ : {value: ["container_id", "all_profiles"]},
            __module__ : {value: "read_book.profiles"}
        });

        function load_profiles(container_id) {
            var container, pl;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            pl = container.querySelector(".profiles_list_container");
            clear(pl);
            pl.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading saved profiles, please wait")].concat([_desugar_kwargs({style: "padding-bottom: 1rem"})])));
            ui_operations.get_all_profiles(got_all_profiles.bind(null, container_id));
        };
        if (!load_profiles.__argnames__) Object.defineProperties(load_profiles, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "read_book.profiles"}
        });

        function create_profiles_panel(container, hide_panel, on_change) {
            var c, container_id, a;
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Profiles"), icon: "close", action: hide_panel})]));
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 1rem", id: unique_id("placeholder-prefs")})]);
            c.addEventListener("close_panel", (function() {
                var _anonfunc = function () {
                    hide_panel();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.profiles"}
                });
                return _anonfunc;
            })(), false);
            c.addEventListener("settings_changed", (function() {
                var _anonfunc = function () {
                    on_change();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.profiles"}
                });
                return _anonfunc;
            })(), false);
            container_id = c.id;
            a = _interpolate_kwargs.call(E, E.div, [E.div(E.label(_("Save current settings as profile:") + " "), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "profile_name", placeholder: _("Name of profile"), onkeydown: (function() {
                var _anonfunc = function (e) {
                    if (e.key === "Enter") {
                        save_profile(container_id, hide_panel);
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["e"]},
                    __module__ : {value: "read_book.profiles"}
                });
                return _anonfunc;
            })()})])), E.div(""), E.div(create_button(_("Save"), "bookmark", save_profile.bind(null, container_id, hide_panel)))].concat([_desugar_kwargs({style: "display:flex"})]));
            container.appendChild(c);
            c.appendChild(a);
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "saved_msg"})]));
            c.appendChild(E.hr());
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "profiles_list_container"})]));
            load_profiles(container_id);
        };
        if (!create_profiles_panel.__argnames__) Object.defineProperties(create_profiles_panel, {
            __argnames__ : {value: ["container", "hide_panel", "on_change"]},
            __module__ : {value: "read_book.profiles"}
        });

        _modules["read_book.profiles"].save_profile = save_profile;
        _modules["read_book.profiles"].use_profile = use_profile;
        _modules["read_book.profiles"].delete_profile = delete_profile;
        _modules["read_book.profiles"].got_all_profiles = got_all_profiles;
        _modules["read_book.profiles"].load_profiles = load_profiles;
        _modules["read_book.profiles"].create_profiles_panel = create_profiles_panel;
    })();

    (function(){
        var __name__ = "read_book.prefs.font_size";
        var CONTAINER, MIN_FONT_SIZE, MAX_FONT_SIZE;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var get_color = _modules["book_list.theme"].get_color;

        var add_extra_css = _modules.dom.add_extra_css;
        var rule = _modules.dom.rule;
        var unique_id = _modules.dom.unique_id;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button = _modules.widgets.create_button;

        var session_defaults = _modules.session.session_defaults;

        CONTAINER = unique_id("font-size-prefs");
        MIN_FONT_SIZE = 8;
        MAX_FONT_SIZE = 80;
        add_extra_css((function() {
            var _anonfunc = function () {
                var style;
                style = _interpolate_kwargs.call(this, rule, [CONTAINER, "option.current"].concat([_desugar_kwargs({background_color: get_color("window-background2")})]));
                style += _interpolate_kwargs.call(this, rule, [CONTAINER, "option:hover"].concat([_desugar_kwargs({background_color: get_color("window-background2")})]));
                style += _interpolate_kwargs.call(this, rule, [CONTAINER, "a:hover"].concat([_desugar_kwargs({color: get_color("window-hover-foreground")})]));
                style += _interpolate_kwargs.call(this, rule, [CONTAINER, "a.calibre-push-button:hover"].concat([_desugar_kwargs({color: get_color("button-text")})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.prefs.font_size"}
            });
            return _anonfunc;
        })());
        function change_font_size(sz) {
            var sd;
            sd = get_session_data();
            if (sd.get("base_font_size") !== sz) {
                sd.set("base_font_size", sz);
                ui_operations.update_font_size();
            }
        };
        if (!change_font_size.__argnames__) Object.defineProperties(change_font_size, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function apply_font_size() {
            var fs;
            fs = int(document.getElementById(CONTAINER).dataset.cfs);
            change_font_size(fs);
        };
        if (!apply_font_size.__module__) Object.defineProperties(apply_font_size, {
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function set_quick_size(ev) {
            var newval;
            newval = ev.currentTarget.value;
            try {
                int(newval);
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    return;
                } 
            }
            if (newval !== document.getElementById(CONTAINER).dataset.cfs) {
                display_changed_font_size(newval);
            }
        };
        if (!set_quick_size.__argnames__) Object.defineProperties(set_quick_size, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function change_font_size_by(frac) {
            var sd, sz, amt, nsz;
            sd = get_session_data();
            sz = sd.get("base_font_size");
            amt = sz * frac;
            if (abs(amt) < 1) {
                amt = (amt < 0) ? -1 : 1;
            }
            nsz = int(sz + amt);
            nsz = max(MIN_FONT_SIZE, min(nsz, MAX_FONT_SIZE));
            change_font_size(nsz);
        };
        if (!change_font_size_by.__argnames__) Object.defineProperties(change_font_size_by, {
            __argnames__ : {value: ["frac"]},
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function restore_default_font_size() {
            change_font_size(session_defaults().base_font_size);
        };
        if (!restore_default_font_size.__module__) Object.defineProperties(restore_default_font_size, {
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function display_changed_font_size(sz) {
            var c, option, input;
            sz = max(MIN_FONT_SIZE, min(int(sz), MAX_FONT_SIZE));
            sz += "";
            c = document.getElementById(CONTAINER);
            c.dataset.cfs = sz;
            var _Iter0 = _Iterable(c.querySelectorAll("option"));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                option = _Iter0[_Index0];
                if (option.value === sz) {
                    option.classList.add("current");
                } else {
                    option.classList.remove("current");
                }
            }
            var _Iter1 = _Iterable(c.querySelectorAll("input"));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                input = _Iter1[_Index1];
                input.value = sz;
            }
            c.querySelector(".cfs_preview").style.fontSize = "" + _str.format("{}", sz) + "px";
        };
        if (!display_changed_font_size.__argnames__) Object.defineProperties(display_changed_font_size, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function create_font_size_panel(container, close) {
            var sd, cfs, quick, sz;
            sd = get_session_data();
            cfs = sd.get("base_font_size");
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER, style: "max-width: 500px; width: 80vw; border-radius: 8px; border: solid 1px currentColor; padding:1ex 1rem;", onclick: (function() {
                var _anonfunc = function (ev) {
                    [ev.preventDefault(), ev.stopPropagation()];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.prefs.font_size"}
                });
                return _anonfunc;
            })()})])].concat([_desugar_kwargs({style: "width: 100%; height: 100%; display: flex; justify-content: center; align-items: center"})])));
            container = container.lastChild.lastChild;
            container.style.backgroundColor = get_color("window-background");
            container.dataset.cfs = cfs + "";
            quick = _interpolate_kwargs.call(E, E.datalist, [_desugar_kwargs({style: "display:flex; justify-content:space-around; flex-wrap: wrap; align-items: baseline;"})]);
            container.appendChild(quick);
            var _Iter2 = _Iterable(_list_decorate([ 10, 12, 14, 16, 18, 20, 22 ]));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                sz = _Iter2[_Index2];
                quick.appendChild(_interpolate_kwargs.call(E, E.option, ["Aa"].concat([_desugar_kwargs({title: "{} px".format(sz), class_: (cfs === sz) ? "current" : "", value: sz + "", style: "display: inline-block; font-size:" + _str.format("{}", sz) + "px; padding: 5px; cursor: pointer; border-radius: 4px; margin: 0 0.5rem", onclick: (function() {
                    var _anonfunc = function (ev) {
                        set_quick_size(ev);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.prefs.font_size"}
                    });
                    return _anonfunc;
                })()})])));
            }
            function set_size(ev) {
                var newval, q;
                newval = ev.currentTarget.value;
                try {
                    q = int(newval);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        return;
                    } 
                }
                if (MIN_FONT_SIZE <= q && q <= MAX_FONT_SIZE) {
                    set_quick_size(ev);
                }
            };
            if (!set_size.__argnames__) Object.defineProperties(set_size, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "read_book.prefs.font_size"}
            });

            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "range", min: MIN_FONT_SIZE + "", max: MAX_FONT_SIZE + "", value: cfs + "", style: "flex-grow: 4", oninput: set_quick_size})]), E.span("", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({value: "" + _str.format("{}", cfs) + "", oninput: set_size, type: "number", min: MIN_FONT_SIZE + "", max: MAX_FONT_SIZE + "", step: "1", style: "width: 3em"})]), "px")].concat([_desugar_kwargs({style: "display: flex; margin-top: 1rem"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_("Sample to preview font size")].concat([_desugar_kwargs({class_: "cfs_preview"})]))].concat([_desugar_kwargs({style: "font-size: " + _str.format("{}", cfs) + "px; margin-top: 1rem; min-height: 60px; max-height: 60px; overflow: hidden; display: flex;"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({highlight: true, action: (function() {
                var _anonfunc = function () {
                    apply_font_size();
                    close();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.prefs.font_size"}
                });
                return _anonfunc;
            })()})])), "", _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: close})]))].concat([_desugar_kwargs({style: "margin-top: 1rem; text-align: right"})])));
        };
        if (!create_font_size_panel.__argnames__) Object.defineProperties(create_font_size_panel, {
            __argnames__ : {value: ["container", "close"]},
            __module__ : {value: "read_book.prefs.font_size"}
        });

        function develop(container) {
            create_font_size_panel(container, (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.prefs.font_size"}
                });
                return _anonfunc;
            })());
        };
        if (!develop.__argnames__) Object.defineProperties(develop, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.font_size"}
        });

        _modules["read_book.prefs.font_size"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.font_size"].MIN_FONT_SIZE = MIN_FONT_SIZE;
        _modules["read_book.prefs.font_size"].MAX_FONT_SIZE = MAX_FONT_SIZE;
        _modules["read_book.prefs.font_size"].change_font_size = change_font_size;
        _modules["read_book.prefs.font_size"].apply_font_size = apply_font_size;
        _modules["read_book.prefs.font_size"].set_quick_size = set_quick_size;
        _modules["read_book.prefs.font_size"].change_font_size_by = change_font_size_by;
        _modules["read_book.prefs.font_size"].restore_default_font_size = restore_default_font_size;
        _modules["read_book.prefs.font_size"].display_changed_font_size = display_changed_font_size;
        _modules["read_book.prefs.font_size"].create_font_size_panel = create_font_size_panel;
        _modules["read_book.prefs.font_size"].develop = develop;
    })();

    (function(){
        var __name__ = "read_book.prefs.colors";
        var CONTAINER, COLOR_LIST, ACTION_BUTTONS, EDIT_SCHEME, MARGINS, develop;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var cached_color_to_rgba = _modules["book_list.theme"].cached_color_to_rgba;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var set_radio_group_value = _modules.dom.set_radio_group_value;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var error_dialog = _modules.modals.error_dialog;

        var default_color_schemes = _modules["read_book.globals"].default_color_schemes;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var session_defaults = _modules.session.session_defaults;

        var create_button = _modules.widgets.create_button;

        CONTAINER = unique_id("reader-color-scheme");
        COLOR_LIST = unique_id();
        ACTION_BUTTONS = unique_id();
        EDIT_SCHEME = unique_id();
        MARGINS = ["left", "right", "top", "bottom"];
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "#" + COLOR_LIST;
                style = _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({list_style_type: "none", display: "flex", flex_wrap: "wrap"})]));
                sel += " > li";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({padding: "1ex 1rem", margin: "1ex 0.5rem", border_radius: "4px", cursor: "pointer", border: "solid 1px currentColor"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + " svg"].concat([_desugar_kwargs({visibility: "hidden"})]));
                sel += ".current-color";
                style += _interpolate_kwargs.call(this, build_rule, [sel + " svg"].concat([_desugar_kwargs({visibility: "visible"})]));
                style += _interpolate_kwargs.call(this, build_rule, ["#{} #{} td".format(CONTAINER, EDIT_SCHEME)].concat([_desugar_kwargs({padding: "1ex 1em"})]));
                sel = "#" + ACTION_BUTTONS;
                style += sel + "{margin-top:2ex; padding-top:1ex; border-top: solid 1px currentColor; margin-bottom: 2ex; padding-bottom: 1ex; border-bottom: solid 1px currentColor}";
                style += _interpolate_kwargs.call(this, build_rule, [sel + " > span "].concat([_desugar_kwargs({margin: "1ex 0.5rem", display: "inline-block"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.prefs.colors"}
            });
            return _anonfunc;
        })());
        function get_container() {
            return document.getElementById(CONTAINER);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.colors"}
        });

        function resolve_color_scheme(current_color_scheme) {
            var sd, cs, ucs, ans, sn, rgba;
            sd = get_session_data();
            cs = current_color_scheme || sd.get("current_color_scheme") || session_defaults().current_color_scheme;
            ucs = sd.get("user_color_schemes");
            if (default_color_schemes[(typeof cs === "number" && cs < 0) ? default_color_schemes.length + cs : cs]) {
                ans = default_color_schemes[(typeof cs === "number" && cs < 0) ? default_color_schemes.length + cs : cs];
            } else if (ucs[(typeof cs === "number" && cs < 0) ? ucs.length + cs : cs] && ucs[(typeof cs === "number" && cs < 0) ? ucs.length + cs : cs].foreground && ucs[(typeof cs === "number" && cs < 0) ? ucs.length + cs : cs].background) {
                ans = ucs[(typeof cs === "number" && cs < 0) ? ucs.length + cs : cs];
            } else {
                var _Iter0 = _Iterable(default_color_schemes);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    sn = _Iter0[_Index0];
                    ans = default_color_schemes[(typeof sn === "number" && sn < 0) ? default_color_schemes.length + sn : sn];
                    break;
                }
            }
            rgba = cached_color_to_rgba(ans.background);
            ans.is_dark_theme = max(rgba[0], rgba[1], rgba[2]) < 115;
            return ans;
        };
        if (!resolve_color_scheme.__argnames__) Object.defineProperties(resolve_color_scheme, {
            __argnames__ : {value: ["current_color_scheme"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function change_current_color(ev) {
            var ul, li;
            ul = ev.currentTarget.parentNode;
            var _Iter1 = _Iterable(ul.childNodes);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                li = _Iter1[_Index1];
                li.setAttribute("class", (li === ev.currentTarget) ? "current-color" : "");
            }
            set_action_button_visibility(ul.parentNode);
        };
        if (!change_current_color.__argnames__) Object.defineProperties(change_current_color, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function new_color_scheme(ev) {
            var container, inp;
            container = document.getElementById(EDIT_SCHEME);
            container.style.display = "block";
            var _Iter2 = _Iterable(container.querySelectorAll("input"));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                inp = _Iter2[_Index2];
                if (inp.name.endswith("_color_type")) {
                    inp.checked = inp.value === "default";
                } else if (inp.name.startswith("margin_")) {
                } else {
                    inp.value = (_expr_temp = (function(){
                        var _d = Object.create(null);
                        _d["name"] = "";
                        _d["bg"] = "#ffffff";
                        _d["fg"] = "#000000";
                        _d["link"] = "#0000ee";
                        return _d;
                    }).call(this))[_bound_index(inp.name, _expr_temp)];
                }
            }
            container.querySelector("input").focus();
            return container;
        };
        if (!new_color_scheme.__argnames__) Object.defineProperties(new_color_scheme, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function edit_color_scheme(ev) {
            var container, ccs, all_schemes, scheme, attr, val, _unpack, bg, fg, which;
            container = new_color_scheme(ev);
            ccs = current_color_scheme(container);
            all_schemes = all_color_schemes();
            if (all_schemes[(typeof ccs === "number" && ccs < 0) ? all_schemes.length + ccs : ccs]) {
                scheme = all_schemes[(typeof ccs === "number" && ccs < 0) ? all_schemes.length + ccs : ccs];
                container = document.getElementById(EDIT_SCHEME);
                container.querySelector("input").value = scheme.name;
                container.querySelector("input[name=bg]").value = scheme.background;
                container.querySelector("input[name=fg]").value = scheme.foreground;
                set_radio_group_value(container, "link_color_type", (scheme.link) ? "custom" : "default");
                if (scheme.link) {
                    container.querySelector("input[name=link]").value = scheme.link;
                }
                var _Iter3 = _Iterable(MARGINS);
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    which = _Iter3[_Index3];
                    attr = "margin_" + _str.format("{}", which) + "";
                    val = scheme[(typeof attr === "number" && attr < 0) ? scheme.length + attr : attr];
                    set_radio_group_value(container, "" + _str.format("{}", attr) + "_color_type", (val) ? "custom" : "default");
                    if (val) {
                        _unpack = val.split(":");
_unpack = _unpack_asarray(2, _unpack);
                        bg = _unpack[0];
                        fg = _unpack[1];
                        container.querySelector("input[name=" + _str.format("{}", attr) + "_bg]").value = bg;
                        container.querySelector("input[name=" + _str.format("{}", attr) + "_fg]").value = fg;
                    }
                }
            }
        };
        if (!edit_color_scheme.__argnames__) Object.defineProperties(edit_color_scheme, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function remove_color_scheme(ev) {
            var ccs, sd, ucs;
            ccs = current_color_scheme();
            if (default_color_schemes[(typeof ccs === "number" && ccs < 0) ? default_color_schemes.length + ccs : ccs]) {
                return error_dialog(_("Cannot remove"), _("Cannot remove a builtin color scheme"));
            }
            sd = get_session_data();
            ucs = sd.get("user_color_schemes");
            delete ucs[ccs];
            sd.set("user_color_schemes", ucs);
            create_color_buttons();
            set_current_color_scheme();
        };
        if (!remove_color_scheme.__argnames__) Object.defineProperties(remove_color_scheme, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function current_color_scheme() {
            try {
                return get_container().querySelector("li.current-color").getAttribute("data-name");
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof Error) {
                    return session_defaults().current_color_scheme;
                } else {
                    throw _Exception;
                }
            }
        };
        if (!current_color_scheme.__module__) Object.defineProperties(current_color_scheme, {
            __module__ : {value: "read_book.prefs.colors"}
        });

        function set_current_color_scheme(value) {
            var ul, done, li;
            ul = document.getElementById(COLOR_LIST);
            done = false;
            var _Iter4 = _Iterable(ul.childNodes);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                li = _Iter4[_Index4];
                li.classList.remove("current-color");
                if (li.getAttribute("data-name") === value) {
                    li.classList.add("current-color");
                    done = true;
                }
            }
            if (!done) {
                var _Iter5 = _Iterable(ul.childNodes);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    li = _Iter5[_Index5];
                    li.classList.add("current-color");
                    break;
                }
            }
            set_action_button_visibility();
        };
        if (!set_current_color_scheme.__argnames__) Object.defineProperties(set_current_color_scheme, {
            __argnames__ : {value: ["value"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function add_color_scheme(ev) {
            var colors, div, name, col, which, margin, key, sd, ucs;
            colors = Object.create(null);
            function check_color(col) {
                colors[(typeof col === "number" && col < 0) ? colors.length + col : col] = div.querySelector("input[name=" + _str.format("{}", col) + "]").value;
                if (!/^#[0-9A-F]{6}$/i.test(colors[(typeof col === "number" && col < 0) ? colors.length + col : col])) {
                    error_dialog(_("Invalid color"), _("The color {} is not a valid color").format(colors[(typeof col === "number" && col < 0) ? colors.length + col : col]));
                    return false;
                }
                return true;
            };
            if (!check_color.__argnames__) Object.defineProperties(check_color, {
                __argnames__ : {value: ["col"]},
                __module__ : {value: "read_book.prefs.colors"}
            });

            div = document.getElementById(EDIT_SCHEME);
            if (this !== "cancel") {
                name = div.querySelector("input[name=name]").value;
                if (!name) {
                    error_dialog(_("Name not specified"), _("You must specify a name for the color scheme"));
                    return;
                }
                var _Iter6 = _Iterable(_list_decorate([ "bg", "fg", "link" ]));
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    col = _Iter6[_Index6];
                    if (!check_color(col)) {
                        return;
                    }
                }
                var _Iter7 = _Iterable(MARGINS);
                for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                    margin = _Iter7[_Index7];
                    var _Iter8 = _Iterable(_list_decorate([ "fg", "bg" ]));
                    for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                        which = _Iter8[_Index8];
                        if (!check_color("margin_" + _str.format("{}", margin) + "_" + _str.format("{}", which) + "")) {
                            return;
                        }
                    }
                }
                key = "*" + name;
                sd = get_session_data();
                ucs = Object.assign(Object.create(null), sd.get("user_color_schemes"));
                ucs[(typeof key === "number" && key < 0) ? ucs.length + key : key] = (function(){
                    var _d = Object.create(null);
                    _d["name"] = name;
                    _d["foreground"] = colors.fg;
                    _d["background"] = colors.bg;
                    return _d;
                }).call(this);
                if (div.querySelector("input[name=link_color_type]:checked").value === "custom") {
                    ucs[(typeof key === "number" && key < 0) ? ucs.length + key : key].link = colors.link;
                }
                var _Iter9 = _Iterable(MARGINS);
                for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                    margin = _Iter9[_Index9];
                    if (div.querySelector("input[name=margin_" + _str.format("{}", margin) + "_color_type]:checked").value === "custom") {
                        (_expr_temp = ucs[(typeof key === "number" && key < 0) ? ucs.length + key : key])[_bound_index("margin_" + _str.format("{}", margin) + "", _expr_temp)] = colors[_bound_index("margin_" + _str.format("{}", margin) + "_bg", colors)] + ":" + colors[_bound_index("margin_" + _str.format("{}", margin) + "_fg", colors)];
                    }
                }
                sd.set("user_color_schemes", ucs);
                create_color_buttons();
                set_current_color_scheme(key);
            }
            div.style.display = "none";
        };
        if (!add_color_scheme.__argnames__) Object.defineProperties(add_color_scheme, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        function all_color_schemes() {
            var all_schemes, k, sd, ucs;
            all_schemes = Object.create(null);
            var _Iter10 = _Iterable(default_color_schemes);
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                k = _Iter10[_Index10];
                all_schemes[(typeof k === "number" && k < 0) ? all_schemes.length + k : k] = default_color_schemes[(typeof k === "number" && k < 0) ? default_color_schemes.length + k : k];
            }
            sd = get_session_data();
            ucs = sd.get("user_color_schemes");
            var _Iter11 = _Iterable(ucs);
            for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                k = _Iter11[_Index11];
                all_schemes[(typeof k === "number" && k < 0) ? all_schemes.length + k : k] = ucs[(typeof k === "number" && k < 0) ? ucs.length + k : k];
            }
            return all_schemes;
        };
        if (!all_color_schemes.__module__) Object.defineProperties(all_color_schemes, {
            __module__ : {value: "read_book.prefs.colors"}
        });

        function create_color_buttons() {
            var ul, sd, all_schemes, ccs, scheme, is_current, item, name;
            ul = document.getElementById(COLOR_LIST);
            sd = get_session_data();
            clear(ul);
            all_schemes = all_color_schemes();
            ccs = sd.get("current_color_scheme");
            if (!all_schemes[(typeof ccs === "number" && ccs < 0) ? all_schemes.length + ccs : ccs]) {
                ccs = session_defaults().current_color_scheme;
            }
            var _Iter12 = _Iterable(_interpolate_kwargs.call(this, sorted, [all_schemes].concat([_desugar_kwargs({key: (function() {
                var _anonfunc = function (k) {
                    return all_schemes[(typeof k === "number" && k < 0) ? all_schemes.length + k : k].name.toLowerCase();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["k"]},
                    __module__ : {value: "read_book.prefs.colors"}
                });
                return _anonfunc;
            })()})])));
            for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                name = _Iter12[_Index12];
                scheme = all_schemes[(typeof name === "number" && name < 0) ? all_schemes.length + name : name];
                is_current = name === ccs;
                item = _interpolate_kwargs.call(this, set_css, [_interpolate_kwargs.call(E, E.li, [svgicon("check"), "" + scheme.name].concat([_desugar_kwargs({data_name: name, onclick: change_current_color, class_: (is_current) ? "current-color" : ""})]))].concat([_desugar_kwargs({color: scheme.foreground, background_color: scheme.background})]));
                ul.appendChild(item);
            }
        };
        if (!create_color_buttons.__module__) Object.defineProperties(create_color_buttons, {
            __module__ : {value: "read_book.prefs.colors"}
        });

        function set_action_button_visibility() {
            var container, ccs, is_custom, is_first, button;
            container = get_container();
            ccs = current_color_scheme(container);
            is_custom = ccs.startswith("*");
            is_first = true;
            var _Iter13 = _Iterable(container.querySelectorAll("#" + ACTION_BUTTONS + " > span"));
            for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                button = _Iter13[_Index13];
                if (is_first) {
                    is_first = false;
                } else {
                    button.style.display = (is_custom) ? "inline-block" : "none";
                }
            }
        };
        if (!set_action_button_visibility.__module__) Object.defineProperties(set_action_button_visibility, {
            __module__ : {value: "read_book.prefs.colors"}
        });

        function create_colors_panel(container, apply_func, cancel_func) {
            var sd, cs, ul;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER})]));
            container = container.lastChild;
            sd = get_session_data();
            cs = resolve_color_scheme();
            container.dataset.bg = cs.background;
            container.dataset.fg = cs.foreground;
            container.dataset.link = cs.link || "";
            container.appendChild(_interpolate_kwargs.call(E, E.p, [_("Choose a color scheme below")].concat([_desugar_kwargs({style: "margin:1ex 1em; padding: 1ex 0"})])));
            ul = _interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({id: COLOR_LIST})]);
            container.appendChild(ul);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.span(_("Override all book colors:") + ""), E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "override_book_colors", value: "never"})]), _("Never")), "  ", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "override_book_colors", value: "dark"})]), _("In dark mode")), "  ", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "override_book_colors", value: "always"})]), _("Always"))].concat([_desugar_kwargs({style: "margin:1ex 1em; padding: 1ex 0; white-space: pre-wrap"})])));
            try {
                container.lastChild.querySelector("[name=override_book_colors][value=" + _str.format("{}", sd.get("override_book_colors")) + "]").checked = true;
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    container.lastChild.querySelector("[name=override_book_colors][value=never]").checked = true;
                } 
            }
            create_color_buttons();
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.span(create_button(_("New scheme"), "plus", new_color_scheme)), E.span(create_button(_("Edit scheme"), "pencil", edit_color_scheme)), E.span(create_button(_("Remove scheme"), "trash", remove_color_scheme))].concat([_desugar_kwargs({id: ACTION_BUTTONS})])));
            function margin_row(title, which) {
                return E.tr(E.td(title), E.td(E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "margin_" + _str.format("{}", which) + "_color_type", value: "default"})]), _("Default")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "margin_" + _str.format("{}", which) + "_color_type", value: "custom"})]), _("Custom")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "margin_" + _str.format("{}", which) + "_bg", type: "color", value: "#ffffff", onclick: (function() {
                    var _anonfunc = function (ev) {
                        set_radio_group_value(ev.currentTarget.closest("td"), "margin_" + _str.format("{}", which) + "_color_type", "custom");
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.prefs.colors"}
                    });
                    return _anonfunc;
                })()})]), "" + _("Background")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "margin_" + _str.format("{}", which) + "_fg", type: "color", value: "#000000", onclick: (function() {
                    var _anonfunc = function (ev) {
                        set_radio_group_value(ev.currentTarget.closest("td"), "margin_" + _str.format("{}", which) + "_color_type", "custom");
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.prefs.colors"}
                    });
                    return _anonfunc;
                })()})]), "" + _("Foreground"))));
            };
            if (!margin_row.__argnames__) Object.defineProperties(margin_row, {
                __argnames__ : {value: ["title", "which"]},
                __module__ : {value: "read_book.prefs.colors"}
            });

            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.table(E.tr(E.td(_("Name:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "name"})]))), E.tr(E.td(_("Background:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "bg", type: "color", value: "#ffffff"})]))), E.tr(E.td(_("Foreground:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "fg", type: "color", value: "#000000"})]))), E.tr(E.td(_("Link:")), E.td(E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "link_color_type", value: "default"})]), _("Default")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "link_color_type", value: "custom"})]), _("Custom")), "", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "link", type: "color", value: "#000000", onclick: (function() {
                var _anonfunc = function (ev) {
                    set_radio_group_value(ev.currentTarget.closest("td"), "link_color_type", "custom");
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.prefs.colors"}
                });
                return _anonfunc;
            })()})]))), margin_row(_("Top margin:"), "top"), margin_row(_("Bottom margin:"), "bottom"), margin_row(_("Left margin:"), "left"), margin_row(_("Right margin:"), "right")), _interpolate_kwargs.call(E, E.div, [create_button(_("Apply"), "check", add_color_scheme), E.span(""), create_button(_("Discard"), "close", add_color_scheme.bind("cancel"))].concat([_desugar_kwargs({style: "display:flex; justify-content: flex-end; margin: 1ex 1em"})]))].concat([_desugar_kwargs({id: EDIT_SCHEME, style: "display:none"})])));
            set_action_button_visibility();
            container.appendChild(_interpolate_kwargs.call(E, E.div, [create_button_box(null, apply_func, cancel_func)].concat([_desugar_kwargs({style: "margin: 1rem"})])));
        };
        if (!create_colors_panel.__argnames__) Object.defineProperties(create_colors_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        develop = create_colors_panel;
        function commit_colors(onchange) {
            var ccs, rcs, c, sd, prev_obc, cur_obc;
            ccs = current_color_scheme();
            rcs = resolve_color_scheme(ccs);
            c = get_container();
            sd = get_session_data();
            prev_obc = sd.get("override_book_colors");
            cur_obc = c.querySelector("[name=override_book_colors]:checked").value;
            sd.set("current_color_scheme", ccs);
            if (cur_obc !== prev_obc) {
                sd.set("override_book_colors", cur_obc);
            }
            if (rcs.foreground !== c.dataset.fg || rcs.background !== c.dataset.bg || c.dataset.link !== rcs.link || cur_obc !== prev_obc) {
                ui_operations.update_color_scheme();
                onchange();
            }
        };
        if (!commit_colors.__argnames__) Object.defineProperties(commit_colors, {
            __argnames__ : {value: ["onchange"]},
            __module__ : {value: "read_book.prefs.colors"}
        });

        _modules["read_book.prefs.colors"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.colors"].COLOR_LIST = COLOR_LIST;
        _modules["read_book.prefs.colors"].ACTION_BUTTONS = ACTION_BUTTONS;
        _modules["read_book.prefs.colors"].EDIT_SCHEME = EDIT_SCHEME;
        _modules["read_book.prefs.colors"].MARGINS = MARGINS;
        _modules["read_book.prefs.colors"].develop = develop;
        _modules["read_book.prefs.colors"].get_container = get_container;
        _modules["read_book.prefs.colors"].resolve_color_scheme = resolve_color_scheme;
        _modules["read_book.prefs.colors"].change_current_color = change_current_color;
        _modules["read_book.prefs.colors"].new_color_scheme = new_color_scheme;
        _modules["read_book.prefs.colors"].edit_color_scheme = edit_color_scheme;
        _modules["read_book.prefs.colors"].remove_color_scheme = remove_color_scheme;
        _modules["read_book.prefs.colors"].current_color_scheme = current_color_scheme;
        _modules["read_book.prefs.colors"].set_current_color_scheme = set_current_color_scheme;
        _modules["read_book.prefs.colors"].add_color_scheme = add_color_scheme;
        _modules["read_book.prefs.colors"].all_color_schemes = all_color_schemes;
        _modules["read_book.prefs.colors"].create_color_buttons = create_color_buttons;
        _modules["read_book.prefs.colors"].set_action_button_visibility = set_action_button_visibility;
        _modules["read_book.prefs.colors"].create_colors_panel = create_colors_panel;
        _modules["read_book.prefs.colors"].commit_colors = commit_colors;
    })();

    (function(){
        var __name__ = "read_book.prefs.fonts";
        var CONTAINER, DEFAULT_STANDARD_FONT, DEFAULT_MINIMUM_FONT_SIZE, DEFAULT_ZOOM_STEP_SIZE, develop;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var unique_id = _modules.dom.unique_id;

        var runtime = _modules["read_book.globals"].runtime;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        CONTAINER = unique_id("standalone-font-settings");
        DEFAULT_STANDARD_FONT = "serif";
        DEFAULT_MINIMUM_FONT_SIZE = 8;
        DEFAULT_ZOOM_STEP_SIZE = 20;
        function current_zoom_step_size() {
            var s;
            s = get_session_data().get("standalone_font_settings");
            return s.zoom_step_size || DEFAULT_ZOOM_STEP_SIZE;
        };
        if (!current_zoom_step_size.__module__) Object.defineProperties(current_zoom_step_size, {
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function font_select(name, settings) {
            var ans, current_val, family;
            ans = _interpolate_kwargs.call(E, E.select, [_desugar_kwargs({name: name})]);
            ans.appendChild(_interpolate_kwargs.call(E, E.option, [_(" Choose a font ")].concat([_desugar_kwargs({value: ""})])));
            current_val = settings[(typeof name === "number" && name < 0) ? settings.length + name : name];
            if (!current_val) {
                ans.lastChild.setAttribute("selected", "selected");
            }
            var _Iter0 = _Iterable(runtime.all_font_families);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                family = _Iter0[_Index0];
                if (family) {
                    ans.appendChild(E.option(family));
                    if (family === current_val) {
                        ans.lastChild.setAttribute("selected", "selected");
                    }
                }
            }
            return ans;
        };
        if (!font_select.__argnames__) Object.defineProperties(font_select, {
            __argnames__ : {value: ["name", "settings"]},
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function standard_font(settings) {
            var ans, sf;
            ans = _interpolate_kwargs.call(E, E.select, [_desugar_kwargs({name: "standard_font"})]);
            ans.appendChild(_interpolate_kwargs.call(E, E.option, [_("Serif")].concat([_desugar_kwargs({value: "serif"})])));
            ans.appendChild(_interpolate_kwargs.call(E, E.option, [_("Sans-serif")].concat([_desugar_kwargs({value: "sans"})])));
            ans.appendChild(_interpolate_kwargs.call(E, E.option, [_("Monospace")].concat([_desugar_kwargs({value: "mono"})])));
            sf = settings.standard_font || DEFAULT_STANDARD_FONT;
            ans.querySelector("[value=" + _str.format("{}", sf) + "]").setAttribute("selected", "selected");
            return ans;
        };
        if (!standard_font.__argnames__) Object.defineProperties(standard_font, {
            __argnames__ : {value: ["settings"]},
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function minimum_font_size(settings) {
            var ans;
            ans = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({max: "100", min: "0", step: "1", type: "number", name: "minimum_font_size"})]);
            if (typeof settings.minimum_font_size === "number") {
                ans.value = settings.minimum_font_size + "";
            } else {
                ans.value = "" + DEFAULT_MINIMUM_FONT_SIZE;
            }
            return ans;
        };
        if (!minimum_font_size.__argnames__) Object.defineProperties(minimum_font_size, {
            __argnames__ : {value: ["settings"]},
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function zoom_step_size(settings) {
            var ans;
            ans = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({max: "100", min: "1", step: "1", type: "number", name: "zoom_step_size"})]);
            if (typeof settings.zoom_step_size === "number") {
                ans.value = settings.zoom_step_size + "";
            } else {
                ans.value = "" + DEFAULT_ZOOM_STEP_SIZE;
            }
            return ans;
        };
        if (!zoom_step_size.__argnames__) Object.defineProperties(zoom_step_size, {
            __argnames__ : {value: ["settings"]},
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function restore_defaults() {
            var container, q;
            container = get_container();
            var _Iter1 = _Iterable(_list_decorate([ "serif_family", "sans_family", "mono_family" ]));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                q = _Iter1[_Index1];
                container.querySelector("[name=" + _str.format("{}", q) + "]").value = "";
            }
            container.querySelector("[name=zoom_step_size]").value = DEFAULT_ZOOM_STEP_SIZE + "";
            container.querySelector("[name=minimum_font_size]").value = DEFAULT_MINIMUM_FONT_SIZE + "";
            container.querySelector("[name=standard_font]").value = DEFAULT_STANDARD_FONT;
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function get_container() {
            return document.getElementById(CONTAINER);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.fonts"}
        });

        function create_fonts_panel(container, apply_func, cancel_func) {
            var sd, settings;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER, style: "margin: 1rem"})]));
            container = container.lastChild;
            container.append(_interpolate_kwargs.call(E, E.div, [_("Choose fonts to use for un-styled text:")].concat([_desugar_kwargs({style: "margin-top: 1rem"})])));
            sd = get_session_data();
            settings = sd.get("standalone_font_settings");
            function row(label, widget) {
                return E.tr(_interpolate_kwargs.call(E, E.td, [label + ":"].concat([_desugar_kwargs({style: "padding-top: 1ex"})])), _interpolate_kwargs.call(E, E.td, [widget].concat([_desugar_kwargs({style: "padding-top: 1ex"})])));
            };
            if (!row.__argnames__) Object.defineProperties(row, {
                __argnames__ : {value: ["label", "widget"]},
                __module__ : {value: "read_book.prefs.fonts"}
            });

            container.append(_interpolate_kwargs.call(E, E.table, [row(_("Serif family"), font_select("serif_family", settings)), row(_("Sans-serif family"), font_select("sans_family", settings)), row(_("Monospace family"), font_select("mono_family", settings)), row(_("Standard font"), standard_font(settings))].concat([_desugar_kwargs({style: "margin-top: 1rem"})])));
            container.append(_interpolate_kwargs.call(E, E.div, [_("Zoom related settings")].concat([_desugar_kwargs({style: "margin-top: 1rem; padding-top: 1rem; width: 100%; border-top: solid 1px"})])));
            container.append(E.table(row(_("Zoom step size (%)"), zoom_step_size(settings)), row(_("Minimum font size (px)"), minimum_font_size(settings))));
            container.appendChild(create_button_box(restore_defaults, apply_func, cancel_func));
        };
        if (!create_fonts_panel.__argnames__) Object.defineProperties(create_fonts_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.fonts"}
        });

        develop = create_fonts_panel;
        function commit_fonts(onchange) {
            var sd, container, vals, zss, mfs, sf, val, q;
            sd = get_session_data();
            container = get_container();
            vals = Object.create(null);
            zss = parseInt(container.querySelector("[name=zoom_step_size]").value);
            if (zss !== DEFAULT_ZOOM_STEP_SIZE) {
                vals.zoom_step_size = zss;
            }
            mfs = parseInt(container.querySelector("[name=minimum_font_size]").value);
            if (mfs !== DEFAULT_MINIMUM_FONT_SIZE) {
                vals.minimum_font_size = mfs;
            }
            sf = container.querySelector("[name=standard_font]").value;
            if (sf !== DEFAULT_STANDARD_FONT) {
                vals.standard_font = sf;
            }
            var _Iter2 = _Iterable(_list_decorate([ "serif_family", "sans_family", "mono_family" ]));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                q = _Iter2[_Index2];
                val = container.querySelector("[name=" + _str.format("{}", q) + "]").value;
                if (val) {
                    vals[(typeof q === "number" && q < 0) ? vals.length + q : q] = val;
                }
            }
            sd.set("standalone_font_settings", vals);
        };
        if (!commit_fonts.__argnames__) Object.defineProperties(commit_fonts, {
            __argnames__ : {value: ["onchange"]},
            __module__ : {value: "read_book.prefs.fonts"}
        });

        _modules["read_book.prefs.fonts"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.fonts"].DEFAULT_STANDARD_FONT = DEFAULT_STANDARD_FONT;
        _modules["read_book.prefs.fonts"].DEFAULT_MINIMUM_FONT_SIZE = DEFAULT_MINIMUM_FONT_SIZE;
        _modules["read_book.prefs.fonts"].DEFAULT_ZOOM_STEP_SIZE = DEFAULT_ZOOM_STEP_SIZE;
        _modules["read_book.prefs.fonts"].develop = develop;
        _modules["read_book.prefs.fonts"].current_zoom_step_size = current_zoom_step_size;
        _modules["read_book.prefs.fonts"].font_select = font_select;
        _modules["read_book.prefs.fonts"].standard_font = standard_font;
        _modules["read_book.prefs.fonts"].minimum_font_size = minimum_font_size;
        _modules["read_book.prefs.fonts"].zoom_step_size = zoom_step_size;
        _modules["read_book.prefs.fonts"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.fonts"].get_container = get_container;
        _modules["read_book.prefs.fonts"].create_fonts_panel = create_fonts_panel;
        _modules["read_book.prefs.fonts"].commit_fonts = commit_fonts;
    })();

    (function(){
        var __name__ = "read_book.prefs.keyboard";
        var develop;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_search_bar = _modules.complete.create_search_bar;

        var create_item = _modules["book_list.item_list"].create_item;
        var create_item_list = _modules["book_list.item_list"].create_item_list;

        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var key_as_text = _modules["read_book.shortcuts"].key_as_text;
        var keyevent_as_shortcut = _modules["read_book.shortcuts"].keyevent_as_shortcut;
        var shortcut_differs = _modules["read_book.shortcuts"].shortcut_differs;
        var shortcuts_definition = _modules["read_book.shortcuts"].shortcuts_definition;
        var shortcuts_group_desc = _modules["read_book.shortcuts"].shortcuts_group_desc;

        var create_button = _modules.widgets.create_button;

        function get_container() {
            return document.getElementById(get_container.id);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function restore_defaults(close_func) {
            var q, item;
            get_container().dataset.changed = "true";
            var _Iter0 = _Iterable(get_container().querySelectorAll("[data-user-data]"));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                item = _Iter0[_Index0];
                q = JSON.parse(item.dataset.userData);
                q.shortcuts = (_expr_temp = shortcuts_definition())[_bound_index(q.name, _expr_temp)].shortcuts;
                item.dataset.userData = JSON.stringify(q);
            }
            close_func();
        };
        if (!restore_defaults.__argnames__) Object.defineProperties(restore_defaults, {
            __argnames__ : {value: ["close_func"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function as_groups(shortcuts) {
            var ans, sc, sc_name;
            ans = Object.create(null);
            var _Iter1 = _Iterable(Object.keys(shortcuts));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                sc_name = _Iter1[_Index1];
                sc = shortcuts[(typeof sc_name === "number" && sc_name < 0) ? shortcuts.length + sc_name : sc_name];
                if (!ans[_bound_index(sc.group, ans)]) {
                    ans[_bound_index(sc.group, ans)] = Object.create(null);
                }
                (_expr_temp = ans[_bound_index(sc.group, ans)])[(typeof sc_name === "number" && sc_name < 0) ? _expr_temp.length + sc_name : sc_name] = sc;
            }
            return ans;
        };
        if (!as_groups.__argnames__) Object.defineProperties(as_groups, {
            __argnames__ : {value: ["shortcuts"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function sort_group_key(group, sc_name) {
            return group[(typeof sc_name === "number" && sc_name < 0) ? group.length + sc_name : sc_name].short.toLowerCase();
        };
        if (!sort_group_key.__argnames__) Object.defineProperties(sort_group_key, {
            __argnames__ : {value: ["group", "sc_name"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function sc_as_item(sc_name, sc, shortcuts) {
            var cuts;
            cuts = shortcuts || sc.shortcuts;
            return _interpolate_kwargs.call(this, create_item, [sc.short].concat([_desugar_kwargs({action: customize_shortcut.bind(null, sc_name), subtitle: sc.long, data: JSON.stringify((function(){
                var _d = Object.create(null);
                _d["name"] = sc_name;
                _d["shortcuts"] = cuts;
                return _d;
            }).call(this))})]));
        };
        if (!sc_as_item.__argnames__) Object.defineProperties(sc_as_item, {
            __argnames__ : {value: ["sc_name", "sc", "shortcuts"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function remove_key(evt) {
            var key_container;
            key_container = evt.currentTarget.parentNode.parentNode;
            key_container.parentNode.removeChild(key_container);
        };
        if (!remove_key.__argnames__) Object.defineProperties(remove_key, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function key_widget(key) {
            var icon;
            icon = svgicon("remove");
            icon.style.verticalAlign = "baseline";
            return _interpolate_kwargs.call(E, E.tr, [_interpolate_kwargs.call(E, E.td, [key_as_text(key)].concat([_desugar_kwargs({style: "padding: 0.5rem; border-right: solid 1px; margin-right: 0.5rem; margin-top: 0.5rem"})])), _interpolate_kwargs.call(E, E.td, [_interpolate_kwargs.call(E, E.a, ["", icon, " ", _("Remove")].concat([_desugar_kwargs({class_: "simple-link", onclick: remove_key})]))].concat([_desugar_kwargs({style: "padding: 0.5rem; margin-top: 0.5rem; vertical-align: bottom"})]))].concat([_desugar_kwargs({data_shortcut: JSON.stringify(keyevent_as_shortcut(key))})]));
        };
        if (!key_widget.__argnames__) Object.defineProperties(key_widget, {
            __argnames__ : {value: ["key"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function close_customize_shortcut(apply_changes) {
            var container, q, item, shortcuts, sc, x, sc_name;
            container = get_container();
            container.firstChild.style.display = "flex";
            container.firstChild.nextSibling.style.display = "block";
            container.lastChild.style.display = "none";
            if (close_customize_shortcut.shortcut_being_customized) {
                var _Iter2 = _Iterable(container.firstChild.querySelectorAll("[data-user-data]"));
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    item = _Iter2[_Index2];
                    q = JSON.parse(item.dataset.userData);
                    if (q.name === close_customize_shortcut.shortcut_being_customized) {
                        item.scrollIntoView();
                        break;
                    }
                }
            }
            if (apply_changes) {
                shortcuts = [];
                var _Iter3 = _Iterable(container.lastChild.querySelectorAll("[data-shortcut]"));
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    x = _Iter3[_Index3];
                    sc = JSON.parse(x.dataset.shortcut);
                    shortcuts.push(sc);
                }
                sc_name = container.lastChild.dataset.scName;
                var _Iter4 = _Iterable(container.querySelectorAll("[data-user-data]"));
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    item = _Iter4[_Index4];
                    q = JSON.parse(item.dataset.userData);
                    if (q.name === sc_name) {
                        q.shortcuts = shortcuts;
                        item.dataset.userData = JSON.stringify(q);
                        break;
                    }
                }
                get_container().dataset.changed = "true";
                commit_keyboard(create_keyboard_panel.onchange, null);
            }
        };
        if (!close_customize_shortcut.__argnames__) Object.defineProperties(close_customize_shortcut, {
            __argnames__ : {value: ["apply_changes"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function add_key_widget() {
            var uid;
            uid = unique_id("add-new-shortcut");
            return _interpolate_kwargs.call(E, E.div, [E.div(_interpolate_kwargs.call(this, create_button, [_("Add a new shortcut")].concat([_desugar_kwargs({icon: "plus", action: (function() {
                var _anonfunc = function (evt) {
                    var div;
                    div = document.getElementById(uid);
                    div.firstChild.style.display = "none";
                    div.lastChild.style.display = "block";
                    div.lastChild.querySelector("input").focus();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["evt"]},
                    __module__ : {value: "read_book.prefs.keyboard"}
                });
                return _anonfunc;
            })()})]))), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({readonly: "readonly", value: _("Press the key combination to use as a shortcut"), style: "width: 90vw", onkeydown: (function() {
                var _anonfunc = function (evt) {
                    var key_con, div;
                    evt.preventDefault();
                    evt.stopPropagation();
                    if (!_in(evt.key, ['Control', 'Meta', 'Alt', 'Shift'])) {
                        key_con = get_container().querySelector(".key-container");
                        key_con.appendChild(key_widget(evt));
                        div = document.getElementById(uid);
                        div.firstChild.style.display = "block";
                        div.lastChild.style.display = "none";
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["evt"]},
                    __module__ : {value: "read_book.prefs.keyboard"}
                });
                return _anonfunc;
            })()})])].concat([_desugar_kwargs({style: "display:none"})]))].concat([_desugar_kwargs({style: "margin-top: 1ex; margin-bottom: 1ex", id: uid})]));
        };
        if (!add_key_widget.__module__) Object.defineProperties(add_key_widget, {
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function customize_shortcut(sc_name) {
            var container, shortcuts, q, item, sc, key_con, key;
            container = get_container();
            container.firstChild.style.display = "none";
            container.firstChild.nextSibling.style.display = "none";
            container.lastChild.style.display = "block";
            close_customize_shortcut.shortcut_being_customized = sc_name;
            shortcuts = [];
            var _Iter5 = _Iterable(container.querySelectorAll("[data-user-data]"));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                item = _Iter5[_Index5];
                q = JSON.parse(item.dataset.userData);
                if (q.name === sc_name) {
                    shortcuts = q.shortcuts;
                    break;
                }
            }
            container = container.lastChild;
            clear(container);
            container.dataset.scName = sc_name;
            sc = (_expr_temp = shortcuts_definition())[(typeof sc_name === "number" && sc_name < 0) ? _expr_temp.length + sc_name : sc_name];
            container.appendChild(E.h4(sc.short));
            if (sc.long) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [sc.long].concat([_desugar_kwargs({style: "font-style: italic; font-size: smaller; margin-top: 1ex"})])));
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Existing shortcuts:")].concat([_desugar_kwargs({style: "margin-top: 1rem"})])));
            key_con = container.appendChild(_interpolate_kwargs.call(E, E.table, [_desugar_kwargs({class_: "key-container"})]));
            var _Iter6 = _Iterable(shortcuts);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                key = _Iter6[_Index6];
                key_con.appendChild(key_widget(key));
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [add_key_widget()].concat([_desugar_kwargs({style: "margin-top:1ex;"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({action: close_customize_shortcut.bind(null, true)})])), E.span(""), _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: close_customize_shortcut.bind(null, false)})]))].concat([_desugar_kwargs({style: "margin-top:1ex; display:flex; justify-content: flex-end"})])));
        };
        if (!customize_shortcut.__argnames__) Object.defineProperties(customize_shortcut, {
            __argnames__ : {value: ["sc_name"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function run_search() {
            var container, query, q, matches, item;
            container = get_container();
            query = container.querySelector("[name=search-for-sc]").value || "";
            query = query.toLowerCase();
            var _Iter7 = _Iterable(get_container().querySelectorAll("[data-user-data]"));
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                item = _Iter7[_Index7];
                q = item.textContent.toLowerCase();
                matches = !query || q.indexOf(query) > -1;
                item.style.display = (matches) ? "list-item" : "none";
            }
        };
        if (!run_search.__module__) Object.defineProperties(run_search, {
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function create_keyboard_panel(container, apply_func, cancel_func, onchange) {
            var search_button, sb, sd, custom_shortcuts, groups, group, items, sc, sc_name, group_name;
            create_keyboard_panel.onchange = onchange;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: unique_id("keyboard-settings"), style: "margin: 1rem"})]));
            container = container.lastChild;
            container.dataset.changed = "false";
            get_container.id = container.id;
            search_button = _interpolate_kwargs.call(this, create_button, [_("Search")].concat([_desugar_kwargs({icon: "search"})]));
            sb = _interpolate_kwargs.call(this, create_search_bar, [run_search, "search-for-sc"].concat([_desugar_kwargs({placeholder: _("Search for shortcut"), button: search_button})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [sb, E.span(""), search_button].concat([_desugar_kwargs({style: "margin-bottom: 1ex; display: flex; width: 100%; justify-content: space-between"})])));
            container.firstChild.firstChild.style.flexGrow = "100";
            container.appendChild(E.div());
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display: none"})]));
            container = container.firstChild.nextSibling;
            sd = get_session_data();
            custom_shortcuts = sd.get("keyboard_shortcuts");
            groups = as_groups(shortcuts_definition());
            var _Iter8 = _Iterable(Object.keys(groups));
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                group_name = _Iter8[_Index8];
                container.appendChild(_interpolate_kwargs.call(E, E.h3, [(_expr_temp = shortcuts_group_desc())[(typeof group_name === "number" && group_name < 0) ? _expr_temp.length + group_name : group_name]].concat([_desugar_kwargs({style: "margin-top: 1ex"})])));
                group = groups[(typeof group_name === "number" && group_name < 0) ? groups.length + group_name : group_name];
                items = _list_decorate([]);
                var _Iter9 = _Iterable(_interpolate_kwargs.call(this, sorted, [Object.keys(group)].concat([_desugar_kwargs({key: sort_group_key.bind(null, group)})])));
                for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                    sc_name = _Iter9[_Index9];
                    sc = group[(typeof sc_name === "number" && sc_name < 0) ? group.length + sc_name : sc_name];
                    items.push(sc_as_item(sc_name, sc, custom_shortcuts[(typeof sc_name === "number" && sc_name < 0) ? custom_shortcuts.length + sc_name : sc_name]));
                }
                container.appendChild(E.div());
                create_item_list(container.lastChild, items);
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Restore defaults")].concat([_desugar_kwargs({action: restore_defaults.bind(null, apply_func)})]))].concat([_desugar_kwargs({style: "margin-top: 1rem"})])));
        };
        if (!create_keyboard_panel.__argnames__) Object.defineProperties(create_keyboard_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func", "onchange"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        develop = create_keyboard_panel;
        function shortcuts_differ(a, b) {
            var _unpack, x, y;
            if (a.length !== b.length) {
                return true;
            }
            var _Iter10 = _Iterable(zip(a, b));
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                _unpack = _Iter10[_Index10];
                x = _unpack[0];
                y = _unpack[1];
                if (shortcut_differs(x, y)) {
                    return true;
                }
            }
            return false;
        };
        if (!shortcuts_differ.__argnames__) Object.defineProperties(shortcuts_differ, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        function commit_keyboard(onchange, container) {
            var sd, vals, q, item;
            sd = get_session_data();
            vals = Object.create(null);
            var _Iter11 = _Iterable(get_container().querySelectorAll("[data-user-data]"));
            for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                item = _Iter11[_Index11];
                q = JSON.parse(item.dataset.userData);
                if (shortcuts_differ(q.shortcuts, (_expr_temp = shortcuts_definition())[_bound_index(q.name, _expr_temp)].shortcuts)) {
                    vals[_bound_index(q.name, vals)] = q.shortcuts;
                }
            }
            sd.set("keyboard_shortcuts", vals);
            if (container !== null) {
                create_keyboard_panel.onchange = null;
            }
            if (get_container().dataset.changed === "true") {
                onchange();
            }
        };
        if (!commit_keyboard.__argnames__) Object.defineProperties(commit_keyboard, {
            __argnames__ : {value: ["onchange", "container"]},
            __module__ : {value: "read_book.prefs.keyboard"}
        });

        _modules["read_book.prefs.keyboard"].develop = develop;
        _modules["read_book.prefs.keyboard"].get_container = get_container;
        _modules["read_book.prefs.keyboard"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.keyboard"].as_groups = as_groups;
        _modules["read_book.prefs.keyboard"].sort_group_key = sort_group_key;
        _modules["read_book.prefs.keyboard"].sc_as_item = sc_as_item;
        _modules["read_book.prefs.keyboard"].remove_key = remove_key;
        _modules["read_book.prefs.keyboard"].key_widget = key_widget;
        _modules["read_book.prefs.keyboard"].close_customize_shortcut = close_customize_shortcut;
        _modules["read_book.prefs.keyboard"].add_key_widget = add_key_widget;
        _modules["read_book.prefs.keyboard"].customize_shortcut = customize_shortcut;
        _modules["read_book.prefs.keyboard"].run_search = run_search;
        _modules["read_book.prefs.keyboard"].create_keyboard_panel = create_keyboard_panel;
        _modules["read_book.prefs.keyboard"].shortcuts_differ = shortcuts_differ;
        _modules["read_book.prefs.keyboard"].commit_keyboard = commit_keyboard;
    })();

    (function(){
        var __name__ = "read_book.prefs.layout";
        var CONTAINER, MARGINS, READ_MODE, FS_MODE, COLS, TEXT_AREA, develop;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var element = _modules.dom.element;
        var unique_id = _modules.dom.unique_id;

        var runtime = _modules["read_book.globals"].runtime;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var session_defaults = _modules.session.session_defaults;

        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        CONTAINER = unique_id("reader-page-layout");
        MARGINS = unique_id("reader-page-margins");
        READ_MODE = unique_id("read-mode");
        FS_MODE = unique_id("fs-mode");
        COLS = unique_id("cols-per-screen");
        TEXT_AREA = unique_id("text-area");
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "#" + MARGINS;
                style = _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin_left: "1rem", margin_top: "-1ex"})]));
                style += _interpolate_kwargs.call(this, build_rule, ["#{} td".format(CONTAINER)].concat([_desugar_kwargs({padding: "1ex"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.prefs.layout"}
            });
            return _anonfunc;
        })());
        function restore_defaults() {
            var defaults, container, which, name;
            defaults = session_defaults();
            container = document.getElementById(CONTAINER);
            var _Iter0 = _Iterable("top bottom left right".split(" "));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                which = _Iter0[_Index0];
                container.querySelector("input[name={}]".format(which)).value = str(defaults[_bound_index("margin_" + which, defaults)]);
            }
            var _Iter1 = _Iterable("paged flow".split(" "));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                name = _Iter1[_Index1];
                container.querySelector("#" + _str.format("{}", READ_MODE) + " input[data-name=" + _str.format("{}", name) + "]").checked = defaults.read_mode === name;
            }
            if (!runtime.is_standalone_viewer) {
                container.querySelector("#" + _str.format("{}", FS_MODE) + " input[value=" + _str.format("{}", defaults.fullscreen_when_opening) + "]").checked = true;
            }
            var _Iter2 = _Iterable("portrait landscape".split(" "));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                name = _Iter2[_Index2];
                container.querySelector("input[name={}]".format(name)).value = str((_expr_temp = defaults.columns_per_screen)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]);
            }
            var _Iter3 = _Iterable("width height".split(" "));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                which = _Iter3[_Index3];
                container.querySelector("input[name={}]".format(which)).value = str(defaults[_bound_index("max_text_" + which, defaults)]);
            }
            container.querySelector("input[name=cover_preserve_aspect_ratio]").checked = defaults.cover_preserve_aspect_ratio;
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.layout"}
        });

        function create_layout_panel(container, apply_func, cancel_func) {
            var sd, labels, rm, cps, name, val;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER})]));
            container = container.lastChild;
            sd = get_session_data();
            container.appendChild(_interpolate_kwargs.call(E, E.p, [_desugar_kwargs({style: "margin:1ex 1rem; padding: 1ex 0"})]));
            safe_set_inner_html(container.lastChild, _("Current window size is: <b>{0}x{1}</b> pixels").format(window.innerWidth, window.innerHeight));
            container.appendChild(_interpolate_kwargs.call(E, E.p, [_("Change the page margins (in pixels) below")].concat([_desugar_kwargs({style: "margin:1ex 1rem; padding: 1ex 0"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.table, [_desugar_kwargs({id: MARGINS})]));
            labels = (function(){
                var _d = Object.create(null);
                _d["top"] = _("Top:");
                _d["bottom"] = _("Bottom:");
                _d["left"] = _("Left:");
                _d["right"] = _("Right:");
                return _d;
            }).call(this);
            function item(which, tr) {
                tr.appendChild(E.td(labels[(typeof which === "number" && which < 0) ? labels.length + which : which]));
                tr.appendChild(E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", max: "9999", min: "0", step: "1", name: which, value: str(sd.get("margin_" + which))})])));
            };
            if (!item.__argnames__) Object.defineProperties(item, {
                __argnames__ : {value: ["which", "tr"]},
                __module__ : {value: "read_book.prefs.layout"}
            });

            container.lastChild.appendChild(E.tr());
            item("left", container.lastChild.lastChild);
            item("right", container.lastChild.lastChild);
            container.lastChild.appendChild(E.tr());
            item("top", container.lastChild.lastChild);
            item("bottom", container.lastChild.lastChild);
            function sec(text) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [text].concat([_desugar_kwargs({style: "margin: 2ex 1rem; padding-top:2ex; border-top: solid 1px; max-width: 50em"})])));
            };
            if (!sec.__argnames__) Object.defineProperties(sec, {
                __argnames__ : {value: ["text"]},
                __module__ : {value: "read_book.prefs.layout"}
            });

            sec(_("Choose the page layout mode. In paged mode, the text is split up into individual pages, as in a paper book. In flow mode text is presented as one long scrolling page, as in web browsers."));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: READ_MODE, style: "margin: 1ex 2rem; display: flex;"})]));
            rm = sd.get("read_mode");
            rm = (rm === "flow") ? "flow" : "paged";
            function rb(name, text) {
                var d;
                d = container.lastChild;
                d.appendChild(E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: "page-layout-mode", data_name: name, checked: rm === name})]), text));
            };
            if (!rb.__argnames__) Object.defineProperties(rb, {
                __argnames__ : {value: ["name", "text"]},
                __module__ : {value: "read_book.prefs.layout"}
            });

            rb("paged", _("Paged mode"));
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.span, [""].concat([_desugar_kwargs({style: "width:3em"})])));
            rb("flow", _("Flow mode"));
            sec(_("In paged mode, control the number of pages per screen. A setting of zero means the number of pages is set based on the screen size."));
            cps = sd.get("columns_per_screen");
            container.appendChild(_interpolate_kwargs.call(E, E.table, [E.tr(E.td(_("Portrait:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", name: "portrait", min: "0", step: "1", max: "20", value: str(cps.portrait)})])), E.td(_("Landscape:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", name: "landscape", min: "0", step: "1", max: "20", value: str(cps.landscape)})])))].concat([_desugar_kwargs({style: "margin: 1ex 1rem", id: COLS})])));
            sec(_("Change the maximum screen area (in pixels) used to display text. A value of zero means that all available screen area is used."));
            container.appendChild(_interpolate_kwargs.call(E, E.table, [E.tr(E.td(_("Width:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", name: "width", min: "0", step: "10", max: "99999", value: str(sd.get("max_text_width"))})])), E.td(_("Height:")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", name: "height", min: "0", step: "10", max: "99999", value: str(sd.get("max_text_height"))})])))].concat([_desugar_kwargs({style: "margin: 1ex 1rem", id: TEXT_AREA})])));
            sec(_("Miscellaneous"));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: "cover_preserve_aspect_ratio", checked: sd.get("cover_preserve_aspect_ratio")})]), _("Preserve cover aspect ratio"))].concat([_desugar_kwargs({style: "margin: 1ex 2rem; display: flex;"})])));
            if (!runtime.is_standalone_viewer) {
                name = "fullscreen_when_opening";
                val = sd.get(name);
                if ("auto always never".split(" ").indexOf(val || "") < 0) {
                    val = session_defaults().fullscreen_when_opening;
                }
                container.appendChild(E.div(_interpolate_kwargs.call(E, E.div, [_("When opening a book enter fullscreen:"), " ", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: name, value: "auto", checked: val === "auto"})]), _("Auto")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: name, value: "always", checked: val === "always"})]), _("Always")), "", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: name, value: "never", checked: val === "never"})]), _("Never"))].concat([_desugar_kwargs({style: "margin: 1ex 2rem", id: FS_MODE})]))));
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [create_button_box(restore_defaults, apply_func, cancel_func)].concat([_desugar_kwargs({style: "margin: 1rem"})])));
        };
        if (!create_layout_panel.__argnames__) Object.defineProperties(create_layout_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.layout"}
        });

        develop = create_layout_panel;
        function commit_layout(onchange, container) {
            var was_changed, sd, i, val, which, rm, crm, fs, cfs, cps, inp, cover_preserve_aspect_ratio;
            was_changed = false;
            sd = get_session_data();
            var _Iter4 = _Iterable("top bottom left right".split(" "));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                which = _Iter4[_Index4];
                i = element(MARGINS, "[name={}]".format(which));
                try {
                    val = int(i.value);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        continue;
                    } 
                }
                if (val !== sd.get("margin_" + which)) {
                    was_changed = true;
                    sd.set("margin_" + which, val);
                }
            }
            rm = sd.get("read_mode");
            rm = (rm === "flow") ? "flow" : "paged";
            crm = (element(READ_MODE, "input").checked) ? "paged" : "flow";
            if (rm !== crm) {
                was_changed = true;
                sd.set("read_mode", crm);
            }
            if (!runtime.is_standalone_viewer) {
                fs = sd.get("fullscreen_when_opening");
                cfs = document.querySelector("#" + _str.format("{}", FS_MODE) + " input[name=\"fullscreen_when_opening\"]:checked").value;
                if (cfs !== fs) {
                    was_changed = true;
                    sd.set("fullscreen_when_opening", cfs);
                }
            }
            cps = sd.get("columns_per_screen");
            cps = (function(){
                var _d = Object.create(null);
                _d["portrait"] = cps.portrait;
                _d["landscape"] = cps.landscape;
                return _d;
            }).call(this);
            var _Iter5 = _Iterable(_list_decorate([ "portrait", "landscape" ]));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                which = _Iter5[_Index5];
                inp = element(COLS, "input[name={}]".format(which));
                try {
                    val = int(inp.value);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        continue;
                    } 
                }
                if (cps[(typeof which === "number" && which < 0) ? cps.length + which : which] !== val) {
                    cps[(typeof which === "number" && which < 0) ? cps.length + which : which] = val;
                    sd.set("columns_per_screen", cps);
                    was_changed = true;
                }
            }
            var _Iter6 = _Iterable(_list_decorate([ "width", "height" ]));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                which = _Iter6[_Index6];
                try {
                    val = int(element(TEXT_AREA, "input[name={}]".format(which)).value);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    {
                        continue;
                    } 
                }
                if (val !== sd.get("max_text_" + which)) {
                    was_changed = true;
                    sd.set("max_text_" + which, val);
                }
            }
            cover_preserve_aspect_ratio = element(CONTAINER, "input[name=cover_preserve_aspect_ratio]").checked;
            if (cover_preserve_aspect_ratio !== sd.get("cover_preserve_aspect_ratio")) {
                was_changed = true;
                sd.set("cover_preserve_aspect_ratio", cover_preserve_aspect_ratio);
            }
            if (was_changed) {
                onchange();
            }
        };
        if (!commit_layout.__argnames__) Object.defineProperties(commit_layout, {
            __argnames__ : {value: ["onchange", "container"]},
            __module__ : {value: "read_book.prefs.layout"}
        });

        _modules["read_book.prefs.layout"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.layout"].MARGINS = MARGINS;
        _modules["read_book.prefs.layout"].READ_MODE = READ_MODE;
        _modules["read_book.prefs.layout"].FS_MODE = FS_MODE;
        _modules["read_book.prefs.layout"].COLS = COLS;
        _modules["read_book.prefs.layout"].TEXT_AREA = TEXT_AREA;
        _modules["read_book.prefs.layout"].develop = develop;
        _modules["read_book.prefs.layout"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.layout"].create_layout_panel = create_layout_panel;
        _modules["read_book.prefs.layout"].commit_layout = commit_layout;
    })();

    (function(){
        var __name__ = "read_book.prefs.misc";
        var CONTAINER, develop;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var session_defaults = _modules.session.session_defaults;
        var DEFAULTS = _modules.session.standalone_reader_defaults;

        var create_button = _modules.widgets.create_button;

        CONTAINER = unique_id("standalone-misc-settings");
        function restore_defaults() {
            var container, control, q;
            container = get_container();
            var _Iter0 = _Iterable(Object.keys(DEFAULTS));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                q = _Iter0[_Index0];
                control = container.querySelector("[name=" + _str.format("{}", q) + "]");
                if (typeof DEFAULTS[(typeof q === "number" && q < 0) ? DEFAULTS.length + q : q] === "boolean") {
                    control.checked = DEFAULTS[(typeof q === "number" && q < 0) ? DEFAULTS.length + q : q];
                } else {
                    control.value = DEFAULTS[(typeof q === "number" && q < 0) ? DEFAULTS.length + q : q];
                }
            }
            container.querySelector("[name=hide_tooltips]").checked = session_defaults().hide_tooltips;
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.misc"}
        });

        function get_container() {
            return document.getElementById(CONTAINER);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.misc"}
        });

        function create_misc_panel(container, apply_func, cancel_func) {
            var sd, settings, sai, sync_annots;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER, style: "margin: 1rem"})]));
            container = container.lastChild;
            sd = get_session_data();
            settings = sd.get("standalone_misc_settings");
            settings.hide_tooltips = sd.get("hide_tooltips");
            function cb(name, text) {
                var ans;
                ans = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: name})]);
                ans.checked = (typeof settings[(typeof name === "number" && name < 0) ? settings.length + name : name] === "boolean") ? settings[(typeof name === "number" && name < 0) ? settings.length + name : name] : DEFAULTS[(typeof name === "number" && name < 0) ? DEFAULTS.length + name : name];
                return _interpolate_kwargs.call(E, E.div, [E.label(ans, "" + text)].concat([_desugar_kwargs({style: "margin-top:1ex"})]));
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["name", "text"]},
                __module__ : {value: "read_book.prefs.misc"}
            });

            sai = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "sync_annots_user", title: _("The username of a Content server user that you want all annotations synced with. Use the special value * to sync with anonymous users")})]);
            sai.value = (typeof settings.sync_annots_user === "string") ? settings.sync_annots_user : DEFAULTS.sync_annots_user;
            sync_annots = _interpolate_kwargs.call(E, E.div, [E.label(_("Sync bookmarks/highlights with Content server user:") + "", sai)].concat([_desugar_kwargs({style: "margin-top: 1ex; margin-left: 3px"})]));
            container.append(cb("remember_window_geometry", _("Remember last used window size and position")));
            container.append(cb("show_actions_toolbar", _("Show a toolbar with the most useful actions")));
            container.lastChild.append(E.span(""));
            container.lastChild.append(_interpolate_kwargs.call(this, create_button, [_("Customize toolbar")].concat([_desugar_kwargs({action: ui_operations.customize_toolbar})])));
            container.append(cb("show_actions_toolbar_in_fullscreen", _("Keep the toolbar in full screen mode (needs restart)")));
            container.append(cb("remember_last_read", _("Remember current page when quitting")));
            container.append(cb("restore_docks", _("Restore open panels such as Table of Contents, Search, etc. on restart")));
            container.append(cb("save_annotations_in_ebook", _("Keep a copy of annotations/bookmarks in the e-book file, for easy sharing")));
            container.append(sync_annots);
            container.append(cb("singleinstance", _("Allow only a single instance of the viewer (needs restart)")));
            container.append(cb("hide_tooltips", _("Hide mouse-over tooltips in the book text")));
            container.append(cb("auto_hide_mouse", _("Auto hide the mouse cursor when unused for a few seconds")));
            container.appendChild(create_button_box(restore_defaults, apply_func, cancel_func));
        };
        if (!create_misc_panel.__argnames__) Object.defineProperties(create_misc_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.misc"}
        });

        develop = create_misc_panel;
        function commit_misc(onchange) {
            var sd, container, vals, control, val, q, hide_tooltips;
            sd = get_session_data();
            container = get_container();
            vals = Object.create(null);
            var _Iter1 = _Iterable(Object.keys(DEFAULTS));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                q = _Iter1[_Index1];
                control = container.querySelector("[name=" + _str.format("{}", q) + "]");
                if (typeof DEFAULTS[(typeof q === "number" && q < 0) ? DEFAULTS.length + q : q] === "boolean") {
                    val = control.checked;
                } else {
                    val = control.value.strip();
                }
                if (val !== DEFAULTS[(typeof q === "number" && q < 0) ? DEFAULTS.length + q : q]) {
                    vals[(typeof q === "number" && q < 0) ? vals.length + q : q] = val;
                }
            }
            sd.set("standalone_misc_settings", vals);
            hide_tooltips = container.querySelector("[name=hide_tooltips]").checked;
            sd.set("hide_tooltips", (hide_tooltips === session_defaults().hide_tooltips) ? null : hide_tooltips);
            onchange();
        };
        if (!commit_misc.__argnames__) Object.defineProperties(commit_misc, {
            __argnames__ : {value: ["onchange"]},
            __module__ : {value: "read_book.prefs.misc"}
        });

        _modules["read_book.prefs.misc"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.misc"].develop = develop;
        _modules["read_book.prefs.misc"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.misc"].get_container = get_container;
        _modules["read_book.prefs.misc"].create_misc_panel = create_misc_panel;
        _modules["read_book.prefs.misc"].commit_misc = commit_misc;
    })();

    (function(){
        var __name__ = "read_book.prefs.scrolling";
        var CONTAINER, MIN_SCROLL_SPEED_AUTO, MAX_SCROLL_SPEED_AUTO, MIN_SCROLL_AUTO_DELAY, MAX_SCROLL_AUTO_DELAY, MIN_SCROLL_SPEED_SMOOTH, MAX_SCROLL_SPEED_SMOOTH, develop;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var unique_id = _modules.dom.unique_id;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var session_defaults = _modules.session.session_defaults;

        CONTAINER = unique_id("standalone-scrolling-settings");
        MIN_SCROLL_SPEED_AUTO = .05;
        MAX_SCROLL_SPEED_AUTO = 5;
        MIN_SCROLL_AUTO_DELAY = -1;
        MAX_SCROLL_AUTO_DELAY = 50;
        MIN_SCROLL_SPEED_SMOOTH = 5;
        MAX_SCROLL_SPEED_SMOOTH = 80;
        function restore_defaults() {
            var container, val, control;
            container = get_container();
            var _Iter0 = _Iterable(container.querySelectorAll("input[name]"));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                control = _Iter0[_Index0];
                val = (_expr_temp = session_defaults())[_bound_index(control.getAttribute("name"), _expr_temp)];
                if (control.type === "checkbox") {
                    control.checked = val;
                } else {
                    control.valueAsNumber = val;
                }
            }
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.scrolling"}
        });

        function get_container() {
            return document.getElementById(CONTAINER);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.scrolling"}
        });

        function change_scroll_speed(amt) {
            var sd, lps, nlps;
            sd = get_session_data();
            lps = sd.get("lines_per_sec_auto");
            nlps = max(MIN_SCROLL_SPEED_AUTO, min(lps + amt, MAX_SCROLL_SPEED_AUTO));
            if ((nlps !== lps && (typeof nlps !== "object" || _not_equals(nlps, lps)))) {
                sd.set("lines_per_sec_auto", nlps);
            }
            return nlps;
        };
        if (!change_scroll_speed.__argnames__) Object.defineProperties(change_scroll_speed, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "read_book.prefs.scrolling"}
        });

        function create_scrolling_panel(container, apply_func, cancel_func) {
            var sd;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER, style: "margin: 1rem"})]));
            container = container.lastChild;
            sd = get_session_data();
            function cb(name, text, title) {
                var ans;
                ans = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: name, style: "margin-left: 0"})]);
                if (sd.get(name)) {
                    ans.checked = true;
                }
                return _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.label, [ans, text].concat([_desugar_kwargs({title: title || ""})]))].concat([_desugar_kwargs({style: "margin-top:1ex"})]));
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["name", "text", "title"]},
                __module__ : {value: "read_book.prefs.scrolling"}
            });

            function spinner() {
                var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
                var text = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
                var kwargs = arguments[arguments.length-1];
                if (kwargs === null || typeof kwargs !== "object" || kwargs [_kwargs_symbol] !== true) kwargs = {};
                var ans, _unpack, key, val;
                ans = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", name: name, id: name})]);
                var _Iter1 = _Iterable(Object.entries(kwargs));
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    _unpack = _Iter1[_Index1];
                    key = _unpack[0];
                    val = _unpack[1];
                    ans[(typeof key === "number" && key < 0) ? ans.length + key : key] = val;
                }
                ans.valueAsNumber = sd.get(name, (_expr_temp = session_defaults())[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]);
                return [_interpolate_kwargs.call(E, E.label, [text].concat([_desugar_kwargs({"for": name})])), 
                ans];
            };
            if (!spinner.__handles_kwarg_interpolation__) Object.defineProperties(spinner, {
                __handles_kwarg_interpolation__ : {value: true},
                __argnames__ : {value: ["name", "text"]},
                __module__ : {value: "read_book.prefs.scrolling"}
            });

            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Control how scrolling works in paged mode")].concat([_desugar_kwargs({style: "margin-top:1ex"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-left: 1rem"})]));
            container.lastChild.appendChild(cb("paged_wheel_scrolls_by_screen", _("Mouse wheel scrolls by screen fulls instead of pages")));
            container.lastChild.appendChild(cb("paged_wheel_section_jumps", _("Horizontal mouse wheel jumps to next/previous section")));
            container.lastChild.appendChild(cb("paged_margin_clicks_scroll_by_screen", _("Clicking on the margins scrolls by screen fulls instead of pages")));
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, _interpolate_kwargs.call(this, spinner, ["paged_pixel_scroll_threshold", "" + _("Pixel scroll threshold:")].concat([_desugar_kwargs({title: _("When using a touchpad or mouse wheel that produces scroll events in pixels, set the number of pixels before a page turn is triggered"), step: 5, min: 0, max: 1e3})])).concat([_desugar_kwargs({style: "display:grid;margin-top:1ex;align-items:center;grid-template-columns:auto min-content;grid-gap:1ex; max-width: 30em"})])));
            container.appendChild(E.hr());
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Control how smooth scrolling works in flow mode")].concat([_desugar_kwargs({style: "margin-top:1ex"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-left: 1rem"})]));
            container.lastChild.appendChild(cb("scroll_stop_boundaries", _("Stop at internal file boundaries when smooth scrolling by holding down the scroll key")));
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, _interpolate_kwargs.call(this, spinner, ["lines_per_sec_smooth", _("Smooth scrolling speed in lines/sec:")].concat([_desugar_kwargs({step: 5, min: MIN_SCROLL_SPEED_SMOOTH, max: MAX_SCROLL_SPEED_SMOOTH})])).concat(_interpolate_kwargs.call(this, spinner, ["lines_per_sec_auto", _("Auto scrolling speed in lines/sec:")].concat([_desugar_kwargs({step: .05, min: MIN_SCROLL_SPEED_AUTO, max: MAX_SCROLL_SPEED_AUTO})]))).concat(_interpolate_kwargs.call(this, spinner, ["scroll_auto_boundary_delay", _("Seconds to pause before auto-scrolling past internal file boundaries:")].concat([_desugar_kwargs({title: _("Use negative values to not auto-scroll past internal file boundaries"), step: .25, min: MIN_SCROLL_AUTO_DELAY, max: MAX_SCROLL_AUTO_DELAY})]))).concat([_desugar_kwargs({style: "display:grid;margin-top:1ex;align-items:center;grid-template-columns:auto min-content;grid-gap:1ex; max-width: 30em"})])));
            container.appendChild(E.hr());
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Miscellaneous")].concat([_desugar_kwargs({style: "margin-top:1ex"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-left: 1rem"})]));
            container.lastChild.appendChild(cb("book_scrollbar", _("Show a scrollbar")));
            container.lastChild.appendChild(cb("reverse_page_turn_zones", _("Invert the page turn tap areas"), _("Have tapping on the left side turn the page forward and the right side backwards")));
            container.appendChild(create_button_box(restore_defaults, apply_func, cancel_func));
        };
        if (!create_scrolling_panel.__argnames__) Object.defineProperties(create_scrolling_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.scrolling"}
        });

        develop = create_scrolling_panel;
        function commit_scrolling(onchange) {
            var sd, container, changed, name, val, control;
            sd = get_session_data();
            container = get_container();
            changed = false;
            var _Iter2 = _Iterable(container.querySelectorAll("input[name]"));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                control = _Iter2[_Index2];
                name = control.getAttribute("name");
                val = (control.type === "checkbox") ? control.checked : control.valueAsNumber;
                if (val !== sd.get(name) && control.validity.valid) {
                    sd.set(name, val);
                    changed = true;
                }
            }
            if (changed) {
                onchange();
            }
        };
        if (!commit_scrolling.__argnames__) Object.defineProperties(commit_scrolling, {
            __argnames__ : {value: ["onchange"]},
            __module__ : {value: "read_book.prefs.scrolling"}
        });

        _modules["read_book.prefs.scrolling"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.scrolling"].MIN_SCROLL_SPEED_AUTO = MIN_SCROLL_SPEED_AUTO;
        _modules["read_book.prefs.scrolling"].MAX_SCROLL_SPEED_AUTO = MAX_SCROLL_SPEED_AUTO;
        _modules["read_book.prefs.scrolling"].MIN_SCROLL_AUTO_DELAY = MIN_SCROLL_AUTO_DELAY;
        _modules["read_book.prefs.scrolling"].MAX_SCROLL_AUTO_DELAY = MAX_SCROLL_AUTO_DELAY;
        _modules["read_book.prefs.scrolling"].MIN_SCROLL_SPEED_SMOOTH = MIN_SCROLL_SPEED_SMOOTH;
        _modules["read_book.prefs.scrolling"].MAX_SCROLL_SPEED_SMOOTH = MAX_SCROLL_SPEED_SMOOTH;
        _modules["read_book.prefs.scrolling"].develop = develop;
        _modules["read_book.prefs.scrolling"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.scrolling"].get_container = get_container;
        _modules["read_book.prefs.scrolling"].change_scroll_speed = change_scroll_speed;
        _modules["read_book.prefs.scrolling"].create_scrolling_panel = create_scrolling_panel;
        _modules["read_book.prefs.scrolling"].commit_scrolling = commit_scrolling;
    })();

    (function(){
        var __name__ = "read_book.selection_bar";
        var DRAG_SCROLL_ZONE_MIN_HEIGHT, BUTTON_MARGIN, HIDDEN, WAITING, DRAGGING, EDITING;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var get_color = _modules["book_list.theme"].get_color;

        var change_icon_image = _modules.dom.change_icon_image;
        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var create_custom_dialog = _modules.modals.create_custom_dialog;
        var error_dialog = _modules.modals.error_dialog;
        var question_dialog = _modules.modals.question_dialog;

        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var ICON_SIZE = _modules["read_book.highlights"].ICON_SIZE;
        var EditNotesAndColors = _modules["read_book.highlights"].EditNotesAndColors;
        var HighlightStyle = _modules["read_book.highlights"].HighlightStyle;
        var all_styles = _modules["read_book.highlights"].all_styles;
        var get_current_link_prefix = _modules["read_book.highlights"].get_current_link_prefix;
        var link_to_epubcfi = _modules["read_book.highlights"].link_to_epubcfi;
        var render_notes = _modules["read_book.highlights"].render_notes;

        var shortcut_for_key_event = _modules["read_book.shortcuts"].shortcut_for_key_event;

        var family_for_toc_node = _modules["read_book.toc"].family_for_toc_node;
        var get_toc_nodes_bordering_spine_item = _modules["read_book.toc"].get_toc_nodes_bordering_spine_item;

        var short_uuid = _modules.uuid.short_uuid;

        var create_button = _modules.widgets.create_button;

        var parse_url_params = _modules.utils.parse_url_params;

        DRAG_SCROLL_ZONE_MIN_HEIGHT = 10;
        BUTTON_MARGIN = "0.5rem";
        function get_margins() {
            return (function(){
                var _d = Object.create(null);
                _d["top"] = document.getElementById("book-top-margin").offsetHeight;
                _d["left"] = document.getElementById("book-left-margin").offsetWidth;
                return _d;
            }).call(this);
        };
        if (!get_margins.__module__) Object.defineProperties(get_margins, {
            __module__ : {value: "read_book.selection_bar"}
        });

        function map_boundaries(cs, vertical, rtl) {
            var margins;
            margins = get_margins();
            function map_boundary(b) {
                var x_offset, y_offset;
                x_offset = y_offset = 0;
                if (vertical) {
                    if (b.selected_prev) {
                        y_offset = b.height;
                    }
                } else {
                    if (rtl) {
                        if (!b.selected_prev) {
                            x_offset = b.width;
                        }
                    } else {
                        if (b.selected_prev) {
                            x_offset = b.width;
                        }
                    }
                }
                return (function(){
                    var _d = Object.create(null);
                    _d["x"] = (b.x || 0) + x_offset + margins.left;
                    _d["y"] = (b.y || 0) + y_offset + margins.top;
                    _d["height"] = b.height || 0;
                    _d["width"] = b.width || 0;
                    _d["onscreen"] = b.onscreen;
                    return _d;
                }).call(this);
            };
            if (!map_boundary.__argnames__) Object.defineProperties(map_boundary, {
                __argnames__ : {value: ["b"]},
                __module__ : {value: "read_book.selection_bar"}
            });

            return [map_boundary(cs.start), map_boundary(cs.end)];
        };
        if (!map_boundaries.__argnames__) Object.defineProperties(map_boundaries, {
            __argnames__ : {value: ["cs", "vertical", "rtl"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        function map_to_iframe_coords(point, margins) {
            point.x -= margins.left;
            point.y -= margins.top;
            return point;
        };
        if (!map_to_iframe_coords.__argnames__) Object.defineProperties(map_to_iframe_coords, {
            __argnames__ : {value: ["point", "margins"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        function near_element(elem, x, y) {
            var r, extend_by, left, top, right, bottom;
            r = elem.getBoundingClientRect();
            extend_by = 15;
            left = r.left - extend_by;
            top = r.top - extend_by;
            right = r.right + extend_by;
            bottom = r.bottom + extend_by;
            return left <= x && x <= right && top <= y && y <= bottom;
        };
        if (!near_element.__argnames__) Object.defineProperties(near_element, {
            __argnames__ : {value: ["elem", "x", "y"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        function position_bar_avoiding_handles(lh, rh, left, top, bar_width, bar_height, available_width, available_height, buffer) {
            var bottom, has_space_below, b, _unpack, left_overlaps, right_overlaps, h, d1, d2, q1, q2, d, d3, q3, th, bh;
            function bar_rect(left, top) {
                return (function(){
                    var _d = Object.create(null);
                    _d["left"] = left;
                    _d["top"] = top;
                    _d["right"] = left + bar_width;
                    _d["bottom"] = top + bar_height;
                    return _d;
                }).call(this);
            };
            if (!bar_rect.__argnames__) Object.defineProperties(bar_rect, {
                __argnames__ : {value: ["left", "top"]},
                __module__ : {value: "read_book.selection_bar"}
            });

            function overlaps_a_handle(left, top) {
                var b;
                b = bar_rect(left, top);
                if (elements_overlap(lh, b)) {
                    return lh;
                }
                if (elements_overlap(rh, b)) {
                    return rh;
                }
            };
            if (!overlaps_a_handle.__argnames__) Object.defineProperties(overlaps_a_handle, {
                __argnames__ : {value: ["left", "top"]},
                __module__ : {value: "read_book.selection_bar"}
            });

            if (!overlaps_a_handle(left, top)) {
                return;
            }
            if (Math.abs(lh.top - rh.top) < lh.height + buffer) {
                bottom = max(lh.bottom, rh.bottom);
                has_space_below = bottom + bar_height < available_height - buffer;
                if (has_space_below) {
                    return (function(){
                        var _d = Object.create(null);
                        _d["top"] = bottom;
                        _d["put_below"] = true;
                        return _d;
                    }).call(this);
                }
                return (function(){
                    var _d = Object.create(null);
                    _d["top"] = min(lh.top, rh.top);
                    _d["put_below"] = false;
                    return _d;
                }).call(this);
            }
            b = bar_rect(left, top);
            if (lh.left > rh.left) {
                _unpack = [rh, lh];
                lh = _unpack[0];
                rh = _unpack[1];
            }
            left_overlaps = elements_overlap(lh, b);
            right_overlaps = elements_overlap(rh, b);
            if (!left_overlaps || !right_overlaps) {
                h = (left_overlaps) ? lh : rh;
                d1 = d2 = 2 * available_width;
                q1 = h.left - bar_width - 1;
                if (q1 > -buffer && !overlaps_a_handle(q1, top)) {
                    d1 = abs(left - q1);
                }
                q2 = h.right + 1;
                if (q2 + bar_width < available_width + buffer && !overlaps_a_handle(q2, top)) {
                    d2 = abs(left - q2);
                }
                d = min(d1, d2);
                if (d < available_width) {
                    return (function(){
                        var _d = Object.create(null);
                        _d["left"] = (d === d1) ? q1 : q2;
                        return _d;
                    }).call(this);
                }
            }
            d1 = d2 = d3 = 2 * available_width;
            q1 = lh.left - bar_width - 1;
            if (q1 > -buffer && !overlaps_a_handle(q1, top)) {
                d1 = abs(left - q1);
            }
            q2 = lh.right + 1;
            if (q2 + bar_width < rh.left + buffer && !overlaps_a_handle(q2, top)) {
                d2 = abs(left - q2);
            }
            q3 = rh.right + 1;
            if (q3 + bar_width < available_width + buffer && !overlaps_a_handle(q3, top)) {
                d3 = abs(left - q3);
            }
            d = min(d1, d2, d3);
            if (d < available_width) {
                return (function(){
                    var _d = Object.create(null);
                    _d["left"] = (d === d1) ? q1 : (d === d2) ? q2 : q3;
                    return _d;
                }).call(this);
            }
            _unpack = (lh.top <= rh.top) ? [lh, rh] : [rh, lh];
_unpack = _unpack_asarray(2, _unpack);
            th = _unpack[0];
            bh = _unpack[1];
            d1 = d2 = d3 = 2 * available_height;
            q1 = th.top - bar_height - 1;
            if (q1 > -buffer && !overlaps_a_handle(left, q1)) {
                d1 = abs(top - q1);
            }
            q2 = th.bottom + 1;
            if (q2 + bar_height < bh.top + buffer && !overlaps_a_handle(left, q2)) {
                d2 = abs(top - q2);
            }
            q3 = bh.bottom + 1;
            if (q3 + bar_height < available_height + buffer && !overlaps_a_handle(left, q3)) {
                d3 = abs(top - q3);
            }
            d = min(d1, d2, d3);
            if (d < available_height) {
                return (function(){
                    var _d = Object.create(null);
                    _d["top"] = (d === d1) ? q1 + bar_height : (d === d2) ? q2 : q3;
                    _d["put_below"] = d !== d1;
                    return _d;
                }).call(this);
            }
            if (!overlaps_a_handle(buffer, buffer)) {
                return (function(){
                    var _d = Object.create(null);
                    _d["left"] = buffer;
                    _d["top"] = buffer + bar_height;
                    _d["put_below"] = false;
                    return _d;
                }).call(this);
            }
            if (!overlaps_a_handle(available_width - bar_width, buffer)) {
                return (function(){
                    var _d = Object.create(null);
                    _d["left"] = available_width - bar_width;
                    _d["top"] = buffer + bar_height;
                    _d["put_below"] = false;
                    return _d;
                }).call(this);
            }
            if (!overlaps_a_handle(buffer, available_height - bar_height)) {
                return (function(){
                    var _d = Object.create(null);
                    _d["left"] = buffer;
                    _d["top"] = available_height - bar_height;
                    _d["put_below"] = true;
                    return _d;
                }).call(this);
            }
            if (!overlaps_a_handle(available_width - bar_width, available_height - bar_height)) {
                return (function(){
                    var _d = Object.create(null);
                    _d["left"] = available_width - bar_width;
                    _d["top"] = available_height - bar_height;
                    _d["put_below"] = true;
                    return _d;
                }).call(this);
            }
        };
        if (!position_bar_avoiding_handles.__argnames__) Object.defineProperties(position_bar_avoiding_handles, {
            __argnames__ : {value: ["lh", "rh", "left", "top", "bar_width", "bar_height", "available_width", "available_height", "buffer"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        function quick_highlight_icon(name, tooltip, hcolor) {
            var svg, u, ans;
            svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("style", "fill: currentColor; height: 2ex; width: 2ex; vertical-align: text-top; margin: 0");
            u = document.createElementNS("http://www.w3.org/2000/svg", "use");
            svg.appendChild(u);
            svg.firstChild.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "#icon-" + name);
            ans = _interpolate_kwargs.call(E, E.div, [svg, _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "width: " + _str.format("{}", ICON_SIZE) + "; height: 1ex; background-color: " + _str.format("{}", hcolor) + "; color: " + _str.format("{}", hcolor) + "; margin: 0"})])].concat([_desugar_kwargs({style: "width: " + _str.format("{}", ICON_SIZE) + "; height: " + _str.format("{}", ICON_SIZE) + "; display: flex; flex-direction: column", title: tooltip || ""})]));
            return ans;
        };
        if (!quick_highlight_icon.__argnames__) Object.defineProperties(quick_highlight_icon, {
            __argnames__ : {value: ["name", "tooltip", "hcolor"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        function all_actions() {
            var qh;
            function a(icon, text, func, needs_highlight) {
                return (function(){
                    var _d = Object.create(null);
                    _d["icon"] = icon;
                    _d["text"] = text;
                    _d["function_name"] = func;
                    _d["needs_highlight"] = !!needs_highlight;
                    _d["icon_function"] = (function() {
                        var _anonfunc = function (hcolor) {
                            return svgicon(icon, ICON_SIZE, ICON_SIZE, text);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["hcolor"]},
                            __module__ : {value: "read_book.selection_bar"}
                        });
                        return _anonfunc;
                    })();
                    return _d;
                }).call(this);
            };
            if (!a.__argnames__) Object.defineProperties(a, {
                __argnames__ : {value: ["icon", "text", "func", "needs_highlight"]},
                __module__ : {value: "read_book.selection_bar"}
            });

            if (!all_actions.ans) {
                all_actions.ans = (function(){
                    var _d = Object.create(null);
                    _d["copy"] = a("copy", _("Copy to clipboard") + " [Ctrl+C]", "copy_to_clipboard");
                    _d["lookup"] = a("library", _("Lookup/search selected word") + " [L]", "lookup");
                    _d["quick_highlight"] = a("highlight", _("Quick highlight in current style") + " [Q]", "quick_highlight");
                    _d["highlight"] = a("highlight", _("Highlight selection") + " [H]", "create_highlight");
                    _d["search"] = a("search", _("Search for selection in the book") + " [F]", "book_search");
                    _d["bookmark"] = a("bookmark", _("Create a bookmark") + " [Ctrl+Alt+B]", "new_bookmark");
                    _d["search_net"] = a("global-search", _("Search for selection on the net") + " [S]", "internet_search");
                    _d["remove_highlight"] = a("trash", _("Remove this highlight") + _(" [Delete or D]"), "remove_highlight", true);
                    _d["clear"] = a("close", _("Clear selection") + " [Esc]", "clear_selection");
                    _d["speak"] = a("bullhorn", _("Read aloud") + " [T]", "speak_aloud");
                    _d["cite"] = a("reference-mode", _("Copy a citation to this text") + " [X]", "cite");
                    return _d;
                }).call(this);
                qh = all_actions.ans.quick_highlight;
                qh.icon_function = quick_highlight_icon.bind(null, qh.icon, qh.text);
            }
            return all_actions.ans;
        };
        if (!all_actions.__module__) Object.defineProperties(all_actions, {
            __module__ : {value: "read_book.selection_bar"}
        });

        function selection_handle() {
            var ans, s;
            ans = svgicon("selection-handle");
            s = ans.style;
            s.position = "absolute";
            s.boxSizing = "border-box";
            s.touchAction = "none";
            return ans;
        };
        if (!selection_handle.__module__) Object.defineProperties(selection_handle, {
            __module__ : {value: "read_book.selection_bar"}
        });

        function set_handle_color(handle, bg, fg) {
            var use;
            use = handle.querySelector("use");
            use.style.stroke = fg;
            use.style.fill = bg;
        };
        if (!set_handle_color.__argnames__) Object.defineProperties(set_handle_color, {
            __argnames__ : {value: ["handle", "bg", "fg"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        function elements_overlap(a, b) {
            return a.left < b.right && b.left < a.right && a.top < b.bottom && b.top < a.bottom;
        };
        if (!elements_overlap.__argnames__) Object.defineProperties(elements_overlap, {
            __argnames__ : {value: ["a", "b"]},
            __module__ : {value: "read_book.selection_bar"}
        });

        HIDDEN = 0;
        WAITING = 1;
        DRAGGING = 2;
        EDITING = 3;
        function SelectionBar() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            SelectionBar.prototype.__bind_methods__.call(this);
            SelectionBar.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(SelectionBar.prototype, "__bind_methods__", {value: function () {
            this.set_handle_colors = SelectionBar.prototype.set_handle_colors.bind(this);
            this.build_bar = SelectionBar.prototype.build_bar.bind(this);
            this.show_quick_highlight_buttons = SelectionBar.prototype.show_quick_highlight_buttons.bind(this);
            this.show_notes = SelectionBar.prototype.show_notes.bind(this);
            this.mousedown_on_handle = SelectionBar.prototype.mousedown_on_handle.bind(this);
            this.touchstart_on_handle = SelectionBar.prototype.touchstart_on_handle.bind(this);
            this.start_handle_drag = SelectionBar.prototype.start_handle_drag.bind(this);
            this.container_context_menu_requested = SelectionBar.prototype.container_context_menu_requested.bind(this);
            this.container_clicked = SelectionBar.prototype.container_clicked.bind(this);
            this.mousemove_on_container = SelectionBar.prototype.mousemove_on_container.bind(this);
            this.touchmove_on_container = SelectionBar.prototype.touchmove_on_container.bind(this);
            this.move_handle = SelectionBar.prototype.move_handle.bind(this);
            this.end_handle_drag = SelectionBar.prototype.end_handle_drag.bind(this);
            this.mouseup_on_container = SelectionBar.prototype.mouseup_on_container.bind(this);
            this.touchend_on_container = SelectionBar.prototype.touchend_on_container.bind(this);
            this.on_wheel = SelectionBar.prototype.on_wheel.bind(this);
            this.on_keydown = SelectionBar.prototype.on_keydown.bind(this);
            this.report_failed_edit_highlight = SelectionBar.prototype.report_failed_edit_highlight.bind(this);
            this.run_drag_scroll = SelectionBar.prototype.run_drag_scroll.bind(this);
            this.do_one_drag_scroll = SelectionBar.prototype.do_one_drag_scroll.bind(this);
            this.send_drag_scroll_message = SelectionBar.prototype.send_drag_scroll_message.bind(this);
            this.end_drag_scroll = SelectionBar.prototype.end_drag_scroll.bind(this);
            this.hide = SelectionBar.prototype.hide.bind(this);
            this.show = SelectionBar.prototype.show.bind(this);
            this.focus = SelectionBar.prototype.focus.bind(this);
            this.update_position = SelectionBar.prototype.update_position.bind(this);
            this.place_single_handle = SelectionBar.prototype.place_single_handle.bind(this);
            this.position_handles = SelectionBar.prototype.position_handles.bind(this);
            this.position_undragged_handle = SelectionBar.prototype.position_undragged_handle.bind(this);
            this.show_editor = SelectionBar.prototype.show_editor.bind(this);
            this.place_editor = SelectionBar.prototype.place_editor.bind(this);
            this.hide_editor = SelectionBar.prototype.hide_editor.bind(this);
            this.editor_container_clicked = SelectionBar.prototype.editor_container_clicked.bind(this);
            this.copy_to_clipboard = SelectionBar.prototype.copy_to_clipboard.bind(this);
            this.lookup = SelectionBar.prototype.lookup.bind(this);
            this.book_search = SelectionBar.prototype.book_search.bind(this);
            this.new_bookmark = SelectionBar.prototype.new_bookmark.bind(this);
            this.internet_search = SelectionBar.prototype.internet_search.bind(this);
            this.clear_selection = SelectionBar.prototype.clear_selection.bind(this);
            this.speak_aloud = SelectionBar.prototype.speak_aloud.bind(this);
            this.cite = SelectionBar.prototype.cite.bind(this);
            this.create_highlight = SelectionBar.prototype.create_highlight.bind(this);
            this.quick_highlight = SelectionBar.prototype.quick_highlight.bind(this);
            this.quick_highlight_with_style = SelectionBar.prototype.quick_highlight_with_style.bind(this);
            this.remove_highlight = SelectionBar.prototype.remove_highlight.bind(this);
            this.remove_highlight_with_id = SelectionBar.prototype.remove_highlight_with_id.bind(this);
            this.edit_highlight = SelectionBar.prototype.edit_highlight.bind(this);
            this.send_message = SelectionBar.prototype.send_message.bind(this);
            this.notes_edited = SelectionBar.prototype.notes_edited.bind(this);
            this.handle_message = SelectionBar.prototype.handle_message.bind(this);
        }});
        Object.defineProperties(SelectionBar.prototype,  {
            "supports_css_min_max": {
                "enumerable": true, 
                "get": function supports_css_min_max() {
                    var self = this;
                    return !runtime.is_standalone_viewer || runtime.QT_VERSION >= 331520;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById("book-selection-bar-overlay");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "bar": {
                "enumerable": true, 
                "get": function bar() {
                    var self = this;
                    return document.getElementById(self.bar_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "start_handle": {
                "enumerable": true, 
                "get": function start_handle() {
                    var self = this;
                    return document.getElementById(self.start_handle_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "end_handle": {
                "enumerable": true, 
                "get": function end_handle() {
                    var self = this;
                    return document.getElementById(self.end_handle_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "editor": {
                "enumerable": true, 
                "get": function editor() {
                    var self = this;
                    return document.getElementById(self.editor_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "annotations_manager": {
                "enumerable": true, 
                "get": function annotations_manager() {
                    var self = this;
                    return self.view.annotations_manager;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_handle_position": {
                "enumerable": true, 
                "get": function current_handle_position() {
                    var self = this;
                    var _unpack, sh, eh, sbr, ebr;
                    _unpack = [self.start_handle, self.end_handle];
                    sh = _unpack[0];
                    eh = _unpack[1];
                    _unpack = [sh.getBoundingClientRect(), eh.getBoundingClientRect()];
                    sbr = _unpack[0];
                    ebr = _unpack[1];
                    if (!self.vertical) {
                        if (!self.rtl) {
                            return (function(){
                                var _d = Object.create(null);
                                _d["start"] = (function(){
                                    var _d = Object.create(null);
                                    _d["onscreen"] = sh.style.display !== "none";
                                    _d["x"] = Math.round(sbr.right);
                                    _d["y"] = Math.round(sbr.bottom - Math.floor(self.start_line_length / 2));
                                    return _d;
                                }).call(this);
                                _d["end"] = (function(){
                                    var _d = Object.create(null);
                                    _d["onscreen"] = eh.style.display !== "none";
                                    _d["x"] = Math.round(ebr.left);
                                    _d["y"] = Math.round(ebr.bottom - Math.floor(self.end_line_length / 2));
                                    return _d;
                                }).call(this);
                                return _d;
                            }).call(this);
                        } else {
                            return (function(){
                                var _d = Object.create(null);
                                _d["start"] = (function(){
                                    var _d = Object.create(null);
                                    _d["onscreen"] = sh.style.display !== "none";
                                    _d["x"] = Math.round(sbr.left);
                                    _d["y"] = Math.round(sbr.bottom - Math.floor(self.start_line_length / 2));
                                    return _d;
                                }).call(this);
                                _d["end"] = (function(){
                                    var _d = Object.create(null);
                                    _d["onscreen"] = eh.style.display !== "none";
                                    _d["x"] = Math.round(ebr.right);
                                    _d["y"] = Math.round(ebr.bottom - Math.floor(self.end_line_length / 2));
                                    return _d;
                                }).call(this);
                                return _d;
                            }).call(this);
                        }
                    } else if (self.rtl) {
                        return (function(){
                            var _d = Object.create(null);
                            _d["start"] = (function(){
                                var _d = Object.create(null);
                                _d["onscreen"] = sh.style.display !== "none";
                                _d["x"] = Math.round(sbr.left + Math.floor(self.start_line_length / 2));
                                _d["y"] = Math.round(sbr.bottom);
                                return _d;
                            }).call(this);
                            _d["end"] = (function(){
                                var _d = Object.create(null);
                                _d["onscreen"] = eh.style.display !== "none";
                                _d["x"] = Math.round(ebr.right - Math.floor(self.end_line_length / 2));
                                _d["y"] = Math.round(ebr.top);
                                return _d;
                            }).call(this);
                            return _d;
                        }).call(this);
                    } else {
                        return (function(){
                            var _d = Object.create(null);
                            _d["start"] = (function(){
                                var _d = Object.create(null);
                                _d["onscreen"] = sh.style.display !== "none";
                                _d["x"] = Math.round(sbr.right - Math.floor(self.end_line_length / 2));
                                _d["y"] = Math.round(sbr.bottom);
                                return _d;
                            }).call(this);
                            _d["end"] = (function(){
                                var _d = Object.create(null);
                                _d["onscreen"] = eh.style.display !== "none";
                                _d["x"] = Math.round(ebr.left + Math.floor(self.start_line_length / 2));
                                _d["y"] = Math.round(ebr.top);
                                return _d;
                            }).call(this);
                            return _d;
                        }).call(this);
                    }
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        SelectionBar.prototype.__init__ = function __init__(view) {
            var self = this;
            var container, start_handle, end_handle, h, editor_div;
            self.view = view;
            self.current_highlight_style = new HighlightStyle(get_session_data().get("highlight_style"));
            self.current_notes = "";
            self.state = HIDDEN;
            self.start_handle_id = unique_id("handle");
            self.end_handle_id = unique_id("handle");
            self.bar_id = unique_id("bar");
            self.editor_id = unique_id("editor");
            self.quick_highlight_styles = [];
            self.ltr = true;
            self.rtl = false;
            self.vertical = false;
            container = self.container;
            container.style.overflow = "hidden";
            container.addEventListener("click", self.container_clicked, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("contextmenu", self.container_context_menu_requested, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("mouseup", self.mouseup_on_container, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("mousemove", self.mousemove_on_container, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("touchmove", self.touchmove_on_container, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("touchend", self.touchend_on_container, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("touchcancel", self.touchend_on_container, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("keydown", self.on_keydown, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("wheel", self.on_wheel, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.setAttribute("tabindex", "0");
            self.dragging_handle = null;
            self.position_in_handle = (function(){
                var _d = Object.create(null);
                _d["x"] = 0;
                _d["y"] = 0;
                return _d;
            }).call(this);
            self.active_touch = null;
            self.drag_scroll_timer = null;
            self.last_drag_scroll_at = null;
            self.start_line_length = self.end_line_length = 0;
            self.current_editor = null;
            start_handle = selection_handle();
            start_handle.id = self.start_handle_id;
            end_handle = selection_handle();
            end_handle.id = self.end_handle_id;
            var _Iter0 = _Iterable(_list_decorate([ start_handle, end_handle ]));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                h = _Iter0[_Index0];
                h.addEventListener("mousedown", self.mousedown_on_handle, (function(){
                    var _d = Object.create(null);
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                h.addEventListener("touchstart", self.touchstart_on_handle, (function(){
                    var _d = Object.create(null);
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                container.appendChild(h);
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: self.bar_id, style: "position: absolute; border: solid 1px currentColor; border-radius: 5px;left: 0; top: 0; display: flex; flex-direction: column;"})]));
            editor_div = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: self.editor_id, style: "position: absolute"})]);
            container.appendChild(editor_div);
            editor_div.addEventListener("click", self.editor_container_clicked, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            editor_div.addEventListener("wheel", (function() {
                var _anonfunc = function (ev) {
                    ev.stopPropagation();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.selection_bar"}
                });
                return _anonfunc;
            })(), (function(){
                var _d = Object.create(null);
                _d["passive"] = true;
                return _d;
            }).call(this));
        };
        if (!SelectionBar.prototype.__init__.__argnames__) Object.defineProperties(SelectionBar.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.__argnames__ = SelectionBar.prototype.__init__.__argnames__;
        SelectionBar.__handles_kwarg_interpolation__ = SelectionBar.prototype.__init__.__handles_kwarg_interpolation__;
        SelectionBar.prototype.set_handle_colors = function set_handle_colors() {
            var self = this;
            var handle_fill, fg, h;
            handle_fill = get_color("window-background");
            fg = self.view.current_color_scheme.foreground;
            var _Iter1 = _Iterable(_list_decorate([ self.start_handle, self.end_handle ]));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                h = _Iter1[_Index1];
                set_handle_color(h, handle_fill, fg);
            }
        };
        if (!SelectionBar.prototype.set_handle_colors.__module__) Object.defineProperties(SelectionBar.prototype.set_handle_colors, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.build_bar = function build_bar(annot_id) {
            var self = this;
            var notes, bar_container, notes_container, x, bar, hs, actions, sd, ac, acname, selection_bar_quick_highlights;
            notes = self.annotations_manager.notes_for_highlight(annot_id);
            bar_container = self.bar;
            clear(bar_container);
            bar_container.style.maxWidth = (self.supports_css_min_max) ? "min(50rem, 90vw)" : "50rem";
            bar_container.style.backgroundColor = get_color("window-background");
            notes_container = E.div();
            notes_container.addEventListener("wheel", (function() {
                var _anonfunc = function (evt) {
                    evt.stopPropagation();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["evt"]},
                    __module__ : {value: "read_book.selection_bar"}
                });
                return _anonfunc;
            })(), (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            var _Iter2 = _Iterable(_list_decorate([ _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "height: 4ex; display: flex; align-items: center; padding: 5px; justify-content: center"})]), _interpolate_kwargs.call(E, E.hr, [_desugar_kwargs({style: "border-top: solid 1px; margin: 0; padding: 0; display: none"})]), _interpolate_kwargs.call(E, E.div, [notes_container].concat([_desugar_kwargs({style: "display: none; padding: 5px;"})])) ]));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                x = _Iter2[_Index2];
                bar_container.appendChild(x);
            }
            bar = bar_container.firstChild;
            hs = self.current_highlight_style.highlight_shade(self.view.current_color_scheme.is_dark_theme);
            function cb(ac, callback) {
                var ans;
                ans = ac.icon_function(hs);
                ans.addEventListener("click", (function() {
                    var _anonfunc = function (ev) {
                        [ev.stopPropagation(), ev.preventDefault()];
                        callback(ev);
                        self.view.focus_iframe();
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.selection_bar"}
                    });
                    return _anonfunc;
                })());
                ans.classList.add("simple-link");
                ans.style.marginLeft = ans.style.marginRight = BUTTON_MARGIN;
                return ans;
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["ac", "callback"]},
                __module__ : {value: "read_book.selection_bar"}
            });

            actions = all_actions();
            sd = get_session_data();
            var _Iter3 = _Iterable(sd.get("selection_bar_actions"));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                acname = _Iter3[_Index3];
                ac = actions[(typeof acname === "number" && acname < 0) ? actions.length + acname : acname];
                if (ac && (!ac.needs_highlight || !!annot_id)) {
                    bar.appendChild(cb(ac, self[_bound_index(ac.function_name, self)]));
                }
            }
            selection_bar_quick_highlights = sd.get("selection_bar_quick_highlights");
            self.quick_highlight_styles = [];
            if ((typeof selection_bar_quick_highlights !== "undefined" && selection_bar_quick_highlights !== null ? selection_bar_quick_highlights : Object.create(null)).length) {
                self.show_quick_highlight_buttons(bar, selection_bar_quick_highlights);
            }
            self.show_notes(bar_container, notes);
            return bar_container;
        };
        if (!SelectionBar.prototype.build_bar.__argnames__) Object.defineProperties(SelectionBar.prototype.build_bar, {
            __argnames__ : {value: ["annot_id"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.show_quick_highlight_buttons = function show_quick_highlight_buttons(bar, actions) {
            var self = this;
            var all, x, a, dark, hs, sc, sw, _unpack, i, key;
            all = (function() {
                var _Iter = _Iterable(all_styles()), _Result = Object.create(null), x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    _Result[x.key] = (x);
                }
                return _Result;
            })();
            actions = (function() {
                var _Iter = _Iterable(actions), _Result = [], a;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    a = _Iter[_Index];
                    if (all[(typeof a === "number" && a < 0) ? all.length + a : a]) {
                        _Result.push(a);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            if (!actions.length) {
                return;
            }
            _interpolate_kwargs.call(actions, actions.pysort, [_desugar_kwargs({key: (function() {
                var _anonfunc = function (a) {
                    return (all[(typeof a === "number" && a < 0) ? all.length + a : a].friendly_name || "").toLowerCase();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a"]},
                    __module__ : {value: "read_book.selection_bar"}
                });
                return _anonfunc;
            })()})]);
            self.quick_highlight_styles = actions;
            bar.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "background: currentColor; width: 1px; height: " + _str.format("{}", ICON_SIZE) + "; margin-left: " + _str.format("{}", BUTTON_MARGIN) + "; margin-right: " + _str.format("{}", BUTTON_MARGIN) + ""})]));
            dark = self.view.current_color_scheme.is_dark_theme;
            var _Iter4 = _Iterable(enumerate(actions));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                _unpack = _Iter4[_Index4];
                i = _unpack[0];
                key = _unpack[1];
                hs = all[(typeof key === "number" && key < 0) ? all.length + key : key];
                if (i < 9) {
                    sc = i + 1;
                } else if ((i === 10 || typeof i === "object" && _equals(i, 10))) {
                    sc = 0;
                } else {
                    sc = null;
                }
                sw = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-link", style: "margin-left: " + _str.format("{}", BUTTON_MARGIN) + "; margin-right: " + _str.format("{}", BUTTON_MARGIN) + "", title: (_expr_temp = _("Highlight using: {name}{sc}"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({name: hs.friendly_name, sc: (sc !== null) ? " [" + _str.format("{}", sc) + "]" : ""})])), onclick: self.quick_highlight_with_style.bind(null, hs)})]);
                hs.make_swatch(sw, dark);
                bar.appendChild(sw);
            }
        };
        if (!SelectionBar.prototype.show_quick_highlight_buttons.__argnames__) Object.defineProperties(SelectionBar.prototype.show_quick_highlight_buttons, {
            __argnames__ : {value: ["bar", "actions"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.show_notes = function show_notes(bar, notes) {
            var self = this;
            var notes_container, c;
            notes = (notes || "").strip();
            if (!notes) {
                return;
            }
            notes_container = bar.lastChild;
            c = notes_container.lastChild;
            notes_container.style.display = notes_container.previousSibling.style.display = "block";
            c.style.overflow = "auto";
            if (self.supports_css_min_max) {
                c.style.maxHeight = "min(20ex, 40vh)";
            } else {
                c.style.maxHeight = "20ex";
            }
            render_notes(notes, c, true);
        };
        if (!SelectionBar.prototype.show_notes.__argnames__) Object.defineProperties(SelectionBar.prototype.show_notes, {
            __argnames__ : {value: ["bar", "notes"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.mousedown_on_handle = function mousedown_on_handle(ev) {
            var self = this;
            [ev.stopPropagation(), ev.preventDefault()];
            if (self.state === WAITING) {
                self.start_handle_drag(ev, ev.currentTarget);
            }
        };
        if (!SelectionBar.prototype.mousedown_on_handle.__argnames__) Object.defineProperties(SelectionBar.prototype.mousedown_on_handle, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.touchstart_on_handle = function touchstart_on_handle(ev) {
            var self = this;
            var touch;
            [ev.stopPropagation(), ev.preventDefault()];
            if (self.state === WAITING) {
                var _Iter5 = _Iterable(ev.changedTouches);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    touch = _Iter5[_Index5];
                    self.active_touch = touch.identifier;
                    self.start_handle_drag(touch, ev.currentTarget);
                    break;
                }
            }
        };
        if (!SelectionBar.prototype.touchstart_on_handle.__argnames__) Object.defineProperties(SelectionBar.prototype.touchstart_on_handle, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.start_handle_drag = function start_handle_drag(ev, handle) {
            var self = this;
            var r;
            self.state = DRAGGING;
            self.dragging_handle = handle.id;
            r = handle.getBoundingClientRect();
            self.position_in_handle.x = Math.round(ev.clientX - r.left);
            self.position_in_handle.y = Math.round(ev.clientY - r.top);
        };
        if (!SelectionBar.prototype.start_handle_drag.__argnames__) Object.defineProperties(SelectionBar.prototype.start_handle_drag, {
            __argnames__ : {value: ["ev", "handle"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.container_context_menu_requested = function container_context_menu_requested(ev) {
            var self = this;
            var pos;
            pos = (function(){
                var _d = Object.create(null);
                _d["x"] = ev.clientX;
                _d["y"] = ev.clientY;
                return _d;
            }).call(this);
            map_to_iframe_coords(pos, get_margins());
            _interpolate_kwargs.call(self, self.send_message, ["extend-to-point"].concat([_desugar_kwargs({pos: pos})]));
        };
        if (!SelectionBar.prototype.container_context_menu_requested.__argnames__) Object.defineProperties(SelectionBar.prototype.container_context_menu_requested, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.container_clicked = function container_clicked(ev) {
            var self = this;
            var now, pos, x;
            [ev.stopPropagation(), ev.preventDefault()];
            if (self.state === EDITING) {
                self.hide_editor(true);
            }
            if (self.state === WAITING) {
                now = window.performance.now();
                if (ev.shiftKey) {
                    pos = (function(){
                        var _d = Object.create(null);
                        _d["x"] = ev.clientX;
                        _d["y"] = ev.clientY;
                        return _d;
                    }).call(this);
                    map_to_iframe_coords(pos, get_margins());
                    _interpolate_kwargs.call(self, self.send_message, ["extend-to-point"].concat([_desugar_kwargs({pos: pos})]));
                    return;
                }
                if (self.last_double_click_at && now - self.last_double_click_at < 500) {
                    self.send_message("extend-to-paragraph");
                    return;
                }
                var _Iter6 = _Iterable(_list_decorate([ self.bar, self.start_handle, self.end_handle ]));
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    x = _Iter6[_Index6];
                    if (near_element(x, ev.clientX, ev.clientY)) {
                        return;
                    }
                }
            }
            self.clear_selection();
        };
        if (!SelectionBar.prototype.container_clicked.__argnames__) Object.defineProperties(SelectionBar.prototype.container_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.mousemove_on_container = function mousemove_on_container(ev) {
            var self = this;
            if (self.state !== DRAGGING) {
                return;
            }
            [ev.stopPropagation(), ev.preventDefault()];
            self.move_handle(ev);
        };
        if (!SelectionBar.prototype.mousemove_on_container.__argnames__) Object.defineProperties(SelectionBar.prototype.mousemove_on_container, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.touchmove_on_container = function touchmove_on_container(ev) {
            var self = this;
            var touch;
            if (self.state !== DRAGGING) {
                return;
            }
            [ev.stopPropagation(), ev.preventDefault()];
            var _Iter7 = _Iterable(ev.changedTouches);
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                touch = _Iter7[_Index7];
                if (touch.identifier === self.active_touch) {
                    self.move_handle(touch);
                    return;
                }
            }
        };
        if (!SelectionBar.prototype.touchmove_on_container.__argnames__) Object.defineProperties(SelectionBar.prototype.touchmove_on_container, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.move_handle = function move_handle(ev) {
            var self = this;
            var handle, s, margins, pos, start, position, c, rect, t, top, bottom;
            handle = document.getElementById(self.dragging_handle);
            s = handle.style;
            s.left = ev.clientX - self.position_in_handle.x + "px";
            s.top = ev.clientY - self.position_in_handle.y + "px";
            margins = get_margins();
            pos = self.current_handle_position;
            if (self.dragging_handle === self.start_handle_id) {
                start = true;
                position = map_to_iframe_coords(pos.start, margins);
            } else {
                start = false;
                position = map_to_iframe_coords(pos.end, margins);
            }
            _interpolate_kwargs.call(self, self.send_message, ["move-end-of-selection"].concat([_desugar_kwargs({start: start, pos: position})]));
            c = self.container;
            rect = c.getBoundingClientRect();
            t = document.getElementById("book-top-margin").offsetHeight;
            top = rect.top + max(t, DRAG_SCROLL_ZONE_MIN_HEIGHT);
            t = document.getElementById("book-bottom-margin").offsetHeight;
            bottom = rect.bottom - max(t, DRAG_SCROLL_ZONE_MIN_HEIGHT);
            if (ev.clientY < top || ev.clientY > bottom) {
                self.run_drag_scroll(ev.clientY, top, bottom);
            } else {
                self.end_drag_scroll();
            }
        };
        if (!SelectionBar.prototype.move_handle.__argnames__) Object.defineProperties(SelectionBar.prototype.move_handle, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.end_handle_drag = function end_handle_drag() {
            var self = this;
            var handle;
            self.end_drag_scroll();
            handle = self.dragging_handle;
            self.dragging_handle = null;
            self.state = WAITING;
            window.setTimeout(self.update_position.bind(null, handle), 0);
        };
        if (!SelectionBar.prototype.end_handle_drag.__module__) Object.defineProperties(SelectionBar.prototype.end_handle_drag, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.mouseup_on_container = function mouseup_on_container(ev) {
            var self = this;
            if (self.state === DRAGGING) {
                [ev.preventDefault(), ev.stopPropagation()];
                self.end_handle_drag();
            }
        };
        if (!SelectionBar.prototype.mouseup_on_container.__argnames__) Object.defineProperties(SelectionBar.prototype.mouseup_on_container, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.touchend_on_container = function touchend_on_container(ev) {
            var self = this;
            var touch;
            if (self.state === DRAGGING) {
                [ev.preventDefault(), ev.stopPropagation()];
                var _Iter8 = _Iterable(ev.changedTouches);
                for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                    touch = _Iter8[_Index8];
                    if (touch.identifier === self.active_touch) {
                        self.active_touch = null;
                        self.end_handle_drag();
                        return;
                    }
                }
            }
        };
        if (!SelectionBar.prototype.touchend_on_container.__argnames__) Object.defineProperties(SelectionBar.prototype.touchend_on_container, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.on_wheel = function on_wheel(ev) {
            var self = this;
            [ev.stopPropagation(), ev.preventDefault()];
            if (self.state !== EDITING) {
                self.view.send_wheel_event_to_iframe(ev, "selection-mode");
            }
        };
        if (!SelectionBar.prototype.on_wheel.__argnames__) Object.defineProperties(SelectionBar.prototype.on_wheel, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.on_keydown = function on_keydown(ev) {
            var self = this;
            var k, all, x, key, hs, sc_name, forwarded;
            [ev.stopPropagation(), ev.preventDefault()];
            if (ev.key === "Escape") {
                if (self.state === EDITING) {
                    self.hide_editor();
                } else {
                    self.clear_selection();
                }
                return;
            }
            if (self.state === WAITING && !ev.ctrlKey && !ev.altKey && !ev.metaKey) {
                k = ev.key.toLowerCase();
                if (k === "l") {
                    self.lookup();
                    return;
                }
                if (k === "q") {
                    self.quick_highlight();
                    return;
                }
                if (k === "h") {
                    self.create_highlight();
                    return;
                }
                if (k === "f") {
                    self.book_search();
                    return;
                }
                if (k === "s") {
                    self.internet_search();
                    return;
                }
                if (k === "t") {
                    self.speak_aloud();
                    return;
                }
                if (k === "x") {
                    self.cite();
                    return;
                }
                if (k === "delete" || k === "d") {
                    self.remove_highlight();
                    return;
                }
                if (_in(k, "0123456789")) {
                    all = (function() {
                        var _Iter = _Iterable(all_styles()), _Result = Object.create(null), x;
                        for (var _Index = 0; _Index < _Iter.length; _Index++) {
                            x = _Iter[_Index];
                            _Result[x.key] = (x);
                        }
                        return _Result;
                    })();
                    k = int(k);
                    if (k === 0) {
                        k = 9;
                    } else {
                        k -= 1;
                    }
                    key = (_expr_temp = self.quick_highlight_styles)[(typeof k === "number" && k < 0) ? _expr_temp.length + k : k];
                    if (key) {
                        hs = all[(typeof key === "number" && key < 0) ? all.length + key : key];
                        if (hs) {
                            self.quick_highlight_with_style(hs);
                        }
                    }
                    return;
                }
            }
            sc_name = shortcut_for_key_event(ev, self.view.keyboard_shortcut_map);
            if (!sc_name) {
                return;
            }
            forwarded = (function(){
                var _d = Object.create(null);
                _d["toggle_highlights"] = true;
                _d["edit_book"] = true;
                _d["select_all"] = true;
                _d["extend_selection_to_end_of_line"] = true;
                _d["extend_selection_to_start_of_line"] = true;
                return _d;
            }).call(this);
            if (sc_name === "show_chrome") {
                self.clear_selection();
            } else if (sc_name === "copy_to_clipboard") {
                self.copy_to_clipboard();
            } else if (sc_name === "toggle_lookup") {
                self.lookup();
            } else if (_in(sc_name, ["up", "down", "pageup", "pagedown", "left", "right"])) {
                _interpolate_kwargs.call(self, self.send_message, ["trigger-shortcut"].concat([_desugar_kwargs({name: sc_name})]));
            } else if (sc_name === "start_search") {
                self.book_search();
            } else if (sc_name === "new_bookmark") {
                self.new_bookmark();
            } else if (sc_name.startsWith("shrink_selection_by_") || sc_name.startsWith("extend_selection_by_") || forwarded[(typeof sc_name === "number" && sc_name < 0) ? forwarded.length + sc_name : sc_name]) {
                self.view.on_handle_shortcut((function(){
                    var _d = Object.create(null);
                    _d["name"] = sc_name;
                    return _d;
                }).call(this));
            }
        };
        if (!SelectionBar.prototype.on_keydown.__argnames__) Object.defineProperties(SelectionBar.prototype.on_keydown, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.report_failed_edit_highlight = function report_failed_edit_highlight(annot_id) {
            var self = this;
            var notes, has_notes, title, text;
            notes = self.annotations_manager.notes_for_highlight(annot_id);
            has_notes = bool(notes);
            title = _("Highlight text missing");
            text = _("The text associated with this highlight could not be found in the book. This can happen if the book was modified. This highlight will be automatically removed.");
            if (runtime.is_standalone_viewer || !has_notes) {
                if (has_notes) {
                    ui_operations.copy_selection(notes);
                    text += " " + _("The notes for this highlight have been copied to the clipboard.");
                }
                error_dialog(title, text);
            } else {
                create_custom_dialog(title, (function() {
                    var _anonfunc = function (parent, close_modal) {
                        parent.appendChild(E.div(E.div(text), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Copy notes to clipboard"), null, (function() {
                            var _anonfunc = function () {
                                ui_operations.copy_selection(notes);
                                close_modal();
                            };
                            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                __module__ : {value: "read_book.selection_bar"}
                            });
                            return _anonfunc;
                        })()].concat([_desugar_kwargs({highlight: true})])), "", create_button(_("OK"), null, close_modal)].concat([_desugar_kwargs({class_: "button-box"})]))));
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["parent", "close_modal"]},
                        __module__ : {value: "read_book.selection_bar"}
                    });
                    return _anonfunc;
                })());
            }
            self.remove_highlight_with_id(annot_id);
        };
        if (!SelectionBar.prototype.report_failed_edit_highlight.__argnames__) Object.defineProperties(SelectionBar.prototype.report_failed_edit_highlight, {
            __argnames__ : {value: ["annot_id"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.run_drag_scroll = function run_drag_scroll(mouse_y, top, bottom) {
            var self = this;
            var backwards;
            backwards = mouse_y <= top;
            self.do_one_drag_scroll(backwards, (backwards) ? top - mouse_y : mouse_y - bottom);
        };
        if (!SelectionBar.prototype.run_drag_scroll.__argnames__) Object.defineProperties(SelectionBar.prototype.run_drag_scroll, {
            __argnames__ : {value: ["mouse_y", "top", "bottom"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.do_one_drag_scroll = function do_one_drag_scroll(backwards, distance_from_boundary) {
            var self = this;
            var sd, in_flow_mode, interval, now;
            window.clearTimeout(self.drag_scroll_timer);
            self.drag_scroll_timer = null;
            if (self.state !== DRAGGING) {
                return;
            }
            sd = get_session_data();
            in_flow_mode = sd.get("read_mode") === "flow";
            interval = (in_flow_mode) ? 1e3 / sd.get("lines_per_sec_smooth") : 1200;
            self.drag_scroll_timer = window.setTimeout(self.do_one_drag_scroll.bind(null, backwards, distance_from_boundary), interval);
            now = window.performance.now();
            if (self.last_drag_scroll_at === null) {
                if (in_flow_mode) {
                    self.send_drag_scroll_message(backwards, (self.dragging_handle === self.start_handle_id) ? "left" : "right", true);
                }
                self.last_drag_scroll_at = now;
            } else if (now - self.last_drag_scroll_at > interval) {
                self.send_drag_scroll_message(backwards, (self.dragging_handle === self.start_handle_id) ? "left" : "right", true);
                self.last_drag_scroll_at = now;
            }
        };
        if (!SelectionBar.prototype.do_one_drag_scroll.__argnames__) Object.defineProperties(SelectionBar.prototype.do_one_drag_scroll, {
            __argnames__ : {value: ["backwards", "distance_from_boundary"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.send_drag_scroll_message = function send_drag_scroll_message(backwards, handle, extend_selection) {
            var self = this;
            _interpolate_kwargs.call(self, self.send_message, ["drag-scroll"].concat([_desugar_kwargs({backwards: backwards, handle: handle, extents: self.current_handle_position, extend_selection: extend_selection})]));
        };
        if (!SelectionBar.prototype.send_drag_scroll_message.__argnames__) Object.defineProperties(SelectionBar.prototype.send_drag_scroll_message, {
            __argnames__ : {value: ["backwards", "handle", "extend_selection"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.end_drag_scroll = function end_drag_scroll() {
            var self = this;
            if (self.drag_scroll_timer !== null) {
                window.clearTimeout(self.drag_scroll_timer);
                self.drag_scroll_timer = null;
                self.last_drag_scroll_at = null;
            }
        };
        if (!SelectionBar.prototype.end_drag_scroll.__module__) Object.defineProperties(SelectionBar.prototype.end_drag_scroll, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.hide = function hide() {
            var self = this;
            var was_shown;
            was_shown = self.state !== HIDDEN;
            self.state = HIDDEN;
            self.container.style.display = "none";
            self.view.focus_iframe();
            if (!was_shown && self.spoken_aloud_at_least_once) {
                ui_operations.speak_simple_text("");
                self.spoken_aloud_at_least_once = false;
            }
        };
        if (!SelectionBar.prototype.hide.__module__) Object.defineProperties(SelectionBar.prototype.hide, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.show = function show() {
            var self = this;
            var sd;
            sd = get_session_data();
            if (self.state === HIDDEN) {
                if (sd.get("show_selection_bar")) {
                    self.container.style.display = "block";
                    self.state = WAITING;
                    self.focus();
                }
            }
        };
        if (!SelectionBar.prototype.show.__module__) Object.defineProperties(SelectionBar.prototype.show, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.focus = function focus() {
            var self = this;
            self.container.focus();
        };
        if (!SelectionBar.prototype.focus.__module__) Object.defineProperties(SelectionBar.prototype.focus, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.update_position = function update_position(dragged_handle) {
            var self = this;
            var container, cs, h, _unpack, start, end, bar, bar_height, bar_width, buffer, limits, start_handle, end_handle, end_after_start, has_space_below, put_below, has_space_above, top, left, sh, eh, changed;
            container = self.container;
            cs = self.view.currently_showing.selection;
            self.bar.style.display = "none";
            self.set_handle_colors();
            if (self.state === DRAGGING) {
                self.show();
                self.position_undragged_handle();
                return;
            }
            if (self.state === EDITING) {
                self.start_handle.style.display = "none";
                self.end_handle.style.display = "none";
                self.show();
                self.place_editor();
                return;
            }
            self.start_handle.style.display = "none";
            self.end_handle.style.display = "none";
            self.editor.style.display = "none";
            if (!cs || cs.empty || typeof _exists.d(cs.drag_mouse_position).x === "number" || cs.selection_change_caused_by_search) {
                return self.hide();
            }
            if (!cs.start.onscreen && !cs.end.onscreen) {
                return self.hide();
            }
            self.rtl = cs.rtl;
            self.ltr = !self.rtl;
            self.vertical = cs.vertical;
            var _Iter9 = _Iterable(_list_decorate([ self.start_handle, self.end_handle ]));
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                h = _Iter9[_Index9];
                if (h.vertical !== self.vertical) {
                    h.vertical = self.vertical;
                    change_icon_image(h, (h.vertical) ? "selection-handle-vertical" : "selection-handle");
                }
            }
            self.show();
            self.bar.style.display = self.start_handle.style.display = self.end_handle.style.display = "block";
            _unpack = map_boundaries(cs, self.vertical, self.rtl);
_unpack = _unpack_asarray(2, _unpack);
            start = _unpack[0];
            end = _unpack[1];
            bar = self.build_bar(cs.annot_id);
            bar_height = bar.offsetHeight;
            bar_width = bar.offsetWidth;
            buffer = 2;
            limits = (function(){
                var _d = Object.create(null);
                _d["top"] = buffer;
                _d["bottom"] = container.offsetHeight - bar_height - buffer;
                _d["left"] = buffer;
                _d["right"] = container.offsetWidth - bar_width - buffer - 10;
                return _d;
            }).call(this);
            _unpack = [self.start_handle, self.end_handle];
            start_handle = _unpack[0];
            end_handle = _unpack[1];
            self.position_handles(start_handle, end_handle, start, end);
            function place_vertically(pos, put_below) {
                var top;
                if (put_below) {
                    top = pos;
                    bar.style.flexDirection = "column";
                } else {
                    top = pos - bar_height - buffer;
                    bar.style.flexDirection = "column-reverse";
                }
                bar.style.top = top + "px";
                return top;
            };
            if (!place_vertically.__argnames__) Object.defineProperties(place_vertically, {
                __argnames__ : {value: ["pos", "put_below"]},
                __module__ : {value: "read_book.selection_bar"}
            });

            if (dragged_handle) {
                if (dragged_handle !== self.end_handle_id) {
                    _unpack = [end, start];
                    start = _unpack[0];
                    end = _unpack[1];
                }
            } else {
                if (!cs.start_is_anchor) {
                    _unpack = [end, start];
                    start = _unpack[0];
                    end = _unpack[1];
                }
            }
            if (!end.onscreen && start.onscreen) {
                _unpack = [end, start];
                start = _unpack[0];
                end = _unpack[1];
            }
            end_after_start = start.y < end.y || start.y === end.y && start.x < end.x;
            if (end_after_start) {
                has_space_below = end.y + end.height < container.offsetHeight - bar_height - buffer;
                put_below = has_space_below;
            } else {
                has_space_above = end.y - bar_height - buffer > 0;
                put_below = !has_space_above;
            }
            top = place_vertically((put_below) ? end.y + end.height : end.y, put_below);
            left = end.x - Math.floor(bar_width / 2);
            left = max(limits.left, min(left, limits.right));
            bar.style.left = left + "px";
            _unpack = [start_handle.getBoundingClientRect(), end_handle.getBoundingClientRect()];
            sh = _unpack[0];
            eh = _unpack[1];
            changed = position_bar_avoiding_handles(sh, eh, left, top, bar_width, bar_height, container.offsetWidth - 10, container.offsetHeight, buffer);
            if (changed) {
                if (_exists.n(changed.top)) {
                    place_vertically(changed.top, changed.put_below);
                }
                if (_exists.n(changed.left)) {
                    bar.style.left = changed.left + "px";
                }
            }
        };
        if (!SelectionBar.prototype.update_position.__argnames__) Object.defineProperties(SelectionBar.prototype.update_position, {
            __argnames__ : {value: ["dragged_handle"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.place_single_handle = function place_single_handle(selection_size, handle, boundary, is_start) {
            var self = this;
            var s, width, height, bottom, top;
            s = handle.style;
            s.display = (boundary.onscreen) ? "block" : "none";
            selection_size = max(10, min(selection_size, 60));
            if (self.vertical) {
                width = selection_size * 2;
                height = int(width * 2 / 3);
            } else {
                height = selection_size * 2;
                width = int(height * 2 / 3);
            }
            s.width = "" + _str.format("{}", width) + "px";
            s.height = "" + _str.format("{}", height) + "px";
            s.transform = "none";
            if (!self.vertical) {
                bottom = boundary.y + boundary.height;
                top = bottom - height;
                s.top = "" + _str.format("{}", top) + "px";
                if (is_start) {
                    if (self.ltr) {
                        s.left = boundary.x - width + "px";
                        self.start_line_length = selection_size;
                    } else {
                        s.left = boundary.x + "px";
                        self.start_line_length = selection_size;
                        s.transform = "scaleX(-1)";
                    }
                } else {
                    if (self.ltr) {
                        s.left = boundary.x + "px";
                        self.end_line_length = selection_size;
                        s.transform = "scaleX(-1)";
                    } else {
                        s.left = boundary.x - width + "px";
                        self.end_line_length = selection_size;
                    }
                }
            } else {
                if (is_start) {
                    if (self.rtl) {
                        s.top = boundary.y - height + "px";
                        s.left = boundary.x + "px";
                        self.start_line_length = selection_size;
                        s.transform = "scaleX(-1) scaleY(-1)";
                    } else {
                        s.top = boundary.y - height + "px";
                        s.left = boundary.x - width + boundary.width + "px";
                        self.start_line_length = selection_size;
                        s.transform = "scaleY(-1)";
                    }
                } else {
                    if (self.rtl) {
                        s.top = boundary.y + "px";
                        s.left = boundary.x - width + boundary.width + "px";
                        self.end_line_length = selection_size;
                    } else {
                        s.top = boundary.y + "px";
                        s.left = boundary.x + "px";
                        self.end_line_length = selection_size;
                        s.transform = "scaleX(-1)";
                    }
                }
            }
        };
        if (!SelectionBar.prototype.place_single_handle.__argnames__) Object.defineProperties(SelectionBar.prototype.place_single_handle, {
            __argnames__ : {value: ["selection_size", "handle", "boundary", "is_start"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.position_handles = function position_handles(start_handle, end_handle, start, end) {
            var self = this;
            var selection_size;
            if (self.vertical) {
                selection_size = max(start.width, end.width);
            } else {
                selection_size = max(start.height, end.height);
            }
            self.place_single_handle(selection_size, start_handle, start, true);
            self.place_single_handle(selection_size, end_handle, end, false);
        };
        if (!SelectionBar.prototype.position_handles.__argnames__) Object.defineProperties(SelectionBar.prototype.position_handles, {
            __argnames__ : {value: ["start_handle", "end_handle", "start", "end"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.position_undragged_handle = function position_undragged_handle() {
            var self = this;
            var cs, _unpack, start, end, selection_size, handle, boundary, is_start;
            cs = self.view.currently_showing.selection;
            _unpack = map_boundaries(cs, self.vertical, self.rtl);
_unpack = _unpack_asarray(2, _unpack);
            start = _unpack[0];
            end = _unpack[1];
            if (!self.vertical) {
                selection_size = max(start.height, end.height);
            } else {
                selection_size = max(start.width, end.width);
            }
            if (self.dragging_handle === self.start_handle_id) {
                handle = self.end_handle;
                boundary = end;
                is_start = false;
            } else {
                handle = self.start_handle;
                boundary = start;
                is_start = true;
            }
            self.place_single_handle(selection_size, handle, boundary, is_start);
        };
        if (!SelectionBar.prototype.position_undragged_handle.__module__) Object.defineProperties(SelectionBar.prototype.position_undragged_handle, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.show_editor = function show_editor(highlight_style, notes) {
            var self = this;
            var x, container, cs;
            var _Iter10 = _Iterable(_list_decorate([ self.bar, self.start_handle, self.end_handle ]));
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                x = _Iter10[_Index10];
                x.style.display = "none";
            }
            container = self.editor;
            clear(container);
            container.style.display = "block";
            self.state = EDITING;
            cs = self.view.currently_showing.selection;
            self.current_editor = new EditNotesAndColors(container, self.view.current_color_scheme.is_dark_theme, notes, highlight_style, cs.annot_id, self.hide_editor);
            self.place_editor();
        };
        if (!SelectionBar.prototype.show_editor.__argnames__) Object.defineProperties(SelectionBar.prototype.show_editor, {
            __argnames__ : {value: ["highlight_style", "notes"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.place_editor = function place_editor() {
            var self = this;
            var ed, cs, _unpack, start, end, width, height, top, bottom, container, space_above, space_below, put_above, y, x;
            if (self.current_editor === null) {
                return;
            }
            ed = self.editor;
            cs = self.view.currently_showing.selection;
            _unpack = map_boundaries(cs, self.vertical, self.rtl);
_unpack = _unpack_asarray(2, _unpack);
            start = _unpack[0];
            end = _unpack[1];
            if (!start.onscreen && !end.onscreen) {
                return;
            }
            _unpack = [ed.offsetWidth, ed.offsetHeight];
            width = _unpack[0];
            height = _unpack[1];
            if (!start.onscreen) {
                start = end;
            }
            if (!end.onscreen) {
                end = start;
            }
            _unpack = (start.y <= end.y) ? [start, end] : [end, start];
_unpack = _unpack_asarray(2, _unpack);
            top = _unpack[0];
            bottom = _unpack[1];
            container = self.container;
            _unpack = [top.y, container.offsetHeight - (bottom.y + bottom.height)];
            space_above = _unpack[0];
            space_below = _unpack[1];
            if (height <= min(space_above, space_below)) {
                put_above = space_above < space_below;
            } else {
                put_above = space_above > space_below;
            }
            if (put_above) {
                y = max(0, top.y - height);
            } else {
                y = bottom.y + bottom.height;
                if (y + height > container.offsetHeight) {
                    y = container.offsetHeight - height;
                }
            }
            x = max(0, end.x - Math.floor(width / 2));
            if (x + width > container.offsetWidth) {
                x = container.offsetWidth - width;
            }
            ed.style.left = x + "px";
            ed.style.top = y + "px";
        };
        if (!SelectionBar.prototype.place_editor.__module__) Object.defineProperties(SelectionBar.prototype.place_editor, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.hide_editor = function hide_editor(apply_changes) {
            var self = this;
            var ed;
            if (!apply_changes) {
                self.state = WAITING;
                self.update_position();
                self.focus();
                return;
            }
            ed = self.current_editor;
            self.current_editor = null;
            self.current_highlight_style = ed.current_style;
            self.current_notes = ed.current_notes;
            _interpolate_kwargs.call(self, self.send_message, ["apply-highlight"].concat([_desugar_kwargs({style: self.current_highlight_style.style, uuid: short_uuid(), existing: ed.annot_id, has_notes: !!self.current_notes})]));
            self.state = WAITING;
            self.update_position();
            get_session_data().set("highlight_style", self.current_highlight_style.style);
            self.focus();
        };
        if (!SelectionBar.prototype.hide_editor.__argnames__) Object.defineProperties(SelectionBar.prototype.hide_editor, {
            __argnames__ : {value: ["apply_changes"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.editor_container_clicked = function editor_container_clicked(ev) {
            var self = this;
            [ev.stopPropagation(), ev.preventDefault()];
        };
        if (!SelectionBar.prototype.editor_container_clicked.__argnames__) Object.defineProperties(SelectionBar.prototype.editor_container_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.copy_to_clipboard = function copy_to_clipboard() {
            var self = this;
            self.view.copy_to_clipboard();
        };
        if (!SelectionBar.prototype.copy_to_clipboard.__module__) Object.defineProperties(SelectionBar.prototype.copy_to_clipboard, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.lookup = function lookup() {
            var self = this;
            if (ui_operations.toggle_lookup) {
                ui_operations.toggle_lookup(true);
            } else {
                self.view.overlay.show_word_actions(self.view.currently_showing.selection.text);
            }
        };
        if (!SelectionBar.prototype.lookup.__module__) Object.defineProperties(SelectionBar.prototype.lookup, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.book_search = function book_search() {
            var self = this;
            var cs;
            cs = _exists.d(_exists.d(self.view.currently_showing).selection).text;
            if (!cs || len(str.strip(cs)) < 2) {
                return error_dialog(_("Too little text"), _("Cannot search as too little text is selected. You must select at least two characters."));
            }
            self.view.show_search(true);
            self.clear_selection();
        };
        if (!SelectionBar.prototype.book_search.__module__) Object.defineProperties(SelectionBar.prototype.book_search, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.new_bookmark = function new_bookmark() {
            var self = this;
            self.view.new_bookmark();
        };
        if (!SelectionBar.prototype.new_bookmark.__module__) Object.defineProperties(SelectionBar.prototype.new_bookmark, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.internet_search = function internet_search() {
            var self = this;
            var text, q, url;
            text = self.view.currently_showing.selection.text;
            if (text) {
                q = encodeURIComponent(text);
                url = (_expr_temp = get_session_data().get("net_search_url"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({q: q})]));
                ui_operations.open_url(url);
            }
        };
        if (!SelectionBar.prototype.internet_search.__module__) Object.defineProperties(SelectionBar.prototype.internet_search, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.clear_selection = function clear_selection() {
            var self = this;
            self.view.on_handle_shortcut((function(){
                var _d = Object.create(null);
                _d["name"] = "clear_selection";
                return _d;
            }).call(this));
            self.hide();
        };
        if (!SelectionBar.prototype.clear_selection.__module__) Object.defineProperties(SelectionBar.prototype.clear_selection, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.speak_aloud = function speak_aloud() {
            var self = this;
            var text;
            text = self.view.currently_showing.selection.text;
            if (text) {
                ui_operations.speak_simple_text(text);
                self.spoken_aloud_at_least_once = true;
            }
        };
        if (!SelectionBar.prototype.speak_aloud.__module__) Object.defineProperties(SelectionBar.prototype.speak_aloud, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.cite = function cite() {
            var self = this;
            self.send_message("cite-current-selection");
        };
        if (!SelectionBar.prototype.cite.__module__) Object.defineProperties(SelectionBar.prototype.cite, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.create_highlight = function create_highlight() {
            var self = this;
            var cs, hs, notes, am, q;
            cs = self.view.currently_showing.selection;
            hs = self.current_highlight_style;
            notes = "";
            if (cs.annot_id) {
                am = self.annotations_manager;
                q = am.style_for_highlight(cs.annot_id);
                if (q) {
                    hs = new HighlightStyle(q);
                }
                notes = am.notes_for_highlight(cs.annot_id) || notes;
                self.show();
            }
            self.show_editor(hs, notes);
        };
        if (!SelectionBar.prototype.create_highlight.__module__) Object.defineProperties(SelectionBar.prototype.create_highlight, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.quick_highlight = function quick_highlight() {
            var self = this;
            var cs, am;
            cs = self.view.currently_showing.selection;
            if (cs.text) {
                if (cs.annot_id) {
                    am = self.annotations_manager;
                    self.current_notes = am.notes_for_highlight(cs.annot_id) || "";
                    _interpolate_kwargs.call(self, self.send_message, ["apply-highlight"].concat([_desugar_kwargs({style: self.current_highlight_style.style, uuid: short_uuid(), existing: cs.annot_id, has_notes: !!self.current_notes})]));
                } else {
                    self.current_notes = "";
                    _interpolate_kwargs.call(self, self.send_message, ["apply-highlight"].concat([_desugar_kwargs({style: self.current_highlight_style.style, uuid: short_uuid(), has_notes: false})]));
                }
                self.state = WAITING;
                self.update_position();
            }
        };
        if (!SelectionBar.prototype.quick_highlight.__module__) Object.defineProperties(SelectionBar.prototype.quick_highlight, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.quick_highlight_with_style = function quick_highlight_with_style(hs) {
            var self = this;
            self.current_highlight_style = hs;
            self.quick_highlight();
        };
        if (!SelectionBar.prototype.quick_highlight_with_style.__argnames__) Object.defineProperties(SelectionBar.prototype.quick_highlight_with_style, {
            __argnames__ : {value: ["hs"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.remove_highlight = function remove_highlight() {
            var self = this;
            var annot_id, q, text, notes;
            annot_id = self.view.currently_showing.selection.annot_id;
            if (annot_id) {
                q = _("Are you sure you want to delete this highlight permanently?");
                text = self.annotations_manager.text_for_highlight(annot_id);
                if (text && text.length) {
                    if (text.length > 20) {
                        text = text.slice(0, 20) + "";
                    }
                    notes = self.annotations_manager.notes_for_highlight(annot_id);
                    if (notes && notes.length) {
                        q = _("Are you sure you want to delete the highlighting of \"{}\" and the associated notes permanently?").format(text);
                    } else {
                        q = _("Are you sure you want to delete the highlighting of \"{}\" permanently?").format(text);
                    }
                }
                _interpolate_kwargs.call(this, question_dialog, [_("Are you sure?"), q, (function() {
                    var _anonfunc = function (yes) {
                        if (yes) {
                            self.remove_highlight_with_id(annot_id);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["yes"]},
                        __module__ : {value: "read_book.selection_bar"}
                    });
                    return _anonfunc;
                })()].concat([_desugar_kwargs({skip_dialog_name: "confirm_remove_highlight"})]));
            }
        };
        if (!SelectionBar.prototype.remove_highlight.__module__) Object.defineProperties(SelectionBar.prototype.remove_highlight, {
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.remove_highlight_with_id = function remove_highlight_with_id(annot_id) {
            var self = this;
            _interpolate_kwargs.call(self, self.send_message, ["remove-highlight"].concat([_desugar_kwargs({uuid: annot_id})]));
            self.annotations_manager.delete_highlight(annot_id);
        };
        if (!SelectionBar.prototype.remove_highlight_with_id.__argnames__) Object.defineProperties(SelectionBar.prototype.remove_highlight_with_id, {
            __argnames__ : {value: ["annot_id"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.edit_highlight = function edit_highlight(annot_id) {
            var self = this;
            _interpolate_kwargs.call(self, self.send_message, ["edit-highlight"].concat([_desugar_kwargs({uuid: annot_id})]));
        };
        if (!SelectionBar.prototype.edit_highlight.__argnames__) Object.defineProperties(SelectionBar.prototype.edit_highlight, {
            __argnames__ : {value: ["annot_id"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.send_message = function send_message() {
            var self = this;
            var type = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            _interpolate_kwargs.call(self.view.iframe_wrapper, self.view.iframe_wrapper.send_message, ["annotations"].concat([_desugar_kwargs(kw, {type: type})]));
        };
        if (!SelectionBar.prototype.send_message.__handles_kwarg_interpolation__) Object.defineProperties(SelectionBar.prototype.send_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["type"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.notes_edited = function notes_edited(annot_id) {
            var self = this;
            var notes;
            notes = self.annotations_manager.notes_for_highlight(annot_id);
            _interpolate_kwargs.call(self, self.send_message, ["notes-edited"].concat([_desugar_kwargs({uuid: annot_id, has_notes: bool(notes)})]));
        };
        if (!SelectionBar.prototype.notes_edited.__argnames__) Object.defineProperties(SelectionBar.prototype.notes_edited, {
            __argnames__ : {value: ["annot_id"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.handle_message = function handle_message(msg) {
            var self = this;
            var notes, toc_family, before, annot_id, data, spine_index, cfi, url, _unpack, key, value, info, copy_info, link_prefix, text;
            if (msg.type === "highlight-applied") {
                notes = self.current_notes;
                self.current_notes = "";
                if (!msg.ok) {
                    return error_dialog(_("Highlighting failed"), _("Failed to apply highlighting, try adjusting extent of highlight"));
                }
                toc_family = [];
                if (msg.anchor_before) {
                    toc_family = family_for_toc_node(msg.anchor_before.id);
                } else {
                    before = get_toc_nodes_bordering_spine_item()[0];
                    if (before) {
                        toc_family = family_for_toc_node(before.id);
                    }
                }
                self.annotations_manager.add_highlight(msg, self.current_highlight_style.style, notes, toc_family);
            } else if (msg.type === "highlight-overlapped") {
                question_dialog(_("Are you sure?"), _("This highlight overlaps existing highlights. Creating it will cause notes in the existing highlights to be lost. Create it anyway?"), (function() {
                    var _anonfunc = function (yes) {
                        if (yes) {
                            _interpolate_kwargs.call(self, self.send_message, ["apply-highlight-overwrite"].concat([_desugar_kwargs({style: msg.style, uuid: msg.uuid, existing: msg.existing, has_notes: msg.has_notes})]));
                        } else {
                            if (self.current_notes) {
                                self.show_editor(self.current_highlight_style, self.current_notes);
                            }
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["yes"]},
                        __module__ : {value: "read_book.selection_bar"}
                    });
                    return _anonfunc;
                })());
            } else if (msg.type === "edit-highlight") {
                if (self.state === WAITING) {
                    self.create_highlight();
                }
            } else if (msg.type === "edit-highlight-failed") {
                self.report_failed_edit_highlight(msg.uuid);
            } else if (msg.type === "double-click") {
                self.last_double_click_at = window.performance.now();
            } else if (msg.type === "cite-data") {
                annot_id = self.view.currently_showing.selection.annot_id;
                if (annot_id) {
                    data = self.annotations_manager.data_for_highlight(annot_id);
                    spine_index = self.view.currently_showing.spine_index;
                    cfi = self.annotations_manager.cfi_for_highlight(annot_id, spine_index);
                    if (runtime.is_standalone_viewer) {
                        url = get_current_link_prefix() + "?open_at=" + cfi;
                    } else {
                        url = get_current_link_prefix() + ("bookpos=" + _str.format("{}", cfi) + "");
                        var _Iter11 = _Iterable(Object.entries(parse_url_params()));
                        for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                            _unpack = _Iter11[_Index11];
                            key = _unpack[0];
                            value = _unpack[1];
                            if ((key !== "bookpos" && (typeof key !== "object" || _not_equals(key, "bookpos")))) {
                                url = url + ("&" + _str.format("{}", key) + "=" + _str.format("{}", value) + "");
                            }
                        }
                    }
                    info = (function(){
                        var _d = Object.create(null);
                        _d["text"] = data.highlighted_text;
                        _d["url"] = url;
                        _d["timestamp"] = data.timestamp;
                        _d["style_type"] = data.style.type;
                        _d["style_kind"] = data.style.kind;
                        _d["style_which"] = data.style.which;
                        _d["chapter"] = (data.toc_family_titles[0]) ? data.toc_family_titles[0] : "";
                        _d["notes"] = (_in("notes", data)) ? data.notes : "";
                        return _d;
                    }).call(this);
                    copy_info = (_expr_temp = get_session_data().get("cite_hl_template"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs(info)]));
                } else {
                    spine_index = self.view.currently_showing.spine_index;
                    spine_index = (1 + spine_index) * 2;
                    cfi = msg.bounds.start;
                    link_prefix = get_current_link_prefix();
                    if (!link_prefix) {
                        return self.view.show_not_a_library_book_error();
                    }
                    text = msg.highlighted_text.replace(/\[/g, "\\[").replace(/\]/g, "\\]");
                    url = link_to_epubcfi("epubcfi(/" + _str.format("{}", spine_index) + "" + _str.format("{}", cfi) + ")", link_prefix);
                    info = (function(){
                        var _d = Object.create(null);
                        _d["text"] = text;
                        _d["url"] = url;
                        return _d;
                    }).call(this);
                    copy_info = (_expr_temp = get_session_data().get("cite_text_template"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs(info)]));
                }
                ui_operations.copy_selection(copy_info);
            } else {
                print("Ignoring annotations message with unknown type:", msg.type);
            }
        };
        if (!SelectionBar.prototype.handle_message.__argnames__) Object.defineProperties(SelectionBar.prototype.handle_message, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.selection_bar"}
        });
        SelectionBar.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        SelectionBar.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(SelectionBar.prototype, "__bases__", {value: []});
        
        
        
        
        
        
        
        
        

        _modules["read_book.selection_bar"].DRAG_SCROLL_ZONE_MIN_HEIGHT = DRAG_SCROLL_ZONE_MIN_HEIGHT;
        _modules["read_book.selection_bar"].BUTTON_MARGIN = BUTTON_MARGIN;
        _modules["read_book.selection_bar"].HIDDEN = HIDDEN;
        _modules["read_book.selection_bar"].WAITING = WAITING;
        _modules["read_book.selection_bar"].DRAGGING = DRAGGING;
        _modules["read_book.selection_bar"].EDITING = EDITING;
        _modules["read_book.selection_bar"].get_margins = get_margins;
        _modules["read_book.selection_bar"].map_boundaries = map_boundaries;
        _modules["read_book.selection_bar"].map_to_iframe_coords = map_to_iframe_coords;
        _modules["read_book.selection_bar"].near_element = near_element;
        _modules["read_book.selection_bar"].position_bar_avoiding_handles = position_bar_avoiding_handles;
        _modules["read_book.selection_bar"].quick_highlight_icon = quick_highlight_icon;
        _modules["read_book.selection_bar"].all_actions = all_actions;
        _modules["read_book.selection_bar"].selection_handle = selection_handle;
        _modules["read_book.selection_bar"].set_handle_color = set_handle_color;
        _modules["read_book.selection_bar"].elements_overlap = elements_overlap;
        _modules["read_book.selection_bar"].SelectionBar = SelectionBar;
    })();

    (function(){
        var __name__ = "read_book.prefs.selection";
        var CONTAINER, develop;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_simple_input_with_history = _modules.complete.create_simple_input_with_history;

        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var is_dark_theme = _modules["read_book.globals"].is_dark_theme;

        var all_styles = _modules["read_book.highlights"].all_styles;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var all_actions = _modules["read_book.selection_bar"].all_actions;

        var session_defaults = _modules.session.session_defaults;

        CONTAINER = unique_id("selection-settings");
        function set_actions(use_defaults) {
            var c, adef, sd, actions, current, x, available_actions, quick_actions;
            c = get_container();
            adef = all_actions();
            sd = get_session_data();
            actions = (use_defaults) ? session_defaults().selection_bar_actions : sd.get("selection_bar_actions");
            current = (function() {
                var _Iter = _Iterable(actions), _Result = [], x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    if (adef[(typeof x === "number" && x < 0) ? adef.length + x : x]) {
                        _Result.push(x);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            c.querySelector(".current-actions").dataset.actions = JSON.stringify(current);
            available_actions = (function() {
                var _Iter = _Iterable(adef), _Result = [], x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    if (current.indexOf(x) === -1) {
                        _Result.push(x);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            c.querySelector(".available-actions").dataset.actions = JSON.stringify(available_actions);
            update_action_tables();
            quick_actions = (use_defaults) ? session_defaults().selection_bar_quick_highlights : sd.get("selection_bar_quick_highlights");
            c.querySelector(".quick-actions").dataset.actions = JSON.stringify(quick_actions);
            update_quick_action_table();
        };
        if (!set_actions.__argnames__) Object.defineProperties(set_actions, {
            __argnames__ : {value: ["use_defaults"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        function restore_defaults() {
            var container, sd, val, control, ta;
            container = get_container();
            sd = session_defaults();
            var _Iter0 = _Iterable(container.querySelectorAll("input[name]"));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                control = _Iter0[_Index0];
                val = sd[_bound_index(control.getAttribute("name"), sd)];
                if (control.type === "checkbox") {
                    control.checked = val;
                } else if (control.type === "number") {
                    control.valueAsNumber = val;
                } else {
                    control.value = val;
                }
            }
            var _Iter1 = _Iterable(container.querySelectorAll("textarea[name]"));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                ta = _Iter1[_Index1];
                val = sd[_bound_index(ta.getAttribute("name"), sd)];
                ta.value = val;
            }
            set_actions(true);
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.selection"}
        });

        function get_container() {
            return document.getElementById(CONTAINER);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.selection"}
        });

        function transfer(name, frm, to_) {
            var c, actions, idx;
            c = get_container().querySelector("." + frm);
            actions = JSON.parse(c.dataset.actions);
            idx = actions.indexOf(name);
            actions.splice(idx, 1);
            c.dataset.actions = JSON.stringify(actions);
            c = get_container().querySelector("." + to_);
            actions = JSON.parse(c.dataset.actions);
            if (to_ === "current-actions") {
                actions.unshift(name);
            } else {
                actions.push(name);
            }
            c.dataset.actions = JSON.stringify(actions);
            update_action_tables();
        };
        if (!transfer.__argnames__) Object.defineProperties(transfer, {
            __argnames__ : {value: ["name", "frm", "to_"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        function add_action(name) {
            transfer(name, "available-actions", "current-actions");
        };
        if (!add_action.__argnames__) Object.defineProperties(add_action, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        function remove_action(name) {
            transfer(name, "current-actions", "available-actions");
        };
        if (!remove_action.__argnames__) Object.defineProperties(remove_action, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        function move_action(name, up) {
            var c, actions, idx, delta, new_idx, _unpack, a, b;
            c = get_container().querySelector(".current-actions");
            actions = JSON.parse(c.dataset.actions);
            idx = actions.indexOf(name);
            delta = (up) ? -1 : 1;
            new_idx = (idx + delta + len(actions)) % len(actions);
            _unpack = [actions[(typeof idx === "number" && idx < 0) ? actions.length + idx : idx], 
            actions[(typeof new_idx === "number" && new_idx < 0) ? actions.length + new_idx : new_idx]];
            a = _unpack[0];
            b = _unpack[1];
            _unpack = [a, b];
            actions[(typeof new_idx === "number" && new_idx < 0) ? actions.length + new_idx : new_idx] = _unpack[0];
            actions[(typeof idx === "number" && idx < 0) ? actions.length + idx : idx] = _unpack[1];
            c.dataset.actions = JSON.stringify(actions);
            update_action_tables();
        };
        if (!move_action.__argnames__) Object.defineProperties(move_action, {
            __argnames__ : {value: ["name", "up"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        function build_action_table(container, is_current) {
            var adef, table, ac, buttons, icon, action_name;
            clear(container);
            adef = all_actions();
            table = _interpolate_kwargs.call(E, E.table, [_desugar_kwargs({style: "margin-left: 2rem"})]);
            container.appendChild(table);
            var _Iter2 = _Iterable(JSON.parse(container.dataset.actions));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                action_name = _Iter2[_Index2];
                ac = adef[(typeof action_name === "number" && action_name < 0) ? adef.length + action_name : action_name];
                if (is_current) {
                    buttons = E.td(_interpolate_kwargs.call(E, E.span, [_("Remove")].concat([_desugar_kwargs({class_: "simple-link", onclick: remove_action.bind(null, action_name)})])), _interpolate_kwargs.call(E, E.span, [""].concat([_desugar_kwargs({style: "min-width: 2rem; display: inline-block"})])), _interpolate_kwargs.call(E, E.span, [_("Up")].concat([_desugar_kwargs({class_: "simple-link", onclick: move_action.bind(null, action_name, true)})])), _interpolate_kwargs.call(E, E.span, [""].concat([_desugar_kwargs({style: "min-width: 2rem; display: inline-block"})])), _interpolate_kwargs.call(E, E.span, [_("Down")].concat([_desugar_kwargs({class_: "simple-link", onclick: move_action.bind(null, action_name, false)})])));
                } else {
                    buttons = E.td(_interpolate_kwargs.call(E, E.span, [_("Add")].concat([_desugar_kwargs({class_: "simple-link", onclick: add_action.bind(null, action_name)})])));
                }
                buttons.style.paddingLeft = "2rem";
                if (ac.icon_function) {
                    icon = ac.icon_function("#add8ff");
                } else {
                    icon = svgicon(ac.icon);
                }
                table.appendChild(E.tr(_interpolate_kwargs.call(E, E.td, [icon].concat([_desugar_kwargs({style: "padding: 1ex"})])), E.td(ac.text), buttons));
            }
        };
        if (!build_action_table.__argnames__) Object.defineProperties(build_action_table, {
            __argnames__ : {value: ["container", "is_current"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        function update_action_tables() {
            var c, current;
            c = get_container();
            current = c.querySelector(".current-actions");
            build_action_table(current, true);
            current = c.querySelector(".available-actions");
            build_action_table(current, false);
        };
        if (!update_action_tables.__module__) Object.defineProperties(update_action_tables, {
            __module__ : {value: "read_book.prefs.selection"}
        });

        function update_quick_action_table() {
            var c, current, x, actions, hs;
            c = get_container().querySelector(".quick-actions");
            clear(c);
            c.style.display = "flex";
            c.style.flexWrap = "wrap";
            current = (function() {
                var _Iter = _Iterable(JSON.parse(c.dataset.actions)), _Result = Object.create(null), x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    _Result[x] = (true);
                }
                return _Result;
            })();
            actions = list(all_styles());
            _interpolate_kwargs.call(actions, actions.pysort, [_desugar_kwargs({key: (function() {
                var _anonfunc = function (a) {
                    return (a.friendly_name || "").toLowerCase();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["a"]},
                    __module__ : {value: "read_book.prefs.selection"}
                });
                return _anonfunc;
            })()})]);
            var _Iter3 = _Iterable(actions);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                hs = _Iter3[_Index3];
                c.appendChild(_interpolate_kwargs.call(E, E.label, [hs.make_swatch(E.span(), is_dark_theme()), "", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", value: hs.key, checked: current[_bound_index(hs.key, current)]})]), "", hs.friendly_name].concat([_desugar_kwargs({style: "margin: 1ex; display: flex; align-contents: center"})])));
            }
        };
        if (!update_quick_action_table.__module__) Object.defineProperties(update_quick_action_table, {
            __module__ : {value: "read_book.prefs.selection"}
        });

        function selected_quick_actions() {
            var ans, c, inp;
            ans = [];
            c = get_container().querySelector(".quick-actions");
            var _Iter4 = _Iterable(c.querySelectorAll("input:checked"));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                inp = _Iter4[_Index4];
                if (inp.value) {
                    ans.push(inp.value);
                }
            }
            return ans;
        };
        if (!selected_quick_actions.__module__) Object.defineProperties(selected_quick_actions, {
            __module__ : {value: "read_book.prefs.selection"}
        });

        function create_selection_panel(container, apply_func, cancel_func) {
            var sd;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER, style: "margin: 1rem"})]));
            container = container.lastChild;
            sd = get_session_data();
            function cb(name, text) {
                var ans;
                ans = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: name})]);
                if (sd.get(name)) {
                    ans.checked = true;
                }
                return _interpolate_kwargs.call(E, E.div, [E.label(ans, "" + text)].concat([_desugar_kwargs({style: "margin-top:1ex"})]));
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["name", "text"]},
                __module__ : {value: "read_book.prefs.selection"}
            });

            function url(name, text, title) {
                var ans, inp;
                ans = _interpolate_kwargs.call(this, create_simple_input_with_history, [name].concat([_desugar_kwargs({input_type: "url"})]));
                inp = ans.querySelector("input[name=" + _str.format("{}", name) + "]");
                inp.value = sd.get(name) || "";
                inp.setAttribute("size", "50");
                inp.style.marginTop = "1ex";
                return _interpolate_kwargs.call(E, E.div, [E.label(text, E.br(), ans)].concat([_desugar_kwargs({style: "margin-top:1ex"})]));
            };
            if (!url.__argnames__) Object.defineProperties(url, {
                __argnames__ : {value: ["name", "text", "title"]},
                __module__ : {value: "read_book.prefs.selection"}
            });

            function cite_template_textarea(name, text, title) {
                var ans;
                ans = _interpolate_kwargs.call(E, E.textarea, [_desugar_kwargs({name: name, style: "width: 100%; margin-top: 1ex; box-sizing: border-box; flex-grow: 10"})]);
                ans.value = sd.get(name);
                return _interpolate_kwargs.call(E, E.div, [E.label(text, E.br(), ans)].concat([_desugar_kwargs({style: "margin-top:1ex"})]));
            };
            if (!cite_template_textarea.__argnames__) Object.defineProperties(cite_template_textarea, {
                __argnames__ : {value: ["name", "text", "title"]},
                __module__ : {value: "read_book.prefs.selection"}
            });

            container.appendChild(cb("show_selection_bar", _("Show a popup bar with common actions next to selected text")));
            container.appendChild(url("net_search_url", _("URL to query when searching the internet"), _("The {q} in the URL is replaced by the selected text")));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Customize which actions are shown in the selection popup bar")].concat([_desugar_kwargs({style: "margin-top: 2ex; border-top: solid 1px; padding-top: 1ex;"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.h3(_("Current actions")), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "current-actions"})]), E.h3(_("Available actions")), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "available-actions"})])].concat([_desugar_kwargs({style: "padding: 1ex; border-bottom: solid 1px; margin-bottom: 1ex"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.h3(_("Quick highlight actions")), E.div(_("Choose highlight styles that will have dedicated buttons in the selection bar to create highlights with a single click")), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "quick-actions"})])].concat([_desugar_kwargs({style: "padding: 1ex; border-bottom: solid 1px; margin-bottom: 1ex"})])));
            container.appendChild(E.h3(_("Citing text")));
            container.appendChild(cite_template_textarea("cite_text_template", _("Template for citing plain text:")));
            container.appendChild(cite_template_textarea("cite_hl_template", _("Template for citing highlighted text:")));
            container.appendChild(E.div(_interpolate_kwargs.call(E, E.div, [(_expr_temp = _("{text} and {url} are available in both types of template. Additionally, {timestamp}, {chapter}, {notes}, {style_type}, {style_kind} and {style_which} are available when citing a highlight."), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({text: "{text}", url: "{url}", chapter: "{chapter}", notes: "{notes}", style_type: "{style_type}", style_kind: "{style_kind}", style_which: "{style_which}", timestamp: "{timestamp}"})]))].concat([_desugar_kwargs({style: "margin-top: 2ex"})])), _interpolate_kwargs.call(E, E.div, [_("Use \"}}\" and \"{{\" to escape \"}\" and \"{\".")].concat([_desugar_kwargs({style: "margin-top: 2ex; margin-bottom: 2ex; border-bottom: solid 1px; padding-bottom: 1ex;"})]))));
            set_actions();
            container.appendChild(create_button_box(restore_defaults, apply_func, cancel_func));
        };
        if (!create_selection_panel.__argnames__) Object.defineProperties(create_selection_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        develop = create_selection_panel;
        function commit_selection(onchange) {
            var sd, container, changed, save_ev, x, name, val, control, actions, quick_highlights, old, ta;
            sd = get_session_data();
            container = get_container();
            changed = false;
            save_ev = new Event("save_history");
            var _Iter5 = _Iterable(container.querySelectorAll("[data-calibre-history-input]"));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                x = _Iter5[_Index5];
                x.dispatchEvent(save_ev);
            }
            var _Iter6 = _Iterable(container.querySelectorAll("input[name]"));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                control = _Iter6[_Index6];
                name = control.getAttribute("name");
                if (control.type === "checkbox") {
                    val = control.checked;
                } else if (control.type === "number") {
                    val = control.valueAsNumber;
                } else {
                    val = control.value;
                }
                if (val !== sd.get(name) && control.validity.valid) {
                    sd.set(name, val);
                    changed = true;
                }
            }
            actions = JSON.parse(container.querySelector(".current-actions").dataset.actions);
            if (_not_equals(list(actions), list(sd.get("selection_bar_actions")))) {
                changed = true;
                sd.set("selection_bar_actions", actions);
            }
            quick_highlights = selected_quick_actions();
            if (_not_equals(list(quick_highlights), list(sd.get("selection_bar_quick_highlights")))) {
                changed = true;
                sd.set("selection_bar_quick_highlights", quick_highlights);
            }
            var _Iter7 = _Iterable(container.querySelectorAll("textarea[name]"));
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                ta = _Iter7[_Index7];
                name = ta.getAttribute("name");
                val = (ta.value || "").strip() || (_expr_temp = session_defaults())[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
                old = sd.get(name);
                if (old !== val) {
                    sd.set(name, val);
                    changed = true;
                }
            }
            if (changed) {
                onchange();
            }
        };
        if (!commit_selection.__argnames__) Object.defineProperties(commit_selection, {
            __argnames__ : {value: ["onchange"]},
            __module__ : {value: "read_book.prefs.selection"}
        });

        _modules["read_book.prefs.selection"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.selection"].develop = develop;
        _modules["read_book.prefs.selection"].set_actions = set_actions;
        _modules["read_book.prefs.selection"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.selection"].get_container = get_container;
        _modules["read_book.prefs.selection"].transfer = transfer;
        _modules["read_book.prefs.selection"].add_action = add_action;
        _modules["read_book.prefs.selection"].remove_action = remove_action;
        _modules["read_book.prefs.selection"].move_action = move_action;
        _modules["read_book.prefs.selection"].build_action_table = build_action_table;
        _modules["read_book.prefs.selection"].update_action_tables = update_action_tables;
        _modules["read_book.prefs.selection"].update_quick_action_table = update_quick_action_table;
        _modules["read_book.prefs.selection"].selected_quick_actions = selected_quick_actions;
        _modules["read_book.prefs.selection"].create_selection_panel = create_selection_panel;
        _modules["read_book.prefs.selection"].commit_selection = commit_selection;
    })();

    (function(){
        var __name__ = "read_book.prefs.touch";
        var CONTAINER, develop;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var allowed_actions_for_flow_mode_drag = _modules["read_book.gestures"].allowed_actions_for_flow_mode_drag;
        var allowed_actions_for_flow_mode_flick = _modules["read_book.gestures"].allowed_actions_for_flow_mode_flick;
        var allowed_actions_for_paged_mode_swipe = _modules["read_book.gestures"].allowed_actions_for_paged_mode_swipe;
        var allowed_actions_for_tap = _modules["read_book.gestures"].allowed_actions_for_tap;
        var allowed_actions_for_two_fingers = _modules["read_book.gestures"].allowed_actions_for_two_fingers;
        var current_action_for_gesture_type = _modules["read_book.gestures"].current_action_for_gesture_type;
        var get_action_descriptions = _modules["read_book.gestures"].get_action_descriptions;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var GESTURE = _modules["read_book.touch"].GESTURE;
        var GESTURE_NAMES = _modules["read_book.touch"].GESTURE_NAMES;

        CONTAINER = unique_id("touch-settings");
        function restore_defaults() {
            apply_settings_to_ui(Object.create(null));
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.touch"}
        });

        function get_container() {
            return document.getElementById(CONTAINER);
        };
        if (!get_container.__module__) Object.defineProperties(get_container, {
            __module__ : {value: "read_book.prefs.touch"}
        });

        function apply_settings_to_ui(overrides) {
            var group_name, in_flow_mode, allowed_actions, option, gesture_type, current_action, select, group;
            overrides = overrides || Object.create(null);
            var _Iter0 = _Iterable(get_container().querySelectorAll("[data-group]"));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                group = _Iter0[_Index0];
                group_name = group.dataset.group;
                in_flow_mode = group_name.indexOf("flow") >= 0;
                var _Iter1 = _Iterable(group.querySelectorAll("select"));
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    select = _Iter1[_Index1];
                    allowed_actions = [];
                    var _Iter2 = _Iterable(select.querySelectorAll("option"));
                    for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                        option = _Iter2[_Index2];
                        allowed_actions.push(option.value);
                    }
                    gesture_type = select.name;
                    current_action = current_action_for_gesture_type(overrides, gesture_type, in_flow_mode);
                    if (allowed_actions.indexOf(current_action) < 0) {
                        current_action = current_action_for_gesture_type(Object.create(null), gesture_type, in_flow_mode);
                    }
                    if (!current_action || allowed_actions.indexOf(current_action) < 0) {
                        current_action = "none";
                    }
                    select.value = current_action;
                    select.dispatchEvent(new Event("change", (function(){
                        var _d = Object.create(null);
                        _d["view"] = window;
                        _d["bubbles"] = true;
                        return _d;
                    }).call(this)));
                }
            }
        };
        if (!apply_settings_to_ui.__argnames__) Object.defineProperties(apply_settings_to_ui, {
            __argnames__ : {value: ["overrides"]},
            __module__ : {value: "read_book.prefs.touch"}
        });

        function get_overrides_from_ui() {
            var ans, group_name, in_flow_mode, attr, val, defval, select, group, which;
            ans = Object.create(null);
            var _Iter3 = _Iterable(get_container().querySelectorAll("[data-group]"));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                group = _Iter3[_Index3];
                group_name = group.dataset.group;
                in_flow_mode = group_name.indexOf("flow") >= 0;
                if (group_name === "paged_swipe") {
                    attr = "paged_mode";
                } else if (group_name === "flow_swipe") {
                    attr = "flow_mode";
                } else {
                    attr = "common";
                }
                if (!ans[(typeof attr === "number" && attr < 0) ? ans.length + attr : attr]) {
                    ans[(typeof attr === "number" && attr < 0) ? ans.length + attr : attr] = Object.create(null);
                }
                var _Iter4 = _Iterable(group.querySelectorAll("select"));
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    select = _Iter4[_Index4];
                    val = select.value;
                    defval = current_action_for_gesture_type(Object.create(null), select.name, in_flow_mode);
                    if (val !== defval) {
                        (_expr_temp = ans[(typeof attr === "number" && attr < 0) ? ans.length + attr : attr])[_bound_index(select.name, _expr_temp)] = val;
                    }
                }
            }
            var _Iter5 = _Iterable(Object.keys(ans));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                which = _Iter5[_Index5];
                if (Object.keys(ans[(typeof which === "number" && which < 0) ? ans.length + which : which]).length === 0) {
                    delete ans[which];
                }
            }
            return ans;
        };
        if (!get_overrides_from_ui.__module__) Object.defineProperties(get_overrides_from_ui, {
            __module__ : {value: "read_book.prefs.touch"}
        });

        function create_touch_panel(container, apply_func, cancel_func) {
            var sd, overrides, action_descriptions, in_flow_mode, c, aat, aap, aaf;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: CONTAINER, style: "margin: 1rem"})]));
            container = container.lastChild;
            sd = get_session_data();
            overrides = sd.get("gesture_overrides");
            action_descriptions = get_action_descriptions();
            in_flow_mode = false;
            function on_select_change(ev) {
                var select, ad, span;
                select = ev.target;
                ad = action_descriptions[_bound_index(select.value, action_descriptions)];
                span = select.parentNode.querySelector("span");
                span.textContent = ad.long;
            };
            if (!on_select_change.__argnames__) Object.defineProperties(on_select_change, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "read_book.prefs.touch"}
            });

            function make_setting(gesture_type, allowed_actions) {
                var ans, title, sid, select, ad, action;
                ans = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 1ex"})]);
                title = (_expr_temp = GESTURE_NAMES())[(typeof gesture_type === "number" && gesture_type < 0) ? _expr_temp.length + gesture_type : gesture_type];
                sid = unique_id(gesture_type);
                ans.appendChild(E.h4(_interpolate_kwargs.call(E, E.label, [title].concat([_desugar_kwargs({"for": sid})]))));
                select = _interpolate_kwargs.call(E, E.select, [_desugar_kwargs({name: gesture_type, id: sid})]);
                var _Iter6 = _Iterable(allowed_actions);
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    action = _Iter6[_Index6];
                    ad = action_descriptions[(typeof action === "number" && action < 0) ? action_descriptions.length + action : action];
                    select.appendChild(_interpolate_kwargs.call(E, E.option, [ad.short].concat([_desugar_kwargs({value: action})])));
                }
                select.addEventListener("change", on_select_change);
                ans.appendChild(E.div(select, "", _interpolate_kwargs.call(E, E.span, [_desugar_kwargs({style: "font-size: smaller; font-style: italic"})])));
                on_select_change((function(){
                    var _d = Object.create(null);
                    _d["target"] = select;
                    return _d;
                }).call(this));
                return ans;
            };
            if (!make_setting.__argnames__) Object.defineProperties(make_setting, {
                __argnames__ : {value: ["gesture_type", "allowed_actions"]},
                __module__ : {value: "read_book.prefs.touch"}
            });

            container.appendChild(E.h2(_("Tapping")));
            container.appendChild(E.div(_("There are three tap zones, depending on where on the screen you tap. When the tap is on a link, the link is followed, otherwise a configurable action based on the zone is performed.")));
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({"data-group": "tap"})]);
            container.appendChild(c);
            aat = allowed_actions_for_tap();
            c.appendChild(make_setting(GESTURE.control_zone_tap, aat));
            c.appendChild(make_setting(GESTURE.forward_zone_tap, aat));
            c.appendChild(make_setting(GESTURE.back_zone_tap, aat));
            c.appendChild(make_setting(GESTURE.long_tap, aat));
            container.appendChild(E.hr());
            container.appendChild(E.h2(_("Two finger gestures")));
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({"data-group": "two_finger"})]);
            container.appendChild(c);
            aat = allowed_actions_for_two_fingers();
            c.appendChild(make_setting(GESTURE.two_finger_tap, aat));
            c.appendChild(make_setting(GESTURE.pinch_in, aat));
            c.appendChild(make_setting(GESTURE.pinch_out, aat));
            container.appendChild(E.hr());
            container.appendChild(E.h2(_("Swiping")));
            container.appendChild(E.div(_("Swiping works differently in paged and flow mode, with different actions. For an English like language, swiping in the writing direction means swiping horizontally. For languages written vertically, it means swiping vertically. For languages written left-to-right \"going forward\" means swiping right-to-left, like turning a page with your finger.")));
            container.appendChild(_interpolate_kwargs.call(E, E.h3, [_("Swiping in paged mode")].concat([_desugar_kwargs({style: "padding-top: 1ex"})])));
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({"data-group": "paged_swipe"})]);
            container.appendChild(c);
            aap = allowed_actions_for_paged_mode_swipe();
            c.appendChild(make_setting(GESTURE.flick_block_forward, aap));
            c.appendChild(make_setting(GESTURE.flick_block_backward, aap));
            c.appendChild(make_setting(GESTURE.flick_inline_forward, aap));
            c.appendChild(make_setting(GESTURE.flick_inline_backward, aap));
            c.appendChild(make_setting(GESTURE.swipe_inline_forward_hold, aap));
            c.appendChild(make_setting(GESTURE.swipe_inline_backward_hold, aap));
            c.appendChild(make_setting(GESTURE.swipe_block_forward_hold, aap));
            c.appendChild(make_setting(GESTURE.swipe_block_backward_hold, aap));
            container.appendChild(E.hr());
            container.appendChild(_interpolate_kwargs.call(E, E.h3, [_("Swiping in flow mode")].concat([_desugar_kwargs({style: "padding-top: 1ex"})])));
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({"data-group": "flow_swipe"})]);
            container.appendChild(c);
            in_flow_mode = true;
            in_flow_mode;
            aaf = allowed_actions_for_flow_mode_flick();
            c.appendChild(make_setting(GESTURE.flick_block_forward, aaf));
            c.appendChild(make_setting(GESTURE.flick_block_backward, aaf));
            c.appendChild(make_setting(GESTURE.flick_inline_forward, aaf));
            c.appendChild(make_setting(GESTURE.flick_inline_backward, aaf));
            aaf = allowed_actions_for_flow_mode_drag();
            c.appendChild(make_setting(GESTURE.swipe_inline_backward_in_progress, aaf));
            c.appendChild(make_setting(GESTURE.swipe_inline_forward_in_progress, aaf));
            c.appendChild(make_setting(GESTURE.swipe_block_backward_in_progress, aaf));
            c.appendChild(make_setting(GESTURE.swipe_block_forward_in_progress, aaf));
            container.appendChild(E.hr());
            container.appendChild(create_button_box(restore_defaults, apply_func, cancel_func));
            apply_settings_to_ui(overrides);
        };
        if (!create_touch_panel.__argnames__) Object.defineProperties(create_touch_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.touch"}
        });

        develop = create_touch_panel;
        function commit_touch(onchange) {
            var sd, current_overrides, overrides, changed;
            sd = get_session_data();
            current_overrides = sd.get("gesture_overrides");
            overrides = get_overrides_from_ui();
            changed = (overrides !== current_overrides && (typeof overrides !== "object" || _not_equals(overrides, current_overrides)));
            if (changed) {
                sd.set("gesture_overrides", overrides);
                onchange();
            }
        };
        if (!commit_touch.__argnames__) Object.defineProperties(commit_touch, {
            __argnames__ : {value: ["onchange"]},
            __module__ : {value: "read_book.prefs.touch"}
        });

        _modules["read_book.prefs.touch"].CONTAINER = CONTAINER;
        _modules["read_book.prefs.touch"].develop = develop;
        _modules["read_book.prefs.touch"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.touch"].get_container = get_container;
        _modules["read_book.prefs.touch"].apply_settings_to_ui = apply_settings_to_ui;
        _modules["read_book.prefs.touch"].get_overrides_from_ui = get_overrides_from_ui;
        _modules["read_book.prefs.touch"].create_touch_panel = create_touch_panel;
        _modules["read_book.prefs.touch"].commit_touch = commit_touch;
    })();

    (function(){
        var __name__ = "viewer";

    })();

    (function(){
        var __name__ = "viewer.constants";
        var FAKE_PROTOCOL, FAKE_HOST;
        FAKE_PROTOCOL = "clbr";
        FAKE_HOST = "internal.invalid";
        _modules["viewer.constants"].FAKE_PROTOCOL = FAKE_PROTOCOL;
        _modules["viewer.constants"].FAKE_HOST = FAKE_HOST;
    })();

    (function(){
        var __name__ = "read_book.prefs.user_stylesheet";
        var BLANK, develop;
        var E = _modules.elementmaker.E;

        var absolute_path = _modules.ajax.absolute_path;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var ensure_id = _modules.dom.ensure_id;
        var unique_id = _modules.dom.unique_id;

        var hexlify = _modules.encodings.hexlify;

        var _ = _modules.gettext.gettext;

        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button_box = _modules["read_book.prefs.utils"].create_button_box;

        var session_defaults = _modules.session.session_defaults;

        var FAKE_HOST = _modules["viewer.constants"].FAKE_HOST;
        var FAKE_PROTOCOL = _modules["viewer.constants"].FAKE_PROTOCOL;

        var create_button = _modules.widgets.create_button;

        BLANK = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
        function change_background_image(img_id) {
            ui_operations.change_background_image(img_id);
        };
        if (!change_background_image.__argnames__) Object.defineProperties(change_background_image, {
            __argnames__ : {value: ["img_id"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function clear_image(img_id) {
            var i;
            i = document.getElementById(img_id);
            i.src = BLANK;
            i.dataset.url = "";
        };
        if (!clear_image.__argnames__) Object.defineProperties(clear_image, {
            __argnames__ : {value: ["img_id"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function modify_background_image_url_for_fetch(url) {
            var encoded, x;
            if (!url) {
                return BLANK;
            }
            if (runtime.is_standalone_viewer) {
                if (url.startswith("" + _str.format("{}", FAKE_PROTOCOL) + ":")) {
                    return url;
                }
                encoded = hexlify(url);
                return "" + _str.format("{}", FAKE_PROTOCOL) + "://" + _str.format("{}", FAKE_HOST) + "/reader-background-" + _str.format("{}", encoded) + "";
            }
            if (url.startswith("" + _str.format("{}", FAKE_PROTOCOL) + ":")) {
                x = (_expr_temp = str.split(url, "/"))[_expr_temp.length-1].partition("?")[0].partition("-")[2];
                return absolute_path("reader-background/" + _str.format("{}", x) + "");
            }
            return url;
        };
        if (!modify_background_image_url_for_fetch.__argnames__) Object.defineProperties(modify_background_image_url_for_fetch, {
            __argnames__ : {value: ["url"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function standalone_background_widget(sd) {
            var url, src, img_id;
            url = sd.get("background_image");
            src = modify_background_image_url_for_fetch(url);
            img_id = unique_id("bg-image");
            return _interpolate_kwargs.call(E, E.div, [E.div(_interpolate_kwargs.call(E, E.img, [_desugar_kwargs({src: src, data_url: url, id: img_id, class_: "bg-image-preview", style: "width: 75px; height: 75px; border: solid 1px"})])), _interpolate_kwargs.call(E, E.div, [""].concat([_desugar_kwargs({style: "margin: 0.5rem"})])), _interpolate_kwargs.call(this, create_button, [_("Change image")].concat([_desugar_kwargs({action: change_background_image.bind(null, img_id)})])), _interpolate_kwargs.call(E, E.div, [""].concat([_desugar_kwargs({style: "margin: 0.5rem"})])), _interpolate_kwargs.call(this, create_button, [_("Clear image")].concat([_desugar_kwargs({action: clear_image.bind(null, img_id)})]))].concat([_desugar_kwargs({style: "display: flex; align-items: center"})]));
        };
        if (!standalone_background_widget.__argnames__) Object.defineProperties(standalone_background_widget, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function background_widget(sd) {
            if (runtime.is_standalone_viewer) {
                return standalone_background_widget(sd);
            }
            return _interpolate_kwargs.call(E, E.div, [E.label(_("Image URL") + ":", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "url", name: "background_image", value: sd.get("background_image") || ""})]))].concat([_desugar_kwargs({style: "margin-bottom: 1ex"})]));
        };
        if (!background_widget.__argnames__) Object.defineProperties(background_widget, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function background_style_widget(sd) {
            var ans;
            ans = _interpolate_kwargs.call(E, E.div, [E.label(_("Background image style") + ":", _interpolate_kwargs.call(E, E.select, [_interpolate_kwargs.call(E, E.option, [_("Scaled")].concat([_desugar_kwargs({value: "scaled"})])), _interpolate_kwargs.call(E, E.option, [_("Tiled")].concat([_desugar_kwargs({value: "tiled"})]))].concat([_desugar_kwargs({name: "background_image_style"})])))].concat([_desugar_kwargs({style: "margin-bottom: 1ex"})]));
            ans.querySelector("select").value = sd.get("background_image_style");
            return ans;
        };
        if (!background_style_widget.__argnames__) Object.defineProperties(background_style_widget, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function background_fade_widget(sd) {
            return E.div(E.label(_("Background image fade (%)") + ":", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({name: "background_image_fade", type: "number", max: "100", min: "0", step: "1", value: "" + sd.get("background_image_fade"), title: _("Fading of the background image is done by blending it with the background color")})])));
        };
        if (!background_fade_widget.__argnames__) Object.defineProperties(background_fade_widget, {
            __argnames__ : {value: ["sd"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function restore_defaults() {
            var container, i;
            container = document.getElementById(create_user_stylesheet_panel.container_id);
            container.querySelector("[name=user-stylesheet]").value = "";
            if (runtime.is_standalone_viewer) {
                i = container.querySelector("img");
                clear_image(i.id);
            } else {
                container.querySelector("[name=background_image]").value = "";
            }
            container.querySelector("select[name=background_image_style]").value = session_defaults().background_image_style;
            container.querySelector("input[name=background_image_fade]").value = str(session_defaults().background_image_fade);
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        function create_user_stylesheet_panel(container, apply_func, cancel_func) {
            var sd, val;
            sd = get_session_data();
            create_user_stylesheet_panel.container_id = ensure_id(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_("Choose a background image to display behind the book text")].concat([_desugar_kwargs({style: "margin-bottom: 1.5ex"})])), background_widget(sd), background_style_widget(sd), background_fade_widget(sd)].concat([_desugar_kwargs({style: "border-bottom: solid 1px; margin-bottom: 1.5ex; padding-bottom: 1.5ex"})])), _interpolate_kwargs.call(E, E.div, [E.div(_("A CSS style sheet that can be used to control the look and feel of the text. For examples, click"), " ", _interpolate_kwargs.call(E, E.a, [_("here.")].concat([_desugar_kwargs({class_: "blue-link", title: _("Examples of user style sheets"), target: (runtime.is_standalone_viewer) ? "_self" : "_blank", href: "https://www.mobileread.com/forums/showthread.php?t=51500"})])), " ", _("Note that you can use the selectors body.calibre-viewer-paginated and body.calibre-viewer-scrolling to target the Paged and Flow modes. Similarly, use body.calibre-viewer-light-colors and body.calibre-viewer-dark-colors to target light and dark color schemes.")), _interpolate_kwargs.call(E, E.textarea, [_desugar_kwargs({name: "user-stylesheet", style: "width: 100%; margin-top: 1ex; box-sizing: border-box; flex-grow: 10"})])].concat([_desugar_kwargs({style: "flex-grow: 10; display: flex; flex-flow: column"})]))].concat([_desugar_kwargs({style: "min-height: 75vh; display: flex; flex-flow: column; margin: 1ex 1rem; padding: 1ex 0"})])));
            val = sd.get("user_stylesheet");
            if (val) {
                container.querySelector("[name=user-stylesheet]").value = val;
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [create_button_box(restore_defaults, apply_func, cancel_func)].concat([_desugar_kwargs({style: "margin: 1rem"})])));
        };
        if (!create_user_stylesheet_panel.__argnames__) Object.defineProperties(create_user_stylesheet_panel, {
            __argnames__ : {value: ["container", "apply_func", "cancel_func"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        develop = create_user_stylesheet_panel;
        function commit_user_stylesheet(onchange, container) {
            var sd, ta, val, old, changed, bg_image, bis, bif;
            sd = get_session_data();
            ta = container.querySelector("[name=user-stylesheet]");
            val = ta.value || "";
            old = sd.get("user_stylesheet");
            changed = false;
            if (old !== val) {
                sd.set("user_stylesheet", val);
                changed = true;
            }
            if (runtime.is_standalone_viewer) {
                bg_image = container.querySelector("img.bg-image-preview").dataset.url;
                if (bg_image === BLANK || !bg_image) {
                    bg_image = null;
                }
            } else {
                bg_image = container.querySelector("input[name=background_image]").value;
            }
            old = sd.get("background_image");
            if (old !== bg_image) {
                sd.set("background_image", bg_image);
                changed = true;
            }
            old = sd.get("background_image_style");
            bis = container.querySelector("select[name=background_image_style]").value;
            if (bis !== old) {
                changed = true;
                sd.set("background_image_style", bis);
            }
            old = int(sd.get("background_image_fade"));
            bif = int(container.querySelector("input[name=background_image_fade]").value);
            if (old !== bif) {
                changed = true;
                sd.set("background_image_fade", bif);
            }
            if (changed) {
                onchange();
            }
        };
        if (!commit_user_stylesheet.__argnames__) Object.defineProperties(commit_user_stylesheet, {
            __argnames__ : {value: ["onchange", "container"]},
            __module__ : {value: "read_book.prefs.user_stylesheet"}
        });

        _modules["read_book.prefs.user_stylesheet"].BLANK = BLANK;
        _modules["read_book.prefs.user_stylesheet"].develop = develop;
        _modules["read_book.prefs.user_stylesheet"].change_background_image = change_background_image;
        _modules["read_book.prefs.user_stylesheet"].clear_image = clear_image;
        _modules["read_book.prefs.user_stylesheet"].modify_background_image_url_for_fetch = modify_background_image_url_for_fetch;
        _modules["read_book.prefs.user_stylesheet"].standalone_background_widget = standalone_background_widget;
        _modules["read_book.prefs.user_stylesheet"].background_widget = background_widget;
        _modules["read_book.prefs.user_stylesheet"].background_style_widget = background_style_widget;
        _modules["read_book.prefs.user_stylesheet"].background_fade_widget = background_fade_widget;
        _modules["read_book.prefs.user_stylesheet"].restore_defaults = restore_defaults;
        _modules["read_book.prefs.user_stylesheet"].create_user_stylesheet_panel = create_user_stylesheet_panel;
        _modules["read_book.prefs.user_stylesheet"].commit_user_stylesheet = commit_user_stylesheet;
    })();

    (function(){
        var __name__ = "read_book.prefs.main";
        var E = _modules.elementmaker.E;

        var build_list = _modules["book_list.item_list"].build_list;
        var create_item = _modules["book_list.item_list"].create_item;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;
        var set_title = _modules["book_list.top_bar"].set_title;

        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;

        var _ = _modules.gettext.gettext;

        var runtime = _modules["read_book.globals"].runtime;

        var commit_colors = _modules["read_book.prefs.colors"].commit_colors;
        var create_colors_panel = _modules["read_book.prefs.colors"].create_colors_panel;

        var commit_fonts = _modules["read_book.prefs.fonts"].commit_fonts;
        var create_fonts_panel = _modules["read_book.prefs.fonts"].create_fonts_panel;

        var commit_head_foot = _modules["read_book.prefs.head_foot"].commit_head_foot;
        var create_head_foot_panel = _modules["read_book.prefs.head_foot"].create_head_foot_panel;

        var commit_keyboard = _modules["read_book.prefs.keyboard"].commit_keyboard;
        var create_keyboard_panel = _modules["read_book.prefs.keyboard"].create_keyboard_panel;

        var commit_layout = _modules["read_book.prefs.layout"].commit_layout;
        var create_layout_panel = _modules["read_book.prefs.layout"].create_layout_panel;

        var commit_misc = _modules["read_book.prefs.misc"].commit_misc;
        var create_misc_panel = _modules["read_book.prefs.misc"].create_misc_panel;

        var commit_scrolling = _modules["read_book.prefs.scrolling"].commit_scrolling;
        var create_scrolling_panel = _modules["read_book.prefs.scrolling"].create_scrolling_panel;

        var commit_selection = _modules["read_book.prefs.selection"].commit_selection;
        var create_selection_panel = _modules["read_book.prefs.selection"].create_selection_panel;

        var commit_touch = _modules["read_book.prefs.touch"].commit_touch;
        var create_touch_panel = _modules["read_book.prefs.touch"].create_touch_panel;

        var commit_user_stylesheet = _modules["read_book.prefs.user_stylesheet"].commit_user_stylesheet;
        var create_user_stylesheet_panel = _modules["read_book.prefs.user_stylesheet"].create_user_stylesheet_panel;

        function Prefs() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Prefs.prototype.__bind_methods__.call(this);
            Prefs.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Prefs.prototype, "__bind_methods__", {value: function () {
            this.set_top_title = Prefs.prototype.set_top_title.bind(this);
            this.onchange = Prefs.prototype.onchange.bind(this);
            this.cancel = Prefs.prototype.cancel.bind(this);
            this.onclose = Prefs.prototype.onclose.bind(this);
            this.create_panel = Prefs.prototype.create_panel.bind(this);
            this.display_panel = Prefs.prototype.display_panel.bind(this);
            this.show_panel = Prefs.prototype.show_panel.bind(this);
            this.display_top = Prefs.prototype.display_top.bind(this);
            this.display_fonts = Prefs.prototype.display_fonts.bind(this);
            this.close_fonts = Prefs.prototype.close_fonts.bind(this);
            this.display_misc = Prefs.prototype.display_misc.bind(this);
            this.close_misc = Prefs.prototype.close_misc.bind(this);
            this.display_colors = Prefs.prototype.display_colors.bind(this);
            this.close_colors = Prefs.prototype.close_colors.bind(this);
            this.display_layout = Prefs.prototype.display_layout.bind(this);
            this.close_layout = Prefs.prototype.close_layout.bind(this);
            this.display_user_stylesheet = Prefs.prototype.display_user_stylesheet.bind(this);
            this.close_user_stylesheet = Prefs.prototype.close_user_stylesheet.bind(this);
            this.display_head_foot = Prefs.prototype.display_head_foot.bind(this);
            this.close_head_foot = Prefs.prototype.close_head_foot.bind(this);
            this.display_keyboard = Prefs.prototype.display_keyboard.bind(this);
            this.close_keyboard = Prefs.prototype.close_keyboard.bind(this);
            this.display_scrolling = Prefs.prototype.display_scrolling.bind(this);
            this.close_scrolling = Prefs.prototype.close_scrolling.bind(this);
            this.display_selection = Prefs.prototype.display_selection.bind(this);
            this.close_selection = Prefs.prototype.close_selection.bind(this);
            this.display_touch = Prefs.prototype.display_touch.bind(this);
            this.close_touch = Prefs.prototype.close_touch.bind(this);
        }});
        Object.defineProperties(Prefs.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.container_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        Prefs.prototype.__init__ = function __init__(container, close_func, on_change) {
            var self = this;
            self.close_func = close_func;
            self.on_change = on_change;
            self.main_title = _("Configure book reader");
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "flex-grow: 100; overflow: auto"})])].concat([_desugar_kwargs({style: "contain: paint; width: 100%; height: 100%; display: flex; flex-direction: column", tabindex: "-1", onkeydown: (function() {
                var _anonfunc = function (ev) {
                    if (ev.key === "Escape") {
                        [ev.stopPropagation(), ev.preventDefault()];
                        if (!self.cancel()) {
                            self.close_func();
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.prefs.main"}
                });
                return _anonfunc;
            })()})])));
            container = container.firstChild;
            _interpolate_kwargs.call(this, create_top_bar, [container.firstChild].concat([_desugar_kwargs({title: self.main_title, icon: "close", action: self.onclose})]));
            self.container_id = ensure_id(container.lastChild);
            self.stack = ["top"];
            self.display_top(container.lastChild);
        };
        if (!Prefs.prototype.__init__.__argnames__) Object.defineProperties(Prefs.prototype.__init__, {
            __argnames__ : {value: ["container", "close_func", "on_change"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.__argnames__ = Prefs.prototype.__init__.__argnames__;
        Prefs.__handles_kwarg_interpolation__ = Prefs.prototype.__init__.__handles_kwarg_interpolation__;
        Prefs.prototype.set_top_title = function set_top_title(val) {
            var self = this;
            set_title(self.container.parentNode, val);
        };
        if (!Prefs.prototype.set_top_title.__argnames__) Object.defineProperties(Prefs.prototype.set_top_title, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.onchange = function onchange() {
            var self = this;
            self.on_change();
        };
        if (!Prefs.prototype.onchange.__module__) Object.defineProperties(Prefs.prototype.onchange, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.cancel = function cancel() {
            var self = this;
            if (self.stack.length > 1) {
                self.stack.pop();
                self.display_panel((_expr_temp = self.stack)[_expr_temp.length-1]);
                return true;
            }
        };
        if (!Prefs.prototype.cancel.__module__) Object.defineProperties(Prefs.prototype.cancel, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.onclose = function onclose() {
            var self = this;
            var which, close_func;
            if (self.stack.length > 1) {
                which = self.stack.pop();
                close_func = getattr(self, "close_" + which, null);
                if (close_func) {
                    close_func.bind(self)();
                }
                self.display_panel((_expr_temp = self.stack)[_expr_temp.length-1]);
            } else {
                self.close_func();
            }
        };
        if (!Prefs.prototype.onclose.__module__) Object.defineProperties(Prefs.prototype.onclose, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.create_panel = function create_panel(container, which, create_func, needs_onchange) {
            var self = this;
            self.set_top_title((_expr_temp = self.title_map)[(typeof which === "number" && which < 0) ? _expr_temp.length + which : which] || which);
            if (needs_onchange) {
                create_func(container, self.onclose, self.cancel, self.onchange);
            } else {
                create_func(container, self.onclose, self.cancel);
            }
        };
        if (!Prefs.prototype.create_panel.__argnames__) Object.defineProperties(Prefs.prototype.create_panel, {
            __argnames__ : {value: ["container", "which", "create_func", "needs_onchange"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_panel = function display_panel(which) {
            var self = this;
            var container;
            container = self.container;
            clear(container);
            getattr(self, "display_" + which)(container);
            container.setAttribute("tabindex", "-1");
            container.focus();
        };
        if (!Prefs.prototype.display_panel.__argnames__) Object.defineProperties(Prefs.prototype.display_panel, {
            __argnames__ : {value: ["which"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.show_panel = function show_panel(which) {
            var self = this;
            self.stack.push(which);
            self.display_panel(which);
        };
        if (!Prefs.prototype.show_panel.__argnames__) Object.defineProperties(Prefs.prototype.show_panel, {
            __argnames__ : {value: ["which"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_top = function display_top(container) {
            var self = this;
            var c, items;
            self.set_top_title(self.main_title);
            c = E.div();
            container.appendChild(c);
            self.title_map = Object.create(null);
            items = _list_decorate([]);
            function ci(title, which, subtitle) {
                items.push(create_item(title, self.show_panel.bind(null, which), subtitle));
                (_expr_temp = self.title_map)[(typeof which === "number" && which < 0) ? _expr_temp.length + which : which] = title;
            };
            if (!ci.__argnames__) Object.defineProperties(ci, {
                __argnames__ : {value: ["title", "which", "subtitle"]},
                __module__ : {value: "read_book.prefs.main"}
            });

            ci(_("Colors"), "colors", _("Colors of the page and text"));
            ci(_("Page layout"), "layout", _("Page margins and number of pages per screen"));
            ci(_("Styles"), "user_stylesheet", _("Style rules for text and background image"));
            ci(_("Headers and footers"), "head_foot", _("Customize the headers and footers"));
            ci(_("Scrolling behavior"), "scrolling", _("Control how the viewer scrolls"));
            ci(_("Selection behavior"), "selection", _("Control how the viewer selects text"));
            ci(_("Touch behavior"), "touch", _("Customize what various touchscreen gestures do"));
            ci(_("Keyboard shortcuts"), "keyboard", _("Customize the keyboard shortcuts"));
            if (runtime.is_standalone_viewer) {
                ci(_("Fonts"), "fonts", _("Font choices"));
                ci(_("Miscellaneous"), "misc", _("Window size, last read position, toolbar, etc."));
            }
            build_list(c, items);
        };
        if (!Prefs.prototype.display_top.__argnames__) Object.defineProperties(Prefs.prototype.display_top, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_fonts = function display_fonts(container) {
            var self = this;
            self.create_panel(container, "fonts", create_fonts_panel);
        };
        if (!Prefs.prototype.display_fonts.__argnames__) Object.defineProperties(Prefs.prototype.display_fonts, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_fonts = function close_fonts() {
            var self = this;
            commit_fonts(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_fonts.__module__) Object.defineProperties(Prefs.prototype.close_fonts, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_misc = function display_misc(container) {
            var self = this;
            self.create_panel(container, "misc", create_misc_panel);
        };
        if (!Prefs.prototype.display_misc.__argnames__) Object.defineProperties(Prefs.prototype.display_misc, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_misc = function close_misc() {
            var self = this;
            commit_misc(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_misc.__module__) Object.defineProperties(Prefs.prototype.close_misc, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_colors = function display_colors(container) {
            var self = this;
            self.create_panel(container, "colors", create_colors_panel);
        };
        if (!Prefs.prototype.display_colors.__argnames__) Object.defineProperties(Prefs.prototype.display_colors, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_colors = function close_colors() {
            var self = this;
            commit_colors(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_colors.__module__) Object.defineProperties(Prefs.prototype.close_colors, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_layout = function display_layout(container) {
            var self = this;
            self.create_panel(container, "layout", create_layout_panel);
        };
        if (!Prefs.prototype.display_layout.__argnames__) Object.defineProperties(Prefs.prototype.display_layout, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_layout = function close_layout() {
            var self = this;
            commit_layout(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_layout.__module__) Object.defineProperties(Prefs.prototype.close_layout, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_user_stylesheet = function display_user_stylesheet(container) {
            var self = this;
            self.create_panel(container, "user_stylesheet", create_user_stylesheet_panel);
        };
        if (!Prefs.prototype.display_user_stylesheet.__argnames__) Object.defineProperties(Prefs.prototype.display_user_stylesheet, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_user_stylesheet = function close_user_stylesheet() {
            var self = this;
            commit_user_stylesheet(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_user_stylesheet.__module__) Object.defineProperties(Prefs.prototype.close_user_stylesheet, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_head_foot = function display_head_foot(container) {
            var self = this;
            self.create_panel(container, "head_foot", create_head_foot_panel);
        };
        if (!Prefs.prototype.display_head_foot.__argnames__) Object.defineProperties(Prefs.prototype.display_head_foot, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_head_foot = function close_head_foot() {
            var self = this;
            commit_head_foot(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_head_foot.__module__) Object.defineProperties(Prefs.prototype.close_head_foot, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_keyboard = function display_keyboard(container) {
            var self = this;
            self.create_panel(container, "keyboard", create_keyboard_panel, true);
        };
        if (!Prefs.prototype.display_keyboard.__argnames__) Object.defineProperties(Prefs.prototype.display_keyboard, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_keyboard = function close_keyboard() {
            var self = this;
            commit_keyboard(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_keyboard.__module__) Object.defineProperties(Prefs.prototype.close_keyboard, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_scrolling = function display_scrolling(container) {
            var self = this;
            self.create_panel(container, "scrolling", create_scrolling_panel);
        };
        if (!Prefs.prototype.display_scrolling.__argnames__) Object.defineProperties(Prefs.prototype.display_scrolling, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_scrolling = function close_scrolling() {
            var self = this;
            commit_scrolling(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_scrolling.__module__) Object.defineProperties(Prefs.prototype.close_scrolling, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_selection = function display_selection(container) {
            var self = this;
            self.create_panel(container, "selection", create_selection_panel);
        };
        if (!Prefs.prototype.display_selection.__argnames__) Object.defineProperties(Prefs.prototype.display_selection, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_selection = function close_selection() {
            var self = this;
            commit_selection(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_selection.__module__) Object.defineProperties(Prefs.prototype.close_selection, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.display_touch = function display_touch(container) {
            var self = this;
            self.create_panel(container, "touch", create_touch_panel);
        };
        if (!Prefs.prototype.display_touch.__argnames__) Object.defineProperties(Prefs.prototype.display_touch, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.close_touch = function close_touch() {
            var self = this;
            commit_touch(self.onchange, self.container);
        };
        if (!Prefs.prototype.close_touch.__module__) Object.defineProperties(Prefs.prototype.close_touch, {
            __module__ : {value: "read_book.prefs.main"}
        });
        Prefs.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Prefs.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Prefs.prototype, "__bases__", {value: []});
        

        function create_prefs_panel(container, close_func, on_change) {
            return new Prefs(container, close_func, on_change);
        };
        if (!create_prefs_panel.__argnames__) Object.defineProperties(create_prefs_panel, {
            __argnames__ : {value: ["container", "close_func", "on_change"]},
            __module__ : {value: "read_book.prefs.main"}
        });

        _modules["read_book.prefs.main"].Prefs = Prefs;
        _modules["read_book.prefs.main"].create_prefs_panel = create_prefs_panel;
    })();

    (function(){
        var __name__ = "read_book.word_actions";
        var current_data;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var create_item = _modules["book_list.item_list"].create_item;
        var create_item_list = _modules["book_list.item_list"].create_item_list;

        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;

        var error_dialog = _modules.modals.error_dialog;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_button = _modules.widgets.create_button;

        function lookup(close_panel_func, url) {
            close_panel_func();
            ui_operations.open_url(url);
        };
        if (!lookup.__argnames__) Object.defineProperties(lookup, {
            __argnames__ : {value: ["close_panel_func", "url"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function toggle_custom_container(container_id, visible) {
            var container, c, list_container;
            container = document.getElementById(container_id);
            if (container) {
                c = container.lastChild;
                list_container = c.previousSibling;
                list_container.style.display = (visible) ? "none" : "block";
                c.style.display = (visible) ? "block" : "none";
                return c;
            }
        };
        if (!toggle_custom_container.__argnames__) Object.defineProperties(toggle_custom_container, {
            __argnames__ : {value: ["container_id", "visible"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function add(container_id) {
            var container, c, name, url, sd, actions;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            c = container.lastChild;
            name = c.querySelector("input[name=\"name\"]").value;
            url = c.querySelector("input[name=\"url\"]").value;
            if (!name || !url) {
                error_dialog(_("Required fields missing"), _("You must specify both a name and a URL."));
                return;
            }
            sd = get_session_data();
            actions = sd.get("word_actions", []);
            actions.push((function(){
                var _d = Object.create(null);
                _d["title"] = name;
                _d["url"] = url;
                return _d;
            }).call(this));
            sd.set("word_actions", actions);
            toggle_custom_container(container_id, false);
            populate_list(container);
        };
        if (!add.__argnames__) Object.defineProperties(add, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function add_custom(container_id) {
            var container, do_add;
            container = toggle_custom_container(container_id, true);
            if (!container) {
                return;
            }
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Enter the name and URL for a custom lookup source. The URL must contain  {0} in it, which will be replaced by the word being looked up. For example:  {1}").format("{word}", "https://google.com/search?q={word}")].concat([_desugar_kwargs({style: "margin: 1rem"})])));
            do_add = add.bind(null, container_id);
            container.appendChild(E.form(_interpolate_kwargs.call(E, E.button, [_desugar_kwargs({style: "display:none", onclick: do_add})]), _interpolate_kwargs.call(E, E.table, [E.tr(E.td(_("Name:") + ""), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: "name"})]))), E.tr(E.td(""), E.td("")), E.tr(E.td(_("URL:") + ""), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "url", name: "url"})])))].concat([_desugar_kwargs({style: "margin: 1rem"})]))));
            container.append(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Add"), "plus", add.bind(null, container_id)].concat([_desugar_kwargs({highlight: true})])), "", _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: toggle_custom_container.bind(null, container_id, false)})]))].concat([_desugar_kwargs({style: "margin: 1rem; display: flex"})])));
            container.querySelector("input").focus();
        };
        if (!add_custom.__argnames__) Object.defineProperties(add_custom, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function remove(container_id, num) {
            var container, sd, actions;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            sd = get_session_data();
            actions = sd.get("word_actions", []);
            actions.splice(num, 1);
            sd.set("word_actions", actions);
            toggle_custom_container(container_id, false);
            populate_list(container);
        };
        if (!remove.__argnames__) Object.defineProperties(remove, {
            __argnames__ : {value: ["container_id", "num"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function remove_custom(container_id) {
            var container, items, sd, actions, _unpack, i, item;
            container = toggle_custom_container(container_id, true);
            if (!container) {
                return;
            }
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Choose a custom lookup to remove")].concat([_desugar_kwargs({style: "margin: 1rem"})])));
            items = _list_decorate([ create_item(_("Cancel (no removals)"), toggle_custom_container.bind(null, container_id, false)) ]);
            sd = get_session_data();
            actions = sd.get("word_actions", []);
            var _Iter0 = _Iterable(enumerate(actions));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                _unpack = _Iter0[_Index0];
                i = _unpack[0];
                item = _unpack[1];
                items.push(create_item(item.title, remove.bind(null, container_id, i)));
            }
            container.appendChild(E.div());
            create_item_list(container.lastChild, items);
        };
        if (!remove_custom.__argnames__) Object.defineProperties(remove_custom, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function lookup_items(word, close_panel_func, container_id) {
            var eword, items, custom_actions, has_custom, entry;
            eword = encodeURIComponent(word);
            items = _list_decorate([]);
            function a(title, url) {
                items.push(create_item(title, lookup.bind(word, close_panel_func, _interpolate_kwargs.call(url, url.format, [_desugar_kwargs({word: eword})]))));
            };
            if (!a.__argnames__) Object.defineProperties(a, {
                __argnames__ : {value: ["title", "url"]},
                __module__ : {value: "read_book.word_actions"}
            });

            custom_actions = get_session_data().get("word_actions", []);
            has_custom = custom_actions && custom_actions.length;
            if (has_custom) {
                var _Iter1 = _Iterable(custom_actions);
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    entry = _Iter1[_Index1];
                    if (entry.title && entry.url) {
                        a(entry.title, entry.url);
                    }
                }
            }
            a(_("Google dictionary"), "https://google.com/search?q=define:{word}");
            a(_("Wordnik"), "https://www.wordnik.com/words/{word}");
            a(_("Search the internet"), "https://google.com/search?q={word}");
            items.push(create_item(_("Add a custom lookup"), add_custom.bind(null, container_id)));
            if (has_custom) {
                items.push(create_item(_("Remove a custom lookup"), remove_custom.bind(null, container_id)));
            }
            return items;
        };
        if (!lookup_items.__argnames__) Object.defineProperties(lookup_items, {
            __argnames__ : {value: ["word", "close_panel_func", "container_id"]},
            __module__ : {value: "read_book.word_actions"}
        });

        current_data = null;
        function populate_list(container) {
            var _unpack, word, close_panel_func, list_container;
            _unpack = current_data;
_unpack = _unpack_asarray(2, _unpack);
            word = _unpack[0];
            close_panel_func = _unpack[1];
            list_container = container.lastChild.previousSibling;
            clear(list_container);
            create_item_list(list_container, lookup_items(word, close_panel_func, ensure_id(container)));
        };
        if (!populate_list.__argnames__) Object.defineProperties(populate_list, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function create_word_actions_panel(container, word, close_panel_func) {
            word = str.replace(word, "\u00ad", "");
            current_data = [word, close_panel_func];
            container.appendChild(E.div());
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:none"})]));
            populate_list(container);
        };
        if (!create_word_actions_panel.__argnames__) Object.defineProperties(create_word_actions_panel, {
            __argnames__ : {value: ["container", "word", "close_panel_func"]},
            __module__ : {value: "read_book.word_actions"}
        });

        function develop(container) {
            container.appendChild(E.div());
            create_word_actions_panel(container, "develop", (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.word_actions"}
                });
                return _anonfunc;
            })());
        };
        if (!develop.__argnames__) Object.defineProperties(develop, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.word_actions"}
        });

        _modules["read_book.word_actions"].current_data = current_data;
        _modules["read_book.word_actions"].lookup = lookup;
        _modules["read_book.word_actions"].toggle_custom_container = toggle_custom_container;
        _modules["read_book.word_actions"].add = add;
        _modules["read_book.word_actions"].add_custom = add_custom;
        _modules["read_book.word_actions"].remove = remove;
        _modules["read_book.word_actions"].remove_custom = remove_custom;
        _modules["read_book.word_actions"].lookup_items = lookup_items;
        _modules["read_book.word_actions"].populate_list = populate_list;
        _modules["read_book.word_actions"].create_word_actions_panel = create_word_actions_panel;
        _modules["read_book.word_actions"].develop = develop;
    })();

    (function(){
        var __name__ = "read_book.overlay";
        var MAIN_OVERLAY_TS_CLASS, MAIN_OVERLAY_ACTIONS_CLASS;
        var E = _modules.elementmaker.E;

        var BD_CLASS_NAME = _modules["book_list.book_details"].CLASS_NAME;
        var render_metadata = _modules["book_list.book_details"].render_metadata;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var set_book_metadata = _modules["book_list.library_data"].set_book_metadata;
        var sync_library_books = _modules["book_list.library_data"].sync_library_books;

        var home = _modules["book_list.router"].home;

        var get_color = _modules["book_list.theme"].get_color;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var query_as_href = _modules["book_list.ui"].query_as_href;
        var show_panel = _modules["book_list.ui"].show_panel;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var error_dialog = _modules.modals.error_dialog;
        var question_dialog = _modules.modals.question_dialog;

        var create_bookmarks_panel = _modules["read_book.bookmarks"].create_bookmarks_panel;

        var runtime = _modules["read_book.globals"].runtime;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var create_goto_panel = _modules["read_book.goto"].create_goto_panel;
        var create_location_overlay = _modules["read_book.goto"].create_location_overlay;

        var create_highlights_panel = _modules["read_book.highlights"].create_highlights_panel;

        var create_profiles_panel = _modules["read_book.profiles"].create_profiles_panel;

        var create_open_book = _modules["read_book.open_book"].create_open_book;

        var create_font_size_panel = _modules["read_book.prefs.font_size"].create_font_size_panel;

        var time_formatter = _modules["read_book.prefs.head_foot"].time_formatter;

        var create_prefs_panel = _modules["read_book.prefs.main"].create_prefs_panel;

        var create_toc_panel = _modules["read_book.toc"].create_toc_panel;

        var create_word_actions_panel = _modules["read_book.word_actions"].create_word_actions_panel;

        var session_defaults = _modules.session.session_defaults;
        var get_device_uuid = _modules.session.get_device_uuid;

        var default_context_menu_should_be_allowed = _modules.utils.default_context_menu_should_be_allowed;
        var full_screen_element = _modules.utils.full_screen_element;
        var full_screen_supported = _modules.utils.full_screen_supported;
        var is_ios = _modules.utils.is_ios;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var short_uuid = _modules.uuid.short_uuid;

        var create_button = _modules.widgets.create_button;
        var create_spinner = _modules.widgets.create_spinner;

        function LoadingMessage() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            LoadingMessage.prototype.__bind_methods__.call(this);
            LoadingMessage.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(LoadingMessage.prototype, "__bind_methods__", {value: function () {
            this.show = LoadingMessage.prototype.show.bind(this);
            this.set_msg = LoadingMessage.prototype.set_msg.bind(this);
            this.on_container_click = LoadingMessage.prototype.on_container_click.bind(this);
        }});
        LoadingMessage.prototype.__init__ = function __init__(msg, current_color_scheme) {
            var self = this;
            self.msg = msg || "";
            self.current_color_scheme = current_color_scheme;
            self.is_not_escapable = true;
        };
        if (!LoadingMessage.prototype.__init__.__argnames__) Object.defineProperties(LoadingMessage.prototype.__init__, {
            __argnames__ : {value: ["msg", "current_color_scheme"]},
            __module__ : {value: "read_book.overlay"}
        });
        LoadingMessage.__argnames__ = LoadingMessage.prototype.__init__.__argnames__;
        LoadingMessage.__handles_kwarg_interpolation__ = LoadingMessage.prototype.__init__.__handles_kwarg_interpolation__;
        LoadingMessage.prototype.show = function show(container) {
            var self = this;
            self.container_id = container.getAttribute("id");
            container.style.backgroundColor = self.current_color_scheme.background;
            container.style.color = self.current_color_scheme.foreground;
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(create_spinner("100px", "100px")), E.h2()].concat([_desugar_kwargs({style: "text-align:center"})])));
            safe_set_inner_html(container.firstChild.lastChild, self.msg);
            _interpolate_kwargs.call(this, set_css, [container.firstChild].concat([_desugar_kwargs({position: "relative", top: "50%", transform: "translateY(-50%)"})]));
        };
        if (!LoadingMessage.prototype.show.__argnames__) Object.defineProperties(LoadingMessage.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        LoadingMessage.prototype.set_msg = function set_msg(msg) {
            var self = this;
            var container;
            self.msg = msg;
            container = document.getElementById(self.container_id);
            safe_set_inner_html(container.firstChild.lastChild, self.msg);
        };
        if (!LoadingMessage.prototype.set_msg.__argnames__) Object.defineProperties(LoadingMessage.prototype.set_msg, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.overlay"}
        });
        LoadingMessage.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!LoadingMessage.prototype.on_container_click.__argnames__) Object.defineProperties(LoadingMessage.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        LoadingMessage.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        LoadingMessage.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(LoadingMessage.prototype, "__bases__", {value: []});

        function DeleteBook() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            DeleteBook.prototype.__bind_methods__.call(this);
            DeleteBook.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(DeleteBook.prototype, "__bind_methods__", {value: function () {
            this.show = DeleteBook.prototype.show.bind(this);
            this.focus_me = DeleteBook.prototype.focus_me.bind(this);
            this.show_working = DeleteBook.prototype.show_working.bind(this);
            this.on_container_click = DeleteBook.prototype.on_container_click.bind(this);
            this.delete_book = DeleteBook.prototype.delete_book.bind(this);
            this.cancel = DeleteBook.prototype.cancel.bind(this);
        }});
        DeleteBook.prototype.__init__ = function __init__(overlay, question, ok_icon, ok_text, reload_book) {
            var self = this;
            self.overlay = overlay;
            self.question = question || _("Are you sure you want to remove this book from local storage? You will have to re-download it from calibre if you want to read it again.");
            self.ok_icon = ok_icon || "trash";
            self.ok_text = ok_text || _("Delete book");
            self.reload_book = reload_book;
        };
        if (!DeleteBook.prototype.__init__.__argnames__) Object.defineProperties(DeleteBook.prototype.__init__, {
            __argnames__ : {value: ["overlay", "question", "ok_icon", "ok_text", "reload_book"]},
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.__argnames__ = DeleteBook.prototype.__init__.__argnames__;
        DeleteBook.__handles_kwarg_interpolation__ = DeleteBook.prototype.__init__.__handles_kwarg_interpolation__;
        DeleteBook.prototype.show = function show(container) {
            var self = this;
            self.container_id = container.getAttribute("id");
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({background_color: get_color("window-background")})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [E.h2(self.question), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [self.ok_text, self.ok_icon].concat([_desugar_kwargs({action: self.delete_book, highlight: true})])), E.span(""), _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: self.cancel})]))].concat([_desugar_kwargs({style: "display:flex; justify-content:flex-end; margin-top:1rem"})]))].concat([_desugar_kwargs({style: "margin:1ex 1em; max-width: 80%"})]))].concat([_desugar_kwargs({style: "display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%", tabindex: "0", onkeyup: (function() {
                var _anonfunc = function (ev) {
                    if (ev.key === "Escape") {
                        [ev.stopPropagation(), ev.preventDefault()];
                        self.cancel();
                    } else if (ev.key === "Enter" || ev.key === "Return") {
                        [ev.stopPropagation(), ev.preventDefault()];
                        self.delete_book();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })()})])));
            window.setTimeout(self.focus_me, 0);
        };
        if (!DeleteBook.prototype.show.__argnames__) Object.defineProperties(DeleteBook.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.prototype.focus_me = function focus_me() {
            var self = this;
            document.getElementById(self.container_id).lastChild.focus();
        };
        if (!DeleteBook.prototype.focus_me.__module__) Object.defineProperties(DeleteBook.prototype.focus_me, {
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.prototype.show_working = function show_working() {
            var self = this;
            var container;
            container = document.getElementById(self.container_id);
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(create_spinner("100px", "100px")), E.h2()].concat([_desugar_kwargs({style: "text-align:center"})])));
            safe_set_inner_html(container.lastChild.lastChild, _("Deleting local book copy, please wait..."));
        };
        if (!DeleteBook.prototype.show_working.__module__) Object.defineProperties(DeleteBook.prototype.show_working, {
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!DeleteBook.prototype.on_container_click.__argnames__) Object.defineProperties(DeleteBook.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.prototype.delete_book = function delete_book() {
            var self = this;
            var view;
            if (runtime.is_standalone_viewer) {
                if (self.reload_book) {
                    self.overlay.view.reload_book();
                }
                return;
            }
            self.show_working();
            view = self.overlay.view;
            ui_operations.delete_book(view.book, (function() {
                var _anonfunc = function (book, errmsg) {
                    self.overlay.hide_current_panel();
                    if (errmsg) {
                        view.ui.show_error(_("Failed to delete book"), _("Failed to delete book from local storage, click \"Show details\" for more information."), errmsg);
                    } else {
                        if (self.reload_book) {
                            self.overlay.view.reload_book();
                        } else {
                            home();
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["book", "errmsg"]},
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })());
        };
        if (!DeleteBook.prototype.delete_book.__module__) Object.defineProperties(DeleteBook.prototype.delete_book, {
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.prototype.cancel = function cancel() {
            var self = this;
            self.overlay.hide_current_panel();
        };
        if (!DeleteBook.prototype.cancel.__module__) Object.defineProperties(DeleteBook.prototype.cancel, {
            __module__ : {value: "read_book.overlay"}
        });
        DeleteBook.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        DeleteBook.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(DeleteBook.prototype, "__bases__", {value: []});

        function SyncBook() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            SyncBook.prototype.__bind_methods__.call(this);
            SyncBook.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(SyncBook.prototype, "__bind_methods__", {value: function () {
            this.show = SyncBook.prototype.show.bind(this);
            this.on_container_click = SyncBook.prototype.on_container_click.bind(this);
            this.cancel = SyncBook.prototype.cancel.bind(this);
            this.sync_data_received = SyncBook.prototype.sync_data_received.bind(this);
        }});
        SyncBook.prototype.__init__ = function __init__(overlay) {
            var self = this;
            self.overlay = overlay;
            self.canceled = false;
        };
        if (!SyncBook.prototype.__init__.__argnames__) Object.defineProperties(SyncBook.prototype.__init__, {
            __argnames__ : {value: ["overlay"]},
            __module__ : {value: "read_book.overlay"}
        });
        SyncBook.__argnames__ = SyncBook.prototype.__init__.__argnames__;
        SyncBook.__handles_kwarg_interpolation__ = SyncBook.prototype.__init__.__handles_kwarg_interpolation__;
        SyncBook.prototype.show = function show(container) {
            var self = this;
            var book, to_sync;
            self.container_id = container.getAttribute("id");
            _interpolate_kwargs.call(this, set_css, [container].concat([_desugar_kwargs({background_color: get_color("window-background")})]));
            book = self.overlay.view.book;
            to_sync = [[book.key, new Date(0)]];
            self.overlay.view.annotations_manager.sync_annots_to_server();
            sync_library_books(book.key[0], to_sync, self.sync_data_received);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [E.h2(_("Syncing last read position and annotations")), E.p(_("Downloading data from server, please wait...")), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: self.cancel})]))].concat([_desugar_kwargs({style: "display:flex; justify-content:flex-end"})]))].concat([_desugar_kwargs({style: "margin:1ex 1em; max-width: 80vw"})]))].concat([_desugar_kwargs({style: "display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%"})])));
        };
        if (!SyncBook.prototype.show.__argnames__) Object.defineProperties(SyncBook.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        SyncBook.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!SyncBook.prototype.on_container_click.__argnames__) Object.defineProperties(SyncBook.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        SyncBook.prototype.cancel = function cancel() {
            var self = this;
            self.canceled = true;
            self.overlay.hide_current_panel();
        };
        if (!SyncBook.prototype.cancel.__module__) Object.defineProperties(SyncBook.prototype.cancel, {
            __module__ : {value: "read_book.overlay"}
        });
        SyncBook.prototype.sync_data_received = function sync_data_received(library_id, lrmap, load_type, xhr, ev) {
            var self = this;
            var data, book, dev, epoch, ans, new_annotations_map, _unpack, book_id, fmt, new_vals, last_read_positions, d, key, cfi;
            if (self.canceled) {
                return;
            }
            self.overlay.hide();
            if (load_type !== "load") {
                if (xhr.responseText === "login required for sync") {
                    error_dialog(_("Failed to fetch sync data"), _("You must setup user accounts and login to use the sync functionality"));
                } else {
                    error_dialog(_("Failed to fetch sync data"), _("Failed to download sync data from server, click \"Show details\" for more information."), xhr.error_html);
                }
                return;
            }
            data = JSON.parse(xhr.responseText);
            book = self.overlay.view.book;
            dev = get_device_uuid();
            epoch = 0;
            ans = null;
            new_annotations_map = null;
            var _Iter0 = _Iterable(data);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                key = _Iter0[_Index0];
                _unpack = _eslice(key.partition(":"), 2);
_unpack = _unpack_asarray(2, _unpack);
                book_id = _unpack[0];
                fmt = _unpack[1];
                if (book_id === str(book.key[1]) && fmt.upper() === book.key[2].upper()) {
                    new_vals = data[(typeof key === "number" && key < 0) ? data.length + key : key];
                    last_read_positions = new_vals.last_read_positions;
                    new_annotations_map = new_vals.annotations_map;
                    var _Iter1 = _Iterable(last_read_positions);
                    for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                        d = _Iter1[_Index1];
                        if (d.device !== dev && d.epoch > epoch) {
                            epoch = d.epoch;
                            ans = d;
                        }
                    }
                    break;
                }
            }
            cfi = (typeof ans !== "undefined" && ans !== null ? ans : Object.create(null)).cfi;
            if (new_annotations_map || cfi) {
                self.overlay.view.sync_data_received(cfi, new_annotations_map);
            }
        };
        if (!SyncBook.prototype.sync_data_received.__argnames__) Object.defineProperties(SyncBook.prototype.sync_data_received, {
            __argnames__ : {value: ["library_id", "lrmap", "load_type", "xhr", "ev"]},
            __module__ : {value: "read_book.overlay"}
        });
        SyncBook.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        SyncBook.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(SyncBook.prototype, "__bases__", {value: []});

        MAIN_OVERLAY_TS_CLASS = "read-book-main-overlay-top-section";
        MAIN_OVERLAY_ACTIONS_CLASS = "read-book-main-overlay-actions";
        function timer_id() {
            if (!timer_id.ans) {
                timer_id.ans = unique_id();
            }
            return timer_id.ans;
        };
        if (!timer_id.__module__) Object.defineProperties(timer_id, {
            __module__ : {value: "read_book.overlay"}
        });

        add_extra_css((function() {
            var _anonfunc = function () {
                var style, sel;
                style = "";
                sel = "." + MAIN_OVERLAY_TS_CLASS + " > ." + MAIN_OVERLAY_ACTIONS_CLASS + " ";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({overflow: "hidden"})]));
                sel += "> ul ";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({display: "flex", list_style: "none", border_bottom: "1px solid currentColor"})]));
                sel += "> li";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({border_right: "1px solid currentColor", padding: "0.5em 1ex", display: "flex", flex_wrap: "wrap", align_items: "center", cursor: "pointer"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":last-child"].concat([_desugar_kwargs({border_right_style: "none"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":hover > *:first-child, .main-overlay-button:hover > *:first-child"].concat([_desugar_kwargs({color: get_color("window-hover-foreground")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":active > *:first-child, .main-overlay-button:active > *:first-child"].concat([_desugar_kwargs({transform: "scale(1.8)"})]));
                style += "@media screen and (max-width: 350px) { #" + _str.format("{}", timer_id()) + " { display: none; } }";
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.overlay"}
            });
            return _anonfunc;
        })());
        function simple_overlay_title(title, overlay, container, close_action) {
            container.style.backgroundColor = get_color("window-background");
            function action() {
                var event;
                event = this;
                event.stopPropagation();
                overlay.hide_current_panel(event);
            };
            if (!action.__module__) Object.defineProperties(action, {
                __module__ : {value: "read_book.overlay"}
            });

            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: title, icon: "close", action: close_action || action})]));
        };
        if (!simple_overlay_title.__argnames__) Object.defineProperties(simple_overlay_title, {
            __argnames__ : {value: ["title", "overlay", "container", "close_action"]},
            __module__ : {value: "read_book.overlay"}
        });

        function MainOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            MainOverlay.prototype.__bind_methods__.call(this);
            MainOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(MainOverlay.prototype, "__bind_methods__", {value: function () {
            this.show = MainOverlay.prototype.show.bind(this);
            this.update_time = MainOverlay.prototype.update_time.bind(this);
            this.on_hide = MainOverlay.prototype.on_hide.bind(this);
            this.back = MainOverlay.prototype.back.bind(this);
            this.forward = MainOverlay.prototype.forward.bind(this);
        }});
        MainOverlay.prototype.__init__ = function __init__(overlay, elements) {
            var self = this;
            self.overlay = overlay;
            self.elements = elements || Object.create(null);
            self.timer = null;
            if (_exists.d(window.Intl).DateTimeFormat) {
                self.date_formatter = window.Intl.DateTimeFormat(undefined, (function(){
                    var _d = Object.create(null);
                    _d["hour"] = "numeric";
                    _d["minute"] = "numeric";
                    return _d;
                }).call(this));
            } else {
                self.date_formatter = (function(){
                    var _d = Object.create(null);
                    _d["format"] = (function() {
                        var _anonfunc = function (date) {
                            return "{}:{}".format(date.getHours(), date.getMinutes());
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["date"]},
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })();
                    return _d;
                }).call(this);
            }
        };
        if (!MainOverlay.prototype.__init__.__argnames__) Object.defineProperties(MainOverlay.prototype.__init__, {
            __argnames__ : {value: ["overlay", "elements"]},
            __module__ : {value: "read_book.overlay"}
        });
        MainOverlay.__argnames__ = MainOverlay.prototype.__init__.__argnames__;
        MainOverlay.__handles_kwarg_interpolation__ = MainOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        MainOverlay.prototype.show = function show(container) {
            var self = this;
            var icon_size, sd, sync_action, delete_action, reload_action, back_action, forward_action, nav_actions, reload_actions, bookmarks_action, highlights_action, toc_actions, actions_div, home_action, library_action, book_action, full_screen_actions, text, asa, no_selection_bar, copy_actions, renderer, c, b;
            self.container_id = container.getAttribute("id");
            icon_size = "3.5ex";
            sd = get_session_data();
            function ac(text, tooltip, action, icon, is_text_button) {
                if (is_text_button) {
                    icon = _interpolate_kwargs.call(E, E.span, [icon].concat([_desugar_kwargs({style: "font-size: 175%; font-weight: bold"})]));
                } else {
                    icon = (icon) ? svgicon(icon, icon_size, icon_size) : "";
                }
                icon.style.marginRight = "0.5ex";
                return _interpolate_kwargs.call(E, E.li, [icon, text].concat([_desugar_kwargs({onclick: action, title: tooltip})]));
            };
            if (!ac.__argnames__) Object.defineProperties(ac, {
                __argnames__ : {value: ["text", "tooltip", "action", "icon", "is_text_button"]},
                __module__ : {value: "read_book.overlay"}
            });

            sync_action = ac(_("Sync"), _("Get last read position and annotations from the server"), self.overlay.sync_book, "cloud-download");
            delete_action = ac(_("Delete"), _("Delete this book from local storage"), self.overlay.delete_book, "trash");
            reload_action = ac(_("Reload"), _("Reload this book from the {}").format((runtime.is_standalone_viewer) ? _("computer") : _("server")), self.overlay.reload_book, "refresh");
            back_action = ac(_("Back"), _("Go back"), self.back, "arrow-left");
            forward_action = ac(_("Forward"), _("Go forward"), self.forward, "arrow-right");
            nav_actions = E.ul(back_action, forward_action);
            if (runtime.is_standalone_viewer) {
                reload_actions = E.ul(ac(_("Open book"), _("Open a book"), self.overlay.open_book, "book"), reload_action);
            } else {
                reload_actions = E.ul(sync_action, delete_action, reload_action);
            }
            bookmarks_action = ac(_("Bookmarks"), _("Browse all bookmarks"), self.overlay.show_bookmarks, "bookmark");
            highlights_action = ac(_("Highlights"), _("Browse all highlights"), (function() {
                var _anonfunc = function () {
                    self.overlay.show_highlights();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })(), "image");
            toc_actions = E.ul(ac(_("Table of Contents"), _("Browse the Table of Contents"), self.overlay.show_toc, "toc"));
            toc_actions.appendChild(ac(_("Reference mode"), _("Toggle the Reference mode"), self.overlay.toggle_reference_mode, "reference-mode"));
            actions_div = _interpolate_kwargs.call(E, E.div, [nav_actions, E.ul(ac(_("Search"), _("Search for text in this book"), self.overlay.show_search, "search"), ac(_("Go to"), _("Go to a specific location in the book"), self.overlay.show_goto, "chevron-right")), reload_actions, toc_actions, E.ul(highlights_action, bookmarks_action), E.ul(ac(_("Font size"), _("Change text size"), self.overlay.show_font_size_chooser, "Aa", true), ac(_("Preferences"), _("Configure the E-book viewer"), self.overlay.show_prefs, "cogs"))].concat([_desugar_kwargs({class_: MAIN_OVERLAY_ACTIONS_CLASS})]));
            if (!runtime.is_standalone_viewer) {
                home_action = ac(_("Home"), _("Return to the home page"), (function() {
                    var _anonfunc = function () {
                        home();
                        ui_operations.close_book();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "home");
                library_action = ac(_("Library"), _("Return to the library page"), self.overlay.show_library, "library");
                book_action = ac(_("Book"), _("Return to the book's page"), self.overlay.show_book_page, "book");
                actions_div.insertBefore(E.ul(home_action, library_action, book_action), actions_div.firstChild);
            }
            full_screen_actions = _list_decorate([]);
            if (runtime.is_standalone_viewer) {
                text = (runtime.viewer_in_full_screen) ? _("Exit full screen") : _("Enter full screen");
                full_screen_actions.push(ac(text, _("Toggle full screen mode"), (function() {
                    var _anonfunc = function () {
                        [self.overlay.hide(), ui_operations.toggle_full_screen()];
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "full-screen"));
                full_screen_actions.push(ac(_("Print"), _("Print book to PDF"), (function() {
                    var _anonfunc = function () {
                        [self.overlay.hide(), ui_operations.print_book()];
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "print"));
            } else {
                if (!is_ios && full_screen_supported()) {
                    text = (full_screen_element()) ? _("Exit full screen") : _("Enter full screen");
                    full_screen_actions.push(ac(text, _("Toggle full screen mode"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.toggle_full_screen()];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "full-screen"));
                }
            }
            if (sd.get("read_mode") === "flow") {
                asa = self.overlay.view.autoscroll_active;
                full_screen_actions.append(ac((asa) ? _("Stop auto scroll") : _("Auto scroll"), _("Toggle auto-scrolling"), (function() {
                    var _anonfunc = function () {
                        self.overlay.hide();
                        window.setTimeout(self.overlay.view.toggle_autoscroll, 0);
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "auto-scroll"));
            }
            actions_div.appendChild(E.ul(ac(_("Read aloud"), _("Read the book aloud"), (function() {
                var _anonfunc = function () {
                    self.overlay.hide();
                    self.overlay.view.start_read_aloud();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })(), "bullhorn"), ac(_("Profiles"), _("Quickly switch between different settings"), (function() {
                var _anonfunc = function () {
                    self.overlay.show_profiles();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })(), "convert")));
            if (full_screen_actions.length) {
                actions_div.appendChild(E.ul.apply(E, full_screen_actions));
            }
            no_selection_bar = !sd.get("show_selection_bar");
            if (runtime.is_standalone_viewer) {
                if (no_selection_bar) {
                    actions_div.appendChild(E.ul(ac(_("Lookup/search word"), _("Lookup or search for the currently selected word"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.toggle_lookup(true)];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "library")));
                }
                copy_actions = E.ul();
                if (self.elements.link) {
                    copy_actions.appendChild(ac(_("Copy link"), _("Copy the current link"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.copy_selection(self.elements.link)];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "link"));
                }
                if (self.elements.img) {
                    copy_actions.appendChild(ac(_("View image"), _("View the current image"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.view_image(self.elements.img)];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "image"));
                    copy_actions.appendChild(ac(_("Copy image"), _("Copy the current image"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.copy_image(self.elements.img)];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "copy"));
                }
                if (copy_actions.childNodes.length) {
                    actions_div.appendChild(copy_actions);
                }
                actions_div.appendChild(E.ul(ac(_("Inspector"), _("Show the content inspector"), (function() {
                    var _anonfunc = function () {
                        [self.overlay.hide(), ui_operations.toggle_inspector()];
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "bug"), ac(_("Reset interface"), _("Reset E-book viewer panels, toolbars and scrollbars to defaults"), (function() {
                    var _anonfunc = function () {
                        question_dialog(_("Are you sure?"), _("Are you sure you want to reset the viewer interface to its default appearance?"), (function() {
                            var _anonfunc = function (yes) {
                                var sd;
                                if (yes) {
                                    self.overlay.hide();
                                    ui_operations.reset_interface();
                                    sd = get_session_data();
                                    sd.set("skipped_dialogs", session_defaults().skipped_dialogs);
                                }
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["yes"]},
                                __module__ : {value: "read_book.overlay"}
                            });
                            return _anonfunc;
                        })());
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "window-restore"), ac(_("Quit"), _("Close the E-book viewer"), (function() {
                    var _anonfunc = function () {
                        [self.overlay.hide(), ui_operations.quit()];
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.overlay"}
                    });
                    return _anonfunc;
                })(), "remove")));
            } else {
                copy_actions = E.ul();
                if (self.elements.link) {
                    copy_actions.appendChild(ac(_("Copy link"), _("Copy the current link"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.copy_selection(self.elements.link)];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "link"));
                }
                if (self.elements.img) {
                    copy_actions.appendChild(ac(_("View image"), _("View the current image"), (function() {
                        var _anonfunc = function () {
                            [self.overlay.hide(), ui_operations.view_image(self.elements.img)];
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })(), "image"));
                    if (window.navigator.clipboard) {
                        copy_actions.appendChild(ac(_("Copy image"), _("Copy the current image"), (function() {
                            var _anonfunc = function () {
                                [self.overlay.hide(), ui_operations.copy_image(self.elements.img)];
                            };
                            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                __module__ : {value: "read_book.overlay"}
                            });
                            return _anonfunc;
                        })(), "copy"));
                    }
                }
                if (copy_actions.childNodes.length) {
                    actions_div.appendChild(copy_actions);
                }
            }
            container.appendChild(_interpolate_kwargs.call(this, set_css, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, set_css, [E.div(_interpolate_kwargs.call(E, E.div, [_exists.d(_exists.d(self.overlay.view.book).metadata).title || _("Unknown")].concat([_desugar_kwargs({style: "max-width: 90%; text-overflow: ellipsis; font-weight: bold; white-space: nowrap; overflow: hidden"})])), _interpolate_kwargs.call(E, E.div, [time_formatter.format(new Date)].concat([_desugar_kwargs({id: timer_id(), style: "max-width: 9%; white-space: nowrap; overflow: hidden"})])))].concat([_desugar_kwargs({display: "flex", justify_content: "space-between", align_items: "baseline", font_size: "smaller", padding: "0.5ex 1ex", border_bottom: "solid 1px currentColor"})])), actions_div].concat([_desugar_kwargs({class_: MAIN_OVERLAY_TS_CLASS, onclick: (function() {
                var _anonfunc = function (evt) {
                    evt.stopPropagation();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["evt"]},
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })()})]))].concat([_desugar_kwargs({user_select: "none", background_color: get_color("window-background")})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [svgicon("close", icon_size, icon_size), "", _("Close")].concat([_desugar_kwargs({style: "display: flex; align-items: center; cursor: pointer; padding: 0.5ex 1rem", class_: "main-overlay-button", title: _("Close the viewer controls")})])), _interpolate_kwargs.call(E, E.div, [svgicon("help", icon_size, icon_size), "", _("Help")].concat([_desugar_kwargs({style: "display: flex; align-items: center; cursor: pointer; padding: 0.5ex 1rem", class_: "main-overlay-button", onclick: (function() {
                var _anonfunc = function (ev) {
                    ui_operations.show_help("viewer");
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })()})]))].concat([_desugar_kwargs({style: "display: flex; justify-content: space-between; align-items: center;"})])), _interpolate_kwargs.call(E, E.div, [""].concat([_desugar_kwargs({style: "padding: 0.5ex 1rem"})])), _interpolate_kwargs.call(E, E.div, [""].concat([_desugar_kwargs({style: "padding: 0.5ex 1rem"})]))].concat([_desugar_kwargs({style: "position: fixed; width: 100%; bottom: 0; display: flex; justify-content: space-between; align-items: center;user-select: none; background-color: {}".format(get_color("window-background"))})])));
            renderer = self.overlay.view.create_template_renderer();
            if (renderer) {
                c = container.lastChild.lastChild;
                b = c.previousSibling;
                renderer(b, "controls_footer", "middle", "");
                renderer(c, "controls_footer", "right", "");
            }
            self.on_hide();
            self.timer = setInterval(self.update_time, 1e3);
        };
        if (!MainOverlay.prototype.show.__argnames__) Object.defineProperties(MainOverlay.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        MainOverlay.prototype.update_time = function update_time() {
            var self = this;
            var tm;
            tm = document.getElementById(timer_id());
            if (tm) {
                tm.textContent = self.date_formatter.format(new Date);
            }
        };
        if (!MainOverlay.prototype.update_time.__module__) Object.defineProperties(MainOverlay.prototype.update_time, {
            __module__ : {value: "read_book.overlay"}
        });
        MainOverlay.prototype.on_hide = function on_hide() {
            var self = this;
            if (self.timer !== null) {
                clearInterval(self.timer);
            }
            self.timer = null;
        };
        if (!MainOverlay.prototype.on_hide.__module__) Object.defineProperties(MainOverlay.prototype.on_hide, {
            __module__ : {value: "read_book.overlay"}
        });
        MainOverlay.prototype.back = function back() {
            var self = this;
            window.history.back();
            self.overlay.hide();
        };
        if (!MainOverlay.prototype.back.__module__) Object.defineProperties(MainOverlay.prototype.back, {
            __module__ : {value: "read_book.overlay"}
        });
        MainOverlay.prototype.forward = function forward() {
            var self = this;
            window.history.forward();
            self.overlay.hide();
        };
        if (!MainOverlay.prototype.forward.__module__) Object.defineProperties(MainOverlay.prototype.forward, {
            __module__ : {value: "read_book.overlay"}
        });
        MainOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        MainOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(MainOverlay.prototype, "__bases__", {value: []});

        function SimpleOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            SimpleOverlay.prototype.__bind_methods__.call(this);
            SimpleOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(SimpleOverlay.prototype, "__bind_methods__", {value: function () {
            this.on_container_click = SimpleOverlay.prototype.on_container_click.bind(this);
            this.show = SimpleOverlay.prototype.show.bind(this);
        }});
        SimpleOverlay.prototype.__init__ = function __init__(overlay, create_func, title) {
            var self = this;
            self.overlay = overlay;
            self.create_func = create_func;
            self.title = title;
        };
        if (!SimpleOverlay.prototype.__init__.__argnames__) Object.defineProperties(SimpleOverlay.prototype.__init__, {
            __argnames__ : {value: ["overlay", "create_func", "title"]},
            __module__ : {value: "read_book.overlay"}
        });
        SimpleOverlay.__argnames__ = SimpleOverlay.prototype.__init__.__argnames__;
        SimpleOverlay.__handles_kwarg_interpolation__ = SimpleOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        SimpleOverlay.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!SimpleOverlay.prototype.on_container_click.__argnames__) Object.defineProperties(SimpleOverlay.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        SimpleOverlay.prototype.show = function show(container) {
            var self = this;
            simple_overlay_title(self.title, self.overlay, container);
            self.create_func(self.overlay, container);
        };
        if (!SimpleOverlay.prototype.show.__argnames__) Object.defineProperties(SimpleOverlay.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        SimpleOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        SimpleOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(SimpleOverlay.prototype, "__bases__", {value: []});

        function TOCOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            TOCOverlay.prototype.__bind_methods__.call(this);
            TOCOverlay.prototype.__init__.apply(this, arguments);
        }
        _extends(TOCOverlay, SimpleOverlay);
        Object.defineProperty(TOCOverlay.prototype, "__bind_methods__", {value: function () {
            SimpleOverlay.prototype.__bind_methods__ && SimpleOverlay.prototype.__bind_methods__.call(this);
            this.show = TOCOverlay.prototype.show.bind(this);
            this.handle_activate = TOCOverlay.prototype.handle_activate.bind(this);
        }});
        TOCOverlay.prototype.__init__ = function __init__(overlay, create_func, title) {
            var self = this;
            self.overlay = overlay;
            self.create_func = create_func || create_toc_panel;
            self.title = title || _("Table of Contents");
        };
        if (!TOCOverlay.prototype.__init__.__argnames__) Object.defineProperties(TOCOverlay.prototype.__init__, {
            __argnames__ : {value: ["overlay", "create_func", "title"]},
            __module__ : {value: "read_book.overlay"}
        });
        TOCOverlay.__argnames__ = TOCOverlay.prototype.__init__.__argnames__;
        TOCOverlay.__handles_kwarg_interpolation__ = TOCOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        TOCOverlay.prototype.show = function show(container) {
            var self = this;
            container.appendChild(E.div());
            container = container.firstChild;
            simple_overlay_title(self.title, self.overlay, container);
            self.create_func(self.overlay.view.book, container, self.handle_activate);
        };
        if (!TOCOverlay.prototype.show.__argnames__) Object.defineProperties(TOCOverlay.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        TOCOverlay.prototype.handle_activate = function handle_activate(dest, frag) {
            var self = this;
            self.overlay.hide();
            if (typeof dest === "function") {
                dest(self.overlay.view, frag);
            } else {
                self.overlay.view.goto_named_destination(dest, frag);
            }
        };
        if (!TOCOverlay.prototype.handle_activate.__argnames__) Object.defineProperties(TOCOverlay.prototype.handle_activate, {
            __argnames__ : {value: ["dest", "frag"]},
            __module__ : {value: "read_book.overlay"}
        });
        TOCOverlay.prototype.__repr__ = function __repr__ () {
            if(SimpleOverlay.prototype.__repr__) return SimpleOverlay.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        TOCOverlay.prototype.__str__ = function __str__ () {
            if(SimpleOverlay.prototype.__str__) return SimpleOverlay.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(TOCOverlay.prototype, "__bases__", {value: [SimpleOverlay]});

        function WordActionsOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            WordActionsOverlay.prototype.__bind_methods__.call(this);
            WordActionsOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(WordActionsOverlay.prototype, "__bind_methods__", {value: function () {
            this.on_container_click = WordActionsOverlay.prototype.on_container_click.bind(this);
            this.show = WordActionsOverlay.prototype.show.bind(this);
        }});
        WordActionsOverlay.prototype.__init__ = function __init__(word, overlay) {
            var self = this;
            self.word = word;
            self.overlay = overlay;
        };
        if (!WordActionsOverlay.prototype.__init__.__argnames__) Object.defineProperties(WordActionsOverlay.prototype.__init__, {
            __argnames__ : {value: ["word", "overlay"]},
            __module__ : {value: "read_book.overlay"}
        });
        WordActionsOverlay.__argnames__ = WordActionsOverlay.prototype.__init__.__argnames__;
        WordActionsOverlay.__handles_kwarg_interpolation__ = WordActionsOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        WordActionsOverlay.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!WordActionsOverlay.prototype.on_container_click.__argnames__) Object.defineProperties(WordActionsOverlay.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        WordActionsOverlay.prototype.show = function show(container) {
            var self = this;
            simple_overlay_title(_("Lookup: {}").format(self.word), self.overlay, container);
            create_word_actions_panel(container, self.word, self.overlay.hide);
        };
        if (!WordActionsOverlay.prototype.show.__argnames__) Object.defineProperties(WordActionsOverlay.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        WordActionsOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        WordActionsOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(WordActionsOverlay.prototype, "__bases__", {value: []});

        function PrefsOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            PrefsOverlay.prototype.__bind_methods__.call(this);
            PrefsOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(PrefsOverlay.prototype, "__bind_methods__", {value: function () {
            this.on_container_click = PrefsOverlay.prototype.on_container_click.bind(this);
            this.create_panel_impl = PrefsOverlay.prototype.create_panel_impl.bind(this);
            this.show = PrefsOverlay.prototype.show.bind(this);
            this.on_change = PrefsOverlay.prototype.on_change.bind(this);
            this.handle_escape = PrefsOverlay.prototype.handle_escape.bind(this);
            this.on_hide = PrefsOverlay.prototype.on_hide.bind(this);
        }});
        PrefsOverlay.prototype.__init__ = function __init__(overlay) {
            var self = this;
            self.overlay = overlay;
            self.changes_occurred = false;
        };
        if (!PrefsOverlay.prototype.__init__.__argnames__) Object.defineProperties(PrefsOverlay.prototype.__init__, {
            __argnames__ : {value: ["overlay"]},
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.__argnames__ = PrefsOverlay.prototype.__init__.__argnames__;
        PrefsOverlay.__handles_kwarg_interpolation__ = PrefsOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        PrefsOverlay.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!PrefsOverlay.prototype.on_container_click.__argnames__) Object.defineProperties(PrefsOverlay.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.prototype.create_panel_impl = function create_panel_impl(container) {
            var self = this;
            return create_prefs_panel(container, self.overlay.hide_current_panel, self.on_change);
        };
        if (!PrefsOverlay.prototype.create_panel_impl.__argnames__) Object.defineProperties(PrefsOverlay.prototype.create_panel_impl, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.prototype.show = function show(container) {
            var self = this;
            self.changes_occurred = false;
            container.style.backgroundColor = get_color("window-background");
            self.prefs = self.create_panel_impl(container);
        };
        if (!PrefsOverlay.prototype.show.__argnames__) Object.defineProperties(PrefsOverlay.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.prototype.on_change = function on_change() {
            var self = this;
            self.changes_occurred = true;
        };
        if (!PrefsOverlay.prototype.on_change.__module__) Object.defineProperties(PrefsOverlay.prototype.on_change, {
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.prototype.handle_escape = function handle_escape() {
            var self = this;
            self.prefs.onclose();
        };
        if (!PrefsOverlay.prototype.handle_escape.__module__) Object.defineProperties(PrefsOverlay.prototype.handle_escape, {
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.prototype.on_hide = function on_hide() {
            var self = this;
            if (self.changes_occurred) {
                self.changes_occurred = false;
                self.overlay.view.preferences_changed();
            }
        };
        if (!PrefsOverlay.prototype.on_hide.__module__) Object.defineProperties(PrefsOverlay.prototype.on_hide, {
            __module__ : {value: "read_book.overlay"}
        });
        PrefsOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        PrefsOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(PrefsOverlay.prototype, "__bases__", {value: []});

        function ProfilesOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ProfilesOverlay.prototype.__bind_methods__.call(this);
            ProfilesOverlay.prototype.__init__.apply(this, arguments);
        }
        _extends(ProfilesOverlay, PrefsOverlay);
        Object.defineProperty(ProfilesOverlay.prototype, "__bind_methods__", {value: function () {
            PrefsOverlay.prototype.__bind_methods__ && PrefsOverlay.prototype.__bind_methods__.call(this);
            this.create_panel_impl = ProfilesOverlay.prototype.create_panel_impl.bind(this);
            this.handle_escape = ProfilesOverlay.prototype.handle_escape.bind(this);
        }});
        ProfilesOverlay.prototype.__init__ = function __init__ () {
            PrefsOverlay.prototype.__init__ && PrefsOverlay.prototype.__init__.apply(this, arguments);
        };
        ProfilesOverlay.prototype.create_panel_impl = function create_panel_impl(container) {
            var self = this;
            return create_profiles_panel(container, self.overlay.hide_current_panel, self.on_change);
        };
        if (!ProfilesOverlay.prototype.create_panel_impl.__argnames__) Object.defineProperties(ProfilesOverlay.prototype.create_panel_impl, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        ProfilesOverlay.prototype.handle_escape = function handle_escape() {
            var self = this;
            self.overlay.hide_current_panel();
        };
        if (!ProfilesOverlay.prototype.handle_escape.__module__) Object.defineProperties(ProfilesOverlay.prototype.handle_escape, {
            __module__ : {value: "read_book.overlay"}
        });
        ProfilesOverlay.prototype.__repr__ = function __repr__ () {
            if(PrefsOverlay.prototype.__repr__) return PrefsOverlay.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ProfilesOverlay.prototype.__str__ = function __str__ () {
            if(PrefsOverlay.prototype.__str__) return PrefsOverlay.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(ProfilesOverlay.prototype, "__bases__", {value: [PrefsOverlay]});

        function FontSizeOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            FontSizeOverlay.prototype.__bind_methods__.call(this);
            FontSizeOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(FontSizeOverlay.prototype, "__bind_methods__", {value: function () {
            this.show = FontSizeOverlay.prototype.show.bind(this);
        }});
        FontSizeOverlay.prototype.__init__ = function __init__(overlay) {
            var self = this;
            self.overlay = overlay;
        };
        if (!FontSizeOverlay.prototype.__init__.__argnames__) Object.defineProperties(FontSizeOverlay.prototype.__init__, {
            __argnames__ : {value: ["overlay"]},
            __module__ : {value: "read_book.overlay"}
        });
        FontSizeOverlay.__argnames__ = FontSizeOverlay.prototype.__init__.__argnames__;
        FontSizeOverlay.__handles_kwarg_interpolation__ = FontSizeOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        FontSizeOverlay.prototype.show = function show(container) {
            var self = this;
            create_font_size_panel(container, self.overlay.hide_current_panel);
        };
        if (!FontSizeOverlay.prototype.show.__argnames__) Object.defineProperties(FontSizeOverlay.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        FontSizeOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        FontSizeOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(FontSizeOverlay.prototype, "__bases__", {value: []});

        function OpenBook() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            OpenBook.prototype.__bind_methods__.call(this);
            OpenBook.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(OpenBook.prototype, "__bind_methods__", {value: function () {
            this.handle_escape = OpenBook.prototype.handle_escape.bind(this);
            this.on_container_click = OpenBook.prototype.on_container_click.bind(this);
            this.show = OpenBook.prototype.show.bind(this);
        }});
        OpenBook.prototype.__init__ = function __init__(overlay, closeable) {
            var self = this;
            self.overlay = overlay;
            self.closeable = closeable;
        };
        if (!OpenBook.prototype.__init__.__argnames__) Object.defineProperties(OpenBook.prototype.__init__, {
            __argnames__ : {value: ["overlay", "closeable"]},
            __module__ : {value: "read_book.overlay"}
        });
        OpenBook.__argnames__ = OpenBook.prototype.__init__.__argnames__;
        OpenBook.__handles_kwarg_interpolation__ = OpenBook.prototype.__init__.__handles_kwarg_interpolation__;
        OpenBook.prototype.handle_escape = function handle_escape() {
            var self = this;
            if (self.closeable) {
                self.overlay.hide_current_panel();
            } else {
                if (self.overlay.handling_context_menu_event === null) {
                    ui_operations.quit();
                }
            }
        };
        if (!OpenBook.prototype.handle_escape.__module__) Object.defineProperties(OpenBook.prototype.handle_escape, {
            __module__ : {value: "read_book.overlay"}
        });
        OpenBook.prototype.on_container_click = function on_container_click(evt) {
            var self = this;
        };
        if (!OpenBook.prototype.on_container_click.__argnames__) Object.defineProperties(OpenBook.prototype.on_container_click, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        OpenBook.prototype.show = function show(container) {
            var self = this;
            simple_overlay_title(_("Open a book"), self.overlay, container, (function() {
                var _anonfunc = function () {
                    var ev;
                    ev = this;
                    [ev.stopPropagation(), ev.preventDefault()];
                    if (self.closeable) {
                        self.overlay.hide_current_panel(ev);
                    } else {
                        ui_operations.quit();
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.overlay"}
                });
                return _anonfunc;
            })());
            create_open_book(container, _exists.d(self.overlay.view).book);
        };
        if (!OpenBook.prototype.show.__argnames__) Object.defineProperties(OpenBook.prototype.show, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.overlay"}
        });
        OpenBook.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        OpenBook.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(OpenBook.prototype, "__bases__", {value: []});

        function Overlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Overlay.prototype.__bind_methods__.call(this);
            Overlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Overlay.prototype, "__bind_methods__", {value: function () {
            this.oncontextmenu = Overlay.prototype.oncontextmenu.bind(this);
            this.clear_container = Overlay.prototype.clear_container.bind(this);
            this.update_visibility = Overlay.prototype.update_visibility.bind(this);
            this.container_clicked = Overlay.prototype.container_clicked.bind(this);
            this.show_loading_message = Overlay.prototype.show_loading_message.bind(this);
            this.hide_loading_message = Overlay.prototype.hide_loading_message.bind(this);
            this.hide_current_panel = Overlay.prototype.hide_current_panel.bind(this);
            this.handle_escape = Overlay.prototype.handle_escape.bind(this);
            this.show_current_panel = Overlay.prototype.show_current_panel.bind(this);
            this.show = Overlay.prototype.show.bind(this);
            this.hide = Overlay.prototype.hide.bind(this);
            this.delete_book = Overlay.prototype.delete_book.bind(this);
            this.reload_book = Overlay.prototype.reload_book.bind(this);
            this.open_book = Overlay.prototype.open_book.bind(this);
            this.sync_book = Overlay.prototype.sync_book.bind(this);
            this.show_toc = Overlay.prototype.show_toc.bind(this);
            this.toggle_reference_mode = Overlay.prototype.toggle_reference_mode.bind(this);
            this.show_bookmarks = Overlay.prototype.show_bookmarks.bind(this);
            this.show_highlights = Overlay.prototype.show_highlights.bind(this);
            this.show_profiles = Overlay.prototype.show_profiles.bind(this);
            this.show_goto = Overlay.prototype.show_goto.bind(this);
            this.show_metadata = Overlay.prototype.show_metadata.bind(this);
            this.show_ask_for_location = Overlay.prototype.show_ask_for_location.bind(this);
            this.show_search = Overlay.prototype.show_search.bind(this);
            this.show_prefs = Overlay.prototype.show_prefs.bind(this);
            this.show_library = Overlay.prototype.show_library.bind(this);
            this.show_book_page = Overlay.prototype.show_book_page.bind(this);
            this.show_font_size_chooser = Overlay.prototype.show_font_size_chooser.bind(this);
            this.show_word_actions = Overlay.prototype.show_word_actions.bind(this);
        }});
        Object.defineProperties(Overlay.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById("book-overlay");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        Overlay.prototype.__init__ = function __init__(view) {
            var self = this;
            var c;
            self.view = view;
            self.handling_context_menu_event = null;
            c = self.clear_container();
            c.addEventListener("click", self.container_clicked);
            c.addEventListener("contextmenu", self.oncontextmenu, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            self.panels = _list_decorate([]);
        };
        if (!Overlay.prototype.__init__.__argnames__) Object.defineProperties(Overlay.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.__argnames__ = Overlay.prototype.__init__.__argnames__;
        Overlay.__handles_kwarg_interpolation__ = Overlay.prototype.__init__.__handles_kwarg_interpolation__;
        Overlay.prototype.oncontextmenu = function oncontextmenu(evt) {
            var self = this;
            if (default_context_menu_should_be_allowed(evt)) {
                return;
            }
            evt.preventDefault();
            self.handling_context_menu_event = evt;
            self.handle_escape();
            self.handling_context_menu_event = null;
        };
        if (!Overlay.prototype.oncontextmenu.__argnames__) Object.defineProperties(Overlay.prototype.oncontextmenu, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.clear_container = function clear_container() {
            var self = this;
            var c;
            c = self.container;
            clear(c);
            c.style.backgroundColor = "transparent";
            c.style.color = get_color("window-foreground");
            if (c.style.display !== "block") {
                c.style.display = "block";
            }
            return c;
        };
        if (!Overlay.prototype.clear_container.__module__) Object.defineProperties(Overlay.prototype.clear_container, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.update_visibility = function update_visibility() {
            var self = this;
            if (self.panels.length) {
                self.container.style.display = "block";
                self.view.overlay_visibility_changed(true);
            } else if (self.container.style.display === "block") {
                self.container.style.display = "none";
                self.view.focus_iframe();
                self.view.overlay_visibility_changed(false);
            }
        };
        if (!Overlay.prototype.update_visibility.__module__) Object.defineProperties(Overlay.prototype.update_visibility, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.container_clicked = function container_clicked(evt) {
            var self = this;
            if (self.panels.length && typeof (_expr_temp = self.panels)[_expr_temp.length-1].on_container_click === "function") {
                (_expr_temp = self.panels)[_expr_temp.length-1].on_container_click(evt);
            } else {
                self.hide_current_panel();
            }
        };
        if (!Overlay.prototype.container_clicked.__argnames__) Object.defineProperties(Overlay.prototype.container_clicked, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_loading_message = function show_loading_message(msg) {
            var self = this;
            var lm;
            if (ui_operations.show_loading_message) {
                ui_operations.show_loading_message(msg);
            } else {
                lm = new LoadingMessage(msg, self.view.current_color_scheme);
                self.panels.push(lm);
                self.show_current_panel();
            }
        };
        if (!Overlay.prototype.show_loading_message.__argnames__) Object.defineProperties(Overlay.prototype.show_loading_message, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.hide_loading_message = function hide_loading_message() {
            var self = this;
            var p;
            if (ui_operations.show_loading_message) {
                ui_operations.show_loading_message(null);
            } else {
                self.panels = (function() {
                    var _Iter = _Iterable(self.panels), _Result = [], p;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        p = _Iter[_Index];
                        if (!(_instanceof(p, LoadingMessage))) {
                            _Result.push(p);
                        }
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })();
                self.show_current_panel();
            }
        };
        if (!Overlay.prototype.hide_loading_message.__module__) Object.defineProperties(Overlay.prototype.hide_loading_message, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.hide_current_panel = function hide_current_panel() {
            var self = this;
            var p;
            p = self.panels.pop();
            if (p && callable(p.on_hide)) {
                p.on_hide();
            }
            self.show_current_panel();
        };
        if (!Overlay.prototype.hide_current_panel.__module__) Object.defineProperties(Overlay.prototype.hide_current_panel, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.handle_escape = function handle_escape() {
            var self = this;
            var p;
            if (self.panels.length) {
                p = (_expr_temp = self.panels)[_expr_temp.length-1];
                if (!p.is_not_escapable) {
                    if (p.handle_escape) {
                        p.handle_escape();
                    } else {
                        self.hide_current_panel();
                    }
                    return true;
                }
            }
            return false;
        };
        if (!Overlay.prototype.handle_escape.__module__) Object.defineProperties(Overlay.prototype.handle_escape, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_current_panel = function show_current_panel() {
            var self = this;
            var c;
            if (self.panels.length) {
                c = self.clear_container();
                (_expr_temp = self.panels)[_expr_temp.length-1].show(c);
            }
            self.update_visibility();
        };
        if (!Overlay.prototype.show_current_panel.__module__) Object.defineProperties(Overlay.prototype.show_current_panel, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show = function show(elements) {
            var self = this;
            self.panels = _list_decorate([ new MainOverlay(self, elements) ]);
            self.show_current_panel();
        };
        if (!Overlay.prototype.show.__argnames__) Object.defineProperties(Overlay.prototype.show, {
            __argnames__ : {value: ["elements"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.hide = function hide() {
            var self = this;
            while (self.panels.length) {
                self.hide_current_panel();
            }
            self.update_visibility();
        };
        if (!Overlay.prototype.hide.__module__) Object.defineProperties(Overlay.prototype.hide, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.delete_book = function delete_book() {
            var self = this;
            self.hide_current_panel();
            self.panels = _list_decorate([ new DeleteBook(self) ]);
            self.show_current_panel();
        };
        if (!Overlay.prototype.delete_book.__module__) Object.defineProperties(Overlay.prototype.delete_book, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.reload_book = function reload_book() {
            var self = this;
            self.hide_current_panel();
            self.panels = _list_decorate([ new DeleteBook(self, _("Are you sure you want to reload this book?"), "refresh", _("Reload book"), true) ]);
            self.show_current_panel();
        };
        if (!Overlay.prototype.reload_book.__module__) Object.defineProperties(Overlay.prototype.reload_book, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.open_book = function open_book(closeable) {
            var self = this;
            self.hide_current_panel();
            if (typeof closeable !== "boolean") {
                closeable = true;
            }
            self.panels = _list_decorate([ new OpenBook(self, closeable) ]);
            self.show_current_panel();
        };
        if (!Overlay.prototype.open_book.__argnames__) Object.defineProperties(Overlay.prototype.open_book, {
            __argnames__ : {value: ["closeable"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.sync_book = function sync_book() {
            var self = this;
            self.hide_current_panel();
            self.panels = _list_decorate([ new SyncBook(self) ]);
            self.show_current_panel();
        };
        if (!Overlay.prototype.sync_book.__module__) Object.defineProperties(Overlay.prototype.sync_book, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_toc = function show_toc() {
            var self = this;
            self.hide_current_panel();
            if (runtime.is_standalone_viewer) {
                ui_operations.toggle_toc();
                return;
            }
            self.panels.push(new TOCOverlay(self));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_toc.__module__) Object.defineProperties(Overlay.prototype.show_toc, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.toggle_reference_mode = function toggle_reference_mode() {
            var self = this;
            self.hide_current_panel();
            self.view.toggle_reference_mode();
        };
        if (!Overlay.prototype.toggle_reference_mode.__module__) Object.defineProperties(Overlay.prototype.toggle_reference_mode, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_bookmarks = function show_bookmarks() {
            var self = this;
            self.hide_current_panel();
            if (runtime.is_standalone_viewer) {
                ui_operations.toggle_bookmarks();
                return;
            }
            function do_it(action, data) {
                self.panels.push(new TOCOverlay(self, create_bookmarks_panel.bind(null, self.view.annotations_manager, data), _("Bookmarks")));
                self.show_current_panel();
            };
            if (!do_it.__argnames__) Object.defineProperties(do_it, {
                __argnames__ : {value: ["action", "data"]},
                __module__ : {value: "read_book.overlay"}
            });

            self.view.get_current_cfi("show-bookmarks", do_it);
        };
        if (!Overlay.prototype.show_bookmarks.__module__) Object.defineProperties(Overlay.prototype.show_bookmarks, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_highlights = function show_highlights() {
            var self = this;
            self.hide_current_panel();
            if (ui_operations.toggle_highlights) {
                self.hide();
                ui_operations.toggle_highlights();
                return;
            }
            self.panels.push(new TOCOverlay(self, create_highlights_panel.bind(null, self.view.annotations_manager, self.hide_current_panel), _("Highlights")));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_highlights.__module__) Object.defineProperties(Overlay.prototype.show_highlights, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_profiles = function show_profiles() {
            var self = this;
            self.hide_current_panel();
            self.panels.push(new ProfilesOverlay(self));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_profiles.__module__) Object.defineProperties(Overlay.prototype.show_profiles, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_goto = function show_goto() {
            var self = this;
            self.hide_current_panel();
            self.panels.push(new TOCOverlay(self, create_goto_panel.bind(null, self.view.current_position_data), _("Go to")));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_goto.__module__) Object.defineProperties(Overlay.prototype.show_goto, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_metadata = function show_metadata() {
            var self = this;
            var from_read_book, book, key, _unpack, lname, book_id, panel;
            self.hide_current_panel();
            from_read_book = short_uuid();
            function show_metadata_overlay(mi, pathtoebook, calibre_book_in_library_url, lname, book_id, overlay, container) {
                var container_id, table, a;
                container_id = ensure_id(container);
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: BD_CLASS_NAME, style: "padding: 1ex 1em"})]));
                table = _interpolate_kwargs.call(E, E.table, [_desugar_kwargs({class_: "metadata"})]);
                function handle_message(msg) {
                    var data, mi, book_id, book;
                    data = msg.data;
                    if (data.from_read_book !== from_read_book) {
                        return;
                    }
                    if (data.type === "edit_metadata_closed") {
                        ui_operations.stop_waiting_for_messages_from(this);
                        self.hide_current_panel();
                        return;
                    }
                    if (data.type === "update_cached_book_metadata" && data.metadata) {
                        if (current_library_id() === data.library_id) {
                            mi = data.metadata;
                            book_id = int(data.book_id);
                            set_book_metadata(book_id, mi);
                            book = self.view.book;
                            if (book && book.key[0] === data.library_id && book.key[1] === book_id) {
                                ui_operations.update_metadata(book, mi);
                            }
                        }
                    }
                };
                if (!handle_message.__argnames__) Object.defineProperties(handle_message, {
                    __argnames__ : {value: ["msg"]},
                    __module__ : {value: "read_book.overlay"}
                });

                if (!runtime.is_standalone_viewer && lname) {
                    container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Edit the metadata for this book in the library")].concat([_desugar_kwargs({class_: "blue-link", onclick: (function() {
                        var _anonfunc = function () {
                            var container, w;
                            container = document.getElementById(container_id);
                            clear(container);
                            container.appendChild(_interpolate_kwargs.call(E, E.iframe, [_desugar_kwargs({style: "position: absolute; left: 0; top: 0; width: 100vw; height: 100vh; border-width: 0", src: query_as_href((function(){
                                var _d = Object.create(null);
                                _d["from_read_book"] = from_read_book;
                                _d["library_id"] = lname;
                                _d["book_id"] = book_id + "";
                                return _d;
                            }).call(this), "edit_metadata")})]));
                            w = container.lastChild.contentWindow;
                            ui_operations.wait_for_messages_from(w, handle_message.bind(w));
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })()})]))].concat([_desugar_kwargs({style: "text-align: right"})])));
                }
                container.lastChild.appendChild(table);
                render_metadata(mi, table, null, "html { font-size: " + _str.format("{}", document.documentElement.style.fontSize) + " }");
                var _Iter2 = _Iterable(table.querySelectorAll("a[href]"));
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    a = _Iter2[_Index2];
                    a.removeAttribute("href");
                    a.removeAttribute("title");
                    a.classList.remove("blue-link");
                }
                if (pathtoebook) {
                    container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Path:"), " ", _interpolate_kwargs.call(E, E.a, [pathtoebook].concat([_desugar_kwargs({href: "javascript: void(0)", class_: "blue-link", title: _("Click to open the folder the book is in"), onclick: (function() {
                        var _anonfunc = function () {
                            ui_operations.show_book_folder();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.overlay"}
                        });
                        return _anonfunc;
                    })()})]))].concat([_desugar_kwargs({style: "margin-top: 1ex; padding-top: 1ex; border-top: solid 1px"})])));
                }
                if (calibre_book_in_library_url) {
                    container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Show book in the main calibre program")].concat([_desugar_kwargs({href: calibre_book_in_library_url, class_: "blue-link", title: _("Click to see this book in the main calibre program book list")})]))].concat([_desugar_kwargs({style: "margin-top: 1ex; padding-top: 1ex;"})])));
                }
            };
            if (!show_metadata_overlay.__argnames__) Object.defineProperties(show_metadata_overlay, {
                __argnames__ : {value: ["mi", "pathtoebook", "calibre_book_in_library_url", "lname", "book_id", "overlay", "container"]},
                __module__ : {value: "read_book.overlay"}
            });

            book = self.view.book;
            key = book.key || [null, 0];
            _unpack = key;
_unpack = _unpack_asarray(2, _unpack);
            lname = _unpack[0];
            book_id = _unpack[1];
            book_id = int(book_id || 0);
            panel = new SimpleOverlay(self, show_metadata_overlay.bind(null, book.metadata, book.manifest.pathtoebook, book.calibre_book_in_library_url, lname, book_id), self.view.book.metadata.title);
            panel.from_read_book = from_read_book;
            self.panels.push(panel);
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_metadata.__module__) Object.defineProperties(Overlay.prototype.show_metadata, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_ask_for_location = function show_ask_for_location() {
            var self = this;
            self.hide_current_panel();
            self.panels.push(new SimpleOverlay(self, create_location_overlay.bind(null, self.view.current_position_data, self.view.book), _("Go to location, position or reference")));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_ask_for_location.__module__) Object.defineProperties(Overlay.prototype.show_ask_for_location, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_search = function show_search() {
            var self = this;
            self.hide();
            self.view.show_search();
        };
        if (!Overlay.prototype.show_search.__module__) Object.defineProperties(Overlay.prototype.show_search, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_prefs = function show_prefs() {
            var self = this;
            self.hide_current_panel();
            self.panels.push(new PrefsOverlay(self));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_prefs.__module__) Object.defineProperties(Overlay.prototype.show_prefs, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_library = function show_library() {
            var self = this;
            var book;
            self.hide_current_panel();
            book = self.view.book;
            _interpolate_kwargs.call(this, show_panel, ["book_list", (function(){
                var _d = Object.create(null);
                _d["library_id"] = book.key[0];
                _d["book_id"] = book.key[1] + "";
                return _d;
            }).call(this)].concat([_desugar_kwargs({replace: false})]));
            ui_operations.close_book();
        };
        if (!Overlay.prototype.show_library.__module__) Object.defineProperties(Overlay.prototype.show_library, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_book_page = function show_book_page() {
            var self = this;
            self.hide_current_panel();
            self.view.open_book_page();
            ui_operations.close_book();
        };
        if (!Overlay.prototype.show_book_page.__module__) Object.defineProperties(Overlay.prototype.show_book_page, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_font_size_chooser = function show_font_size_chooser() {
            var self = this;
            self.hide_current_panel();
            self.panels.push(new FontSizeOverlay(self));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_font_size_chooser.__module__) Object.defineProperties(Overlay.prototype.show_font_size_chooser, {
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.show_word_actions = function show_word_actions(word) {
            var self = this;
            self.hide_current_panel();
            self.panels.push(new WordActionsOverlay(word, self));
            self.show_current_panel();
        };
        if (!Overlay.prototype.show_word_actions.__argnames__) Object.defineProperties(Overlay.prototype.show_word_actions, {
            __argnames__ : {value: ["word"]},
            __module__ : {value: "read_book.overlay"}
        });
        Overlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Overlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Overlay.prototype, "__bases__", {value: []});
        
        

        _modules["read_book.overlay"].MAIN_OVERLAY_TS_CLASS = MAIN_OVERLAY_TS_CLASS;
        _modules["read_book.overlay"].MAIN_OVERLAY_ACTIONS_CLASS = MAIN_OVERLAY_ACTIONS_CLASS;
        _modules["read_book.overlay"].LoadingMessage = LoadingMessage;
        _modules["read_book.overlay"].DeleteBook = DeleteBook;
        _modules["read_book.overlay"].SyncBook = SyncBook;
        _modules["read_book.overlay"].timer_id = timer_id;
        _modules["read_book.overlay"].simple_overlay_title = simple_overlay_title;
        _modules["read_book.overlay"].MainOverlay = MainOverlay;
        _modules["read_book.overlay"].SimpleOverlay = SimpleOverlay;
        _modules["read_book.overlay"].TOCOverlay = TOCOverlay;
        _modules["read_book.overlay"].WordActionsOverlay = WordActionsOverlay;
        _modules["read_book.overlay"].PrefsOverlay = PrefsOverlay;
        _modules["read_book.overlay"].ProfilesOverlay = ProfilesOverlay;
        _modules["read_book.overlay"].FontSizeOverlay = FontSizeOverlay;
        _modules["read_book.overlay"].OpenBook = OpenBook;
        _modules["read_book.overlay"].Overlay = Overlay;
    })();

    (function(){
        var __name__ = "read_book.read_aloud";
        var HIDDEN, WAITING_FOR_PLAY_TO_START, PAUSED, PLAYING, STOPPED;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var get_color = _modules["book_list.theme"].get_color;

        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var ICON_SIZE = _modules["read_book.highlights"].ICON_SIZE;

        var BUTTON_MARGIN = _modules["read_book.selection_bar"].BUTTON_MARGIN;
        var get_margins = _modules["read_book.selection_bar"].get_margins;
        var map_to_iframe_coords = _modules["read_book.selection_bar"].map_to_iframe_coords;

        var shortcut_for_key_event = _modules["read_book.shortcuts"].shortcut_for_key_event;

        HIDDEN = 0;
        WAITING_FOR_PLAY_TO_START = 1;
        PAUSED = 2;
        PLAYING = 3;
        STOPPED = 4;
        function is_flow_mode() {
            var sd, mode;
            sd = get_session_data();
            mode = sd.get("read_mode");
            return mode === "flow";
        };
        if (!is_flow_mode.__module__) Object.defineProperties(is_flow_mode, {
            __module__ : {value: "read_book.read_aloud"}
        });

        function ReadAloud() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ReadAloud.prototype.__bind_methods__.call(this);
            ReadAloud.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ReadAloud.prototype, "__bind_methods__", {value: function () {
            this.hide = ReadAloud.prototype.hide.bind(this);
            this.show = ReadAloud.prototype.show.bind(this);
            this.focus = ReadAloud.prototype.focus.bind(this);
            this.build_bar = ReadAloud.prototype.build_bar.bind(this);
            this.configure = ReadAloud.prototype.configure.bind(this);
            this.slower = ReadAloud.prototype.slower.bind(this);
            this.faster = ReadAloud.prototype.faster.bind(this);
            this.play = ReadAloud.prototype.play.bind(this);
            this.pause = ReadAloud.prototype.pause.bind(this);
            this.stop = ReadAloud.prototype.stop.bind(this);
            this.toggle = ReadAloud.prototype.toggle.bind(this);
            this.container_clicked = ReadAloud.prototype.container_clicked.bind(this);
            this.on_keydown = ReadAloud.prototype.on_keydown.bind(this);
            this.handle_tts_event = ReadAloud.prototype.handle_tts_event.bind(this);
            this.send_message = ReadAloud.prototype.send_message.bind(this);
            this.handle_message = ReadAloud.prototype.handle_message.bind(this);
        }});
        Object.defineProperties(ReadAloud.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById("book-read-aloud-overlay");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "supports_css_min_max": {
                "enumerable": true, 
                "get": function supports_css_min_max() {
                    var self = this;
                    return true;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "bar": {
                "enumerable": true, 
                "get": function bar() {
                    var self = this;
                    return document.getElementById(self.bar_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "state": {
                "enumerable": true, 
                "get": function state() {
                    var self = this;
                    return self._state;
                }, 
                "set": function state(val) {
                    var self = this;
                    if (val !== self._state) {
                        self._state = val;
                        self.build_bar();
                    }
                }
            }, 
        });
        ReadAloud.prototype.__init__ = function __init__(view) {
            var self = this;
            var container;
            self.view = view;
            self._state = HIDDEN;
            self.bar_id = unique_id("bar");
            container = self.container;
            container.setAttribute("tabindex", "0");
            container.style.overflow = "hidden";
            container.style.justifyContent = "flex-end";
            container.style.alignItems = (is_flow_mode()) ? "flex-end" : "flex-start";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: self.bar_id, style: "border: solid 1px currentColor; border-radius: 5px;display: flex; flex-direction: column; margin: 1rem;"})]));
            container.appendChild(E.style("#" + _str.format("{}", self.bar_id) + ".speaking " + "{ opacity: 0.5 }\n\n", "#" + _str.format("{}", self.bar_id) + ".speaking:hover " + "{ opacity: 1.0 }\n\n"));
            container.addEventListener("keydown", self.on_keydown, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("click", self.container_clicked, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("contextmenu", self.toggle, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
        };
        if (!ReadAloud.prototype.__init__.__argnames__) Object.defineProperties(ReadAloud.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.__argnames__ = ReadAloud.prototype.__init__.__argnames__;
        ReadAloud.__handles_kwarg_interpolation__ = ReadAloud.prototype.__init__.__handles_kwarg_interpolation__;
        ReadAloud.prototype.hide = function hide() {
            var self = this;
            if (self.state !== HIDDEN) {
                ui_operations.tts("stop");
                self.state = HIDDEN;
                self.container.style.display = "none";
                self.view.focus_iframe();
                if (ui_operations.read_aloud_state_changed) {
                    ui_operations.read_aloud_state_changed(false);
                }
            }
        };
        if (!ReadAloud.prototype.hide.__module__) Object.defineProperties(ReadAloud.prototype.hide, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.show = function show() {
            var self = this;
            if (self.state === HIDDEN) {
                self.container.style.display = "flex";
                self.state = STOPPED;
                self.focus();
                if (ui_operations.read_aloud_state_changed) {
                    ui_operations.read_aloud_state_changed(true);
                }
            }
        };
        if (!ReadAloud.prototype.show.__module__) Object.defineProperties(ReadAloud.prototype.show, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.focus = function focus() {
            var self = this;
            self.container.focus();
        };
        if (!ReadAloud.prototype.focus.__module__) Object.defineProperties(ReadAloud.prototype.focus, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.build_bar = function build_bar(annot_id) {
            var self = this;
            var bar_container, x, bar, notes_container;
            if (self.state === HIDDEN) {
                return;
            }
            self.container.style.alignItems = (is_flow_mode()) ? "flex-end" : "flex-start";
            bar_container = self.bar;
            if (self.state === PLAYING) {
                bar_container.classList.add("speaking");
            } else {
                bar_container.classList.remove("speaking");
            }
            clear(bar_container);
            bar_container.style.maxWidth = (self.supports_css_min_max) ? "min(40rem, 80vw)" : "40rem";
            bar_container.style.backgroundColor = get_color("window-background");
            var _Iter0 = _Iterable(_list_decorate([ _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "height: 4ex; display: flex; align-items: center; padding: 5px; justify-content: center"})]), _interpolate_kwargs.call(E, E.hr, [_desugar_kwargs({style: "border-top: solid 1px; margin: 0; padding: 0; display: none"})]), _interpolate_kwargs.call(E, E.div, [E.div()].concat([_desugar_kwargs({style: "display: none; padding: 5px; font-size: smaller"})])) ]));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                x = _Iter0[_Index0];
                bar_container.appendChild(x);
            }
            bar = bar_container.firstChild;
            function cb(name, icon, text) {
                var ans;
                ans = svgicon(icon, ICON_SIZE, ICON_SIZE, text);
                if (name) {
                    ans.addEventListener("click", (function() {
                        var _anonfunc = function (ev) {
                            [ev.stopPropagation(), ev.preventDefault()];
                            self[(typeof name === "number" && name < 0) ? self.length + name : name](ev);
                            self.view.focus_iframe();
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["ev"]},
                            __module__ : {value: "read_book.read_aloud"}
                        });
                        return _anonfunc;
                    })());
                }
                ans.classList.add("simple-link");
                ans.style.marginLeft = ans.style.marginRight = BUTTON_MARGIN;
                return ans;
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["name", "icon", "text"]},
                __module__ : {value: "read_book.read_aloud"}
            });

            if (self.state === PLAYING) {
                bar.appendChild(cb("pause", "pause", _("Pause reading")));
            } else if (self.state === WAITING_FOR_PLAY_TO_START) {
                bar.appendChild(cb(null, "hourglass", _("Pause reading")));
            } else {
                bar.appendChild(cb("play", "play", (self.state === STOPPED) ? _("Start reading") : _("Resume reading")));
            }
            bar.appendChild(cb("slower", "slower", _("Slow down speech")));
            bar.appendChild(cb("faster", "faster", _("Speed up speech")));
            bar.appendChild(cb("configure", "cogs", _("Configure Read aloud")));
            bar.appendChild(cb("hide", "off", _("Close Read aloud")));
            if (self.state !== WAITING_FOR_PLAY_TO_START) {
                notes_container = bar_container.lastChild;
                notes_container.style.display = notes_container.previousSibling.style.display = "block";
                notes_container = notes_container.lastChild;
                if (self.state === STOPPED) {
                    notes_container.textContent = _("Tap/click on a word to start from there");
                } else if (self.state === PLAYING) {
                    notes_container.textContent = _("Tap/click on a word to skip to it");
                } else {
                    notes_container.textContent = _("Tap/click on a word to continue from there");
                }
            }
        };
        if (!ReadAloud.prototype.build_bar.__argnames__) Object.defineProperties(ReadAloud.prototype.build_bar, {
            __argnames__ : {value: ["annot_id"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.configure = function configure() {
            var self = this;
            self.pause();
            self.waiting_for_configure = true;
            ui_operations.tts("configure");
        };
        if (!ReadAloud.prototype.configure.__module__) Object.defineProperties(ReadAloud.prototype.configure, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.slower = function slower() {
            var self = this;
            ui_operations.tts("slower");
        };
        if (!ReadAloud.prototype.slower.__module__) Object.defineProperties(ReadAloud.prototype.slower, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.faster = function faster() {
            var self = this;
            ui_operations.tts("faster");
        };
        if (!ReadAloud.prototype.faster.__module__) Object.defineProperties(ReadAloud.prototype.faster, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.play = function play() {
            var self = this;
            if (self.state === PAUSED) {
                ui_operations.tts((self.waiting_for_configure) ? "resume_after_configure" : "resume");
                self.waiting_for_configure = false;
                self.state = PLAYING;
            } else if (self.state === STOPPED) {
                self.send_message("play");
                self.state = WAITING_FOR_PLAY_TO_START;
            }
        };
        if (!ReadAloud.prototype.play.__module__) Object.defineProperties(ReadAloud.prototype.play, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.pause = function pause() {
            var self = this;
            if (self.state === PLAYING) {
                ui_operations.tts("pause");
                self.state = PAUSED;
            }
        };
        if (!ReadAloud.prototype.pause.__module__) Object.defineProperties(ReadAloud.prototype.pause, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.stop = function stop() {
            var self = this;
            if (self.state === PLAYING || self.state === PAUSED) {
                ui_operations.tts("stop");
                self.state = STOPPED;
            }
        };
        if (!ReadAloud.prototype.stop.__module__) Object.defineProperties(ReadAloud.prototype.stop, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.toggle = function toggle() {
            var self = this;
            if (self.state === PLAYING) {
                self.pause();
            } else if (self.state === PAUSED || self.state === STOPPED) {
                self.play();
            }
        };
        if (!ReadAloud.prototype.toggle.__module__) Object.defineProperties(ReadAloud.prototype.toggle, {
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.container_clicked = function container_clicked(ev) {
            var self = this;
            var margins, pos;
            if (ev.button !== 0) {
                return;
            }
            [ev.stopPropagation(), ev.preventDefault()];
            margins = get_margins();
            pos = (function(){
                var _d = Object.create(null);
                _d["x"] = ev.clientX;
                _d["y"] = ev.clientY;
                return _d;
            }).call(this);
            pos = map_to_iframe_coords(pos, margins);
            _interpolate_kwargs.call(self, self.send_message, ["play"].concat([_desugar_kwargs({pos: pos})]));
        };
        if (!ReadAloud.prototype.container_clicked.__argnames__) Object.defineProperties(ReadAloud.prototype.container_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.on_keydown = function on_keydown(ev) {
            var self = this;
            var sc_name;
            [ev.stopPropagation(), ev.preventDefault()];
            if (ev.key === "Escape") {
                self.hide();
                return;
            }
            if (ev.key === " " || ev.key === "MediaPlayPause" || ev.key === "PlayPause") {
                self.toggle();
                return;
            }
            if (ev.key === "Play" || ev.key === "MediaPlay") {
                self.play();
                return;
            }
            if (ev.key === "Pause" || ev.key === "MediaPause") {
                self.pause();
                return;
            }
            if (ev.key === "MediaStop") {
                self.stop();
                return;
            }
            sc_name = shortcut_for_key_event(ev, self.view.keyboard_shortcut_map);
            if (!sc_name) {
                return;
            }
            if (sc_name === "show_chrome") {
                self.hide();
            } else if (sc_name === "quit") {
                self.hide();
                ui_operations.quit();
            }
        };
        if (!ReadAloud.prototype.on_keydown.__argnames__) Object.defineProperties(ReadAloud.prototype.on_keydown, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.handle_tts_event = function handle_tts_event(which, data) {
            var self = this;
            if (which === "mark") {
                _interpolate_kwargs.call(self, self.send_message, ["mark"].concat([_desugar_kwargs({num: data})]));
            } else if (which === "begin") {
                self.state = PLAYING;
            } else if (which === "end") {
                self.state = STOPPED;
                self.view.show_next_spine_item();
            } else if (which === "configured") {
                self.focus();
                if (self.waiting_for_configure) {
                    self.play();
                }
                if (data !== null) {
                }
            }
        };
        if (!ReadAloud.prototype.handle_tts_event.__argnames__) Object.defineProperties(ReadAloud.prototype.handle_tts_event, {
            __argnames__ : {value: ["which", "data"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.send_message = function send_message() {
            var self = this;
            var type = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            _interpolate_kwargs.call(self.view.iframe_wrapper, self.view.iframe_wrapper.send_message, ["tts"].concat([_desugar_kwargs(kw, {type: type})]));
        };
        if (!ReadAloud.prototype.send_message.__handles_kwarg_interpolation__) Object.defineProperties(ReadAloud.prototype.send_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["type"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.handle_message = function handle_message(msg) {
            var self = this;
            if (msg.type === "text-extracted") {
                if (msg.pos) {
                    self.stop();
                }
                ui_operations.tts("play", (function(){
                    var _d = Object.create(null);
                    _d["marked_text"] = msg.marked_text;
                    return _d;
                }).call(this));
            }
        };
        if (!ReadAloud.prototype.handle_message.__argnames__) Object.defineProperties(ReadAloud.prototype.handle_message, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.read_aloud"}
        });
        ReadAloud.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ReadAloud.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ReadAloud.prototype, "__bases__", {value: []});
        ReadAloud.prototype.dont_hide_on_content_loaded = true;
        ReadAloud.prototype.prevent_navigation = true;
        
        
        
        
        
        

        _modules["read_book.read_aloud"].HIDDEN = HIDDEN;
        _modules["read_book.read_aloud"].WAITING_FOR_PLAY_TO_START = WAITING_FOR_PLAY_TO_START;
        _modules["read_book.read_aloud"].PAUSED = PAUSED;
        _modules["read_book.read_aloud"].PLAYING = PLAYING;
        _modules["read_book.read_aloud"].STOPPED = STOPPED;
        _modules["read_book.read_aloud"].is_flow_mode = is_flow_mode;
        _modules["read_book.read_aloud"].ReadAloud = ReadAloud;
    })();

    (function(){
        var __name__ = "read_book.read_audio_ebook";
        var _unpack, HIDDEN, PLAYING, PAUSED;
        var E = _modules.elementmaker.E;

        var get_color = _modules["book_list.theme"].get_color;

        var change_icon_image = _modules.dom.change_icon_image;
        var svgicon = _modules.dom.svgicon;

        var _ = _modules.gettext.gettext;

        var error_dialog = _modules.modals.error_dialog;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var ICON_SIZE = _modules["read_book.highlights"].ICON_SIZE;

        var BUTTON_MARGIN = _modules["read_book.selection_bar"].BUTTON_MARGIN;
        var get_margins = _modules["read_book.selection_bar"].get_margins;
        var map_to_iframe_coords = _modules["read_book.selection_bar"].map_to_iframe_coords;

        var shortcut_for_key_event = _modules["read_book.shortcuts"].shortcut_for_key_event;

        var find_next_audio_in_spine = _modules["read_book.smil"].find_next_audio_in_spine;
        var get_smil_id_for_timestamp = _modules["read_book.smil"].get_smil_id_for_timestamp;
        var next_audio_file_for_spine_item = _modules["read_book.smil"].next_audio_file_for_spine_item;

        _unpack = ["HIDDEN", "PLAYING", "PAUSED"];
        HIDDEN = _unpack[0];
        PLAYING = _unpack[1];
        PAUSED = _unpack[2];
        function seconds_to_ms(seconds) {
            var minutes, remaining_seconds;
            minutes = Math.floor(seconds / 60);
            remaining_seconds = int(seconds % 60);
            return str(minutes) + ":" + str(remaining_seconds).zfill(2);
        };
        if (!seconds_to_ms.__argnames__) Object.defineProperties(seconds_to_ms, {
            __argnames__ : {value: ["seconds"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });

        function ReadAudioEbook() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ReadAudioEbook.prototype.__bind_methods__.call(this);
            ReadAudioEbook.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ReadAudioEbook.prototype, "__bind_methods__", {value: function () {
            this.initialize = ReadAudioEbook.prototype.initialize.bind(this);
            this.mark_for_timeupdate = ReadAudioEbook.prototype.mark_for_timeupdate.bind(this);
            this.play_next_audio_file = ReadAudioEbook.prototype.play_next_audio_file.bind(this);
            this.set_audio_src = ReadAudioEbook.prototype.set_audio_src.bind(this);
            this.start_playback = ReadAudioEbook.prototype.start_playback.bind(this);
            this.hide = ReadAudioEbook.prototype.hide.bind(this);
            this.show = ReadAudioEbook.prototype.show.bind(this);
            this.focus = ReadAudioEbook.prototype.focus.bind(this);
            this.slower = ReadAudioEbook.prototype.slower.bind(this);
            this.faster = ReadAudioEbook.prototype.faster.bind(this);
            this.play = ReadAudioEbook.prototype.play.bind(this);
            this.pause = ReadAudioEbook.prototype.pause.bind(this);
            this.toggle = ReadAudioEbook.prototype.toggle.bind(this);
            this.on_bar_clicked = ReadAudioEbook.prototype.on_bar_clicked.bind(this);
            this.on_container_clicked = ReadAudioEbook.prototype.on_container_clicked.bind(this);
            this.on_keydown = ReadAudioEbook.prototype.on_keydown.bind(this);
            this.send_message = ReadAudioEbook.prototype.send_message.bind(this);
            this.handle_message = ReadAudioEbook.prototype.handle_message.bind(this);
        }});
        Object.defineProperties(ReadAudioEbook.prototype,  {
            "bar": {
                "enumerable": true, 
                "get": function bar() {
                    var self = this;
                    return self.container.querySelector("[data-component=bar]");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "time_display": {
                "enumerable": true, 
                "get": function time_display() {
                    var self = this;
                    return self.container.querySelector("[data-component=time_display]");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "progress_bar": {
                "enumerable": true, 
                "get": function progress_bar() {
                    var self = this;
                    return self.container.querySelector("[data-component=progress_bar]");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById("audio-ebooks-overlay");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "audio_player": {
                "enumerable": true, 
                "get": function audio_player() {
                    var self = this;
                    return self.container.querySelector("[data-component=audio]");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "state": {
                "enumerable": true, 
                "get": function state() {
                    var self = this;
                    return self._state;
                }, 
                "set": function state(val) {
                    var self = this;
                    var speaking;
                    if (val !== self._state) {
                        speaking = false;
                        if (val === HIDDEN) {
                            self._state = HIDDEN;
                        } else if (val === PLAYING) {
                            self._state = PLAYING;
                            speaking = true;
                        } else if (val === PAUSED) {
                            self._state = PAUSED;
                        }
                        if (speaking) {
                            self.bar.classList.add("speaking");
                        } else {
                            self.bar.classList.remove("speaking");
                        }
                    }
                }
            }, 
            "play_pause_button": {
                "enumerable": true, 
                "get": function play_pause_button() {
                    var self = this;
                    return self.container.querySelector("[data-button=\"toggle\"]");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ReadAudioEbook.prototype.__init__ = function __init__(view) {
            var self = this;
            self.view = view;
            self._state = HIDDEN;
            self.initialized = false;
            self.current_audio_src = "";
        };
        if (!ReadAudioEbook.prototype.__init__.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.__argnames__ = ReadAudioEbook.prototype.__init__.__argnames__;
        ReadAudioEbook.__handles_kwarg_interpolation__ = ReadAudioEbook.prototype.__init__.__handles_kwarg_interpolation__;
        ReadAudioEbook.prototype.initialize = function initialize() {
            var self = this;
            var container, bar_container, x, ap;
            if (self.initialized) {
                return;
            }
            self.initialized = true;
            container = self.container;
            container.style.backgroundColor = "rgba(0, 0, 0, 0)";
            container.style.justifyContent = "center";
            container.style.alignItems = "flex-end";
            container.setAttribute("tabindex", "0");
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "bar", style: "position: absolute; bottom: 0; width: min(600px, 80vw); height: 2em; border-radius: 1em; padding:0.5em; display: flex; justify-content: center; align-items: center; background-color: " + _str.format("{}", get_color("window-background")) + ";"})]));
            bar_container = container.lastChild;
            container.appendChild(E.style("#" + _str.format("{}", container.id) + " .speaking " + "{ opacity: 0.5 }\n\n", "#" + _str.format("{}", container.id) + " .speaking:hover " + "{ opacity: 1.0 }\n\n"));
            container.addEventListener("keydown", self.on_keydown, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("click", self.on_container_clicked, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            container.addEventListener("contextmenu", self.toggle, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            function create_button(name, icon, text) {
                var ans;
                ans = svgicon(icon, ICON_SIZE, ICON_SIZE, text);
                if (name) {
                    ans.addEventListener("click", (function() {
                        var _anonfunc = function (ev) {
                            [ev.stopPropagation(), ev.preventDefault()];
                            self[(typeof name === "number" && name < 0) ? self.length + name : name](ev);
                            self.view.focus_iframe();
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["ev"]},
                            __module__ : {value: "read_book.read_audio_ebook"}
                        });
                        return _anonfunc;
                    })());
                }
                ans.dataset.button = name;
                ans.classList.add("simple-link");
                ans.style.marginLeft = ans.style.marginRight = BUTTON_MARGIN;
                return ans;
            };
            if (!create_button.__argnames__) Object.defineProperties(create_button, {
                __argnames__ : {value: ["name", "icon", "text"]},
                __module__ : {value: "read_book.read_audio_ebook"}
            });

            var _Iter0 = _Iterable(_list_decorate([ _interpolate_kwargs.call(E, E.div, [create_button("toggle", "pause", _("Pause audio"))].concat([_desugar_kwargs({style: "height: 3ex; display: flex; align-items: center; justify-content: center"})])), _interpolate_kwargs.call(E, E.div, [E.text("")].concat([_desugar_kwargs({data_component: "time_display"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display:block; width: 0%; background-color:" + _str.format("{}", get_color("window-foreground")) + "; height:100%"})])].concat([_desugar_kwargs({data_component: "progress_bar", style: "height:1.5em; border-radius: 0.75em; overflow: hidden; flex-grow: 100; display:block; background-color:" + _str.format("{}", get_color("window-background2")) + "; margin:1em; cursor: pointer"})])), _interpolate_kwargs.call(E, E.div, [create_button("slower", "slower", _("Slow down audio")), create_button("faster", "faster", _("Speed up audio")), create_button("hide", "off", _("Close Read aloud"))].concat([_desugar_kwargs({style: "height: 3ex; display: flex; align-items: center; justify-content: center"})])) ]));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                x = _Iter0[_Index0];
                bar_container.appendChild(x);
            }
            bar_container.addEventListener("click", self.on_bar_clicked, (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                return _d;
            }).call(this));
            self.container.appendChild(_interpolate_kwargs.call(E, E.audio, [_desugar_kwargs({data_component: "audio", style: "display:none"})]));
            ap = self.container.lastChild;
            ap.addEventListener("timeupdate", (function() {
                var _anonfunc = function () {
                    var ap, audio_current_time, progress;
                    if (self.state !== HIDDEN) {
                        ap = self.audio_player;
                        if (ap.duration) {
                            audio_current_time = ap.currentTime;
                            progress = audio_current_time / ap.duration * 100;
                            self.progress_bar.firstChild.style.width = progress + "%";
                            self.time_display.textContent = "" + _str.format("{}", seconds_to_ms(audio_current_time)) + "/" + _str.format("{}", seconds_to_ms(ap.duration)) + "";
                            self.mark_for_timeupdate(audio_current_time);
                        } else {
                            self.time_display.textContent = "00:00";
                            self.progress_bar.firstChild.style.width = "0%";
                        }
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.read_audio_ebook"}
                });
                return _anonfunc;
            })());
            ap.addEventListener("ended", (function() {
                var _anonfunc = function () {
                    self.play_next_audio_file();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.read_audio_ebook"}
                });
                return _anonfunc;
            })());
            self.progress_bar.addEventListener("click", (function() {
                var _anonfunc = function (event) {
                    var ap, rect, x, total_width, skip_time;
                    ap = self.audio_player;
                    if (ap.duration) {
                        rect = self.progress_bar.getBoundingClientRect();
                        x = event.clientX - rect.left;
                        total_width = rect.width;
                        if (total_width) {
                            skip_time = x / total_width * ap.duration;
                            ap.currentTime = skip_time;
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.read_audio_ebook"}
                });
                return _anonfunc;
            })());
        };
        if (!ReadAudioEbook.prototype.initialize.__module__) Object.defineProperties(ReadAudioEbook.prototype.initialize, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.mark_for_timeupdate = function mark_for_timeupdate(audio_time) {
            var self = this;
            var sam, _unpack, smil_id, idx;
            sam = self.view.currently_showing.smil_audio_map;
            if (sam) {
                _unpack = get_smil_id_for_timestamp(self.current_audio_src, audio_time, sam, self.last_marked_smil_idx);
_unpack = _unpack_asarray(2, _unpack);
                smil_id = _unpack[0];
                idx = _unpack[1];
                if (smil_id && smil_id !== self.last_marked_smil_id) {
                    _interpolate_kwargs.call(self, self.send_message, ["mark"].concat([_desugar_kwargs({anchor: smil_id, idx: idx})]));
                }
            }
        };
        if (!ReadAudioEbook.prototype.mark_for_timeupdate.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.mark_for_timeupdate, {
            __argnames__ : {value: ["audio_time"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.play_next_audio_file = function play_next_audio_file() {
            var self = this;
            var _unpack, next_audio_file, par, spine_name;
            _unpack = next_audio_file_for_spine_item(self.current_audio_src, self.view.currently_showing.smil_audio_map);
_unpack = _unpack_asarray(2, _unpack);
            next_audio_file = _unpack[0];
            par = _unpack[1];
            if (next_audio_file) {
                self.set_audio_src(next_audio_file, (function() {
                    var _anonfunc = function () {
                        self.audio_player.currentTime = _exists.d(par.audio).start || 0;
                        self.play();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.read_audio_ebook"}
                    });
                    return _anonfunc;
                })());
                return;
            }
            _unpack = find_next_audio_in_spine(self.view.currently_showing.spine_index, self.view.book.manifest);
_unpack = _unpack_asarray(2, _unpack);
            spine_name = _unpack[0];
            par = _unpack[1];
            if (spine_name) {
                _interpolate_kwargs.call(self.view, self.view.show_name, [spine_name].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "smil_id";
                    _d["anchor"] = par.anchor;
                    return _d;
                }).call(this)})]));
            } else {
                self.hide();
            }
        };
        if (!ReadAudioEbook.prototype.play_next_audio_file.__module__) Object.defineProperties(ReadAudioEbook.prototype.play_next_audio_file, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.set_audio_src = function set_audio_src(name, proceed) {
            var self = this;
            var ap;
            if (self.current_audio_src === name) {
                proceed();
                return;
            }
            self.last_marked_smil_id = self.last_marked_smil_idx = null;
            self.current_audio_src = name;
            ap = self.audio_player;
            if (ui_operations.get_url_for_book_file_name) {
                ap.onloadeddata = (function() {
                    var _anonfunc = function () {
                        proceed();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.read_audio_ebook"}
                    });
                    return _anonfunc;
                })();
                ap.onerror = (function() {
                    var _anonfunc = function (evt) {
                        console.error(evt);
                        error_dialog(_("Could not load audio"), _("Could not load the audio file: {} with error: {}").format(name, evt.message));
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["evt"]},
                        __module__ : {value: "read_book.read_audio_ebook"}
                    });
                    return _anonfunc;
                })();
                ap.src = ui_operations.get_url_for_book_file_name(name);
                return;
            }
            if (ap.src) {
                ap.onloadeddata = (function() {
                    var _anonfunc = function () {
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.read_audio_ebook"}
                    });
                    return _anonfunc;
                })();
                ap.onerror = (function() {
                    var _anonfunc = function () {
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.read_audio_ebook"}
                    });
                    return _anonfunc;
                })();
                window.URL.revokeObjectURL(ap.src);
                ap.src = "";
            }
            ui_operations.get_file(self.view.book, name, (function() {
                var _anonfunc = function (blob, name, mimetype) {
                    var ap;
                    ap = self.audio_player;
                    ap.onloadeddata = (function() {
                        var _anonfunc = function () {
                            proceed();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.read_audio_ebook"}
                        });
                        return _anonfunc;
                    })();
                    ap.onerror = (function() {
                        var _anonfunc = function (evt) {
                            console.error(evt);
                            error_dialog(_("Could not load audio"), _("Could not load the audio file: {} with error: {}").format(name, evt.message));
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["evt"]},
                            __module__ : {value: "read_book.read_audio_ebook"}
                        });
                        return _anonfunc;
                    })();
                    ap.src = window.URL.createObjectURL(blob);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["blob", "name", "mimetype"]},
                    __module__ : {value: "read_book.read_audio_ebook"}
                });
                return _anonfunc;
            })());
        };
        if (!ReadAudioEbook.prototype.set_audio_src.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.set_audio_src, {
            __argnames__ : {value: ["name", "proceed"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.start_playback = function start_playback() {
            var self = this;
            var cn, _unpack, spine_name, par;
            cn = self.view.currently_showing.name;
            if (_exists.d((_expr_temp = self.view.book.manifest.files)[(typeof cn === "number" && cn < 0) ? _expr_temp.length + cn : cn]).smil_map) {
                self.send_message("play");
                return;
            }
            _unpack = find_next_audio_in_spine(self.view.currently_showing.spine_index, self.view.book.manifest);
_unpack = _unpack_asarray(2, _unpack);
            spine_name = _unpack[0];
            par = _unpack[1];
            if (!spine_name) {
                _unpack = find_next_audio_in_spine(-1, self.view.book.manifest);
_unpack = _unpack_asarray(2, _unpack);
                spine_name = _unpack[0];
                par = _unpack[1];
            }
            if (spine_name) {
                _interpolate_kwargs.call(self.view, self.view.show_name, [spine_name].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "smil_id";
                    _d["anchor"] = par.anchor;
                    return _d;
                }).call(this)})]));
            } else {
                self.hide();
                error_dialog(_("No audio"), _("No audio found in this book"));
            }
        };
        if (!ReadAudioEbook.prototype.start_playback.__module__) Object.defineProperties(ReadAudioEbook.prototype.start_playback, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.hide = function hide() {
            var self = this;
            if (self.state !== HIDDEN) {
                self.send_message("mark");
                self.pause();
                self.container.style.display = "none";
                self.view.focus_iframe();
                self.state = HIDDEN;
                if (ui_operations.read_aloud_state_changed) {
                    ui_operations.read_aloud_state_changed(false);
                }
            }
        };
        if (!ReadAudioEbook.prototype.hide.__module__) Object.defineProperties(ReadAudioEbook.prototype.hide, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.show = function show() {
            var self = this;
            if (self.state === HIDDEN) {
                self.initialize();
                self.state = PLAYING;
                change_icon_image(self.play_pause_button, "pause", _("Pause audio"));
                self.start_playback();
                self.container.style.display = self.CONTAINER_DISPLAY;
                self.focus();
                if (ui_operations.read_aloud_state_changed) {
                    ui_operations.read_aloud_state_changed(true);
                }
            }
        };
        if (!ReadAudioEbook.prototype.show.__module__) Object.defineProperties(ReadAudioEbook.prototype.show, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.focus = function focus() {
            var self = this;
            self.container.focus();
        };
        if (!ReadAudioEbook.prototype.focus.__module__) Object.defineProperties(ReadAudioEbook.prototype.focus, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.slower = function slower() {
            var self = this;
            self.audio_player.playbackRate -= .1;
        };
        if (!ReadAudioEbook.prototype.slower.__module__) Object.defineProperties(ReadAudioEbook.prototype.slower, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.faster = function faster() {
            var self = this;
            self.audio_player.playbackRate += .1;
        };
        if (!ReadAudioEbook.prototype.faster.__module__) Object.defineProperties(ReadAudioEbook.prototype.faster, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.play = function play() {
            var self = this;
            var ap;
            self.state = PLAYING;
            change_icon_image(self.play_pause_button, "pause", _("Pause audio"));
            ap = self.audio_player;
            if (ap.getAttribute("src")) {
                ap.play();
            }
        };
        if (!ReadAudioEbook.prototype.play.__module__) Object.defineProperties(ReadAudioEbook.prototype.play, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.pause = function pause() {
            var self = this;
            var ap;
            self.state = PAUSED;
            change_icon_image(self.play_pause_button, "play", _("Play audio"));
            ap = self.audio_player;
            if (ap.getAttribute("src")) {
                ap.pause();
            }
        };
        if (!ReadAudioEbook.prototype.pause.__module__) Object.defineProperties(ReadAudioEbook.prototype.pause, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.toggle = function toggle() {
            var self = this;
            if (self.state === PLAYING) {
                self.pause();
            } else if (self.state === PAUSED) {
                self.play();
            }
        };
        if (!ReadAudioEbook.prototype.toggle.__module__) Object.defineProperties(ReadAudioEbook.prototype.toggle, {
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.on_bar_clicked = function on_bar_clicked(ev) {
            var self = this;
            [ev.stopPropagation(), ev.preventDefault()];
        };
        if (!ReadAudioEbook.prototype.on_bar_clicked.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.on_bar_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.on_container_clicked = function on_container_clicked(ev) {
            var self = this;
            var margins, pos;
            if (ev.button !== 0) {
                return;
            }
            [ev.stopPropagation(), ev.preventDefault()];
            margins = get_margins();
            pos = (function(){
                var _d = Object.create(null);
                _d["x"] = ev.clientX;
                _d["y"] = ev.clientY;
                return _d;
            }).call(this);
            pos = map_to_iframe_coords(pos, margins);
            _interpolate_kwargs.call(self, self.send_message, ["play"].concat([_desugar_kwargs({pos: pos})]));
        };
        if (!ReadAudioEbook.prototype.on_container_clicked.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.on_container_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.on_keydown = function on_keydown(ev) {
            var self = this;
            var sc_name;
            [ev.stopPropagation(), ev.preventDefault()];
            if (ev.key === "Escape") {
                self.hide();
                return;
            }
            if (ev.key === " " || ev.key === "MediaPlayPause" || ev.key === "PlayPause") {
                self.toggle();
                return;
            }
            if (ev.key === "Play" || ev.key === "MediaPlay") {
                self.play();
                return;
            }
            if (ev.key === "Pause" || ev.key === "MediaPause") {
                self.pause();
                return;
            }
            sc_name = shortcut_for_key_event(ev, self.view.keyboard_shortcut_map);
            if (!sc_name) {
                return;
            }
            if (sc_name === "show_chrome") {
                self.hide();
            } else if (sc_name === "quit") {
                self.hide();
            }
        };
        if (!ReadAudioEbook.prototype.on_keydown.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.on_keydown, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.send_message = function send_message() {
            var self = this;
            var message_type = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var kw = arguments[arguments.length-1];
            if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
            _interpolate_kwargs.call(self.view.iframe_wrapper, self.view.iframe_wrapper.send_message, ["audio-ebook"].concat([_desugar_kwargs(kw, {type: message_type})]));
        };
        if (!ReadAudioEbook.prototype.send_message.__handles_kwarg_interpolation__) Object.defineProperties(ReadAudioEbook.prototype.send_message, {
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["message_type"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.handle_message = function handle_message(message) {
            var self = this;
            if (message.type === "start_play_at") {
                if (message.par) {
                    self.set_audio_src(message.par.audio, (function() {
                        var _anonfunc = function () {
                            self.audio_player.currentTime = message.par.start || 0;
                            self.play();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.read_audio_ebook"}
                        });
                        return _anonfunc;
                    })());
                } else {
                    if (message.anchor) {
                        self.send_message("play");
                        return;
                    }
                    if (message.pos) {
                    } else {
                        self.pause();
                        error_dialog(_("Audio element not found"), _("Could not play audio as no associated audio was found"));
                    }
                }
            } else if (message.type === "marked") {
                if (message.anchor) {
                    self.last_marked_smil_id = message.anchor;
                    self.last_marked_smil_idx = message.idx;
                } else {
                    self.last_marked_smil_id = self.last_marked_smil_idx = null;
                }
            } else {
                console.error("Unknown audio ebook message type from iframe: " + _str.format("{}", message.type) + "");
            }
        };
        if (!ReadAudioEbook.prototype.handle_message.__argnames__) Object.defineProperties(ReadAudioEbook.prototype.handle_message, {
            __argnames__ : {value: ["message"]},
            __module__ : {value: "read_book.read_audio_ebook"}
        });
        ReadAudioEbook.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ReadAudioEbook.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ReadAudioEbook.prototype, "__bases__", {value: []});
        ReadAudioEbook.prototype.dont_hide_on_content_loaded = true;
        ReadAudioEbook.prototype.prevent_navigation = true;
        ReadAudioEbook.prototype.CONTAINER_DISPLAY = "flex";
        
        
        
        
        
        
        
        
        

        _modules["read_book.read_audio_ebook"]._unpack = _unpack;
        _modules["read_book.read_audio_ebook"].HIDDEN = HIDDEN;
        _modules["read_book.read_audio_ebook"].PLAYING = PLAYING;
        _modules["read_book.read_audio_ebook"].PAUSED = PAUSED;
        _modules["read_book.read_audio_ebook"].seconds_to_ms = seconds_to_ms;
        _modules["read_book.read_audio_ebook"].ReadAudioEbook = ReadAudioEbook;
    })();

    (function(){
        var __name__ = "read_book.scrollbar";
        var SIZE;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var cached_color_to_rgba = _modules["book_list.theme"].cached_color_to_rgba;

        var unique_id = _modules.dom.unique_id;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        SIZE = 10;
        function BookScrollbar() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            BookScrollbar.prototype.__bind_methods__.call(this);
            BookScrollbar.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(BookScrollbar.prototype, "__bind_methods__", {value: function () {
            this.create = BookScrollbar.prototype.create.bind(this);
            this.context_menu = BookScrollbar.prototype.context_menu.bind(this);
            this.bar_clicked = BookScrollbar.prototype.bar_clicked.bind(this);
            this.on_bob_mouse_event = BookScrollbar.prototype.on_bob_mouse_event.bind(this);
            this.apply_visibility = BookScrollbar.prototype.apply_visibility.bind(this);
            this.set_position = BookScrollbar.prototype.set_position.bind(this);
            this.sync_to_contents = BookScrollbar.prototype.sync_to_contents.bind(this);
            this.apply_color_scheme = BookScrollbar.prototype.apply_color_scheme.bind(this);
        }});
        Object.defineProperties(BookScrollbar.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.container_id);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "effective_width": {
                "enumerable": true, 
                "get": function effective_width() {
                    var self = this;
                    return (self.container.style.display === "block") ? SIZE : 0;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        BookScrollbar.prototype.__init__ = function __init__(view) {
            var self = this;
            self.view = view;
            self.container_id = unique_id("book-scrollbar");
            self.sync_to_contents_timer = 0;
            self.sync_contents_timer = 0;
        };
        if (!BookScrollbar.prototype.__init__.__argnames__) Object.defineProperties(BookScrollbar.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.__argnames__ = BookScrollbar.prototype.__init__.__argnames__;
        BookScrollbar.__handles_kwarg_interpolation__ = BookScrollbar.prototype.__init__.__handles_kwarg_interpolation__;
        BookScrollbar.prototype.create = function create() {
            var self = this;
            self.on_bob_mousedown = self.on_bob_mouse_event.bind(null, "down");
            self.on_bob_mousemove = self.on_bob_mouse_event.bind(null, "move");
            self.on_bob_mouseup = self.on_bob_mouse_event.bind(null, "up");
            return _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: relative; width: 100%; height: " + _str.format("{}", int(2.2 * SIZE)) + "px; background-color: #444; border-radius: 5px", onmousedown: self.on_bob_mousedown})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; z-index: 2147483647; width: 100vw; height: 100vh; left: 0; top: 0; display: none;"})])].concat([_desugar_kwargs({id: self.container_id, style: "height: 100vh; background-color: #aaa; width: " + _str.format("{}", SIZE) + "px; border-radius: 5px", onclick: self.bar_clicked, oncontextmenu: self.context_menu})]));
        };
        if (!BookScrollbar.prototype.create.__module__) Object.defineProperties(BookScrollbar.prototype.create, {
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.context_menu = function context_menu(ev) {
            var self = this;
            var c, bob, height, top, frac;
            if (ui_operations.scrollbar_context_menu) {
                [ev.preventDefault(), ev.stopPropagation()];
                c = self.container;
                bob = c.firstChild;
                height = c.clientHeight - bob.clientHeight;
                top = max(0, min(ev.clientY - bob.clientHeight, height));
                frac = max(0, min(top / height, 1));
                ui_operations.scrollbar_context_menu(ev.screenX, ev.screenY, frac);
            }
        };
        if (!BookScrollbar.prototype.context_menu.__argnames__) Object.defineProperties(BookScrollbar.prototype.context_menu, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.bar_clicked = function bar_clicked(evt) {
            var self = this;
            var c, b, bob_top, bob_bottom;
            if (evt.button === 0) {
                c = self.container;
                b = c.firstChild;
                bob_top = b.offsetTop;
                bob_bottom = bob_top + b.offsetHeight;
                if (evt.clientY < bob_top) {
                    self.view.side_margin_clicked("left", evt);
                } else if (evt.clientY > bob_bottom) {
                    self.view.side_margin_clicked("right", evt);
                }
            }
        };
        if (!BookScrollbar.prototype.bar_clicked.__argnames__) Object.defineProperties(BookScrollbar.prototype.bar_clicked, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.on_bob_mouse_event = function on_bob_mouse_event(which, evt) {
            var self = this;
            var c, bob, mouse_grab, top, height, frac;
            c = self.container;
            bob = c.firstChild;
            mouse_grab = bob.nextSibling;
            if (which === "move") {
                top = evt.pageY - self.down_y;
                height = c.clientHeight - bob.clientHeight;
                top = max(0, min(top, height));
                bob.style.top = "" + _str.format("{}", top) + "px";
                [evt.preventDefault(), evt.stopPropagation()];
                frac = bob.offsetTop / height;
                if (self.sync_contents_timer) {
                    window.clearTimeout(self.sync_contents_timer);
                }
                self.sync_contents_timer = window.setTimeout(self.view.goto_frac.bind(null, frac), 2);
            } else if (which === "down") {
                if (evt.button !== 0) {
                    return;
                }
                [evt.preventDefault(), evt.stopPropagation()];
                self.down_y = evt.clientY - bob.getBoundingClientRect().top;
                mouse_grab.style.display = "block";
                window.addEventListener("mousemove", self.on_bob_mousemove, (function(){
                    var _d = Object.create(null);
                    _d["capture"] = true;
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                window.addEventListener("mouseup", self.on_bob_mouseup, (function(){
                    var _d = Object.create(null);
                    _d["capture"] = true;
                    _d["passive"] = false;
                    return _d;
                }).call(this));
            } else if (which === "up") {
                self.down_y = 0;
                window.removeEventListener("mousemove", self.on_bob_mousemove, (function(){
                    var _d = Object.create(null);
                    _d["capture"] = true;
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                window.removeEventListener("mouseup", self.on_bob_mouseup, (function(){
                    var _d = Object.create(null);
                    _d["capture"] = true;
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                window.setTimeout((function() {
                    var _anonfunc = function () {
                        self.container.firstChild.nextSibling.style.display = "none";
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.scrollbar"}
                    });
                    return _anonfunc;
                })(), 10);
                [evt.preventDefault(), evt.stopPropagation()];
            }
        };
        if (!BookScrollbar.prototype.on_bob_mouse_event.__argnames__) Object.defineProperties(BookScrollbar.prototype.on_bob_mouse_event, {
            __argnames__ : {value: ["which", "evt"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.apply_visibility = function apply_visibility() {
            var self = this;
            var sd;
            sd = get_session_data();
            self.container.style.display = (sd.get("book_scrollbar")) ? "block" : "none";
        };
        if (!BookScrollbar.prototype.apply_visibility.__module__) Object.defineProperties(BookScrollbar.prototype.apply_visibility, {
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.set_position = function set_position(frac) {
            var self = this;
            var c;
            c = self.container;
            frac = max(0, min(frac, 1));
            c.firstChild.style.top = "" + _str.format("{}", frac * (c.clientHeight - c.firstChild.clientHeight)) + "px";
        };
        if (!BookScrollbar.prototype.set_position.__argnames__) Object.defineProperties(BookScrollbar.prototype.set_position, {
            __argnames__ : {value: ["frac"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.sync_to_contents = function sync_to_contents(frac) {
            var self = this;
            if (self.sync_to_contents_timer) {
                window.clearTimeout(self.sync_to_contents_timer);
            }
            self.sync_to_contents_timer = window.setTimeout(self.set_position.bind(null, frac), 100);
        };
        if (!BookScrollbar.prototype.sync_to_contents.__argnames__) Object.defineProperties(BookScrollbar.prototype.sync_to_contents, {
            __argnames__ : {value: ["frac"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.apply_color_scheme = function apply_color_scheme(colors) {
            var self = this;
            var fg, bg, rbg, rfg, c;
            fg = cached_color_to_rgba(colors.foreground);
            bg = cached_color_to_rgba(colors.background);
            function mix(fg, bg, frac) {
                function m(x) {
                    return frac * fg[(typeof x === "number" && x < 0) ? fg.length + x : x] + (1 - frac) * bg[(typeof x === "number" && x < 0) ? bg.length + x : x];
                };
                if (!m.__argnames__) Object.defineProperties(m, {
                    __argnames__ : {value: ["x"]},
                    __module__ : {value: "read_book.scrollbar"}
                });

                return [m[0], m[1], m[2]];
            };
            if (!mix.__argnames__) Object.defineProperties(mix, {
                __argnames__ : {value: ["fg", "bg", "frac"]},
                __module__ : {value: "read_book.scrollbar"}
            });

            rbg = mix(fg, bg, .3);
            rfg = mix(fg, bg, .7);
            c = self.container;
            c.style.backgroundColor = "rgb(" + _str.format("{}", rbg[0]) + ", " + _str.format("{}", rbg[1]) + ", " + _str.format("{}", rbg[2]) + ")";
            c.firstChild.style.backgroundColor = "rgb(" + _str.format("{}", rfg[0]) + ", " + _str.format("{}", rfg[1]) + ", " + _str.format("{}", rfg[2]) + ")";
        };
        if (!BookScrollbar.prototype.apply_color_scheme.__argnames__) Object.defineProperties(BookScrollbar.prototype.apply_color_scheme, {
            __argnames__ : {value: ["colors"]},
            __module__ : {value: "read_book.scrollbar"}
        });
        BookScrollbar.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        BookScrollbar.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(BookScrollbar.prototype, "__bases__", {value: []});
        
        

        _modules["read_book.scrollbar"].SIZE = SIZE;
        _modules["read_book.scrollbar"].BookScrollbar = BookScrollbar;
    })();

    (function(){
        var __name__ = "read_book.search_worker";
        var GET_SPINE_FAILED, CONNECT_FAILED, UNHANDLED_ERROR, DB_ERROR, _RE_ESCAPE, quote_map, qpat, spat, invisible_chars, wc;
        var DB = _modules["read_book.db"].DB;

        var text_from_serialized_html = _modules["read_book.resources"].text_from_serialized_html;

        var format_exception = _modules.traceback.format_exception;

        GET_SPINE_FAILED = 1;
        CONNECT_FAILED = 2;
        UNHANDLED_ERROR = 3;
        DB_ERROR = 4;
        _RE_ESCAPE = /[-\/\\^$*+?.()|[\]{}]/g;
        quote_map = (function(){
            var _d = Object.create(null);
            _d["\""] = "\"";
            _d["'"] = "'";
            return _d;
        }).call(this);
        qpat = /(['"])/g;
        spat = /(\s+)/g;
        invisible_chars = "(?:[\u00ad\u200c\u200d]{0,1})";
        function escape(string) {
            return string.replace(_RE_ESCAPE, "\\$&");
        };
        if (!escape.__argnames__) Object.defineProperties(escape, {
            __argnames__ : {value: ["string"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function split_string(pat, string) {
            pat.lastIndex = 0;
            return string.split(pat);
        };
        if (!split_string.__argnames__) Object.defineProperties(split_string, {
            __argnames__ : {value: ["pat", "string"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function text_to_regex(text) {
            var has_leading, has_trailing, ans, r, chars, ch, part, wpart;
            if (text && !text.strip()) {
                return "\\s+";
            }
            has_leading = text.lstrip() !== text;
            has_trailing = text.rstrip() !== text;
            ans = (has_leading) ? ["\s+"] : [];
            var _Iter0 = _Iterable(split_string(spat, text.strip()));
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                wpart = _Iter0[_Index0];
                if (!wpart.strip()) {
                    ans.push("\\s+");
                } else {
                    var _Iter1 = _Iterable(split_string(qpat, wpart));
                    for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                        part = _Iter1[_Index1];
                        r = quote_map[(typeof part === "number" && part < 0) ? quote_map.length + part : part];
                        if (r) {
                            ans.push("[" + r + "]");
                        } else {
                            chars = [];
                            var _Iter2 = _Iterable(part);
                            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                                ch = _Iter2[_Index2];
                                chars.push(escape(ch));
                            }
                            chars.join(invisible_chars);
                            ans.push(part);
                        }
                    }
                }
            }
            if (has_trailing) {
                ans.push("\\s+");
            }
            return ans.join("");
        };
        if (!text_to_regex.__argnames__) Object.defineProperties(text_to_regex, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function ToCOffsetMap() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ToCOffsetMap.prototype.__bind_methods__.call(this);
            ToCOffsetMap.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(ToCOffsetMap.prototype, "__bind_methods__", {value: function () {
            this.toc_nodes_for_offset = ToCOffsetMap.prototype.toc_nodes_for_offset.bind(this);
        }});
        ToCOffsetMap.prototype.__init__ = function __init__(toc_nodes, offset_map, previous_toc_node, parent_map) {
            var self = this;
            self.toc_nodes = toc_nodes || [];
            self.offset_map = offset_map || Object.create(null);
            self.previous_toc_node = previous_toc_node || null;
            self.parent_map = parent_map || Object.create(null);
        };
        if (!ToCOffsetMap.prototype.__init__.__argnames__) Object.defineProperties(ToCOffsetMap.prototype.__init__, {
            __argnames__ : {value: ["toc_nodes", "offset_map", "previous_toc_node", "parent_map"]},
            __module__ : {value: "read_book.search_worker"}
        });
        ToCOffsetMap.__argnames__ = ToCOffsetMap.prototype.__init__.__argnames__;
        ToCOffsetMap.__handles_kwarg_interpolation__ = ToCOffsetMap.prototype.__init__.__handles_kwarg_interpolation__;
        ToCOffsetMap.prototype.toc_nodes_for_offset = function toc_nodes_for_offset(offset) {
            var self = this;
            var matches, q, node, ans, ancestors, parent;
            matches = [];
            var _Iter3 = _Iterable(self.toc_nodes);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                node = _Iter3[_Index3];
                q = (_expr_temp = self.offset_map)[_bound_index(node.id, _expr_temp)];
                if ((typeof q !== "undefined" && q !== null)) {
                    if (q > offset) {
                        break;
                    }
                    matches.push(node);
                }
            }
            if (!matches && self.previous_toc_node) {
                matches.push(self.previous_toc_node);
            }
            ans = [];
            if (matches.length) {
                ancestors = [];
                node = matches[matches.length-1];
                parent = (_expr_temp = self.parent_map)[_bound_index(node.id, _expr_temp)];
                while ((typeof parent !== "undefined" && parent !== null)) {
                    ancestors.push(parent);
                    parent = (_expr_temp = self.parent_map)[_bound_index(parent.id, _expr_temp)];
                }
                if (ancestors.length > 1) {
                    for (var i = ancestors.length - 1; i-- > 0;) {
                        ans.push(ancestors[(typeof i === "number" && i < 0) ? ancestors.length + i : i].id);
                    }
                }
                ans.push(node.id);
            }
            return ans;
        };
        if (!ToCOffsetMap.prototype.toc_nodes_for_offset.__argnames__) Object.defineProperties(ToCOffsetMap.prototype.toc_nodes_for_offset, {
            __argnames__ : {value: ["offset"]},
            __module__ : {value: "read_book.search_worker"}
        });
        ToCOffsetMap.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ToCOffsetMap.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ToCOffsetMap.prototype, "__bases__", {value: []});

        function toc_offset_map_for_name(name) {
            var anchor_map, toc_data, idx, toc_nodes, offset_map, node_id, aid, offset, node, prev_toc_node, spine_name, ptn;
            if ((_expr_temp = wc.toc_offset_map_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]) {
                return (_expr_temp = wc.toc_offset_map_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            }
            anchor_map = (_expr_temp = wc.text_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name][1];
            toc_data = wc.current_book.toc_data;
            idx = (_expr_temp = toc_data.spine_idx_map)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            toc_nodes = (_expr_temp = toc_data.spine_toc_map)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            if (!(typeof idx !== "undefined" && idx !== null) || idx < 0) {
                (_expr_temp = wc.toc_offset_map_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = new ToCOffsetMap;
                return (_expr_temp = wc.toc_offset_map_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            }
            offset_map = Object.create(null);
            var _Iter4 = _Iterable(toc_nodes);
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                node = _Iter4[_Index4];
                node_id = node.id;
                if ((typeof node_id !== "undefined" && node_id !== null)) {
                    aid = node.frag;
                    offset = anchor_map[(typeof aid === "number" && aid < 0) ? anchor_map.length + aid : aid] || 0;
                    offset_map[(typeof node_id === "number" && node_id < 0) ? offset_map.length + node_id : node_id] = offset;
                }
            }
            prev_toc_node = null;
            for (var i = idx; i-- > 0;) {
                spine_name = (_expr_temp = wc.current_book.spine)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i];
                ptn = (_expr_temp = toc_data.spine_toc_map)[(typeof spine_name === "number" && spine_name < 0) ? _expr_temp.length + spine_name : spine_name];
                if ((typeof ptn !== "undefined" && ptn !== null)) {
                    prev_toc_node = ptn[ptn.length-1];
                    break;
                }
            }
            (_expr_temp = wc.toc_offset_map_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = new ToCOffsetMap(toc_nodes, offset_map, prev_toc_node, toc_data.parent_map);
            return (_expr_temp = wc.toc_offset_map_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
        };
        if (!toc_offset_map_for_name.__argnames__) Object.defineProperties(toc_offset_map_for_name, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function toc_nodes_for_search_result(sr) {
            var sidx, name, tmap;
            sidx = sr.spine_idx;
            name = (_expr_temp = wc.current_book.spine)[(typeof sidx === "number" && sidx < 0) ? _expr_temp.length + sidx : sidx];
            if (!name) {
                return [];
            }
            tmap = toc_offset_map_for_name(name);
            return tmap.toc_nodes_for_offset(sr.offset);
        };
        if (!toc_nodes_for_search_result.__argnames__) Object.defineProperties(toc_nodes_for_search_result, {
            __argnames__ : {value: ["sr"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function Worker() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Worker.prototype.__bind_methods__.call(this);
            Worker.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Worker.prototype, "__bind_methods__", {value: function () {
            this.clear_caches = Worker.prototype.clear_caches.bind(this);
        }});
        Object.defineProperties(Worker.prototype,  {
            "initialize_error_msg": {
                "enumerable": true, 
                "get": function initialize_error_msg() {
                    var self = this;
                    return _exists.d(self.db).initialize_error_msg;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        Worker.prototype.__init__ = function __init__() {
            var self = this;
            self.db = null;
            self.connected_to_db = false;
            self.pending_search = null;
            self.searching = false;
            self.current_query = null;
            self.current_query_id = null;
            self.current_book = null;
            self.regex = null;
            self.result_num = 0;
            self.clear_caches();
        };
        if (!Worker.prototype.__init__.__module__) Object.defineProperties(Worker.prototype.__init__, {
            __module__ : {value: "read_book.search_worker"}
        });
        Worker.__argnames__ = Worker.prototype.__init__.__argnames__;
        Worker.__handles_kwarg_interpolation__ = Worker.prototype.__init__.__handles_kwarg_interpolation__;
        Worker.prototype.clear_caches = function clear_caches() {
            var self = this;
            self.text_cache = Object.create(null);
            self.toc_offset_map_cache = Object.create(null);
        };
        if (!Worker.prototype.clear_caches.__module__) Object.defineProperties(Worker.prototype.clear_caches, {
            __module__ : {value: "read_book.search_worker"}
        });
        Worker.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Worker.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Worker.prototype, "__bases__", {value: []});
        

        wc = new Worker;
        function send_search_complete() {
            self.postMessage((function(){
                var _d = Object.create(null);
                _d["type"] = "search_complete";
                _d["id"] = wc.current_query_id;
                return _d;
            }).call(this));
            wc.current_query = wc.current_query_id = null;
        };
        if (!send_search_complete.__module__) Object.defineProperties(send_search_complete, {
            __module__ : {value: "read_book.search_worker"}
        });

        function search_in_text_of(name) {
            var ctx_size, r, haystack, match_counts, spine_idx, m, text, _unpack, start, end, before, after, q, result;
            ctx_size = 75;
            r = wc.regex;
            r.lastIndex = 0;
            haystack = (_expr_temp = wc.text_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name][0] || "";
            match_counts = Object.create(null);
            spine_idx = wc.current_book.spine.indexOf(name);
            while (true) {
                m = r.exec(haystack);
                if (!m) {
                    break;
                }
                text = m[0];
                _unpack = [m.index, r.lastIndex];
                start = _unpack[0];
                end = _unpack[1];
                before = haystack.slice(Math.max(0, start - ctx_size), start);
                after = haystack.slice(end, end + ctx_size);
                q = (before || "").slice(-15) + text + (after || "").slice(0, 15);
                match_counts[(typeof q === "number" && q < 0) ? match_counts.length + q : q] = match_counts[(typeof q === "number" && q < 0) ? match_counts.length + q : q] || 0;
                wc.result_num += 1;
                result = (function(){
                    var _d = Object.create(null);
                    _d["file_name"] = name;
                    _d["spine_idx"] = spine_idx;
                    _d["index"] = match_counts[(typeof q === "number" && q < 0) ? match_counts.length + q : q];
                    _d["offset"] = start;
                    _d["text"] = text;
                    _d["before"] = before;
                    _d["after"] = after;
                    _d["mode"] = wc.current_query.query.mode;
                    _d["q"] = q;
                    _d["result_num"] = wc.result_num;
                    _d["on_discovery"] = wc.current_query_id;
                    return _d;
                }).call(this);
                result.toc_nodes = toc_nodes_for_search_result(result);
                self.postMessage((function(){
                    var _d = Object.create(null);
                    _d["type"] = "search_result";
                    _d["id"] = wc.current_query_id;
                    _d["result"] = result;
                    return _d;
                }).call(this));
                if (wc.current_query.query.only_first_match) {
                    break;
                }
                match_counts[(typeof q === "number" && q < 0) ? match_counts.length + q : q] += 1;
            }
        };
        if (!search_in_text_of.__argnames__) Object.defineProperties(search_in_text_of, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function queue_next_spine_item(spine_idx, allow_current_name) {
            var name, query;
            spine_idx = spine_idx % wc.current_book.spine.length;
            name = (_expr_temp = wc.current_book.spine)[(typeof spine_idx === "number" && spine_idx < 0) ? _expr_temp.length + spine_idx : spine_idx];
            if (wc.current_query.query.only_first_match && wc.result_num > 0) {
                send_search_complete();
                return;
            }
            if (!name || !allow_current_name && name === wc.current_query.current_name) {
                send_search_complete();
                return;
            }
            if ((_expr_temp = wc.text_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]) {
                search_in_text_of(name);
                setTimeout(queue_next_spine_item.bind(null, spine_idx + 1), 0);
                return;
            }
            query = wc.current_query;
            wc.db.get_book_file(wc.current_book.book_hash, wc.current_book.stored_files, name, got_spine_item.bind(null, query.id, spine_idx));
        };
        if (!queue_next_spine_item.__argnames__) Object.defineProperties(queue_next_spine_item, {
            __argnames__ : {value: ["spine_idx", "allow_current_name"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function got_spine_item(query_id, spine_idx, result) {
            var name;
            if (query_id !== wc.current_query_id) {
                return;
            }
            if (result.ok) {
                name = (_expr_temp = wc.current_book.spine)[(typeof spine_idx === "number" && spine_idx < 0) ? _expr_temp.length + spine_idx : spine_idx];
                (_expr_temp = wc.text_cache)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = text_from_serialized_html(result.result, true);
                search_in_text_of(name);
                setTimeout(queue_next_spine_item.bind(null, spine_idx + 1), 0);
            } else {
                if (result.details === "ENOENT") {
                    queue_next_spine_item(spine_idx + 1);
                } else {
                    send_error(GET_SPINE_FAILED, result.details);
                    wc.current_query = wc.current_query_id = null;
                }
            }
        };
        if (!got_spine_item.__argnames__) Object.defineProperties(got_spine_item, {
            __argnames__ : {value: ["query_id", "spine_idx", "result"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function regex_for_query(query) {
            var expr, flags, words, part;
            expr = query.text;
            flags = "umg";
            if (!query.case_sensitive) {
                flags += "i";
            }
            if (query.mode !== "regex") {
                if (query.mode === "word") {
                    words = [];
                    var _Iter5 = _Iterable(expr.split(" "));
                    for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                        part = _Iter5[_Index5];
                        words.push("\\b" + text_to_regex(part) + "\\b");
                    }
                    expr = words.join("\\s+");
                } else {
                    expr = text_to_regex(expr);
                }
            }
            return new RegExp(expr, flags);
        };
        if (!regex_for_query.__argnames__) Object.defineProperties(regex_for_query, {
            __argnames__ : {value: ["query"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function perform_search(query) {
            var idx;
            wc.current_query = query;
            wc.current_query_id = query.id;
            wc.result_num = 0;
            if (!wc.current_book || !_exists.d(wc.current_book.spine).length || !query.query.text) {
                send_search_complete();
                return;
            }
            wc.regex = regex_for_query(query.query);
            idx = wc.current_book.spine.indexOf(query.current_name);
            if (idx < 0) {
                idx = 0;
            }
            queue_next_spine_item(idx, true);
        };
        if (!perform_search.__argnames__) Object.defineProperties(perform_search, {
            __argnames__ : {value: ["query"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function worker_connection_done() {
            var s;
            wc.connected_to_db = true;
            if (!wc.initialize_error_msg) {
                if (wc.pending_search) {
                    s = wc.pending_search;
                    wc.pending_search = null;
                    perform_search(s);
                }
            }
        };
        if (!worker_connection_done.__module__) Object.defineProperties(worker_connection_done, {
            __module__ : {value: "read_book.search_worker"}
        });

        function send_error(code, msg, error) {
            self.postMessage((function(){
                var _d = Object.create(null);
                _d["type"] = "error";
                _d["code"] = code;
                _d["msg"] = msg;
                _d["id"] = wc.current_query_id;
                _d["error"] = error;
                return _d;
            }).call(this));
        };
        if (!send_error.__argnames__) Object.defineProperties(send_error, {
            __argnames__ : {value: ["code", "msg", "error"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function on_worker_db_error(title, msg, details) {
            send_error(DB_ERROR, msg, (function(){
                var _d = Object.create(null);
                _d["title"] = title;
                _d["msg"] = msg;
                _d["details"] = details;
                return _d;
            }).call(this));
        };
        if (!on_worker_db_error.__argnames__) Object.defineProperties(on_worker_db_error, {
            __argnames__ : {value: ["title", "msg", "details"]},
            __module__ : {value: "read_book.search_worker"}
        });

        function worker_main() {
            wc.db = new DB(worker_connection_done, on_worker_db_error);
            self.onmessage = (function() {
                var _anonfunc = function (e) {
                    if (e.data.type === "search") {
                        wc.current_query_id = e.data.id;
                        if (wc.connected_to_db) {
                            if (wc.initialize_error_msg) {
                                send_error(CONNECT_FAILED, wc.initialize_error_msg);
                            } else {
                                perform_search(e.data);
                            }
                        } else {
                            wc.pending_search = e.data;
                        }
                    } else if (e.data.type === "clear_caches") {
                        wc.clear_caches();
                        wc.current_book = e.data.book;
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["e"]},
                    __module__ : {value: "read_book.search_worker"}
                });
                return _anonfunc;
            })();
            self.addEventListener("error", (function() {
                var _anonfunc = function (e) {
                    send_error(UNHANDLED_ERROR, "" + _str.format("{}", e.lineno) + ":" + _str.format("{}", e.message) + "" + "\n\n" + format_exception(e.error).join(""));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["e"]},
                    __module__ : {value: "read_book.search_worker"}
                });
                return _anonfunc;
            })());
        };
        if (!worker_main.__module__) Object.defineProperties(worker_main, {
            __module__ : {value: "read_book.search_worker"}
        });

        _modules["read_book.search_worker"].GET_SPINE_FAILED = GET_SPINE_FAILED;
        _modules["read_book.search_worker"].CONNECT_FAILED = CONNECT_FAILED;
        _modules["read_book.search_worker"].UNHANDLED_ERROR = UNHANDLED_ERROR;
        _modules["read_book.search_worker"].DB_ERROR = DB_ERROR;
        _modules["read_book.search_worker"]._RE_ESCAPE = _RE_ESCAPE;
        _modules["read_book.search_worker"].quote_map = quote_map;
        _modules["read_book.search_worker"].qpat = qpat;
        _modules["read_book.search_worker"].spat = spat;
        _modules["read_book.search_worker"].invisible_chars = invisible_chars;
        _modules["read_book.search_worker"].wc = wc;
        _modules["read_book.search_worker"].escape = escape;
        _modules["read_book.search_worker"].split_string = split_string;
        _modules["read_book.search_worker"].text_to_regex = text_to_regex;
        _modules["read_book.search_worker"].ToCOffsetMap = ToCOffsetMap;
        _modules["read_book.search_worker"].toc_offset_map_for_name = toc_offset_map_for_name;
        _modules["read_book.search_worker"].toc_nodes_for_search_result = toc_nodes_for_search_result;
        _modules["read_book.search_worker"].Worker = Worker;
        _modules["read_book.search_worker"].send_search_complete = send_search_complete;
        _modules["read_book.search_worker"].search_in_text_of = search_in_text_of;
        _modules["read_book.search_worker"].queue_next_spine_item = queue_next_spine_item;
        _modules["read_book.search_worker"].got_spine_item = got_spine_item;
        _modules["read_book.search_worker"].regex_for_query = regex_for_query;
        _modules["read_book.search_worker"].perform_search = perform_search;
        _modules["read_book.search_worker"].worker_connection_done = worker_connection_done;
        _modules["read_book.search_worker"].send_error = send_error;
        _modules["read_book.search_worker"].on_worker_db_error = on_worker_db_error;
        _modules["read_book.search_worker"].worker_main = worker_main;
    })();

    (function(){
        var __name__ = "worker";
        var main_js = _modules["book_list.globals"].main_js;

        function worker_js_url(entry_point) {
            if (!worker_js_url.ans) {
                worker_js_url.ans = window.URL.createObjectURL(new Blob(_list_decorate([ main_js() ])), (function(){
                    var _d = Object.create(null);
                    _d["type"] = "text/javascript";
                    return _d;
                }).call(this));
            }
            return worker_js_url.ans + "#" + entry_point;
        };
        if (!worker_js_url.__argnames__) Object.defineProperties(worker_js_url, {
            __argnames__ : {value: ["entry_point"]},
            __module__ : {value: "worker"}
        });

        function start_worker(entry_point) {
            return new window.Worker(worker_js_url(entry_point));
        };
        if (!start_worker.__argnames__) Object.defineProperties(start_worker, {
            __argnames__ : {value: ["entry_point"]},
            __module__ : {value: "worker"}
        });

        _modules.worker.worker_js_url = worker_js_url;
        _modules.worker.start_worker = start_worker;
    })();

    (function(){
        var __name__ = "read_book.search";
        var main;
        var E = _modules.elementmaker.E;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var get_color = _modules["book_list.theme"].get_color;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var create_search_bar = _modules.complete.create_search_bar;

        var clear = _modules.dom.clear;
        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;

        var _ = _modules.gettext.gettext;
        var ngettext = _modules.gettext.ngettext;

        var error_dialog = _modules.modals.error_dialog;

        var current_book = _modules["read_book.globals"].current_book;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var CONNECT_FAILED = _modules["read_book.search_worker"].CONNECT_FAILED;
        var DB_ERROR = _modules["read_book.search_worker"].DB_ERROR;
        var GET_SPINE_FAILED = _modules["read_book.search_worker"].GET_SPINE_FAILED;
        var UNHANDLED_ERROR = _modules["read_book.search_worker"].UNHANDLED_ERROR;
        var worker_main = _modules["read_book.search_worker"].worker_main;

        var shortcut_for_key_event = _modules["read_book.shortcuts"].shortcut_for_key_event;

        var create_button = _modules.widgets.create_button;
        var create_spinner = _modules.widgets.create_spinner;

        var start_worker = _modules.worker.start_worker;

        function parse_error_msg(msg) {
            var details, emsg;
            details = msg.msg;
            emsg = _("Unknown error");
            if (msg.code === GET_SPINE_FAILED) {
                emsg = _("Loading text from the book failed.");
            } else if (msg.code === CONNECT_FAILED) {
                emsg = _("Connecting to database storing the local copy of the book failed in the worker thread.");
            } else if (msg.code === UNHANDLED_ERROR) {
                emsg = _("There was an unhandled error while searching.");
            } else if (msg.code === DB_ERROR) {
                emsg = msg.error.msg;
                details = msg.error.details;
            }
            return [emsg, details];
        };
        if (!parse_error_msg.__argnames__) Object.defineProperties(parse_error_msg, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.search"}
        });

        function get_toc_data(book) {
            var spine, spine_toc_map, name, parent_map, toc_id_map, toc;
            spine = book.manifest.spine;
            spine_toc_map = (function() {
                var _Iter = _Iterable(spine), _Result = Object.create(null), name;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    name = _Iter[_Index];
                    _Result[name] = ([]);
                }
                return _Result;
            })();
            parent_map = Object.create(null);
            toc_id_map = Object.create(null);
            function process_node(node) {
                var items, children, child;
                toc_id_map[_bound_index(node.id, toc_id_map)] = node;
                items = spine_toc_map[_bound_index(node.dest, spine_toc_map)];
                if (items) {
                    items.push(node);
                }
                children = node.children;
                if (children) {
                    var _Iter0 = _Iterable(children);
                    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                        child = _Iter0[_Index0];
                        parent_map[_bound_index(child.id, parent_map)] = node;
                        process_node(child);
                    }
                }
            };
            if (!process_node.__argnames__) Object.defineProperties(process_node, {
                __argnames__ : {value: ["node"]},
                __module__ : {value: "read_book.search"}
            });

            toc = book.manifest.toc;
            if (toc) {
                process_node(toc);
            }
            return (function(){
                var _d = Object.create(null);
                _d["spine"] = spine;
                _d["spine_toc_map"] = spine_toc_map;
                _d["spine_idx_map"] = (function() {
                    var _Iter = _Iterable(enumerate(spine)), _Result = Object.create(null), idx, name;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        _unpack = _Iter[_Index];
                        idx = _unpack[0];
                        name = _unpack[1];
                        _Result[name] = (idx);
                    }
                    return _Result;
                })();
                _d["parent_map"] = parent_map;
                _d["toc_id_map"] = toc_id_map;
                return _d;
            }).call(this);
        };
        if (!get_toc_data.__argnames__) Object.defineProperties(get_toc_data, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.search"}
        });

        function SearchOverlay() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            SearchOverlay.prototype.__bind_methods__.call(this);
            SearchOverlay.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(SearchOverlay.prototype, "__bind_methods__", {value: function () {
            this.show_wait = SearchOverlay.prototype.show_wait.bind(this);
            this.show_results = SearchOverlay.prototype.show_results.bind(this);
            this.clear_results = SearchOverlay.prototype.clear_results.bind(this);
            this.do_initial_search = SearchOverlay.prototype.do_initial_search.bind(this);
            this.handle_initial_search_result = SearchOverlay.prototype.handle_initial_search_result.bind(this);
            this.queue_search = SearchOverlay.prototype.queue_search.bind(this);
            this.set_original_pos = SearchOverlay.prototype.set_original_pos.bind(this);
            this.return_to_original_position = SearchOverlay.prototype.return_to_original_position.bind(this);
            this.on_worker_message = SearchOverlay.prototype.on_worker_message.bind(this);
            this.no_result_received = SearchOverlay.prototype.no_result_received.bind(this);
            this.result_received = SearchOverlay.prototype.result_received.bind(this);
            this.make_result_current = SearchOverlay.prototype.make_result_current.bind(this);
            this.search_result_discovered = SearchOverlay.prototype.search_result_discovered.bind(this);
            this.search_result_not_found = SearchOverlay.prototype.search_result_not_found.bind(this);
            this.select_search_result_in_book = SearchOverlay.prototype.select_search_result_in_book.bind(this);
            this.result_clicked = SearchOverlay.prototype.result_clicked.bind(this);
            this.clear_caches = SearchOverlay.prototype.clear_caches.bind(this);
            this.next_match = SearchOverlay.prototype.next_match.bind(this);
            this.onkeyup = SearchOverlay.prototype.onkeyup.bind(this);
            this.onkeydown = SearchOverlay.prototype.onkeydown.bind(this);
            this.find_next = SearchOverlay.prototype.find_next.bind(this);
            this.set_text = SearchOverlay.prototype.set_text.bind(this);
            this.hide = SearchOverlay.prototype.hide.bind(this);
            this.show = SearchOverlay.prototype.show.bind(this);
            this.run_search = SearchOverlay.prototype.run_search.bind(this);
        }});
        Object.defineProperties(SearchOverlay.prototype,  {
            "current_query": {
                "enumerable": true, 
                "get": function current_query() {
                    var self = this;
                    var c;
                    c = self.container;
                    return (function(){
                        var _d = Object.create(null);
                        _d["mode"] = c.querySelector("select[name=mode]").value;
                        _d["case_sensitive"] = c.querySelector("input[name=case_sensitive]").checked;
                        _d["text"] = c.querySelector("input[type=search]").value;
                        return _d;
                    }).call(this);
                }, 
                "set": function current_query(q) {
                    var self = this;
                    var c;
                    c = self.container;
                    c.querySelector("select[name=mode]").value = q.mode || "contains";
                    c.querySelector("input[name=case_sensitive]").checked = bool(q.case_sensitive);
                    c.querySelector("input[type=search]").value = q.text || "";
                }
            }, 
            "bottom_container": {
                "enumerable": true, 
                "get": function bottom_container() {
                    var self = this;
                    return self.container.lastChild;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "results_container": {
                "enumerable": true, 
                "get": function results_container() {
                    var self = this;
                    return self.bottom_container.lastChild;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "worker": {
                "enumerable": true, 
                "get": function worker() {
                    var self = this;
                    if (!self._worker) {
                        self._worker = start_worker("read_book.search");
                        self._worker.onmessage = self.on_worker_message;
                        self.clear_caches();
                    }
                    return self._worker;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_result_container": {
                "enumerable": true, 
                "get": function current_result_container() {
                    var self = this;
                    return self.container.querySelector(".current");
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    return document.getElementById(self.CONTAINER_ID);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "is_visible": {
                "enumerable": true, 
                "get": function is_visible() {
                    var self = this;
                    return self.container.style.display !== "none";
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        SearchOverlay.prototype.__init__ = function __init__(view) {
            var self = this;
            var c, search_button, sd, mode, child;
            self.view = view;
            self.search_in_flight = (function(){
                var _d = Object.create(null);
                _d["id"] = null;
                _d["mode"] = "contains";
                _d["case_sensitive"] = false;
                return _d;
            }).call(this);
            self._worker = null;
            self.request_counter = 0;
            self.result_map = Object.create(null);
            c = self.container;
            c.style.backgroundColor = get_color("window-background");
            c.style.maxHeight = "100vh";
            c.style.minHeight = "100vh";
            c.style.flexDirection = "column";
            c.style.alignItems = "stretch";
            c.style.overflow = "hidden";
            c.style.userSelect = "none";
            c.addEventListener("keydown", self.onkeydown);
            c.addEventListener("keyup", self.onkeyup);
            self.result_handler = null;
            _interpolate_kwargs.call(this, create_top_bar, [c].concat([_desugar_kwargs({title: _("Search in book"), action: self.hide, icon: "close"})]));
            search_button = create_button(_("Search"), "search");
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_search_bar, [self.run_search, "search-in-book"].concat([_desugar_kwargs({button: search_button})])), E.div(""), search_button].concat([_desugar_kwargs({style: "display: flex; padding: 1rem; padding-bottom: 0.5rem; overflow: hidden"})])));
            c.lastChild.firstChild.style.flexGrow = "100";
            sd = get_session_data();
            mode = sd.get("book_search_mode");
            c.appendChild(_interpolate_kwargs.call(E, E.div, [E.label(_("Search type:") + "", _interpolate_kwargs.call(E, E.select, [_interpolate_kwargs.call(E, E.option, [_("Contains")].concat([_desugar_kwargs({value: "contains", selected: (mode === "contains" || typeof mode === "object" && _equals(mode, "contains"))})])), _interpolate_kwargs.call(E, E.option, [_("Whole words")].concat([_desugar_kwargs({value: "word", selected: (mode === "word" || typeof mode === "object" && _equals(mode, "word"))})])), _interpolate_kwargs.call(E, E.option, [_("Regex")].concat([_desugar_kwargs({value: "regex", selected: (mode === "regex" || typeof mode === "object" && _equals(mode, "regex"))})]))].concat([_desugar_kwargs({name: "mode", title: _("Type of search:\n\n                    Contains: Search for the entered text anywhere\n\n                    Whole words: Search for whole words that equal the entered text\n\n                    Regex: Interpret the entered text as a regular expression\n                    "), onchange: (function() {
                var _anonfunc = function (event) {
                    get_session_data().set("book_search_mode", event.target.value);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.search"}
                });
                return _anonfunc;
            })()})]))), E.div(""), _interpolate_kwargs.call(E, E.label, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: "case_sensitive", checked: bool(sd.get("book_search_case_sensitive"))})]), _("Case sensitive")].concat([_desugar_kwargs({onchange: (function() {
                var _anonfunc = function (event) {
                    get_session_data().set("book_search_case_sensitive", event.target.checked);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["event"]},
                    __module__ : {value: "read_book.search"}
                });
                return _anonfunc;
            })()})])), E.div(""), _interpolate_kwargs.call(this, create_button, [_("Return"), "chevron-left"].concat([_desugar_kwargs({action: self.return_to_original_position, tooltip: _("Go back to where you were before searching")})]))].concat([_desugar_kwargs({style: "display: flex; padding: 1rem; padding-top: 0.5rem; padding-bottom: 0; align-items: center; overflow: hidden"})])));
            c.appendChild(E.hr());
            c.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [E.div(create_spinner("4em", "4em")), _interpolate_kwargs.call(E, E.div, [_("Searching, please wait")].concat([_desugar_kwargs({style: "margin-top: 1ex"})]))].concat([_desugar_kwargs({style: "text-align: center"})])), E.div()].concat([_desugar_kwargs({style: "display: none; overflow: auto", tabindex: "0"})])));
            var _Iter1 = _Iterable(c.childNodes);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                child = _Iter1[_Index1];
                if (child !== c.lastChild) {
                    child.style.flexShrink = "0";
                }
            }
        };
        if (!SearchOverlay.prototype.__init__.__argnames__) Object.defineProperties(SearchOverlay.prototype.__init__, {
            __argnames__ : {value: ["view"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.__argnames__ = SearchOverlay.prototype.__init__.__argnames__;
        SearchOverlay.__handles_kwarg_interpolation__ = SearchOverlay.prototype.__init__.__handles_kwarg_interpolation__;
        SearchOverlay.prototype.show_wait = function show_wait() {
            var self = this;
            var c;
            c = self.bottom_container;
            c.style.display = "block";
            c.firstChild.style.display = "block";
            c.lastChild.style.display = "none";
        };
        if (!SearchOverlay.prototype.show_wait.__module__) Object.defineProperties(SearchOverlay.prototype.show_wait, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.show_results = function show_results() {
            var self = this;
            var c;
            c = self.bottom_container;
            c.style.display = "block";
            c.firstChild.style.display = "none";
            c.lastChild.style.display = "block";
            c.focus();
        };
        if (!SearchOverlay.prototype.show_results.__module__) Object.defineProperties(SearchOverlay.prototype.show_results, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.clear_results = function clear_results() {
            var self = this;
            clear(self.results_container);
            self.result_map = Object.create(null);
        };
        if (!SearchOverlay.prototype.clear_results.__module__) Object.defineProperties(SearchOverlay.prototype.clear_results, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.do_initial_search = function do_initial_search(text, query) {
            var self = this;
            var q;
            q = (function(){
                var _d = Object.create(null);
                _d["mode"] = "contains";
                _d["case_sensitive"] = true;
                _d["text"] = text;
                _d["only_first_match"] = true;
                return _d;
            }).call(this);
            self.request_counter += 1;
            self.initial_search_result_counter = 0;
            self.initial_search_human_readable_query = query;
            self.search_in_flight.id = self.request_counter;
            self.result_handler = self.handle_initial_search_result;
            self.worker.postMessage((function(){
                var _d = Object.create(null);
                _d["type"] = "search";
                _d["current_name"] = "";
                _d["id"] = self.request_counter;
                _d["query"] = q;
                return _d;
            }).call(this));
        };
        if (!SearchOverlay.prototype.do_initial_search.__argnames__) Object.defineProperties(SearchOverlay.prototype.do_initial_search, {
            __argnames__ : {value: ["text", "query"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.handle_initial_search_result = function handle_initial_search_result(msg) {
            var self = this;
            var _unpack, emsg, details;
            if (msg.type === "error") {
                _unpack = parse_error_msg(msg);
_unpack = _unpack_asarray(2, _unpack);
                emsg = _unpack[0];
                details = _unpack[1];
                error_dialog(_("Could not search"), emsg, details);
                self.result_handler = null;
                self.initial_search_result_counter = 0;
            } else if (msg.id === self.search_in_flight.id) {
                if (msg.type === "search_complete") {
                    self.search_in_flight.id = null;
                    self.result_handler = null;
                    if (self.initial_search_result_counter === 0) {
                        self.view.hide_loading();
                        window.alert(_("The full text search query {} was not found in the book, try a manual search.").format(self.initial_search_human_readable_query));
                    }
                    self.initial_search_result_counter = 0;
                } else if (msg.type === "search_result") {
                    self.initial_search_result_counter += 1;
                    if (self.initial_search_result_counter === 1) {
                        self.view.discover_search_result(msg.result);
                        self.view.hide_loading();
                    }
                }
            }
        };
        if (!SearchOverlay.prototype.handle_initial_search_result.__argnames__) Object.defineProperties(SearchOverlay.prototype.handle_initial_search_result, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.queue_search = function queue_search(query, book, current_name) {
            var self = this;
            self.request_counter += 1;
            self.original_position = self.view.currently_showing.bookpos;
            self.view.get_current_cfi("search-original-pos", self.set_original_pos);
            self.search_in_flight.id = self.request_counter;
            self.worker.postMessage((function(){
                var _d = Object.create(null);
                _d["type"] = "search";
                _d["current_name"] = current_name;
                _d["id"] = self.request_counter;
                _d["query"] = query;
                return _d;
            }).call(this));
            self.clear_results();
            self.show_wait();
        };
        if (!SearchOverlay.prototype.queue_search.__argnames__) Object.defineProperties(SearchOverlay.prototype.queue_search, {
            __argnames__ : {value: ["query", "book", "current_name"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.set_original_pos = function set_original_pos(request_id, data) {
            var self = this;
            self.original_position = data.cfi;
        };
        if (!SearchOverlay.prototype.set_original_pos.__argnames__) Object.defineProperties(SearchOverlay.prototype.set_original_pos, {
            __argnames__ : {value: ["request_id", "data"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.return_to_original_position = function return_to_original_position() {
            var self = this;
            if (self.original_position) {
                self.view.goto_cfi(self.original_position);
            }
            self.hide();
        };
        if (!SearchOverlay.prototype.return_to_original_position.__module__) Object.defineProperties(SearchOverlay.prototype.return_to_original_position, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.on_worker_message = function on_worker_message(evt) {
            var self = this;
            var msg, _unpack, emsg, details;
            msg = evt.data;
            if (self.result_handler) {
                return self.result_handler(msg);
            }
            if (msg.type === "error") {
                _unpack = parse_error_msg(msg);
_unpack = _unpack_asarray(2, _unpack);
                emsg = _unpack[0];
                details = _unpack[1];
                error_dialog(_("Could not search"), emsg, details);
            } else if (msg.id === self.search_in_flight.id) {
                if (msg.type === "search_complete") {
                    self.search_in_flight.id = null;
                    if (Object.keys(self.result_map).length === 0) {
                        self.no_result_received();
                    }
                } else if (msg.type === "search_result") {
                    self.result_received(msg.result);
                }
            }
        };
        if (!SearchOverlay.prototype.on_worker_message.__argnames__) Object.defineProperties(SearchOverlay.prototype.on_worker_message, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.no_result_received = function no_result_received() {
            var self = this;
            self.show_results();
            self.results_container.appendChild(_interpolate_kwargs.call(E, E.div, [_("No matching results found")].concat([_desugar_kwargs({style: "margin: 1rem"})])));
        };
        if (!SearchOverlay.prototype.no_result_received.__module__) Object.defineProperties(SearchOverlay.prototype.no_result_received, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.result_received = function result_received(result) {
            var self = this;
            var sr, toc_node_id, toc_node, c, group, appended, csi, child, ul, tt, lines, _unpack, i, node_id, rnum, entry;
            self.show_results();
            (_expr_temp = self.result_map)[_bound_index(result.result_num, _expr_temp)] = result;
            sr = Object.assign(Object.create(null), result);
            self.view.discover_search_result(sr);
            toc_node_id = (result.toc_nodes.length) ? result.toc_nodes[0] : -1;
            toc_node = (_expr_temp = self.toc_data.toc_id_map)[(typeof toc_node_id === "number" && toc_node_id < 0) ? _expr_temp.length + toc_node_id : toc_node_id];
            c = self.results_container;
            group = c.querySelector("[data-toc-node-id=\"" + _str.format("{}", toc_node_id) + "\"]");
            if (!group) {
                group = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, ["+"].concat([_desugar_kwargs({style: "display: none"})])), E.span((typeof toc_node !== "undefined" && toc_node !== null ? toc_node : Object.create(null)).title || _("Unknown"))].concat([_desugar_kwargs({title: _("Click to show/hide the results in this chapter"), onclick: (function() {
                    var _anonfunc = function (ev) {
                        ev.target.closest("[data-toc-node-id]").classList.toggle("collapsed");
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["ev"]},
                        __module__ : {value: "read_book.search"}
                    });
                    return _anonfunc;
                })()})])), E.ul()].concat([_desugar_kwargs({data_toc_node_id: toc_node_id + "", data_spine_index: result.spine_idx + ""})]));
                appended = false;
                var _Iter2 = _Iterable(c.querySelectorAll("[data-spine-index]"));
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    child = _Iter2[_Index2];
                    csi = parseInt(child.dataset.spineIndex);
                    if (csi > result.spine_idx) {
                        appended = true;
                        c.insertBefore(group, child);
                        break;
                    }
                }
                if (!appended) {
                    c.appendChild(group);
                }
            }
            ul = group.getElementsByTagName("ul")[0];
            tt = "";
            if (result.toc_nodes.length) {
                lines = [];
                var _Iter3 = _Iterable(enumerate(result.toc_nodes));
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    _unpack = _Iter3[_Index3];
                    i = _unpack[0];
                    node_id = _unpack[1];
                    lines.push("".repeat(i) + " " + (_exists.d((_expr_temp = self.toc_data.toc_id_map)[(typeof node_id === "number" && node_id < 0) ? _expr_temp.length + node_id : node_id]).title || _("Unknown")));
                }
                tt = ngettext("Table of Contents section:", "Table of Contents sections:", lines.length);
                tt += "\n" + lines.join("\n");
            }
            rnum = result.result_num;
            entry = _interpolate_kwargs.call(E, E.li, [_desugar_kwargs({title: tt, data_result_num: rnum + "", onclick: self.result_clicked.bind(null, rnum)})]);
            if (result.before) {
                entry.appendChild(E.span("" + result.before));
            }
            entry.appendChild(E.strong(result.text));
            if (result.after) {
                entry.appendChild(E.span(result.after + ""));
            }
            ul.appendChild(entry);
        };
        if (!SearchOverlay.prototype.result_received.__argnames__) Object.defineProperties(SearchOverlay.prototype.result_received, {
            __argnames__ : {value: ["result"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.make_result_current = function make_result_current(result_num) {
            var self = this;
            var q, li;
            q = result_num + "";
            var _Iter4 = _Iterable(self.container.querySelectorAll("[data-result-num]"));
            for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                li = _Iter4[_Index4];
                if (li.dataset.resultNum === q) {
                    li.classList.add("current");
                    li.scrollIntoView();
                } else {
                    li.classList.remove("current");
                }
            }
        };
        if (!SearchOverlay.prototype.make_result_current.__argnames__) Object.defineProperties(SearchOverlay.prototype.make_result_current, {
            __argnames__ : {value: ["result_num"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.search_result_discovered = function search_result_discovered(sr) {
            var self = this;
            self.make_result_current(sr.result_num);
        };
        if (!SearchOverlay.prototype.search_result_discovered.__argnames__) Object.defineProperties(SearchOverlay.prototype.search_result_discovered, {
            __argnames__ : {value: ["sr"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.search_result_not_found = function search_result_not_found(sr) {
            var self = this;
            if (sr.on_discovery) {
                return;
            }
            error_dialog(_("Search result not found"), _("This search result matches text that is hidden in the book and cannot be displayed"));
            self.show();
        };
        if (!SearchOverlay.prototype.search_result_not_found.__argnames__) Object.defineProperties(SearchOverlay.prototype.search_result_not_found, {
            __argnames__ : {value: ["sr"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.select_search_result_in_book = function select_search_result_in_book(result_num) {
            var self = this;
            var sr;
            sr = Object.assign(Object.create(null), (_expr_temp = self.result_map)[(typeof result_num === "number" && result_num < 0) ? _expr_temp.length + result_num : result_num]);
            sr.on_discovery = 0;
            self.view.show_search_result(sr);
        };
        if (!SearchOverlay.prototype.select_search_result_in_book.__argnames__) Object.defineProperties(SearchOverlay.prototype.select_search_result_in_book, {
            __argnames__ : {value: ["result_num"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.result_clicked = function result_clicked(rnum) {
            var self = this;
            self.make_result_current(rnum);
            self.select_search_result_in_book(rnum);
            self.hide();
        };
        if (!SearchOverlay.prototype.result_clicked.__argnames__) Object.defineProperties(SearchOverlay.prototype.result_clicked, {
            __argnames__ : {value: ["rnum"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.clear_caches = function clear_caches(book) {
            var self = this;
            var data;
            self.clear_results();
            self.bottom_container.style.display = "none";
            if (self._worker) {
                book = book || current_book();
                self.toc_data = get_toc_data(book);
                data = (function(){
                    var _d = Object.create(null);
                    _d["book_hash"] = book.book_hash;
                    _d["stored_files"] = book.stored_files;
                    _d["spine"] = book.manifest.spine;
                    _d["toc_data"] = self.toc_data;
                    return _d;
                }).call(this);
                self.worker.postMessage((function(){
                    var _d = Object.create(null);
                    _d["type"] = "clear_caches";
                    _d["book"] = data;
                    return _d;
                }).call(this));
            }
        };
        if (!SearchOverlay.prototype.clear_caches.__argnames__) Object.defineProperties(SearchOverlay.prototype.clear_caches, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.next_match = function next_match(delta) {
            var self = this;
            var num_of_results, c, rnum, cr;
            delta = delta || 1;
            num_of_results = Object.keys(self.result_map).length;
            c = self.current_result_container;
            if (c) {
                rnum = parseInt(c.dataset.resultNum) - 1;
                rnum = (rnum + delta + num_of_results) % num_of_results;
                rnum += 1;
            } else {
                rnum = 1;
            }
            self.make_result_current(rnum);
            self.results_container.focus();
            cr = self.current_result_container;
            if (cr) {
                self.select_search_result_in_book(cr.dataset.resultNum);
            }
        };
        if (!SearchOverlay.prototype.next_match.__argnames__) Object.defineProperties(SearchOverlay.prototype.next_match, {
            __argnames__ : {value: ["delta"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.onkeyup = function onkeyup(event) {
            var self = this;
            if (event.key === "Escape" || event.key === "Esc") {
                self.hide();
                [event.stopPropagation(), event.preventDefault()];
            }
        };
        if (!SearchOverlay.prototype.onkeyup.__argnames__) Object.defineProperties(SearchOverlay.prototype.onkeyup, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.onkeydown = function onkeydown(event) {
            var self = this;
            var sc_name;
            sc_name = shortcut_for_key_event(event, self.view.keyboard_shortcut_map);
            if (sc_name === "next_match") {
                self.next_match(1);
                [event.stopPropagation(), event.preventDefault()];
                return;
            }
            if (sc_name === "previous_match") {
                self.next_match(-1);
                [event.stopPropagation(), event.preventDefault()];
                return;
            }
        };
        if (!SearchOverlay.prototype.onkeydown.__argnames__) Object.defineProperties(SearchOverlay.prototype.onkeydown, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.find_next = function find_next(backwards) {
            var self = this;
            self.next_match((backwards) ? -1 : 1);
        };
        if (!SearchOverlay.prototype.find_next.__argnames__) Object.defineProperties(SearchOverlay.prototype.find_next, {
            __argnames__ : {value: ["backwards"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.set_text = function set_text(text) {
            var self = this;
            self.container.querySelector("input[type=search]").value = text || "";
        };
        if (!SearchOverlay.prototype.set_text.__argnames__) Object.defineProperties(SearchOverlay.prototype.set_text, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.hide = function hide() {
            var self = this;
            self.container.style.display = "none";
            ui_operations.focus_iframe();
        };
        if (!SearchOverlay.prototype.hide.__module__) Object.defineProperties(SearchOverlay.prototype.hide, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.show = function show() {
            var self = this;
            var c, inp;
            c = self.container;
            c.style.display = self.display_type;
            inp = c.querySelector("input");
            [inp.focus(), inp.select()];
        };
        if (!SearchOverlay.prototype.show.__module__) Object.defineProperties(SearchOverlay.prototype.show, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.run_search = function run_search() {
            var self = this;
            var q;
            q = self.current_query;
            if (!q.text) {
                self.clear_results();
                self.show_results();
            } else {
                self.queue_search(q, current_book(), self.view.currently_showing.name);
            }
        };
        if (!SearchOverlay.prototype.run_search.__module__) Object.defineProperties(SearchOverlay.prototype.run_search, {
            __module__ : {value: "read_book.search"}
        });
        SearchOverlay.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        SearchOverlay.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(SearchOverlay.prototype, "__bases__", {value: []});
        SearchOverlay.prototype.display_type = "flex";
        SearchOverlay.prototype.CONTAINER_ID = "book-search-overlay";
        
        
        
        
        
        
        
        

        add_extra_css((function() {
            var _anonfunc = function () {
                var css, sel;
                css = "";
                sel = "#" + _str.format("{}", SearchOverlay.prototype.CONTAINER_ID) + " ";
                sel += " div[data-toc-node-id]";
                css += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({margin: "1rem"})]));
                css += sel + ".collapsed > div > span { display: inline !important; }";
                css += _interpolate_kwargs.call(this, build_rule, [sel + ".collapsed > ul"].concat([_desugar_kwargs({display: "none"})]));
                css += _interpolate_kwargs.call(this, build_rule, [sel + " > div"].concat([_desugar_kwargs({font_style: "italic", font_weight: "bold", cursor: "pointer"})]));
                css += _interpolate_kwargs.call(this, build_rule, [sel + " li"].concat([_desugar_kwargs({list_style_type: "none", margin: "1rem", margin_right: "0", cursor: "pointer"})]));
                css += _interpolate_kwargs.call(this, build_rule, [sel + " li.current"].concat([_desugar_kwargs({border_left: "solid 2px " + get_color("link-foreground"), padding_left: "2px"})]));
                css += _interpolate_kwargs.call(this, build_rule, [sel + " li strong"].concat([_desugar_kwargs({color: get_color("link-foreground"), font_style: "italic"})]));
                return css;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.search"}
            });
            return _anonfunc;
        })());
        main = worker_main;
        _modules["read_book.search"].main = main;
        _modules["read_book.search"].parse_error_msg = parse_error_msg;
        _modules["read_book.search"].get_toc_data = get_toc_data;
        _modules["read_book.search"].SearchOverlay = SearchOverlay;
    })();

    (function(){
        var __name__ = "read_book.timers";
        var THRESHOLD, FILTER_THRESHOLD, MAX_SAMPLES;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        THRESHOLD = 5;
        FILTER_THRESHOLD = 25;
        MAX_SAMPLES = 256;
        function Timers() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Timers.prototype.__bind_methods__.call(this);
            Timers.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Timers.prototype, "__bind_methods__", {value: function () {
            this.start_book = Timers.prototype.start_book.bind(this);
            this.reset_read_timer = Timers.prototype.reset_read_timer.bind(this);
            this.calculate = Timers.prototype.calculate.bind(this);
            this.on_human_scroll = Timers.prototype.on_human_scroll.bind(this);
            this.time_for = Timers.prototype.time_for.bind(this);
        }});
        Timers.prototype.__init__ = function __init__() {
            var self = this;
            self.reset_read_timer();
            self.rates = [];
            self.average = self.stddev = 0;
        };
        if (!Timers.prototype.__init__.__module__) Object.defineProperties(Timers.prototype.__init__, {
            __module__ : {value: "read_book.timers"}
        });
        Timers.__argnames__ = Timers.prototype.__init__.__argnames__;
        Timers.__handles_kwarg_interpolation__ = Timers.prototype.__init__.__handles_kwarg_interpolation__;
        Timers.prototype.start_book = function start_book(book) {
            var self = this;
            self.reset_read_timer();
            self.rates = [];
            if (_exists.d((typeof book !== "undefined" && book !== null ? book : Object.create(null)).saved_reading_rates).rates) {
                self.rates = book.saved_reading_rates.rates.slice(0);
                self.calculate();
            }
        };
        if (!Timers.prototype.start_book.__argnames__) Object.defineProperties(Timers.prototype.start_book, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.timers"}
        });
        Timers.prototype.reset_read_timer = function reset_read_timer() {
            var self = this;
            self.last_scroll_at = null;
        };
        if (!Timers.prototype.reset_read_timer.__module__) Object.defineProperties(Timers.prototype.reset_read_timer, {
            __module__ : {value: "read_book.timers"}
        });
        Timers.prototype.calculate = function calculate() {
            var self = this;
            var rates, rlen, avg, sq, x;
            rates = self.rates;
            rlen = rates.length;
            if (rlen >= THRESHOLD) {
                avg = 0;
                for (var i = 0; i < rlen; i++) {
                    avg += rates[(typeof i === "number" && i < 0) ? rates.length + i : i];
                }
                avg /= rlen;
                self.average = avg;
                sq = 0;
                for (var i = 0; i < rlen; i++) {
                    x = rates[(typeof i === "number" && i < 0) ? rates.length + i : i] - avg;
                    sq += x * x;
                }
                self.stddev = Math.sqrt(sq / (rlen - 1));
            } else {
                self.average = self.stddev = 0;
            }
        };
        if (!Timers.prototype.calculate.__module__) Object.defineProperties(Timers.prototype.calculate, {
            __module__ : {value: "read_book.timers"}
        });
        Timers.prototype.on_human_scroll = function on_human_scroll(amt_scrolled) {
            var self = this;
            var last_scroll_at, now, time_since_last_scroll, rate;
            last_scroll_at = self.last_scroll_at;
            self.last_scroll_at = now = window.performance.now();
            if (last_scroll_at === null) {
                return;
            }
            time_since_last_scroll = (now - last_scroll_at) / 1e3;
            if (time_since_last_scroll <= 0 || time_since_last_scroll >= 300) {
                return;
            }
            if (time_since_last_scroll < 2) {
                return;
            }
            rate = amt_scrolled / time_since_last_scroll;
            if (self.rates.length >= FILTER_THRESHOLD && Math.abs(rate - self.average) > 2 * self.stddev) {
                return;
            }
            if (self.rates.length >= MAX_SAMPLES) {
                self.rates.shift();
            }
            self.rates.push(rate);
            self.calculate();
            if (ui_operations.update_reading_rates) {
                ui_operations.update_reading_rates((function(){
                    var _d = Object.create(null);
                    _d["rates"] = self.rates.slice(0);
                    return _d;
                }).call(this));
            }
        };
        if (!Timers.prototype.on_human_scroll.__argnames__) Object.defineProperties(Timers.prototype.on_human_scroll, {
            __argnames__ : {value: ["amt_scrolled"]},
            __module__ : {value: "read_book.timers"}
        });
        Timers.prototype.time_for = function time_for(length) {
            var self = this;
            if (length >= 0 && self.rates.length >= THRESHOLD && self.average > 0) {
                return length / self.average;
            }
            return null;
        };
        if (!Timers.prototype.time_for.__argnames__) Object.defineProperties(Timers.prototype.time_for, {
            __argnames__ : {value: ["length"]},
            __module__ : {value: "read_book.timers"}
        });
        Timers.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Timers.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Timers.prototype, "__bases__", {value: []});

        _modules["read_book.timers"].THRESHOLD = THRESHOLD;
        _modules["read_book.timers"].FILTER_THRESHOLD = FILTER_THRESHOLD;
        _modules["read_book.timers"].MAX_SAMPLES = MAX_SAMPLES;
        _modules["read_book.timers"].Timers = Timers;
    })();

    (function(){
        var __name__ = "read_book.view";
        var E = _modules.elementmaker.E;

        var read_book = _modules.read_book;
        read_book.iframe = _modules["read_book.iframe"];

        var ajax_send = _modules.ajax.ajax_send;

        var get_session_data = _modules["book_list.globals"].get_session_data;

        var update_book_in_recently_read_by_user_on_home_page = _modules["book_list.home"].update_book_in_recently_read_by_user_on_home_page;

        var cached_color_to_rgba = _modules["book_list.theme"].cached_color_to_rgba;
        var get_color = _modules["book_list.theme"].get_color;
        var set_ui_colors = _modules["book_list.theme"].set_ui_colors;

        var show_panel = _modules["book_list.ui"].show_panel;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var create_wrapped_iframe = _modules.iframe_comm.create_wrapped_iframe;

        var error_dialog = _modules.modals.error_dialog;
        var warning_dialog = _modules.modals.warning_dialog;

        var AnnotationsManager = _modules["read_book.annotations"].AnnotationsManager;

        var create_new_bookmark = _modules["read_book.bookmarks"].create_new_bookmark;

        var ContentPopupOverlay = _modules["read_book.content_popup"].ContentPopupOverlay;

        var current_book = _modules["read_book.globals"].current_book;
        var current_spine_item = _modules["read_book.globals"].current_spine_item;
        var is_dark_theme = _modules["read_book.globals"].is_dark_theme;
        var rtl_page_progression = _modules["read_book.globals"].rtl_page_progression;
        var runtime = _modules["read_book.globals"].runtime;
        var set_current_spine_item = _modules["read_book.globals"].set_current_spine_item;
        var ui_operations = _modules["read_book.globals"].ui_operations;

        var get_next_section = _modules["read_book.goto"].get_next_section;

        var get_current_link_prefix = _modules["read_book.highlights"].get_current_link_prefix;
        var link_to_epubcfi = _modules["read_book.highlights"].link_to_epubcfi;

        var Hints = _modules["read_book.hints"].Hints;

        var add_book_to_recently_viewed = _modules["read_book.open_book"].add_book_to_recently_viewed;

        var Overlay = _modules["read_book.overlay"].Overlay;

        var resolve_color_scheme = _modules["read_book.prefs.colors"].resolve_color_scheme;

        var change_font_size_by = _modules["read_book.prefs.font_size"].change_font_size_by;
        var restore_default_font_size = _modules["read_book.prefs.font_size"].restore_default_font_size;

        var current_zoom_step_size = _modules["read_book.prefs.fonts"].current_zoom_step_size;

        var render_head_foot = _modules["read_book.prefs.head_foot"].render_head_foot;

        var SCROLL_SPEED_STEP = _modules["read_book.prefs.scrolling"].MIN_SCROLL_SPEED_AUTO;
        var change_scroll_speed = _modules["read_book.prefs.scrolling"].change_scroll_speed;

        var modify_background_image_url_for_fetch = _modules["read_book.prefs.user_stylesheet"].modify_background_image_url_for_fetch;

        var ReadAloud = _modules["read_book.read_aloud"].ReadAloud;

        var ReadAudioEbook = _modules["read_book.read_audio_ebook"].ReadAudioEbook;

        var load_resources = _modules["read_book.resources"].load_resources;

        var BookScrollbar = _modules["read_book.scrollbar"].BookScrollbar;

        var SearchOverlay = _modules["read_book.search"].SearchOverlay;

        var SelectionBar = _modules["read_book.selection_bar"].SelectionBar;

        var create_shortcut_map = _modules["read_book.shortcuts"].create_shortcut_map;

        var get_smil_audio_map = _modules["read_book.smil"].get_smil_audio_map;

        var Timers = _modules["read_book.timers"].Timers;

        var get_current_toc_nodes = _modules["read_book.toc"].get_current_toc_nodes;
        var update_visible_toc_nodes = _modules["read_book.toc"].update_visible_toc_nodes;

        var set_left_margin_handler = _modules["read_book.touch"].set_left_margin_handler;
        var set_right_margin_handler = _modules["read_book.touch"].set_right_margin_handler;

        var get_device_uuid = _modules.session.get_device_uuid;
        var get_interface_data = _modules.session.get_interface_data;

        var default_context_menu_should_be_allowed = _modules.utils.default_context_menu_should_be_allowed;
        var html_escape = _modules.utils.html_escape;
        var parse_url_params = _modules.utils.parse_url_params;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var username_key = _modules.utils.username_key;

        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, ans;
                sel = ".book-side-margin";
                ans = _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({cursor: "pointer", text_align: "center", height: "100dvh", user_select: "none", display: "flex", align_items: "center", justify_content: "space-between", flex_direction: "column"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + " > .arrow"].concat([_desugar_kwargs({display: "none"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + " > *"].concat([_desugar_kwargs({max_width: "100%", overflow: "hidden"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ":hover > .not-arrow"].concat([_desugar_kwargs({display: "none"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ":active > .not-arrow"].concat([_desugar_kwargs({display: "none"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ":hover > .arrow"].concat([_desugar_kwargs({display: "block"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [sel + ":active > .arrow"].concat([_desugar_kwargs({display: "block", transform: "scale(2)"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [".book-h-margin .visible-on-hover"].concat([_desugar_kwargs({visibility: "hidden"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [".book-h-margin:hover .visible-on-hover"].concat([_desugar_kwargs({visibility: "visible"})]));
                ans += _interpolate_kwargs.call(this, build_rule, [".book-h-margin .visible-on-hover:hover"].concat([_desugar_kwargs({color: get_color("window-hover-foreground")})]));
                return ans;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "read_book.view"}
            });
            return _anonfunc;
        })());
        function show_controls_help() {
            var container, div, left_msg, left_width, right_msg, right_width, left_grow, right_grow, _unpack;
            container = document.getElementById("controls-help-overlay");
            container.style.display = "block";
            container.style.backgroundColor = get_color("window-background");
            if (!show_controls_help.listener_added) {
                show_controls_help.listener_added = true;
                container.addEventListener("click", (function() {
                    var _anonfunc = function () {
                        document.getElementById("controls-help-overlay").style.display = "none";
                        ui_operations.focus_iframe();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })());
                container.addEventListener("contextmenu", (function() {
                    var _anonfunc = function (evt) {
                        [evt.preventDefault(), evt.stopPropagation()];
                        document.getElementById("controls-help-overlay").style.display = "none";
                        ui_operations.focus_iframe();
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["evt"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })(), (function(){
                    var _d = Object.create(null);
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                container.addEventListener("keydown", (function() {
                    var _anonfunc = function (event) {
                        [event.preventDefault(), event.stopPropagation()];
                        document.getElementById("controls-help-overlay").style.display = "none";
                        ui_operations.focus_iframe();
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["event"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })(), (function(){
                    var _d = Object.create(null);
                    _d["passive"] = false;
                    return _d;
                }).call(this));
            }
            function focus() {
                if (container.style.display === "block") {
                    container.querySelector("input").focus();
                    window.setTimeout(focus, 10);
                }
            };
            if (!focus.__module__) Object.defineProperties(focus, {
                __module__ : {value: "read_book.view"}
            });

            if (runtime.is_standalone_viewer) {
                clear(container);
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 1rem"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 1rem"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 1rem"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 1rem"})]), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({style: "background: transparent; border-width: 0; outline: none", readonly: "readonly"})])].concat([_desugar_kwargs({style: "margin: 1rem"})])));
                div = container.lastChild.firstChild;
                safe_set_inner_html(div, _("Welcome to the <b>calibre E-book viewer</b>!"));
                div = div.nextSibling;
                safe_set_inner_html(div, _("Use the <b>PageUp/PageDn</b> or <b>Arrow keys</b> to turn pages"));
                div = div.nextSibling;
                safe_set_inner_html(div, _("Press the <b>Esc</b> key or <b>{}</b> or <b>tap on the top third</b> of the text area to show the viewer controls").format((_in("macos", window.navigator.userAgent)) ? _("control+click") : _("right click")));
                div = div.nextSibling;
                safe_set_inner_html(div, _("Press any key to continue"));
                focus();
                return;
            }
            function msg(txt) {
                return _interpolate_kwargs.call(this, set_css, [E.div(txt)].concat([_desugar_kwargs({padding: "1ex 1em", text_align: "center", margin: "auto"})]));
            };
            if (!msg.__argnames__) Object.defineProperties(msg, {
                __argnames__ : {value: ["txt"]},
                __module__ : {value: "read_book.view"}
            });

            left_msg = msg(_("Tap to turn back"));
            left_width = "min(25vw, 1in)";
            right_msg = msg(_("Tap to turn page"));
            right_width = "auto";
            left_grow = 0;
            right_grow = 1;
            if (rtl_page_progression()) {
                _unpack = [right_msg, left_msg];
                left_msg = _unpack[0];
                right_msg = _unpack[1];
                _unpack = [right_width, left_width];
                left_width = _unpack[0];
                right_width = _unpack[1];
                _unpack = [right_grow, left_grow];
                left_grow = _unpack[0];
                right_grow = _unpack[1];
            }
            if (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [msg(_("Tap (or right click) for controls"))].concat([_desugar_kwargs({style: "height: 25dvh; display:flex; align-items: center; border-bottom: solid 2px currentColor"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [left_msg].concat([_desugar_kwargs({style: "width: " + _str.format("{}", left_width) + "; flex-grow: " + _str.format("{}", left_grow) + "; display:flex; align-items: center; border-right: solid 2px currentColor"})])), _interpolate_kwargs.call(E, E.div, [right_msg].concat([_desugar_kwargs({style: "width: " + _str.format("{}", right_width) + "; display:flex; flex-grow: " + _str.format("{}", right_grow) + "; align-items: center"})]))].concat([_desugar_kwargs({style: "display: flex; align-items: stretch; flex-grow: 10"})]))].concat([_desugar_kwargs({style: "overflow: hidden; width: 100vw; height: 100dvh; text-align: center; font-size: 1.3rem; font-weight: bold; background: " + _str.format("{}", get_color("window-background")) + ";" + "display:flex; flex-direction: column; align-items: stretch"})])));
        };
        if (!show_controls_help.__module__) Object.defineProperties(show_controls_help, {
            __module__ : {value: "read_book.view"}
        });

        function body_font_size() {
            var ans, q;
            ans = body_font_size.ans;
            if (!ans) {
                q = window.getComputedStyle(document.body).fontSize;
                if (q && q.endsWith("px")) {
                    q = parseInt(q);
                    if (q && !isNaN(q)) {
                        ans = body_font_size.ans = q;
                        return ans;
                    }
                }
                ans = body_font_size.ans = 12;
            }
            return ans;
        };
        if (!body_font_size.__module__) Object.defineProperties(body_font_size, {
            __module__ : {value: "read_book.view"}
        });

        function header_footer_font_size(sz) {
            return min(max(0, sz - 6), body_font_size());
        };
        if (!header_footer_font_size.__argnames__) Object.defineProperties(header_footer_font_size, {
            __argnames__ : {value: ["sz"]},
            __module__ : {value: "read_book.view"}
        });

        function margin_elem(sd, which, id, onclick, oncontextmenu) {
            var sz, fsz, s, ans;
            sz = sd.get(which, 20);
            fsz = header_footer_font_size(sz);
            s = "; text-overflow: ellipsis; white-space: nowrap; overflow: hidden";
            ans = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-right: 1.5em" + s})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: s})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-left: 1.5em" + s})])].concat([_desugar_kwargs({style: "height:" + _str.format("{}", sz) + "px; overflow: hidden; font-size:" + _str.format("{}", fsz) + "px; width:100%; padding: 0; display: flex; justify-content: space-between; align-items: center; user-select: none; cursor: pointer", class_: "book-h-margin", id: id})]));
            if (onclick) {
                ans.addEventListener("click", onclick);
            }
            if (oncontextmenu) {
                ans.addEventListener("contextmenu", oncontextmenu);
            }
            return ans;
        };
        if (!margin_elem.__argnames__) Object.defineProperties(margin_elem, {
            __argnames__ : {value: ["sd", "which", "id", "onclick", "oncontextmenu"]},
            __module__ : {value: "read_book.view"}
        });

        function side_margin_elem(self, sd, which, icon) {
            var ans;
            ans = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [svgicon("caret-" + _str.format("{}", icon) + "", "100%", "100%")].concat([_desugar_kwargs({class_: "arrow", style: "order: 3"})])), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "order:1"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "order:2", class_: "not-arrow"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "order:4"})])].concat([_desugar_kwargs({style: "width:{}px; user-select: none".format(sd.get("margin_" + _str.format("{}", which) + "", 20)), class_: "book-side-margin", id: "book-" + _str.format("{}", which) + "-margin", onclick: self.side_margin_clicked.bind(null, which), oncontextmenu: self.margin_context_menu.bind(null, which), onwheel: self.on_margin_wheel.bind(null, which)})]));
            return ans;
        };
        if (!side_margin_elem.__argnames__) Object.defineProperties(side_margin_elem, {
            __argnames__ : {value: ["self", "sd", "which", "icon"]},
            __module__ : {value: "read_book.view"}
        });

        function View() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            View.prototype.__bind_methods__.call(this);
            View.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(View.prototype, "__bind_methods__", {value: function () {
            this.copy_to_clipboard = View.prototype.copy_to_clipboard.bind(this);
            this.show_not_a_library_book_error = View.prototype.show_not_a_library_book_error.bind(this);
            this.copy_current_location_to_clipboard = View.prototype.copy_current_location_to_clipboard.bind(this);
            this.set_scrollbar_visibility = View.prototype.set_scrollbar_visibility.bind(this);
            this.toggle_scrollbar = View.prototype.toggle_scrollbar.bind(this);
            this.on_annotations_message = View.prototype.on_annotations_message.bind(this);
            this.on_tts_message = View.prototype.on_tts_message.bind(this);
            this.on_audio_ebook_message = View.prototype.on_audio_ebook_message.bind(this);
            this.on_hints_message = View.prototype.on_hints_message.bind(this);
            this.side_margin_clicked = View.prototype.side_margin_clicked.bind(this);
            this.top_margin_clicked = View.prototype.top_margin_clicked.bind(this);
            this.bottom_margin_clicked = View.prototype.bottom_margin_clicked.bind(this);
            this.margin_context_menu = View.prototype.margin_context_menu.bind(this);
            this.on_margin_wheel = View.prototype.on_margin_wheel.bind(this);
            this.send_wheel_event_to_iframe = View.prototype.send_wheel_event_to_iframe.bind(this);
            this.forward_gesture = View.prototype.forward_gesture.bind(this);
            this.iframe_size = View.prototype.iframe_size.bind(this);
            this.on_request_size = View.prototype.on_request_size.bind(this);
            this.on_print = View.prototype.on_print.bind(this);
            this.on_human_scroll = View.prototype.on_human_scroll.bind(this);
            this.on_handle_keypress = View.prototype.on_handle_keypress.bind(this);
            this.handle_keypress = View.prototype.handle_keypress.bind(this);
            this.overlay_visibility_changed = View.prototype.overlay_visibility_changed.bind(this);
            this.on_handle_shortcut = View.prototype.on_handle_shortcut.bind(this);
            this.on_selection_change = View.prototype.on_selection_change.bind(this);
            this.new_bookmark = View.prototype.new_bookmark.bind(this);
            this.update_selection_position = View.prototype.update_selection_position.bind(this);
            this.on_columns_per_screen_changed = View.prototype.on_columns_per_screen_changed.bind(this);
            this.switch_color_scheme = View.prototype.switch_color_scheme.bind(this);
            this.toggle_paged_mode = View.prototype.toggle_paged_mode.bind(this);
            this.toggle_autoscroll = View.prototype.toggle_autoscroll.bind(this);
            this.toggle_toolbar = View.prototype.toggle_toolbar.bind(this);
            this.on_invisible_text = View.prototype.on_invisible_text.bind(this);
            this.bump_font_size = View.prototype.bump_font_size.bind(this);
            this.on_show_footnote = View.prototype.on_show_footnote.bind(this);
            this.hide_overlays = View.prototype.hide_overlays.bind(this);
            this.focus_iframe = View.prototype.focus_iframe.bind(this);
            this.start_read_aloud = View.prototype.start_read_aloud.bind(this);
            this.toggle_read_aloud = View.prototype.toggle_read_aloud.bind(this);
            this.toggle_hints = View.prototype.toggle_hints.bind(this);
            this.show_chrome = View.prototype.show_chrome.bind(this);
            this.show_chrome_force = View.prototype.show_chrome_force.bind(this);
            this.do_show_chrome = View.prototype.do_show_chrome.bind(this);
            this.prepare_for_close = View.prototype.prepare_for_close.bind(this);
            this.show_search = View.prototype.show_search.bind(this);
            this.show_content_popup = View.prototype.show_content_popup.bind(this);
            this.set_margins = View.prototype.set_margins.bind(this);
            this.on_iframe_ready = View.prototype.on_iframe_ready.bind(this);
            this.do_pending_load = View.prototype.do_pending_load.bind(this);
            this.on_iframe_error = View.prototype.on_iframe_error.bind(this);
            this.apply_color_scheme = View.prototype.apply_color_scheme.bind(this);
            this.on_resize = View.prototype.on_resize.bind(this);
            this.show_loading_message = View.prototype.show_loading_message.bind(this);
            this.show_loading = View.prototype.show_loading.bind(this);
            this.hide_loading = View.prototype.hide_loading.bind(this);
            this.parse_cfi = View.prototype.parse_cfi.bind(this);
            this.open_book_page = View.prototype.open_book_page.bind(this);
            this.clear_book_resource_caches = View.prototype.clear_book_resource_caches.bind(this);
            this.reload_book = View.prototype.reload_book.bind(this);
            this.display_book = View.prototype.display_book.bind(this);
            this.preferences_changed = View.prototype.preferences_changed.bind(this);
            this.redisplay_book = View.prototype.redisplay_book.bind(this);
            this.iframe_settings = View.prototype.iframe_settings.bind(this);
            this.show_name = View.prototype.show_name.bind(this);
            this.load_doc = View.prototype.load_doc.bind(this);
            this.goto_doc_boundary = View.prototype.goto_doc_boundary.bind(this);
            this.goto_frac = View.prototype.goto_frac.bind(this);
            this.goto_book_position = View.prototype.goto_book_position.bind(this);
            this.on_scroll_to_anchor = View.prototype.on_scroll_to_anchor.bind(this);
            this.link_in_content_popup_activated = View.prototype.link_in_content_popup_activated.bind(this);
            this.goto_cfi = View.prototype.goto_cfi.bind(this);
            this.goto_reference = View.prototype.goto_reference.bind(this);
            this.goto_named_destination = View.prototype.goto_named_destination.bind(this);
            this.goto_toc_node = View.prototype.goto_toc_node.bind(this);
            this.sync_data_received = View.prototype.sync_data_received.bind(this);
            this.set_notes_for_highlight = View.prototype.set_notes_for_highlight.bind(this);
            this.show_next_spine_item = View.prototype.show_next_spine_item.bind(this);
            this.on_next_spine_item = View.prototype.on_next_spine_item.bind(this);
            this.on_next_section = View.prototype.on_next_section.bind(this);
            this.get_current_cfi = View.prototype.get_current_cfi.bind(this);
            this.update_cfi_data = View.prototype.update_cfi_data.bind(this);
            this.on_report_cfi = View.prototype.on_report_cfi.bind(this);
            this.on_update_progress_frac = View.prototype.on_update_progress_frac.bind(this);
            this.on_update_cfi = View.prototype.on_update_cfi.bind(this);
            this.show_status_message = View.prototype.show_status_message.bind(this);
            this.create_template_renderer = View.prototype.create_template_renderer.bind(this);
            this.update_header_footer = View.prototype.update_header_footer.bind(this);
            this.on_update_toc_position = View.prototype.on_update_toc_position.bind(this);
            this.show_spine_item = View.prototype.show_spine_item.bind(this);
            this.show_spine_item_stage2 = View.prototype.show_spine_item_stage2.bind(this);
            this.on_content_loaded = View.prototype.on_content_loaded.bind(this);
            this.set_progress_frac = View.prototype.set_progress_frac.bind(this);
            this.update_font_size = View.prototype.update_font_size.bind(this);
            this.viewer_font_size_changed = View.prototype.viewer_font_size_changed.bind(this);
            this.update_scroll_speed = View.prototype.update_scroll_speed.bind(this);
            this.update_color_scheme = View.prototype.update_color_scheme.bind(this);
            this.toggle_reference_mode = View.prototype.toggle_reference_mode.bind(this);
            this.discover_search_result = View.prototype.discover_search_result.bind(this);
            this.handle_search_result_discovery = View.prototype.handle_search_result_discovery.bind(this);
            this.search_result_discovered = View.prototype.search_result_discovered.bind(this);
            this.search_result_not_found = View.prototype.search_result_not_found.bind(this);
            this.show_search_result = View.prototype.show_search_result.bind(this);
            this.highlight_action = View.prototype.highlight_action.bind(this);
        }});
        Object.defineProperties(View.prototype,  {
            "iframe": {
                "enumerable": true, 
                "get": function iframe() {
                    var self = this;
                    return self.iframe_wrapper.iframe;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "overlay_prevents_navigation": {
                "enumerable": true, 
                "get": function overlay_prevents_navigation() {
                    var self = this;
                    var x;
                    var _Iter0 = _Iterable(self.modal_overlays);
                    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                        x = _Iter0[_Index0];
                        if (x.is_visible && x.prevent_navigation) {
                            return true;
                        }
                    }
                    return false;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "current_position_data": {
                "enumerable": true, 
                "get": function current_position_data() {
                    var self = this;
                    var book_length, name, chapter_length, pos;
                    if (_exists.d(self.book).manifest) {
                        book_length = self.book.manifest.spine_length || 0;
                        name = self.currently_showing.name;
                        chapter_length = _exists.d((_expr_temp = self.book.manifest.files)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]).length || 0;
                    } else {
                        book_length = chapter_length = 0;
                    }
                    pos = (function(){
                        var _d = Object.create(null);
                        _d["progress_frac"] = self.current_progress_frac;
                        _d["book_length"] = book_length;
                        _d["chapter_length"] = chapter_length;
                        _d["file_progress_frac"] = self.current_file_progress_frac;
                        _d["cfi"] = _exists.d(self.currently_showing).bookpos;
                        _d["page_counts"] = self.current_page_counts;
                        return _d;
                    }).call(this);
                    return pos;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        View.prototype.__init__ = function __init__(container) {
            var self = this;
            var sd, left_margin, right_margin, handlers, iframe_id, entry_point, iframe_kw, _unpack, iframe;
            self.timers = new Timers;
            self.reference_mode_enabled = false;
            self.loaded_resources = Object.create(null);
            self.current_progress_frac = self.current_file_progress_frac = 0;
            self.current_page_counts = (function(){
                var _d = Object.create(null);
                _d["current"] = 0;
                _d["total"] = 0;
                _d["pages_per_screen"] = 1;
                return _d;
            }).call(this);
            self.current_status_message = "";
            self.current_toc_node = self.current_toc_toplevel_node = null;
            self.current_toc_families = [];
            self.report_cfi_callbacks = Object.create(null);
            self.get_cfi_counter = 0;
            self.show_loading_callback_timer = null;
            self.timer_ids = (function(){
                var _d = Object.create(null);
                _d["clock"] = 0;
                return _d;
            }).call(this);
            self.book_scrollbar = new BookScrollbar(self);
            sd = get_session_data();
            self.keyboard_shortcut_map = create_shortcut_map(sd.get("keyboard_shortcuts"));
            if (ui_operations.export_shortcut_map) {
                ui_operations.export_shortcut_map(self.keyboard_shortcut_map);
            }
            left_margin = side_margin_elem(self, sd, "left", (sd.get("reverse_page_turn_zones")) ? "right" : "left");
            set_left_margin_handler(left_margin);
            right_margin = side_margin_elem(self, sd, "right", (sd.get("reverse_page_turn_zones")) ? "left" : "right");
            set_right_margin_handler(right_margin);
            handlers = (function(){
                var _d = Object.create(null);
                _d["autoscroll_state_changed"] = (function() {
                    var _anonfunc = function (data) {
                        self.autoscroll_active = !!data.running;
                        if (ui_operations.autoscroll_state_changed) {
                            ui_operations.autoscroll_state_changed(self.autoscroll_active);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["data"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })();
                _d["bump_font_size"] = self.bump_font_size;
                _d["content_loaded"] = self.on_content_loaded;
                _d["error"] = self.on_iframe_error;
                _d["invisible_text"] = self.on_invisible_text;
                _d["goto_doc_boundary"] = (function() {
                    var _anonfunc = function (data) {
                        self.goto_doc_boundary(data.start);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["data"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })();
                _d["handle_keypress"] = self.on_handle_keypress;
                _d["handle_shortcut"] = self.on_handle_shortcut;
                _d["human_scroll"] = self.on_human_scroll;
                _d["next_section"] = self.on_next_section;
                _d["next_spine_item"] = self.on_next_spine_item;
                _d["print"] = self.on_print;
                _d["ready"] = self.on_iframe_ready;
                _d["report_cfi"] = self.on_report_cfi;
                _d["request_size"] = self.on_request_size;
                _d["scroll_to_anchor"] = self.on_scroll_to_anchor;
                _d["selectionchange"] = self.on_selection_change;
                _d["update_selection_position"] = self.update_selection_position;
                _d["columns_per_screen_changed"] = self.on_columns_per_screen_changed;
                _d["show_chrome"] = self.show_chrome;
                _d["show_footnote"] = self.on_show_footnote;
                _d["update_cfi"] = self.on_update_cfi;
                _d["update_progress_frac"] = self.on_update_progress_frac;
                _d["update_toc_position"] = self.on_update_toc_position;
                _d["search_result_not_found"] = self.search_result_not_found;
                _d["search_result_discovered"] = self.search_result_discovered;
                _d["annotations"] = self.on_annotations_message;
                _d["tts"] = self.on_tts_message;
                _d["audio_ebook_message"] = self.on_audio_ebook_message;
                _d["hints"] = self.on_hints_message;
                _d["copy_text_to_clipboard"] = (function() {
                    var _anonfunc = function (data) {
                        ui_operations.copy_selection(data.text, data.html);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["data"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })();
                _d["view_image"] = (function() {
                    var _anonfunc = function (data) {
                        if (ui_operations.view_image) {
                            ui_operations.view_image(data.calibre_src);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["data"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
            iframe_id = unique_id("read-book-iframe");
            if (runtime.is_standalone_viewer) {
                entry_point = "" + _str.format("{}", runtime.FAKE_PROTOCOL) + "://" + _str.format("{}", runtime.SANDBOX_HOST) + "/book/__index__";
            } else {
                entry_point = "read_book.iframe";
            }
            iframe_kw = (function(){
                var _d = Object.create(null);
                _d["id"] = iframe_id;
                _d["seamless"] = true;
                _d["sandbox"] = "allow-popups allow-scripts allow-popups-to-escape-sandbox";
                _d["style"] = "flex-grow: 2";
                _d["allowfullscreen"] = "true";
                return _d;
            }).call(this);
            _unpack = create_wrapped_iframe(handlers, _("Bootstrapping book reader..."), entry_point, iframe_kw);
_unpack = _unpack_asarray(2, _unpack);
            iframe = _unpack[0];
            self.iframe_wrapper = _unpack[1];
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [left_margin, _interpolate_kwargs.call(E, E.div, [margin_elem(sd, "margin_top", "book-top-margin", self.top_margin_clicked, self.margin_context_menu.bind(null, "top")), iframe, margin_elem(sd, "margin_bottom", "book-bottom-margin", self.bottom_margin_clicked, self.margin_context_menu.bind(null, "bottom"))].concat([_desugar_kwargs({style: "flex-grow:2; display:flex; align-items:stretch; flex-direction: column"})])), right_margin, self.book_scrollbar.create(), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height: 100%; display:none;", id: "book-selection-bar-overlay"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height: 100%; display:none;", id: "book-read-aloud-overlay"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height: 100%; display:none;", id: "book-hints-overlay"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height:100%; display:none", id: SearchOverlay.prototype.CONTAINER_ID})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height: 100%; display:none", id: "book-content-popup-overlay"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height: 100%; overflow: auto; display:none", id: "book-overlay"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; top:0; left:0; width: 100%; height: 100%; display:none", id: "controls-help-overlay"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "position: absolute; bottom:0em; width: 100%; height: 100%; display:none", id: "audio-ebooks-overlay"})])].concat([_desugar_kwargs({style: "max-height: 100dvh; flex-grow: 2; display:flex; align-items: stretch"})]))].concat([_desugar_kwargs({style: "max-height: 100dvh; display: flex; flex-direction: column; align-items: stretch; flex-grow:2"})]))].concat([_desugar_kwargs({style: "max-height: 100dvh; width: 100dvw; height: 100dvh; overflow: hidden; display: flex; align-items: stretch", oncontextmenu: (function() {
                var _anonfunc = function (ev) {
                    if (!default_context_menu_should_be_allowed(ev)) {
                        ev.preventDefault();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["ev"]},
                    __module__ : {value: "read_book.view"}
                });
                return _anonfunc;
            })()})])));
            self.current_color_scheme = resolve_color_scheme();
            if (runtime.is_standalone_viewer) {
                document.documentElement.addEventListener("keydown", self.handle_keypress, (function(){
                    var _d = Object.create(null);
                    _d["passive"] = false;
                    return _d;
                }).call(this));
                set_ui_colors(self.current_color_scheme.is_dark_theme);
            }
            is_dark_theme(self.current_color_scheme.is_dark_theme);
            self.search_overlay = new SearchOverlay(self);
            self.content_popup_overlay = new ContentPopupOverlay(self);
            self.overlay = new Overlay(self);
            self.selection_bar = new SelectionBar(self);
            self.read_aloud = new ReadAloud(self);
            self.read_audio_ebook = new ReadAudioEbook(self);
            self.hints = new Hints(self);
            self.modal_overlays = [self.selection_bar, self.read_aloud, self.hints, self.read_audio_ebook];
            self.processing_spine_item_display = false;
            self.pending_load = null;
            self.currently_showing = (function(){
                var _d = Object.create(null);
                _d["selection"] = (function(){
                    var _d = Object.create(null);
                    _d["empty"] = true;
                    return _d;
                }).call(this);
                _d["on_load"] = [];
                return _d;
            }).call(this);
            self.book_scrollbar.apply_visibility();
            self.annotations_manager = new AnnotationsManager(self);
        };
        if (!View.prototype.__init__.__argnames__) Object.defineProperties(View.prototype.__init__, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "read_book.view"}
        });
        View.__argnames__ = View.prototype.__init__.__argnames__;
        View.__handles_kwarg_interpolation__ = View.prototype.__init__.__handles_kwarg_interpolation__;
        View.prototype.copy_to_clipboard = function copy_to_clipboard() {
            var self = this;
            self.iframe_wrapper.send_message("copy_selection");
        };
        if (!View.prototype.copy_to_clipboard.__module__) Object.defineProperties(View.prototype.copy_to_clipboard, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_not_a_library_book_error = function show_not_a_library_book_error() {
            var self = this;
            error_dialog(_("Not a calibre library book"), _("This book is not a part of a calibre library, so no calibre:// URL for it exists."));
        };
        if (!View.prototype.show_not_a_library_book_error.__module__) Object.defineProperties(View.prototype.show_not_a_library_book_error, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.copy_current_location_to_clipboard = function copy_current_location_to_clipboard(as_url) {
            var self = this;
            var link_prefix;
            link_prefix = get_current_link_prefix();
            if (!link_prefix && as_url) {
                return self.show_not_a_library_book_error();
            }
            self.get_current_cfi("copy-location-url", (function() {
                var _anonfunc = function (req_id, data) {
                    var text;
                    if (as_url) {
                        text = link_to_epubcfi(data.cfi, link_prefix);
                    } else {
                        text = data.cfi;
                    }
                    ui_operations.copy_selection(text);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["req_id", "data"]},
                    __module__ : {value: "read_book.view"}
                });
                return _anonfunc;
            })());
        };
        if (!View.prototype.copy_current_location_to_clipboard.__argnames__) Object.defineProperties(View.prototype.copy_current_location_to_clipboard, {
            __argnames__ : {value: ["as_url"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.set_scrollbar_visibility = function set_scrollbar_visibility(visible) {
            var self = this;
            var sd;
            sd = get_session_data();
            sd.set("book_scrollbar", bool(visible));
            self.book_scrollbar.apply_visibility();
        };
        if (!View.prototype.set_scrollbar_visibility.__argnames__) Object.defineProperties(View.prototype.set_scrollbar_visibility, {
            __argnames__ : {value: ["visible"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_scrollbar = function toggle_scrollbar() {
            var self = this;
            var sd;
            sd = get_session_data();
            self.set_scrollbar_visibility(!sd.get("book_scrollbar"));
        };
        if (!View.prototype.toggle_scrollbar.__module__) Object.defineProperties(View.prototype.toggle_scrollbar, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_annotations_message = function on_annotations_message(data) {
            var self = this;
            self.selection_bar.handle_message(data);
        };
        if (!View.prototype.on_annotations_message.__argnames__) Object.defineProperties(View.prototype.on_annotations_message, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_tts_message = function on_tts_message(data) {
            var self = this;
            self.read_aloud.handle_message(data);
        };
        if (!View.prototype.on_tts_message.__argnames__) Object.defineProperties(View.prototype.on_tts_message, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_audio_ebook_message = function on_audio_ebook_message(data) {
            var self = this;
            self.read_audio_ebook.handle_message(data);
        };
        if (!View.prototype.on_audio_ebook_message.__argnames__) Object.defineProperties(View.prototype.on_audio_ebook_message, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_hints_message = function on_hints_message(data) {
            var self = this;
            self.hints.handle_message(data);
        };
        if (!View.prototype.on_hints_message.__argnames__) Object.defineProperties(View.prototype.on_hints_message, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.side_margin_clicked = function side_margin_clicked(which, event) {
            var self = this;
            var backwards, sd;
            backwards = which === "left";
            if (get_session_data().get("reverse_page_turn_zones")) {
                backwards = !backwards;
            }
            if (event.button === 0) {
                [event.preventDefault(), event.stopPropagation()];
                sd = get_session_data();
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["next_screen"].concat([_desugar_kwargs({backwards: backwards, flip_if_rtl_page_progression: true, all_pages_on_screen: sd.get("paged_margin_clicks_scroll_by_screen")})]));
            } else if (event.button === 2) {
                [event.preventDefault(), event.stopPropagation()];
                window.setTimeout(self.show_chrome, 0);
            }
            self.focus_iframe();
        };
        if (!View.prototype.side_margin_clicked.__argnames__) Object.defineProperties(View.prototype.side_margin_clicked, {
            __argnames__ : {value: ["which", "event"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.top_margin_clicked = function top_margin_clicked(event) {
            var self = this;
            if (event.button === 0 || event.button === 2) {
                [event.preventDefault(), event.stopPropagation()];
                self.show_chrome();
            } else {
                self.focus_iframe();
            }
        };
        if (!View.prototype.top_margin_clicked.__argnames__) Object.defineProperties(View.prototype.top_margin_clicked, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.bottom_margin_clicked = function bottom_margin_clicked(event) {
            var self = this;
            if (event.button === 0 || event.button === 2) {
                [event.preventDefault(), event.stopPropagation()];
                window.setTimeout(self.show_chrome, 0);
            }
            self.focus_iframe();
        };
        if (!View.prototype.bottom_margin_clicked.__argnames__) Object.defineProperties(View.prototype.bottom_margin_clicked, {
            __argnames__ : {value: ["event"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.margin_context_menu = function margin_context_menu(which, event) {
            var self = this;
            [event.preventDefault(), event.stopPropagation()];
            self.show_chrome();
        };
        if (!View.prototype.margin_context_menu.__argnames__) Object.defineProperties(View.prototype.margin_context_menu, {
            __argnames__ : {value: ["which", "event"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_margin_wheel = function on_margin_wheel(which, event) {
            var self = this;
            event.preventDefault();
            self.send_wheel_event_to_iframe(event, "margin-" + _str.format("{}", which) + "");
        };
        if (!View.prototype.on_margin_wheel.__argnames__) Object.defineProperties(View.prototype.on_margin_wheel, {
            __argnames__ : {value: ["which", "event"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.send_wheel_event_to_iframe = function send_wheel_event_to_iframe(event, location) {
            var self = this;
            var evt, attr;
            evt = (function(){
                var _d = Object.create(null);
                _d["location"] = location;
                return _d;
            }).call(this);
            var _Iter1 = _Iterable(_list_decorate([ "deltaX", "deltaY", "deltaMode", "altKey", "ctrlKey", "shiftKey", "metaKey" ]));
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                attr = _Iter1[_Index1];
                evt[(typeof attr === "number" && attr < 0) ? evt.length + attr : attr] = event[(typeof attr === "number" && attr < 0) ? event.length + attr : attr];
            }
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["fake_wheel_event"].concat([_desugar_kwargs({evt: evt})]));
        };
        if (!View.prototype.send_wheel_event_to_iframe.__argnames__) Object.defineProperties(View.prototype.send_wheel_event_to_iframe, {
            __argnames__ : {value: ["event", "location"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.forward_gesture = function forward_gesture(gesture) {
            var self = this;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["gesture_from_margin"].concat([_desugar_kwargs({gesture: gesture})]));
        };
        if (!View.prototype.forward_gesture.__argnames__) Object.defineProperties(View.prototype.forward_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.iframe_size = function iframe_size() {
            var self = this;
            var iframe, _unpack, l, r, w, t, b, h;
            iframe = self.iframe;
            _unpack = [document.getElementById("book-left-margin"), document.getElementById("book-right-margin")];
            l = _unpack[0];
            r = _unpack[1];
            w = r.offsetLeft - l.offsetLeft - iframe.offsetLeft;
            _unpack = [document.getElementById("book-top-margin"), document.getElementById("book-bottom-margin")];
            t = _unpack[0];
            b = _unpack[1];
            h = b.offsetTop - t.offsetTop - iframe.offsetTop;
            return [w, h];
        };
        if (!View.prototype.iframe_size.__module__) Object.defineProperties(View.prototype.iframe_size, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_request_size = function on_request_size(data) {
            var self = this;
            var _unpack, w, h;
            window.scrollTo(0, 0);
            _unpack = self.iframe_size();
_unpack = _unpack_asarray(2, _unpack);
            w = _unpack[0];
            h = _unpack[1];
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["window_size"].concat([_desugar_kwargs({width: w, height: h})]));
        };
        if (!View.prototype.on_request_size.__argnames__) Object.defineProperties(View.prototype.on_request_size, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_print = function on_print(data) {
            var self = this;
            print(data.string);
        };
        if (!View.prototype.on_print.__argnames__) Object.defineProperties(View.prototype.on_print, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_human_scroll = function on_human_scroll(data) {
            var self = this;
            var name, length, amt_scrolled;
            if (data.scrolled_by_frac === null) {
                self.timers.reset_read_timer();
            } else {
                name = self.currently_showing.name;
                length = _exists.d((_expr_temp = self.book.manifest.files)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]).length;
                if (length) {
                    amt_scrolled = data.scrolled_by_frac * length;
                    self.timers.on_human_scroll(amt_scrolled);
                }
            }
        };
        if (!View.prototype.on_human_scroll.__argnames__) Object.defineProperties(View.prototype.on_human_scroll, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_handle_keypress = function on_handle_keypress(data) {
            var self = this;
            self.handle_keypress(data.evt);
        };
        if (!View.prototype.on_handle_keypress.__argnames__) Object.defineProperties(View.prototype.on_handle_keypress, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.handle_keypress = function handle_keypress(evt) {
            var self = this;
            if (self.overlay.is_visible && evt.key === "Escape") {
                if (self.overlay.handle_escape()) {
                    if (evt.preventDefault) {
                        [evt.preventDefault(), evt.stopPropagation()];
                    }
                }
            }
        };
        if (!View.prototype.handle_keypress.__argnames__) Object.defineProperties(View.prototype.handle_keypress, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.overlay_visibility_changed = function overlay_visibility_changed(visible) {
            var self = this;
            var x;
            if (self.iframe_wrapper.send_message) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["overlay_visibility_changed"].concat([_desugar_kwargs({visible: visible})]));
            }
            if (ui_operations.overlay_visibility_changed) {
                ui_operations.overlay_visibility_changed(visible);
            }
            if (visible) {
                var _Iter2 = _Iterable(self.modal_overlays);
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    x = _Iter2[_Index2];
                    x.hide();
                }
            } else {
                self.selection_bar.update_position();
            }
        };
        if (!View.prototype.overlay_visibility_changed.__argnames__) Object.defineProperties(View.prototype.overlay_visibility_changed, {
            __argnames__ : {value: ["visible"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_handle_shortcut = function on_handle_shortcut(data) {
            var self = this;
            if (!data.name) {
                return;
            }
            if (data.name === "back") {
                window.history.back();
            } else if (data.name === "forward") {
                window.history.forward();
            } else if (data.name === "show_chrome") {
                self.show_chrome();
            } else if (data.name === "show_chrome_force") {
                self.show_chrome_force();
            } else if (data.name === "toggle_toc") {
                ui_operations.toggle_toc();
            } else if (data.name === "toggle_bookmarks") {
                if (ui_operations.toggle_bookmarks) {
                    ui_operations.toggle_bookmarks();
                } else {
                    self.overlay.show_bookmarks();
                }
            } else if (data.name === "show_profiles") {
                self.overlay.show_profiles();
            } else if (data.name === "toggle_highlights") {
                ui_operations.toggle_highlights();
            } else if (data.name === "new_bookmark") {
                self.new_bookmark();
            } else if (data.name === "copy_to_clipboard") {
                self.copy_to_clipboard();
            } else if (data.name === "copy_location_to_clipboard" || data.name === "copy_location_as_url_to_clipboard") {
                self.copy_current_location_to_clipboard(_in("url", data.name));
            } else if (data.name === "toggle_inspector") {
                ui_operations.toggle_inspector();
            } else if (data.name === "toggle_lookup") {
                ui_operations.toggle_lookup();
            } else if (data.name === "toggle_full_screen") {
                ui_operations.toggle_full_screen();
            } else if (data.name === "toggle_paged_mode") {
                self.toggle_paged_mode();
            } else if (data.name === "toggle_toolbar") {
                self.toggle_toolbar();
            } else if (data.name === "toggle_scrollbar") {
                self.toggle_scrollbar();
            } else if (data.name === "quit") {
                ui_operations.quit();
            } else if (data.name === "start_search") {
                self.show_search();
            } else if (data.name === "next_match") {
                ui_operations.find_next();
            } else if (data.name === "previous_match") {
                ui_operations.find_next(true);
            } else if (data.name === "increase_font_size") {
                self.bump_font_size((function(){
                    var _d = Object.create(null);
                    _d["increase"] = true;
                    return _d;
                }).call(this));
            } else if (data.name === "decrease_font_size") {
                self.bump_font_size((function(){
                    var _d = Object.create(null);
                    _d["increase"] = false;
                    return _d;
                }).call(this));
            } else if (data.name === "default_font_size") {
                restore_default_font_size();
            } else if (data.name === "toggle_full_screen") {
                ui_operations.toggle_full_screen();
            } else if (data.name === "toggle_reference_mode") {
                self.toggle_reference_mode();
            } else if (data.name === "read_aloud") {
                self.start_read_aloud();
            } else if (data.name === "toggle_hints") {
                self.toggle_hints();
            } else if (data.name === "toggle_read_aloud") {
                self.toggle_read_aloud();
            } else if (data.name === "reload_book") {
                self.reload_book();
            } else if (data.name === "sync_book") {
                self.overlay.sync_book();
            } else if (data.name === "next_section") {
                self.on_next_section((function(){
                    var _d = Object.create(null);
                    _d["forward"] = true;
                    return _d;
                }).call(this));
            } else if (data.name === "previous_section") {
                self.on_next_section((function(){
                    var _d = Object.create(null);
                    _d["forward"] = false;
                    return _d;
                }).call(this));
            } else if (data.name === "open_book") {
                self.overlay.open_book();
            } else if (data.name === "next") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["next_screen"].concat([_desugar_kwargs({backwards: false, flip_if_rtl_page_progression: false, all_pages_on_screen: get_session_data().get("paged_margin_clicks_scroll_by_screen")})]));
            } else if (data.name === "previous") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["next_screen"].concat([_desugar_kwargs({backwards: true, flip_if_rtl_page_progression: false, all_pages_on_screen: get_session_data().get("paged_margin_clicks_scroll_by_screen")})]));
            } else if (data.name === "clear_selection") {
                self.iframe_wrapper.send_message("clear_selection");
            } else if (data.name === "print") {
                ui_operations.print_book();
            } else if (data.name === "preferences") {
                self.show_chrome((function(){
                    var _d = Object.create(null);
                    _d["initial_panel"] = "show_prefs";
                    return _d;
                }).call(this));
            } else if (data.name === "metadata") {
                self.overlay.show_metadata();
            } else if (data.name === "edit_book") {
                ui_operations.edit_book(current_spine_item(), self.current_file_progress_frac, _exists.d(_exists.d(self.currently_showing).selection).text);
            } else if (data.name === "goto_location") {
                self.overlay.show_ask_for_location();
            } else if (data.name === "select_all") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["modify_selection"].concat([_desugar_kwargs({granularity: "all"})]));
            } else if (data.name.startsWith("shrink_selection_by_")) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["modify_selection"].concat([_desugar_kwargs({direction: "backward", granularity: (_expr_temp = data.name.rpartition("_"))[_expr_temp.length-1]})]));
            } else if (data.name.startsWith("extend_selection_by_")) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["modify_selection"].concat([_desugar_kwargs({direction: "forward", granularity: (_expr_temp = data.name.rpartition("_"))[_expr_temp.length-1]})]));
            } else if (data.name === "extend_selection_to_start_of_line") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["modify_selection"].concat([_desugar_kwargs({direction: "backward", granularity: "lineboundary"})]));
            } else if (data.name === "extend_selection_to_end_of_line") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["modify_selection"].concat([_desugar_kwargs({direction: "forward", granularity: "lineboundary"})]));
            } else if (data.name === "scrollspeed_increase") {
                self.update_scroll_speed(SCROLL_SPEED_STEP);
            } else if (data.name === "scrollspeed_decrease") {
                self.update_scroll_speed(-SCROLL_SPEED_STEP);
            } else if (data.name === "toggle_autoscroll") {
                self.toggle_autoscroll();
            } else if (data.name.startsWith("switch_color_scheme:")) {
                self.switch_color_scheme((_expr_temp = data.name.partition(":"))[_expr_temp.length-1]);
            } else if (data.name === "increase_number_of_columns") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["change_number_of_columns"].concat([_desugar_kwargs({delta: 1})]));
            } else if (data.name === "decrease_number_of_columns") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["change_number_of_columns"].concat([_desugar_kwargs({delta: -1})]));
            } else if (data.name === "reset_number_of_columns") {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["change_number_of_columns"].concat([_desugar_kwargs({delta: 0})]));
            } else {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["handle_navigation_shortcut"].concat([_desugar_kwargs({name: data.name})]));
            }
        };
        if (!View.prototype.on_handle_shortcut.__argnames__) Object.defineProperties(View.prototype.on_handle_shortcut, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_selection_change = function on_selection_change(data) {
            var self = this;
            self.currently_showing.selection = (function(){
                var _d = Object.create(null);
                _d["text"] = data.text;
                _d["empty"] = data.empty;
                _d["start"] = data.selection_extents.start;
                _d["end"] = data.selection_extents.end;
                _d["annot_id"] = data.annot_id;
                _d["drag_mouse_position"] = data.drag_mouse_position;
                _d["selection_change_caused_by_search"] = data.selection_change_caused_by_search;
                _d["rtl"] = data.rtl;
                _d["vertical"] = data.vertical;
                _d["start_is_anchor"] = data.start_is_anchor;
                return _d;
            }).call(this);
            if (ui_operations.selection_changed) {
                ui_operations.selection_changed(self.currently_showing.selection.text, self.currently_showing.selection.annot_id);
            }
            self.selection_bar.update_position();
        };
        if (!View.prototype.on_selection_change.__argnames__) Object.defineProperties(View.prototype.on_selection_change, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.new_bookmark = function new_bookmark() {
            var self = this;
            if (ui_operations.new_bookmark) {
                self.get_current_cfi("new-bookmark", ui_operations.new_bookmark);
            } else {
                self.get_current_cfi("new-bookmark", (function() {
                    var _anonfunc = function (req_id, data) {
                        create_new_bookmark(self.annotations_manager, data);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["req_id", "data"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })());
            }
        };
        if (!View.prototype.new_bookmark.__module__) Object.defineProperties(View.prototype.new_bookmark, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.update_selection_position = function update_selection_position(data) {
            var self = this;
            var sel;
            sel = self.currently_showing.selection;
            sel.start = data.selection_extents.start;
            sel.end = data.selection_extents.end;
            self.selection_bar.update_position();
        };
        if (!View.prototype.update_selection_position.__argnames__) Object.defineProperties(View.prototype.update_selection_position, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_columns_per_screen_changed = function on_columns_per_screen_changed(data) {
            var self = this;
            var sd, cps;
            sd = get_session_data();
            cps = sd.get("columns_per_screen") || Object.create(null);
            cps[_bound_index(data.which, cps)] = int(data.cps);
            sd.set("columns_per_screen", cps);
        };
        if (!View.prototype.on_columns_per_screen_changed.__argnames__) Object.defineProperties(View.prototype.on_columns_per_screen_changed, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.switch_color_scheme = function switch_color_scheme(name) {
            var self = this;
            get_session_data().set("current_color_scheme", name);
            ui_operations.redisplay_book();
        };
        if (!View.prototype.switch_color_scheme.__argnames__) Object.defineProperties(View.prototype.switch_color_scheme, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_paged_mode = function toggle_paged_mode() {
            var self = this;
            var sd, mode, new_mode;
            sd = get_session_data();
            mode = sd.get("read_mode");
            new_mode = (mode === "paged") ? "flow" : "paged";
            sd.set("read_mode", new_mode);
            ui_operations.redisplay_book();
        };
        if (!View.prototype.toggle_paged_mode.__module__) Object.defineProperties(View.prototype.toggle_paged_mode, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_autoscroll = function toggle_autoscroll() {
            var self = this;
            self.iframe_wrapper.send_message("toggle_autoscroll");
        };
        if (!View.prototype.toggle_autoscroll.__module__) Object.defineProperties(View.prototype.toggle_autoscroll, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_toolbar = function toggle_toolbar() {
            var self = this;
            var sd, misc;
            sd = get_session_data();
            misc = sd.get("standalone_misc_settings");
            misc.show_actions_toolbar = !misc.show_actions_toolbar;
            sd.set("standalone_misc_settings", misc);
        };
        if (!View.prototype.toggle_toolbar.__module__) Object.defineProperties(View.prototype.toggle_toolbar, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_invisible_text = function on_invisible_text(data) {
            var self = this;
            _interpolate_kwargs.call(this, warning_dialog, [_("Not found"), _("The text: <i>{}</i> is present on this page but not visible").format(html_escape(data.text))].concat([_desugar_kwargs({on_close: (function() {
                var _anonfunc = function () {
                    self.search_overlay.show();
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.view"}
                });
                return _anonfunc;
            })()})]));
        };
        if (!View.prototype.on_invisible_text.__argnames__) Object.defineProperties(View.prototype.on_invisible_text, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.bump_font_size = function bump_font_size(data) {
            var self = this;
            var mult, frac;
            mult = (data.increase) ? 1 : -1;
            frac = .2;
            if (runtime.is_standalone_viewer) {
                frac = current_zoom_step_size() / 100;
            }
            change_font_size_by(mult * frac);
        };
        if (!View.prototype.bump_font_size.__argnames__) Object.defineProperties(View.prototype.bump_font_size, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_show_footnote = function on_show_footnote(data) {
            var self = this;
            self.show_content_popup();
            self.content_popup_overlay.show_footnote(data);
        };
        if (!View.prototype.on_show_footnote.__argnames__) Object.defineProperties(View.prototype.on_show_footnote, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.hide_overlays = function hide_overlays() {
            var self = this;
            self.overlay.hide();
            self.search_overlay.hide();
            self.content_popup_overlay.hide();
            self.focus_iframe();
        };
        if (!View.prototype.hide_overlays.__module__) Object.defineProperties(View.prototype.hide_overlays, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.focus_iframe = function focus_iframe() {
            var self = this;
            var x;
            var _Iter3 = _Iterable(self.modal_overlays);
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                x = _Iter3[_Index3];
                if (x.is_visible) {
                    x.focus();
                    return;
                }
            }
            self.iframe.contentWindow.focus();
        };
        if (!View.prototype.focus_iframe.__module__) Object.defineProperties(View.prototype.focus_iframe, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.start_read_aloud = function start_read_aloud(dont_start_talking) {
            var self = this;
            var x;
            if (self.book.manifest.has_smil) {
                var _Iter4 = _Iterable(self.modal_overlays);
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    x = _Iter4[_Index4];
                    if (x !== self.read_audio_ebook) {
                        x.hide();
                    }
                }
                self.read_audio_ebook.show();
            } else {
                var _Iter5 = _Iterable(self.modal_overlays);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    x = _Iter5[_Index5];
                    if (x !== self.read_aloud) {
                        x.hide();
                    }
                }
                self.read_aloud.show();
                if (!dont_start_talking) {
                    self.read_aloud.play();
                }
            }
        };
        if (!View.prototype.start_read_aloud.__argnames__) Object.defineProperties(View.prototype.start_read_aloud, {
            __argnames__ : {value: ["dont_start_talking"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_read_aloud = function toggle_read_aloud() {
            var self = this;
            if (self.read_audio_ebook.is_visible) {
                self.read_audio_ebook.hide();
            } else if (self.read_aloud.is_visible) {
                self.read_aloud.hide();
            } else {
                self.start_read_aloud();
            }
        };
        if (!View.prototype.toggle_read_aloud.__module__) Object.defineProperties(View.prototype.toggle_read_aloud, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_hints = function toggle_hints() {
            var self = this;
            var x;
            if (self.hints.is_visible) {
                self.hints.hide();
            } else {
                var _Iter6 = _Iterable(self.modal_overlays);
                for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                    x = _Iter6[_Index6];
                    if (x !== self.hints) {
                        x.hide();
                    }
                }
                self.hints.show();
            }
        };
        if (!View.prototype.toggle_hints.__module__) Object.defineProperties(View.prototype.toggle_hints, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_chrome = function show_chrome(data) {
            var self = this;
            var elements, initial_panel;
            if (self.content_popup_overlay.is_visible) {
                self.content_popup_overlay.hide();
                return;
            }
            self.content_popup_overlay;
            elements = Object.create(null);
            if (data && data.elements) {
                elements = data.elements;
            }
            initial_panel = (typeof data !== "undefined" && data !== null ? data : Object.create(null)).initial_panel || null;
            self.get_current_cfi("show-chrome", self.do_show_chrome.bind(null, elements, initial_panel));
        };
        if (!View.prototype.show_chrome.__argnames__) Object.defineProperties(View.prototype.show_chrome, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_chrome_force = function show_chrome_force() {
            var self = this;
            self.hide_overlays();
            self.show_chrome();
        };
        if (!View.prototype.show_chrome_force.__module__) Object.defineProperties(View.prototype.show_chrome_force, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.do_show_chrome = function do_show_chrome(elements, initial_panel, request_id, cfi_data) {
            var self = this;
            self.hide_overlays();
            self.update_cfi_data(cfi_data);
            if (initial_panel) {
                getattr(self.overlay, initial_panel)();
            } else {
                self.overlay.show(elements);
            }
        };
        if (!View.prototype.do_show_chrome.__argnames__) Object.defineProperties(View.prototype.do_show_chrome, {
            __argnames__ : {value: ["elements", "initial_panel", "request_id", "cfi_data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.prepare_for_close = function prepare_for_close() {
            var self = this;
            function close_prepared(request_id, cfi_data) {
                ui_operations.close_prep_finished(cfi_data.cfi);
            };
            if (!close_prepared.__argnames__) Object.defineProperties(close_prepared, {
                __argnames__ : {value: ["request_id", "cfi_data"]},
                __module__ : {value: "read_book.view"}
            });

            self.get_current_cfi("prepare-close", close_prepared);
        };
        if (!View.prototype.prepare_for_close.__module__) Object.defineProperties(View.prototype.prepare_for_close, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_search = function show_search(trigger) {
            var self = this;
            var text;
            self.hide_overlays();
            text = self.currently_showing.selection.text;
            if (runtime.is_standalone_viewer) {
                ui_operations.show_search(text || "", trigger);
            } else {
                if (text) {
                    self.search_overlay.set_text(text);
                }
                self.search_overlay.show(text);
                if (trigger && text) {
                    self.search_overlay.find_next();
                }
            }
        };
        if (!View.prototype.show_search.__argnames__) Object.defineProperties(View.prototype.show_search, {
            __argnames__ : {value: ["trigger"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_content_popup = function show_content_popup() {
            var self = this;
            self.hide_overlays();
            self.content_popup_overlay.show();
        };
        if (!View.prototype.show_content_popup.__module__) Object.defineProperties(View.prototype.show_content_popup, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.set_margins = function set_margins() {
            var self = this;
            var no_margins, sd, margin_left, margin_right, margin_top, margin_bottom, max_text_height, th, extra, max_text_width, tw;
            no_margins = self.currently_showing.name === self.book.manifest.title_page_name;
            sd = get_session_data();
            margin_left = (no_margins) ? 0 : sd.get("margin_left");
            margin_right = (no_margins) ? 0 : sd.get("margin_right");
            margin_top = (no_margins) ? 0 : sd.get("margin_top");
            margin_bottom = (no_margins) ? 0 : sd.get("margin_bottom");
            max_text_height = sd.get("max_text_height");
            th = window.innerHeight - margin_top - margin_bottom;
            if (!no_margins && max_text_height > 100 && th > max_text_height) {
                extra = Math.floor((th - max_text_height) / 2);
                margin_top += extra;
                margin_bottom += extra;
            }
            max_text_width = sd.get("max_text_width");
            tw = window.innerWidth - margin_left - margin_right;
            if (!no_margins && max_text_width > 100 && tw > max_text_width) {
                extra = Math.floor((tw - max_text_width) / 2);
                margin_left += extra;
                margin_right += extra;
            }
            _interpolate_kwargs.call(this, set_css, [document.getElementById("book-top-margin")].concat([_desugar_kwargs({height: margin_top + "px", font_size: header_footer_font_size(margin_top) + "px"})]));
            _interpolate_kwargs.call(this, set_css, [document.getElementById("book-bottom-margin")].concat([_desugar_kwargs({height: margin_bottom + "px", font_size: header_footer_font_size(margin_bottom) + "px"})]));
            function side_margin(which, val) {
                var m, s;
                m = document.getElementById("book-{}-margin".format(which));
                if (which === "left") {
                    m.nextSibling.style.maxWidth = "calc(100vw - {}px)".format(margin_left + margin_right + self.book_scrollbar.effective_width);
                }
                _interpolate_kwargs.call(this, set_css, [m].concat([_desugar_kwargs({width: val + "px"})]));
                val = min(val, 25);
                s = m.querySelector(".arrow").style;
                s.width = val + "px";
                s.height = val + "px";
            };
            if (!side_margin.__argnames__) Object.defineProperties(side_margin, {
                __argnames__ : {value: ["which", "val"]},
                __module__ : {value: "read_book.view"}
            });

            [side_margin("left", margin_left), side_margin("right", margin_right)];
        };
        if (!View.prototype.set_margins.__module__) Object.defineProperties(View.prototype.set_margins, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_iframe_ready = function on_iframe_ready(data) {
            var self = this;
            var _unpack;
            _unpack = self.iframe_size();
_unpack = _unpack_asarray(2, _unpack);
            data.width = _unpack[0];
            data.height = _unpack[1];
            if (ui_operations.on_iframe_ready) {
                ui_operations.on_iframe_ready();
            }
            return self.do_pending_load;
        };
        if (!View.prototype.on_iframe_ready.__argnames__) Object.defineProperties(View.prototype.on_iframe_ready, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.do_pending_load = function do_pending_load() {
            var self = this;
            var data;
            if (self.pending_load) {
                data = self.pending_load;
                self.pending_load = null;
                self.show_spine_item_stage2(data);
            }
        };
        if (!View.prototype.do_pending_load.__module__) Object.defineProperties(View.prototype.do_pending_load, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_iframe_error = function on_iframe_error(data) {
            var self = this;
            var title, msg;
            title = data.title || _("There was an error processing the book");
            msg = _("Unknown error");
            if (data.errkey) {
                if (data.errkey === "no-auto-scroll-in-paged-mode") {
                    title = _("No auto scroll in paged mode");
                    msg = _("Switch to flow mode (Viewer preferences->Page layout) to enable auto scrolling");
                } else if (data.errkey === "changing-columns-in-flow-mode") {
                    title = _("In flow mode");
                    msg = _("Cannot change number of pages per screen in flow mode, switch to paged mode first.");
                } else if (data.errkey = "unhandled-error") {
                    title = _("Unhandled error");
                }
            }
            if (data.is_non_critical) {
                _interpolate_kwargs.call(this, warning_dialog, [title, msg, data.details].concat([_desugar_kwargs({on_close: ui_operations.focus_iframe})]));
                return;
            }
            ui_operations.show_error(title, msg, data.details);
        };
        if (!View.prototype.on_iframe_error.__argnames__) Object.defineProperties(View.prototype.on_iframe_error, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.apply_color_scheme = function apply_color_scheme() {
            var self = this;
            var ans, iframe, m, s, mc, _unpack, which, sd, bg_image;
            self.current_color_scheme = ans = resolve_color_scheme();
            iframe = self.iframe;
            if (runtime.is_standalone_viewer) {
                set_ui_colors(self.current_color_scheme.is_dark_theme);
            } else {
                iframe.style.colorScheme = (self.current_color_scheme.is_dark_theme) ? "dark" : "light";
            }
            is_dark_theme(self.current_color_scheme.is_dark_theme);
            var _Iter7 = _Iterable("left top right bottom".split(" "));
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                which = _Iter7[_Index7];
                m = document.getElementById("book-{}-margin".format(which));
                s = m.style;
                mc = ans[_bound_index("margin_" + _str.format("{}", which) + "", ans)];
                if (mc) {
                    _unpack = mc.split(":");
_unpack = _unpack_asarray(2, _unpack);
                    s.backgroundColor = _unpack[0];
                    s.color = _unpack[1];
                } else {
                    s.color = ans.foreground;
                    s.backgroundColor = ans.background;
                }
            }
            sd = get_session_data();
            iframe.style.backgroundColor = ans.background || "white";
            bg_image = sd.get("background_image");
            if (bg_image) {
                iframe.style.backgroundImage = "url(" + _str.format("{}", modify_background_image_url_for_fetch(bg_image)) + ")";
            } else {
                iframe.style.backgroundImage = "none";
            }
            if (sd.get("background_image_style") === "scaled") {
                iframe.style.backgroundSize = "100% 100%";
                iframe.style.backgroundRepeat = "no-repeat";
                iframe.style.backgroundAttachment = "scroll";
                iframe.style.backgroundPosition = "center";
            } else {
                iframe.style.backgroundSize = "auto";
                iframe.style.backgroundRepeat = "repeat";
                iframe.style.backgroundAttachment = "scroll";
                iframe.style.backgroundPosition = "0 0";
            }
            self.content_popup_overlay.apply_color_scheme(ans.background, ans.foreground);
            self.book_scrollbar.apply_color_scheme(ans);
            iframe.parentNode.style.backgroundColor = ans.background;
            iframe.parentNode.parentNode.style.backgroundColor = ans.background;
            return ans;
        };
        if (!View.prototype.apply_color_scheme.__module__) Object.defineProperties(View.prototype.apply_color_scheme, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_resize = function on_resize() {
            var self = this;
            var sd;
            if (self.book && self.currently_showing.name) {
                sd = get_session_data();
                if (sd.get("max_text_width") || sd.get("max_text_height")) {
                    self.set_margins();
                }
            }
        };
        if (!View.prototype.on_resize.__module__) Object.defineProperties(View.prototype.on_resize, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_loading_message = function show_loading_message(msg) {
            var self = this;
            self.overlay.show_loading_message(msg);
        };
        if (!View.prototype.show_loading_message.__argnames__) Object.defineProperties(View.prototype.show_loading_message, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_loading = function show_loading() {
            var self = this;
            var msg;
            msg = (_expr_temp = _("Loading next section from <i>{title}</i>, please wait"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({title: self.book.metadata.title || _("Unknown")})]));
            if (self.show_loading_callback_timer !== null) {
                clearTimeout(self.show_loading_callback_timer);
            }
            self.show_loading_callback_timer = setTimeout(self.show_loading_message.bind(null, msg), 200);
        };
        if (!View.prototype.show_loading.__module__) Object.defineProperties(View.prototype.show_loading, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.hide_loading = function hide_loading() {
            var self = this;
            var q;
            if (window.read_book_initial_open_search_text) {
                q = window.read_book_initial_open_search_text;
                delete window.read_book_initial_open_search_text;
                self.search_overlay.do_initial_search(q.text, q.query);
                self.show_loading_message(_("Searching for: {}").format(q.query));
                return;
            }
            if (self.show_loading_callback_timer !== null) {
                clearTimeout(self.show_loading_callback_timer);
                self.show_loading_callback_timer = null;
            }
            self.iframe.style.visibility = "visible";
            self.overlay.hide_loading_message();
            self.focus_iframe();
        };
        if (!View.prototype.hide_loading.__module__) Object.defineProperties(View.prototype.hide_loading, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.parse_cfi = function parse_cfi(encoded_cfi, book) {
            var self = this;
            var name, cfi, _unpack, snum, rest;
            name = cfi = null;
            if (encoded_cfi && encoded_cfi.startswith("epubcfi(/")) {
                cfi = encoded_cfi.slice(len("epubcfi(/"), -1);
                _unpack = _eslice(cfi.partition("/"), 2);
_unpack = _unpack_asarray(2, _unpack);
                snum = _unpack[0];
                rest = _unpack[1];
                try {
                    snum = int(snum);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        print("Invalid spine number in CFI:", snum);
                    } else {
                        throw _Exception;
                    }
                }
                if (typeof snum === "number") {
                    name = (_expr_temp = book.manifest.spine)[_bound_index(Math.floor(int(snum) / 2) - 1, _expr_temp)] || name;
                    cfi = "/" + rest;
                }
            }
            return [name, cfi];
        };
        if (!View.prototype.parse_cfi.__argnames__) Object.defineProperties(View.prototype.parse_cfi, {
            __argnames__ : {value: ["encoded_cfi", "book"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.open_book_page = function open_book_page() {
            var self = this;
            if (self.book && self.book.key) {
                _interpolate_kwargs.call(this, show_panel, ["book_details", (function(){
                    var _d = Object.create(null);
                    _d["library_id"] = self.book.key[0];
                    _d["book_id"] = self.book.key[1] + "";
                    return _d;
                }).call(this)].concat([_desugar_kwargs({replace: false})]));
            }
        };
        if (!View.prototype.open_book_page.__module__) Object.defineProperties(View.prototype.open_book_page, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.clear_book_resource_caches = function clear_book_resource_caches() {
            var self = this;
            self.loaded_resources = Object.create(null);
            self.content_popup_overlay.loaded_resources = Object.create(null);
        };
        if (!View.prototype.clear_book_resource_caches.__module__) Object.defineProperties(View.prototype.clear_book_resource_caches, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.reload_book = function reload_book() {
            var self = this;
            self.clear_book_resource_caches();
            ui_operations.reload_book();
        };
        if (!View.prototype.reload_book.__module__) Object.defineProperties(View.prototype.reload_book, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.display_book = function display_book(book, initial_position, is_redisplay) {
            var self = this;
            var is_current_book, unkey, hl, pos, name, cfi, q, _unpack, cfiname, internal_cfi, navigated, sd, help_key, c;
            self.hide_overlays();
            self.iframe.focus();
            is_current_book = self.book && (self.book.key === book.key || typeof self.book.key === "object" && _equals(self.book.key, book.key));
            self.book_load_started = true;
            if (is_current_book) {
                if (!is_redisplay) {
                    self.search_overlay.clear_caches(book);
                }
            } else {
                if (self.book) {
                    self.iframe_wrapper.reset();
                    self.content_popup_overlay.reset();
                }
                self.clear_book_resource_caches();
                self.timers.start_book(book);
                self.search_overlay.clear_caches(book);
            }
            unkey = username_key(get_interface_data().username);
            self.book = current_book.book = book;
            hl = null;
            if (!is_redisplay) {
                if (self.read_audio_ebook) {
                    self.read_audio_ebook.hide();
                    clear(self.read_audio_ebook.container);
                }
                if (runtime.is_standalone_viewer) {
                    hl = book.highlights;
                    delete book.highlights;
                } else {
                    if (unkey && (_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey]) {
                        hl = (_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey].highlight;
                        self.annotations_manager.set_bookmarks((_expr_temp = book.annotations_map)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey].bookmark || []);
                    }
                }
                self.annotations_manager.set_highlights(hl || []);
                if (runtime.is_standalone_viewer) {
                    add_book_to_recently_viewed(book);
                }
            }
            if (ui_operations.update_last_read_time) {
                ui_operations.update_last_read_time(book);
            }
            pos = (function(){
                var _d = Object.create(null);
                _d["replace_history"] = true;
                return _d;
            }).call(this);
            if (!book.manifest.spine.length) {
                ui_operations.show_error(_("Invalid book"), _("This book is empty, with no items in the spine"));
                return;
            }
            name = book.manifest.spine[0];
            cfi = null;
            if (initial_position && initial_position.type === "cfi" && initial_position.data.startswith("epubcfi(/")) {
                cfi = initial_position.data;
            } else {
                q = parse_url_params();
                if (q.bookpos && q.bookpos.startswith("epubcfi(/")) {
                    cfi = q.bookpos;
                } else if (book.last_read_position && (_expr_temp = book.last_read_position)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey]) {
                    cfi = (_expr_temp = book.last_read_position)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey];
                }
            }
            _unpack = self.parse_cfi(cfi, book);
_unpack = _unpack_asarray(2, _unpack);
            cfiname = _unpack[0];
            internal_cfi = _unpack[1];
            if (cfiname && internal_cfi) {
                name = cfiname;
                _unpack = ["cfi", internal_cfi];
                pos.type = _unpack[0];
                pos.cfi = _unpack[1];
            }
            navigated = false;
            if (initial_position) {
                if (initial_position.type === "toc") {
                    navigated = self.goto_toc_node(initial_position.data);
                } else if (initial_position.type === "bookpos") {
                    navigated = true;
                    self.goto_book_position(initial_position.data);
                } else if (initial_position.type === "ref") {
                    navigated = self.goto_reference(initial_position.data);
                }
            }
            if (navigated) {
                self.hide_loading();
            } else {
                _interpolate_kwargs.call(self, self.show_name, [name].concat([_desugar_kwargs({initial_position: pos})]));
            }
            sd = get_session_data();
            help_key = "controls_help_shown_count" + ((rtl_page_progression()) ? "_rtl_page_progression" : "");
            if (!self[(typeof help_key === "number" && help_key < 0) ? self.length + help_key : help_key]) {
                self[(typeof help_key === "number" && help_key < 0) ? self.length + help_key : help_key] = true;
                c = sd.get(help_key, 0);
                if (c < 2) {
                    show_controls_help();
                    sd.set("controls_help_shown_count" + ((rtl_page_progression()) ? "_rtl_page_progression" : ""), c + 1);
                }
            }
        };
        if (!View.prototype.display_book.__argnames__) Object.defineProperties(View.prototype.display_book, {
            __argnames__ : {value: ["book", "initial_position", "is_redisplay"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.preferences_changed = function preferences_changed() {
            var self = this;
            self.set_margins();
            ui_operations.update_url_state(true);
            ui_operations.redisplay_book();
        };
        if (!View.prototype.preferences_changed.__module__) Object.defineProperties(View.prototype.preferences_changed, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.redisplay_book = function redisplay_book() {
            var self = this;
            var sd;
            if (!self.book) {
                if (runtime.is_standalone_viewer) {
                    self.overlay.open_book();
                }
                return;
            }
            sd = get_session_data();
            self.keyboard_shortcut_map = create_shortcut_map(sd.get("keyboard_shortcuts"));
            if (ui_operations.export_shortcut_map) {
                ui_operations.export_shortcut_map(self.keyboard_shortcut_map);
            }
            self.book_scrollbar.apply_visibility();
            self.display_book(self.book, null, true);
        };
        if (!View.prototype.redisplay_book.__module__) Object.defineProperties(View.prototype.redisplay_book, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.iframe_settings = function iframe_settings(name) {
            var self = this;
            var sd, bg_image_fade, cs, fade, rgba;
            sd = get_session_data();
            bg_image_fade = "transparent";
            cs = self.apply_color_scheme();
            fade = int(sd.get("background_image_fade"));
            rgba = cached_color_to_rgba(cs.background);
            if (self.iframe.style.backgroundImage !== "none" && fade > 0) {
                bg_image_fade = "rgba(" + _str.format("{}", rgba[0]) + ", " + _str.format("{}", rgba[1]) + ", " + _str.format("{}", rgba[2]) + ", " + _str.format("{}", fade / 100) + ")";
            }
            return (function(){
                var _d = Object.create(null);
                _d["margin_left"] = (name === self.book.manifest.title_page_name) ? 0 : sd.get("margin_left");
                _d["margin_right"] = (name === self.book.manifest.title_page_name) ? 0 : sd.get("margin_right");
                _d["margin_top"] = (name === self.book.manifest.title_page_name) ? 0 : sd.get("margin_top");
                _d["margin_bottom"] = (name === self.book.manifest.title_page_name) ? 0 : sd.get("margin_bottom");
                _d["read_mode"] = sd.get("read_mode");
                _d["columns_per_screen"] = sd.get("columns_per_screen");
                _d["color_scheme"] = cs;
                _d["override_book_colors"] = sd.get("override_book_colors");
                _d["is_dark_theme"] = cs.is_dark_theme;
                _d["bg_image_fade"] = bg_image_fade;
                _d["base_font_size"] = sd.get("base_font_size");
                _d["user_stylesheet"] = sd.get("user_stylesheet");
                _d["keyboard_shortcuts"] = sd.get("keyboard_shortcuts");
                _d["hide_tooltips"] = sd.get("hide_tooltips");
                _d["cover_preserve_aspect_ratio"] = sd.get("cover_preserve_aspect_ratio");
                _d["paged_wheel_scrolls_by_screen"] = sd.get("paged_wheel_scrolls_by_screen");
                _d["paged_wheel_section_jumps"] = sd.get("paged_wheel_section_jumps");
                _d["paged_pixel_scroll_threshold"] = sd.get("paged_pixel_scroll_threshold");
                _d["lines_per_sec_auto"] = sd.get("lines_per_sec_auto");
                _d["lines_per_sec_smooth"] = sd.get("lines_per_sec_smooth");
                _d["scroll_auto_boundary_delay"] = sd.get("scroll_auto_boundary_delay");
                _d["scroll_stop_boundaries"] = sd.get("scroll_stop_boundaries");
                _d["reverse_page_turn_zones"] = sd.get("reverse_page_turn_zones");
                _d["gesture_overrides"] = sd.get("gesture_overrides");
                return _d;
            }).call(this);
        };
        if (!View.prototype.iframe_settings.__argnames__) Object.defineProperties(View.prototype.iframe_settings, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_name = function show_name() {
            var self = this;
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var initial_position = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? show_name.__defaults__.initial_position : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "initial_position")){
                initial_position = _kwargs_obj.initial_position;
            }
            var spine, idx;
            if (self.currently_showing.loading) {
                return;
            }
            self.processing_spine_item_display = false;
            initial_position = initial_position || (function(){
                var _d = Object.create(null);
                _d["replace_history"] = false;
                return _d;
            }).call(this);
            spine = self.book.manifest.spine;
            idx = spine.indexOf(name);
            self.currently_showing = (function(){
                var _d = Object.create(null);
                _d["name"] = name;
                _d["settings"] = self.iframe_settings(name);
                _d["initial_position"] = initial_position;
                _d["loading"] = true;
                _d["spine_index"] = idx;
                _d["selection"] = (function(){
                    var _d = Object.create(null);
                    _d["empty"] = true;
                    return _d;
                }).call(this);
                _d["on_load"] = [];
                return _d;
            }).call(this);
            self.show_loading();
            set_current_spine_item(name);
            if (idx > -1) {
                self.currently_showing.bookpos = "epubcfi(/{})".format(2 * (idx + 1));
            }
            self.set_margins();
            self.load_doc(name, self.show_spine_item);
        };
        if (!View.prototype.show_name.__defaults__) Object.defineProperties(View.prototype.show_name, {
            __defaults__ : {value: {initial_position:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "initial_position"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.load_doc = function load_doc(name, done_callback) {
            var self = this;
            function cb(resource_data) {
                self.loaded_resources = resource_data;
                done_callback(resource_data);
            };
            if (!cb.__argnames__) Object.defineProperties(cb, {
                __argnames__ : {value: ["resource_data"]},
                __module__ : {value: "read_book.view"}
            });

            load_resources(self.book, name, self.loaded_resources, cb);
        };
        if (!View.prototype.load_doc.__argnames__) Object.defineProperties(View.prototype.load_doc, {
            __argnames__ : {value: ["name", "done_callback"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_doc_boundary = function goto_doc_boundary(start) {
            var self = this;
            var name;
            name = (_expr_temp = self.book.manifest.spine)[_bound_index((start) ? 0 : self.book.manifest.spine.length - 1, _expr_temp)];
            _interpolate_kwargs.call(self, self.show_name, [name].concat([_desugar_kwargs({initial_position: (function(){
                var _d = Object.create(null);
                _d["type"] = "frac";
                _d["frac"] = (start) ? 0 : 1;
                _d["replace_history"] = false;
                return _d;
            }).call(this)})]));
        };
        if (!View.prototype.goto_doc_boundary.__argnames__) Object.defineProperties(View.prototype.goto_doc_boundary, {
            __argnames__ : {value: ["start"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_frac = function goto_frac(frac) {
            var self = this;
            var chapter_start_page, total_length, page, chapter_frac, chapter_name, chapter_length, chapter_end_page, num_pages, name;
            if (!self.book || !self.book.manifest) {
                return;
            }
            chapter_start_page = 0;
            total_length = self.book.manifest.spine_length;
            page = total_length * frac;
            chapter_frac = 0;
            chapter_name = null;
            var _Iter8 = _Iterable(self.book.manifest.spine);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                name = _Iter8[_Index8];
                chapter_length = _exists.d((_expr_temp = self.book.manifest.files)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]).length || 0;
                chapter_end_page = chapter_start_page + chapter_length;
                if (chapter_start_page <= page && page <= chapter_end_page) {
                    num_pages = chapter_end_page - chapter_start_page - 1;
                    if (num_pages > 0) {
                        chapter_frac = (page - chapter_start_page) / num_pages;
                    } else {
                        chapter_frac = 0;
                    }
                    chapter_name = name;
                    break;
                }
                chapter_start_page = chapter_end_page;
            }
            if (!chapter_name) {
                chapter_name = (_expr_temp = self.book.manifest.spine)[_expr_temp.length-1];
            }
            chapter_frac = max(0, min(chapter_frac, 1));
            if (self.currently_showing.name === chapter_name) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["scroll_to_frac"].concat([_desugar_kwargs({frac: chapter_frac})]));
            } else {
                _interpolate_kwargs.call(self, self.show_name, [chapter_name].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "frac";
                    _d["frac"] = chapter_frac;
                    _d["replace_history"] = true;
                    return _d;
                }).call(this)})]));
            }
        };
        if (!View.prototype.goto_frac.__argnames__) Object.defineProperties(View.prototype.goto_frac, {
            __argnames__ : {value: ["frac"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_book_position = function goto_book_position(bpos) {
            var self = this;
            var val;
            val = max(0, min(1e3 * float(bpos) / self.current_position_data.book_length, 1));
            return self.goto_frac(val);
        };
        if (!View.prototype.goto_book_position.__argnames__) Object.defineProperties(View.prototype.goto_book_position, {
            __argnames__ : {value: ["bpos"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_scroll_to_anchor = function on_scroll_to_anchor(data) {
            var self = this;
            _interpolate_kwargs.call(self, self.show_name, [data.name].concat([_desugar_kwargs({initial_position: (function(){
                var _d = Object.create(null);
                _d["type"] = "anchor";
                _d["anchor"] = data.frag;
                _d["replace_history"] = false;
                return _d;
            }).call(this)})]));
        };
        if (!View.prototype.on_scroll_to_anchor.__argnames__) Object.defineProperties(View.prototype.on_scroll_to_anchor, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.link_in_content_popup_activated = function link_in_content_popup_activated(name, frag, is_popup, title) {
            var self = this;
            self.content_popup_overlay.hide();
            if (is_popup) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["fake_popup_activation"].concat([_desugar_kwargs({name: name, frag: frag, title: title})]));
            } else {
                self.goto_named_destination(name, frag);
            }
        };
        if (!View.prototype.link_in_content_popup_activated.__argnames__) Object.defineProperties(View.prototype.link_in_content_popup_activated, {
            __argnames__ : {value: ["name", "frag", "is_popup", "title"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_cfi = function goto_cfi(bookpos, add_to_history) {
            var self = this;
            var _unpack, cfiname, internal_cfi, pos, name;
            _unpack = self.parse_cfi(bookpos, self.book);
_unpack = _unpack_asarray(2, _unpack);
            cfiname = _unpack[0];
            internal_cfi = _unpack[1];
            if (cfiname && internal_cfi) {
                pos = (function(){
                    var _d = Object.create(null);
                    _d["replace_history"] = !add_to_history;
                    return _d;
                }).call(this);
                name = cfiname;
                _unpack = ["cfi", internal_cfi];
                pos.type = _unpack[0];
                pos.cfi = _unpack[1];
                _interpolate_kwargs.call(self, self.show_name, [name].concat([_desugar_kwargs({initial_position: pos})]));
                return true;
            }
            return false;
        };
        if (!View.prototype.goto_cfi.__argnames__) Object.defineProperties(View.prototype.goto_cfi, {
            __argnames__ : {value: ["bookpos", "add_to_history"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_reference = function goto_reference(reference) {
            var self = this;
            var _unpack, index, refnum, chapter_name;
            if (!self.book || !self.book.manifest) {
                return;
            }
            _unpack = reference.split(".");
_unpack = _unpack_asarray(2, _unpack);
            index = _unpack[0];
            refnum = _unpack[1];
            _unpack = [int(index), (refnum) ? int(refnum) : 1];
            index = _unpack[0];
            refnum = _unpack[1];
            chapter_name = (_expr_temp = self.book.manifest.spine)[(typeof index === "number" && index < 0) ? _expr_temp.length + index : index];
            if (!chapter_name) {
                return false;
            }
            if (self.currently_showing.name === chapter_name) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["scroll_to_ref"].concat([_desugar_kwargs({refnum: refnum})]));
            } else {
                _interpolate_kwargs.call(self, self.show_name, [chapter_name].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "ref";
                    _d["refnum"] = refnum;
                    _d["replace_history"] = true;
                    return _d;
                }).call(this)})]));
            }
            return true;
        };
        if (!View.prototype.goto_reference.__argnames__) Object.defineProperties(View.prototype.goto_reference, {
            __argnames__ : {value: ["reference"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_named_destination = function goto_named_destination(name, frag) {
            var self = this;
            var spine, idx;
            if (self.currently_showing.name === name) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["scroll_to_anchor"].concat([_desugar_kwargs({frag: frag})]));
            } else {
                spine = self.book.manifest.spine;
                idx = spine.indexOf(name);
                if (idx === -1) {
                    _interpolate_kwargs.call(this, error_dialog, [_("Destination does not exist"), _("The file {} does not exist in this book").format(name)].concat([_desugar_kwargs({on_close: (function() {
                        var _anonfunc = function () {
                            ui_operations.focus_iframe();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.view"}
                        });
                        return _anonfunc;
                    })()})]));
                    return false;
                }
                _interpolate_kwargs.call(self, self.show_name, [name].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "anchor";
                    _d["anchor"] = frag;
                    _d["replace_history"] = false;
                    return _d;
                }).call(this)})]));
            }
            return true;
        };
        if (!View.prototype.goto_named_destination.__argnames__) Object.defineProperties(View.prototype.goto_named_destination, {
            __argnames__ : {value: ["name", "frag"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.goto_toc_node = function goto_toc_node(node_id) {
            var self = this;
            var toc, found;
            if (self.overlay_prevents_navigation) {
                return;
            }
            toc = self.book.manifest.toc;
            found = false;
            function process_node(x) {
                var c;
                if (x.id === node_id) {
                    self.goto_named_destination(x.dest || "", x.frag || "");
                    found = true;
                    return;
                }
                var _Iter9 = _Iterable(x.children);
                for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                    c = _Iter9[_Index9];
                    process_node(c);
                }
            };
            if (!process_node.__argnames__) Object.defineProperties(process_node, {
                __argnames__ : {value: ["x"]},
                __module__ : {value: "read_book.view"}
            });

            if (toc) {
                process_node(toc);
            }
            return found;
        };
        if (!View.prototype.goto_toc_node.__argnames__) Object.defineProperties(View.prototype.goto_toc_node, {
            __argnames__ : {value: ["node_id"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.sync_data_received = function sync_data_received(reading_pos_cfi, annotations_map) {
            var self = this;
            var hl;
            if (annotations_map) {
                ui_operations.annotations_synced(annotations_map);
                if (annotations_map.highlight) {
                    if (self.annotations_manager.merge_highlights(annotations_map.highlight)) {
                        hl = self.annotations_manager.highlights_for_currently_showing();
                        _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["replace_highlights"].concat([_desugar_kwargs({highlights: hl})]));
                    }
                }
            }
            if (reading_pos_cfi) {
                self.goto_cfi(reading_pos_cfi);
            }
        };
        if (!View.prototype.sync_data_received.__argnames__) Object.defineProperties(View.prototype.sync_data_received, {
            __argnames__ : {value: ["reading_pos_cfi", "annotations_map"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.set_notes_for_highlight = function set_notes_for_highlight(uuid, notes) {
            var self = this;
            if (self.annotations_manager.set_notes_for_highlight(uuid, notes)) {
                self.selection_bar.notes_edited(uuid);
                self.selection_bar.update_position();
            }
        };
        if (!View.prototype.set_notes_for_highlight.__argnames__) Object.defineProperties(View.prototype.set_notes_for_highlight, {
            __argnames__ : {value: ["uuid", "notes"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_next_spine_item = function show_next_spine_item(previous) {
            var self = this;
            var spine, idx;
            spine = self.book.manifest.spine;
            idx = spine.indexOf(self.currently_showing.name);
            if (previous) {
                if (idx === 0) {
                    return false;
                }
                idx = min(spine.length - 1, max(idx - 1, 0));
                _interpolate_kwargs.call(self, self.show_name, [spine[(typeof idx === "number" && idx < 0) ? spine.length + idx : idx]].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "frac";
                    _d["frac"] = 1;
                    _d["replace_history"] = true;
                    return _d;
                }).call(this)})]));
            } else {
                if (idx === spine.length - 1) {
                    return false;
                }
                idx = max(0, min(spine.length - 1, idx + 1));
                _interpolate_kwargs.call(self, self.show_name, [spine[(typeof idx === "number" && idx < 0) ? spine.length + idx : idx]].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "frac";
                    _d["frac"] = 0;
                    _d["replace_history"] = true;
                    return _d;
                }).call(this)})]));
            }
            return true;
        };
        if (!View.prototype.show_next_spine_item.__argnames__) Object.defineProperties(View.prototype.show_next_spine_item, {
            __argnames__ : {value: ["previous"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_next_spine_item = function on_next_spine_item(data) {
            var self = this;
            self.show_next_spine_item(data.previous);
        };
        if (!View.prototype.on_next_spine_item.__argnames__) Object.defineProperties(View.prototype.on_next_spine_item, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_next_section = function on_next_section(data) {
            var self = this;
            var toc_node;
            toc_node = get_next_section(data.forward);
            if (toc_node) {
                self.goto_named_destination(toc_node.dest, toc_node.frag);
            }
        };
        if (!View.prototype.on_next_section.__argnames__) Object.defineProperties(View.prototype.on_next_section, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.get_current_cfi = function get_current_cfi(request_id, callback) {
            var self = this;
            self.get_cfi_counter += 1;
            request_id += ":" + self.get_cfi_counter;
            (_expr_temp = self.report_cfi_callbacks)[(typeof request_id === "number" && request_id < 0) ? _expr_temp.length + request_id : request_id] = callback;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["get_current_cfi"].concat([_desugar_kwargs({request_id: request_id})]));
        };
        if (!View.prototype.get_current_cfi.__argnames__) Object.defineProperties(View.prototype.get_current_cfi, {
            __argnames__ : {value: ["request_id", "callback"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.update_cfi_data = function update_cfi_data(data) {
            var self = this;
            var username, unkey;
            username = get_interface_data().username;
            if (self.book) {
                self.currently_showing.bookpos = data.cfi;
                unkey = username_key(username);
                if (!self.book.last_read_position) {
                    self.book.last_read_position = Object.create(null);
                }
                (_expr_temp = self.book.last_read_position)[(typeof unkey === "number" && unkey < 0) ? _expr_temp.length + unkey : unkey] = data.cfi;
                self.set_progress_frac(data.progress_frac, data.file_progress_frac, data.page_counts);
                self.update_header_footer();
                if (ui_operations.update_last_read_time) {
                    ui_operations.update_last_read_time(self.book);
                }
            }
            return username;
        };
        if (!View.prototype.update_cfi_data.__argnames__) Object.defineProperties(View.prototype.update_cfi_data, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_report_cfi = function on_report_cfi(data) {
            var self = this;
            var cb;
            cb = (_expr_temp = self.report_cfi_callbacks)[_bound_index(data.request_id, _expr_temp)];
            if (cb) {
                cb(data.request_id.rpartition(":")[0], (function(){
                    var _d = Object.create(null);
                    _d["cfi"] = data.cfi;
                    _d["progress_frac"] = data.progress_frac;
                    _d["file_progress_frac"] = data.file_progress_frac;
                    _d["selected_text"] = data.selected_text;
                    _d["selection_bounds"] = data.selection_bounds;
                    _d["page_counts"] = data.page_counts;
                    return _d;
                }).call(this));
                delete self.report_cfi_callbacks[data.request_id];
            }
        };
        if (!View.prototype.on_report_cfi.__argnames__) Object.defineProperties(View.prototype.on_report_cfi, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_update_progress_frac = function on_update_progress_frac(data) {
            var self = this;
            self.set_progress_frac(data.progress_frac, data.file_progress_frac, data.page_counts);
            self.update_header_footer();
        };
        if (!View.prototype.on_update_progress_frac.__argnames__) Object.defineProperties(View.prototype.on_update_progress_frac, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_update_cfi = function on_update_cfi(data) {
            var self = this;
            var overlay_shown, username, key, lrd;
            overlay_shown = !self.processing_spine_item_display && self.overlay.is_visible;
            if (overlay_shown || self.search_overlay.is_visible || self.content_popup_overlay.is_visible) {
                return;
            }
            username = self.update_cfi_data(data);
            ui_operations.update_url_state(data.replace_history);
            if (username) {
                key = self.book.key;
                lrd = (function(){
                    var _d = Object.create(null);
                    _d["device"] = get_device_uuid();
                    _d["cfi"] = data.cfi;
                    _d["pos_frac"] = data.progress_frac;
                    return _d;
                }).call(this);
                ajax_send(_interpolate_kwargs.call("book-set-last-read-position/{library_id}/{book_id}/{fmt}", "book-set-last-read-position/{library_id}/{book_id}/{fmt}".format, [_desugar_kwargs({library_id: key[0], book_id: key[1], fmt: key[2]})]), lrd, (function() {
                    var _anonfunc = function (end_type, xhr, ev) {
                        if (end_type !== "load") {
                            print("Failed to update last read position, AJAX call did not succeed");
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["end_type", "xhr", "ev"]},
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })());
                update_book_in_recently_read_by_user_on_home_page(key[0], key[1], key[2], data.cfi);
            }
        };
        if (!View.prototype.on_update_cfi.__argnames__) Object.defineProperties(View.prototype.on_update_cfi, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_status_message = function show_status_message(msg, timeout) {
            var self = this;
            self.current_status_message = msg || "";
            self.update_header_footer();
            if (self.current_status_message) {
                if (!(typeof timeout !== "undefined" && timeout !== null)) {
                    timeout = 1e4;
                }
                window.setTimeout((function() {
                    var _anonfunc = function () {
                        self.show_status_message();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.view"}
                    });
                    return _anonfunc;
                })(), timeout);
            }
        };
        if (!View.prototype.show_status_message.__argnames__) Object.defineProperties(View.prototype.show_status_message, {
            __argnames__ : {value: ["msg", "timeout"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.create_template_renderer = function create_template_renderer() {
            var self = this;
            var pos, book_length, chapter_length, book_time, chapter_time, mi, sd, view_mode;
            if (!self.book) {
                return;
            }
            pos = self.current_position_data;
            book_length = pos.book_length * max(0, 1 - pos.progress_frac);
            chapter_length = pos.chapter_length * max(0, 1 - pos.file_progress_frac);
            book_time = self.timers.time_for(book_length);
            chapter_time = self.timers.time_for(chapter_length);
            mi = self.book.metadata;
            sd = get_session_data();
            view_mode = sd.get("read_mode");
            function render(div, name, which, override) {
                return render_head_foot(div, name, which, mi, self.current_toc_node, self.current_toc_toplevel_node, book_time, chapter_time, pos, override, view_mode);
            };
            if (!render.__argnames__) Object.defineProperties(render, {
                __argnames__ : {value: ["div", "name", "which", "override"]},
                __module__ : {value: "read_book.view"}
            });

            return render;
        };
        if (!View.prototype.create_template_renderer.__module__) Object.defineProperties(View.prototype.create_template_renderer, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.update_header_footer = function update_header_footer() {
            var self = this;
            var renderer, sd, has_clock, div, tname, edge;
            renderer = self.create_template_renderer();
            if (!renderer) {
                return;
            }
            sd = get_session_data();
            has_clock = false;
            function render_template(div, edge, name) {
                var c, b, a, override, hca, hcb, hcc;
                c = div.lastChild;
                b = c.previousSibling;
                a = b.previousSibling;
                if (sd.get("margin_" + _str.format("{}", edge) + "", 20) > 5) {
                    override = (edge === "bottom") ? self.current_status_message : "";
                    hca = renderer(a, name, "left", override);
                    hcb = renderer(b, name, "middle", "");
                    hcc = renderer(c, name, "right", "");
                    if (hca || hcb || hcc) {
                        has_clock = true;
                    }
                } else {
                    [clear(a), clear(b), clear(c)];
                }
            };
            if (!render_template.__argnames__) Object.defineProperties(render_template, {
                __argnames__ : {value: ["div", "edge", "name"]},
                __module__ : {value: "read_book.view"}
            });

            var _Iter10 = _Iterable(_list_decorate([ "left", "right", "top", "bottom" ]));
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                edge = _Iter10[_Index10];
                div = document.getElementById("book-" + _str.format("{}", edge) + "-margin");
                if (div) {
                    tname = (_expr_temp = (function(){
                        var _d = Object.create(null);
                        _d["left"] = "left-margin";
                        _d["right"] = "right-margin";
                        _d["top"] = "header";
                        _d["bottom"] = "footer";
                        return _d;
                    }).call(this))[(typeof edge === "number" && edge < 0) ? _expr_temp.length + edge : edge];
                    render_template(div, edge, tname);
                }
            }
            if (has_clock) {
                if (!self.timer_ids.clock) {
                    self.timer_ids.clock = window.setInterval(self.update_header_footer, 6e4);
                }
            } else {
                if (self.timer_ids.clock) {
                    window.clearInterval(self.timer_ids.clock);
                    self.timer_ids.clock = 0;
                }
            }
        };
        if (!View.prototype.update_header_footer.__module__) Object.defineProperties(View.prototype.update_header_footer, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_update_toc_position = function on_update_toc_position(data) {
            var self = this;
            var first, r, fam;
            update_visible_toc_nodes(data.visible_anchors);
            self.current_toc_families = get_current_toc_nodes();
            if (self.current_toc_families.length) {
                first = self.current_toc_families[0];
                self.current_toc_node = first[first.length-1];
                self.current_toc_toplevel_node = first[0];
            } else {
                self.current_toc_node = self.current_toc_toplevel_node = null;
            }
            if (runtime.is_standalone_viewer) {
                r = [];
                var _Iter11 = _Iterable(self.current_toc_families);
                for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                    fam = _Iter11[_Index11];
                    if (fam.length) {
                        r.push(fam[fam.length-1].id);
                    }
                }
                ui_operations.update_current_toc_nodes(r);
            }
            self.update_header_footer();
        };
        if (!View.prototype.on_update_toc_position.__argnames__) Object.defineProperties(View.prototype.on_update_toc_position, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_spine_item = function show_spine_item(resource_data) {
            var self = this;
            self.pending_load = resource_data;
            if (self.iframe_wrapper.ready) {
                self.do_pending_load();
            } else {
                self.iframe_wrapper.init();
            }
        };
        if (!View.prototype.show_spine_item.__argnames__) Object.defineProperties(View.prototype.show_spine_item, {
            __argnames__ : {value: ["resource_data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_spine_item_stage2 = function show_spine_item_stage2(resource_data) {
            var self = this;
            var fdata, smil_map;
            self.processing_spine_item_display = true;
            self.current_status_message = "";
            self.iframe.style.visibility = "hidden";
            fdata = (_expr_temp = self.book.manifest.files)[_bound_index(self.currently_showing.name, _expr_temp)];
            smil_map = null;
            if (self.book.manifest.has_smil && fdata) {
                smil_map = fdata.smil_map;
                self.currently_showing.smil_audio_map = get_smil_audio_map(smil_map);
            }
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_unencrypted_message, ["display"].concat([_desugar_kwargs({resource_data: resource_data, book: self.book, name: self.currently_showing.name, initial_position: self.currently_showing.initial_position, smil_map: smil_map || null, settings: self.currently_showing.settings, reference_mode_enabled: self.reference_mode_enabled, is_titlepage: self.currently_showing.name === self.book.manifest.title_page_name, highlights: self.annotations_manager.highlights_for_currently_showing()})]));
        };
        if (!View.prototype.show_spine_item_stage2.__argnames__) Object.defineProperties(View.prototype.show_spine_item_stage2, {
            __argnames__ : {value: ["resource_data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.on_content_loaded = function on_content_loaded(data) {
            var self = this;
            var x;
            var _Iter12 = _Iterable(self.modal_overlays);
            for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                x = _Iter12[_Index12];
                if (!x.dont_hide_on_content_loaded) {
                    x.hide();
                }
            }
            self.processing_spine_item_display = false;
            self.currently_showing.loading = false;
            self.hide_loading();
            self.set_progress_frac(data.progress_frac, data.file_progress_frac, data.page_counts);
            self.update_header_footer();
            window.scrollTo(0, 0);
            if (self.book_load_started) {
                self.book_load_started = false;
                if (ui_operations.clear_history) {
                    ui_operations.clear_history();
                }
            }
            if (ui_operations.content_file_changed) {
                ui_operations.content_file_changed(self.currently_showing.name);
            }
            if (self.read_aloud.is_visible) {
                self.read_aloud.play();
            }
            var _Iter13 = _Iterable(self.currently_showing.on_load);
            for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                x = _Iter13[_Index13];
                x();
            }
            self.currently_showing.on_load = [];
        };
        if (!View.prototype.on_content_loaded.__argnames__) Object.defineProperties(View.prototype.on_content_loaded, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.set_progress_frac = function set_progress_frac(progress_frac, file_progress_frac, page_counts) {
            var self = this;
            self.current_progress_frac = progress_frac || 0;
            self.current_file_progress_frac = file_progress_frac || 0;
            self.current_page_counts = page_counts;
            self.book_scrollbar.sync_to_contents(self.current_progress_frac);
        };
        if (!View.prototype.set_progress_frac.__argnames__) Object.defineProperties(View.prototype.set_progress_frac, {
            __argnames__ : {value: ["progress_frac", "file_progress_frac", "page_counts"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.update_font_size = function update_font_size() {
            var self = this;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["change_font_size"].concat([_desugar_kwargs({base_font_size: get_session_data().get("base_font_size")})]));
        };
        if (!View.prototype.update_font_size.__module__) Object.defineProperties(View.prototype.update_font_size, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.viewer_font_size_changed = function viewer_font_size_changed() {
            var self = this;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["viewer_font_size_changed"].concat([_desugar_kwargs({base_font_size: get_session_data().get("base_font_size")})]));
        };
        if (!View.prototype.viewer_font_size_changed.__module__) Object.defineProperties(View.prototype.viewer_font_size_changed, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.update_scroll_speed = function update_scroll_speed(amt) {
            var self = this;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["change_scroll_speed"].concat([_desugar_kwargs({lines_per_sec_auto: change_scroll_speed(amt)})]));
        };
        if (!View.prototype.update_scroll_speed.__argnames__) Object.defineProperties(View.prototype.update_scroll_speed, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.update_color_scheme = function update_color_scheme() {
            var self = this;
            var cs;
            cs = self.apply_color_scheme();
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["change_color_scheme"].concat([_desugar_kwargs({color_scheme: cs})]));
        };
        if (!View.prototype.update_color_scheme.__module__) Object.defineProperties(View.prototype.update_color_scheme, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.toggle_reference_mode = function toggle_reference_mode() {
            var self = this;
            self.reference_mode_enabled = !self.reference_mode_enabled;
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["set_reference_mode"].concat([_desugar_kwargs({enabled: self.reference_mode_enabled})]));
            if (ui_operations.reference_mode_changed) {
                ui_operations.reference_mode_changed(self.reference_mode_enabled);
            }
        };
        if (!View.prototype.toggle_reference_mode.__module__) Object.defineProperties(View.prototype.toggle_reference_mode, {
            __module__ : {value: "read_book.view"}
        });
        View.prototype.discover_search_result = function discover_search_result(sr) {
            var self = this;
            if (sr.search_finished) {
                if (self.search_result_discovery) {
                    self.search_result_discovery.finished = true;
                    if (!self.search_result_discovery.discovered && self.search_result_discovery.first_search_result && self.search_result_discovery.queue.length === 0) {
                        sr = self.search_result_discovery.first_search_result;
                        sr.force_jump_to = true;
                        self.search_result_discovery.jump_forced = true;
                        self.show_search_result(sr);
                    }
                }
                return;
            }
            if (sr.result_num === 1) {
                self.search_result_discovery = (function(){
                    var _d = Object.create(null);
                    _d["queue"] = [];
                    _d["on_discovery"] = sr.on_discovery;
                    _d["in_flight"] = null;
                    _d["discovered"] = false;
                    _d["first_search_result"] = sr;
                    _d["finished"] = false;
                    _d["jump_forced"] = false;
                    return _d;
                }).call(this);
            }
            if (!self.search_result_discovery || self.search_result_discovery.discovered || self.search_result_discovery.on_discovery !== sr.on_discovery) {
                return;
            }
            self.search_result_discovery.queue.push(sr);
            if (!self.search_result_discovery.in_flight) {
                self.show_search_result(self.search_result_discovery.queue.shift());
            }
        };
        if (!View.prototype.discover_search_result.__argnames__) Object.defineProperties(View.prototype.discover_search_result, {
            __argnames__ : {value: ["sr"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.handle_search_result_discovery = function handle_search_result_discovery(sr, discovered) {
            var self = this;
            if (_exists.d(self.search_result_discovery).on_discovery === sr.on_discovery) {
                self.search_result_discovery.in_flight = null;
                if (discovered) {
                    if (!self.search_result_discovery.discovered) {
                        self.search_result_discovery.discovered = true;
                        ui_operations.search_result_discovered(sr);
                    }
                } else if (!self.search_result_discovery.discovered && self.search_result_discovery.queue.length) {
                    self.show_search_result(self.search_result_discovery.queue.shift());
                } else if (!self.search_result_discovery.discovered && self.search_result_discovery.finished && !self.search_result_discovery.jump_forced) {
                    sr = self.search_result_discovery.first_search_result;
                    sr.force_jump_to = true;
                    self.search_result_discovery.jump_forced = true;
                    self.show_search_result(sr);
                }
            }
        };
        if (!View.prototype.handle_search_result_discovery.__argnames__) Object.defineProperties(View.prototype.handle_search_result_discovery, {
            __argnames__ : {value: ["sr", "discovered"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.search_result_discovered = function search_result_discovered(data) {
            var self = this;
            self.handle_search_result_discovery(data.search_result, data.discovered);
        };
        if (!View.prototype.search_result_discovered.__argnames__) Object.defineProperties(View.prototype.search_result_discovered, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.search_result_not_found = function search_result_not_found(data) {
            var self = this;
            if (ui_operations.search_result_not_found) {
                ui_operations.search_result_not_found(data.search_result);
            }
            self.handle_search_result_discovery(data.search_result, false);
        };
        if (!View.prototype.search_result_not_found.__argnames__) Object.defineProperties(View.prototype.search_result_not_found, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.show_search_result = function show_search_result(sr) {
            var self = this;
            if (self.currently_showing.name === sr.file_name) {
                if (self.currently_showing.loading) {
                    self.currently_showing.on_load.push(self.show_search_result.bind(null, sr));
                } else {
                    _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["show_search_result"].concat([_desugar_kwargs({search_result: sr})]));
                }
            } else {
                _interpolate_kwargs.call(self, self.show_name, [sr.file_name].concat([_desugar_kwargs({initial_position: (function(){
                    var _d = Object.create(null);
                    _d["type"] = "search_result";
                    _d["search_result"] = sr;
                    _d["replace_history"] = true;
                    return _d;
                }).call(this)})]));
            }
            if (_exists.d(self.search_result_discovery).on_discovery === sr.on_discovery) {
                self.search_result_discovery.in_flight = sr.result_num;
            }
        };
        if (!View.prototype.show_search_result.__argnames__) Object.defineProperties(View.prototype.show_search_result, {
            __argnames__ : {value: ["sr"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.highlight_action = function highlight_action(uuid, which) {
            var self = this;
            var spine, spine_index, cfi;
            spine = self.book.manifest.spine;
            spine_index = self.annotations_manager.spine_index_for_highlight(uuid, spine);
            if (spine_index < 0 || spine_index >= spine.length) {
                if (which === "edit") {
                    self.selection_bar.report_failed_edit_highlight(uuid);
                }
                return;
            }
            if (which === "edit") {
                if (self.currently_showing.spine_index === spine_index) {
                    self.selection_bar.edit_highlight(uuid);
                } else {
                    _interpolate_kwargs.call(self, self.show_name, [spine[(typeof spine_index === "number" && spine_index < 0) ? spine.length + spine_index : spine_index]].concat([_desugar_kwargs({initial_position: (function(){
                        var _d = Object.create(null);
                        _d["type"] = "edit_annotation";
                        _d["uuid"] = uuid;
                        _d["replace_history"] = true;
                        return _d;
                    }).call(this)})]));
                }
            } else if (which === "delete") {
                self.selection_bar.remove_highlight_with_id(uuid);
            } else if (which === "goto") {
                cfi = self.annotations_manager.cfi_for_highlight(uuid, spine_index);
                if (cfi) {
                    self.goto_cfi(cfi, true);
                }
            }
        };
        if (!View.prototype.highlight_action.__argnames__) Object.defineProperties(View.prototype.highlight_action, {
            __argnames__ : {value: ["uuid", "which"]},
            __module__ : {value: "read_book.view"}
        });
        View.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        View.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(View.prototype, "__bases__", {value: []});
        
        
        

        _modules["read_book.view"].show_controls_help = show_controls_help;
        _modules["read_book.view"].body_font_size = body_font_size;
        _modules["read_book.view"].header_footer_font_size = header_footer_font_size;
        _modules["read_book.view"].margin_elem = margin_elem;
        _modules["read_book.view"].side_margin_elem = side_margin_elem;
        _modules["read_book.view"].View = View;
    })();

    (function(){
        var __name__ = "image_popup";
        var popup;
        var E = _modules.elementmaker.E;

        var absolute_path = _modules.ajax.absolute_path;

        var add_extra_css = _modules.dom.add_extra_css;
        var svgicon = _modules.dom.svgicon;
        var unique_id = _modules.dom.unique_id;

        var _ = _modules.gettext.gettext;

        var MODAL_Z_INDEX = _modules.popups.MODAL_Z_INDEX;

        var FlickAnimator = _modules["read_book.flow_mode"].FlickAnimator;

        var TouchHandler = _modules["read_book.touch"].TouchHandler;
        var install_handlers = _modules["read_book.touch"].install_handlers;

        var debounce = _modules.utils.debounce;

        add_extra_css((function() {
            var _anonfunc = function () {
                var bg, fg, button_bg, css;
                bg = "#333";
                fg = "#ddd";
                button_bg = "#333";
                css = ".calibre-image-popup { background-color: " + _str.format("{}", bg) + "; color: " + _str.format("{}", fg) + "; }";
                css += ".calibre-image-popup a { padding: 0.25ex; display: inline-block; border-radius: 100%; cursor: pointer; background-color: " + _str.format("{}", button_bg) + "; }";
                css += ".calibre-image-popup.fit-to-window a.fit-to-window { color: " + _str.format("{}", button_bg) + "; background-color: " + _str.format("{}", fg) + "; }";
                return css;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "image_popup"}
            });
            return _anonfunc;
        })());
        function fit_image(width, height, pwidth, pheight) {
            var scaled, corrf, _unpack;
            scaled = height > pheight || width > pwidth;
            if (height > pheight) {
                corrf = pheight / float(height);
                _unpack = [Math.floor(corrf * width), pheight];
                width = _unpack[0];
                height = _unpack[1];
            }
            if (width > pwidth) {
                corrf = pwidth / float(width);
                _unpack = [pwidth, Math.floor(corrf * height)];
                width = _unpack[0];
                height = _unpack[1];
            }
            if (height > pheight) {
                corrf = pheight / float(height);
                _unpack = [Math.floor(corrf * width), pheight];
                width = _unpack[0];
                height = _unpack[1];
            }
            return [scaled, int(width), int(height)];
        };
        if (!fit_image.__argnames__) Object.defineProperties(fit_image, {
            __argnames__ : {value: ["width", "height", "pwidth", "pheight"]},
            __module__ : {value: "image_popup"}
        });

        function ImagePopup() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ImagePopup.prototype.__bind_methods__.call(this);
            ImagePopup.prototype.__init__.apply(this, arguments);
        }
        _extends(ImagePopup, TouchHandler);
        Object.defineProperty(ImagePopup.prototype, "__bind_methods__", {value: function () {
            TouchHandler.prototype.__bind_methods__ && TouchHandler.prototype.__bind_methods__.call(this);
            this.onwheel = ImagePopup.prototype.onwheel.bind(this);
            this.onkeydown = ImagePopup.prototype.onkeydown.bind(this);
            this.handle_gesture = ImagePopup.prototype.handle_gesture.bind(this);
            this.scroll_down = ImagePopup.prototype.scroll_down.bind(this);
            this.scroll_up = ImagePopup.prototype.scroll_up.bind(this);
            this.scroll_right = ImagePopup.prototype.scroll_right.bind(this);
            this.scroll_left = ImagePopup.prototype.scroll_left.bind(this);
            this.scroll_y = ImagePopup.prototype.scroll_y.bind(this);
            this.scroll_x = ImagePopup.prototype.scroll_x.bind(this);
            this.resize_canvas = ImagePopup.prototype.resize_canvas.bind(this);
            this.show_container = ImagePopup.prototype.show_container.bind(this);
            this.hide_container = ImagePopup.prototype.hide_container.bind(this);
            this.show_url = ImagePopup.prototype.show_url.bind(this);
            this.update_canvas = ImagePopup.prototype.update_canvas.bind(this);
            this.toggle_fit_to_window = ImagePopup.prototype.toggle_fit_to_window.bind(this);
            this.image_loaded = ImagePopup.prototype.image_loaded.bind(this);
            this.image_failed = ImagePopup.prototype.image_failed.bind(this);
        }});
        Object.defineProperties(ImagePopup.prototype,  {
            "container": {
                "enumerable": true, 
                "get": function container() {
                    var self = this;
                    if (self._container === null) {
                        self._container = _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [svgicon("fit-to-screen")].concat([_desugar_kwargs({title: _("Fit image to screen"), class_: "fit-to-window", onclick: self.toggle_fit_to_window})])), _interpolate_kwargs.call(E, E.a, [svgicon("close")].concat([_desugar_kwargs({title: _("Close"), onclick: self.hide_container})]))].concat([_desugar_kwargs({style: "position: fixed; top: 0; left: 0; text-align: right; width: 100%; font-size: 200%; padding: 0.25ex; box-sizing: border-box; display: flex; justify-content: space-between"})])), _interpolate_kwargs.call(E, E.canvas, [_desugar_kwargs({width: window.innerWidth + "", height: window.innerHeight + "", style: "width: 100%; height: 100%; margin: 0; padding: 0; border-width: 0; box-sizing: border-box; display: block", aria_label: "Popup view of image"})])].concat([_desugar_kwargs({style: "display:none; position:absolute; left:0; top: 0; z-index: " + _str.format("{}", MODAL_Z_INDEX) + "; width: 100vw; height: 100vh; padding: 0; margin: 0; border-width: 0; box-sizing: border-box", id: self.container_id, tabindex: "0", class_: "calibre-image-popup", onkeydown: self.onkeydown, onwheel: self.onwheel})]));
                        document.body.appendChild(self._container);
                        install_handlers(self.canvas, self);
                        window.addEventListener("resize", debounce(self.resize_canvas, 250));
                    }
                    return self._container;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "vertical_max_bounce_distance": {
                "enumerable": true, 
                "get": function vertical_max_bounce_distance() {
                    var self = this;
                    return Math.min(60, window.innerHeight / 2);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "horizontal_max_bounce_distance": {
                "enumerable": true, 
                "get": function horizontal_max_bounce_distance() {
                    var self = this;
                    return Math.min(60, window.innerWidth / 2);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "canvas": {
                "enumerable": true, 
                "get": function canvas() {
                    var self = this;
                    return self.container.getElementsByTagName("canvas")[0];
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "fit_to_window": {
                "enumerable": true, 
                "get": function fit_to_window() {
                    var self = this;
                    return self.container.classList.contains("fit-to-window");
                }, 
                "set": function fit_to_window(val) {
                    var self = this;
                    var c;
                    c = self.container;
                    if (val) {
                        c.classList.add("fit-to-window");
                        c.querySelector("a.fit-to-window").title = _("Do not fit image to window");
                    } else {
                        c.classList.remove("fit-to-window");
                        c.querySelector("a.fit-to-window").title = _("Fit image to window");
                    }
                }
            }, 
            "canvas_width": {
                "enumerable": true, 
                "get": function canvas_width() {
                    var self = this;
                    return self.canvas.width / Math.max(1, window.devicePixelRatio);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
            "canvas_height": {
                "enumerable": true, 
                "get": function canvas_height() {
                    var self = this;
                    return self.canvas.height / Math.max(1, window.devicePixelRatio);
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ImagePopup.prototype.__init__ = function __init__() {
            var self = this;
            var fa;
            TouchHandler.prototype.__init__.call(self);
            self.flick_animator = fa = new FlickAnimator;
            fa.scroll_x = self.scroll_x;
            fa.scroll_y = self.scroll_y;
            fa.cancel_current_drag_scroll = (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "image_popup"}
                });
                return _anonfunc;
            })();
            self._container = null;
            self.container_id = unique_id("image-popup");
            self.img = null;
            self.img_loading = false;
            self.img_ok = false;
        };
        if (!ImagePopup.prototype.__init__.__module__) Object.defineProperties(ImagePopup.prototype.__init__, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.__argnames__ = ImagePopup.prototype.__init__.__argnames__;
        ImagePopup.__handles_kwarg_interpolation__ = ImagePopup.prototype.__init__.__handles_kwarg_interpolation__;
        ImagePopup.prototype.onwheel = function onwheel(ev) {
            var self = this;
            var dy, dx;
            [ev.stopPropagation(), ev.preventDefault()];
            dy = ev.deltaY;
            dx = ev.deltaX;
            if (ev.deltaMode === window.WheelEvent.DOM_DELTA_LINE) {
                dy *= 20;
                dx *= 20;
            }
            self.scroll_y(dy);
            self.scroll_x(dx);
        };
        if (!ImagePopup.prototype.onwheel.__argnames__) Object.defineProperties(ImagePopup.prototype.onwheel, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.onkeydown = function onkeydown(ev) {
            var self = this;
            [ev.preventDefault(), ev.stopPropagation()];
            if (ev.key === " ") {
                return self.toggle_fit_to_window();
            }
            if (ev.key === "Escape") {
                return self.hide_container();
            }
            if (ev.key === "ArrowDown") {
                return self.scroll_down((ev.getModifierState("Control")) ? window.innerHeight - 10 : 10);
            }
            if (ev.key === "PageDown") {
                return self.scroll_down(window.innerHeight - 10);
            }
            if (ev.key === "ArrowUp") {
                return self.scroll_up((ev.getModifierState("Control")) ? window.innerHeight - 10 : 10);
            }
            if (ev.key === "PageUp") {
                return self.scroll_up(window.innerHeight - 10);
            }
            if (ev.key === "ArrowLeft") {
                return self.scroll_left((ev.getModifierState("Control")) ? window.innerWidth - 10 : 10);
            }
            if (ev.key === "ArrowRight") {
                return self.scroll_right((ev.getModifierState("Control")) ? window.innerWidth - 10 : 10);
            }
        };
        if (!ImagePopup.prototype.onkeydown.__argnames__) Object.defineProperties(ImagePopup.prototype.onkeydown, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.handle_gesture = function handle_gesture(gesture) {
            var self = this;
            var delta;
            self.flick_animator.stop();
            if (gesture.type === "swipe") {
                if (!self.img_ok || self.fit_to_window) {
                    return;
                }
                if (gesture.points.length > 1 && !gesture.is_held) {
                    delta = (_expr_temp = gesture.points)[_expr_temp.length-2] - (_expr_temp = gesture.points)[_expr_temp.length-1];
                    if (Math.abs(delta) >= 1) {
                        if (gesture.axis === "vertical") {
                            self.scroll_y(delta);
                        } else {
                            self.scroll_x(delta);
                        }
                    }
                }
                if (!gesture.active && !gesture.is_held) {
                    self.flick_animator.start(gesture);
                }
            }
            if (gesture.type === "pinch" && self.img_ok) {
                if (gesture.direction === "in") {
                    self.fit_to_window = true;
                } else {
                    self.fit_to_window = false;
                }
                self.update_canvas();
            }
        };
        if (!ImagePopup.prototype.handle_gesture.__argnames__) Object.defineProperties(ImagePopup.prototype.handle_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.scroll_down = function scroll_down(amt) {
            var self = this;
            var canvas_height, miny, y;
            if (self.img_ok && !self.fit_to_window) {
                canvas_height = self.canvas_height;
                if (self.img.height <= canvas_height) {
                    return;
                }
                miny = canvas_height - self.img.height - self.vertical_max_bounce_distance;
                y = Math.max(self.y - amt, miny);
                if (y !== self.y) {
                    self.y = y;
                    self.update_canvas();
                }
            }
        };
        if (!ImagePopup.prototype.scroll_down.__argnames__) Object.defineProperties(ImagePopup.prototype.scroll_down, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.scroll_up = function scroll_up(amt) {
            var self = this;
            var canvas_height, y;
            if (self.img_ok && !self.fit_to_window) {
                canvas_height = self.canvas_height;
                if (self.img.height <= canvas_height) {
                    return;
                }
                y = Math.min(self.y + amt, self.vertical_max_bounce_distance);
                if (y !== self.y) {
                    self.y = y;
                    self.update_canvas();
                }
            }
        };
        if (!ImagePopup.prototype.scroll_up.__argnames__) Object.defineProperties(ImagePopup.prototype.scroll_up, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.scroll_right = function scroll_right(amt) {
            var self = this;
            var canvas_width, minx, x;
            if (self.img_ok && !self.fit_to_window) {
                canvas_width = self.canvas_width;
                if (self.img.width <= canvas_width) {
                    return;
                }
                minx = canvas_width - self.img.width - self.horizontal_max_bounce_distance;
                x = Math.max(self.x - amt, minx);
                if (x !== self.x) {
                    self.x = x;
                    self.update_canvas();
                }
            }
        };
        if (!ImagePopup.prototype.scroll_right.__argnames__) Object.defineProperties(ImagePopup.prototype.scroll_right, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.scroll_left = function scroll_left(amt) {
            var self = this;
            var canvas_width, x;
            if (self.img_ok && !self.fit_to_window) {
                canvas_width = self.canvas_width;
                if (self.img.width <= canvas_width) {
                    return;
                }
                x = Math.min(self.x + amt, self.horizontal_max_bounce_distance);
                if (x !== self.x) {
                    self.x = x;
                    self.update_canvas();
                }
            }
        };
        if (!ImagePopup.prototype.scroll_left.__argnames__) Object.defineProperties(ImagePopup.prototype.scroll_left, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.scroll_y = function scroll_y(amt) {
            var self = this;
            if (amt < 0) {
                self.scroll_up(-amt);
            } else if (amt > 0) {
                self.scroll_down(amt);
            }
        };
        if (!ImagePopup.prototype.scroll_y.__argnames__) Object.defineProperties(ImagePopup.prototype.scroll_y, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.scroll_x = function scroll_x(amt) {
            var self = this;
            if (amt < 0) {
                self.scroll_left(-amt);
            } else if (amt > 0) {
                self.scroll_right(amt);
            }
        };
        if (!ImagePopup.prototype.scroll_x.__argnames__) Object.defineProperties(ImagePopup.prototype.scroll_x, {
            __argnames__ : {value: ["amt"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.resize_canvas = function resize_canvas() {
            var self = this;
            var c, dpr, ctx;
            c = self.canvas;
            dpr = Math.max(1, window.devicePixelRatio);
            c.width = Math.ceil(window.innerWidth * dpr);
            c.height = Math.ceil(window.innerHeight * dpr);
            c.style.width = c.width / dpr + "px";
            c.style.height = c.height / dpr + "px";
            ctx = c.getContext("2d");
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            ctx.fillStyle = ctx.strokeStyle = "#eee";
            ctx.font = "16px sans-serif";
            self.update_canvas();
        };
        if (!ImagePopup.prototype.resize_canvas.__module__) Object.defineProperties(ImagePopup.prototype.resize_canvas, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.show_container = function show_container() {
            var self = this;
            self.flick_animator.stop();
            self.container.style.display = "block";
        };
        if (!ImagePopup.prototype.show_container.__module__) Object.defineProperties(ImagePopup.prototype.show_container, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.hide_container = function hide_container() {
            var self = this;
            self.flick_animator.stop();
            self.container.style.display = "none";
        };
        if (!ImagePopup.prototype.hide_container.__module__) Object.defineProperties(ImagePopup.prototype.hide_container, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.show_url = function show_url(url) {
            var self = this;
            self.img = new Image;
            self.img.addEventListener("load", self.image_loaded);
            self.img.addEventListener("error", self.image_failed);
            self.img_loading = true;
            self.x = self.y = 0;
            self.img_ok = false;
            self.fit_to_window = true;
            self.img.src = url;
            self.show_container();
            self.resize_canvas();
        };
        if (!ImagePopup.prototype.show_url.__argnames__) Object.defineProperties(ImagePopup.prototype.show_url, {
            __argnames__ : {value: ["url"]},
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.update_canvas = function update_canvas() {
            var self = this;
            var canvas, ctx, _unpack, canvas_width, canvas_height;
            canvas = self.canvas;
            ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            _unpack = [self.canvas_width, self.canvas_height];
            canvas_width = _unpack[0];
            canvas_height = _unpack[1];
            function draw_centered_text(text) {
                var tm, x, y;
                tm = ctx.measureText(text);
                x = Math.max(0, (canvas_width - tm.width) / 2);
                y = (canvas_height - 16) / 2;
                ctx.fillText(text, x, y);
            };
            if (!draw_centered_text.__argnames__) Object.defineProperties(draw_centered_text, {
                __argnames__ : {value: ["text"]},
                __module__ : {value: "image_popup"}
            });

            if (self.img_loading) {
                draw_centered_text(_("Loading image, please wait"));
                return;
            }
            if (!self.img_ok) {
                draw_centered_text(_("Loading the image failed"));
                return;
            }
            function draw_full_image_fit_to_canvas() {
                var _unpack, scaled, width, height, x, y;
                _unpack = fit_image(self.img.width, self.img.height, canvas_width, canvas_height);
_unpack = _unpack_asarray(3, _unpack);
                scaled = _unpack[0];
                width = _unpack[1];
                height = _unpack[2];
                scaled;
                x = (canvas_width - width) / 2;
                y = (canvas_height - height) / 2;
                ctx.drawImage(self.img, x, y, width, height);
            };
            if (!draw_full_image_fit_to_canvas.__module__) Object.defineProperties(draw_full_image_fit_to_canvas, {
                __module__ : {value: "image_popup"}
            });

            if (self.fit_to_window) {
                draw_full_image_fit_to_canvas();
                return;
            }
            ctx.drawImage(self.img, self.x, self.y);
        };
        if (!ImagePopup.prototype.update_canvas.__module__) Object.defineProperties(ImagePopup.prototype.update_canvas, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.toggle_fit_to_window = function toggle_fit_to_window() {
            var self = this;
            self.fit_to_window ^= true;
            self.x = self.y = 0;
            self.update_canvas();
        };
        if (!ImagePopup.prototype.toggle_fit_to_window.__module__) Object.defineProperties(ImagePopup.prototype.toggle_fit_to_window, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.image_loaded = function image_loaded() {
            var self = this;
            self.img_loading = false;
            self.img_ok = true;
            self.update_canvas();
        };
        if (!ImagePopup.prototype.image_loaded.__module__) Object.defineProperties(ImagePopup.prototype.image_loaded, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.image_failed = function image_failed() {
            var self = this;
            self.img_loading = false;
            self.img_ok = false;
            self.update_canvas();
        };
        if (!ImagePopup.prototype.image_failed.__module__) Object.defineProperties(ImagePopup.prototype.image_failed, {
            __module__ : {value: "image_popup"}
        });
        ImagePopup.prototype.__repr__ = function __repr__ () {
            if(TouchHandler.prototype.__repr__) return TouchHandler.prototype.__repr__.call(this);
            return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ImagePopup.prototype.__str__ = function __str__ () {
            if(TouchHandler.prototype.__str__) return TouchHandler.prototype.__str__.call(this);
return this.__repr__();
        };
        Object.defineProperty(ImagePopup.prototype, "__bases__", {value: [TouchHandler]});
        
        
        
        
        
        
        
        

        popup = null;
        function show_image(url) {
            if (popup === null) {
                popup = new ImagePopup;
            }
            popup.show_url(url);
        };
        if (!show_image.__argnames__) Object.defineProperties(show_image, {
            __argnames__ : {value: ["url"]},
            __module__ : {value: "image_popup"}
        });

        function develop(container) {
            show_image(absolute_path("get/cover/1698"));
        };
        if (!develop.__argnames__) Object.defineProperties(develop, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "image_popup"}
        });

        _modules.image_popup.popup = popup;
        _modules.image_popup.fit_image = fit_image;
        _modules.image_popup.ImagePopup = ImagePopup;
        _modules.image_popup.show_image = show_image;
        _modules.image_popup.develop = develop;
    })();

    (function(){
        var __name__ = "read_book.ui";
        var RENDER_VERSION, MATHJAX_VERSION;
        var E = _modules.elementmaker.E;

        var traceback = _modules.traceback;

        var ajax = _modules.ajax.ajax;
        var ajax_send = _modules.ajax.ajax_send;

        var read_book_container_id = _modules["book_list.constants"].read_book_container_id;

        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var library_data = _modules["book_list.library_data"].library_data;

        var home = _modules["book_list.router"].home;
        var push_state = _modules["book_list.router"].push_state;
        var read_book_mode = _modules["book_list.router"].read_book_mode;
        var update_window_title = _modules["book_list.router"].update_window_title;

        var show_panel = _modules["book_list.ui"].show_panel;

        var clear = _modules.dom.clear;

        var _ = _modules.gettext.gettext;

        var create_simple_dialog_markup = _modules.modals.create_simple_dialog_markup;
        var error_dialog = _modules.modals.error_dialog;

        var get_db = _modules["read_book.db"].get_db;

        var ui_operations = _modules["read_book.globals"].ui_operations;

        var Client = _modules["read_book.tts"].Client;

        var View = _modules["read_book.view"].View;

        var get_interface_data = _modules.session.get_interface_data;

        var debounce = _modules.utils.debounce;
        var full_screen_element = _modules.utils.full_screen_element;
        var human_readable = _modules.utils.human_readable;
        var request_full_screen = _modules.utils.request_full_screen;

        var create_button = _modules.widgets.create_button;

        var show_image = _modules.image_popup.show_image;

        RENDER_VERSION = 1;
        MATHJAX_VERSION = "7ab8013dfc2c395304109fe189c1772ef87b366a";
        function ReadUI() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            ReadUI.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperties(ReadUI.prototype,  {
            "url_data": {
                "enumerable": true, 
                "get": function url_data() {
                    var self = this;
                    var ans, bookpos;
                    ans = (function(){
                        var _d = Object.create(null);
                        _d["library_id"] = self.base_url_data.library_id;
                        _d["book_id"] = self.base_url_data.book_id;
                        _d["fmt"] = self.base_url_data.fmt;
                        return _d;
                    }).call(this);
                    bookpos = self.view.currently_showing.bookpos;
                    if (bookpos) {
                        ans.bookpos = bookpos;
                    }
                    return ans;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        ReadUI.prototype.__init__ = function __init__() {
            var self = this;
            var container;
            self.base_url_data = Object.create(null);
            self.current_metadata = (function(){
                var _d = Object.create(null);
                _d["title"] = _("Unknown book");
                return _d;
            }).call(this);
            self.current_book_id = null;
            self.manifest_xhr = null;
            self.pending_load = null;
            self.downloads_in_progress = _list_decorate([]);
            self.progress_id = "book-load-progress";
            self.display_id = "book-iframe-container";
            self.error_id = "book-global-error-container";
            self.stacked_widgets = _list_decorate([ self.progress_id, self.display_id, self.error_id ]);
            container = document.getElementById(read_book_container_id);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.h3, [_desugar_kwargs({style: "margin-top:30vh; margin-bottom: 1ex;"})]), _interpolate_kwargs.call(E, E.progress, [_desugar_kwargs({style: "margin: 1ex"})]), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 1ex"})])].concat([_desugar_kwargs({id: self.progress_id, style: "display:none; text-align: center"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: self.error_id, style: "display:none;"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: self.display_id, style: "display:none"})]));
            self.view = new View(container.lastChild);
            self.tts_client = new Client;
            self.windows_to_listen_for_messages_from = _list_decorate([]);
            window.addEventListener("resize", debounce(self.on_resize.bind(self), 250));
            window.addEventListener("message", self.message_from_other_window.bind(self));
            self.db = get_db(self.db_initialized.bind(self), self.show_error.bind(self));
            ui_operations.get_file = self.db.get_file;
            ui_operations.get_mathjax_files = self.db.get_mathjax_files;
            ui_operations.update_url_state = self.update_url_state.bind(self);
            ui_operations.update_last_read_time = self.db.update_last_read_time;
            ui_operations.show_error = self.show_error.bind(self);
            ui_operations.update_reading_rates = self.update_reading_rates.bind(self);
            ui_operations.redisplay_book = self.redisplay_book.bind(self);
            ui_operations.reload_book = self.reload_book.bind(self);
            ui_operations.forward_gesture = self.forward_gesture.bind(self);
            ui_operations.update_color_scheme = self.update_color_scheme.bind(self);
            ui_operations.update_font_size = self.update_font_size.bind(self);
            ui_operations.goto_cfi = self.goto_cfi.bind(self);
            ui_operations.goto_frac = self.goto_frac.bind(self);
            ui_operations.goto_book_position = self.goto_book_position.bind(self);
            ui_operations.goto_reference = self.goto_reference.bind(self);
            ui_operations.delete_book = self.delete_book.bind(self);
            ui_operations.focus_iframe = self.focus_iframe.bind(self);
            ui_operations.toggle_toc = self.toggle_toc.bind(self);
            ui_operations.toggle_full_screen = self.toggle_full_screen.bind(self);
            ui_operations.annots_changed = self.annots_changed.bind(self);
            ui_operations.annotations_synced = self.annotations_synced.bind(self);
            ui_operations.wait_for_messages_from = self.wait_for_messages_from.bind(self);
            ui_operations.stop_waiting_for_messages_from = self.stop_waiting_for_messages_from.bind(self);
            ui_operations.update_metadata = self.update_metadata.bind(self);
            ui_operations.close_book = self.close_book.bind(self);
            ui_operations.copy_image = self.copy_image.bind(self);
            ui_operations.view_image = self.view_image.bind(self);
            ui_operations.speak_simple_text = self.speak_simple_text.bind(self);
            ui_operations.tts = self.tts.bind(self);
            ui_operations.search_result_discovered = self.view.search_overlay.search_result_discovered;
            ui_operations.search_result_not_found = self.view.search_overlay.search_result_not_found;
            ui_operations.find_next = self.view.search_overlay.find_next;
            ui_operations.open_url = (function() {
                var _anonfunc = function (url) {
                    window.open(url, "_blank");
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["url"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })();
            ui_operations.show_help = (function() {
                var _anonfunc = function (which) {
                    var path, url;
                    if (which === "viewer") {
                        path = "/viewer.html";
                    } else {
                        return;
                    }
                    if (get_interface_data().lang_code_for_user_manual) {
                        path = "/" + _str.format("{}", get_interface_data().lang_code_for_user_manual) + "" + _str.format("{}", path) + "";
                    }
                    url = "https://manual.calibre-ebook.com" + path;
                    window.open(url, "_blank");
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["which"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })();
            ui_operations.copy_selection = (function() {
                var _anonfunc = function (text, html) {
                    var active_elem, ta, ok;
                    active_elem = document.activeElement;
                    ta = document.createElement("textarea");
                    ta.value = text;
                    ta.style.position = "absolute";
                    ta.style.top = window.innerHeight + "px";
                    ta.style.left = window.innerWidth + "px";
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    ok = false;
                    try {
                        ok = document.execCommand("copy");
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                        } 
                    }
                    document.body.removeChild(ta);
                    if (active_elem) {
                        active_elem.focus();
                    }
                    if (ok) {
                        return;
                    }
                    if (!window.navigator.clipboard) {
                        return error_dialog(_("No clipboard access"), _("Your browser requires you to access the Content server over an HTTPS connection to be able to copy to clipboard."));
                    }
                    window.navigator.clipboard.writeText(text || "").then((function() {
                        var _anonfunc = function () {
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.ui"}
                        });
                        return _anonfunc;
                    })(), (function() {
                        var _anonfunc = function () {
                            error_dialog(_("Could not copy to clipboard"), _("No permission to write to clipboard"));
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.ui"}
                        });
                        return _anonfunc;
                    })());
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["text", "html"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })();
            ui_operations.get_all_profiles = (function() {
                var _anonfunc = function (proceed) {
                    ajax("reader-profiles/get-all", (function() {
                        var _anonfunc = function (end_type, xhr, ev) {
                            var result;
                            if (end_type !== "load") {
                                if (end_type === "abort") {
                                    return;
                                }
                                return self.show_error(_("Failed to load profiles"), _("Could not load profiles: with error: {}").format(xhr.error_html));
                            }
                            try {
                                result = JSON.parse(xhr.responseText);
                            } catch (_Exception) {
                                _last_exception = _Exception;
                                if (_Exception instanceof Error) {
                                    return self.show_error(_("Failed to parse profiles"), _("Unparseable data received for profiles"));
                                } else {
                                    throw _Exception;
                                }
                            }
                            proceed(result);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["end_type", "xhr", "ev"]},
                            __module__ : {value: "read_book.ui"}
                        });
                        return _anonfunc;
                    })()).send();
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["proceed"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })();
            ui_operations.save_profile = (function() {
                var _anonfunc = function (profile_name, profile, proceed) {
                    ajax_send("reader-profiles/save", (function(){
                        var _d = Object.create(null);
                        _d["name"] = profile_name;
                        _d["profile"] = profile;
                        return _d;
                    }).call(this), (function() {
                        var _anonfunc = function (end_type, xhr, ev) {
                            if (end_type !== "load") {
                                if (end_type === "abort") {
                                    return;
                                }
                                return self.show_error(_("Failed to load profiles"), _("Could not load profiles: with error: {}").format(xhr.error_html));
                            }
                            proceed();
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["end_type", "xhr", "ev"]},
                            __module__ : {value: "read_book.ui"}
                        });
                        return _anonfunc;
                    })());
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["profile_name", "profile", "proceed"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })();
        };
        if (!ReadUI.prototype.__init__.__module__) Object.defineProperties(ReadUI.prototype.__init__, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.__argnames__ = ReadUI.prototype.__init__.__argnames__;
        ReadUI.__handles_kwarg_interpolation__ = ReadUI.prototype.__init__.__handles_kwarg_interpolation__;
        ReadUI.prototype.on_resize = function on_resize() {
            var self = this;
            self.view.on_resize();
        };
        if (!ReadUI.prototype.on_resize.__module__) Object.defineProperties(ReadUI.prototype.on_resize, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.show_stack = function show_stack(name) {
            var self = this;
            var ans, d, v, w;
            ans = null;
            var _Iter0 = _Iterable(self.stacked_widgets);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                w = _Iter0[_Index0];
                d = document.getElementById(w);
                v = "none";
                if (name === w) {
                    ans = d;
                    v = "block";
                }
                d.style.display = v;
            }
            return ans;
        };
        if (!ReadUI.prototype.show_stack.__argnames__) Object.defineProperties(ReadUI.prototype.show_stack, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.show_error = function show_error(title, msg, details) {
            var self = this;
            var div, book, dp, q;
            div = self.show_stack(self.error_id);
            clear(div);
            if (self.current_metadata) {
                book = self.current_metadata.title;
            } else if (self.current_book_id) {
                book = _("Book id #{}").format(self.current_book_id);
            } else {
                book = _("book");
            }
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "padding: 2ex 2rem; display:table; margin: auto"})]));
            div = div.lastChild;
            dp = E.div();
            create_simple_dialog_markup(title, _("Could not open {}. {}").format(book, msg), details, "bug", "", "red", dp);
            div.appendChild(dp);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Go back to:"), E.br(), E.br(), create_button(_("Home"), "home", (function() {
                var _anonfunc = function () {
                    home(true);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })())].concat([_desugar_kwargs({style: "margin-top: 1ex; padding-top: 1ex; border-top: solid 1px currentColor"})])));
            q = Object.create(null);
            if (self.current_book_id) {
                q.book_id = self.current_book_id + "";
            }
            q.close_action = "home";
            div.lastChild.appendChild(E.span("", create_button(_("Book list"), "library", (function() {
                var _anonfunc = function () {
                    show_panel("book_list", q, true);
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })())));
            if (self.current_book_id) {
                q.close_action = "book_list";
                div.lastChild.appendChild(E.span("", create_button(_("Book details"), "book", (function() {
                    var _anonfunc = function () {
                        show_panel("book_details", q, true);
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "read_book.ui"}
                    });
                    return _anonfunc;
                })())));
            }
        };
        if (!ReadUI.prototype.show_error.__argnames__) Object.defineProperties(ReadUI.prototype.show_error, {
            __argnames__ : {value: ["title", "msg", "details"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.init_ui = function init_ui() {
            var self = this;
            var div, pr;
            div = self.show_stack(self.progress_id);
            if (self.current_metadata) {
                div.firstChild.textContent = _("Downloading {0} for offline reading, please wait...").format(self.current_metadata.title);
            } else {
                div.firstChild.textContent = "";
            }
            pr = div.firstChild.nextSibling;
            [pr.removeAttribute("value"), pr.removeAttribute("max")];
            div.lastChild.textContent = _("Downloading book manifest...");
        };
        if (!ReadUI.prototype.init_ui.__module__) Object.defineProperties(ReadUI.prototype.init_ui, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.show_progress_message = function show_progress_message(msg) {
            var self = this;
            var div;
            div = document.getElementById(self.progress_id);
            div.lastChild.textContent = msg || "";
        };
        if (!ReadUI.prototype.show_progress_message.__argnames__) Object.defineProperties(ReadUI.prototype.show_progress_message, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.close_book = function close_book() {
            var self = this;
            self.base_url_data = Object.create(null);
        };
        if (!ReadUI.prototype.close_book.__module__) Object.defineProperties(ReadUI.prototype.close_book, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.copy_image = function copy_image(image_file_name) {
            var self = this;
            if (!_exists.d(self.view).book) {
                return;
            }
            ui_operations.get_file(self.view.book, image_file_name, (function() {
                var _anonfunc = function (blob, name, mimetype) {
                    try {
                        window.navigator.clipboard.write(_list_decorate([ new ClipboardItem((function(){
                            var _d = Object.create(null);
                            _d[mimetype] = blob;
                            return _d;
                        }).call(this)) ]));
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        if (_Exception instanceof Error) {
                            var err = _Exception;
                            error_dialog(_("Could not copy image"), str(err));
                        } else {
                            throw _Exception;
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["blob", "name", "mimetype"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })());
        };
        if (!ReadUI.prototype.copy_image.__argnames__) Object.defineProperties(ReadUI.prototype.copy_image, {
            __argnames__ : {value: ["image_file_name"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.view_image = function view_image(image_file_name) {
            var self = this;
            if (!_exists.d(self.view).book) {
                return;
            }
            ui_operations.get_file(self.view.book, image_file_name, (function() {
                var _anonfunc = function (blob, name, mimetype) {
                    var url;
                    url = window.URL.createObjectURL(blob);
                    show_image(url);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["blob", "name", "mimetype"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })());
        };
        if (!ReadUI.prototype.view_image.__argnames__) Object.defineProperties(ReadUI.prototype.view_image, {
            __argnames__ : {value: ["image_file_name"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.load_book = function load_book(library_id, book_id, fmt, metadata, force_reload) {
            var self = this;
            self.base_url_data = (function(){
                var _d = Object.create(null);
                _d["library_id"] = library_id;
                _d["book_id"] = book_id;
                _d["fmt"] = fmt;
                return _d;
            }).call(this);
            if (!self.db.initialized) {
                self.pending_load = _list_decorate([ book_id, fmt, metadata, force_reload ]);
                return;
            }
            if (!self.db.is_ok) {
                self.show_error(_("Cannot read books"), self.db.initialize_error_msg);
                return;
            }
            self.start_load(book_id, fmt, metadata, force_reload);
        };
        if (!ReadUI.prototype.load_book.__argnames__) Object.defineProperties(ReadUI.prototype.load_book, {
            __argnames__ : {value: ["library_id", "book_id", "fmt", "metadata", "force_reload"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.reload_book = function reload_book() {
            var self = this;
            var _unpack, library_id, book_id, fmt, metadata;
            _unpack = [self.base_url_data.library_id, self.base_url_data.book_id, self.base_url_data.fmt];
            library_id = _unpack[0];
            book_id = _unpack[1];
            fmt = _unpack[2];
            metadata = self.metadata || (_expr_temp = library_data.metadata)[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id];
            self.load_book(library_id, book_id, fmt, metadata, true);
        };
        if (!ReadUI.prototype.reload_book.__module__) Object.defineProperties(ReadUI.prototype.reload_book, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.redisplay_book = function redisplay_book() {
            var self = this;
            self.view.redisplay_book();
        };
        if (!ReadUI.prototype.redisplay_book.__module__) Object.defineProperties(ReadUI.prototype.redisplay_book, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.forward_gesture = function forward_gesture(gesture) {
            var self = this;
            self.view.forward_gesture(gesture);
        };
        if (!ReadUI.prototype.forward_gesture.__argnames__) Object.defineProperties(ReadUI.prototype.forward_gesture, {
            __argnames__ : {value: ["gesture"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.update_font_size = function update_font_size() {
            var self = this;
            self.view.update_font_size();
        };
        if (!ReadUI.prototype.update_font_size.__module__) Object.defineProperties(ReadUI.prototype.update_font_size, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.goto_cfi = function goto_cfi(bookpos) {
            var self = this;
            return self.view.goto_cfi(bookpos);
        };
        if (!ReadUI.prototype.goto_cfi.__argnames__) Object.defineProperties(ReadUI.prototype.goto_cfi, {
            __argnames__ : {value: ["bookpos"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.goto_frac = function goto_frac(frac) {
            var self = this;
            return self.view.goto_frac(frac);
        };
        if (!ReadUI.prototype.goto_frac.__argnames__) Object.defineProperties(ReadUI.prototype.goto_frac, {
            __argnames__ : {value: ["frac"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.goto_book_position = function goto_book_position(bpos) {
            var self = this;
            return self.view.goto_book_position(bpos);
        };
        if (!ReadUI.prototype.goto_book_position.__argnames__) Object.defineProperties(ReadUI.prototype.goto_book_position, {
            __argnames__ : {value: ["bpos"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.goto_reference = function goto_reference(ref) {
            var self = this;
            return self.view.goto_reference(ref);
        };
        if (!ReadUI.prototype.goto_reference.__argnames__) Object.defineProperties(ReadUI.prototype.goto_reference, {
            __argnames__ : {value: ["ref"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.delete_book = function delete_book(book, proceed) {
            var self = this;
            self.db.delete_book(book, proceed);
        };
        if (!ReadUI.prototype.delete_book.__argnames__) Object.defineProperties(ReadUI.prototype.delete_book, {
            __argnames__ : {value: ["book", "proceed"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.focus_iframe = function focus_iframe() {
            var self = this;
            self.view.focus_iframe();
        };
        if (!ReadUI.prototype.focus_iframe.__module__) Object.defineProperties(ReadUI.prototype.focus_iframe, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.toggle_toc = function toggle_toc() {
            var self = this;
            self.view.overlay.show_toc();
        };
        if (!ReadUI.prototype.toggle_toc.__module__) Object.defineProperties(ReadUI.prototype.toggle_toc, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.toggle_full_screen = function toggle_full_screen() {
            var self = this;
            if (full_screen_element()) {
                document.exitFullscreen();
            } else {
                request_full_screen(document.documentElement);
            }
        };
        if (!ReadUI.prototype.toggle_full_screen.__module__) Object.defineProperties(ReadUI.prototype.toggle_full_screen, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.update_color_scheme = function update_color_scheme() {
            var self = this;
            self.view.update_color_scheme();
        };
        if (!ReadUI.prototype.update_color_scheme.__module__) Object.defineProperties(ReadUI.prototype.update_color_scheme, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.annots_changed = function annots_changed(amap) {
            var self = this;
            var library_id, book_id, fmt;
            library_id = self.base_url_data.library_id;
            book_id = self.base_url_data.book_id;
            fmt = self.base_url_data.fmt;
            self.db.update_annotations_data_from_key(library_id, book_id, fmt, (function(){
                var _d = Object.create(null);
                _d["annotations_map"] = amap;
                return _d;
            }).call(this));
            ajax_send("book-update-annotations/" + _str.format("{}", library_id) + "/" + _str.format("{}", book_id) + "/" + _str.format("{}", fmt) + "", amap, (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })());
        };
        if (!ReadUI.prototype.annots_changed.__argnames__) Object.defineProperties(ReadUI.prototype.annots_changed, {
            __argnames__ : {value: ["amap"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.annotations_synced = function annotations_synced(amap) {
            var self = this;
            var library_id, book_id, fmt;
            library_id = self.base_url_data.library_id;
            book_id = self.base_url_data.book_id;
            fmt = self.base_url_data.fmt;
            self.db.update_annotations_data_from_key(library_id, book_id, fmt, (function(){
                var _d = Object.create(null);
                _d["annotations_map"] = amap;
                return _d;
            }).call(this));
        };
        if (!ReadUI.prototype.annotations_synced.__argnames__) Object.defineProperties(ReadUI.prototype.annotations_synced, {
            __argnames__ : {value: ["amap"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.db_initialized = function db_initialized() {
            var self = this;
            var _unpack, pl;
            if (!self.db.is_ok) {
                error_dialog(_("Could not initialize database"), self.db.initialize_error_msg);
                return;
            }
            if (self.pending_load !== null) {
                _unpack = [self.pending_load, null];
                pl = _unpack[0];
                self.pending_load = _unpack[1];
                if (self.db.initialize_error_msg) {
                    self.show_error(_("Failed to initialize IndexedDB"), self.db.initialize_error_msg);
                } else {
                    self.start_load.apply(self, pl);
                }
            }
        };
        if (!ReadUI.prototype.db_initialized.__module__) Object.defineProperties(ReadUI.prototype.db_initialized, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.start_load = function start_load(book_id, fmt, metadata, force_reload) {
            var self = this;
            self.current_book_id = book_id;
            self.current_book_fmt = fmt;
            metadata = metadata || (_expr_temp = library_data.metadata)[(typeof book_id === "number" && book_id < 0) ? _expr_temp.length + book_id : book_id];
            self.current_metadata = metadata || (function(){
                var _d = Object.create(null);
                _d["title"] = _("Book id #") + book_id;
                return _d;
            }).call(this);
            update_window_title("", self.current_metadata.title);
            self.init_ui();
            if (typeof self.db === "string") {
                self.show_error(_("Cannot read book"), self.db);
                return;
            }
            self.db.get_book(current_library_id(), book_id, fmt, metadata, self.got_book.bind(self, force_reload));
        };
        if (!ReadUI.prototype.start_load.__argnames__) Object.defineProperties(ReadUI.prototype.start_load, {
            __argnames__ : {value: ["book_id", "fmt", "metadata", "force_reload"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.got_book = function got_book(force_reload, book) {
            var self = this;
            if (!book.manifest || book.manifest.version !== RENDER_VERSION || !book.is_complete) {
                self.get_manifest(book, force_reload);
            } else {
                self.display_book(book);
            }
        };
        if (!ReadUI.prototype.got_book.__argnames__) Object.defineProperties(ReadUI.prototype.got_book, {
            __argnames__ : {value: ["force_reload", "book"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.get_manifest = function get_manifest(book, force_reload) {
            var self = this;
            var _unpack, library_id, book_id, fmt, query;
            _unpack = book.key;
_unpack = _unpack_asarray(3, _unpack);
            library_id = _unpack[0];
            book_id = _unpack[1];
            fmt = _unpack[2];
            if (self.manifest_xhr) {
                self.manifest_xhr.abort();
            }
            query = (function(){
                var _d = Object.create(null);
                _d["library_id"] = library_id;
                return _d;
            }).call(this);
            if (force_reload) {
                query.force_reload = "1";
            }
            self.manifest_xhr = _interpolate_kwargs.call(this, ajax, ["book-manifest/" + encodeURIComponent(book_id) + "/" + encodeURIComponent(fmt), self.got_manifest.bind(self, book)].concat([_desugar_kwargs({query: query})]));
            self.manifest_xhr.send();
        };
        if (!ReadUI.prototype.get_manifest.__argnames__) Object.defineProperties(ReadUI.prototype.get_manifest, {
            __argnames__ : {value: ["book", "force_reload"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.got_manifest = function got_manifest(book, end_type, xhr, ev) {
            var self = this;
            var fmt, manifest, msg;
            self.manifest_xhr = null;
            if (end_type === "abort") {
                return;
            }
            if (end_type !== "load") {
                if (xhr.status === 404) {
                    fmt = (self.current_book_fmt || "UNKNOWN").toUpperCase();
                    if (_in("cannot be viewed", xhr.error_html)) {
                        return self.show_error(_("Failed to view book"), _("Viewing of the {} format is not supported.").format(fmt), xhr.error_html);
                    }
                    return self.show_error(_("Failed to view book"), _("The {} format is not available.").format(fmt), xhr.error_html);
                }
                return self.show_error(_("Failed to load book manifest"), (_expr_temp = _("The book manifest failed to load, click \"Show details\" for more information."), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({title: self.current_metadata.title})])), xhr.error_html);
            }
            try {
                manifest = JSON.parse(xhr.responseText);
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof Error) {
                    return self.show_error(_("Failed to load book manifest"), (_expr_temp = _("The manifest for {title} is not valid"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({title: self.current_metadata.title})])), traceback.format_exc());
                } else {
                    throw _Exception;
                }
            }
            if (manifest.version !== undefined) {
                if (manifest.version !== RENDER_VERSION) {
                    print("calibre upgraded: RENDER_VERSION={} manifest.version={}".format(RENDER_VERSION, manifest.version));
                    return self.show_error(_("calibre upgraded!"), _("A newer version of calibre is available, please click the Reload button in your browser."));
                }
                self.current_metadata = manifest.metadata;
                self.db.save_manifest(book, manifest, self.download_book.bind(self, book));
                return;
            }
            msg = _("Downloading book manifest...");
            if (manifest.job_status === "finished") {
                if (manifest.aborted) {
                    return self.show_error(_("Failed to prepare book for reading"), _("Preparation of book for reading was aborted because it took too long"));
                }
                if (manifest.traceback) {
                    return self.show_error(_("Failed to prepare book for reading"), _("There was an error processing the book, click \"Show details\" for more information"), manifest.traceback || "");
                }
            } else if (manifest.job_status === "waiting") {
                msg = _("Book is queued for processing on the server...");
            } else if (manifest.job_status === "running") {
                msg = _("Book is being prepared for reading on the server...");
            }
            self.show_progress_message(msg);
            setTimeout(self.get_manifest.bind(self, book), 100);
        };
        if (!ReadUI.prototype.got_manifest.__argnames__) Object.defineProperties(ReadUI.prototype.got_manifest, {
            __argnames__ : {value: ["book", "end_type", "xhr", "ev"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.download_book = function download_book(book) {
            var self = this;
            var files, total, cover_total_updated, name, files_left, failed_files, xhr, progress, pbar, _unpack, library_id, book_id, fmt, base_path, query, progress_track, raster_cover_name, nnum, base, inserted_name, raster_cover_size, count, queued, fname;
            files = book.manifest.files;
            total = 0;
            cover_total_updated = false;
            var _Iter1 = _Iterable(files);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                name = _Iter1[_Index1];
                total += files[(typeof name === "number" && name < 0) ? files.length + name : name].size;
            }
            files_left = set(book.manifest.files);
            failed_files = _list_decorate([]);
            var _Iter2 = _Iterable(self.downloads_in_progress);
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                xhr = _Iter2[_Index2];
                xhr.abort();
            }
            self.downloads_in_progress = _list_decorate([]);
            progress = document.getElementById(self.progress_id);
            pbar = progress.firstChild.nextSibling;
            _unpack = book.key;
_unpack = _unpack_asarray(3, _unpack);
            library_id = _unpack[0];
            book_id = _unpack[1];
            fmt = _unpack[2];
            base_path = "book-file/{}/{}/{}/{}/".format(encodeURIComponent(book_id), encodeURIComponent(fmt), encodeURIComponent(book.manifest.book_hash.size), encodeURIComponent(book.manifest.book_hash.mtime));
            query = (function(){
                var _d = Object.create(null);
                _d["library_id"] = library_id;
                return _d;
            }).call(this);
            progress_track = Object.create(null);
            pbar.setAttribute("max", total + "");
            raster_cover_name = book.manifest.raster_cover_name;
            if (!raster_cover_name) {
                nnum = 1;
                base = "raster-cover-image-{}.jpg";
                inserted_name = base.format(nnum);
                while (_in(inserted_name, files_left)) {
                    nnum += 1;
                    inserted_name = base.format(nnum);
                }
                raster_cover_name = inserted_name;
                files_left.add(raster_cover_name);
            }
            raster_cover_size = 0;
            function update_progress() {
                var x, name, msg;
                x = 0;
                var _Iter3 = _Iterable(progress_track);
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    name = _Iter3[_Index3];
                    x += progress_track[(typeof name === "number" && name < 0) ? progress_track.length + name : name];
                }
                pbar.setAttribute("value", x + "");
                if (x === total) {
                    msg = _("Downloaded {}, saving to disk. This may take a few seconds...").format(human_readable(total));
                } else {
                    msg = _("Downloaded {0}, {1} left").format(human_readable(x), human_readable(total - x));
                }
                progress.lastChild.textContent = msg;
            };
            if (!update_progress.__module__) Object.defineProperties(update_progress, {
                __module__ : {value: "read_book.ui"}
            });

            function show_failure() {
                var det;
                det = (function() {
                    var _Iter = _Iterable(failed_files), _Result = [], fname, err_html;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        _unpack = _Iter[_Index];
                        fname = _unpack[0];
                        err_html = _unpack[1];
                        _Result.push("<h4>{}</h4><div>{}</div><hr>".format(fname, err_html));
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })().join("");
                self.show_error(_("Could not download book"), _("Failed to download some book data, click \"Show details\" for more information"), det);
            };
            if (!show_failure.__module__) Object.defineProperties(show_failure, {
                __module__ : {value: "read_book.ui"}
            });

            function on_stored(err) {
                files_left.discard(this);
                if (err) {
                    failed_files.append(_list_decorate([ this, err ]));
                }
                if (len(files_left)) {
                    return;
                }
                if (failed_files.length) {
                    return show_failure();
                }
                self.db.finish_book(book, self.display_book.bind(self, book));
            };
            if (!on_stored.__argnames__) Object.defineProperties(on_stored, {
                __argnames__ : {value: ["err"]},
                __module__ : {value: "read_book.ui"}
            });

            function on_complete(end_type, xhr, ev) {
                var fname;
                self.downloads_in_progress.remove(xhr);
                progress_track[_bound_index(this, progress_track)] = (this === raster_cover_name) ? raster_cover_size : files[_bound_index(this, files)].size;
                update_progress();
                if (len(queued)) {
                    var _Iter4 = _Iterable(queued);
                    for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                        fname = _Iter4[_Index4];
                        start_download(fname, base_path + encodeURIComponent(fname).replace(/%2[fF]/g, "/"));
                        queued.discard(fname);
                        break;
                    }
                }
                if (end_type === "abort") {
                    files_left.discard(this);
                    return;
                }
                if (end_type === "load") {
                    self.db.store_file(book, this, xhr, on_stored.bind(this), this === raster_cover_name);
                } else {
                    failed_files.append(_list_decorate([ this, xhr.error_html ]));
                    files_left.discard(this);
                    if (!len(files_left)) {
                        show_failure();
                    }
                }
            };
            if (!on_complete.__argnames__) Object.defineProperties(on_complete, {
                __argnames__ : {value: ["end_type", "xhr", "ev"]},
                __module__ : {value: "read_book.ui"}
            });

            function on_progress(loaded, ftotal) {
                if (this === raster_cover_name && !cover_total_updated) {
                    raster_cover_size = ftotal;
                    cover_total_updated = true;
                    total = total - (_exists.d(files[(typeof raster_cover_name === "number" && raster_cover_name < 0) ? files.length + raster_cover_name : raster_cover_name]).size || 0) + raster_cover_size;
                    pbar.setAttribute("max", total + "");
                }
                progress_track[_bound_index(this, progress_track)] = loaded;
                update_progress();
            };
            if (!on_progress.__argnames__) Object.defineProperties(on_progress, {
                __argnames__ : {value: ["loaded", "ftotal"]},
                __module__ : {value: "read_book.ui"}
            });

            function start_download(fname, path) {
                var xhr;
                xhr = _interpolate_kwargs.call(this, ajax, [path, on_complete.bind(fname)].concat([_desugar_kwargs({on_progress: on_progress.bind(fname), query: query, progress_totals_needed: fname === raster_cover_name})]));
                xhr.responseType = "text";
                if (!_exists.d((_expr_temp = book.manifest.files)[(typeof fname === "number" && fname < 0) ? _expr_temp.length + fname : fname]).is_virtualized) {
                    xhr.responseType = (self.db.supports_blobs) ? "blob" : "arraybuffer";
                }
                xhr.send();
                self.downloads_in_progress.append(xhr);
            };
            if (!start_download.__argnames__) Object.defineProperties(start_download, {
                __argnames__ : {value: ["fname", "path"]},
                __module__ : {value: "read_book.ui"}
            });

            if (raster_cover_name) {
                start_download(raster_cover_name, "get/cover/" + book_id + "/" + encodeURIComponent(library_id));
            }
            count = 0;
            queued = set();
            var _Iter5 = _Iterable(files_left);
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                fname = _Iter5[_Index5];
                if (fname !== raster_cover_name) {
                    count += 1;
                    if (count < 20) {
                        start_download(fname, base_path + encodeURIComponent(fname).replace(/%2[fF]/g, "/"));
                    } else {
                        queued.add(fname);
                    }
                }
            }
        };
        if (!ReadUI.prototype.download_book.__argnames__) Object.defineProperties(ReadUI.prototype.download_book, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.ensure_maths = function ensure_maths(proceed) {
            var self = this;
            self.db.get_mathjax_info((function() {
                var _anonfunc = function (mathjax_info) {
                    if (mathjax_info.version === MATHJAX_VERSION) {
                        return proceed();
                    }
                    print("Upgrading MathJax, previous version:", mathjax_info.version);
                    self.db.clear_mathjax((function() {
                        var _anonfunc = function () {
                            self.get_mathjax_manifest(mathjax_info, proceed);
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "read_book.ui"}
                        });
                        return _anonfunc;
                    })());
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["mathjax_info"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })());
        };
        if (!ReadUI.prototype.ensure_maths.__argnames__) Object.defineProperties(ReadUI.prototype.ensure_maths, {
            __argnames__ : {value: ["proceed"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.get_mathjax_manifest = function get_mathjax_manifest(mathjax_info, proceed) {
            var self = this;
            ajax("mathjax", (function() {
                var _anonfunc = function (end_type, xhr, event) {
                    var manifest;
                    if (end_type === "abort") {
                        return;
                    }
                    if (end_type !== "load") {
                        return self.show_error(_("Failed to load MathJax manifest"), (_expr_temp = _("The MathJax manifest failed to load, click \"Show details\" for more information."), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({title: self.current_metadata.title})])), xhr.error_html);
                    }
                    try {
                        manifest = JSON.parse(xhr.responseText);
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        if (_Exception instanceof Error) {
                            return self.show_error(_("Failed to load MathJax manifest"), _("The MathJax manifest is not valid"), traceback.format_exc());
                        } else {
                            throw _Exception;
                        }
                    }
                    if (manifest.etag !== MATHJAX_VERSION) {
                        print("calibre upgraded: MATHJAX_VERSION={} manifest.etag={}".format(MATHJAX_VERSION, manifest.etag));
                        return self.show_error(_("calibre upgraded!"), _("A newer version of calibre is available, please click the Reload button in your browser."));
                    }
                    mathjax_info.version = manifest.etag;
                    mathjax_info.files = manifest.files;
                    self.download_mathjax(mathjax_info, proceed);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["end_type", "xhr", "event"]},
                    __module__ : {value: "read_book.ui"}
                });
                return _anonfunc;
            })()).send();
        };
        if (!ReadUI.prototype.get_mathjax_manifest.__argnames__) Object.defineProperties(ReadUI.prototype.get_mathjax_manifest, {
            __argnames__ : {value: ["mathjax_info", "proceed"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.download_mathjax = function download_mathjax(mathjax_info, proceed) {
            var self = this;
            var files, total, progress_track, files_left, failed_files, key, progress, pbar, xhr, fname;
            files = mathjax_info.files;
            total = 0;
            progress_track = Object.create(null);
            files_left = set();
            failed_files = _list_decorate([]);
            var _Iter6 = _Iterable(files);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                key = _Iter6[_Index6];
                total += files[(typeof key === "number" && key < 0) ? files.length + key : key];
                progress_track[(typeof key === "number" && key < 0) ? progress_track.length + key : key] = 0;
                files_left.add(key);
            }
            progress = document.getElementById(self.progress_id);
            progress.firstChild.textContent = _("Downloading MathJax to render mathematics in this book...");
            pbar = progress.firstChild.nextSibling;
            pbar.setAttribute("max", total + "");
            var _Iter7 = _Iterable(self.downloads_in_progress);
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                xhr = _Iter7[_Index7];
                xhr.abort();
            }
            self.downloads_in_progress = _list_decorate([]);
            function update_progress() {
                var x, name, msg;
                x = 0;
                var _Iter8 = _Iterable(progress_track);
                for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                    name = _Iter8[_Index8];
                    x += progress_track[(typeof name === "number" && name < 0) ? progress_track.length + name : name];
                }
                pbar.setAttribute("value", x + "");
                if (x === total) {
                    msg = _("Downloaded {}, saving to disk. This may take a few seconds...").format(human_readable(total));
                } else {
                    msg = _("Downloaded {0}, {1} left").format(human_readable(x), human_readable(total - x));
                }
                progress.lastChild.textContent = msg;
            };
            if (!update_progress.__module__) Object.defineProperties(update_progress, {
                __module__ : {value: "read_book.ui"}
            });

            function on_progress(loaded, ftotal) {
                progress_track[_bound_index(this, progress_track)] = loaded;
                update_progress();
            };
            if (!on_progress.__argnames__) Object.defineProperties(on_progress, {
                __argnames__ : {value: ["loaded", "ftotal"]},
                __module__ : {value: "read_book.ui"}
            });

            function show_failure() {
                var det;
                det = (function() {
                    var _Iter = _Iterable(failed_files), _Result = [], fname, err_html;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        _unpack = _Iter[_Index];
                        fname = _unpack[0];
                        err_html = _unpack[1];
                        _Result.push("<h4>{}</h4><div>{}</div><hr>".format(fname, err_html));
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })().join("");
                self.show_error(_("Could not download MathJax"), _("Failed to download some MathJax data, click \"Show details\" for more information"), det);
            };
            if (!show_failure.__module__) Object.defineProperties(show_failure, {
                __module__ : {value: "read_book.ui"}
            });

            function on_complete(end_type, xhr, ev) {
                self.downloads_in_progress.remove(xhr);
                progress_track[_bound_index(this, progress_track)] = files[_bound_index(this, files)];
                update_progress();
                if (end_type === "abort") {
                    files_left.discard(this);
                    return;
                }
                if (end_type === "load") {
                    self.db.store_mathjax_file(this, xhr, on_stored.bind(this));
                } else {
                    failed_files.append(_list_decorate([ this, xhr.error_html ]));
                    files_left.discard(this);
                    if (!len(files_left)) {
                        show_failure();
                    }
                }
            };
            if (!on_complete.__argnames__) Object.defineProperties(on_complete, {
                __argnames__ : {value: ["end_type", "xhr", "ev"]},
                __module__ : {value: "read_book.ui"}
            });

            function on_stored(err) {
                files_left.discard(this);
                if (err) {
                    failed_files.append(_list_decorate([ this, err ]));
                }
                if (len(files_left)) {
                    return;
                }
                if (failed_files.length) {
                    return show_failure();
                }
                self.db.finish_mathjax(mathjax_info, proceed);
            };
            if (!on_stored.__argnames__) Object.defineProperties(on_stored, {
                __argnames__ : {value: ["err"]},
                __module__ : {value: "read_book.ui"}
            });

            function start_download(name) {
                var path, xhr;
                path = "mathjax/" + name;
                xhr = _interpolate_kwargs.call(this, ajax, [path, on_complete.bind(name)].concat([_desugar_kwargs({on_progress: on_progress.bind(name), progress_totals_needed: false})]));
                xhr.responseType = (self.db.supports_blobs) ? "blob" : "arraybuffer";
                xhr.send();
                self.downloads_in_progress.push(xhr);
            };
            if (!start_download.__argnames__) Object.defineProperties(start_download, {
                __argnames__ : {value: ["name"]},
                __module__ : {value: "read_book.ui"}
            });

            var _Iter9 = _Iterable(files_left);
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                fname = _Iter9[_Index9];
                start_download(fname);
            }
        };
        if (!ReadUI.prototype.download_mathjax.__argnames__) Object.defineProperties(ReadUI.prototype.download_mathjax, {
            __argnames__ : {value: ["mathjax_info", "proceed"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.display_book = function display_book(book) {
            var self = this;
            if (book.manifest.has_maths) {
                self.ensure_maths(self.display_book_stage2.bind(self, book));
            } else {
                self.display_book_stage2(book);
            }
        };
        if (!ReadUI.prototype.display_book.__argnames__) Object.defineProperties(ReadUI.prototype.display_book, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.display_book_stage2 = function display_book_stage2(book) {
            var self = this;
            self.current_metadata = book.metadata;
            update_window_title("", self.current_metadata.title);
            self.show_stack(self.display_id);
            self.view.display_book(book);
        };
        if (!ReadUI.prototype.display_book_stage2.__argnames__) Object.defineProperties(ReadUI.prototype.display_book_stage2, {
            __argnames__ : {value: ["book"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.apply_url_state = function apply_url_state(current_query) {
            var self = this;
            var same, current_state;
            same = true;
            current_state = self.url_data;
            same = current_query.library_id === current_state.library_id && str(current_query.book_id) === str(current_state.book_id) && current_query.fmt === current_state.fmt;
            self.view.overlay.hide();
            window.scrollTo(0, 0);
            if (same) {
                if (current_state.bookpos !== current_query.bookpos && current_query.bookpos) {
                    self.view.goto_cfi(current_query.bookpos);
                }
            } else {
                self.load_book(current_query.library_id, int(current_query.book_id), current_query.fmt, (_expr_temp = library_data.metadata)[_bound_index(current_query.book_id, _expr_temp)]);
            }
        };
        if (!ReadUI.prototype.apply_url_state.__argnames__) Object.defineProperties(ReadUI.prototype.apply_url_state, {
            __argnames__ : {value: ["current_query"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.update_url_state = function update_url_state(replace) {
            var self = this;
            _interpolate_kwargs.call(this, push_state, [self.url_data].concat([_desugar_kwargs({replace: replace, mode: read_book_mode})]));
        };
        if (!ReadUI.prototype.update_url_state.__argnames__) Object.defineProperties(ReadUI.prototype.update_url_state, {
            __argnames__ : {value: ["replace"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.update_metadata = function update_metadata(book, metadata) {
            var self = this;
            self.db.update_metadata(book, metadata);
        };
        if (!ReadUI.prototype.update_metadata.__argnames__) Object.defineProperties(ReadUI.prototype.update_metadata, {
            __argnames__ : {value: ["book", "metadata"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.wait_for_messages_from = function wait_for_messages_from(w, callback) {
            var self = this;
            self.windows_to_listen_for_messages_from.push([w, callback]);
        };
        if (!ReadUI.prototype.wait_for_messages_from.__argnames__) Object.defineProperties(ReadUI.prototype.wait_for_messages_from, {
            __argnames__ : {value: ["w", "callback"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.stop_waiting_for_messages_from = function stop_waiting_for_messages_from(w) {
            var self = this;
            var x;
            self.windows_to_listen_for_messages_from = (function() {
                var _Iter = _Iterable(self.windows_to_listen_for_messages_from), _Result = [], x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    if (x[0] !== w) {
                        _Result.push(x);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
        };
        if (!ReadUI.prototype.stop_waiting_for_messages_from.__argnames__) Object.defineProperties(ReadUI.prototype.stop_waiting_for_messages_from, {
            __argnames__ : {value: ["w"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.message_from_other_window = function message_from_other_window(msg) {
            var self = this;
            var old, _unpack, w, callback, x;
            if (!self.windows_to_listen_for_messages_from.length) {
                return;
            }
            old = self.windows_to_listen_for_messages_from;
            var _Iter10 = _Iterable(old);
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                x = _Iter10[_Index10];
                _unpack = x;
_unpack = _unpack_asarray(2, _unpack);
                w = _unpack[0];
                callback = _unpack[1];
                if (w === msg.source) {
                    callback(msg);
                }
            }
        };
        if (!ReadUI.prototype.message_from_other_window.__argnames__) Object.defineProperties(ReadUI.prototype.message_from_other_window, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.check_for_speech_capability = function check_for_speech_capability() {
            var self = this;
            if (!window.speechSynthesis) {
                error_dialog(_("No speech support"), _("Your browser does not have support for Text-to-Speech"));
                return false;
            }
            return true;
        };
        if (!ReadUI.prototype.check_for_speech_capability.__module__) Object.defineProperties(ReadUI.prototype.check_for_speech_capability, {
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.speak_simple_text = function speak_simple_text(text) {
            var self = this;
            if (!self.check_for_speech_capability()) {
                return;
            }
            self.tts_client.speak_simple_text(text);
        };
        if (!ReadUI.prototype.speak_simple_text.__argnames__) Object.defineProperties(ReadUI.prototype.speak_simple_text, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.tts = function tts(event, data) {
            var self = this;
            if (!self.check_for_speech_capability()) {
                return;
            }
            if (event === "play") {
                self.tts_client.speak_marked_text(data.marked_text, self.view.read_aloud.handle_tts_event);
            } else {
                getattr(self.tts_client, event)();
            }
        };
        if (!ReadUI.prototype.tts.__argnames__) Object.defineProperties(ReadUI.prototype.tts, {
            __argnames__ : {value: ["event", "data"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.update_reading_rates = function update_reading_rates(rates) {
            var self = this;
            var book;
            if (!_exists.d(self.view).book) {
                return;
            }
            book = self.view.book;
            self.db.save_reading_rates(book, rates);
        };
        if (!ReadUI.prototype.update_reading_rates.__argnames__) Object.defineProperties(ReadUI.prototype.update_reading_rates, {
            __argnames__ : {value: ["rates"]},
            __module__ : {value: "read_book.ui"}
        });
        ReadUI.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        ReadUI.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(ReadUI.prototype, "__bases__", {value: []});
        

        _modules["read_book.ui"].RENDER_VERSION = RENDER_VERSION;
        _modules["read_book.ui"].MATHJAX_VERSION = MATHJAX_VERSION;
        _modules["read_book.ui"].ReadUI = ReadUI;
    })();

    (function(){
        var __name__ = "book_list.local_books";
        var CLASS_NAME, book_list_data;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;
        var ngettext = _modules.gettext.ngettext;

        var get_db = _modules["book_list.globals"].get_db;

        var home = _modules["book_list.router"].home;
        var open_book = _modules["book_list.router"].open_book;

        var add_button = _modules["book_list.top_bar"].add_button;
        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;

        var DEFAULT_MODE = _modules["book_list.views"].DEFAULT_MODE;
        var get_view_mode = _modules["book_list.views"].get_view_mode;
        var setup_view_mode = _modules["book_list.views"].setup_view_mode;

        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;

        var create_custom_dialog = _modules.modals.create_custom_dialog;
        var error_dialog = _modules.modals.error_dialog;

        var conditional_timeout = _modules.utils.conditional_timeout;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;
        var enable_escape_key = _modules.widgets.enable_escape_key;

        CLASS_NAME = "local-books-list";
        book_list_data = Object.create(null);
        function component(name) {
            return document.getElementById(book_list_data.container_id).querySelector("[data-component=\"" + _str.format("{}", name) + "\"]");
        };
        if (!component.__argnames__) Object.defineProperties(component, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.local_books"}
        });

        function clear_grid() {
            var container, e, bl;
            container = document.getElementById(book_list_data.container_id);
            e = component("book_list");
            bl = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "book_list"})]);
            container.insertBefore(bl, e);
            container.removeChild(e);
            book_list_data.init_grid(bl);
        };
        if (!clear_grid.__module__) Object.defineProperties(clear_grid, {
            __module__ : {value: "book_list.local_books"}
        });

        function read_book(book, book_idx) {
            var _unpack, library_id, book_id, fmt;
            _unpack = book.key;
_unpack = _unpack_asarray(3, _unpack);
            library_id = _unpack[0];
            book_id = _unpack[1];
            fmt = _unpack[2];
            open_book(book_id, fmt, library_id);
        };
        if (!read_book.__argnames__) Object.defineProperties(read_book, {
            __argnames__ : {value: ["book", "book_idx"]},
            __module__ : {value: "book_list.local_books"}
        });

        function delete_book(book, book_idx) {
            var db;
            db = get_db();
            db.delete_book(book, (function() {
                var _anonfunc = function (book, err_string) {
                    var books, i;
                    if (err_string) {
                        error_dialog(_("Failed to delete book"), err_string);
                        return;
                    }
                    books = (function() {
                        var _Iter = _Iterable(book_list_data.books), _Result = [], i;
                        for (var _Index = 0; _Index < _Iter.length; _Index++) {
                            i = _Iter[_Index];
                            if (i !== book_idx) {
                                _Result.push((_expr_temp = book_list_data.book_data)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i]);
                            }
                        }
                        _Result = _list_constructor(_Result);
                        return _Result;
                    })();
                    show_recent_stage2.call(book_list_data.container_id, books);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["book", "err_string"]},
                    __module__ : {value: "book_list.local_books"}
                });
                return _anonfunc;
            })());
        };
        if (!delete_book.__argnames__) Object.defineProperties(delete_book, {
            __argnames__ : {value: ["book", "book_idx"]},
            __module__ : {value: "book_list.local_books"}
        });

        function confirm_delete_all() {
            var num_of_books;
            num_of_books = _exists.d(book_list_data.books).length;
            if (!num_of_books) {
                return;
            }
            create_custom_dialog(_("Are you sure?"), (function() {
                var _anonfunc = function (parent, close_modal) {
                    var msg, m;
                    function action(doit) {
                        if (doit) {
                            clear(parent);
                            delete_all(parent, close_modal);
                        } else {
                            close_modal();
                        }
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["doit"]},
                        __module__ : {value: "book_list.local_books"}
                    });

                    msg = ngettext("This will remove the downloaded book from local storage. Are you sure?", "This will remove all {} downloaded books from local storage. Are you sure?", num_of_books).format(num_of_books);
                    m = E.div();
                    safe_set_inner_html(m, msg);
                    parent.appendChild(E.div(m, _interpolate_kwargs.call(E, E.div, [create_button(_("OK"), null, action.bind(null, true)), "", _interpolate_kwargs.call(this, create_button, [_("Cancel"), null, action.bind(null, false)].concat([_desugar_kwargs({highlight: true})]))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.local_books"}
                });
                return _anonfunc;
            })());
        };
        if (!confirm_delete_all.__module__) Object.defineProperties(confirm_delete_all, {
            __module__ : {value: "book_list.local_books"}
        });

        function delete_all(msg_parent, close_modal) {
            var db, books;
            db = get_db();
            books = list(book_list_data.books);
            function refresh() {
                show_recent_stage2.call(book_list_data.container_id, (function() {
                    var _Iter = _Iterable(books), _Result = [], i;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        i = _Iter[_Index];
                        _Result.push((_expr_temp = book_list_data.book_data)[(typeof i === "number" && i < 0) ? _expr_temp.length + i : i]);
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })());
            };
            if (!refresh.__module__) Object.defineProperties(refresh, {
                __module__ : {value: "book_list.local_books"}
            });

            function delete_one() {
                var book_to_delete;
                if (!books.length) {
                    close_modal();
                    refresh();
                    return;
                }
                clear(msg_parent);
                safe_set_inner_html(msg_parent, ngettext("Deleting one book, please wait...", "Deleting {} books, please wait...", books.length || 0).format(books.length));
                book_to_delete = books.pop();
                db.delete_book((_expr_temp = book_list_data.book_data)[(typeof book_to_delete === "number" && book_to_delete < 0) ? _expr_temp.length + book_to_delete : book_to_delete], (function() {
                    var _anonfunc = function (book, err_string) {
                        if (err_string) {
                            close_modal();
                            refresh();
                            error_dialog(_("Failed to delete book"), err_string);
                        } else {
                            delete_one();
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["book", "err_string"]},
                        __module__ : {value: "book_list.local_books"}
                    });
                    return _anonfunc;
                })());
            };
            if (!delete_one.__module__) Object.defineProperties(delete_one, {
                __module__ : {value: "book_list.local_books"}
            });

            delete_one();
        };
        if (!delete_all.__argnames__) Object.defineProperties(delete_all, {
            __argnames__ : {value: ["msg_parent", "close_modal"]},
            __module__ : {value: "book_list.local_books"}
        });

        function on_select(book, book_idx) {
            var title;
            title = this;
            create_custom_dialog(title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    function action(which) {
                        close_modal();
                        which(book, book_idx);
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["which"]},
                        __module__ : {value: "book_list.local_books"}
                    });

                    parent.appendChild(E.div(E.div(_("What would you like to do with this book?")), _interpolate_kwargs.call(E, E.div, [create_button(_("Read"), "book", action.bind(null, read_book)), "", create_button(_("Delete"), "trash", action.bind(null, delete_book))].concat([_desugar_kwargs({class_: "button-box"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.local_books"}
                });
                return _anonfunc;
            })());
        };
        if (!on_select.__argnames__) Object.defineProperties(on_select, {
            __argnames__ : {value: ["book", "book_idx"]},
            __module__ : {value: "book_list.local_books"}
        });

        function show_cover(blob, name, mt, book) {
            var img;
            img = document.getElementById(this);
            if (img) {
                img.src = window.URL.createObjectURL(blob);
            }
        };
        if (!show_cover.__argnames__) Object.defineProperties(show_cover, {
            __argnames__ : {value: ["blob", "name", "mt", "book"]},
            __module__ : {value: "book_list.local_books"}
        });

        function create_image(book_idx, max_width, max_height, on_load) {
            var img, book, authors, img_id;
            img = new Image;
            img.onerror = (function() {
                var _anonfunc = function () {
                    if (this.src) {
                        window.URL.revokeObjectURL(this.src);
                    }
                    on_load(this, "error");
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.local_books"}
                });
                return _anonfunc;
            })();
            img.onload = (function() {
                var _anonfunc = function () {
                    if (this.src) {
                        window.URL.revokeObjectURL(this.src);
                    }
                    on_load(this, "load");
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.local_books"}
                });
                return _anonfunc;
            })();
            book = (_expr_temp = book_list_data.book_data)[(typeof book_idx === "number" && book_idx < 0) ? _expr_temp.length + book_idx : book_idx];
            if ((typeof book !== "undefined" && book !== null ? book : Object.create(null)).metadata) {
                authors = (book.metadata.authors) ? book.metadata.authors.join(" & ") : _("Unknown");
                img.setAttribute("alt", _("{} by {}").format(book.metadata.title, authors));
            }
            if ((typeof book !== "undefined" && book !== null ? book : Object.create(null)).cover_name) {
                img_id = ensure_id(img, "local-cover-");
                get_db().get_file(book, book.cover_name, show_cover.bind(img_id));
            }
            return img;
        };
        if (!create_image.__argnames__) Object.defineProperties(create_image, {
            __argnames__ : {value: ["book_idx", "max_width", "max_height", "on_load"]},
            __module__ : {value: "book_list.local_books"}
        });

        function render_book(book_idx) {
            var book;
            book = (_expr_temp = book_list_data.book_data)[(typeof book_idx === "number" && book_idx < 0) ? _expr_temp.length + book_idx : book_idx];
            return book_list_data.render_book(book_idx, book.metadata, create_image, on_select.bind(book.metadata.title, book, book_idx));
        };
        if (!render_book.__argnames__) Object.defineProperties(render_book, {
            __argnames__ : {value: ["book_idx"]},
            __module__ : {value: "book_list.local_books"}
        });

        function render_books(books) {
            var div, child, book_idx;
            div = component("book_list");
            books = books || book_list_data.books;
            var _Iter0 = _Iterable(books);
            for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                book_idx = _Iter0[_Index0];
                child = render_book(book_idx);
                if (child !== null) {
                    book_list_data.append_item(div, child);
                }
            }
        };
        if (!render_books.__argnames__) Object.defineProperties(render_books, {
            __argnames__ : {value: ["books"]},
            __module__ : {value: "book_list.local_books"}
        });

        function apply_view_mode(mode) {
            mode = mode || DEFAULT_MODE;
            if (book_list_data.mode === mode) {
                return;
            }
            setup_view_mode(mode, book_list_data);
            clear_grid();
            render_books();
        };
        if (!apply_view_mode.__argnames__) Object.defineProperties(apply_view_mode, {
            __argnames__ : {value: ["mode"]},
            __module__ : {value: "book_list.local_books"}
        });

        function create_books_list(container, books) {
            var _unpack, i, book;
            clear(container);
            book_list_data.container_id = ensure_id(container);
            book_list_data.book_data = (function() {
                var _Iter = _Iterable(enumerate(books)), _Result = Object.create(null), i, book;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    _unpack = _Iter[_Index];
                    i = _unpack[0];
                    book = _unpack[1];
                    _Result[i] = (book);
                }
                return _Result;
            })();
            book_list_data.books = list(range(books.length));
            book_list_data.mode = null;
            book_list_data.thumbnail_cache = Object.create(null);
            if (!books.length) {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_("No downloaded books present")].concat([_desugar_kwargs({style: "margin: 1rem 1rem"})])));
            } else {
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "book_list"})]));
                apply_view_mode(get_view_mode());
            }
        };
        if (!create_books_list.__argnames__) Object.defineProperties(create_books_list, {
            __argnames__ : {value: ["container", "books"]},
            __module__ : {value: "book_list.local_books"}
        });

        function show_recent_stage2(books) {
            var container;
            container = document.getElementById(this);
            if (!container) {
                return;
            }
            create_books_list(container, books);
        };
        if (!show_recent_stage2.__argnames__) Object.defineProperties(show_recent_stage2, {
            __argnames__ : {value: ["books"]},
            __module__ : {value: "book_list.local_books"}
        });

        function show_recent() {
            var container, db;
            container = this;
            db = get_db();
            if (!db.initialized) {
                conditional_timeout(container.id, 5, show_recent);
                return;
            }
            if (db.is_ok) {
                db.get_recently_read_books(show_recent_stage2.bind(container.id), 200);
            } else {
                error_dialog(_("Database not initialized"), db.initialize_error_msg);
            }
        };
        if (!show_recent.__module__) Object.defineProperties(show_recent, {
            __module__ : {value: "book_list.local_books"}
        });

        function init(container_id) {
            var container, on_close, recent, recent_container_id;
            container = document.getElementById(container_id);
            on_close = home;
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Downloaded books"), action: on_close, icon: "home"})]));
            add_button(container, "trash", confirm_delete_all, _("Delete all downloaded books"));
            recent = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME})]);
            recent_container_id = ensure_id(recent);
            container.appendChild(recent);
            recent.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading downloaded books from local storage, please wait...")].concat([_desugar_kwargs({style: "margin: 1rem 1rem"})])));
            conditional_timeout(recent_container_id, 5, show_recent);
            enable_escape_key(container, on_close);
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.local_books"}
        });

        set_panel_handler("local_books", init);
        _modules["book_list.local_books"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.local_books"].book_list_data = book_list_data;
        _modules["book_list.local_books"].component = component;
        _modules["book_list.local_books"].clear_grid = clear_grid;
        _modules["book_list.local_books"].read_book = read_book;
        _modules["book_list.local_books"].delete_book = delete_book;
        _modules["book_list.local_books"].confirm_delete_all = confirm_delete_all;
        _modules["book_list.local_books"].delete_all = delete_all;
        _modules["book_list.local_books"].on_select = on_select;
        _modules["book_list.local_books"].show_cover = show_cover;
        _modules["book_list.local_books"].create_image = create_image;
        _modules["book_list.local_books"].render_book = render_book;
        _modules["book_list.local_books"].render_books = render_books;
        _modules["book_list.local_books"].apply_view_mode = apply_view_mode;
        _modules["book_list.local_books"].create_books_list = create_books_list;
        _modules["book_list.local_books"].show_recent_stage2 = show_recent_stage2;
        _modules["book_list.local_books"].show_recent = show_recent;
        _modules["book_list.local_books"].init = init;
    })();

    (function(){
        var __name__ = "book_list.comments_editor";
        var CLASS_NAME, TOOLBAR_CLASS, registry;
        var E = _modules.elementmaker.E;

        var color_scheme = _modules["book_list.theme"].color_scheme;
        var get_color = _modules["book_list.theme"].get_color;
        var get_color_as_rgba = _modules["book_list.theme"].get_color_as_rgba;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;
        var svgicon = _modules.dom.svgicon;

        var _ = _modules.gettext.gettext;

        var IframeClient = _modules.iframe_comm.IframeClient;
        var create_wrapped_iframe = _modules.iframe_comm.create_wrapped_iframe;

        var fit_image = _modules.image_popup.fit_image;

        var create_custom_dialog = _modules.modals.create_custom_dialog;

        var html_escape = _modules.utils.html_escape;

        var short_uuid4 = _modules.uuid.short_uuid4;

        var create_button = _modules.widgets.create_button;

        CLASS_NAME = "comments-editor";
        TOOLBAR_CLASS = "comments-editor-toolbar";
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + TOOLBAR_CLASS + " ";
                style = "";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({display: "flex", flex_wrap: "wrap", padding_top: "0.25ex", padding_bottom: "0.25ex"})]));
                sel += " > div";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({padding: "0.5ex", margin_right: "0.5ex", cursor: "pointer"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":hover"].concat([_desugar_kwargs({color: "red"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".activated"].concat([_desugar_kwargs({color: get_color("window-background"), background: get_color("window-foreground")})]));
                sel += ".sep";
                style += _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({border_left: "solid 2px currentColor", cursor: "auto"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ":hover"].concat([_desugar_kwargs({color: "currentColor"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.comments_editor"}
            });
            return _anonfunc;
        })());
        function choose_block_style(proceed) {
            create_custom_dialog(_("Choose style"), (function() {
                var _anonfunc = function (parent, close_modal) {
                    var spc;
                    function action(which) {
                        close_modal();
                        proceed(which);
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["which"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });

                    function s(text, tag) {
                        var ans;
                        ans = _interpolate_kwargs.call(this, create_button, [text].concat([_desugar_kwargs({action: action.bind(null, tag)})]));
                        ans.style.marginBottom = "1ex";
                        return ans;
                    };
                    if (!s.__argnames__) Object.defineProperties(s, {
                        __argnames__ : {value: ["text", "tag"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });

                    spc = "";
                    parent.appendChild(E.div(E.div(_("Choose the block style you would like to use")), _interpolate_kwargs.call(E, E.div, [s(_("Normal"), "div"), spc, s("H1", "h1"), spc, s("H2", "h2"), spc, s("H3", "h3"), spc, s("H4", "h4"), spc, s("H5", "h5"), spc, s("H6", "h6"), spc, s(_("Quote"), "blockquote")].concat([_desugar_kwargs({class_: "button-box", style: "flex-wrap: wrap"})]))));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.comments_editor"}
                });
                return _anonfunc;
            })());
        };
        if (!choose_block_style.__argnames__) Object.defineProperties(choose_block_style, {
            __argnames__ : {value: ["proceed"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function insert_heading(editor_id, cmd) {
            var editor;
            editor = registry[(typeof editor_id === "number" && editor_id < 0) ? registry.length + editor_id : editor_id];
            if (cmd) {
                editor.exec_command("formatBlock", "<" + _str.format("{}", cmd) + ">");
            }
            editor.focus();
        };
        if (!insert_heading.__argnames__) Object.defineProperties(insert_heading, {
            __argnames__ : {value: ["editor_id", "cmd"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function insert_image(editor) {
            var acceptable_image_types, parent_id, accepted, align_name;
            acceptable_image_types = ["image/png", "image/jpeg", "image/gif", "image/webp"];
            parent_id = "";
            accepted = false;
            align_name = "align-radio-button";
            function on_close(evt) {
                var parent, img, align, s, w, page_width, h, page_height, _unpack, resized, nw, nh, markup;
                parent = document.getElementById(parent_id);
                if (parent) {
                    img = parent.querySelector("img");
                    if (img) {
                        if (accepted && img.src) {
                            align = parent.querySelector("input[name=\"" + _str.format("{}", align_name) + "\"]:checked").value;
                            s = style_from_align(align);
                            w = parseInt(parent.querySelector("input[name=\"width\"]").value || "0");
                            page_width = ((isNaN(w)) ? 0 : w) || 1e9;
                            h = parseInt(parent.querySelector("input[name=\"height\"]").value || "0");
                            page_height = ((isNaN(h)) ? 0 : h) || 1e9;
                            _unpack = [img.naturalWidth, img.naturalHeight];
                            w = _unpack[0];
                            h = _unpack[1];
                            _unpack = fit_image(w, h, page_width, page_height);
_unpack = _unpack_asarray(3, _unpack);
                            resized = _unpack[0];
                            nw = _unpack[1];
                            nh = _unpack[2];
                            if (resized) {
                                markup = "<img src=\"" + _str.format("{}", img.src) + "\" data-filename=\"" + _str.format("{}", html_escape(img.dataset.filename)) + "\"" + (" data-align=\"" + _str.format("{}", html_escape(align)) + "\" width=\"" + _str.format("{}", nw) + "\" height=\"" + _str.format("{}", nh) + "\" style=\"" + _str.format("{}", s) + "\"></img>");
                            } else {
                                markup = "<img src=\"" + _str.format("{}", img.src) + "\" data-filename=\"" + _str.format("{}", html_escape(img.dataset.filename)) + "\"" + (" data-align=\"" + _str.format("{}", html_escape(align)) + "\" style=\"" + _str.format("{}", s) + "\"></img>");
                            }
                            editor.exec_command("insertHTML", markup);
                        }
                    }
                }
            };
            if (!on_close.__argnames__) Object.defineProperties(on_close, {
                __argnames__ : {value: ["evt"]},
                __module__ : {value: "book_list.comments_editor"}
            });

            function dialog(parent, close_modal) {
                var container, max_container_height;
                parent_id = ensure_id(parent);
                container = parent.closest(".modal_height_container");
                max_container_height = container.style.maxHeight;
                function action(ok, evt) {
                    var img;
                    img = parent.getElementsByTagName("img")[0];
                    if (ok && !img.src) {
                        parent.querySelector(".no-image-selected").style.display = "block";
                        return;
                    }
                    accepted = ok;
                    close_modal();
                };
                if (!action.__argnames__) Object.defineProperties(action, {
                    __argnames__ : {value: ["ok", "evt"]},
                    __module__ : {value: "book_list.comments_editor"}
                });

                function handle_files(files) {
                    var img, r, h, non_content_height, f;
                    parent.querySelector(".no-image-selected").style.display = "none";
                    parent.querySelector(".image-alignment").style.display = "none";
                    parent.querySelector(".image-shrink").style.display = "none";
                    img = parent.getElementsByTagName("img")[0];
                    img.src = "";
                    img.dataset.filename = "";
                    img.dataset.align = "";
                    img.parentElement.style.display = "none";
                    var _Iter0 = _Iterable(files);
                    for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                        f = _Iter0[_Index0];
                        if (acceptable_image_types.indexOf(f.type) > -1) {
                            r = new FileReader;
                            r.onload = (function() {
                                var _anonfunc = function () {
                                    img.src = r.result;
                                };
                                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                                    __module__ : {value: "book_list.comments_editor"}
                                });
                                return _anonfunc;
                            })();
                            r.readAsDataURL(f);
                            h = parent.querySelector(".button-box").offsetHeight;
                            img.parentElement.style.display = "block";
                            non_content_height = container.offsetHeight - parent.offsetHeight + "px";
                            img.style.maxHeight = "calc(" + _str.format("{}", max_container_height) + " - " + _str.format("{}", non_content_height) + " - " + _str.format("{}", h) + "px - 1rem)";
                            if (f.name) {
                                img.dataset.filename = f.name;
                            }
                            parent.querySelector(".image-alignment").style.display = "block";
                            parent.querySelector(".image-shrink").style.display = "block";
                            return;
                        }
                    }
                    alert(_("No valid image file found"));
                };
                if (!handle_files.__argnames__) Object.defineProperties(handle_files, {
                    __argnames__ : {value: ["files"]},
                    __module__ : {value: "book_list.comments_editor"}
                });

                parent.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.img, [_desugar_kwargs({style: "max-width: 100%"})])].concat([_desugar_kwargs({style: "display: none; min-width: 40%; max-width: 40%; margin-right: 0.5rem"})])), E.div(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "file", accept: ",".join(acceptable_image_types), onchange: (function() {
                    var _anonfunc = function (e) {
                        handle_files(e.target.files);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["e"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });
                    return _anonfunc;
                })(), style: "display: none"})]), E.p(_interpolate_kwargs.call(E, E.a, [_("Select an image from your files")].concat([_desugar_kwargs({class_: "blue-link", href: "javascript:void(0)", onclick: (function() {
                    var _anonfunc = function () {
                        parent.querySelector("input[type=file]").click();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.comments_editor"}
                    });
                    return _anonfunc;
                })()})])), E.span(_(" or drag and drop an image here."))), _interpolate_kwargs.call(E, E.div, [_("Place image:"), E.br(), _interpolate_kwargs.call(E, E.label, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: align_name, value: "left"})]), _("Float left")].concat([_desugar_kwargs({style: "margin-right: 0.5rem"})])), " ", _interpolate_kwargs.call(E, E.label, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: align_name, value: "inline", checked: true})]), _("Inline")].concat([_desugar_kwargs({title: _("Place the image inline with surrounding text"), style: "margin-right: 0.5rem"})])), " ", E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "radio", name: align_name, value: "right"})]), _("Float right"))].concat([_desugar_kwargs({style: "display: none; margin-top: 0.5rem", class_: "image-alignment"})])), _interpolate_kwargs.call(E, E.div, [_("Shrink image to fit (px):"), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.label, [_("Width:") + "", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", min: "0", max: "10000", name: "width"})])].concat([_desugar_kwargs({style: "margin-left: 0.5rem", title: _("A value of zero means no effect")})])), _interpolate_kwargs.call(E, E.label, [_("Height:") + "", _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", min: "0", max: "10000", name: "height"})])].concat([_desugar_kwargs({style: "margin-left: 0.5rem", title: _("A value of zero means no effect")})]))].concat([_desugar_kwargs({style: "display: flex; flex-wrap: wrap"})]))].concat([_desugar_kwargs({style: "display: none; margin-top: 0.5rem", class_: "image-shrink"})])), _interpolate_kwargs.call(E, E.p, [_("No image selected!")].concat([_desugar_kwargs({class_: "no-image-selected", style: "color:red; display:none"})])))].concat([_desugar_kwargs({style: "display: flex;"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({action: action.bind(null, true), highlight: true})])), "", _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: action.bind(null, false), highlight: false})]))].concat([_desugar_kwargs({class_: "button-box"})]))].concat([_desugar_kwargs({ondragenter: (function() {
                    var _anonfunc = function (e) {
                        [e.stopPropagation(), e.preventDefault()];
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["e"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });
                    return _anonfunc;
                })(), ondragover: (function() {
                    var _anonfunc = function (e) {
                        [e.stopPropagation(), e.preventDefault()];
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["e"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });
                    return _anonfunc;
                })(), ondrop: (function() {
                    var _anonfunc = function (e) {
                        [e.stopPropagation(), e.preventDefault()];
                        handle_files(e.dataTransfer.files);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["e"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });
                    return _anonfunc;
                })()})])));
            };
            if (!dialog.__argnames__) Object.defineProperties(dialog, {
                __argnames__ : {value: ["parent", "close_modal"]},
                __module__ : {value: "book_list.comments_editor"}
            });

            _interpolate_kwargs.call(this, create_custom_dialog, [_("Insert image"), dialog].concat([_desugar_kwargs({on_close: on_close})]));
        };
        if (!insert_image.__argnames__) Object.defineProperties(insert_image, {
            __argnames__ : {value: ["editor"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function insert_link(title, msg, proceed) {
            create_custom_dialog(title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    function action(ok, evt) {
                        var c, url, name;
                        close_modal();
                        c = evt.currentTarget.closest(".il-modal-container");
                        url = c.querySelector("input[name=\"url\"]").value;
                        name = c.querySelector("input[name=\"name\"]").value;
                        proceed(ok, url, name);
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["ok", "evt"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });

                    parent.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(msg), _interpolate_kwargs.call(E, E.table, [E.tr(E.td("URL:"), _interpolate_kwargs.call(E, E.td, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "url", name: "url", style: "width: 100%"})])].concat([_desugar_kwargs({style: "padding-bottom: 1ex"})]))), E.tr(E.td(_("Name (optional):")), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: "name", style: "width: 100%"})])))].concat([_desugar_kwargs({style: "width: 95%; margin-top: 1ex"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({action: action.bind(null, true), highlight: true})])), "", _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: action.bind(null, false), highlight: false})]))].concat([_desugar_kwargs({class_: "button-box"})]))].concat([_desugar_kwargs({class_: "il-modal-container"})])));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.comments_editor"}
                });
                return _anonfunc;
            })());
        };
        if (!insert_link.__argnames__) Object.defineProperties(insert_link, {
            __argnames__ : {value: ["title", "msg", "proceed"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function insert_link_or_image(editor_id, is_image, ok, url, title) {
            var editor, markup, cmd;
            editor = registry[(typeof editor_id === "number" && editor_id < 0) ? registry.length + editor_id : editor_id];
            if (ok) {
                if (title) {
                    markup = (is_image) ? "<img src=\"{}\" alt=\"{}\"></img>" : "<a href=\"{}\">{}</a>";
                    editor.exec_command("insertHTML", markup.format(html_escape(url), html_escape(title)));
                } else {
                    cmd = (is_image) ? "insertImage" : "createLink";
                    editor.exec_command(cmd, url);
                }
            }
            editor.focus();
        };
        if (!insert_link_or_image.__argnames__) Object.defineProperties(insert_link_or_image, {
            __argnames__ : {value: ["editor_id", "is_image", "ok", "url", "title"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function set_color(title, msg, proceed) {
            create_custom_dialog(title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    function action(ok, evt) {
                        var c, color;
                        close_modal();
                        c = evt.currentTarget.closest(".sc-modal-container");
                        color = c.querySelector("input[name=\"color\"]").value;
                        proceed(ok, color);
                    };
                    if (!action.__argnames__) Object.defineProperties(action, {
                        __argnames__ : {value: ["ok", "evt"]},
                        __module__ : {value: "book_list.comments_editor"}
                    });

                    parent.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(msg), E.div(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "color", name: "color"})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({action: action.bind(null, true), highlight: true})])), "", _interpolate_kwargs.call(this, create_button, [_("Cancel")].concat([_desugar_kwargs({action: action.bind(null, false), highlight: false})]))].concat([_desugar_kwargs({class_: "button-box"})]))].concat([_desugar_kwargs({class_: "sc-modal-container"})])));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.comments_editor"}
                });
                return _anonfunc;
            })());
        };
        if (!set_color.__argnames__) Object.defineProperties(set_color, {
            __argnames__ : {value: ["title", "msg", "proceed"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function change_color(editor_id, which, ok, color) {
            var editor;
            editor = registry[(typeof editor_id === "number" && editor_id < 0) ? registry.length + editor_id : editor_id];
            if (ok) {
                editor.exec_command(which, color);
            }
            editor.focus();
        };
        if (!change_color.__argnames__) Object.defineProperties(change_color, {
            __argnames__ : {value: ["editor_id", "which", "ok", "color"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function all_editor_actions() {
            if (!all_editor_actions.ans) {
                all_editor_actions.ans = (function(){
                    var _d = Object.create(null);
                    _d["select-all"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "select-all";
                        _d["title"] = _("Select all");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("selectAll");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["remove-format"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "eraser";
                        _d["title"] = _("Remove formatting");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("removeFormat");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["undo"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "undo";
                        _d["title"] = _("Undo");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("undo");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["redo"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "redo";
                        _d["title"] = _("Redo");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("redo");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["bold"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "bold";
                        _d["title"] = _("Bold");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("bold");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["italic"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "italic";
                        _d["title"] = _("Italic");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("italic");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["underline"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "underline";
                        _d["title"] = _("Underline");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("underline");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["strikethrough"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "strikethrough";
                        _d["title"] = _("Strikethrough");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("strikeThrough");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["superscript"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "superscript";
                        _d["title"] = _("Superscript");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("superscript");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["subscript"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "subscript";
                        _d["title"] = _("Subscript");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("subscript");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["hr"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "hr";
                        _d["title"] = _("Insert separator");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("insertHorizontalRule");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["format-block"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "heading";
                        _d["title"] = _("Style the selected text block");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                choose_block_style(insert_heading.bind(null, editor.id));
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["ul"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "ul";
                        _d["title"] = _("Unordered list");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("insertUnorderedList");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["ol"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "ol";
                        _d["title"] = _("Ordered list");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("insertOrderedList");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["indent"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "indent";
                        _d["title"] = _("Increase indentation");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("indent");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["outdent"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "outdent";
                        _d["title"] = _("Decrease indentation");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("outdent");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["justify-left"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "justify-left";
                        _d["title"] = _("Align left");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("justifyLeft");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["justify-full"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "justify-full";
                        _d["title"] = _("Align justified");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("justifyFull");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["justify-center"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "justify-center";
                        _d["title"] = _("Align center");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("justifyCenter");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["justify-right"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "justify-right";
                        _d["title"] = _("Align right");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                editor.exec_command("justifyRight");
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["insert-link"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "insert-link";
                        _d["title"] = _("Insert a link or linked image");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                insert_link(_("Insert a link"), _("Enter the link URL and optionally the link name"), insert_link_or_image.bind(null, editor.id, false));
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["insert-image"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "image";
                        _d["title"] = _("Insert an image");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                if (editor.insert_image_files) {
                                    insert_image(editor);
                                } else {
                                    insert_link(_("Insert an image"), _("Enter the image URL and optionally the image name"), insert_link_or_image.bind(null, editor.id, true));
                                }
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["fg"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "fg";
                        _d["title"] = _("Change the text color");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                set_color(_("Choose text color"), _("Choose the color below"), change_color.bind(null, editor.id, "foreColor"));
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    _d["bg"] = (function(){
                        var _d = Object.create(null);
                        _d["icon"] = "bg";
                        _d["title"] = _("Change the highlight color");
                        _d["execute"] = (function() {
                            var _anonfunc = function (editor, activated) {
                                set_color(_("Choose highlight color"), _("Choose the color below"), change_color.bind(null, editor.id, "hiliteColor"));
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["editor", "activated"]},
                                __module__ : {value: "book_list.comments_editor"}
                            });
                            return _anonfunc;
                        })();
                        return _d;
                    }).call(this);
                    return _d;
                }).call(this);
            }
            return all_editor_actions.ans;
        };
        if (!all_editor_actions.__module__) Object.defineProperties(all_editor_actions, {
            __module__ : {value: "book_list.comments_editor"}
        });

        function style_from_align(align) {
            if (align === "left") {
                return "float: left; margin-right: 0.5em";
            }
            if (align === "right") {
                return "float: right; margin-left: 0.5em";
            }
            return "";
        };
        if (!style_from_align.__argnames__) Object.defineProperties(style_from_align, {
            __argnames__ : {value: ["align"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function CommentsEditorBoss() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            CommentsEditorBoss.prototype.__bind_methods__.call(this);
            CommentsEditorBoss.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(CommentsEditorBoss.prototype, "__bind_methods__", {value: function () {
            this.initialize = CommentsEditorBoss.prototype.initialize.bind(this);
            this.focus = CommentsEditorBoss.prototype.focus.bind(this);
            this.onerror = CommentsEditorBoss.prototype.onerror.bind(this);
            this.set_html = CommentsEditorBoss.prototype.set_html.bind(this);
            this.get_html = CommentsEditorBoss.prototype.get_html.bind(this);
            this.exec_command = CommentsEditorBoss.prototype.exec_command.bind(this);
            this.update_state = CommentsEditorBoss.prototype.update_state.bind(this);
        }});
        CommentsEditorBoss.prototype.__init__ = function __init__() {
            var self = this;
            var handlers;
            handlers = (function(){
                var _d = Object.create(null);
                _d["initialize"] = self.initialize;
                _d["set_html"] = self.set_html;
                _d["get_html"] = self.get_html;
                _d["exec_command"] = self.exec_command;
                _d["focus"] = self.focus;
                return _d;
            }).call(this);
            self.comm = new IframeClient(handlers, "comments-editor-iframe");
        };
        if (!CommentsEditorBoss.prototype.__init__.__module__) Object.defineProperties(CommentsEditorBoss.prototype.__init__, {
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.__argnames__ = CommentsEditorBoss.prototype.__init__.__argnames__;
        CommentsEditorBoss.__handles_kwarg_interpolation__ = CommentsEditorBoss.prototype.__init__.__handles_kwarg_interpolation__;
        CommentsEditorBoss.prototype.initialize = function initialize(data) {
            var self = this;
            window.onerror = self.onerror;
            clear(document.body);
            document.execCommand("defaultParagraphSeparator", false, "div");
            document.execCommand("styleWithCSS", false, false);
            document.body.style.margin = "0";
            document.body.style.padding = "0";
            document.body.style.fontFamily = window.default_font_family;
            document.body.appendChild(E.style("div:focus { outline: none }"));
            document.body.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "width: 100%; padding: 0.5rem; margin: 0; border-width: 0; box-sizing: border-box"})]));
            document.body.lastChild.contentEditable = true;
            document.body.lastChild.addEventListener("keyup", self.update_state);
            document.body.lastChild.addEventListener("mouseup", self.update_state);
            document.body.lastChild.focus();
            self.update_state();
        };
        if (!CommentsEditorBoss.prototype.initialize.__argnames__) Object.defineProperties(CommentsEditorBoss.prototype.initialize, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.focus = function focus() {
            var self = this;
            document.body.lastChild.focus();
        };
        if (!CommentsEditorBoss.prototype.focus.__module__) Object.defineProperties(CommentsEditorBoss.prototype.focus, {
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.onerror = function onerror(msg, script_url, line_number, column_number, error_object) {
            var self = this;
            if (error_object === null) {
                console.log("Unhandled error from external javascript, ignoring: " + _str.format("{}", msg) + " " + _str.format("{}", script_url) + " " + _str.format("{}", line_number) + "");
            } else {
                console.log(error_object);
            }
        };
        if (!CommentsEditorBoss.prototype.onerror.__argnames__) Object.defineProperties(CommentsEditorBoss.prototype.onerror, {
            __argnames__ : {value: ["msg", "script_url", "line_number", "column_number", "error_object"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.set_html = function set_html(data) {
            var self = this;
            if (data.color_scheme) {
                document.documentElement.style.colorScheme = data.color_scheme;
            }
            document.body.style.color = data.color;
            document.body.lastChild.innerHTML = data.html;
        };
        if (!CommentsEditorBoss.prototype.set_html.__argnames__) Object.defineProperties(CommentsEditorBoss.prototype.set_html, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.get_html = function get_html(data) {
            var self = this;
            var c, images, key, s, img;
            c = document.body.lastChild.cloneNode(true);
            images = {};
            if (data.extract_images) {
                var _Iter1 = _Iterable(c.getElementsByTagName("img"));
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    img = _Iter1[_Index1];
                    if (img.src) {
                        key = short_uuid4();
                        images[(typeof key === "number" && key < 0) ? images.length + key : key] = (function(){
                            var _d = Object.create(null);
                            _d["data"] = img.src;
                            _d["filename"] = img.dataset.filename;
                            return _d;
                        }).call(this);
                        if (img.dataset.filename) {
                            s = style_from_align(img.dataset.align);
                            if (s) {
                                img.setAttribute("style", s);
                            } else {
                                img.removeAttribute("style");
                            }
                        }
                        img.src = key;
                        delete img.dataset.filename;
                        delete img.dataset.align;
                    }
                }
            }
            _interpolate_kwargs.call(self.comm, self.comm.send_message, ["html"].concat([_desugar_kwargs({html: c.innerHTML, extra_data: (function(){
                var _d = Object.create(null);
                _d["images"] = images;
                _d["text"] = c.innerText;
                return _d;
            }).call(this)})]));
        };
        if (!CommentsEditorBoss.prototype.get_html.__argnames__) Object.defineProperties(CommentsEditorBoss.prototype.get_html, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.exec_command = function exec_command(data) {
            var self = this;
            document.execCommand(data.name, false, data.value);
            self.update_state();
        };
        if (!CommentsEditorBoss.prototype.exec_command.__argnames__) Object.defineProperties(CommentsEditorBoss.prototype.exec_command, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.update_state = function update_state() {
            var self = this;
            var state, name;
            state = (function() {
                var _Iter = _Iterable("bold italic underline superscript subscript".split(" ")), _Result = Object.create(null), name;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    name = _Iter[_Index];
                    _Result[name] = (document.queryCommandState(name));
                }
                return _Result;
            })();
            state.strikethrough = document.queryCommandState("strikeThrough");
            _interpolate_kwargs.call(self.comm, self.comm.send_message, ["update_state"].concat([_desugar_kwargs({state: state})]));
        };
        if (!CommentsEditorBoss.prototype.update_state.__module__) Object.defineProperties(CommentsEditorBoss.prototype.update_state, {
            __module__ : {value: "book_list.comments_editor"}
        });
        CommentsEditorBoss.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        CommentsEditorBoss.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(CommentsEditorBoss.prototype, "__bases__", {value: []});

        registry = Object.create(null);
        function destroy_removed_editors() {
            var k;
            var _Iter2 = _Iterable(Object.keys(registry));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                k = _Iter2[_Index2];
                if (!document.getElementById(k)) {
                    registry[(typeof k === "number" && k < 0) ? registry.length + k : k].destroy();
                    delete registry[k];
                }
            }
        };
        if (!destroy_removed_editors.__module__) Object.defineProperties(destroy_removed_editors, {
            __module__ : {value: "book_list.comments_editor"}
        });

        function add_editor(editor) {
            destroy_removed_editors();
            registry[_bound_index(editor.id, registry)] = editor;
        };
        if (!add_editor.__argnames__) Object.defineProperties(add_editor, {
            __argnames__ : {value: ["editor"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function destroy_editor(container) {
            delete registry[container.querySelector("iframe").id];
        };
        if (!destroy_editor.__argnames__) Object.defineProperties(destroy_editor, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function Editor() {
            if (this._object_id === undefined) Object.defineProperty(this, "_object_id", {"value":++_object_counter});
            Editor.prototype.__bind_methods__.call(this);
            Editor.prototype.__init__.apply(this, arguments);
        }
        Object.defineProperty(Editor.prototype, "__bind_methods__", {value: function () {
            this.init = Editor.prototype.init.bind(this);
            this.destroy = Editor.prototype.destroy.bind(this);
            this.focus = Editor.prototype.focus.bind(this);
            this.on_iframe_ready = Editor.prototype.on_iframe_ready.bind(this);
            this.after_iframe_initialized = Editor.prototype.after_iframe_initialized.bind(this);
            this.set_html = Editor.prototype.set_html.bind(this);
            this.get_html = Editor.prototype.get_html.bind(this);
            this.on_html_received = Editor.prototype.on_html_received.bind(this);
            this.exec_command = Editor.prototype.exec_command.bind(this);
            this.update_state = Editor.prototype.update_state.bind(this);
        }});
        Object.defineProperties(Editor.prototype,  {
            "iframe": {
                "enumerable": true, 
                "get": function iframe() {
                    var self = this;
                    return self.iframe_wrapper.iframe;
                }, 
                "set": function () { throw new AttributeError("can't set attribute") }
            }, 
        });
        Editor.prototype.__init__ = function __init__(iframe_kw, insert_image_files) {
            var self = this;
            var handlers, _unpack, iframe;
            handlers = (function(){
                var _d = Object.create(null);
                _d["ready"] = self.on_iframe_ready;
                _d["html"] = self.on_html_received;
                _d["update_state"] = self.update_state;
                return _d;
            }).call(this);
            _unpack = create_wrapped_iframe(handlers, _("Loading comments editor..."), "book_list.comments_editor", iframe_kw);
_unpack = _unpack_asarray(2, _unpack);
            iframe = _unpack[0];
            self.iframe_wrapper = _unpack[1];
            self.id = iframe.id;
            self.ready = false;
            self.pending_set_html = null;
            self.pending_get_html = [];
            self.get_html_callbacks = [];
            self.iframe_obj = iframe;
            self.insert_image_files = !!insert_image_files;
        };
        if (!Editor.prototype.__init__.__argnames__) Object.defineProperties(Editor.prototype.__init__, {
            __argnames__ : {value: ["iframe_kw", "insert_image_files"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.__argnames__ = Editor.prototype.__init__.__argnames__;
        Editor.__handles_kwarg_interpolation__ = Editor.prototype.__init__.__handles_kwarg_interpolation__;
        Editor.prototype.init = function init() {
            var self = this;
            self.iframe_wrapper.init();
        };
        if (!Editor.prototype.init.__module__) Object.defineProperties(Editor.prototype.init, {
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.destroy = function destroy() {
            var self = this;
            self.iframe_wrapper.destroy();
            self.get_html_callbacks = [];
        };
        if (!Editor.prototype.destroy.__module__) Object.defineProperties(Editor.prototype.destroy, {
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.focus = function focus() {
            var self = this;
            self.iframe.contentWindow.focus();
            if (self.ready) {
                self.iframe_wrapper.send_message("focus");
            }
        };
        if (!Editor.prototype.focus.__module__) Object.defineProperties(Editor.prototype.focus, {
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.on_iframe_ready = function on_iframe_ready(msg) {
            var self = this;
            self.ready = true;
            return self.after_iframe_initialized;
        };
        if (!Editor.prototype.on_iframe_ready.__argnames__) Object.defineProperties(Editor.prototype.on_iframe_ready, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.after_iframe_initialized = function after_iframe_initialized() {
            var self = this;
            var x;
            if (self.pending_set_html !== null) {
                self.set_html(self.pending_set_html);
                self.pending_set_html = null;
            }
            if (self.pending_get_html.length > 0) {
                var _Iter3 = _Iterable(self.pending_get_html);
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    x = _Iter3[_Index3];
                    self.get_html(x);
                }
            }
        };
        if (!Editor.prototype.after_iframe_initialized.__module__) Object.defineProperties(Editor.prototype.after_iframe_initialized, {
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.set_html = function set_html(html) {
            var self = this;
            var rgba;
            if (!self.ready) {
                self.pending_set_html = html;
                return;
            }
            rgba = get_color_as_rgba("window-foreground");
            _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["set_html"].concat([_desugar_kwargs({html: html, color_scheme: color_scheme(), color: "rgba(" + _str.format("{}", rgba[0]) + "," + _str.format("{}", rgba[1]) + "," + _str.format("{}", rgba[2]) + "," + _str.format("{}", rgba[3]) + ")"})]));
        };
        if (!Editor.prototype.set_html.__argnames__) Object.defineProperties(Editor.prototype.set_html, {
            __argnames__ : {value: ["html"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.get_html = function get_html(proceed) {
            var self = this;
            self.get_html_callbacks.push(proceed);
            if (self.ready) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["get_html"].concat([_desugar_kwargs({extract_images: self.insert_image_files})]));
            } else {
                self.pending_get_html.push(proceed);
            }
        };
        if (!Editor.prototype.get_html.__argnames__) Object.defineProperties(Editor.prototype.get_html, {
            __argnames__ : {value: ["proceed"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.on_html_received = function on_html_received(data) {
            var self = this;
            var f;
            if (self.get_html_callbacks.length) {
                var _Iter4 = _Iterable(self.get_html_callbacks);
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    f = _Iter4[_Index4];
                    f(data.html, data.extra_data);
                }
                self.get_html_callbacks = [];
            }
        };
        if (!Editor.prototype.on_html_received.__argnames__) Object.defineProperties(Editor.prototype.on_html_received, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.exec_command = function exec_command() {
            var self = this;
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var value = (arguments[1] === undefined || ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? exec_command.__defaults__.value : arguments[1];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "value")){
                value = _kwargs_obj.value;
            }
            if (self.ready) {
                _interpolate_kwargs.call(self.iframe_wrapper, self.iframe_wrapper.send_message, ["exec_command"].concat([_desugar_kwargs({name: name, value: value})]));
            }
        };
        if (!Editor.prototype.exec_command.__defaults__) Object.defineProperties(Editor.prototype.exec_command, {
            __defaults__ : {value: {value:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "value"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.update_state = function update_state(data) {
            var self = this;
            var c, div, name;
            c = self.iframe.closest("." + CLASS_NAME);
            var _Iter5 = _Iterable(Object.keys(data.state));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                name = _Iter5[_Index5];
                div = c.querySelector("." + _str.format("{}", TOOLBAR_CLASS) + " > [name=\"" + _str.format("{}", name) + "\"]");
                if (div) {
                    if ((_expr_temp = data.state)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name]) {
                        div.classList.add("activated");
                    } else {
                        div.classList.remove("activated");
                    }
                }
            }
        };
        if (!Editor.prototype.update_state.__argnames__) Object.defineProperties(Editor.prototype.update_state, {
            __argnames__ : {value: ["data"]},
            __module__ : {value: "book_list.comments_editor"}
        });
        Editor.prototype.__repr__ = function __repr__ () {
                        return "<" + __name__ + "." + this.constructor.name + " #" + this._object_id + ">";
        };
        Editor.prototype.__str__ = function __str__ () {
            return this.__repr__();
        };
        Object.defineProperty(Editor.prototype, "__bases__", {value: []});
        

        function create_editor(insert_image_files) {
            var iframe_kw, editor, iframe;
            iframe_kw = (function(){
                var _d = Object.create(null);
                _d["sandbox"] = "allow-scripts";
                _d["seamless"] = true;
                _d["style"] = "flex-grow: 10; border: solid 1px currentColor";
                return _d;
            }).call(this);
            editor = new Editor(iframe_kw, insert_image_files);
            iframe = editor.iframe_obj;
            delete editor.iframe_obj;
            add_editor(editor);
            return [iframe, editor];
        };
        if (!create_editor.__argnames__) Object.defineProperties(create_editor, {
            __argnames__ : {value: ["insert_image_files"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function action_activated(editor_id, ac_name, evt) {
            var editor, action, button;
            editor = registry[(typeof editor_id === "number" && editor_id < 0) ? registry.length + editor_id : editor_id];
            if (!editor) {
                return;
            }
            action = (_expr_temp = all_editor_actions())[(typeof ac_name === "number" && ac_name < 0) ? _expr_temp.length + ac_name : ac_name];
            if (!action) {
                return;
            }
            button = evt.currentTarget;
            action.execute(editor, button.classList.contains("activated"));
            editor.focus();
        };
        if (!action_activated.__argnames__) Object.defineProperties(action_activated, {
            __argnames__ : {value: ["editor_id", "ac_name", "evt"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function add_action(toolbar, ac_name, action, editor_id) {
            var b;
            b = _interpolate_kwargs.call(E, E.div, [svgicon(action.icon)].concat([_desugar_kwargs({title: action.title, onclick: action_activated.bind(null, editor_id, ac_name), name: ac_name})]));
            toolbar.appendChild(b);
        };
        if (!add_action.__argnames__) Object.defineProperties(add_action, {
            __argnames__ : {value: ["toolbar", "ac_name", "action", "editor_id"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function create_comments_editor(container, options) {
            var _unpack, iframe, editor, toolbars, toolbar1, toolbar2, toolbar3, acmap, ac_name;
            options = options || Object.create(null);
            _unpack = create_editor(options.insert_image_files);
_unpack = _unpack_asarray(2, _unpack);
            iframe = _unpack[0];
            editor = _unpack[1];
            toolbars = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "flex-grow: 0"})]);
            toolbar1 = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: TOOLBAR_CLASS})]);
            toolbar2 = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: TOOLBAR_CLASS})]);
            toolbar3 = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: TOOLBAR_CLASS})]);
            [toolbars.appendChild(toolbar1), toolbars.appendChild(toolbar2), toolbars.appendChild(toolbar3)];
            acmap = all_editor_actions();
            function add(toolbar, ac_name) {
                if (ac_name) {
                    if (acmap[(typeof ac_name === "number" && ac_name < 0) ? acmap.length + ac_name : ac_name]) {
                        add_action(toolbar, ac_name, acmap[(typeof ac_name === "number" && ac_name < 0) ? acmap.length + ac_name : ac_name], editor.id);
                    } else {
                        toolbar.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "sep"})]));
                    }
                }
            };
            if (!add.__argnames__) Object.defineProperties(add, {
                __argnames__ : {value: ["toolbar", "ac_name"]},
                __module__ : {value: "book_list.comments_editor"}
            });

            var _Iter6 = _Iterable("undo redo select-all remove-format bold italic underline strikethrough".split(" "));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                ac_name = _Iter6[_Index6];
                add(toolbar1, ac_name);
            }
            var _Iter7 = _Iterable("hr superscript subscript format-block ul ol indent outdent".split(" "));
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                ac_name = _Iter7[_Index7];
                add(toolbar2, ac_name);
            }
            var _Iter8 = _Iterable("justify-left justify-center justify-right justify-full insert-link insert-image fg bg".split(" "));
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                ac_name = _Iter8[_Index8];
                add(toolbar3, ac_name);
            }
            container.setAttribute("style", (container.getAttribute("style") || "") + ";display: flex; flex-direction: column; align-items: stretch");
            container.appendChild(toolbars);
            container.appendChild(iframe);
            container.classList.add(CLASS_NAME);
            return editor;
        };
        if (!create_comments_editor.__argnames__) Object.defineProperties(create_comments_editor, {
            __argnames__ : {value: ["container", "options"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function focus_comments_editor(container) {
            var iframe, editor;
            iframe = container.querySelector("iframe");
            editor = registry[_bound_index(iframe.getAttribute("id"), registry)];
            if (editor) {
                editor.focus();
            }
        };
        if (!focus_comments_editor.__argnames__) Object.defineProperties(focus_comments_editor, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function set_comments_html(container, html) {
            var iframe, eid, editor;
            iframe = container.querySelector("iframe");
            eid = iframe.getAttribute("id");
            editor = registry[(typeof eid === "number" && eid < 0) ? registry.length + eid : eid];
            editor.set_html(html || "");
        };
        if (!set_comments_html.__argnames__) Object.defineProperties(set_comments_html, {
            __argnames__ : {value: ["container", "html"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function get_comments_html(container, proceed) {
            var iframe, eid, editor;
            iframe = container.querySelector("iframe");
            eid = iframe.getAttribute("id");
            editor = registry[(typeof eid === "number" && eid < 0) ? registry.length + eid : eid];
            editor.get_html(proceed);
        };
        if (!get_comments_html.__argnames__) Object.defineProperties(get_comments_html, {
            __argnames__ : {value: ["container", "proceed"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function develop(container) {
            var editor;
            container.setAttribute("style", "width: 100%; min-height: 90vh; display: flex; flex-direction: column; align-items: stretch");
            editor = create_comments_editor(container);
            set_comments_html(container, "<p>Testing, <i>testing</i> 123...");
            focus_comments_editor(container);
            editor.init();
        };
        if (!develop.__argnames__) Object.defineProperties(develop, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.comments_editor"}
        });

        function main() {
            main.boss = new CommentsEditorBoss;
        };
        if (!main.__module__) Object.defineProperties(main, {
            __module__ : {value: "book_list.comments_editor"}
        });

        _modules["book_list.comments_editor"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.comments_editor"].TOOLBAR_CLASS = TOOLBAR_CLASS;
        _modules["book_list.comments_editor"].registry = registry;
        _modules["book_list.comments_editor"].choose_block_style = choose_block_style;
        _modules["book_list.comments_editor"].insert_heading = insert_heading;
        _modules["book_list.comments_editor"].insert_image = insert_image;
        _modules["book_list.comments_editor"].insert_link = insert_link;
        _modules["book_list.comments_editor"].insert_link_or_image = insert_link_or_image;
        _modules["book_list.comments_editor"].set_color = set_color;
        _modules["book_list.comments_editor"].change_color = change_color;
        _modules["book_list.comments_editor"].all_editor_actions = all_editor_actions;
        _modules["book_list.comments_editor"].style_from_align = style_from_align;
        _modules["book_list.comments_editor"].CommentsEditorBoss = CommentsEditorBoss;
        _modules["book_list.comments_editor"].destroy_removed_editors = destroy_removed_editors;
        _modules["book_list.comments_editor"].add_editor = add_editor;
        _modules["book_list.comments_editor"].destroy_editor = destroy_editor;
        _modules["book_list.comments_editor"].Editor = Editor;
        _modules["book_list.comments_editor"].create_editor = create_editor;
        _modules["book_list.comments_editor"].action_activated = action_activated;
        _modules["book_list.comments_editor"].add_action = add_action;
        _modules["book_list.comments_editor"].create_comments_editor = create_comments_editor;
        _modules["book_list.comments_editor"].focus_comments_editor = focus_comments_editor;
        _modules["book_list.comments_editor"].set_comments_html = set_comments_html;
        _modules["book_list.comments_editor"].get_comments_html = get_comments_html;
        _modules["book_list.comments_editor"].develop = develop;
        _modules["book_list.comments_editor"].main = main;
    })();

    (function(){
        var __name__ = "book_list.edit_metadata";
        var CLASS_NAME, IGNORED_FIELDS, value_to_json, changes, has_changes;
        var E = _modules.elementmaker.E;

        var traceback = _modules.traceback;

        var ajax_send = _modules.ajax.ajax_send;

        var add_stars_to = _modules["book_list.book_details"].add_stars_to;
        var basic_table_rules = _modules["book_list.book_details"].basic_table_rules;
        var fetch_metadata = _modules["book_list.book_details"].fetch_metadata;
        var field_sorter = _modules["book_list.book_details"].field_sorter;
        var no_book = _modules["book_list.book_details"].no_book;
        var report_load_failure = _modules["book_list.book_details"].report_load_failure;

        var create_comments_editor = _modules["book_list.comments_editor"].create_comments_editor;
        var focus_comments_editor = _modules["book_list.comments_editor"].focus_comments_editor;
        var get_comments_html = _modules["book_list.comments_editor"].get_comments_html;
        var set_comments_html = _modules["book_list.comments_editor"].set_comments_html;

        var get_current_query = _modules["book_list.globals"].get_current_query;
        var book_whose_metadata_is_being_edited = _modules["book_list.globals"].book_whose_metadata_is_being_edited;

        var book_metadata = _modules["book_list.library_data"].book_metadata;
        var cover_url = _modules["book_list.library_data"].cover_url;
        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var field_names_for = _modules["book_list.library_data"].field_names_for;
        var library_data = _modules["book_list.library_data"].library_data;
        var load_status = _modules["book_list.library_data"].load_status;
        var loaded_book_ids = _modules["book_list.library_data"].loaded_book_ids;
        var set_book_metadata = _modules["book_list.library_data"].set_book_metadata;

        var back = _modules["book_list.router"].back;
        var push_state = _modules["book_list.router"].push_state;
        var show_note = _modules["book_list.router"].show_note;

        var get_color = _modules["book_list.theme"].get_color;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;
        var set_title = _modules["book_list.top_bar"].set_title;

        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;
        var show_panel = _modules["book_list.ui"].show_panel;

        var UNDEFINED_DATE_ISO = _modules.date.UNDEFINED_DATE_ISO;
        var format_date = _modules.date.format_date;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var svgicon = _modules.dom.svgicon;

        var update_status_widget = _modules.file_uploads.update_status_widget;
        var upload_files_widget = _modules.file_uploads.upload_files_widget;
        var upload_status_widget = _modules.file_uploads.upload_status_widget;

        var _ = _modules.gettext.gettext;

        var error_dialog = _modules.modals.error_dialog;
        var question_dialog = _modules.modals.question_dialog;

        var get_interface_data = _modules.session.get_interface_data;

        var conditional_timeout = _modules.utils.conditional_timeout;
        var fmt_sidx = _modules.utils.fmt_sidx;
        var parse_url_params = _modules.utils.parse_url_params;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;

        CLASS_NAME = "edit-metadata-panel";
        IGNORED_FIELDS = (function(){
            var s = _set();
            s.jsset.add("sort");
            s.jsset.add("uuid");
            s.jsset.add("id");
            s.jsset.add("urls_from_identifiers");
            s.jsset.add("lang_names");
            s.jsset.add("last_modified");
            s.jsset.add("path");
            s.jsset.add("marked");
            s.jsset.add("size");
            s.jsset.add("ondevice");
            s.jsset.add("cover");
            s.jsset.add("au_map");
            s.jsset.add("isbn");
            s.jsset.add("in_tag_browser");
            return s;
        })();
        function identity(x) {
            return x;
        };
        if (!identity.__argnames__) Object.defineProperties(identity, {
            __argnames__ : {value: ["x"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        value_to_json = identity;
        changes = Object.create(null);
        has_changes = false;
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME + " ";
                style = basic_table_rules(sel);
                style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata"].concat([_desugar_kwargs({width: "100%"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata td"].concat([_desugar_kwargs({padding_bottom: "0.5ex", padding_top: "0.5ex", cursor: "pointer"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata tr:hover td:first-of-type"].concat([_desugar_kwargs({color: "green"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "table.metadata tr:active"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".completions"].concat([_desugar_kwargs({display: "flex", flex_wrap: "wrap", align_items: "center", margin_bottom: "0.5ex"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".completions > div"].concat([_desugar_kwargs({margin: "0.5ex 0.5rem", margin_left: "0", padding: "0.5ex 0.5rem", border: "solid 1px currentColor", border_radius: "1ex", cursor: "pointer"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".completions > div:active"].concat([_desugar_kwargs({transform: "scale(1.5)"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".completions > div:hover"].concat([_desugar_kwargs({background: get_color("window-foreground"), color: get_color("window-background")})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".rating-edit-container"].concat([_desugar_kwargs({display: "flex", flex_wrap: "wrap", align_items: "center", list_style_type: "none"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".rating-edit-container > li"].concat([_desugar_kwargs({margin: "0.5ex 0.5rem", margin_left: "0", padding: "0.5ex 0.5rem", border: "solid 1px currentColor", border_radius: "1ex", cursor: "pointer"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".rating-edit-container > li.current-rating"].concat([_desugar_kwargs({color: get_color("window-background"), background: get_color("window-foreground")})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.edit_metadata"}
            });
            return _anonfunc;
        })());
        function resolved_metadata(mi, field) {
            if (Object.prototype.hasOwnProperty.call(changes, field)) {
                return changes[(typeof field === "number" && field < 0) ? changes.length + field : field];
            }
            return mi[(typeof field === "number" && field < 0) ? mi.length + field : field];
        };
        if (!resolved_metadata.__argnames__) Object.defineProperties(resolved_metadata, {
            __argnames__ : {value: ["mi", "field"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function resolved_formats(val) {
            var ext, data, fmt;
            val = list(val || []);
            if (changes.added_formats) {
                var _Iter0 = _Iterable(changes.added_formats);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    data = _Iter0[_Index0];
                    ext = data.ext.toUpperCase();
                    if (ext && !_in(ext, val)) {
                        val.push(ext);
                    }
                }
            }
            if (changes.removed_formats) {
                var _Iter1 = _Iterable(changes.removed_formats);
                for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                    fmt = _Iter1[_Index1];
                    fmt = fmt.toUpperCase();
                    if (_in(fmt, val)) {
                        val.remove(fmt);
                    }
                }
            }
            val.sort();
            return val;
        };
        if (!resolved_formats.__argnames__) Object.defineProperties(resolved_formats, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function truncated_html(val) {
            var ans;
            ans = val.replace(/<[^>]+>/g, "");
            if (ans.length > 40) {
                ans = ans.slice(0, 40) + "";
            }
            return ans;
        };
        if (!truncated_html.__argnames__) Object.defineProperties(truncated_html, {
            __argnames__ : {value: ["val"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function onsubmit_field2(container_id, book_id, field, value) {
            var c, d, is_series, unchanged;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            d = c.querySelector("div[data-ctype=\"edit\"]");
            if (!d) {
                return;
            }
            is_series = value.series_index !== undefined;
            if (is_series) {
                unchanged = value.series_name === (_expr_temp = book_metadata(book_id))[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field] && value.series_index === (_expr_temp = book_metadata(book_id))[_bound_index(field + "_index", _expr_temp)];
            } else {
                unchanged = value === (_expr_temp = book_metadata(book_id))[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field];
            }
            if (unchanged) {
                on_close(container_id);
                return;
            }
            clear(d);
            d.appendChild(_interpolate_kwargs.call(E, E.div, [_("Contacting server, please wait") + ""].concat([_desugar_kwargs({style: "margin: 1ex 1rem"})])));
            if (is_series) {
                changes[(typeof field === "number" && field < 0) ? changes.length + field : field] = value_to_json(value.series_name);
                changes[_bound_index(field + "_index", changes)] = float(value.series_index);
            } else {
                changes[(typeof field === "number" && field < 0) ? changes.length + field : field] = value_to_json(value);
            }
            has_changes = true;
            show_book(container_id, book_id);
            on_close(container_id);
        };
        if (!onsubmit_field2.__argnames__) Object.defineProperties(onsubmit_field2, {
            __argnames__ : {value: ["container_id", "book_id", "field", "value"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function onsubmit_field(get_value, container_id, book_id, field) {
            var c, d, _unpack, ok, value;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            d = c.querySelector("div[data-ctype=\"edit\"]");
            if (!d) {
                return;
            }
            if (get_value === html_edit_get_value) {
                html_edit_get_value(d, onsubmit_field2.bind(null, container_id, book_id, field));
            } else {
                _unpack = get_value(d);
_unpack = _unpack_asarray(2, _unpack);
                ok = _unpack[0];
                value = _unpack[1];
                if (!ok) {
                    return;
                }
                window.setTimeout(onsubmit_field2, 0, container_id, book_id, field, value);
            }
        };
        if (!onsubmit_field.__argnames__) Object.defineProperties(onsubmit_field, {
            __argnames__ : {value: ["get_value", "container_id", "book_id", "field"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function create_form(widget, get_value, container_id, book_id, field) {
            var submit_action, button, form;
            submit_action = onsubmit_field.bind(null, get_value, container_id, book_id, field);
            button = _interpolate_kwargs.call(this, create_button, [_("OK")].concat([_desugar_kwargs({action: submit_action})]));
            widget.classList.add("metadata-editor");
            form = _interpolate_kwargs.call(E, E.form, [_interpolate_kwargs.call(E, E.div, [widget].concat([_desugar_kwargs({style: "margin-bottom: 1ex"})])), _interpolate_kwargs.call(E, E.div, [button].concat([_desugar_kwargs({class_: "edit-form-button-container"})])), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "submit", style: "display:none"})])].concat([_desugar_kwargs({action: "javascript: void(0)", onsubmit: submit_action, style: "margin: 1ex auto"})]));
            return form;
        };
        if (!create_form.__argnames__) Object.defineProperties(create_form, {
            __argnames__ : {value: ["widget", "get_value", "container_id", "book_id", "field"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function line_edit_get_value(container) {
            return [true, container.querySelector("input[type=\"text\"]").value];
        };
        if (!line_edit_get_value.__argnames__) Object.defineProperties(line_edit_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function simple_line_edit(container_id, book_id, field, fm, div, mi) {
            var name, le, form;
            name = fm.name || field;
            le = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: name.replace("#", "_c_"), autocomplete: true, style: "width: 100%"})]);
            le.value = resolved_metadata(mi, field) || "";
            form = create_form(le, line_edit_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            [le.focus(), le.select()];
            value_to_json = identity;
        };
        if (!simple_line_edit.__argnames__) Object.defineProperties(simple_line_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function text_edit_get_value(container) {
            return [true, container.querySelector("textarea").value];
        };
        if (!text_edit_get_value.__argnames__) Object.defineProperties(text_edit_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function text_edit(container_id, book_id, field, fm, div, mi, get_name) {
            var name, le, form;
            name = fm.name || field;
            le = _interpolate_kwargs.call(E, E.textarea, [_desugar_kwargs({name: name.replace("#", "_c_"), spellcheck: "true", wrap: "soft", style: "width: 100%; min-height: 70vh"})]);
            le.value = resolved_metadata(mi, get_name || field) || "";
            form = create_form(le, text_edit_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            le.focus();
        };
        if (!text_edit.__argnames__) Object.defineProperties(text_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi", "get_name"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function html_edit_get_value(container, proceed) {
            get_comments_html(container, (function() {
                var _anonfunc = function (html, data) {
                    proceed(html);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["html", "data"]},
                    __module__ : {value: "book_list.edit_metadata"}
                });
                return _anonfunc;
            })());
        };
        if (!html_edit_get_value.__argnames__) Object.defineProperties(html_edit_get_value, {
            __argnames__ : {value: ["container", "proceed"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function html_edit(container_id, book_id, field, fm, div, mi) {
            var val, name, c, form, editor;
            value_to_json = identity;
            val = resolved_metadata(mi, field) || "";
            name = fm.name || field;
            c = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "width: 100%; min-height: 75vh"})]);
            form = create_form(c, html_edit_get_value, container_id, book_id, field);
            editor = create_comments_editor(c);
            set_comments_html(c, val);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            focus_comments_editor(c);
            value_to_json = identity;
            editor.init();
        };
        if (!html_edit.__argnames__) Object.defineProperties(html_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function number_edit_get_value(container) {
            return [true, container.querySelector("input[type=\"number\"]").value];
        };
        if (!number_edit_get_value.__argnames__) Object.defineProperties(number_edit_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function number_edit(container_id, book_id, field, fm, div, mi) {
            var name, le, val, form;
            name = fm.name || field;
            le = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", name: name.replace("#", "_c_"), step: (fm.datatype === "float") ? "any" : "1"})]);
            val = resolved_metadata(mi, field);
            if ((typeof val !== "undefined" && val !== null)) {
                le.value = val;
            } else {
                le.value = "";
            }
            form = create_form(le, number_edit_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            [le.focus(), le.select()];
            function safe_parse(x) {
                var f, ans;
                f = (fm.datatype === "float") ? parseFloat : parseInt;
                ans = f(x);
                if (isNaN(ans)) {
                    ans = null;
                }
                return ans;
            };
            if (!safe_parse.__argnames__) Object.defineProperties(safe_parse, {
                __argnames__ : {value: ["x"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            value_to_json = safe_parse;
        };
        if (!number_edit.__argnames__) Object.defineProperties(number_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function remove_item(container_id, name) {
            var c, le, val, x;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            le = c.querySelector("[data-ctype=\"edit\"] input");
            val = le.value || "";
            val = value_to_json(val);
            val = (function() {
                var _Iter = _Iterable(val), _Result = [], x;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    x = _Iter[_Index];
                    if (x !== name) {
                        _Result.push(x);
                    }
                }
                _Result = _list_constructor(_Result);
                return _Result;
            })();
            le.value = val.join(update_completions.list_to_ui);
            le.focus();
            line_edit_updated(container_id, le.dataset.field);
        };
        if (!remove_item.__argnames__) Object.defineProperties(remove_item, {
            __argnames__ : {value: ["container_id", "name"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function add_completion(container_id, name) {
            var c, le, val;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            le = c.querySelector("[data-ctype=\"edit\"] input");
            val = le.value || "";
            val = value_to_json(val);
            if (typeof val === "string") {
                le.value = name;
            } else if (val) {
                if (val.length) {
                    val[val.length-1] = name;
                } else {
                    val.push(name);
                }
                le.value = val.join(update_completions.list_to_ui) + update_completions.list_to_ui;
            }
            le.focus();
            line_edit_updated(container_id, le.dataset.field);
        };
        if (!add_completion.__argnames__) Object.defineProperties(add_completion, {
            __argnames__ : {value: ["container_id", "name"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function show_completions(container_id, div, field, prefix, names) {
            var completions, _unpack, i, name;
            clear(div);
            completions = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "completions"})]);
            if (names.length) {
                div.appendChild(E.div(_("Tap to add:")));
            }
            div.appendChild(completions);
            var _Iter2 = _Iterable(enumerate(names));
            for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                _unpack = _Iter2[_Index2];
                i = _unpack[0];
                name = _unpack[1];
                completions.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [svgicon("plus"), ""].concat([_desugar_kwargs({style: "color: green"})])), name].concat([_desugar_kwargs({onclick: add_completion.bind(null, container_id, name)})])));
                if (i >= 50) {
                    break;
                }
            }
        };
        if (!show_completions.__argnames__) Object.defineProperties(show_completions, {
            __argnames__ : {value: ["container_id", "div", "field", "prefix", "names"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function query_contains(haystack, needle) {
            return haystack.toLowerCase().indexOf(needle) !== -1;
        };
        if (!query_contains.__argnames__) Object.defineProperties(query_contains, {
            __argnames__ : {value: ["haystack", "needle"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function query_startswitch(haystack, needle) {
            return haystack.toLowerCase().indexOf(needle) === 0;
        };
        if (!query_startswitch.__argnames__) Object.defineProperties(query_startswitch, {
            __argnames__ : {value: ["haystack", "needle"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function update_removals(container_id) {
            var c, d, div, val, removals, _unpack, i, name;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            d = c.querySelector("div[data-ctype=\"edit\"]");
            if (!d || d.style.display !== "block") {
                return;
            }
            div = d.lastChild.previousSibling;
            clear(div);
            val = _exists.d(d.querySelector("input")).value || "";
            val = value_to_json(val);
            if (typeof val === "string" || !val.length) {
                return;
            }
            div.appendChild(E.div(_("Tap to remove:")));
            removals = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "completions"})]);
            div.appendChild(removals);
            var _Iter3 = _Iterable(enumerate(val));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                _unpack = _Iter3[_Index3];
                i = _unpack[0];
                name = _unpack[1];
                removals.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [svgicon("eraser"), ""].concat([_desugar_kwargs({style: "color: " + get_color("window-error-foreground")})])), name].concat([_desugar_kwargs({onclick: remove_item.bind(null, container_id, name)})])));
                if (i >= 50) {
                    break;
                }
            }
        };
        if (!update_removals.__argnames__) Object.defineProperties(update_removals, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function update_completions(container_id, ok, field, names) {
            var c, d, div, err, val, prefix, needle, interface_data, universe, q, matching_names, x;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            d = c.querySelector("div[data-ctype=\"edit\"]");
            if (!d || d.style.display !== "block") {
                return;
            }
            div = d.lastChild;
            clear(div);
            if (!ok) {
                err = E.div();
                safe_set_inner_html(err, names);
                div.appendChild(E.div(_("Failed to download items for completion, with error:"), err));
                return;
            }
            val = d.querySelector("input").value || "";
            val = value_to_json(val);
            if (typeof val === "string") {
                prefix = val;
            } else {
                prefix = (val.length) ? val[val.length-1] : "";
            }
            if (prefix === update_completions.prefix) {
                return;
            }
            needle = prefix.toLowerCase().strip();
            if (needle) {
                interface_data = get_interface_data();
                universe = (update_completions.prefix && needle.startswith(update_completions.prefix.toLowerCase())) ? update_completions.names : names;
                q = (interface_data.completion_mode === "contains") ? query_contains : query_startswitch;
                matching_names = (function() {
                    var _Iter = _Iterable(universe), _Result = [], x;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        x = _Iter[_Index];
                        if (q(x, needle) && x !== prefix) {
                            _Result.push(x);
                        }
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })();
            } else {
                matching_names = _list_decorate([]);
            }
            update_completions.prefix = prefix;
            update_completions.names = matching_names;
            show_completions(container_id, div, field, prefix, matching_names);
        };
        if (!update_completions.__argnames__) Object.defineProperties(update_completions, {
            __argnames__ : {value: ["container_id", "ok", "field", "names"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        update_completions.list_to_ui = null;
        update_completions.names = [];
        update_completions.prefix = "";
        function line_edit_updated(container_id, field) {
            field_names_for(field, update_completions.bind(null, container_id));
            update_removals(container_id);
        };
        if (!line_edit_updated.__argnames__) Object.defineProperties(line_edit_updated, {
            __argnames__ : {value: ["container_id", "field"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function multiple_line_edit(list_to_ui, ui_to_list, container_id, book_id, field, fm, div, mi) {
            var name, le, val, l, form;
            update_completions.list_to_ui = list_to_ui;
            name = fm.name || field;
            le = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: name.replace("#", "_c_"), style: "width: 100%", autocomplete: "off", data_field: field, oninput: line_edit_updated.bind(null, container_id, field)})]);
            val = resolved_metadata(mi, field) || [];
            if (field === "languages") {
                val = (function() {
                    var _Iter = _Iterable(val), _Result = [], l;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        l = _Iter[_Index];
                        _Result.push((_expr_temp = mi.lang_names)[(typeof l === "number" && l < 0) ? _expr_temp.length + l : l] || l);
                    }
                    _Result = _list_constructor(_Result);
                    return _Result;
                })();
            }
            if (list_to_ui) {
                val = val.join(list_to_ui);
            }
            le.value = val;
            form = create_form(le, line_edit_get_value, container_id, book_id, field);
            if (list_to_ui) {
                div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{0}\" below. Multiple items can be separated by \"{1}\".").format(name, list_to_ui.strip())].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            } else {
                div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{0}\" below.").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            }
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 0.5ex 1rem"})]));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [E.span(_("Loading all {}...").format(name))].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            [le.focus(), le.select()];
            if (list_to_ui) {
                value_to_json = (function() {
                    var _anonfunc = function (raw) {
                        var seen, ans, x;
                        seen = Object.create(null);
                        ans = [];
                        var _Iter4 = _Iterable((function() {
                            var _Iter = _Iterable(raw.split(ui_to_list)), _Result = [], a;
                            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                                a = _Iter[_Index];
                                if (a.strip()) {
                                    _Result.push(a.strip());
                                }
                            }
                            _Result = _list_constructor(_Result);
                            return _Result;
                        })());
                        for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                            x = _Iter4[_Index4];
                            if (!seen[(typeof x === "number" && x < 0) ? seen.length + x : x]) {
                                seen[(typeof x === "number" && x < 0) ? seen.length + x : x] = true;
                                ans.push(x);
                            }
                        }
                        return ans;
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["raw"]},
                        __module__ : {value: "book_list.edit_metadata"}
                    });
                    return _anonfunc;
                })();
            } else {
                value_to_json = identity;
            }
            field_names_for(field, update_completions.bind(null, container_id));
            update_removals(container_id);
        };
        if (!multiple_line_edit.__argnames__) Object.defineProperties(multiple_line_edit, {
            __argnames__ : {value: ["list_to_ui", "ui_to_list", "container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function series_edit_get_value(container) {
            var val;
            val = (function(){
                var _d = Object.create(null);
                _d["series_name"] = container.querySelector("input[type=\"text\"]").value;
                _d["series_index"] = parseFloat(parseFloat(container.querySelector("input[type=\"number\"]").value).toFixed(2));
                return _d;
            }).call(this);
            return [true, val];
        };
        if (!series_edit_get_value.__argnames__) Object.defineProperties(series_edit_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function series_edit(container_id, book_id, field, fm, div, mi) {
            var name, le, ne, table, form;
            name = fm.name || field;
            le = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: name.replace("#", "_c_"), style: "width: 100%", oninput: line_edit_updated.bind(null, container_id, field), data_field: field})]);
            le.value = resolved_metadata(mi, field) || "";
            value_to_json = identity;
            ne = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", step: "any", name: name.replace("#", "_c_") + "_index"})]);
            ne.value = parseFloat(parseFloat(resolved_metadata(mi, field + "_index")).toFixed(2));
            table = _interpolate_kwargs.call(E, E.table, [E.tr(E.td(_("Name:") + ""), _interpolate_kwargs.call(E, E.td, [le].concat([_desugar_kwargs({style: "width: 99%; padding-bottom: 1ex"})]))), E.tr(E.td(_("Number:") + ""), E.td(ne))].concat([_desugar_kwargs({style: "width: 100%"})]));
            form = create_form(table, series_edit_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below.").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin: 0.5ex 1rem"})]));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [E.span(_("Loading all {}...").format(name))].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            [le.focus(), le.select()];
            field_names_for(field, update_completions.bind(null, container_id));
        };
        if (!series_edit.__argnames__) Object.defineProperties(series_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function date_edit_get_value(container) {
            return [true, container.querySelector("input[type=\"date\"]").value];
        };
        if (!date_edit_get_value.__argnames__) Object.defineProperties(date_edit_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function date_to_datetime(raw) {
            if (!raw) {
                return UNDEFINED_DATE_ISO;
            }
            return raw + "T12:00:00+00:00";
        };
        if (!date_to_datetime.__argnames__) Object.defineProperties(date_to_datetime, {
            __argnames__ : {value: ["raw"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function date_edit(container_id, book_id, field, fm, div, mi) {
            var name, le, val, form;
            value_to_json = date_to_datetime;
            name = fm.name || field;
            le = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "date", name: name.replace("#", "_c_"), min: UNDEFINED_DATE_ISO.split("T")[0], pattern: "[0-9]{4}-[0-9]{2}-[0-9]{2}"})]);
            val = resolved_metadata(mi, field) || "";
            if (val) {
                val = format_date(val, "yyyy-MM-dd");
            }
            le.value = val || "";
            form = create_form(le, date_edit_get_value, container_id, book_id, field);
            function clear(ev) {
                ev.currentTarget.closest("form").querySelector("input").value = "";
            };
            if (!clear.__argnames__) Object.defineProperties(clear, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function today(ev) {
                ev.currentTarget.closest("form").querySelector("input").value = (new Date).toISOString().substr(0, 10);
            };
            if (!today.__argnames__) Object.defineProperties(today, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            form.firstChild.appendChild(E.span("", _interpolate_kwargs.call(this, create_button, [_("Clear")].concat([_desugar_kwargs({action: clear})])), "", _interpolate_kwargs.call(this, create_button, [_("Today")].concat([_desugar_kwargs({action: today})]))));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below.").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            [le.focus(), le.select()];
        };
        if (!date_edit.__argnames__) Object.defineProperties(date_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function remove_identifier(evt) {
            var li;
            li = evt.currentTarget.closest("li");
            li.parentNode.removeChild(li);
        };
        if (!remove_identifier.__argnames__) Object.defineProperties(remove_identifier, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function add_identifier(container_id, name, val) {
            var c, b;
            c = _exists.d(document.getElementById(container_id)).querySelector(".identifiers-edit");
            if (!c) {
                return;
            }
            b = _interpolate_kwargs.call(this, create_button, [_("Remove")].concat([_desugar_kwargs({action: remove_identifier})]));
            c.appendChild(_interpolate_kwargs.call(E, E.li, [_interpolate_kwargs.call(E, E.table, [E.tr(E.td(_("Type:") + ""), _interpolate_kwargs.call(E, E.td, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", style: "width:100%", autocomplete: true, value: name || ""})])].concat([_desugar_kwargs({style: "padding-bottom: 1ex; width: 99%"})])), _interpolate_kwargs.call(E, E.td, [b].concat([_desugar_kwargs({rowspan: "2", style: "padding: 0.5ex 1rem; vertical-align: middle"})]))), E.tr(E.td(_("Value:") + ""), E.td(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", style: "width: 100%", autocomplete: true, value: val || ""})])))].concat([_desugar_kwargs({style: "width: 100%"})]))].concat([_desugar_kwargs({style: "padding-bottom: 1ex; margin-bottom: 1ex; border-bottom: solid 1px currentColor"})])));
        };
        if (!add_identifier.__argnames__) Object.defineProperties(add_identifier, {
            __argnames__ : {value: ["container_id", "name", "val"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function identifiers_get_value(container) {
            var ans, _unpack, n, v, li;
            ans = Object.create(null);
            var _Iter5 = _Iterable(container.querySelectorAll(".identifiers-edit > li"));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                li = _Iter5[_Index5];
                _unpack = li.querySelectorAll("input");
_unpack = _unpack_asarray(2, _unpack);
                n = _unpack[0];
                v = _unpack[1];
                _unpack = [n.value, v.value];
                n = _unpack[0];
                v = _unpack[1];
                if (n && v) {
                    ans[(typeof n === "number" && n < 0) ? ans.length + n : n] = v;
                }
            }
            return [true, ans];
        };
        if (!identifiers_get_value.__argnames__) Object.defineProperties(identifiers_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function identifiers_edit(container_id, book_id, field, fm, div, mi) {
            var name, val, c, form, bc, k;
            name = fm.name || field;
            val = resolved_metadata(mi, "identifiers") || Object.create(null);
            c = _interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({class_: "identifiers-edit", style: "list-style-type: none"})]);
            form = create_form(c, identifiers_get_value, container_id, book_id, field);
            bc = form.querySelector(".edit-form-button-container");
            bc.insertBefore(create_button(_("Add identifier"), null, add_identifier.bind(null, container_id, "", "")), bc.firstChild);
            bc.insertBefore(document.createTextNode(""), bc.lastChild);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Edit the \"{}\" below.").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            var _Iter6 = _Iterable(Object.keys(val));
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                k = _Iter6[_Index6];
                add_identifier(container_id, k, val[(typeof k === "number" && k < 0) ? val.length + k : k]);
            }
            value_to_json = identity;
        };
        if (!identifiers_edit.__argnames__) Object.defineProperties(identifiers_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function rating_get_value(container) {
            return [true, parseInt(container.querySelector(".current-rating[data-rating]").getAttribute("data-rating"))];
        };
        if (!rating_get_value.__argnames__) Object.defineProperties(rating_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function set_rating(evt) {
            var li, nli;
            li = evt.currentTarget;
            var _Iter7 = _Iterable(li.closest("ul").childNodes);
            for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                nli = _Iter7[_Index7];
                nli.classList.remove("current-rating");
            }
            li.classList.add("current-rating");
        };
        if (!set_rating.__argnames__) Object.defineProperties(set_rating, {
            __argnames__ : {value: ["evt"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function rating_edit(container_id, book_id, field, fm, div, mi) {
            var val, numbers, name, c, s, n, form;
            val = resolved_metadata(mi, field) || 0;
            numbers = (_exists.d(fm.display).allow_half_stars) ? list(range(11)) : list(range(0, 11, 2));
            name = fm.name || field;
            c = _interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({class_: "rating-edit-container"})]);
            var _Iter8 = _Iterable(numbers);
            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                n = _Iter8[_Index8];
                s = _interpolate_kwargs.call(E, E.li, [_desugar_kwargs({data_rating: n + "", onclick: set_rating})]);
                c.appendChild(s);
                if (n === val) {
                    s.classList.add("current-rating");
                }
                if (n) {
                    add_stars_to(s, n, numbers.length > 6);
                } else {
                    s.appendChild(document.createTextNode(_("Unrated")));
                }
            }
            form = create_form(c, rating_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Choose the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            value_to_json = identity;
        };
        if (!rating_edit.__argnames__) Object.defineProperties(rating_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function enum_get_value(container) {
            return [true, container.querySelector(".current-rating[data-rating]").getAttribute("data-rating")];
        };
        if (!enum_get_value.__argnames__) Object.defineProperties(enum_get_value, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function enum_edit(container_id, book_id, field, fm, div, mi) {
            var val, name, c, s, n, form;
            val = resolved_metadata(mi, field) || "";
            name = fm.name || field;
            c = _interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({class_: "rating-edit-container"})]);
            var _Iter9 = _Iterable([""].concat(fm.display.enum_values));
            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                n = _Iter9[_Index9];
                s = _interpolate_kwargs.call(E, E.li, [_desugar_kwargs({data_rating: n + "", onclick: set_rating})]);
                c.appendChild(s);
                if (n === val) {
                    s.classList.add("current-rating");
                }
                s.appendChild(document.createTextNode(n || _("Blank")));
            }
            form = create_form(c, enum_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Choose the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            value_to_json = identity;
        };
        if (!enum_edit.__argnames__) Object.defineProperties(enum_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function bool_edit(container_id, book_id, field, fm, div, mi) {
            var val, name, c, names, s, n, form, val_map;
            val = resolved_metadata(mi, field);
            if (val) {
                val = "y";
            } else {
                if (val === false) {
                    val = "n";
                } else {
                    val = "";
                }
            }
            name = fm.name || field;
            c = _interpolate_kwargs.call(E, E.ul, [_desugar_kwargs({class_: "rating-edit-container"})]);
            names = (function(){
                var _d = Object.create(null);
                _d[""] = _("Blank");
                _d["y"] = _("Yes");
                _d["n"] = _("No");
                return _d;
            }).call(this);
            var _Iter10 = _Iterable(['', 'y', 'n']);
            for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                n = _Iter10[_Index10];
                s = _interpolate_kwargs.call(E, E.li, [_desugar_kwargs({data_rating: n + "", onclick: set_rating})]);
                c.appendChild(s);
                if (n === val) {
                    s.classList.add("current-rating");
                }
                s.appendChild(document.createTextNode(names[(typeof n === "number" && n < 0) ? names.length + n : n]));
            }
            form = create_form(c, enum_get_value, container_id, book_id, field);
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_("Choose the \"{}\" below").format(name)].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [form].concat([_desugar_kwargs({style: "margin: 0.5ex 1rem"})])));
            val_map = (function(){
                var _d = Object.create(null);
                _d[""] = null;
                _d["y"] = true;
                _d["n"] = false;
                return _d;
            }).call(this);
            value_to_json = (function() {
                var _anonfunc = function (x) {
                    return val_map[(typeof x === "number" && x < 0) ? val_map.length + x : x];
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["x"]},
                    __module__ : {value: "book_list.edit_metadata"}
                });
                return _anonfunc;
            })();
        };
        if (!bool_edit.__argnames__) Object.defineProperties(bool_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function cover_chosen(top_container_id, book_id, container_id, files) {
            var container, file;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            if (!files[0]) {
                return;
            }
            file = files[0];
            changes.cover = file;
            has_changes = true;
            on_close(top_container_id);
        };
        if (!cover_chosen.__argnames__) Object.defineProperties(cover_chosen, {
            __argnames__ : {value: ["top_container_id", "book_id", "container_id", "files"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        cover_chosen.counter = 0;
        function remove_cover(top_container_id, book_id) {
            changes.cover = "--remove--";
            has_changes = true;
            on_close(top_container_id);
        };
        if (!remove_cover.__argnames__) Object.defineProperties(remove_cover, {
            __argnames__ : {value: ["top_container_id", "book_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function cover_edit(container_id, book_id, field, fm, div, mi) {
            _interpolate_kwargs.call(this, upload_files_widget, [div, cover_chosen.bind(null, container_id, book_id), _("Change the cover by <a>selecting the cover image</a> or drag and drop of the cover image here.")].concat([_desugar_kwargs({single_file: true, accept_extensions: "png jpeg jpg"})]));
            div.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Remove existing cover")].concat([_desugar_kwargs({action: remove_cover.bind(null, container_id, book_id)})]))].concat([_desugar_kwargs({style: "padding: 1rem"})])));
        };
        if (!cover_edit.__argnames__) Object.defineProperties(cover_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function format_added(top_container_id, book_id, container_id, files) {
            var container, added, ext, data, r, file;
            container = document.getElementById(container_id);
            if (!container) {
                return;
            }
            if (!files[0]) {
                return;
            }
            added = changes.added_formats || [];
            var _Iter11 = _Iterable(files);
            for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                file = _Iter11[_Index11];
                ext = (_expr_temp = file.name.rpartition("."))[_expr_temp.length-1];
                data = (function(){
                    var _d = Object.create(null);
                    _d["name"] = file.name;
                    _d["size"] = file.size;
                    _d["type"] = file.type;
                    _d["data_url"] = null;
                    _d["ext"] = ext;
                    return _d;
                }).call(this);
                added.push(data);
                r = new FileReader;
                r.onload = (function() {
                    var _anonfunc = function (evt) {
                        data.data_url = evt.target.result;
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["evt"]},
                        __module__ : {value: "book_list.edit_metadata"}
                    });
                    return _anonfunc;
                })();
                r.readAsDataURL(file);
            }
            changes.added_formats = added;
            has_changes = true;
            on_close(top_container_id);
        };
        if (!format_added.__argnames__) Object.defineProperties(format_added, {
            __argnames__ : {value: ["top_container_id", "book_id", "container_id", "files"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function remove_format(top_container_id, book_id, fmt) {
            var removed_formats;
            has_changes = true;
            removed_formats = changes.removed_formats || [];
            removed_formats.push(fmt.toUpperCase());
            changes.removed_formats = removed_formats;
            on_close(top_container_id);
        };
        if (!remove_format.__argnames__) Object.defineProperties(remove_format, {
            __argnames__ : {value: ["top_container_id", "book_id", "fmt"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function formats_edit(container_id, book_id, field, fm, div, mi) {
            var remove_buttons, formats, _unpack, i, fmt;
            _interpolate_kwargs.call(this, upload_files_widget, [div, format_added.bind(null, container_id, book_id), _("Add a format by <a>selecting the book file</a> or drag and drop of the book file here.")].concat([_desugar_kwargs({single_file: true})]));
            remove_buttons = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "padding: 1rem; display: flex; flex-wrap: wrap; align-content: flex-start"})]);
            formats = resolved_formats(mi.formats);
            var _Iter12 = _Iterable(enumerate(formats));
            for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                _unpack = _Iter12[_Index12];
                i = _unpack[0];
                fmt = _unpack[1];
                remove_buttons.appendChild(_interpolate_kwargs.call(this, create_button, [_("Remove {}").format(fmt.upper())].concat([_desugar_kwargs({action: remove_format.bind(null, container_id, book_id, fmt.upper())})])));
                remove_buttons.lastChild.style.marginBottom = "1ex";
                remove_buttons.lastChild.style.marginRight = "1rem";
            }
            div.appendChild(remove_buttons);
        };
        if (!formats_edit.__argnames__) Object.defineProperties(formats_edit, {
            __argnames__ : {value: ["container_id", "book_id", "field", "fm", "div", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function switch_to_edit_panel(container) {
            var d;
            d = container.querySelector("div[data-ctype=\"edit\"]");
            d.style.display = "block";
            d.previousSibling.style.display = "none";
            clear(d);
            return d;
        };
        if (!switch_to_edit_panel.__argnames__) Object.defineProperties(switch_to_edit_panel, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function edit_field(container_id, book_id, field) {
            var fm, c, mi, d, ias;
            fm = (_expr_temp = library_data.field_metadata)[(typeof field === "number" && field < 0) ? _expr_temp.length + field : field];
            c = document.getElementById(container_id);
            mi = book_metadata(book_id);
            if (!c || !fm || !mi) {
                return;
            }
            d = switch_to_edit_panel(c);
            update_completions.ui_to_list = null;
            update_completions.list_to_ui = null;
            update_completions.names = [];
            update_completions.prefix = "";
            if (field === "authors") {
                multiple_line_edit(" & ", "&", container_id, book_id, field, fm, d, mi);
            } else if (field === "cover") {
                cover_edit(container_id, book_id, field, fm, d, mi);
            } else if (field === "formats") {
                formats_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "series") {
                series_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "datetime") {
                date_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "rating") {
                rating_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "enumeration") {
                enum_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "bool") {
                bool_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "int" || fm.datatype === "float") {
                number_edit(container_id, book_id, field, fm, d, mi);
            } else if (field === "identifiers") {
                identifiers_edit(container_id, book_id, field, fm, d, mi);
            } else if (fm.datatype === "comments" || field === "comments") {
                ias = _exists.d(fm.display).interpret_as;
                if (ias === "short-text") {
                    simple_line_edit(container_id, book_id, field, fm, d, mi);
                } else if (ias === "long-text") {
                    text_edit(container_id, book_id, field, fm, d, mi);
                } else if (ias === "markdown") {
                    text_edit(container_id, book_id, field, fm, d, mi, field + "#markdown#");
                } else {
                    html_edit(container_id, book_id, field, fm, d, mi);
                }
            } else {
                if (fm.link_column) {
                    multiple_line_edit(_exists.d(fm.is_multiple).list_to_ui, _exists.d(fm.is_multiple).ui_to_list, container_id, book_id, field, fm, d, mi);
                } else {
                    simple_line_edit(container_id, book_id, field, fm, d, mi);
                }
            }
            if (field === "title") {
                value_to_json = (function() {
                    var _anonfunc = function (x) {
                        return x || _("Untitled");
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["x"]},
                        __module__ : {value: "book_list.edit_metadata"}
                    });
                    return _anonfunc;
                })();
            } else if (field === "authors") {
                value_to_json = (function() {
                    var _anonfunc = function (x) {
                        var ans, a;
                        ans = (function() {
                            var _Iter = _Iterable(x.split("&")), _Result = [], a;
                            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                                a = _Iter[_Index];
                                if (a.strip()) {
                                    _Result.push(a.strip());
                                }
                            }
                            _Result = _list_constructor(_Result);
                            return _Result;
                        })();
                        if (!ans.length) {
                            ans = _list_decorate([ _("Unknown") ]);
                        }
                        return ans;
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["x"]},
                        __module__ : {value: "book_list.edit_metadata"}
                    });
                    return _anonfunc;
                })();
            }
        };
        if (!edit_field.__argnames__) Object.defineProperties(edit_field, {
            __argnames__ : {value: ["container_id", "book_id", "field"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function render_metadata(mi, table, container_id, book_id) {
            var field_metadata, interface_data, current_edit_action, fields, added_fields, f, other_field, fm, field, img, r;
            field_metadata = library_data.field_metadata;
            interface_data = get_interface_data();
            current_edit_action = null;
            function allowed_fields(field) {
                var fm, pfm;
                fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
                if (!fm) {
                    return false;
                }
                if (field.endswith("_index")) {
                    pfm = field_metadata[_bound_index(field.slice(0, -len("_index")), field_metadata)];
                    if (pfm && pfm.datatype === "series") {
                        return false;
                    }
                }
                if (fm.datatype === "composite") {
                    return false;
                }
                if (field.startswith("#")) {
                    return true;
                }
                if (_in(field, IGNORED_FIELDS) || field.endswith("_sort") || field[0] === "@") {
                    return false;
                }
                return true;
            };
            if (!allowed_fields.__argnames__) Object.defineProperties(allowed_fields, {
                __argnames__ : {value: ["field"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            fields = library_data.book_display_fields;
            if (!fields || !fields.length) {
                fields = _interpolate_kwargs.call(this, sorted, [filter(allowed_fields, mi)].concat([_desugar_kwargs({key: field_sorter(field_metadata)})]));
            } else {
                fields = filter(allowed_fields, fields);
            }
            fields = list(fields);
            added_fields = (function() {
                var _Iter = _Iterable(fields), _Result = Object.create(null), f;
                for (var _Index = 0; _Index < _Iter.length; _Index++) {
                    f = _Iter[_Index];
                    _Result[f] = (true);
                }
                return _Result;
            })();
            if (!added_fields.title) {
                added_fields.title = true;
                fields.insert(0, "title");
            }
            var _Iter13 = _Iterable(Object.keys(library_data.field_metadata));
            for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                other_field = _Iter13[_Index13];
                if (!added_fields[(typeof other_field === "number" && other_field < 0) ? added_fields.length + other_field : other_field] && allowed_fields(other_field) && !_in(other_field, IGNORED_FIELDS)) {
                    fields.push(other_field);
                }
            }
            function add_row() {
                var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
                var val = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
                var is_html = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.is_html : arguments[2];
                var join = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? add_row.__defaults__.join : arguments[3];
                var _kwargs_obj = arguments[arguments.length-1];
                if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "is_html")){
                    is_html = _kwargs_obj.is_html;
                }
                if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "join")){
                    join = _kwargs_obj.join;
                }
                var v;
                if (val === undefined || val === null) {
                    val = (join) ? [" "] : "";
                }
                function add_val(v) {
                    if (!v.appendChild) {
                        v += "";
                    }
                    if (v.appendChild) {
                        table.lastChild.lastChild.appendChild(v);
                    } else {
                        table.lastChild.lastChild.appendChild(document.createTextNode(v));
                    }
                };
                if (!add_val.__argnames__) Object.defineProperties(add_val, {
                    __argnames__ : {value: ["v"]},
                    __module__ : {value: "book_list.edit_metadata"}
                });

                table.appendChild(_interpolate_kwargs.call(E, E.tr, [E.td(name), E.td()].concat([_desugar_kwargs({onclick: current_edit_action})])));
                if (is_html) {
                    table.lastChild.lastChild.appendChild(document.createTextNode(truncated_html(val + "")));
                } else {
                    if (!join) {
                        add_val(val);
                    } else {
                        var _Iter14 = _Iterable(val);
                        for (var _Index14 = 0; _Index14 < _Iter14.length; _Index14++) {
                            v = _Iter14[_Index14];
                            add_val(v);
                            if (v !== val[val.length-1]) {
                                table.lastChild.lastChild.appendChild(document.createTextNode(join));
                            }
                        }
                    }
                }
                return table.lastChild.lastChild;
            };
            if (!add_row.__defaults__) Object.defineProperties(add_row, {
                __defaults__ : {value: {is_html:false, join:null}},
                __handles_kwarg_interpolation__ : {value: true},
                __argnames__ : {value: ["name", "val", "is_html", "join"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_composite(field, fm, name, val) {
                var all_vals;
                if (fm.display && fm.display.contains_html) {
                    _interpolate_kwargs.call(this, add_row, [name, val].concat([_desugar_kwargs({is_html: true})]));
                } else if (fm.is_multiple && fm.is_multiple.list_to_ui) {
                    all_vals = filter(null, map(str.strip, val.split(fm.is_multiple.list_to_ui)));
                    _interpolate_kwargs.call(this, add_row, [name, all_vals].concat([_desugar_kwargs({join: fm.is_multiple.list_to_ui})]));
                } else {
                    add_row(name, val);
                }
            };
            if (!process_composite.__argnames__) Object.defineProperties(process_composite, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_authors(field, fm, name, val) {
                _interpolate_kwargs.call(this, add_row, [name, val].concat([_desugar_kwargs({join: " & "})]));
            };
            if (!process_authors.__argnames__) Object.defineProperties(process_authors, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_publisher(field, fm, name, val) {
                add_row(name, val);
            };
            if (!process_publisher.__argnames__) Object.defineProperties(process_publisher, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_rating(field, fm, name, val) {
                var stars, i;
                stars = E.span();
                val = int(val || 0);
                if (val > 0) {
                    for (var _Index15 = 0; _Index15 < Math.floor(val / 2); _Index15++) {
                        i = _Index15;
                        stars.appendChild(svgicon("star"));
                    }
                    if (fm.display.allow_half_stars && val % 2) {
                        stars.appendChild(svgicon("star-half"));
                    }
                    add_row(name, stars);
                } else {
                    add_row(name, null);
                }
            };
            if (!process_rating.__argnames__) Object.defineProperties(process_rating, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_identifiers(field, fm, name, val) {
                var keys, td, k;
                if (val) {
                    keys = Object.keys(val);
                    if (keys.length) {
                        table.appendChild(_interpolate_kwargs.call(E, E.tr, [E.td(name), E.td()].concat([_desugar_kwargs({onclick: current_edit_action})])));
                        td = table.lastChild.lastChild;
                        var _Iter16 = _Iterable(keys);
                        for (var _Index16 = 0; _Index16 < _Iter16.length; _Index16++) {
                            k = _Iter16[_Index16];
                            if (td.childNodes.length) {
                                td.appendChild(document.createTextNode(", "));
                            }
                            td.appendChild(document.createTextNode(k));
                        }
                        return;
                    }
                }
                add_row(name, null);
            };
            if (!process_identifiers.__argnames__) Object.defineProperties(process_identifiers, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_languages(field, fm, name, val) {
                var td, lang, k;
                if (val && val.length) {
                    table.appendChild(_interpolate_kwargs.call(E, E.tr, [E.td(name), E.td()].concat([_desugar_kwargs({onclick: current_edit_action})])));
                    td = table.lastChild.lastChild;
                    var _Iter17 = _Iterable(val);
                    for (var _Index17 = 0; _Index17 < _Iter17.length; _Index17++) {
                        k = _Iter17[_Index17];
                        lang = (_expr_temp = mi.lang_names)[(typeof k === "number" && k < 0) ? _expr_temp.length + k : k] || k;
                        td.appendChild(document.createTextNode(lang));
                        if (k !== val[val.length-1]) {
                            td.appendChild(document.createTextNode(", "));
                        }
                    }
                    return;
                }
                add_row(name, null);
            };
            if (!process_languages.__argnames__) Object.defineProperties(process_languages, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_datetime(field, fm, name, val) {
                var fmt;
                if (val) {
                    fmt = interface_data[_bound_index("gui_" + field + "_display_format", interface_data)] || (fm["display"] || Object.create(null)).date_format;
                    add_row(name, format_date(val, fmt));
                } else {
                    add_row(name, null);
                }
            };
            if (!process_datetime.__argnames__) Object.defineProperties(process_datetime, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_series(field, fm, name, val) {
                var ifield, ival, s;
                if (val) {
                    ifield = field + "_index";
                    try {
                        ival = float(resolved_metadata(mi, ifield));
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        if (_Exception instanceof Error) {
                            ival = 1;
                        } else {
                            throw _Exception;
                        }
                    }
                    ival = _interpolate_kwargs.call(this, fmt_sidx, [ival].concat([_desugar_kwargs({use_roman: interface_data.use_roman_numerals_for_series_number})]));
                    table.appendChild(_interpolate_kwargs.call(E, E.tr, [E.td(name), E.td()].concat([_desugar_kwargs({onclick: current_edit_action})])));
                    s = safe_set_inner_html(E.span(), _("{0} of <i>{1}</i>").format(ival, val));
                    table.lastChild.lastChild.appendChild(s);
                } else {
                    add_row(name, null);
                }
            };
            if (!process_series.__argnames__) Object.defineProperties(process_series, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_formats(field, fm, name, val) {
                var join;
                val = resolved_formats(val);
                if (val.length) {
                    join = (fm.is_multiple) ? fm.is_multiple.list_to_ui : null;
                    _interpolate_kwargs.call(this, add_row, [name, val].concat([_desugar_kwargs({join: join})]));
                } else {
                    add_row(name, null);
                }
            };
            if (!process_formats.__argnames__) Object.defineProperties(process_formats, {
                __argnames__ : {value: ["field", "fm", "name", "val"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            function process_field(field, fm) {
                var name, datatype, val, func, join, fmt;
                name = fm.name || field;
                datatype = fm.datatype;
                val = resolved_metadata(mi, field);
                if (field === "comments" || datatype === "comments") {
                    add_row(name, truncated_html(val || ""));
                    return;
                }
                func = null;
                if (datatype === "composite") {
                    func = process_composite;
                } else if (datatype === "rating") {
                    func = process_rating;
                } else if (field === "identifiers") {
                    func = process_identifiers;
                } else if (field === "authors") {
                    func = process_authors;
                } else if (field === "publisher") {
                    func = process_publisher;
                } else if (field === "languages") {
                    func = process_languages;
                } else if (field === "formats") {
                    func = process_formats;
                } else if (datatype === "datetime") {
                    func = process_datetime;
                } else if (datatype === "series") {
                    func = process_series;
                }
                if (func) {
                    func(field, fm, name, val);
                } else {
                    if (datatype === "text" || datatype === "enumeration") {
                        if (val !== undefined && val !== null) {
                            join = (fm.is_multiple) ? fm.is_multiple.list_to_ui : null;
                            _interpolate_kwargs.call(this, add_row, [name, val].concat([_desugar_kwargs({join: join})]));
                        } else {
                            add_row(name, null);
                        }
                    } else if (datatype === "bool") {
                        add_row(name, (val) ? _("Yes") : ((typeof val !== "undefined" && val !== null)) ? _("No") : "");
                    } else if (datatype === "int" || datatype === "float") {
                        if (val !== undefined && val !== null) {
                            fmt = (fm.display || Object.create(null)).number_format;
                            if (fmt) {
                                val = fmt.format(val);
                            } else {
                                val += "";
                            }
                            add_row(name, val);
                        } else {
                            add_row(name, null);
                        }
                    }
                }
            };
            if (!process_field.__argnames__) Object.defineProperties(process_field, {
                __argnames__ : {value: ["field", "fm"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            var _Iter18 = _Iterable(fields);
            for (var _Index18 = 0; _Index18 < _Iter18.length; _Index18++) {
                field = _Iter18[_Index18];
                fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
                if (!fm) {
                    continue;
                }
                current_edit_action = edit_field.bind(null, container_id, book_id, field);
                try {
                    process_field(field, fm);
                } catch (_Exception) {
                    _last_exception = _Exception;
                    if (_Exception instanceof Error) {
                        print("Failed to render metadata field: " + field);
                        traceback.print_exc();
                    } else {
                        throw _Exception;
                    }
                }
            }
            current_edit_action = edit_field.bind(null, container_id, book_id, "cover");
            table.appendChild(_interpolate_kwargs.call(E, E.tr, [E.td(_("Cover")), E.td()].concat([_desugar_kwargs({onclick: current_edit_action})])));
            img = _interpolate_kwargs.call(E, E.img, [_desugar_kwargs({style: "max-width: 100%; max-height: 400px"})]);
            if (changes.cover) {
                if (changes.cover === "--remove--") {
                    img.removeAttribute("src");
                    changes.cover = null;
                } else {
                    r = new FileReader;
                    r.onload = (function() {
                        var _anonfunc = function (evt) {
                            img.src = evt.target.result;
                            changes.cover = evt.target.result;
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["evt"]},
                            __module__ : {value: "book_list.edit_metadata"}
                        });
                        return _anonfunc;
                    })();
                    r.readAsDataURL(changes.cover);
                    delete changes.cover;
                }
            } else {
                img.src = cover_url(book_id);
            }
            table.lastChild.lastChild.appendChild(img);
        };
        if (!render_metadata.__argnames__) Object.defineProperties(render_metadata, {
            __argnames__ : {value: ["mi", "table", "container_id", "book_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function changes_submitted(container_id, book_id, end_type, xhr, ev) {
            var dirtied, cq, bid;
            changes = Object.create(null);
            has_changes = false;
            if (end_type === "abort") {
                on_close(container_id);
                return;
            }
            if (end_type !== "load") {
                error_dialog(_("Failed to update metadata on server"), _("Updating metadata for the book: {} failed.").format(book_id), xhr.error_html);
                return;
            }
            try {
                dirtied = JSON.parse(xhr.responseText);
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof Error) {
                    var err = _Exception;
                    error_dialog(_("Could not update metadata for book"), _("Server returned an invalid response"), err.toString());
                    return;
                } else {
                    throw _Exception;
                }
            }
            cq = get_current_query();
            if (cq.from_read_book) {
                window.parent.postMessage((function(){
                    var _d = Object.create(null);
                    _d["type"] = "update_cached_book_metadata";
                    _d["library_id"] = cq.library_id;
                    _d["book_id"] = cq.book_id;
                    _d["metadata"] = dirtied[(typeof book_id === "number" && book_id < 0) ? dirtied.length + book_id : book_id];
                    _d["from_read_book"] = cq.from_read_book;
                    return _d;
                }).call(this), document.location.protocol + "//" + document.location.host);
            } else {
                var _Iter19 = _Iterable(dirtied);
                for (var _Index19 = 0; _Index19 < _Iter19.length; _Index19++) {
                    bid = _Iter19[_Index19];
                    set_book_metadata(bid, dirtied[(typeof bid === "number" && bid < 0) ? dirtied.length + bid : bid]);
                }
            }
            on_close(container_id);
        };
        if (!changes_submitted.__argnames__) Object.defineProperties(changes_submitted, {
            __argnames__ : {value: ["container_id", "book_id", "end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function on_progress(container_id, book_id, loaded, total, xhr) {
            var container;
            container = document.getElementById(container_id);
            if (container && total) {
                update_status_widget(container, loaded, total);
            }
        };
        if (!on_progress.__argnames__) Object.defineProperties(on_progress, {
            __argnames__ : {value: ["container_id", "book_id", "loaded", "total", "xhr"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function edit_note(field, item) {
            _interpolate_kwargs.call(this, show_note, [field, 0, item].concat([_desugar_kwargs({panel: "edit_note"})]));
        };
        if (!edit_note.__argnames__) Object.defineProperties(edit_note, {
            __argnames__ : {value: ["field", "item"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function show_select_panel() {
            var q;
            q = parse_url_params();
            q.panel = "select_item_for_edit_notes";
            _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: false})]));
        };
        if (!show_select_panel.__module__) Object.defineProperties(show_select_panel, {
            __module__ : {value: "book_list.edit_metadata"}
        });

        function select_item_for_edit_notes(container, mi) {
            var field_metadata, d, dl, fields, val, fm, dd, a, _unpack, i, x, field;
            set_title(container, _("Edit notes"));
            field_metadata = library_data.field_metadata;
            function allowed_fields(field) {
                var fm;
                fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
                if (!fm) {
                    return false;
                }
                return library_data.fields_that_support_notes.indexOf(field) > -1;
            };
            if (!allowed_fields.__argnames__) Object.defineProperties(allowed_fields, {
                __argnames__ : {value: ["field"]},
                __module__ : {value: "book_list.edit_metadata"}
            });

            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "padding: 0.5rem"})]));
            d = container.lastChild;
            d.appendChild(_interpolate_kwargs.call(E, E.div, [svgicon("pencil"), " ", _("Tap on an item below to edit the notes associated with it.")].concat([_desugar_kwargs({style: "margin-bottom: 0.5rem"})])));
            dl = E.dl();
            fields = _interpolate_kwargs.call(this, sorted, [filter(allowed_fields, mi)].concat([_desugar_kwargs({key: field_sorter(field_metadata)})]));
            var _Iter20 = _Iterable(fields);
            for (var _Index20 = 0; _Index20 < _Iter20.length; _Index20++) {
                field = _Iter20[_Index20];
                val = resolved_metadata(mi, field);
                fm = field_metadata[(typeof field === "number" && field < 0) ? field_metadata.length + field : field];
                if (val) {
                    dl.appendChild(E.dt(fm.name));
                    if (typeof val === "string") {
                        val = [val];
                    }
                    dd = _interpolate_kwargs.call(E, E.dd, [_desugar_kwargs({style: "text-indent: 1em; margin-bottom: 0.5em"})]);
                    dl.appendChild(dd);
                    var _Iter21 = _Iterable(enumerate(val));
                    for (var _Index21 = 0; _Index21 < _Iter21.length; _Index21++) {
                        _unpack = _Iter21[_Index21];
                        i = _unpack[0];
                        x = _unpack[1];
                        a = _interpolate_kwargs.call(E, E.a, [x].concat([_desugar_kwargs({href: "javascript:void(0)", class_: "blue-link", onclick: edit_note.bind(null, field, x)})]));
                        dd.appendChild(a);
                        if (i < val.length - 1) {
                            dd.appendChild(document.createTextNode(fm.is_multiple.list_to_ui));
                        }
                    }
                }
            }
            if (dl.firstChild) {
                d.appendChild(dl);
            } else {
                d.appendChild(E.div(_("This book has no authors/series/etc. that can have notes added to them")));
            }
        };
        if (!select_item_for_edit_notes.__argnames__) Object.defineProperties(select_item_for_edit_notes, {
            __argnames__ : {value: ["container", "mi"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function submit_changes(container_id, book_id) {
            var c, d, data, w;
            c = document.getElementById(container_id);
            d = c.querySelector("div[data-ctype=\"show\"]");
            clear(d);
            d.appendChild(_interpolate_kwargs.call(E, E.div, [_("Uploading changes to server, please wait...")].concat([_desugar_kwargs({style: "margin: 1ex 1rem"})])));
            data = (function(){
                var _d = Object.create(null);
                _d["changes"] = changes;
                _d["loaded_book_ids"] = loaded_book_ids();
                return _d;
            }).call(this);
            w = upload_status_widget();
            d.appendChild(w);
            ajax_send("cdb/set-fields/" + _str.format("{}", book_id) + "/" + _str.format("{}", current_library_id()) + "", data, changes_submitted.bind(null, container_id, book_id), on_progress.bind(null, container_id, book_id));
        };
        if (!submit_changes.__argnames__) Object.defineProperties(submit_changes, {
            __argnames__ : {value: ["container_id", "book_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function show_book(container_id, book_id) {
            var container, mi, div, cq, b;
            container = document.getElementById(container_id);
            mi = book_metadata(book_id);
            if (!container || !mi) {
                return;
            }
            div = container.querySelector("div[data-ctype=\"show\"]");
            if (!div) {
                return;
            }
            clear(div);
            cq = get_current_query();
            if (has_changes) {
                b = _interpolate_kwargs.call(this, create_button, [_("Apply changes")].concat([_desugar_kwargs({action: submit_changes.bind(null, container_id, book_id)})]));
                div.appendChild(_interpolate_kwargs.call(E, E.div, [b].concat([_desugar_kwargs({style: "margin: 1ex 1rem"})])));
            } else {
                div.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(_("Tap any field below to edit that field.")), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [svgicon("pencil"), "", _("Add notes for authors, series, etc.")].concat([_desugar_kwargs({href: "javascript:void(0)", onclick: show_select_panel, class_: "blue-link"})]))].concat([_desugar_kwargs({style: "display:" + ((cq.from_read_book) ? "none" : "block")})]))].concat([_desugar_kwargs({style: "margin: 1ex 1rem"})])));
            }
            div.appendChild(_interpolate_kwargs.call(E, E.table, [_desugar_kwargs({class_: "metadata"})]));
            render_metadata(mi, div.lastChild, container_id, book_id);
            if (has_changes) {
                b = _interpolate_kwargs.call(this, create_button, [_("Apply changes")].concat([_desugar_kwargs({action: submit_changes.bind(null, container_id, book_id)})]));
                div.appendChild(_interpolate_kwargs.call(E, E.div, [b].concat([_desugar_kwargs({style: "margin: 1ex 1rem"})])));
            }
        };
        if (!show_book.__argnames__) Object.defineProperties(show_book, {
            __argnames__ : {value: ["container_id", "book_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function is_edit_panel_showing(container) {
            var d;
            d = container.querySelector("div[data-ctype=\"edit\"]");
            return bool(d && d.style.display === "block");
        };
        if (!is_edit_panel_showing.__argnames__) Object.defineProperties(is_edit_panel_showing, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function close_edit_panel(container) {
            var d;
            d = container.querySelector("div[data-ctype=\"edit\"]");
            d.style.display = "none";
            d.previousSibling.style.display = "block";
            [clear(d), clear(d.previousSibling)];
        };
        if (!close_edit_panel.__argnames__) Object.defineProperties(close_edit_panel, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function on_close(container_id) {
            var cq, c, q;
            cq = get_current_query();
            if (cq.panel === "select_item_for_edit_notes") {
                back();
                return;
            }
            c = document.getElementById(container_id);
            if (c) {
                if (is_edit_panel_showing(c)) {
                    close_edit_panel(c);
                    q = parse_url_params();
                    show_book(container_id, int(q.book_id));
                    c.querySelector("." + _str.format("{}", CLASS_NAME) + "").focus();
                    return;
                }
                if (cq.from_read_book) {
                    window.parent.postMessage((function(){
                        var _d = Object.create(null);
                        _d["type"] = "edit_metadata_closed";
                        _d["from_read_book"] = cq.from_read_book;
                        return _d;
                    }).call(this), document.location.protocol + "//" + document.location.host);
                } else {
                    if (has_changes) {
                        question_dialog(_("Are you sure?"), _("Any changes you have made will be discarded. Do you wish to discard all changes?"), (function() {
                            var _anonfunc = function (yes) {
                                if (yes) {
                                    back();
                                }
                            };
                            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                                __argnames__ : {value: ["yes"]},
                                __module__ : {value: "book_list.edit_metadata"}
                            });
                            return _anonfunc;
                        })());
                    } else {
                        back();
                    }
                }
            }
        };
        if (!on_close.__argnames__) Object.defineProperties(on_close, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function proceed_after_succesful_fetch_metadata(container_id, book_id) {
            var container, mi, cq;
            changes = Object.create(null);
            has_changes = false;
            container = document.getElementById(container_id);
            mi = book_metadata(book_id);
            if (!mi || !container) {
                if (get_current_query().from_read_book) {
                    container.textContent = _("Failed to read metadata for book");
                    return;
                }
                _interpolate_kwargs.call(this, show_panel, ["book_details"].concat([_desugar_kwargs({query: parse_url_params(), replace: true})]));
                return;
            }
            cq = get_current_query();
            clear(container.lastChild);
            if (cq.panel === "select_item_for_edit_notes") {
                select_item_for_edit_notes(container, mi);
                return;
            }
            set_title(container, _("Edit metadata for {}").format(mi.title));
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_ctype: "show", style: "display:block"})]));
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_ctype: "edit", style: "display:none"})]));
            show_book(container_id, book_id);
        };
        if (!proceed_after_succesful_fetch_metadata.__argnames__) Object.defineProperties(proceed_after_succesful_fetch_metadata, {
            __argnames__ : {value: ["container_id", "book_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function create_edit_metadata(container) {
            var q, current_book_id, container_id;
            q = parse_url_params();
            current_book_id = q.book_id;
            if (!current_book_id) {
                no_book(container);
                return;
            }
            current_book_id = int(current_book_id);
            container_id = container.parentNode.id;
            if (!book_metadata(current_book_id)) {
                fetch_metadata(container_id, current_book_id, proceed_after_succesful_fetch_metadata);
            } else {
                proceed_after_succesful_fetch_metadata(container_id, current_book_id);
            }
        };
        if (!create_edit_metadata.__argnames__) Object.defineProperties(create_edit_metadata, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function check_for_books_loaded() {
            var container;
            container = this;
            if (load_status.loading) {
                conditional_timeout(container.id, 5, check_for_books_loaded);
                return;
            }
            container = container.lastChild;
            clear(container);
            if (!load_status.ok) {
                report_load_failure(container);
                return;
            }
            create_edit_metadata(container);
        };
        if (!check_for_books_loaded.__module__) Object.defineProperties(check_for_books_loaded, {
            __module__ : {value: "book_list.edit_metadata"}
        });

        function handle_keypress(container_id, ev) {
            if (!ev.altKey && !ev.ctrlKey && !ev.metaKey && !ev.shiftKey) {
                if (ev.key === "Escape") {
                    [ev.preventDefault(), ev.stopPropagation()];
                    on_close(container_id);
                }
            }
        };
        if (!handle_keypress.__argnames__) Object.defineProperties(handle_keypress, {
            __argnames__ : {value: ["container_id", "ev"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function init(container_id) {
            var container;
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Edit metadata"), action: on_close.bind(null, container_id), icon: "close"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME, tabindex: "0", onkeydown: handle_keypress.bind(null, container_id)})]));
            container.lastChild.focus();
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading books from the calibre library, please wait...")].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
            conditional_timeout(container_id, 5, check_for_books_loaded);
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        function init_select_item_for_edit_notes(container_id) {
            var q, container;
            q = parse_url_params();
            book_whose_metadata_is_being_edited(int(q.book_id));
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Edit metadata"), action: on_close.bind(null, container_id), icon: "close"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME, tabindex: "0", onkeydown: handle_keypress.bind(null, container_id)})]));
            container.lastChild.focus();
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading books from the calibre library, please wait...")].concat([_desugar_kwargs({style: "margin: 1ex 1em"})])));
            conditional_timeout(container_id, 5, check_for_books_loaded);
        };
        if (!init_select_item_for_edit_notes.__argnames__) Object.defineProperties(init_select_item_for_edit_notes, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.edit_metadata"}
        });

        set_panel_handler("edit_metadata", init);
        set_panel_handler("select_item_for_edit_notes", init_select_item_for_edit_notes);
        _modules["book_list.edit_metadata"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.edit_metadata"].IGNORED_FIELDS = IGNORED_FIELDS;
        _modules["book_list.edit_metadata"].value_to_json = value_to_json;
        _modules["book_list.edit_metadata"].changes = changes;
        _modules["book_list.edit_metadata"].has_changes = has_changes;
        _modules["book_list.edit_metadata"].identity = identity;
        _modules["book_list.edit_metadata"].resolved_metadata = resolved_metadata;
        _modules["book_list.edit_metadata"].resolved_formats = resolved_formats;
        _modules["book_list.edit_metadata"].truncated_html = truncated_html;
        _modules["book_list.edit_metadata"].onsubmit_field2 = onsubmit_field2;
        _modules["book_list.edit_metadata"].onsubmit_field = onsubmit_field;
        _modules["book_list.edit_metadata"].create_form = create_form;
        _modules["book_list.edit_metadata"].line_edit_get_value = line_edit_get_value;
        _modules["book_list.edit_metadata"].simple_line_edit = simple_line_edit;
        _modules["book_list.edit_metadata"].text_edit_get_value = text_edit_get_value;
        _modules["book_list.edit_metadata"].text_edit = text_edit;
        _modules["book_list.edit_metadata"].html_edit_get_value = html_edit_get_value;
        _modules["book_list.edit_metadata"].html_edit = html_edit;
        _modules["book_list.edit_metadata"].number_edit_get_value = number_edit_get_value;
        _modules["book_list.edit_metadata"].number_edit = number_edit;
        _modules["book_list.edit_metadata"].remove_item = remove_item;
        _modules["book_list.edit_metadata"].add_completion = add_completion;
        _modules["book_list.edit_metadata"].show_completions = show_completions;
        _modules["book_list.edit_metadata"].query_contains = query_contains;
        _modules["book_list.edit_metadata"].query_startswitch = query_startswitch;
        _modules["book_list.edit_metadata"].update_removals = update_removals;
        _modules["book_list.edit_metadata"].update_completions = update_completions;
        _modules["book_list.edit_metadata"].line_edit_updated = line_edit_updated;
        _modules["book_list.edit_metadata"].multiple_line_edit = multiple_line_edit;
        _modules["book_list.edit_metadata"].series_edit_get_value = series_edit_get_value;
        _modules["book_list.edit_metadata"].series_edit = series_edit;
        _modules["book_list.edit_metadata"].date_edit_get_value = date_edit_get_value;
        _modules["book_list.edit_metadata"].date_to_datetime = date_to_datetime;
        _modules["book_list.edit_metadata"].date_edit = date_edit;
        _modules["book_list.edit_metadata"].remove_identifier = remove_identifier;
        _modules["book_list.edit_metadata"].add_identifier = add_identifier;
        _modules["book_list.edit_metadata"].identifiers_get_value = identifiers_get_value;
        _modules["book_list.edit_metadata"].identifiers_edit = identifiers_edit;
        _modules["book_list.edit_metadata"].rating_get_value = rating_get_value;
        _modules["book_list.edit_metadata"].set_rating = set_rating;
        _modules["book_list.edit_metadata"].rating_edit = rating_edit;
        _modules["book_list.edit_metadata"].enum_get_value = enum_get_value;
        _modules["book_list.edit_metadata"].enum_edit = enum_edit;
        _modules["book_list.edit_metadata"].bool_edit = bool_edit;
        _modules["book_list.edit_metadata"].cover_chosen = cover_chosen;
        _modules["book_list.edit_metadata"].remove_cover = remove_cover;
        _modules["book_list.edit_metadata"].cover_edit = cover_edit;
        _modules["book_list.edit_metadata"].format_added = format_added;
        _modules["book_list.edit_metadata"].remove_format = remove_format;
        _modules["book_list.edit_metadata"].formats_edit = formats_edit;
        _modules["book_list.edit_metadata"].switch_to_edit_panel = switch_to_edit_panel;
        _modules["book_list.edit_metadata"].edit_field = edit_field;
        _modules["book_list.edit_metadata"].render_metadata = render_metadata;
        _modules["book_list.edit_metadata"].changes_submitted = changes_submitted;
        _modules["book_list.edit_metadata"].on_progress = on_progress;
        _modules["book_list.edit_metadata"].edit_note = edit_note;
        _modules["book_list.edit_metadata"].show_select_panel = show_select_panel;
        _modules["book_list.edit_metadata"].select_item_for_edit_notes = select_item_for_edit_notes;
        _modules["book_list.edit_metadata"].submit_changes = submit_changes;
        _modules["book_list.edit_metadata"].show_book = show_book;
        _modules["book_list.edit_metadata"].is_edit_panel_showing = is_edit_panel_showing;
        _modules["book_list.edit_metadata"].close_edit_panel = close_edit_panel;
        _modules["book_list.edit_metadata"].on_close = on_close;
        _modules["book_list.edit_metadata"].proceed_after_succesful_fetch_metadata = proceed_after_succesful_fetch_metadata;
        _modules["book_list.edit_metadata"].create_edit_metadata = create_edit_metadata;
        _modules["book_list.edit_metadata"].check_for_books_loaded = check_for_books_loaded;
        _modules["book_list.edit_metadata"].handle_keypress = handle_keypress;
        _modules["book_list.edit_metadata"].init = init;
        _modules["book_list.edit_metadata"].init_select_item_for_edit_notes = init_select_item_for_edit_notes;
    })();

    (function(){
        var __name__ = "book_list.conversion_widgets";
        var CLASS_NAME, indent, container_id, get_option_value, get_option_default_value, is_option_disabled, get_option_help, profiles, ui_data, entry_points, registry, listeners;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;
        var ensure_id = _modules.dom.ensure_id;

        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var create_button = _modules.widgets.create_button;

        CLASS_NAME = "conversion-option-group";
        indent = "";
        add_extra_css((function() {
            var _anonfunc = function () {
                var style, sel;
                style = "";
                sel = "." + CLASS_NAME + " ";
                style += _interpolate_kwargs.call(this, build_rule, [sel + "input[type=\"checkbox\"]"].concat([_desugar_kwargs({margin_left: "0"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "[data-option-name]"].concat([_desugar_kwargs({margin_bottom: "1ex", display: "block", padding_bottom: "0.5ex"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".simple-group > label"].concat([_desugar_kwargs({display: "table-row"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".simple-group > label > *"].concat([_desugar_kwargs({display: "table-cell", padding_bottom: "1ex", padding_right: "1rem"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "label.vertical"].concat([_desugar_kwargs({display: "block"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "label.vertical > *"].concat([_desugar_kwargs({display: "block", padding_bottom: "1ex", padding_right: "1rem"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "[data-profile]"].concat([_desugar_kwargs({margin_left: "2em", text_indent: "-2em", font_size: "smaller", margin_bottom: "1ex"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".subset-choice label"].concat([_desugar_kwargs({display: "block", margin_bottom: "1ex"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());
        container_id = null;
        get_option_value = get_option_default_value = is_option_disabled = get_option_help = profiles = ui_data = null;
        entry_points = Object.create(null);
        registry = Object.create(null);
        listeners = Object.create(null);
        function ep(func) {
            entry_points[_bound_index(func.name, entry_points)] = func;
            return func;
        };
        if (!ep.__argnames__) Object.defineProperties(ep, {
            __argnames__ : {value: ["func"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function add_listener(name, callback) {
            if (!listeners[(typeof name === "number" && name < 0) ? listeners.length + name : name]) {
                listeners[(typeof name === "number" && name < 0) ? listeners.length + name : name] = [];
            }
            listeners[(typeof name === "number" && name < 0) ? listeners.length + name : name].push(callback);
        };
        if (!add_listener.__argnames__) Object.defineProperties(add_listener, {
            __argnames__ : {value: ["name", "callback"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function on_change(name) {
            var callback;
            if (listeners[(typeof name === "number" && name < 0) ? listeners.length + name : name]) {
                var _Iter0 = _Iterable(listeners[(typeof name === "number" && name < 0) ? listeners.length + name : name]);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    callback = _Iter0[_Index0];
                    callback(name);
                }
            }
        };
        if (!on_change.__argnames__) Object.defineProperties(on_change, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function sanitize_accelerator(text) {
            return text.replace("&", "");
        };
        if (!sanitize_accelerator.__argnames__) Object.defineProperties(sanitize_accelerator, {
            __argnames__ : {value: ["text"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function subset_choice() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var choices = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var tooltip = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? subset_choice.__defaults__.tooltip : arguments[2];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            var ans, names, cname, ops;
            if (get_option_default_value(name) === undefined) {
                throw new KeyError("" + _str.format("{}", name) + " is not a known option");
            }
            ans = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_option_name: name, class_: "subset-choice"})]);
            if (tooltip !== null) {
                ans.setAttribute("title", tooltip || get_option_help(name));
            }
            names = Object.keys(choices);
            var _Iter1 = _Iterable(names);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                cname = _Iter1[_Index1];
                ans.appendChild(E.label(_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", name: cname})]), "" + choices[(typeof cname === "number" && cname < 0) ? choices.length + cname : cname]));
            }
            ops = (function(){
                var _d = Object.create(null);
                _d["get"] = (function() {
                    var _anonfunc = function (container) {
                        var ans, w;
                        ans = [];
                        var _Iter2 = _Iterable(container.querySelectorAll("input"));
                        for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                            w = _Iter2[_Index2];
                            if (w.checked) {
                                ans.push(w.name);
                            }
                        }
                        return ",".join(ans);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["container"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })();
                _d["set"] = (function() {
                    var _anonfunc = function (container, val) {
                        var q, x, w;
                        q = (function() {
                            var _Iter = _Iterable((val || "").split(",")), _Result = Object.create(null), x;
                            for (var _Index = 0; _Index < _Iter.length; _Index++) {
                                x = _Iter[_Index];
                                _Result[x.strip()] = (true);
                            }
                            return _Result;
                        })();
                        var _Iter3 = _Iterable(container.querySelectorAll("input"));
                        for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                            w = _Iter3[_Index3];
                            w.checked = bool(q[_bound_index(w.name, q)]);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["container", "val"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })();
                _d["set_disabled"] = (function() {
                    var _anonfunc = function (container, val) {
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["container", "val"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
            registry[(typeof name === "number" && name < 0) ? registry.length + name : name] = ops;
            ops.set(ans, get_option_value(name));
            return ans;
        };
        if (!subset_choice.__defaults__) Object.defineProperties(subset_choice, {
            __defaults__ : {value: {tooltip:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "choices", "tooltip"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function create_simple_widget(name, text, tooltip, input_widget_, getter, setter, suffix) {
            var label, input_widget, ops;
            if (get_option_default_value(name) === undefined) {
                throw new KeyError("" + _str.format("{}", name) + " is not a known option");
            }
            if (!text.endswith(":")) {
                text = text + ":";
            }
            label = E.label(E.span(sanitize_accelerator(text)), E.span(input_widget_));
            if (suffix) {
                label.lastChild.appendChild(document.createTextNode("" + suffix));
            }
            label.dataset.optionName = name;
            label.setAttribute("title", tooltip || get_option_help(name));
            function straight_input_widget(container) {
                return container.lastChild.firstChild;
            };
            if (!straight_input_widget.__argnames__) Object.defineProperties(straight_input_widget, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });

            input_widget = straight_input_widget;
            ops = (function(){
                var _d = Object.create(null);
                _d["get"] = (function() {
                    var _anonfunc = function (container) {
                        return getter(input_widget(container));
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["container"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })();
                _d["set"] = (function() {
                    var _anonfunc = function (container, val) {
                        setter(input_widget(container), val);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["container", "val"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })();
                _d["set_disabled"] = (function() {
                    var _anonfunc = function (container, val) {
                        if (val) {
                            container.classList.add("disabled");
                            input_widget(container).setAttribute("disabled", "disabled");
                        } else {
                            container.classList.remove("disabled");
                            input_widget(container).removeAttribute("disabled");
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["container", "val"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })();
                return _d;
            }).call(this);
            registry[(typeof name === "number" && name < 0) ? registry.length + name : name] = ops;
            ops.set(label, get_option_value(name));
            if (is_option_disabled(name)) {
                ops.set_disabled(label, true);
            }
            input_widget(label).addEventListener("change", on_change.bind(null, name));
            if (listeners[(typeof name === "number" && name < 0) ? listeners.length + name : name]) {
                window.setTimeout(on_change.bind(null, name), 0);
            }
            return label;
        };
        if (!create_simple_widget.__argnames__) Object.defineProperties(create_simple_widget, {
            __argnames__ : {value: ["name", "text", "tooltip", "input_widget_", "getter", "setter", "suffix"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function checkbox(name, text, tooltip) {
            return create_simple_widget(name, text, tooltip, _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox"})]), (function() {
                var _anonfunc = function getter(w) {
                    return bool(w.checked);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })(), (function() {
                var _anonfunc = function setter(w, val) {
                    w.checked = bool(val);
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w", "val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })());
        };
        if (!checkbox.__argnames__) Object.defineProperties(checkbox, {
            __argnames__ : {value: ["name", "text", "tooltip"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function lineedit() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var text = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var width = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? lineedit.__defaults__.width : arguments[2];
            var tooltip = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? lineedit.__defaults__.tooltip : arguments[3];
            var suffix = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? lineedit.__defaults__.suffix : arguments[4];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "width")){
                width = _kwargs_obj.width;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "suffix")){
                suffix = _kwargs_obj.suffix;
            }
            return _interpolate_kwargs.call(this, create_simple_widget, [name, text, tooltip, _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", size: str(width)})]), (function() {
                var _anonfunc = function getter(w) {
                    var ans;
                    ans = w.value;
                    if (ans && ans.strip()) {
                        return ans.strip();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })(), (function() {
                var _anonfunc = function setter(w, val) {
                    w.value = val || "";
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w", "val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({suffix: suffix})]));
        };
        if (!lineedit.__defaults__) Object.defineProperties(lineedit, {
            __defaults__ : {value: {width:25, tooltip:null, suffix:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "text", "width", "tooltip", "suffix"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function float_spin() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var text = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var tooltip = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? float_spin.__defaults__.tooltip : arguments[2];
            var step = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? float_spin.__defaults__.step : arguments[3];
            var min = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? float_spin.__defaults__.min : arguments[4];
            var max = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? float_spin.__defaults__.max : arguments[5];
            var unit = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? float_spin.__defaults__.unit : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "step")){
                step = _kwargs_obj.step;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "min")){
                min = _kwargs_obj.min;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "max")){
                max = _kwargs_obj.max;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "unit")){
                unit = _kwargs_obj.unit;
            }
            var f, defval;
            f = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", step: str(step), min: str(min), max: str(max), required: true})]);
            defval = get_option_default_value(name);
            return _interpolate_kwargs.call(this, create_simple_widget, [name, text, tooltip, f, (function() {
                var _anonfunc = function getter(w) {
                    try {
                        return float(w.value);
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            return defval;
                        } 
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })(), (function() {
                var _anonfunc = function setter(w, val) {
                    w.value = str(float(val));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w", "val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({suffix: unit})]));
        };
        if (!float_spin.__defaults__) Object.defineProperties(float_spin, {
            __defaults__ : {value: {tooltip:null, step:.1, min:0, max:100, unit:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "text", "tooltip", "step", "min", "max", "unit"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function int_spin() {
            var name = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
            var text = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
            var tooltip = (arguments[2] === undefined || ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? int_spin.__defaults__.tooltip : arguments[2];
            var step = (arguments[3] === undefined || ( 3 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? int_spin.__defaults__.step : arguments[3];
            var min = (arguments[4] === undefined || ( 4 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? int_spin.__defaults__.min : arguments[4];
            var max = (arguments[5] === undefined || ( 5 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? int_spin.__defaults__.max : arguments[5];
            var unit = (arguments[6] === undefined || ( 6 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true)) ? int_spin.__defaults__.unit : arguments[6];
            var _kwargs_obj = arguments[arguments.length-1];
            if (_kwargs_obj === null || typeof _kwargs_obj !== "object" || _kwargs_obj [_kwargs_symbol] !== true) _kwargs_obj = {};
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "tooltip")){
                tooltip = _kwargs_obj.tooltip;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "step")){
                step = _kwargs_obj.step;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "min")){
                min = _kwargs_obj.min;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "max")){
                max = _kwargs_obj.max;
            }
            if (Object.prototype.hasOwnProperty.call(_kwargs_obj, "unit")){
                unit = _kwargs_obj.unit;
            }
            var f, defval;
            f = _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "number", step: str(step), min: str(min), max: str(max), required: true})]);
            defval = get_option_default_value(name);
            return _interpolate_kwargs.call(this, create_simple_widget, [name, text, tooltip, f, (function() {
                var _anonfunc = function getter(w) {
                    try {
                        return int(w.value);
                    } catch (_Exception) {
                        _last_exception = _Exception;
                        {
                            return defval;
                        } 
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })(), (function() {
                var _anonfunc = function setter(w, val) {
                    w.value = str(int(val));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w", "val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })()].concat([_desugar_kwargs({suffix: unit})]));
        };
        if (!int_spin.__defaults__) Object.defineProperties(int_spin, {
            __defaults__ : {value: {tooltip:null, step:1, min:0, max:100, unit:null}},
            __handles_kwarg_interpolation__ : {value: true},
            __argnames__ : {value: ["name", "text", "tooltip", "step", "min", "max", "unit"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function choices(name, text, choices, tooltip) {
            var f, key;
            f = E.select();
            if (Array.isArray(choices)) {
                var _Iter4 = _Iterable(choices);
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    key = _Iter4[_Index4];
                    f.appendChild(_interpolate_kwargs.call(E, E.option, [key].concat([_desugar_kwargs({value: key})])));
                }
            } else {
                var _Iter5 = _Iterable(choices);
                for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                    key = _Iter5[_Index5];
                    f.appendChild(_interpolate_kwargs.call(E, E.option, [choices[(typeof key === "number" && key < 0) ? choices.length + key : key]].concat([_desugar_kwargs({value: key})])));
                }
            }
            return create_simple_widget(name, text, tooltip, f, (function() {
                var _anonfunc = function getter(w) {
                    return w.value;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })(), (function() {
                var _anonfunc = function setter(w, val) {
                    w.value = val;
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w", "val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })());
        };
        if (!choices.__argnames__) Object.defineProperties(choices, {
            __argnames__ : {value: ["name", "text", "choices", "tooltip"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function textarea(name, text, tooltip) {
            var ans;
            ans = create_simple_widget(name, text, tooltip, _interpolate_kwargs.call(E, E.textarea, [_desugar_kwargs({rows: "30", cols: "70"})]), (function() {
                var _anonfunc = function getter(w) {
                    var ans;
                    ans = w.value;
                    if (ans && ans.strip()) {
                        return ans.strip();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })(), (function() {
                var _anonfunc = function setter(w, val) {
                    w.value = val || "";
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["w", "val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });
                return _anonfunc;
            })());
            ans.classList.add("vertical");
            return ans;
        };
        if (!textarea.__argnames__) Object.defineProperties(textarea, {
            __argnames__ : {value: ["name", "text", "tooltip"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function container_for_option(name) {
            return document.getElementById(container_id).querySelector("[data-option-name=\"" + _str.format("{}", name) + "\"]");
        };
        if (!container_for_option.__argnames__) Object.defineProperties(container_for_option, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function get(name) {
            return registry[(typeof name === "number" && name < 0) ? registry.length + name : name].get(container_for_option(name));
        };
        if (!get.__argnames__) Object.defineProperties(get, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function set(name, val) {
            registry[(typeof name === "number" && name < 0) ? registry.length + name : name].set(container_for_option(name), val);
        };
        if (!set.__argnames__) Object.defineProperties(set, {
            __argnames__ : {value: ["name", "val"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function set_disabled(name, val) {
            registry[(typeof name === "number" && name < 0) ? registry.length + name : name].set_disabled(container_for_option(name), val);
        };
        if (!set_disabled.__argnames__) Object.defineProperties(set_disabled, {
            __argnames__ : {value: ["name", "val"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        
        var look_and_feel = ep((function() {
            var _anonfunc = function look_and_feel(container) {
                var g;
                function subhead(text) {
                    container.appendChild(_interpolate_kwargs.call(E, E.div, [E.b(sanitize_accelerator(text))].concat([_desugar_kwargs({style: "border-bottom: solid 1px currentColor; margin-bottom: 1ex; max-width: 35em"})])));
                };
                if (!subhead.__argnames__) Object.defineProperties(subhead, {
                    __argnames__ : {value: ["text"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });

                subhead(_("&Fonts"));
                add_listener("disable_font_rescaling", (function() {
                    var _anonfunc = function (name) {
                        var disabled, dname;
                        disabled = get("disable_font_rescaling");
                        var _Iter6 = _Iterable(_list_decorate([ "font_size_mapping", "base_font_size" ]));
                        for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                            dname = _Iter6[_Index6];
                            set_disabled(dname, disabled);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })());
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("disable_font_rescaling", _("&Disable font size rescaling")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["base_font_size", _("Base font si&ze:")].concat([_desugar_kwargs({max: 50, unit: "pt"})])));
                g.appendChild(lineedit("font_size_mapping", _("Font size &key:")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["minimum_line_height", _("Minim&um line height:")].concat([_desugar_kwargs({max: 900, unit: "%"})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["line_height", _("Line hei&ght:")].concat([_desugar_kwargs({unit: "%"})])));
                g.appendChild(lineedit("embed_font_family", _("Embed font fami&ly:")));
                g.appendChild(checkbox("embed_all_fonts", _("&Embed all fonts in document")));
                g.appendChild(checkbox("subset_embedded_fonts", _("&Subset all embedded fonts")));
                g.appendChild(checkbox("keep_ligatures", _("Keep &ligatures")));
                subhead(_("Te&xt"));
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(lineedit("input_encoding", _("I&nput character encoding:")));
                g.appendChild(choices("change_justification", _("Text &justification:"), (function(){
                    var _d = Object.create(null);
                    _d["original"] = _("Original");
                    _d["left"] = _("Left align");
                    _d["justify"] = _("Justify text");
                    return _d;
                }).call(this)));
                g.appendChild(checkbox("smarten_punctuation", _("Smarten &punctuation")));
                g.appendChild(checkbox("unsmarten_punctuation", _("&Unsmarten punctuation")));
                g.appendChild(checkbox("asciiize", _("&Transliterate Unicode characters to ASCII")));
                subhead(_("Lay&out"));
                add_listener("remove_paragraph_spacing", (function() {
                    var _anonfunc = function (name) {
                        var disabled;
                        disabled = get("remove_paragraph_spacing");
                        set_disabled("remove_paragraph_spacing_indent_size", !disabled);
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })());
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("remove_paragraph_spacing", _("Remove &spacing between paragraphs")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["remove_paragraph_spacing_indent_size", indent + _("I&ndent size:")].concat([_desugar_kwargs({min: -.1, unit: "em"})])));
                g.appendChild(checkbox("insert_blank_line", _("Insert &blank line between paragraphs")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["insert_blank_line_size", indent + _("&Line size:")].concat([_desugar_kwargs({unit: "em"})])));
                g.appendChild(checkbox("linearize_tables", _("&Linearize tables")));
                subhead(_("St&yling"));
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(lineedit("filter_css", _("Filter style information"), 40));
                container.appendChild(textarea("extra_css", "E&xtra CSS"));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var heuristics = ep((function() {
            var _anonfunc = function heuristics(container) {
                var settings, blurb, g;
                settings = [];
                function add() {
                    var func = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
                    var name = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
                    var text = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
                    var kw = arguments[arguments.length-1];
                    if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
                    g.appendChild(_interpolate_kwargs.call(this, func, [name, text].concat([_desugar_kwargs(kw)])));
                    settings.push(name);
                };
                if (!add.__handles_kwarg_interpolation__) Object.defineProperties(add, {
                    __handles_kwarg_interpolation__ : {value: true},
                    __argnames__ : {value: ["func", "name", "text"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });

                add_listener("enable_heuristics", (function() {
                    var _anonfunc = function (name) {
                        var disabled, dname;
                        disabled = !get("enable_heuristics");
                        var _Iter7 = _Iterable(settings);
                        for (var _Index7 = 0; _Index7 < _Iter7.length; _Index7++) {
                            dname = _Iter7[_Index7];
                            set_disabled(dname, disabled);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })());
                blurb = _("<b>Heuristic processing</b> means that calibre will scan your book for common patterns and fix them. As the name implies, this involves guesswork, which means that it could end up worsening the result of a conversion, if calibre guesses wrong. Therefore, it is disabled by default. Often, if a conversion does not turn out as you expect, turning on heuristics can improve matters. Read more about the various heuristic processing options in the <a href=\"%s\">User Manual</a>.").replace("%s", "https://manual.calibre-ebook.com/conversion.html#heuristic-processing");
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-bottom: 1ex"})]));
                safe_set_inner_html(container.lastChild, blurb);
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("enable_heuristics", _("Enable &heuristic processing")));
                add(checkbox, "unwrap_lines", _("Unwrap lines"));
                _interpolate_kwargs.call(this, add, [float_spin, "html_unwrap_factor", indent + _("Line &un-wrap factor:")].concat([_desugar_kwargs({max: 1, step: .05})]));
                add(checkbox, "markup_chapter_headings", _("Detect and markup unformatted chapter headings and sub headings"));
                add(checkbox, "renumber_headings", _("Renumber sequences of <h1> or <h2> tags to prevent splitting"));
                add(checkbox, "delete_blank_paragraphs", _("Delete blank lines between paragraphs"));
                add(checkbox, "format_scene_breaks", _("Ensure scene breaks are consistently formatted"));
                add(lineedit, "replace_scene_breaks", _("Rep&lace soft scene breaks:"));
                add(checkbox, "dehyphenate", _("Remove unnecessary hyphens"));
                add(checkbox, "italicize_common_cases", _("Italicize common words and patterns"));
                add(checkbox, "fix_indents", _("Replace entity indents with CSS indents"));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var page_setup = ep((function() {
            var _anonfunc = function page_setup(container) {
                var g;
                function show_profile_desc(name) {
                    var profile, data;
                    profile = get(name);
                    data = (name === "input_profile") ? profiles.input : profiles.output;
                    profile = data[(typeof profile === "number" && profile < 0) ? data.length + profile : profile];
                    container_for_option(name).parentNode.querySelector("[data-profile=\"{}\"".format((name === "input_profile") ? "input" : "output")).textContent = indent + profile.description;
                };
                if (!show_profile_desc.__argnames__) Object.defineProperties(show_profile_desc, {
                    __argnames__ : {value: ["name"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });

                add_listener("input_profile", show_profile_desc);
                add_listener("output_profile", show_profile_desc);
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["margin_left", _("Left page margin")].concat([_desugar_kwargs({unit: "pt", step: .1, min: -1, max: 200})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["margin_top", _("Top page margin")].concat([_desugar_kwargs({unit: "pt", step: .1, min: -1, max: 200})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["margin_right", _("Right page margin")].concat([_desugar_kwargs({unit: "pt", step: .1, min: -1, max: 200})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["margin_bottom", _("Bottom page margin")].concat([_desugar_kwargs({unit: "pt", step: .1, min: -1, max: 200})])));
                g.appendChild(choices("input_profile", _("&Input profile:"), (function() {
                    var _Iter = _Iterable(profiles.input), _Result = Object.create(null), name;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        name = _Iter[_Index];
                        _Result[name] = ((_expr_temp = profiles.input)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name].name);
                    }
                    return _Result;
                })()));
                g.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_profile: "input"})]));
                g.appendChild(choices("output_profile", _("&Output profile:"), (function() {
                    var _Iter = _Iterable(profiles.output), _Result = Object.create(null), name;
                    for (var _Index = 0; _Index < _Iter.length; _Index++) {
                        name = _Iter[_Index];
                        _Result[name] = ((_expr_temp = profiles.output)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name].name);
                    }
                    return _Result;
                })()));
                g.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_profile: "output"})]));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var structure_detection = ep((function() {
            var _anonfunc = function structure_detection(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(lineedit("chapter", _("Detect chapters at"), 50));
                g.appendChild(choices("chapter_mark", _("Chap&ter mark:"), _list_decorate([ "pagebreak", "rule", "both", "none" ])));
                g.appendChild(checkbox("remove_first_image", _("Remove first &image")));
                g.appendChild(checkbox("remove_fake_margins", _("Remove &fake margins")));
                g.appendChild(checkbox("add_alt_text_to_img", _("Add &alt text to images")));
                g.appendChild(checkbox("insert_metadata", _("Insert metadata at start of book")));
                g.appendChild(lineedit("page_breaks_before", _("Insert page breaks before"), 50));
                g.appendChild(lineedit("start_reading_at", _("Start reading at"), 50));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var toc = ep((function() {
            var _anonfunc = function toc(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("use_auto_toc", _("&Force use of auto-generated Table of Contents")));
                g.appendChild(checkbox("no_chapters_in_toc", _("Do not add &detected chapters to the Table of Contents")));
                g.appendChild(checkbox("duplicate_links_in_toc", _("Allow &duplicate links when creating the Table of Contents")));
                g.appendChild(int_spin("max_toc_links", _("Number of &links to add to Table of Contents:")));
                g.appendChild(int_spin("toc_threshold", _("Chapter &threshold:")));
                g.appendChild(lineedit("toc_filter", _("TOC &filter:")));
                g.appendChild(lineedit("level1_toc", _("Level &1 TOC (XPath expression):")));
                g.appendChild(lineedit("level2_toc", _("Level &2 TOC (XPath expression):")));
                g.appendChild(lineedit("level3_toc", _("Level &3 TOC (XPath expression):")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var search_and_replace = ep((function() {
            var _anonfunc = function search_and_replace(container) {
                var ops;
                function add(val) {
                    var c;
                    c = container_for_option("search_replace");
                    c.appendChild(_interpolate_kwargs.call(E, E.div, [E.label(E.span(_("Search:")), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: "search"})])), E.label(E.span(_("Replace:")), _interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "text", name: "replace"})]))].concat([_desugar_kwargs({class_: "simple-group sr-instance", style: "border-bottom: solid 1px currentColor; margin-bottom: 1ex"})])));
                    if (val && val[0]) {
                        c.lastChild.querySelector("input[name=\"search\"]").value = val[0];
                        c.lastChild.querySelector("input[name=\"replace\"]").value = val[1];
                    }
                    return c.lastChild;
                };
                if (!add.__argnames__) Object.defineProperties(add, {
                    __argnames__ : {value: ["val"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });

                container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_option_name: "search_replace"})]));
                ops = (function(){
                    var _d = Object.create(null);
                    _d["get"] = (function() {
                        var _anonfunc = function get(container) {
                            var ans, _unpack, search, replace, r, div;
                            ans = [];
                            var _Iter8 = _Iterable(container.querySelectorAll(".sr-instance"));
                            for (var _Index8 = 0; _Index8 < _Iter8.length; _Index8++) {
                                div = _Iter8[_Index8];
                                _unpack = div.querySelectorAll("input");
_unpack = _unpack_asarray(2, _unpack);
                                search = _unpack[0];
                                replace = _unpack[1];
                                if (search.value) {
                                    r = replace.value || "";
                                    ans.push([search.value, r]);
                                }
                            }
                            return JSON.stringify(ans);
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["container"]},
                            __module__ : {value: "book_list.conversion_widgets"}
                        });
                        return _anonfunc;
                    })();
                    _d["set"] = (function() {
                        var _anonfunc = function set(container, encval) {
                            var vals, val;
                            try {
                                vals = JSON.parse(encval);
                            } catch (_Exception) {
                                _last_exception = _Exception;
                                {
                                    vals = [];
                                } 
                            }
                            vals = vals || [];
                            clear(container);
                            var _Iter9 = _Iterable(vals);
                            for (var _Index9 = 0; _Index9 < _Iter9.length; _Index9++) {
                                val = _Iter9[_Index9];
                                add(val);
                            }
                            add();
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["container", "encval"]},
                            __module__ : {value: "book_list.conversion_widgets"}
                        });
                        return _anonfunc;
                    })();
                    _d["set_disabled"] = (function() {
                        var _anonfunc = function set_disabled(container, disabled) {
                        };
                        if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                            __argnames__ : {value: ["container", "disabled"]},
                            __module__ : {value: "book_list.conversion_widgets"}
                        });
                        return _anonfunc;
                    })();
                    return _d;
                }).call(this);
                registry["search_replace"] = ops;
                ops.set(container.lastChild, get_option_value("search_replace"));
                container.appendChild(E.div(_interpolate_kwargs.call(this, create_button, [_("Add"), "plus"].concat([_desugar_kwargs({action: (function() {
                    var _anonfunc = function () {
                        add();
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })()})]))));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var comic_input = ep((function() {
            var _anonfunc = function comic_input(container) {
                var settings, g;
                settings = [];
                function add() {
                    var func = ( 0 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[0];
                    var name = ( 1 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[1];
                    var text = ( 2 === arguments.length-1 && arguments[arguments.length-1] !== null && typeof arguments[arguments.length-1] === "object" && arguments[arguments.length-1] [_kwargs_symbol] === true) ? undefined : arguments[2];
                    var kw = arguments[arguments.length-1];
                    if (kw === null || typeof kw !== "object" || kw [_kwargs_symbol] !== true) kw = {};
                    g.appendChild(_interpolate_kwargs.call(this, func, [name, text].concat([_desugar_kwargs(kw)])));
                    settings.push(name);
                };
                if (!add.__handles_kwarg_interpolation__) Object.defineProperties(add, {
                    __handles_kwarg_interpolation__ : {value: true},
                    __argnames__ : {value: ["func", "name", "text"]},
                    __module__ : {value: "book_list.conversion_widgets"}
                });

                add_listener("no_process", (function() {
                    var _anonfunc = function (name) {
                        var disabled, dname;
                        disabled = get("no_process");
                        var _Iter10 = _Iterable(settings);
                        for (var _Index10 = 0; _Index10 < _Iter10.length; _Index10++) {
                            dname = _Iter10[_Index10];
                            set_disabled(dname, disabled);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })());
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("no_process", _("&Disable comic processing")));
                add(checkbox, "dont_grayscale", _("Disable conversion of images to &black and white"));
                add(checkbox, "dont_add_comic_pages_to_toc", _("Don't add links to &pages to the Table of Contents for CBC files"));
                _interpolate_kwargs.call(this, add, [int_spin, "colors", _("&Number of colors:")].concat([_desugar_kwargs({max: 256, step: 8})]));
                add(lineedit, "comic_image_size", _("Override image si&ze:"));
                add(checkbox, "dont_normalize", _("Disable &normalize"));
                add(checkbox, "keep_aspect_ratio", _("Keep &aspect ratio"));
                add(checkbox, "dont_sharpen", _("Disable &sharpening"));
                add(checkbox, "disable_trim", _("Disable &trimming"));
                add(checkbox, "wide", _("&Wide"));
                add(checkbox, "landscape", _("&Landscape"));
                add(checkbox, "right2left", _("&Right to left"));
                add(checkbox, "no_sort", _("Don't so&rt"));
                add(checkbox, "despeckle", _("De&speckle"));
                g.appendChild(choices("output_format", _("O&utput format:"), ['png', 'jpg']));
                settings.push("output_format");
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var fb2_input = ep((function() {
            var _anonfunc = function fb2_input(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("no_inline_fb2_toc", _("Do not insert a Table of Contents at the beginning of the book")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var pdf_input = ep((function() {
            var _anonfunc = function pdf_input(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["unwrap_factor", _("Line &un-wrapping factor:")].concat([_desugar_kwargs({max: 1, step: .01})])));
                g.appendChild(checkbox("no_images", _("No &images")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var rtf_input = ep((function() {
            var _anonfunc = function rtf_input(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("ignore_wmf", _("Ignore &WMF images in the RTF file")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var docx_input = ep((function() {
            var _anonfunc = function docx_input(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("docx_no_cover", _("Do not try to autodetect a &cover from images in the document")));
                g.appendChild(checkbox("docx_no_pagebreaks_between_notes", _("Do not add a page after every &endnote")));
                g.appendChild(checkbox("docx_inline_subsup", _("Render &superscripts and subscripts so that they do not affect the line height")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var txt_input = ep((function() {
            var _anonfunc = function txt_input(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(choices("paragraph_type", _("Para&graph style:"), ui_data.paragraph_types));
                g.appendChild(choices("formatting_type", _("Forma&tting style:"), ui_data.formatting_types));
                g.appendChild(checkbox("preserve_spaces", _("Preserve &spaces")));
                g.appendChild(checkbox("txt_in_remove_indents", _("Remove &indents at the beginning of lines")));
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_("Allowed Markdown extensions:"), _interpolate_kwargs.call(E, E.div, [subset_choice("markdown_extensions", ui_data.md_extensions)].concat([_desugar_kwargs({style: "margin-left: 1em; margin-top: 1ex"})]))].concat([_desugar_kwargs({style: "margin-top: 1ex"})])));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var epub_output = ep((function() {
            var _anonfunc = function epub_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("dont_split_on_page_breaks", _("Do not &split on page breaks")));
                g.appendChild(checkbox("no_default_epub_cover", _("No default &cover")));
                g.appendChild(checkbox("epub_flatten", _("&Flatten EPUB file structure")));
                g.appendChild(checkbox("no_svg_cover", _("No &SVG cover")));
                g.appendChild(checkbox("preserve_cover_aspect_ratio", _("Preserve cover &aspect ratio")));
                g.appendChild(checkbox("epub_inline_toc", _("Insert inline &Table of Contents")));
                g.appendChild(checkbox("epub_toc_at_end", _("Put inserted Table of Contents at the &end of the book")));
                g.appendChild(lineedit("toc_title", _("&Title for inserted ToC:")));
                g.appendChild(_interpolate_kwargs.call(this, int_spin, ["flow_size", _("Split files &larger than:")].concat([_desugar_kwargs({unit: "KB", max: 1e6, step: 20})])));
                g.appendChild(lineedit("epub_max_image_size", _("Shrink &images larger than:")));
                g.appendChild(choices("epub_version", _("EP&UB version:"), ui_data.versions));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var docx_output = ep((function() {
            var _anonfunc = function docx_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(choices("docx_page_size", _("Paper si&ze:"), ui_data.page_sizes));
                g.appendChild(lineedit("docx_custom_page_size", _("&Custom size:")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["docx_page_margin_left", _("Page &left margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["docx_page_margin_top", _("Page &top margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["docx_page_margin_right", _("Page &right margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["docx_page_margin_bottom", _("Page &bottom margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(checkbox("docx_no_toc", _("Do not insert the &Table of Contents as a page at the start of the document")));
                g.appendChild(checkbox("docx_no_cover", _("Do not insert &cover as image at start of document")));
                g.appendChild(checkbox("preserve_cover_aspect_ratio", _("Preserve the aspect ratio of the image inserted as cover")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var fb2_output = ep((function() {
            var _anonfunc = function fb2_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(choices("sectionize", _("Sec&tionize:"), ui_data.sectionize));
                g.appendChild(choices("fb2_genre", _("&Genre:"), ui_data.genres));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var lrf_output = ep((function() {
            var _anonfunc = function lrf_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("autorotation", _("Enable &auto-rotation of wide images")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["wordspace", _("&Wordspace:")].concat([_desugar_kwargs({min: 1, max: 20, unit: "pt"})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["minimum_indent", _("Minim&um para. indent:")].concat([_desugar_kwargs({unit: "pt"})])));
                g.appendChild(checkbox("render_tables_as_images", _("Render &tables as images")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["text_size_multiplier_for_rendered_tables", indent + _("Text size multiplier for text in rendered tables:")].concat([_desugar_kwargs({step: .01})])));
                g.appendChild(checkbox("header", _("Add &header")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["header_separation", indent + _("Header &separation:")].concat([_desugar_kwargs({unit: "pt"})])));
                g.appendChild(lineedit("header_format", indent + _("Header &format:")));
                g.appendChild(lineedit("serif_family", _("Serif fon&t family:")));
                g.appendChild(lineedit("sans_family", _("Sans-serif font fami&ly:")));
                g.appendChild(lineedit("mono_family", _("&Monospace font family:")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var mobi_output = ep((function() {
            var _anonfunc = function mobi_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("no_inline_toc", _("Do not add &Table of Contents to book")));
                g.appendChild(lineedit("toc_title", indent + _("&Title for Table of Contents:")));
                g.appendChild(checkbox("mobi_toc_at_start", _("Put generated Table of Contents at &start of book instead of end")));
                g.appendChild(checkbox("mobi_ignore_margins", _("Ignore &margins")));
                g.appendChild(checkbox("prefer_author_sort", _("Use author &sort for author")));
                g.appendChild(checkbox("mobi_keep_original_images", _("Do not convert all images to &JPEG (may result in images not working in older viewers)")));
                g.appendChild(checkbox("dont_compress", _("Disable &compression of the file contents")));
                g.appendChild(choices("mobi_file_type", _("MOBI fi&le type:"), ui_data.file_types));
                g.appendChild(lineedit("personal_doc", _("Personal Doc tag:")));
                g.appendChild(checkbox("share_not_sync", _("Enable &sharing of book content via Facebook, etc. WARNING: Disables last read syncing")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var azw3_output = ep((function() {
            var _anonfunc = function azw3_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("no_inline_toc", _("Do not add &Table of Contents to book")));
                g.appendChild(lineedit("toc_title", indent + _("&Title for Table of Contents:")));
                g.appendChild(checkbox("mobi_toc_at_start", _("Put generated Table of Contents at &start of book instead of end")));
                g.appendChild(checkbox("prefer_author_sort", _("Use author &sort for author")));
                g.appendChild(checkbox("dont_compress", _("Disable &compression of the file contents")));
                g.appendChild(checkbox("share_not_sync", _("Enable &sharing of book content via Facebook, etc. WARNING: Disables last read syncing")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var pdb_output = ep((function() {
            var _anonfunc = function pdb_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(choices("format", _("Forma&t:"), ui_data.formats));
                g.appendChild(lineedit("pdb_output_encoding", _("O&utput encoding:")));
                g.appendChild(checkbox("inline_toc", _("&Inline TOC")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var pdf_output = ep((function() {
            var _anonfunc = function pdf_output(container) {
                var g;
                add_listener("use_profile_size", (function() {
                    var _anonfunc = function (name) {
                        var disabled, dname;
                        disabled = get("use_profile_size");
                        var _Iter11 = _Iterable(_list_decorate([ "paper_size", "custom_size", "unit" ]));
                        for (var _Index11 = 0; _Index11 < _Iter11.length; _Index11++) {
                            dname = _Iter11[_Index11];
                            set_disabled(dname, disabled);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })());
                add_listener("pdf_use_document_margins", (function() {
                    var _anonfunc = function (name) {
                        var disabled, dname;
                        disabled = get("pdf_use_document_margins");
                        var _Iter12 = _Iterable(_list_decorate([ "left", "top", "right", "bottom" ]));
                        for (var _Index12 = 0; _Index12 < _Iter12.length; _Index12++) {
                            dname = _Iter12[_Index12];
                            set_disabled("pdf_page_margin_" + _str.format("{}", dname) + "", disabled);
                        }
                    };
                    if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                        __argnames__ : {value: ["name"]},
                        __module__ : {value: "book_list.conversion_widgets"}
                    });
                    return _anonfunc;
                })());
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("use_profile_size", _("&Use the paper size set in output profile")));
                g.appendChild(choices("paper_size", indent + _("&Paper size:"), ui_data.paper_sizes));
                g.appendChild(lineedit("custom_size", indent + _("&Custom size:")));
                g.appendChild(choices("unit", indent + _("Custom size unit:"), ui_data.units));
                g.appendChild(checkbox("pdf_no_cover", _("Discard book &cover")));
                g.appendChild(checkbox("preserve_cover_aspect_ratio", _("Preserve &aspect ratio of cover")));
                g.appendChild(checkbox("pdf_page_numbers", _("Add page &numbers to the bottom of every page")));
                g.appendChild(checkbox("pdf_hyphenate", _("&Break long words at the end of lines")));
                g.appendChild(checkbox("pdf_add_toc", _("Add a printable &Table of Contents at the end")));
                g.appendChild(lineedit("toc_title", indent + _("&Title for ToC:")));
                g.appendChild(lineedit("pdf_serif_family", _("Serif famil&y:")));
                g.appendChild(lineedit("pdf_sans_family", _("Sans fami&ly:")));
                g.appendChild(lineedit("pdf_mono_family", _("&Monospace family:")));
                g.appendChild(choices("pdf_standard_font", _("S&tandard font:"), ui_data.font_types));
                g.appendChild(_interpolate_kwargs.call(this, int_spin, ["pdf_default_font_size", _("Default font si&ze:")].concat([_desugar_kwargs({unit: "px"})])));
                g.appendChild(_interpolate_kwargs.call(this, int_spin, ["pdf_mono_font_size", _("Default font si&ze:")].concat([_desugar_kwargs({unit: "px"})])));
                g.appendChild(lineedit("pdf_page_number_map", _("Page number &map:")));
                g.appendChild(checkbox("pdf_use_document_margins", _("Use page margins from the &document being converted")));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["pdf_page_margin_left", indent + _("Left page margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["pdf_page_margin_top", indent + _("Top page margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["pdf_page_margin_right", indent + _("Right page margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["pdf_page_margin_bottom", indent + _("Bottom page margin")].concat([_desugar_kwargs({unit: "pt", min: -100, max: 500})])));
                g.appendChild(_interpolate_kwargs.call(this, float_spin, ["pdf_odd_even_offset", indent + _("Odd/even offset")].concat([_desugar_kwargs({unit: "pt", min: -500, max: 500})])));
                g.appendChild(lineedit("pdf_header_template", _("&Header template:")));
                g.appendChild(lineedit("pdf_footer_template", _("&Footer template:")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var pml_output = ep((function() {
            var _anonfunc = function pml_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(lineedit("pml_output_encoding", _("O&utput encoding:")));
                g.appendChild(checkbox("inline_toc", _("&Inline TOC")));
                g.appendChild(checkbox("full_image_depth", _("Do not &reduce image size and depth")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var rb_output = ep((function() {
            var _anonfunc = function rb_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("inline_toc", _("&Inline TOC")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var txt_output = ep((function() {
            var _anonfunc = function txt_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(lineedit("txt_output_encoding", _("O&utput encoding:")));
                g.appendChild(choices("newline", _("&Line ending style:"), ui_data.newline_types));
                g.appendChild(choices("txt_output_formatting", _("Forma&tting:"), ui_data.formatting_types));
                g = E.div(E.div(_("Options for plain text output:")), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group", style: "margin-left: 1rem; margin-top: 1ex"})]));
                container.appendChild(g);
                g = g.lastChild;
                g.appendChild(checkbox("inline_toc", _("&Inline TOC")));
                g.appendChild(_interpolate_kwargs.call(this, int_spin, ["max_line_length", _("&Maximum line length:")].concat([_desugar_kwargs({max: 1e3})])));
                g.appendChild(checkbox("force_max_line_length", _("Force maximum line &length")));
                g = E.div(E.div(_("Options for Markdown and TexTile output:")), _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group", style: "margin-left: 1rem; margin-top: 1ex"})]));
                container.appendChild(g);
                g = g.lastChild;
                g.appendChild(checkbox("keep_links", _("Do not remove links (<a> tags) before processing")));
                g.appendChild(checkbox("keep_image_references", _("Do not remove image &references before processing")));
                g.appendChild(checkbox("keep_color", _("Keep text &color, when possible")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var txtz_output = ep((function() {
            var _anonfunc = function txtz_output(container) {
                return txt_output(container);
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var htmlz_output = ep((function() {
            var _anonfunc = function htmlz_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(choices("htmlz_css_type", _("How to handle &CSS"), ui_data.css_choices));
                g.appendChild(choices("htmlz_class_style", _("How to handle &CSS"), ui_data.sheet_choices));
                g.appendChild(checkbox("htmlz_title_filename", _("Use book title as the filename for the HTML file")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        
        var snb_output = ep((function() {
            var _anonfunc = function snb_output(container) {
                var g;
                g = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "simple-group"})]);
                container.appendChild(g);
                g.appendChild(checkbox("snb_insert_empty_line", _("Insert &empty line between paragraphs")));
                g.appendChild(checkbox("snb_dont_indent_first_line", _("Don't indent the &first line for each paragraph")));
                g.appendChild(checkbox("snb_hide_chapter_name", _("Hide &chapter name")));
                g.appendChild(checkbox("snb_full_screen", _("Optimize for full-&screen mode")));
            };
            if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.conversion_widgets"}
            });
            return _anonfunc;
        })());

        function restore_defaults() {
            var setting;
            var _Iter13 = _Iterable(registry);
            for (var _Index13 = 0; _Index13 < _Iter13.length; _Index13++) {
                setting = _Iter13[_Index13];
                set(setting, get_option_default_value(setting));
            }
        };
        if (!restore_defaults.__module__) Object.defineProperties(restore_defaults, {
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function create_option_group(group_name, ui_data_, profiles_, container, get_option_value_, get_option_default_value_, is_option_disabled_, get_option_help_, on_close) {
            var _unpack;
            _unpack = [get_option_value_, get_option_default_value_, is_option_disabled_, 
            get_option_help_];
            get_option_value = _unpack[0];
            get_option_default_value = _unpack[1];
            is_option_disabled = _unpack[2];
            get_option_help = _unpack[3];
            _unpack = [profiles_, ui_data_];
            profiles = _unpack[0];
            ui_data = _unpack[1];
            registry = Object.create(null);
            listeners = Object.create(null);
            container_id = ensure_id(container);
            container.classList.add(CLASS_NAME);
            entry_points[(typeof group_name === "number" && group_name < 0) ? entry_points.length + group_name : group_name](container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Done")].concat([_desugar_kwargs({action: on_close})])), "", _interpolate_kwargs.call(this, create_button, [_("Restore defaults")].concat([_desugar_kwargs({action: restore_defaults})]))].concat([_desugar_kwargs({style: "margin-top: 2ex; padding-top: 2ex; border-top: solid 1px currentColor"})])));
        };
        if (!create_option_group.__argnames__) Object.defineProperties(create_option_group, {
            __argnames__ : {value: ["group_name", "ui_data_", "profiles_", "container", "get_option_value_", "get_option_default_value_", "is_option_disabled_", "get_option_help_", "on_close"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        function commit_changes(set_option_value) {
            var name;
            var _Iter14 = _Iterable(registry);
            for (var _Index14 = 0; _Index14 < _Iter14.length; _Index14++) {
                name = _Iter14[_Index14];
                set_option_value(name, get(name));
            }
        };
        if (!commit_changes.__argnames__) Object.defineProperties(commit_changes, {
            __argnames__ : {value: ["set_option_value"]},
            __module__ : {value: "book_list.conversion_widgets"}
        });

        _modules["book_list.conversion_widgets"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.conversion_widgets"].indent = indent;
        _modules["book_list.conversion_widgets"].container_id = container_id;
        _modules["book_list.conversion_widgets"].get_option_value = get_option_value;
        _modules["book_list.conversion_widgets"].get_option_default_value = get_option_default_value;
        _modules["book_list.conversion_widgets"].is_option_disabled = is_option_disabled;
        _modules["book_list.conversion_widgets"].get_option_help = get_option_help;
        _modules["book_list.conversion_widgets"].profiles = profiles;
        _modules["book_list.conversion_widgets"].ui_data = ui_data;
        _modules["book_list.conversion_widgets"].entry_points = entry_points;
        _modules["book_list.conversion_widgets"].registry = registry;
        _modules["book_list.conversion_widgets"].listeners = listeners;
        _modules["book_list.conversion_widgets"].ep = ep;
        _modules["book_list.conversion_widgets"].add_listener = add_listener;
        _modules["book_list.conversion_widgets"].on_change = on_change;
        _modules["book_list.conversion_widgets"].sanitize_accelerator = sanitize_accelerator;
        _modules["book_list.conversion_widgets"].subset_choice = subset_choice;
        _modules["book_list.conversion_widgets"].create_simple_widget = create_simple_widget;
        _modules["book_list.conversion_widgets"].checkbox = checkbox;
        _modules["book_list.conversion_widgets"].lineedit = lineedit;
        _modules["book_list.conversion_widgets"].float_spin = float_spin;
        _modules["book_list.conversion_widgets"].int_spin = int_spin;
        _modules["book_list.conversion_widgets"].choices = choices;
        _modules["book_list.conversion_widgets"].textarea = textarea;
        _modules["book_list.conversion_widgets"].container_for_option = container_for_option;
        _modules["book_list.conversion_widgets"].get = get;
        _modules["book_list.conversion_widgets"].set = set;
        _modules["book_list.conversion_widgets"].set_disabled = set_disabled;
        _modules["book_list.conversion_widgets"].look_and_feel = look_and_feel;
        _modules["book_list.conversion_widgets"].heuristics = heuristics;
        _modules["book_list.conversion_widgets"].page_setup = page_setup;
        _modules["book_list.conversion_widgets"].structure_detection = structure_detection;
        _modules["book_list.conversion_widgets"].toc = toc;
        _modules["book_list.conversion_widgets"].search_and_replace = search_and_replace;
        _modules["book_list.conversion_widgets"].comic_input = comic_input;
        _modules["book_list.conversion_widgets"].fb2_input = fb2_input;
        _modules["book_list.conversion_widgets"].pdf_input = pdf_input;
        _modules["book_list.conversion_widgets"].rtf_input = rtf_input;
        _modules["book_list.conversion_widgets"].docx_input = docx_input;
        _modules["book_list.conversion_widgets"].txt_input = txt_input;
        _modules["book_list.conversion_widgets"].epub_output = epub_output;
        _modules["book_list.conversion_widgets"].docx_output = docx_output;
        _modules["book_list.conversion_widgets"].fb2_output = fb2_output;
        _modules["book_list.conversion_widgets"].lrf_output = lrf_output;
        _modules["book_list.conversion_widgets"].mobi_output = mobi_output;
        _modules["book_list.conversion_widgets"].azw3_output = azw3_output;
        _modules["book_list.conversion_widgets"].pdb_output = pdb_output;
        _modules["book_list.conversion_widgets"].pdf_output = pdf_output;
        _modules["book_list.conversion_widgets"].pml_output = pml_output;
        _modules["book_list.conversion_widgets"].rb_output = rb_output;
        _modules["book_list.conversion_widgets"].txt_output = txt_output;
        _modules["book_list.conversion_widgets"].txtz_output = txtz_output;
        _modules["book_list.conversion_widgets"].htmlz_output = htmlz_output;
        _modules["book_list.conversion_widgets"].snb_output = snb_output;
        _modules["book_list.conversion_widgets"].restore_defaults = restore_defaults;
        _modules["book_list.conversion_widgets"].create_option_group = create_option_group;
        _modules["book_list.conversion_widgets"].commit_changes = commit_changes;
    })();

    (function(){
        var __name__ = "book_list.convert_book";
        var CLASS_NAME, current_state, overall_container_id, initializers, conversion_data, conversion_data_load_status;
        var E = _modules.elementmaker.E;

        var _ = _modules.gettext.gettext;

        var ajax = _modules.ajax.ajax;
        var ajax_send = _modules.ajax.ajax_send;

        var report_load_failure = _modules["book_list.book_details"].report_load_failure;

        var create_option_group = _modules["book_list.conversion_widgets"].create_option_group;
        var entry_points = _modules["book_list.conversion_widgets"].entry_points;
        var commit_changes = _modules["book_list.conversion_widgets"].commit_changes;

        var download_url = _modules["book_list.library_data"].download_url;
        var load_status = _modules["book_list.library_data"].load_status;
        var url_books_query = _modules["book_list.library_data"].url_books_query;

        var back = _modules["book_list.router"].back;
        var open_book = _modules["book_list.router"].open_book;
        var report_a_load_failure = _modules["book_list.router"].report_a_load_failure;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;
        var set_title = _modules["book_list.top_bar"].set_title;

        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;

        var add_extra_css = _modules.dom.add_extra_css;
        var build_rule = _modules.dom.build_rule;
        var clear = _modules.dom.clear;

        var error_dialog = _modules.modals.error_dialog;

        var conditional_timeout = _modules.utils.conditional_timeout;
        var human_readable = _modules.utils.human_readable;
        var parse_url_params = _modules.utils.parse_url_params;

        var create_button = _modules.widgets.create_button;
        var enable_escape_key = _modules.widgets.enable_escape_key;

        CLASS_NAME = "convert-book-panel";
        current_state = "initializing";
        overall_container_id = null;
        initializers = Object.create(null);
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = "." + CLASS_NAME + " ";
                style = _interpolate_kwargs.call(this, build_rule, [sel].concat([_desugar_kwargs({padding: "1ex 1rem"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + "h3"].concat([_desugar_kwargs({margin_bottom: "1ex"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".group-names"].concat([_desugar_kwargs({list_style: "none", display: "flex", flex_wrap: "wrap"})]));
                style += _interpolate_kwargs.call(this, build_rule, [sel + ".group-names li"].concat([_desugar_kwargs({padding: "1ex 1rem", font_weight: "bold", white_space: "nowrap"})]));
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.convert_book"}
            });
            return _anonfunc;
        })());
        conversion_data = null;
        conversion_data_load_status = (function(){
            var _d = Object.create(null);
            _d["loading"] = true;
            _d["ok"] = false;
            _d["error_html"] = null;
            _d["current_fetch"] = null;
            return _d;
        }).call(this);
        function container_for_current_state() {
            var ans;
            ans = document.getElementById(overall_container_id);
            if (ans) {
                return ans.querySelector("[data-state=\"" + _str.format("{}", current_state) + "\"]");
            }
        };
        if (!container_for_current_state.__module__) Object.defineProperties(container_for_current_state, {
            __module__ : {value: "book_list.convert_book"}
        });

        function create_converted_markup() {
            function init(container) {
                var fmt, book_id;
                clear(container);
                container.appendChild(E.h3("Conversion successful!"));
                fmt = conversion_data.fmt.toUpperCase();
                book_id = int(conversion_data.book_id);
                function read_book() {
                    open_book(book_id, fmt);
                };
                if (!read_book.__module__) Object.defineProperties(read_book, {
                    __module__ : {value: "book_list.convert_book"}
                });

                container.appendChild(_interpolate_kwargs.call(E, E.div, [create_button(_("Read {}").format(fmt), "book", read_book), "", _interpolate_kwargs.call(this, create_button, [_("Download {}").format(fmt), "cloud-download", download_url(book_id, fmt), _("File size: {}").format(human_readable(conversion_data.size))].concat([_desugar_kwargs({download_filename: "" + _str.format("{}", conversion_data.title) + "." + _str.format("{}", fmt.toLowerCase()) + ""})]))].concat([_desugar_kwargs({style: "margin-top: 1rem"})])));
            };
            if (!init.__argnames__) Object.defineProperties(init, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.convert_book"}
            });

            return [E.div(), init];
        };
        if (!create_converted_markup.__module__) Object.defineProperties(create_converted_markup, {
            __module__ : {value: "book_list.convert_book"}
        });

        function report_conversion_ajax_failure(xhr) {
            current_state = "configuring";
            apply_state_to_markup();
            error_dialog(_("Failed to convert"), _("Could not convert {}. Click \"Show details\" for more information").format(conversion_data.title), xhr.error_html);
        };
        if (!report_conversion_ajax_failure.__argnames__) Object.defineProperties(report_conversion_ajax_failure, {
            __argnames__ : {value: ["xhr"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function show_failure(response) {
            var c, log;
            current_state = "failed";
            apply_state_to_markup();
            c = container_for_current_state();
            clear(c);
            c.appendChild(E.h3(_("Conversion failed!")));
            c.appendChild(E.div(_("Error details below...")));
            c.appendChild(E.div(""));
            c.appendChild(E.div());
            c = c.lastChild;
            if (response.was_aborted) {
                c.textContent = _("Conversion of {} was taking too long, and has been aborted").format(conversion_data.title);
            } else {
                log = "";
                if (response.traceback) {
                    log += response.traceback;
                }
                if (response.log) {
                    log += "\n\n" + _("Conversion log") + "\n\n";
                    log += response.log;
                }
                c.appendChild(E.pre(log));
            }
        };
        if (!show_failure.__argnames__) Object.defineProperties(show_failure, {
            __argnames__ : {value: ["response"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function on_conversion_status(end_type, xhr, ev) {
            var response, c;
            if (current_state !== "converting" || !container_for_current_state()) {
                return;
            }
            if (end_type === "load") {
                response = JSON.parse(xhr.responseText);
                if (response.running) {
                    c = container_for_current_state();
                    c.querySelector("progress").value = response.percent;
                    if (response.msg) {
                        c.querySelector(".progress-msg").textContent = response.msg;
                    }
                    check_for_conversion_status();
                } else {
                    if (response.ok) {
                        conversion_data.fmt = response.fmt;
                        conversion_data.size = response.size;
                        current_state = "converted";
                        apply_state_to_markup();
                    } else {
                        show_failure(response);
                    }
                }
            } else {
                report_conversion_ajax_failure(xhr);
            }
        };
        if (!on_conversion_status.__argnames__) Object.defineProperties(on_conversion_status, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function check_for_conversion_status(abort_job) {
            var query, data;
            query = url_books_query();
            if (abort_job) {
                query.abort_job = "1";
            }
            data = Object.create(null);
            _interpolate_kwargs.call(this, ajax_send, ["conversion/status/" + _str.format("{}", conversion_data.job_id) + "", data, on_conversion_status].concat([_desugar_kwargs({query: query})]));
        };
        if (!check_for_conversion_status.__argnames__) Object.defineProperties(check_for_conversion_status, {
            __argnames__ : {value: ["abort_job"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function on_conversion_started(end_type, xhr, ev) {
            if (end_type === "load") {
                conversion_data.job_id = JSON.parse(xhr.responseText);
                check_for_conversion_status();
            } else {
                report_conversion_ajax_failure(xhr);
            }
        };
        if (!on_conversion_started.__argnames__) Object.defineProperties(on_conversion_started, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function get_conversion_options(container) {
            return conversion_data.conversion_options.options;
        };
        if (!get_conversion_options.__argnames__) Object.defineProperties(get_conversion_options, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function create_converting_markup() {
            var ans;
            ans = E.div(_interpolate_kwargs.call(E, E.div, [_("Converting, please wait"), E.div(E.progress()), _interpolate_kwargs.call(E, E.div, [""].concat([_desugar_kwargs({class_: "progress-msg"})])), E.div(""), E.div(_("Conversion progress can sometimes stall for a few minutes when converting complex books, that is normal.")), E.div(""), E.div(_("Click the close button in the top left corner to abort the conversion."))].concat([_desugar_kwargs({style: "text-align: center; margin: auto"})])));
            function init(container) {
                container.querySelector("progress").removeAttribute("value");
            };
            if (!init.__argnames__) Object.defineProperties(init, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.convert_book"}
            });

            return [ans, init];
        };
        if (!create_converting_markup.__module__) Object.defineProperties(create_converting_markup, {
            __module__ : {value: "book_list.convert_book"}
        });

        function current_input_format() {
            return document.getElementById(overall_container_id).querySelector("select[name=\"input_formats\"]").value.toUpperCase();
        };
        if (!current_input_format.__module__) Object.defineProperties(current_input_format, {
            __module__ : {value: "book_list.convert_book"}
        });

        function current_output_format() {
            return document.getElementById(overall_container_id).querySelector("select[name=\"output_formats\"]").value.toUpperCase();
        };
        if (!current_output_format.__module__) Object.defineProperties(current_output_format, {
            __module__ : {value: "book_list.convert_book"}
        });

        function start_conversion() {
            var container, data, query;
            container = document.getElementById(overall_container_id);
            data = (function(){
                var _d = Object.create(null);
                _d["input_fmt"] = current_input_format();
                _d["output_fmt"] = current_output_format();
                _d["options"] = get_conversion_options(container);
                _d["book_id"] = conversion_data.book_id;
                return _d;
            }).call(this);
            query = url_books_query();
            _interpolate_kwargs.call(this, ajax_send, ["conversion/start/" + _str.format("{}", conversion_data.book_id) + "", data, on_conversion_started].concat([_desugar_kwargs({query: query})]));
            current_state = "converting";
            apply_state_to_markup();
        };
        if (!start_conversion.__module__) Object.defineProperties(start_conversion, {
            __module__ : {value: "book_list.convert_book"}
        });

        function create_configuring_markup() {
            var ignore_changes, ans, tcell, start_conv, GROUP_TITLES;
            ignore_changes = false;
            ans = E.div();
            function on_format_change() {
                var input_fmt, output_fmt, q;
                if (ignore_changes) {
                    return;
                }
                input_fmt = container_for_current_state().querySelector("select[name=\"input_formats\"]").value;
                output_fmt = container_for_current_state().querySelector("select[name=\"output_formats\"]").value;
                current_state = "initializing";
                conditional_timeout(overall_container_id, 5, check_for_data_loaded);
                q = parse_url_params();
                fetch_conversion_data(q.book_id, input_fmt, output_fmt);
                apply_state_to_markup();
            };
            if (!on_format_change.__module__) Object.defineProperties(on_format_change, {
                __module__ : {value: "book_list.convert_book"}
            });

            function generate_choice(name) {
                var ans;
                ans = _interpolate_kwargs.call(E, E.select, [_desugar_kwargs({name: name})]);
                ans.addEventListener("change", on_format_change);
                return ans;
            };
            if (!generate_choice.__argnames__) Object.defineProperties(generate_choice, {
                __argnames__ : {value: ["name"]},
                __module__ : {value: "book_list.convert_book"}
            });

            tcell = "display: table-cell; padding-top: 1em; padding-left: 1em";
            start_conv = _interpolate_kwargs.call(E, E.div, [E.div(_interpolate_kwargs.call(E, E.label, [_interpolate_kwargs.call(E, E.div, [_("Input format:")].concat([_desugar_kwargs({style: tcell})])), _interpolate_kwargs.call(E, E.div, [generate_choice("input_formats")].concat([_desugar_kwargs({style: tcell})]))].concat([_desugar_kwargs({style: "display: table-row"})])), _interpolate_kwargs.call(E, E.label, [_interpolate_kwargs.call(E, E.div, [_("Output format:")].concat([_desugar_kwargs({style: tcell})])), _interpolate_kwargs.call(E, E.div, [generate_choice("output_formats")].concat([_desugar_kwargs({style: tcell})]))].concat([_desugar_kwargs({style: "display: table-row"})]))), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(this, create_button, [_("Start conversion")].concat([_desugar_kwargs({action: start_conversion})]))].concat([_desugar_kwargs({style: "margin: 1em"})]))].concat([_desugar_kwargs({style: "border-bottom: solid 1px currentColor; margin-bottom: 1em"})]));
            ans.appendChild(start_conv);
            ans.appendChild(_interpolate_kwargs.call(E, E.div, [_("To change the settings for this conversion, click on one of the option groups below:")].concat([_desugar_kwargs({style: "margin-bottom: 1em"})])));
            function show_group(ev) {
                var li, group_name, group_title;
                li = ev.currentTarget.closest("li");
                group_name = li.dataset.group;
                group_title = li.firstChild.textContent;
                conversion_data.configuring_group = group_name;
                conversion_data.configuring_group_title = group_title;
                current_state = "configure-group";
                apply_state_to_markup();
                document.getElementById(overall_container_id).focus();
            };
            if (!show_group.__argnames__) Object.defineProperties(show_group, {
                __argnames__ : {value: ["ev"]},
                __module__ : {value: "book_list.convert_book"}
            });

            function is_group_configurable(name) {
                if (entry_points[(typeof name === "number" && name < 0) ? entry_points.length + name : name]) {
                    return true;
                }
                if (name === "input_fmt") {
                    name = conversion_data.conversion_options.input_plugin_name;
                } else if (name === "output_fmt") {
                    name = conversion_data.conversion_options.output_plugin_name;
                }
                return bool(entry_points[(typeof name === "number" && name < 0) ? entry_points.length + name : name]);
            };
            if (!is_group_configurable.__argnames__) Object.defineProperties(is_group_configurable, {
                __argnames__ : {value: ["name"]},
                __module__ : {value: "book_list.convert_book"}
            });

            function category(name) {
                var ans;
                ans = E.li(_interpolate_kwargs.call(E, E.a, [_desugar_kwargs({class_: "simple-link", href: "javascript: void(0)"})]));
                ans.dataset.group = name;
                ans.firstChild.addEventListener("click", show_group);
                return ans;
            };
            if (!category.__argnames__) Object.defineProperties(category, {
                __argnames__ : {value: ["name"]},
                __module__ : {value: "book_list.convert_book"}
            });

            GROUP_TITLES = (function(){
                var _d = Object.create(null);
                _d["heuristics"] = _("Heuristic processing");
                _d["look_and_feel"] = _("Look & feel");
                _d["page_setup"] = _("Page setup");
                _d["search_and_replace"] = _("Search & replace");
                _d["structure_detection"] = _("Structure detection");
                _d["toc"] = _("Table of Contents");
                return _d;
            }).call(this);
            ans.appendChild(_interpolate_kwargs.call(E, E.ul, [category("input_fmt"), category("look_and_feel"), category("page_setup"), category("search_and_replace"), category("structure_detection"), category("toc"), category("heuristics"), category("output_fmt")].concat([_desugar_kwargs({class_: "group-names"})])));
            function initialize(container) {
                var sel, formats, fmt, name, group_name, title, li;
                ignore_changes = true;
                var _Iter0 = _Iterable(_list_decorate([ "input_formats", "output_formats" ]));
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    name = _Iter0[_Index0];
                    sel = container.querySelector("select[name=\"" + _str.format("{}", name) + "\"]");
                    clear(sel);
                    formats = conversion_data[(typeof name === "number" && name < 0) ? conversion_data.length + name : name];
                    var _Iter1 = _Iterable(formats);
                    for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                        fmt = _Iter1[_Index1];
                        sel.appendChild(_interpolate_kwargs.call(E, E.option, [fmt].concat([_desugar_kwargs({value: fmt})])));
                    }
                }
                ignore_changes = false;
                var _Iter2 = _Iterable(container.querySelectorAll(".group-names > li"));
                for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                    li = _Iter2[_Index2];
                    group_name = li.dataset.group;
                    li.style.display = (is_group_configurable(group_name)) ? "block" : "none";
                    if (GROUP_TITLES[(typeof group_name === "number" && group_name < 0) ? GROUP_TITLES.length + group_name : group_name]) {
                        title = GROUP_TITLES[(typeof group_name === "number" && group_name < 0) ? GROUP_TITLES.length + group_name : group_name];
                    } else if (group_name === "input_fmt") {
                        title = _("{} input").format(current_input_format(), title);
                    } else {
                        title = _("{} output").format(current_output_format(), title);
                    }
                    li.firstChild.textContent = title;
                }
            };
            if (!initialize.__argnames__) Object.defineProperties(initialize, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.convert_book"}
            });

            return [ans, initialize];
        };
        if (!create_configuring_markup.__module__) Object.defineProperties(create_configuring_markup, {
            __module__ : {value: "book_list.convert_book"}
        });

        function get_option_value(name, defval) {
            var ans;
            ans = (_expr_temp = conversion_data.conversion_options.options)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            if (ans === undefined) {
                ans = defval;
            }
            return ans;
        };
        if (!get_option_value.__argnames__) Object.defineProperties(get_option_value, {
            __argnames__ : {value: ["name", "defval"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function get_option_default_value(name, defval) {
            var ans;
            ans = (_expr_temp = conversion_data.conversion_options.defaults)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name];
            if (ans === undefined) {
                ans = defval;
            }
            return ans;
        };
        if (!get_option_default_value.__argnames__) Object.defineProperties(get_option_default_value, {
            __argnames__ : {value: ["name", "defval"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function set_option_value(name, val) {
            (_expr_temp = conversion_data.conversion_options.options)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = val;
        };
        if (!set_option_value.__argnames__) Object.defineProperties(set_option_value, {
            __argnames__ : {value: ["name", "val"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function is_option_disabled(name) {
            return (_expr_temp = conversion_data.disabled_map)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] === true;
        };
        if (!is_option_disabled.__argnames__) Object.defineProperties(is_option_disabled, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function get_option_help(name) {
            return (_expr_temp = conversion_data.conversion_options.help)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] || "";
        };
        if (!get_option_help.__argnames__) Object.defineProperties(get_option_help, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function create_configure_group_markup() {
            var ans;
            ans = E.div();
            function init(container) {
                var panel, g, ui_data;
                clear(container);
                container.appendChild(_interpolate_kwargs.call(E, E.h3, [_("Configuring {} settings").format(conversion_data.configuring_group_title)].concat([_desugar_kwargs({style: "margin-bottom: 1ex"})])));
                panel = E.div();
                container.appendChild(panel);
                g = conversion_data.configuring_group;
                ui_data = null;
                if (g === "input_fmt") {
                    g = conversion_data.conversion_options.input_plugin_name;
                    ui_data = conversion_data.conversion_options.input_ui_data;
                } else if (g === "output_fmt") {
                    g = conversion_data.conversion_options.output_plugin_name;
                    ui_data = conversion_data.conversion_options.output_ui_data;
                }
                create_option_group(g, ui_data, conversion_data.profiles, container, get_option_value, get_option_default_value, is_option_disabled, get_option_help, on_close);
            };
            if (!init.__argnames__) Object.defineProperties(init, {
                __argnames__ : {value: ["container"]},
                __module__ : {value: "book_list.convert_book"}
            });

            return [ans, init];
        };
        if (!create_configure_group_markup.__module__) Object.defineProperties(create_configure_group_markup, {
            __module__ : {value: "book_list.convert_book"}
        });

        function on_data_loaded(end_type, xhr, ev) {
            var name;
            conversion_data_load_status.current_fetch = null;
            conversion_data_load_status.loading = false;
            conversion_data_load_status.ok = true;
            conversion_data_load_status.error_html = null;
            function bad_load(msg) {
                conversion_data_load_status.ok = false;
                conversion_data_load_status.error_html = msg || xhr.error_html;
            };
            if (!bad_load.__argnames__) Object.defineProperties(bad_load, {
                __argnames__ : {value: ["msg"]},
                __module__ : {value: "book_list.convert_book"}
            });

            if (end_type === "load") {
                conversion_data = JSON.parse(xhr.responseText);
                conversion_data.disabled_map = Object.create(null);
                var _Iter3 = _Iterable(conversion_data.conversion_options.disabled);
                for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                    name = _Iter3[_Index3];
                    (_expr_temp = conversion_data.disabled_map)[(typeof name === "number" && name < 0) ? _expr_temp.length + name : name] = true;
                }
            } else if (end_type === "abort") {
            } else {
                bad_load();
            }
        };
        if (!on_data_loaded.__argnames__) Object.defineProperties(on_data_loaded, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function fetch_conversion_data(book_id, input_fmt, output_fmt) {
            var query;
            if (conversion_data_load_status.current_fetch) {
                conversion_data_load_status.current_fetch.abort();
            }
            conversion_data = null;
            query = url_books_query();
            if (input_fmt) {
                query.input_fmt = input_fmt;
            }
            if (output_fmt) {
                query.output_fmt = output_fmt;
            }
            conversion_data_load_status.loading = true;
            conversion_data_load_status.ok = false;
            conversion_data_load_status.error_html = null;
            conversion_data_load_status.current_fetch = _interpolate_kwargs.call(this, ajax, ["conversion/book-data/" + _str.format("{}", book_id) + "", on_data_loaded].concat([_desugar_kwargs({query: query})]));
            conversion_data_load_status.current_fetch.send();
        };
        if (!fetch_conversion_data.__argnames__) Object.defineProperties(fetch_conversion_data, {
            __argnames__ : {value: ["book_id", "input_fmt", "output_fmt"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function on_close(container_id) {
            if (current_state === "configure-group") {
                commit_changes(set_option_value);
                current_state = "configuring";
                apply_state_to_markup();
                return;
            }
            if (current_state === "converting") {
                check_for_conversion_status(true);
            }
            current_state = "initializing";
            apply_state_to_markup();
            back();
        };
        if (!on_close.__argnames__) Object.defineProperties(on_close, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function check_for_data_loaded() {
            var container;
            container = this;
            if (load_status.loading || conversion_data_load_status.loading) {
                conditional_timeout(container.id, 5, check_for_data_loaded);
                return;
            }
            container = container.lastChild;
            if (!load_status.ok) {
                current_state = "load-failure";
                report_load_failure(container_for_current_state());
            } else if (!conversion_data_load_status.ok) {
                current_state = "load-failure";
                report_a_load_failure(container_for_current_state(), _("Failed to load conversion data from calibre, with error:"), conversion_data_load_status.error_html);
            } else {
                set_title(container.parentNode, _("Convert: {}").format(conversion_data.title));
                current_state = "configuring";
            }
            apply_state_to_markup();
        };
        if (!check_for_data_loaded.__module__) Object.defineProperties(check_for_data_loaded, {
            __module__ : {value: "book_list.convert_book"}
        });

        function create_markup(container) {
            container.appendChild(_interpolate_kwargs.call(E, E.div, [E.div(_("Loading conversion data, please wait..."))].concat([_desugar_kwargs({data_state: "initializing"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_state: "load-failure"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_state: "failed"})]));
            function cm(name, func) {
                var _unpack, ccm, init;
                _unpack = func();
_unpack = _unpack_asarray(2, _unpack);
                ccm = _unpack[0];
                init = _unpack[1];
                ccm.dataset.state = name;
                container.appendChild(ccm);
                initializers[(typeof name === "number" && name < 0) ? initializers.length + name : name] = init;
            };
            if (!cm.__argnames__) Object.defineProperties(cm, {
                __argnames__ : {value: ["name", "func"]},
                __module__ : {value: "book_list.convert_book"}
            });

            cm("configuring", create_configuring_markup);
            cm("converting", create_converting_markup);
            cm("converted", create_converted_markup);
            cm("configure-group", create_configure_group_markup);
        };
        if (!create_markup.__argnames__) Object.defineProperties(create_markup, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.convert_book"}
        });

        function apply_state_to_markup() {
            var container, node;
            container = document.getElementById(overall_container_id);
            if (container) {
                var _Iter4 = _Iterable(container.lastChild.childNodes);
                for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                    node = _Iter4[_Index4];
                    if (node.dataset.state === current_state) {
                        node.style.display = "block";
                        if (initializers[(typeof current_state === "number" && current_state < 0) ? initializers.length + current_state : current_state]) {
                            initializers[(typeof current_state === "number" && current_state < 0) ? initializers.length + current_state : current_state](node);
                        }
                    } else {
                        node.style.display = "none";
                    }
                }
            }
        };
        if (!apply_state_to_markup.__module__) Object.defineProperties(apply_state_to_markup, {
            __module__ : {value: "book_list.convert_book"}
        });

        function init(container_id) {
            var container, q;
            container = document.getElementById(container_id);
            overall_container_id = container_id;
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Convert book"), action: on_close.bind(null, container_id), icon: "close"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: CLASS_NAME})]));
            create_markup(container.lastChild);
            apply_state_to_markup();
            conditional_timeout(container_id, 5, check_for_data_loaded);
            q = parse_url_params();
            fetch_conversion_data(q.book_id);
            enable_escape_key(container, on_close.bind(null, container_id));
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.convert_book"}
        });

        set_panel_handler("convert_book", init);
        _modules["book_list.convert_book"].CLASS_NAME = CLASS_NAME;
        _modules["book_list.convert_book"].current_state = current_state;
        _modules["book_list.convert_book"].overall_container_id = overall_container_id;
        _modules["book_list.convert_book"].initializers = initializers;
        _modules["book_list.convert_book"].conversion_data = conversion_data;
        _modules["book_list.convert_book"].conversion_data_load_status = conversion_data_load_status;
        _modules["book_list.convert_book"].container_for_current_state = container_for_current_state;
        _modules["book_list.convert_book"].create_converted_markup = create_converted_markup;
        _modules["book_list.convert_book"].report_conversion_ajax_failure = report_conversion_ajax_failure;
        _modules["book_list.convert_book"].show_failure = show_failure;
        _modules["book_list.convert_book"].on_conversion_status = on_conversion_status;
        _modules["book_list.convert_book"].check_for_conversion_status = check_for_conversion_status;
        _modules["book_list.convert_book"].on_conversion_started = on_conversion_started;
        _modules["book_list.convert_book"].get_conversion_options = get_conversion_options;
        _modules["book_list.convert_book"].create_converting_markup = create_converting_markup;
        _modules["book_list.convert_book"].current_input_format = current_input_format;
        _modules["book_list.convert_book"].current_output_format = current_output_format;
        _modules["book_list.convert_book"].start_conversion = start_conversion;
        _modules["book_list.convert_book"].create_configuring_markup = create_configuring_markup;
        _modules["book_list.convert_book"].get_option_value = get_option_value;
        _modules["book_list.convert_book"].get_option_default_value = get_option_default_value;
        _modules["book_list.convert_book"].set_option_value = set_option_value;
        _modules["book_list.convert_book"].is_option_disabled = is_option_disabled;
        _modules["book_list.convert_book"].get_option_help = get_option_help;
        _modules["book_list.convert_book"].create_configure_group_markup = create_configure_group_markup;
        _modules["book_list.convert_book"].on_data_loaded = on_data_loaded;
        _modules["book_list.convert_book"].fetch_conversion_data = fetch_conversion_data;
        _modules["book_list.convert_book"].on_close = on_close;
        _modules["book_list.convert_book"].check_for_data_loaded = check_for_data_loaded;
        _modules["book_list.convert_book"].create_markup = create_markup;
        _modules["book_list.convert_book"].apply_state_to_markup = apply_state_to_markup;
        _modules["book_list.convert_book"].init = init;
    })();

    (function(){
        var __name__ = "book_list.fts";
        var overall_container_id, current_fts_query, query_id_counter;
        var E = _modules.elementmaker.E;

        var ajax = _modules.ajax.ajax;
        var ajax_send = _modules.ajax.ajax_send;

        var THUMBNAIL_MAX_HEIGHT = _modules["book_list.cover_grid"].THUMBNAIL_MAX_HEIGHT;
        var THUMBNAIL_MAX_WIDTH = _modules["book_list.cover_grid"].THUMBNAIL_MAX_WIDTH;

        var get_current_query = _modules["book_list.globals"].get_current_query;
        var get_session_data = _modules["book_list.globals"].get_session_data;

        var current_library_id = _modules["book_list.library_data"].current_library_id;
        var download_url = _modules["book_list.library_data"].download_url;
        var library_data = _modules["book_list.library_data"].library_data;

        var back = _modules["book_list.router"].back;
        var home = _modules["book_list.router"].home;
        var open_book_url = _modules["book_list.router"].open_book_url;
        var push_state = _modules["book_list.router"].push_state;

        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var query_as_href = _modules["book_list.ui"].query_as_href;
        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;

        var create_image = _modules["book_list.views"].create_image;

        var create_search_bar = _modules.complete.create_search_bar;

        var add_extra_css = _modules.dom.add_extra_css;
        var clear = _modules.dom.clear;
        var set_css = _modules.dom.set_css;
        var svgicon = _modules.dom.svgicon;

        var _ = _modules.gettext.gettext;

        var create_custom_dialog = _modules.modals.create_custom_dialog;
        var error_dialog = _modules.modals.error_dialog;
        var info_dialog = _modules.modals.info_dialog;
        var question_dialog = _modules.modals.question_dialog;

        var create_button = _modules.widgets.create_button;
        var create_spinner = _modules.widgets.create_spinner;

        overall_container_id = "";
        current_fts_query = Object.create(null);
        query_id_counter = 0;
        add_extra_css((function() {
            var _anonfunc = function () {
                var sel, style;
                sel = ".fts-help-display ";
                style = "" + _str.format("{}", sel) + " " + "{ padding-top: 0.5ex }\n";
                style += "" + _str.format("{}", sel) + " div" + " { margin-top: 0.5ex }\n";
                style += "" + _str.format("{}", sel) + " .h" + " { font-weight: bold; padding-bottom: 0.25ex }\n";
                style += "" + _str.format("{}", sel) + " .bq" + " { margin-left: 1em; margin-top: 0.5ex; margin-bottom: 0.5ex; font-style: italic }\n";
                style += "" + _str.format("{}", sel) + " p" + " { margin: 0}\n";
                style += ".fts-highlight-match { font-style: italic; font-weight: bold }\n";
                return style;
            };
            if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                __module__ : {value: "book_list.fts"}
            });
            return _anonfunc;
        })());
        function component(name) {
            var c;
            c = document.getElementById(overall_container_id);
            if (c) {
                return c.querySelector("[data-component=\"" + _str.format("{}", name) + "\"]");
            }
        };
        if (!component.__argnames__) Object.defineProperties(component, {
            __argnames__ : {value: ["name"]},
            __module__ : {value: "book_list.fts"}
        });

        function showing_search_panel() {
            var c;
            c = component("search");
            return bool(c && c.style.display === "block");
        };
        if (!showing_search_panel.__module__) Object.defineProperties(showing_search_panel, {
            __module__ : {value: "book_list.fts"}
        });

        function make_new_fts_query(q) {
            var xhr;
            query_id_counter += 1;
            current_fts_query = (function(){
                var _d = Object.create(null);
                _d["query_id"] = query_id_counter + "";
                return _d;
            }).call(this);
            if (current_library_id()) {
                current_fts_query.library_id = current_library_id();
            }
            Object.assign(current_fts_query, q);
            xhr = _interpolate_kwargs.call(this, ajax, ["fts/search", on_initial_fts_fetched].concat([_desugar_kwargs({query: current_fts_query, bypass_cache: true})]));
            xhr.send();
        };
        if (!make_new_fts_query.__argnames__) Object.defineProperties(make_new_fts_query, {
            __argnames__ : {value: ["q"]},
            __module__ : {value: "book_list.fts"}
        });

        function enable_indexing() {
            function on_response(end_type, xhr, ev) {
                if (end_type === "abort" || !showing_search_panel()) {
                    return;
                }
                if (end_type !== "load") {
                    if (xhr.status === 403) {
                        return error_dialog(_("Permission denied"), _("You do not have permission to enable indexing. Only logged in users with write permission are allowed."), xhr.error_html);
                    }
                    return error_dialog(_("Failed to enable indexing"), _("Enabling indexing failed. Click \"Show details\" for more information."), xhr.error_html);
                }
                library_data.fts_enabled = true;
                info_dialog(_("Indexing enabled"), _("Indexing of this library has been enabled. Depending on library size it can take a long time to index all books."));
            };
            if (!on_response.__argnames__) Object.defineProperties(on_response, {
                __argnames__ : {value: ["end_type", "xhr", "ev"]},
                __module__ : {value: "book_list.fts"}
            });

            ajax_send("fts/indexing", true, on_response);
        };
        if (!enable_indexing.__module__) Object.defineProperties(enable_indexing, {
            __module__ : {value: "book_list.fts"}
        });

        function report_fts_not_enabled() {
            question_dialog(_("Full text searching disabled"), _("Full text search indexing has not been enabled for this library. Once enabled, indexing will take some time to complete after which searching will work. Enable indexing?"), (function() {
                var _anonfunc = function (yes) {
                    if (yes) {
                        enable_indexing();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "book_list.fts"}
                });
                return _anonfunc;
            })());
        };
        if (!report_fts_not_enabled.__module__) Object.defineProperties(report_fts_not_enabled, {
            __module__ : {value: "book_list.fts"}
        });

        function on_initial_fts_fetched(end_type, xhr, ev) {
            var results;
            if (end_type === "abort" || !showing_search_panel()) {
                return;
            }
            if (end_type !== "load") {
                clear_to_waiting_for_results(_("No matches found"));
                if (xhr.status === 428) {
                    return report_fts_not_enabled();
                }
                return error_dialog(_("Failed to search"), _("The search failed. Click \"Show details\" for more information."), xhr.error_html);
            }
            try {
                results = JSON.parse(xhr.responseText);
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof Error) {
                    var err = _Exception;
                    return error_dialog(_("Server error"), _("Failed to parse search response from server."), err + "");
                } else {
                    throw _Exception;
                }
            }
            if (results.query_id + "" !== current_fts_query.query_id) {
                return;
            }
            current_fts_query.results = results;
            show_initial_results();
        };
        if (!on_initial_fts_fetched.__argnames__) Object.defineProperties(on_initial_fts_fetched, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.fts"}
        });

        function execute_search_interactive() {
            var query, q;
            query = component("query").querySelector("input").value;
            if (!query || query.length < 1) {
                error_dialog(_("No search query specified"), _("A search word/phrase must be specified before attempting to search"));
                clear_to_help();
                return;
            }
            q = get_current_query();
            q.fts_panel = "search";
            q.fts_query = query;
            q.fts_use_stemming = (component("related_words").checked) ? "y" : "n";
            if (q.restricted === "y") {
                q.restriction = component("restrict").querySelector("input").value;
            }
            current_fts_query = Object.create(null);
            _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: true})]));
        };
        if (!execute_search_interactive.__module__) Object.defineProperties(execute_search_interactive, {
            __module__ : {value: "book_list.fts"}
        });

        function build_search_page() {
            var container, search_button, search_bar, sd, related_words, restrict_bar;
            container = component("search");
            clear(container);
            search_button = _interpolate_kwargs.call(this, create_button, [_("Search")].concat([_desugar_kwargs({icon: "search", tooltip: _("Do the search")})]));
            search_bar = _interpolate_kwargs.call(this, create_search_bar, [execute_search_interactive, "search-books-fts"].concat([_desugar_kwargs({tooltip: _("Search for books"), placeholder: _("Enter words to search for"), button: search_button})]));
            _interpolate_kwargs.call(this, set_css, [search_bar].concat([_desugar_kwargs({flex_grow: "10", margin_right: "0.5em"})]));
            search_bar.dataset.component = "query";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [svgicon("fts"), E.span(""), search_bar, search_button].concat([_desugar_kwargs({style: "display: flex; width: 100%; align-items: center"})])));
            sd = get_session_data();
            related_words = _interpolate_kwargs.call(E, E.label, [_interpolate_kwargs.call(E, E.input, [_desugar_kwargs({type: "checkbox", data_component: "related_words", checked: bool(sd.get("fts_related_words"))})]), "" + _("Match on related words")].concat([_desugar_kwargs({onchange: (function() {
                var _anonfunc = function () {
                    var sd, rw;
                    sd = get_session_data();
                    rw = bool(component("related_words").checked);
                    if (rw !== sd.get("fts_related_words")) {
                        get_session_data().set("fts_related_words", rw);
                    }
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.fts"}
                });
                return _anonfunc;
            })(), title: _("With this option searching for words will also match on any related words (supported in several languages). For example, in the English language: {0} matches {1} and {2} as well").format("correction", "correcting", "corrected")})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [related_words].concat([_desugar_kwargs({style: "padding-top: 1ex;"})])));
            restrict_bar = _interpolate_kwargs.call(this, create_search_bar, [execute_search_interactive, "search-books-fts-restrict"].concat([_desugar_kwargs({tooltip: _("Restrict the results to only books matching this query"), placeholder: _("Restrict to books matching...")})]));
            _interpolate_kwargs.call(this, set_css, [restrict_bar].concat([_desugar_kwargs({flex_grow: "10", margin_right: "0.5em"})]));
            restrict_bar.dataset.component = "restrict";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [svgicon("search"), E.span(""), restrict_bar].concat([_desugar_kwargs({style: "padding-top: 1ex; display: flex; width: 100%; align-items: center"})])));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "border-top: 1px currentColor solid; margin-top: 1ex", data_component: "results"})]));
        };
        if (!build_search_page.__module__) Object.defineProperties(build_search_page, {
            __module__ : {value: "book_list.fts"}
        });

        function clear_to_waiting_for_results(msg) {
            var container;
            container = component("results");
            if (!container) {
                return;
            }
            clear(container);
            msg = msg || _("Searching, please wait") + "";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [create_spinner(), "" + msg].concat([_desugar_kwargs({style: "margin: auto; width: 100%; text-align: center; margin-top: 4ex"})])));
        };
        if (!clear_to_waiting_for_results.__argnames__) Object.defineProperties(clear_to_waiting_for_results, {
            __argnames__ : {value: ["msg"]},
            __module__ : {value: "book_list.fts"}
        });

        function toggle_restrict() {
            var container, q;
            container = component("restrict");
            if (!container) {
                return;
            }
            q = get_current_query();
            q.restricted = (q.restricted === "y") ? "n" : "y";
            _interpolate_kwargs.call(this, push_state, [q].concat([_desugar_kwargs({replace: true})]));
        };
        if (!toggle_restrict.__module__) Object.defineProperties(toggle_restrict, {
            __module__ : {value: "book_list.fts"}
        });

        function clear_to_help() {
            var container, restrict, fts_url, html, a;
            container = component("results");
            if (!container) {
                return;
            }
            clear(container);
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({class_: "fts-help-display"})]));
            restrict = get_current_query().restricted === "y";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Re-index all books in this library")].concat([_desugar_kwargs({class_: "blue-link", href: "javascript:void(0)", onclick: reindex_all})])), E.span(""), _interpolate_kwargs.call(E, E.a, [_("Disable full text search")].concat([_desugar_kwargs({class_: "blue-link", href: "javascript:void(0)", onclick: disable_fts})])), E.span(""), _interpolate_kwargs.call(E, E.a, [(restrict) ? _("Search all books") : _("Search a subset of books")].concat([_desugar_kwargs({class_: "blue-link", href: "javascript:void(0)", onclick: toggle_restrict})]))].concat([_desugar_kwargs({style: "margin-top: 1ex"})])));
            container = container.firstChild;
            fts_url = "https://www.sqlite.org/fts5.html#full_text_query_syntax";
            html = (_expr_temp = _("\n<div class=\"h\">Search for single words</div>\n<p>Simply type the word:</p>\n<div class=\"bq\">awesome<br>calibre</div>\n\n<div class=\"h\">Search for phrases</div>\n<p>Enclose the phrase in quotes:</p>\n<div class=\"bq\">\"early run\"<br>\"song of love\"</div>\n\n<div class=\"h\">Boolean searches</div>\n<div class=\"bq\">(calibre AND ebook) NOT gun<br>simple NOT (\"high bar\" OR hard)</div>\n\n<div class=\"h\">Phrases near each other</div>\n<div class=\"bq\">NEAR(\"people\" \"in Asia\" \"try\")<br>NEAR(\"Kovid\" \"calibre\", 30)</div>\n<p>Here, 30 is the most words allowed between near groups. Defaults to 10 when unspecified.</p>\n\n<div style=\"margin-top: 1em\"><a href=\"{fts_url}\">Full syntax reference</a></div>\n" + "</div>"), _interpolate_kwargs.call(_expr_temp, _expr_temp.format, [_desugar_kwargs({fts_url: fts_url})]));
            container.innerHTML = html;
            a = container.querySelector("a[href]");
            a.setAttribute("target", "_new");
            a.classList.add("blue-link");
        };
        if (!clear_to_help.__module__) Object.defineProperties(clear_to_help, {
            __module__ : {value: "book_list.fts"}
        });

        function apply_search_panel_state() {
            var q, ftsq, r;
            q = get_current_query();
            ftsq = (function(){
                var _d = Object.create(null);
                _d["query"] = q.fts_query || "";
                _d["use_stemming"] = q.fts_use_stemming || "y";
                _d["restriction"] = (q.restricted === "y") ? q.restriction : "";
                return _d;
            }).call(this);
            component("query").querySelector("input").value = ftsq.query;
            component("related_words").checked = ftsq.use_stemming === "y";
            r = component("restrict");
            r.parentNode.style.display = (ftsq.restriction !== "") ? "flex" : "none";
            r.querySelector("input").value = q.restriction || "";
            if (!ftsq.query) {
                clear_to_help();
                return;
            }
            if (current_fts_query.query !== ftsq.query || current_fts_query.use_stemming !== ftsq.use_stemming || current_fts_query.restriction !== ftsq.restriction) {
                make_new_fts_query(ftsq);
                clear_to_waiting_for_results(_("Searching for {}, please wait").format(ftsq.query));
                return;
            }
            show_initial_results();
        };
        if (!apply_search_panel_state.__module__) Object.defineProperties(apply_search_panel_state, {
            __module__ : {value: "book_list.fts"}
        });

        function open_format(book_id, fmt) {
            var snippets, text, s, url, w;
            snippets = _exists.d(current_fts_query.results).snippets;
            if (snippets) {
                snippets = snippets[(typeof book_id === "number" && book_id < 0) ? snippets.length + book_id : book_id];
            }
            text = "";
            if (snippets && fmt !== "PDF") {
                var _Iter0 = _Iterable(snippets);
                for (var _Index0 = 0; _Index0 < _Iter0.length; _Index0++) {
                    s = _Iter0[_Index0];
                    if (s.formats.indexOf(fmt) > -1) {
                        text = s.text;
                        break;
                    }
                }
            }
            url = open_book_url(book_id, fmt);
            if (fmt === "PDF") {
                url = download_url(book_id, fmt, "inline");
            }
            w = window.open(url, "_blank");
            if (text) {
                text = str.strip(text, "").replaceAll("\u001c", "").replaceAll("\u001e", "");
                w.read_book_initial_open_search_text = (function(){
                    var _d = Object.create(null);
                    _d["text"] = text;
                    _d["query"] = current_fts_query.query;
                    return _d;
                }).call(this);
            }
        };
        if (!open_format.__argnames__) Object.defineProperties(open_format, {
            __argnames__ : {value: ["book_id", "fmt"]},
            __module__ : {value: "book_list.fts"}
        });

        function reindex_book(book_id) {
            function on_response(end_type, xhr, ev) {
                if (end_type === "abort" || !showing_search_panel()) {
                    return;
                }
                if (end_type !== "load") {
                    if (xhr.status === 403) {
                        return error_dialog(_("Permission denied"), _("You do not have permission to re-index books. Only logged in users with write permission are allowed to re-index"), xhr.error_html);
                    }
                    return error_dialog(_("Failed to re-index"), _("Re-indexing the book failed. Click \"Show details\" for more information."), xhr.error_html);
                }
                info_dialog(_("Re-indexing scheduled"), (book_id) ? _("The book has been scheduled for re-indexing") : _("All books have been scheduled for re-indexing"));
            };
            if (!on_response.__argnames__) Object.defineProperties(on_response, {
                __argnames__ : {value: ["end_type", "xhr", "ev"]},
                __module__ : {value: "book_list.fts"}
            });

            if (book_id) {
                ajax_send("fts/reindex", (function(){
                    var _d = Object.create(null);
                    _d[book_id] = [];
                    return _d;
                }).call(this), on_response);
            } else {
                ajax_send("fts/reindex", "all", on_response);
            }
        };
        if (!reindex_book.__argnames__) Object.defineProperties(reindex_book, {
            __argnames__ : {value: ["book_id"]},
            __module__ : {value: "book_list.fts"}
        });

        function reindex_all() {
            question_dialog(_("Are you sure?"), _("Re-indexing all books in the library can take a long time. Are you sure you want to proceed?"), (function() {
                var _anonfunc = function (yes) {
                    if (yes) {
                        reindex_book();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "book_list.fts"}
                });
                return _anonfunc;
            })());
        };
        if (!reindex_all.__module__) Object.defineProperties(reindex_all, {
            __module__ : {value: "book_list.fts"}
        });

        function disable_fts_backend() {
            function on_response(end_type, xhr, ev) {
                if (end_type === "abort" || !showing_search_panel()) {
                    return;
                }
                if (end_type !== "load") {
                    if (xhr.status === 403) {
                        return error_dialog(_("Permission denied"), _("You do not have permission to disable FTS. Only logged in users with write permission are allowed to disable FTS."), xhr.error_html);
                    }
                    return error_dialog(_("Disabling FTS failed"), _("Disabling FTS failed. Click \"Show details\" for more information."), xhr.error_html);
                }
                library_data.fts_enabled = false;
                _interpolate_kwargs.call(this, info_dialog, [_("Full text searching disabled"), _("Full text searching for this library has been disabled. In the future the entire library will have to be re-indexed when re-enabling full text searching.")].concat([_desugar_kwargs({on_close: (function() {
                    var _anonfunc = function () {
                        window.setTimeout(home);
                    };
                    if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                        __module__ : {value: "book_list.fts"}
                    });
                    return _anonfunc;
                })()})]));
            };
            if (!on_response.__argnames__) Object.defineProperties(on_response, {
                __argnames__ : {value: ["end_type", "xhr", "ev"]},
                __module__ : {value: "book_list.fts"}
            });

            _interpolate_kwargs.call(this, ajax, ["fts/disable", on_response].concat([_desugar_kwargs({bypass_cache: true})])).send();
        };
        if (!disable_fts_backend.__module__) Object.defineProperties(disable_fts_backend, {
            __module__ : {value: "book_list.fts"}
        });

        function disable_fts() {
            question_dialog(_("Are you sure?"), _("Disabling full text search means that in the future the entire library will have to be re-indexed to use full text search. Are you sure you want to proceed?"), (function() {
                var _anonfunc = function (yes) {
                    if (yes) {
                        disable_fts_backend();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["yes"]},
                    __module__ : {value: "book_list.fts"}
                });
                return _anonfunc;
            })());
        };
        if (!disable_fts.__module__) Object.defineProperties(disable_fts, {
            __module__ : {value: "book_list.fts"}
        });

        function book_result_tile_clicked(ev) {
            var result_tile, bid, results, formats, x;
            result_tile = ev.currentTarget;
            bid = int(result_tile.dataset.bookId);
            results = current_fts_query.results;
            formats = [];
            var _Iter1 = _Iterable(results.results);
            for (var _Index1 = 0; _Index1 < _Iter1.length; _Index1++) {
                x = _Iter1[_Index1];
                if (x.book_id === bid) {
                    formats.push(x.format);
                }
            }
            create_custom_dialog(result_tile.title, (function() {
                var _anonfunc = function (parent, close_modal) {
                    var fmc, a, fmt;
                    fmc = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "display: flex; flex-wrap: wrap; margin-top: 1ex"})]);
                    function open_format_and_close(book_id, fmt) {
                        open_format(book_id, fmt);
                        close_modal();
                    };
                    if (!open_format_and_close.__argnames__) Object.defineProperties(open_format_and_close, {
                        __argnames__ : {value: ["book_id", "fmt"]},
                        __module__ : {value: "book_list.fts"}
                    });

                    function reindex(book_id) {
                        close_modal();
                        reindex_book(book_id);
                    };
                    if (!reindex.__argnames__) Object.defineProperties(reindex, {
                        __argnames__ : {value: ["book_id"]},
                        __module__ : {value: "book_list.fts"}
                    });

                    var _Iter2 = _Iterable(formats);
                    for (var _Index2 = 0; _Index2 < _Iter2.length; _Index2++) {
                        fmt = _Iter2[_Index2];
                        a = _interpolate_kwargs.call(E, E.a, [fmt].concat([_desugar_kwargs({class_: "blue-link", style: "cursor: pointer; margin: 1ex; display: block", href: "javascript: void(0)", onclick: open_format_and_close.bind(null, bid, fmt)})]));
                        fmc.appendChild(a);
                    }
                    parent.appendChild(E.div(_("Click one of the formats below to open the book at this search result (except PDF which will open at the start):"), fmc));
                    parent.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Open the details page for this book")].concat([_desugar_kwargs({class_: "blue-link", target: "_blank", href: query_as_href((function(){
                        var _d = Object.create(null);
                        _d["book_id"] = str(bid);
                        return _d;
                    }).call(this), "book_details")})]))].concat([_desugar_kwargs({style: "margin-top: 1ex"})])));
                    parent.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.a, [_("Re-index this book")].concat([_desugar_kwargs({class_: "blue-link", href: "javascript: void(0)", onclick: reindex.bind(null, bid)})]))].concat([_desugar_kwargs({style: "margin-top: 1ex"})])));
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["parent", "close_modal"]},
                    __module__ : {value: "book_list.fts"}
                });
                return _anonfunc;
            })());
        };
        if (!book_result_tile_clicked.__argnames__) Object.defineProperties(book_result_tile_clicked, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "book_list.fts"}
        });

        function book_result_tile(book_id, title, authors) {
            var _unpack, tile_height, img_max_width, img, tooltip;
            _unpack = ["16ex", "12ex"];
            tile_height = _unpack[0];
            img_max_width = _unpack[1];
            img = create_image(book_id, THUMBNAIL_MAX_WIDTH, THUMBNAIL_MAX_HEIGHT, (function() {
                var _anonfunc = function () {
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.fts"}
                });
                return _anonfunc;
            })());
            img.style.maxHeight = tile_height;
            img.style.maxWidth = img_max_width;
            tooltip = title + " " + _("by") + " " + authors;
            img.alt = _("Cover of") + " " + tooltip;
            return _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [img].concat([_desugar_kwargs({style: "margin-right: 1ex; width: " + _str.format("{}", img_max_width) + ""})])), _interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [_("loading"), ""].concat([_desugar_kwargs({style: "font-size: small; font-style: italic; opacity: 0.5;"})]))].concat([_desugar_kwargs({class_: "snippets_container"})]))].concat([_desugar_kwargs({style: "display:flex; flex-direction: column; height: 100%; overflow-y: auto"})]))].concat([_desugar_kwargs({onclick: book_result_tile_clicked, title: tooltip, data_book_id: book_id + "", data_snippets_needed: "1", style: "cursor: pointer; margin-bottom: 1ex; display:flex; height: " + _str.format("{}", tile_height) + "; max-height: " + _str.format("{}", tile_height) + "; width: 100%; align-items: stretch"})]));
        };
        if (!book_result_tile.__argnames__) Object.defineProperties(book_result_tile, {
            __argnames__ : {value: ["book_id", "title", "authors"]},
            __module__ : {value: "book_list.fts"}
        });

        function on_snippets_fetched(end_type, xhr, ev) {
            var container, results;
            if (end_type === "abort" || !showing_search_panel()) {
                return;
            }
            if (end_type !== "load") {
                return error_dialog(_("Failed to search"), _("The search failed. Click \"Show details\" for more information."), xhr.error_html);
            }
            container = component("results");
            if (!container) {
                return;
            }
            try {
                results = JSON.parse(xhr.responseText);
            } catch (_Exception) {
                _last_exception = _Exception;
                if (_Exception instanceof Error) {
                    var err = _Exception;
                    return error_dialog(_("Server error"), _("Failed to parse search response from server."), err + "");
                } else {
                    throw _Exception;
                }
            }
            if (results.query_id !== current_fts_query.query_id) {
                return;
            }
            if (!current_fts_query.results.snippets) {
                current_fts_query.results.snippets = Object.create(null);
            }
            Object.assign(current_fts_query.results.snippets, results.snippets);
            show_snippets(results.snippets);
            fetch_snippets();
        };
        if (!on_snippets_fetched.__argnames__) Object.defineProperties(on_snippets_fetched, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.fts"}
        });

        function render_text(parent, text) {
            var in_highlighted, q, idx, chunk;
            in_highlighted = false;
            while (text.length > 0) {
                q = (in_highlighted) ? "\u001e" : "\u001c";
                idx = text.indexOf(q);
                if (idx < 0) {
                    idx = text.length;
                }
                chunk = text.slice(0, idx);
                text = text.slice(idx + 1);
                if (in_highlighted) {
                    parent.append(_interpolate_kwargs.call(E, E.span, [chunk].concat([_desugar_kwargs({class_: "fts-highlight-match"})])));
                    in_highlighted = false;
                } else {
                    parent.append(E.span(chunk));
                    in_highlighted = true;
                }
            }
        };
        if (!render_text.__argnames__) Object.defineProperties(render_text, {
            __argnames__ : {value: ["parent", "text"]},
            __module__ : {value: "book_list.fts"}
        });

        function show_snippets(snippets) {
            var container, c, s, f, e, x, book_id;
            container = component("results");
            var _Iter3 = _Iterable(Object.keys(snippets));
            for (var _Index3 = 0; _Index3 < _Iter3.length; _Index3++) {
                book_id = _Iter3[_Index3];
                c = container.querySelector("[data-book-id=\"" + _str.format("{}", book_id) + "\"]");
                if (c) {
                    delete c.dataset.snippetsNeeded;
                    s = c.querySelector(".snippets_container");
                    clear(s);
                    var _Iter4 = _Iterable(snippets[(typeof book_id === "number" && book_id < 0) ? snippets.length + book_id : book_id]);
                    for (var _Index4 = 0; _Index4 < _Iter4.length; _Index4++) {
                        x = _Iter4[_Index4];
                        f = " ".join(x.formats);
                        e = E.div(_interpolate_kwargs.call(E, E.code, [f].concat([_desugar_kwargs({style: "border: solid 1px currentColor; border-radius: 6px; padding: 0 4px; font-size: smaller", data_formats: f})])));
                        e.appendChild(E.span(" "));
                        render_text(e, x.text);
                        s.appendChild(e);
                    }
                }
            }
        };
        if (!show_snippets.__argnames__) Object.defineProperties(show_snippets, {
            __argnames__ : {value: ["snippets"]},
            __module__ : {value: "book_list.fts"}
        });

        function fetch_snippets() {
            var container, ids, book_id, x, q, xhr;
            container = component("results");
            if (!container) {
                return;
            }
            ids = [];
            var _Iter5 = _Iterable(container.querySelectorAll("[data-snippets-needed=\"1\"]"));
            for (var _Index5 = 0; _Index5 < _Iter5.length; _Index5++) {
                x = _Iter5[_Index5];
                book_id = int(x.dataset.bookId);
                ids.push(book_id);
                if (ids.length > 1) {
                    break;
                }
            }
            if (ids.length < 1) {
                return;
            }
            ids = ",".join(ids);
            q = Object.create(null);
            Object.assign(q, current_fts_query);
            q.results = undefined;
            xhr = _interpolate_kwargs.call(this, ajax, ["fts/snippets/" + _str.format("{}", ids) + "", on_snippets_fetched].concat([_desugar_kwargs({query: q, bypass_cache: true})]));
            xhr.send();
        };
        if (!fetch_snippets.__module__) Object.defineProperties(fetch_snippets, {
            __module__ : {value: "book_list.fts"}
        });

        function show_initial_results() {
            var container, results, _unpack, left, total, pc, rc, mm, seen, bid, m, r;
            container = component("results");
            if (!container) {
                return;
            }
            clear(container);
            results = current_fts_query.results;
            _unpack = [results.indexing_status["left"], results.indexing_status["total"]];
            left = _unpack[0];
            total = _unpack[1];
            if (left > 0) {
                pc = int((total - left) / total * 100);
                container.appendChild(_interpolate_kwargs.call(E, E.div, [_interpolate_kwargs.call(E, E.span, [_("WARNING:")].concat([_desugar_kwargs({style: "color: red; font-weight: bold"})])), "", _("Indexing of library only {}% complete, search results may be incomplete.").format(pc)].concat([_desugar_kwargs({style: "margin-top: 0.5ex"})])));
            }
            rc = _interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "margin-top: 0.5ex"})]);
            container.appendChild(rc);
            mm = results.metadata;
            seen = Object.create(null);
            var _Iter6 = _Iterable(results.results);
            for (var _Index6 = 0; _Index6 < _Iter6.length; _Index6++) {
                r = _Iter6[_Index6];
                bid = r["book_id"];
                m = mm[(typeof bid === "number" && bid < 0) ? mm.length + bid : bid];
                if (!seen[(typeof bid === "number" && bid < 0) ? seen.length + bid : bid]) {
                    rc.appendChild(book_result_tile(bid, m["title"], m["authors"]));
                    seen[(typeof bid === "number" && bid < 0) ? seen.length + bid : bid] = rc.lastChild;
                    rc.appendChild(E.hr());
                }
            }
            if (results.results.length < 1) {
                rc.appendChild(E.div(_("No matches found")));
            }
            fetch_snippets();
        };
        if (!show_initial_results.__module__) Object.defineProperties(show_initial_results, {
            __module__ : {value: "book_list.fts"}
        });

        function show_panel(visible) {
            var c, x;
            c = component(visible);
            if (c) {
                x = c.parentNode.firstChild;
                while (x) {
                    if (x.nodeType === 1 && x.dataset.component) {
                        x.style.display = (x === c) ? "block" : "none";
                    }
                    x = x.nextSibling;
                }
            }
        };
        if (!show_panel.__argnames__) Object.defineProperties(show_panel, {
            __argnames__ : {value: ["visible"]},
            __module__ : {value: "book_list.fts"}
        });

        function show_search_panel() {
            show_panel("search");
            apply_search_panel_state();
        };
        if (!show_search_panel.__module__) Object.defineProperties(show_search_panel, {
            __module__ : {value: "book_list.fts"}
        });

        function show_index_panel() {
            show_panel("index");
        };
        if (!show_index_panel.__module__) Object.defineProperties(show_index_panel, {
            __module__ : {value: "book_list.fts"}
        });

        function init(container_id) {
            var container, q;
            overall_container_id = container_id;
            container = document.getElementById(container_id);
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Search text of books"), action: back, icon: "close"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "index"})]));
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({data_component: "search", style: "padding:1ex 1em; margin-top: 0.5ex;"})]));
            build_search_page();
            q = get_current_query();
            if (!q.fts_panel || q.fts_panel === "search") {
                show_search_panel();
            } else if (q.fts_panel === "index") {
                show_index_panel();
            }
        };
        if (!init.__argnames__) Object.defineProperties(init, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.fts"}
        });

        set_panel_handler("fts", init);
        _modules["book_list.fts"].overall_container_id = overall_container_id;
        _modules["book_list.fts"].current_fts_query = current_fts_query;
        _modules["book_list.fts"].query_id_counter = query_id_counter;
        _modules["book_list.fts"].component = component;
        _modules["book_list.fts"].showing_search_panel = showing_search_panel;
        _modules["book_list.fts"].make_new_fts_query = make_new_fts_query;
        _modules["book_list.fts"].enable_indexing = enable_indexing;
        _modules["book_list.fts"].report_fts_not_enabled = report_fts_not_enabled;
        _modules["book_list.fts"].on_initial_fts_fetched = on_initial_fts_fetched;
        _modules["book_list.fts"].execute_search_interactive = execute_search_interactive;
        _modules["book_list.fts"].build_search_page = build_search_page;
        _modules["book_list.fts"].clear_to_waiting_for_results = clear_to_waiting_for_results;
        _modules["book_list.fts"].toggle_restrict = toggle_restrict;
        _modules["book_list.fts"].clear_to_help = clear_to_help;
        _modules["book_list.fts"].apply_search_panel_state = apply_search_panel_state;
        _modules["book_list.fts"].open_format = open_format;
        _modules["book_list.fts"].reindex_book = reindex_book;
        _modules["book_list.fts"].reindex_all = reindex_all;
        _modules["book_list.fts"].disable_fts_backend = disable_fts_backend;
        _modules["book_list.fts"].disable_fts = disable_fts;
        _modules["book_list.fts"].book_result_tile_clicked = book_result_tile_clicked;
        _modules["book_list.fts"].book_result_tile = book_result_tile;
        _modules["book_list.fts"].on_snippets_fetched = on_snippets_fetched;
        _modules["book_list.fts"].render_text = render_text;
        _modules["book_list.fts"].show_snippets = show_snippets;
        _modules["book_list.fts"].fetch_snippets = fetch_snippets;
        _modules["book_list.fts"].show_initial_results = show_initial_results;
        _modules["book_list.fts"].show_panel = show_panel;
        _modules["book_list.fts"].show_search_panel = show_search_panel;
        _modules["book_list.fts"].show_index_panel = show_index_panel;
        _modules["book_list.fts"].init = init;
    })();

    (function(){
        var __name__ = "book_list.show_note";
        var current_note_markup, current_container_id;
        var E = _modules.elementmaker.E;

        var ajax = _modules.ajax.ajax;

        var create_comments_editor = _modules["book_list.comments_editor"].create_comments_editor;
        var destroy_editor = _modules["book_list.comments_editor"].destroy_editor;
        var focus_comments_editor = _modules["book_list.comments_editor"].focus_comments_editor;
        var get_comments_html = _modules["book_list.comments_editor"].get_comments_html;
        var set_comments_html = _modules["book_list.comments_editor"].set_comments_html;

        var sandbox_css = _modules["book_list.details_list"].sandbox_css;

        var book_whose_metadata_is_being_edited = _modules["book_list.globals"].book_whose_metadata_is_being_edited;

        var book_metadata = _modules["book_list.library_data"].book_metadata;

        var back = _modules["book_list.router"].back;
        var home = _modules["book_list.router"].home;
        var show_note = _modules["book_list.router"].show_note;

        var add_button = _modules["book_list.top_bar"].add_button;
        var create_top_bar = _modules["book_list.top_bar"].create_top_bar;

        var set_panel_handler = _modules["book_list.ui"].set_panel_handler;

        var _ = _modules.gettext.gettext;

        var ajax_send_progress_dialog = _modules.modals.ajax_send_progress_dialog;
        var error_dialog = _modules.modals.error_dialog;

        var parse_url_params = _modules.utils.parse_url_params;
        var safe_set_inner_html = _modules.utils.safe_set_inner_html;
        var sandboxed_html = _modules.utils.sandboxed_html;

        function message_from_iframe(ev) {
            var c, iframe, close_action;
            c = document.getElementById(current_container_id);
            if (c && c.lastChild) {
                iframe = c.querySelector("iframe");
                if (iframe && ev.source === iframe.contentWindow) {
                    if (ev.data.key) {
                        ev.data.from_iframe = true;
                        close_action = get_close_action()[0];
                        onkeydown(current_container_id, close_action, ev.data);
                    }
                }
            }
        };
        if (!message_from_iframe.__argnames__) Object.defineProperties(message_from_iframe, {
            __argnames__ : {value: ["ev"]},
            __module__ : {value: "book_list.show_note"}
        });

        function make_iframe(html) {
            var iframe;
            html += "\n<script>\nfunction onkeydown(ev) {\n    ev.preventDefault()\n    ev.stopPropagation()\n    msg = {\n    key: ev.key, altKey: ev.altKey, ctrlKey: ev.ctrlKey, code: ev.code, isComposing: ev.isComposing,\n    repeat: ev.repeat, shiftKey: ev.shiftKey, metaKey: ev.metaKey,\n    }\n    window.parent.postMessage(msg, '*')\n}\ndocument.onkeydown = onkeydown\n" + "<" + "/script>";
            iframe = sandboxed_html(html, sandbox_css() + "\n\nhtml { overflow: visible; margin: 0.5rem; }", "allow-scripts");
            iframe.tabIndex = -1;
            iframe.style.width = "100%";
            iframe.style.flexGrow = "10";
            if (!message_from_iframe.added) {
                message_from_iframe.added = true;
                window.addEventListener("message", message_from_iframe, false);
            }
            return iframe;
        };
        if (!make_iframe.__argnames__) Object.defineProperties(make_iframe, {
            __argnames__ : {value: ["html"]},
            __module__ : {value: "book_list.show_note"}
        });

        current_note_markup = null;
        current_container_id = "";
        function on_item_val_based_notes_fetched(load_type, xhr, ev) {
            var container, q, data, old, p;
            container = document.getElementById(this);
            if (!container) {
                return;
            }
            q = parse_url_params();
            current_note_markup = null;
            if (load_type === "load") {
                data = JSON.parse(xhr.responseText);
                q.html = data.html;
                q.item_id = str(data.item_id);
                current_note_markup = q;
                _interpolate_kwargs.call(this, show_note, [q.field, q.item_id, q.item].concat([_desugar_kwargs({replace: true, library_id: q.library_id || null, close_action: q.close_action, panel: q.panel})]));
                return;
            }
            old = container.querySelector("div.loading");
            p = old.parentNode;
            p.removeChild(old);
            container.appendChild(E.div());
            safe_set_inner_html(container.lastChild, xhr.error_html);
        };
        if (!on_item_val_based_notes_fetched.__argnames__) Object.defineProperties(on_item_val_based_notes_fetched, {
            __argnames__ : {value: ["load_type", "xhr", "ev"]},
            __module__ : {value: "book_list.show_note"}
        });

        function on_notes_fetched(load_type, xhr, ev) {
            var q, html, container, old, p;
            q = parse_url_params();
            if (load_type === "load") {
                html = xhr.responseText;
                q.html = xhr.responseText;
                current_note_markup = q;
            } else {
                current_note_markup = null;
                html = xhr.error_html;
            }
            container = document.getElementById(this);
            if (!container) {
                return;
            }
            old = container.querySelector("div.loading");
            p = old.parentNode;
            p.removeChild(old);
            if (q.panel === "show_note") {
                create_note_display(container);
            } else if (q.panel === "edit_note") {
                if (current_note_markup) {
                    create_editor(container.lastChild, current_note_markup.html);
                } else {
                    container.appendChild(E.div());
                    safe_set_inner_html(container.lastChild, html);
                }
            }
        };
        if (!on_notes_fetched.__argnames__) Object.defineProperties(on_notes_fetched, {
            __argnames__ : {value: ["load_type", "xhr", "ev"]},
            __module__ : {value: "book_list.show_note"}
        });

        function edit_note() {
            var q;
            q = parse_url_params();
            _interpolate_kwargs.call(this, show_note, [q.field, q.item_id, q.item].concat([_desugar_kwargs({library_id: q.library_id, panel: "edit_note"})]));
        };
        if (!edit_note.__module__) Object.defineProperties(edit_note, {
            __module__ : {value: "book_list.show_note"}
        });

        function onkeydown(container_id, close_action, ev) {
            var q;
            if (ev.key === "Escape") {
                if (!ev.from_iframe) {
                    [ev.preventDefault(), ev.stopPropagation()];
                }
                close_action();
            } else if (ev.key === "e" || ev.key === "E") {
                q = parse_url_params();
                if (q.panel === "show_note") {
                    if (!ev.from_iframe) {
                        [ev.preventDefault(), ev.stopPropagation()];
                    }
                    edit_note();
                }
            }
        };
        if (!onkeydown.__argnames__) Object.defineProperties(onkeydown, {
            __argnames__ : {value: ["container_id", "close_action", "ev"]},
            __module__ : {value: "book_list.show_note"}
        });

        function setup_container(container, close_action) {
            container.style.height = "100vh";
            container.style.display = "flex";
            container.style.flexDirection = "column";
            container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({tabindex: "0", style: "flex-grow: 10; display: flex; align-items: stretch"})]));
            container.lastChild.addEventListener("keydown", onkeydown.bind(null, container.id, close_action), (function(){
                var _d = Object.create(null);
                _d["passive"] = false;
                _d["capture"] = true;
                return _d;
            }).call(this));
            container.lastChild.focus();
        };
        if (!setup_container.__argnames__) Object.defineProperties(setup_container, {
            __argnames__ : {value: ["container", "close_action"]},
            __module__ : {value: "book_list.show_note"}
        });

        function get_close_action() {
            var q, _unpack, close_action, close_icon, ca;
            q = parse_url_params();
            if (q.panel === "show_note") {
                _unpack = [back, "close"];
                close_action = _unpack[0];
                close_icon = _unpack[1];
                q = parse_url_params();
                ca = q.close_action;
                if (ca === "home") {
                    _unpack = [(function() {
                        var _anonfunc = function () {
                            home();
                        };
                        if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                            __module__ : {value: "book_list.show_note"}
                        });
                        return _anonfunc;
                    })(), "home"];
                    close_action = _unpack[0];
                    close_icon = _unpack[1];
                }
            } else {
                _unpack = [back, "close"];
                close_action = _unpack[0];
                close_icon = _unpack[1];
            }
            return [close_action, close_icon];
        };
        if (!get_close_action.__module__) Object.defineProperties(get_close_action, {
            __module__ : {value: "book_list.show_note"}
        });

        function create_note_display(container) {
            var html;
            _interpolate_kwargs.call(this, add_button, [container, "edit"].concat([_desugar_kwargs({action: edit_note, tooltip: _("Edit this note [E]")})]));
            html = current_note_markup.html;
            container.lastChild.appendChild(make_iframe(html));
        };
        if (!create_note_display.__argnames__) Object.defineProperties(create_note_display, {
            __argnames__ : {value: ["container"]},
            __module__ : {value: "book_list.show_note"}
        });

        function reroute_with_item_id(container, q) {
            var url;
            container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading") + ""].concat([_desugar_kwargs({style: "margin: 0.5rem", class_: "loading"})])));
            url = "get-note-from-item-val/" + encodeURIComponent(q.field) + "/" + encodeURIComponent(q.item);
            if (q.library_id) {
                url += "/" + encodeURIComponent(q.library_id);
            }
            _interpolate_kwargs.call(this, ajax, [url, on_item_val_based_notes_fetched.bind(container.id)].concat([_desugar_kwargs({bypass_cache: false})])).send();
            return;
        };
        if (!reroute_with_item_id.__argnames__) Object.defineProperties(reroute_with_item_id, {
            __argnames__ : {value: ["container", "q"]},
            __module__ : {value: "book_list.show_note"}
        });

        function init_display_note(container_id) {
            var container, _unpack, close_action, close_icon, q, url;
            current_container_id = container_id;
            container = document.getElementById(container_id);
            _unpack = get_close_action();
_unpack = _unpack_asarray(2, _unpack);
            close_action = _unpack[0];
            close_icon = _unpack[1];
            q = parse_url_params();
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: q.item, action: close_action, icon: close_icon})]));
            setup_container(container, close_action);
            if (q.item_id === "0" || q.item_id === 0 || !q.item_id) {
                return reroute_with_item_id(container, q);
            }
            if (current_note_markup && current_note_markup.library_id === q.library_id && current_note_markup.field === q.field && current_note_markup.item_id === q.item_id) {
                create_note_display(container);
            } else {
                container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading") + ""].concat([_desugar_kwargs({style: "margin: 0.5rem", class_: "loading"})])));
                url = "get-note/" + encodeURIComponent(q.field) + "/" + encodeURIComponent(q.item_id);
                if (q.library_id) {
                    url += "/" + encodeURIComponent(q.library_id);
                }
                _interpolate_kwargs.call(this, ajax, [url, on_notes_fetched.bind(container_id)].concat([_desugar_kwargs({bypass_cache: false})])).send();
            }
        };
        if (!init_display_note.__argnames__) Object.defineProperties(init_display_note, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.show_note"}
        });

        function save(container_id, book_id) {
            var c, q, url, close_action;
            c = document.getElementById(container_id);
            if (!c) {
                return;
            }
            q = parse_url_params();
            url = "set-note/" + encodeURIComponent(q.field) + "/" + encodeURIComponent(q.item_id);
            if (q.library_id) {
                url += "/" + encodeURIComponent(q.library_id);
            }
            close_action = get_close_action()[0];
            function on_complete(end_type, xhr, evt) {
                var mi;
                if (end_type === "abort") {
                    close_action();
                    return;
                }
                if (end_type !== "load") {
                    error_dialog(_("Failed to send notes to server"), _("Updating the notes for: {} failed.").format(q.item), xhr.error_html);
                    return;
                }
                q.html = xhr.responseText;
                current_note_markup = q;
                destroy_editor(c);
                if (book_id) {
                    mi = book_metadata(book_id);
                    if (mi) {
                        mi.items_with_notes = mi.items_with_notes || Object.create(null);
                        (_expr_temp = mi.items_with_notes)[_bound_index(q.field, _expr_temp)] = (_expr_temp = mi.items_with_notes)[_bound_index(q.field, _expr_temp)] || Object.create(null);
                        if (q.html) {
                            (_expr_temp = (_expr_temp = mi.items_with_notes)[_bound_index(q.field, _expr_temp)])[_bound_index(q.item, _expr_temp)] = int(q.item_id);
                        } else {
                            delete mi.items_with_notes[q.field][q.item];
                        }
                    }
                }
                close_action();
            };
            if (!on_complete.__argnames__) Object.defineProperties(on_complete, {
                __argnames__ : {value: ["end_type", "xhr", "evt"]},
                __module__ : {value: "book_list.show_note"}
            });

            function on_got_html(html, extra_data) {
                ajax_send_progress_dialog(url, (function(){
                    var _d = Object.create(null);
                    _d["html"] = html;
                    _d["searchable_text"] = extra_data.text;
                    _d["images"] = extra_data.images;
                    return _d;
                }).call(this), on_complete, _("Sending note data to calibre server..."));
            };
            if (!on_got_html.__argnames__) Object.defineProperties(on_got_html, {
                __argnames__ : {value: ["html", "extra_data"]},
                __module__ : {value: "book_list.show_note"}
            });

            get_comments_html(c, on_got_html);
        };
        if (!save.__argnames__) Object.defineProperties(save, {
            __argnames__ : {value: ["container_id", "book_id"]},
            __module__ : {value: "book_list.show_note"}
        });

        function init_edit(container_id) {
            var container, q, _unpack, close_action, close_icon, url;
            current_container_id = container_id;
            container = document.getElementById(container_id);
            q = parse_url_params();
            _unpack = get_close_action();
_unpack = _unpack_asarray(2, _unpack);
            close_action = _unpack[0];
            close_icon = _unpack[1];
            _interpolate_kwargs.call(this, create_top_bar, [container].concat([_desugar_kwargs({title: _("Edit {}").format(q.item), action: close_action, icon: close_icon, tooltip: _("Discard any changes")})]));
            setup_container(container, close_action);
            if (q.item_id === "0" || q.item_id === 0 || !q.item_id) {
                return reroute_with_item_id(container, q);
            }
            if (current_note_markup && current_note_markup.library_id === q.library_id && current_note_markup.field === q.field && current_note_markup.item_id === q.item_id) {
                create_editor(container.lastChild, current_note_markup.html);
            } else {
                container.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_("Loading") + ""].concat([_desugar_kwargs({style: "margin: 0.5rem", class_: "loading"})])));
                url = "get-note/" + encodeURIComponent(q.field) + "/" + encodeURIComponent(q.item_id);
                if (q.library_id) {
                    url += "/" + encodeURIComponent(q.library_id);
                }
                _interpolate_kwargs.call(this, ajax, [url, on_notes_fetched.bind(container_id)].concat([_desugar_kwargs({bypass_cache: false})])).send();
            }
        };
        if (!init_edit.__argnames__) Object.defineProperties(init_edit, {
            __argnames__ : {value: ["container_id"]},
            __module__ : {value: "book_list.show_note"}
        });

        function create_editor(container, html) {
            var book_id, bar_container, c, editor;
            book_id = book_whose_metadata_is_being_edited();
            book_whose_metadata_is_being_edited(null);
            bar_container = document.getElementById(current_container_id);
            if (bar_container) {
                _interpolate_kwargs.call(this, add_button, [bar_container, "check"].concat([_desugar_kwargs({action: save.bind(null, bar_container.id, book_id), tooltip: _("Save the changes")})]));
            }
            c = container.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({style: "flex-grow:10"})]));
            editor = create_comments_editor(c, (function(){
                var _d = Object.create(null);
                _d["insert_image_files"] = true;
                return _d;
            }).call(this));
            set_comments_html(c, html);
            focus_comments_editor(c);
            editor.init();
        };
        if (!create_editor.__argnames__) Object.defineProperties(create_editor, {
            __argnames__ : {value: ["container", "html"]},
            __module__ : {value: "book_list.show_note"}
        });

        set_panel_handler("show_note", init_display_note);
        set_panel_handler("edit_note", init_edit);
        _modules["book_list.show_note"].current_note_markup = current_note_markup;
        _modules["book_list.show_note"].current_container_id = current_container_id;
        _modules["book_list.show_note"].message_from_iframe = message_from_iframe;
        _modules["book_list.show_note"].make_iframe = make_iframe;
        _modules["book_list.show_note"].on_item_val_based_notes_fetched = on_item_val_based_notes_fetched;
        _modules["book_list.show_note"].on_notes_fetched = on_notes_fetched;
        _modules["book_list.show_note"].edit_note = edit_note;
        _modules["book_list.show_note"].onkeydown = onkeydown;
        _modules["book_list.show_note"].setup_container = setup_container;
        _modules["book_list.show_note"].get_close_action = get_close_action;
        _modules["book_list.show_note"].create_note_display = create_note_display;
        _modules["book_list.show_note"].reroute_with_item_id = reroute_with_item_id;
        _modules["book_list.show_note"].init_display_note = init_display_note;
        _modules["book_list.show_note"].save = save;
        _modules["book_list.show_note"].init_edit = init_edit;
        _modules["book_list.show_note"].create_editor = create_editor;
    })();

    (function(){
        var __name__ = "book_list.main";
        var traceback = _modules.traceback;

        var E = _modules.elementmaker.E;

        var ajax = _modules.ajax.ajax;

        var set_css = _modules.dom.set_css;
        var get_widget_css = _modules.dom.get_widget_css;

        var create_modal_container = _modules.modals.create_modal_container;
        var error_dialog = _modules.modals.error_dialog;

        var get_interface_data = _modules.session.get_interface_data;
        var UserSessionData = _modules.session.UserSessionData;
        var update_interface_data = _modules.session.update_interface_data;
        var get_translations = _modules.session.get_translations;

        var _ = _modules.gettext.gettext;
        var install = _modules.gettext.install;

        var install_event_filters = _modules.popups.install_event_filters;

        var safe_set_inner_html = _modules.utils.safe_set_inner_html;

        var book_list_container_id = _modules["book_list.constants"].book_list_container_id;
        var read_book_container_id = _modules["book_list.constants"].read_book_container_id;
        var INIT_ENDPOINT = _modules["book_list.constants"].INIT_ENDPOINT;

        var update_recently_read_by_user = _modules["book_list.home"].update_recently_read_by_user;

        var fetch_init_data = _modules["book_list.library_data"].fetch_init_data;
        var update_library_data = _modules["book_list.library_data"].update_library_data;
        var url_books_query = _modules["book_list.library_data"].url_books_query;

        var get_color = _modules["book_list.theme"].get_color;
        var get_font_family = _modules["book_list.theme"].get_font_family;
        var css_for_variables = _modules["book_list.theme"].css_for_variables;

        var update_window_title = _modules["book_list.router"].update_window_title;
        var set_default_mode_handler = _modules["book_list.router"].set_default_mode_handler;
        var apply_url = _modules["book_list.router"].apply_url;
        var set_mode_handler = _modules["book_list.router"].set_mode_handler;
        var on_pop_state = _modules["book_list.router"].on_pop_state;

        var get_db = _modules["book_list.globals"].get_db;
        var set_session_data = _modules["book_list.globals"].set_session_data;

        var book_list_mode_handler = _modules["book_list.ui"].apply_url_state;

        var ReadUI = _modules["read_book.ui"].ReadUI;

        var book_list = _modules.book_list;
        book_list.home = _modules["book_list.home"];

        var book_list = _modules.book_list;
        book_list.views = _modules["book_list.views"];

        var book_list = _modules.book_list;
        book_list.local_books = _modules["book_list.local_books"];

        var book_list = _modules.book_list;
        book_list.book_details = _modules["book_list.book_details"];

        var book_list = _modules.book_list;
        book_list.edit_metadata = _modules["book_list.edit_metadata"];

        var book_list = _modules.book_list;
        book_list.convert_book = _modules["book_list.convert_book"];

        var book_list = _modules.book_list;
        book_list.fts = _modules["book_list.fts"];

        var book_list = _modules.book_list;
        book_list.show_note = _modules["book_list.show_note"];

        function remove_initial_progress_bar() {
            var p;
            p = document.getElementById("page_load_progress");
            if (p) {
                p.parentNode.removeChild(p);
            }
        };
        if (!remove_initial_progress_bar.__module__) Object.defineProperties(remove_initial_progress_bar, {
            __module__ : {value: "book_list.main"}
        });

        function onerror(msg, script_url, line_number, column_number, error_object) {
            var fname, details;
            if (error_object === null) {
                console.log("Unhandled error from external javascript, ignoring: " + _str.format("{}", msg) + " " + _str.format("{}", script_url) + " " + _str.format("{}", line_number) + "");
                return;
            }
            console.log(error_object);
            try {
                fname = (_expr_temp = script_url.rpartition("/"))[_expr_temp.length-1] || script_url;
                msg = msg + "<br><span style=\"font-size:smaller\">" + "Error at {}:{}:{}".format(fname, line_number, column_number || "") + "</span>";
                details = "";
                details = traceback.format_exception(error_object).join("");
                error_dialog(_("Unhandled error"), msg, details);
                return true;
            } catch (_Exception) {
                _last_exception = _Exception;
                {
                    console.log("There was an error in the unhandled exception handler");
                } 
            }
        };
        if (!onerror.__argnames__) Object.defineProperties(onerror, {
            __argnames__ : {value: ["msg", "script_url", "line_number", "column_number", "error_object"]},
            __module__ : {value: "book_list.main"}
        });

        function init_ui() {
            var translations, read_ui;
            document.body.style.fontFamily = get_font_family();
            install_event_filters();
            set_default_mode_handler(book_list_mode_handler);
            window.onerror = onerror;
            setTimeout((function() {
                var _anonfunc = function () {
                    window.onpopstate = on_pop_state;
                };
                if (!_anonfunc.__module__) Object.defineProperties(_anonfunc, {
                    __module__ : {value: "book_list.main"}
                });
                return _anonfunc;
            })(), 0);
            translations = get_translations();
            install(translations);
            remove_initial_progress_bar();
            document.head.appendChild(E.style(css_for_variables() + "\n\n" + get_widget_css()));
            _interpolate_kwargs.call(this, set_css, [document.body].concat([_desugar_kwargs({background_color: get_color("window-background"), color: get_color("window-foreground")})]));
            document.body.appendChild(E.div());
            document.body.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: book_list_container_id, style: "display: none"})]));
            document.body.lastChild.appendChild(_interpolate_kwargs.call(E, E.div, [_desugar_kwargs({id: read_book_container_id, style: "display: none"})]));
            create_modal_container();
            update_window_title();
            read_ui = new ReadUI;
            get_db(read_ui.db);
            set_mode_handler("read_book", read_ui.apply_url_state.bind(read_ui));
            apply_url();
        };
        if (!init_ui.__module__) Object.defineProperties(init_ui, {
            __module__ : {value: "book_list.main"}
        });

        function install_data_and_init_ui(raw_data) {
            var data, interface_data, sd;
            data = JSON.parse(raw_data);
            update_interface_data(data);
            update_recently_read_by_user(data.recently_read_by_user);
            update_library_data(data);
            interface_data = get_interface_data();
            sd = new UserSessionData(interface_data.username, interface_data.user_session_data);
            set_session_data(sd);
            if (_exists.n(data.translations)) {
                get_translations(data.translations);
            }
            init_ui();
        };
        if (!install_data_and_init_ui.__argnames__) Object.defineProperties(install_data_and_init_ui, {
            __argnames__ : {value: ["raw_data"]},
            __module__ : {value: "book_list.main"}
        });

        function on_data_loaded(end_type, xhr, ev) {
            var p, msg;
            remove_initial_progress_bar();
            if (end_type === "load") {
                install_data_and_init_ui(xhr.responseText);
            } else {
                p = _interpolate_kwargs.call(E, E.p, [_desugar_kwargs({style: "color:{}; font-weight: bold; font-size:1.5em".format(get_color("window-error-foreground"))})]);
                if (xhr.status === 401) {
                    msg = _("You are not authorized to view this site");
                } else {
                    msg = xhr.error_html;
                }
                safe_set_inner_html(p, msg);
                document.body.appendChild(p);
            }
        };
        if (!on_data_loaded.__argnames__) Object.defineProperties(on_data_loaded, {
            __argnames__ : {value: ["end_type", "xhr", "ev"]},
            __module__ : {value: "book_list.main"}
        });

        function on_data_load_progress(loaded, total) {
            var p;
            p = document.querySelector("#page_load_progress > progress");
            if (p) {
                p.max = total;
                p.value = loaded;
            }
        };
        if (!on_data_load_progress.__argnames__) Object.defineProperties(on_data_load_progress, {
            __argnames__ : {value: ["loaded", "total"]},
            __module__ : {value: "book_list.main"}
        });

        function load_interface_data() {
            var idata, query, temp;
            idata = get_interface_data();
            query = Object.create(null);
            if (!idata.is_default) {
                temp = new UserSessionData(null, Object.create(null));
                query = url_books_query(temp);
            }
            _interpolate_kwargs.call(this, ajax, [INIT_ENDPOINT, on_data_loaded, on_data_load_progress].concat([_desugar_kwargs({query: query})])).send();
        };
        if (!load_interface_data.__module__) Object.defineProperties(load_interface_data, {
            __module__ : {value: "book_list.main"}
        });

        function do_update_interface_data() {
            var t, thash, url;
            t = get_translations();
            thash = (typeof t !== "undefined" && t !== null ? t : Object.create(null)).hash;
            url = "interface-data/update";
            if (thash) {
                url += "/" + thash;
            }
            ajax(url, (function() {
                var _anonfunc = function (end_type, xhr, ev) {
                    var data;
                    if (end_type === "load") {
                        data = JSON.parse(xhr.responseText);
                        update_interface_data(data);
                        update_recently_read_by_user(data.recently_read_by_user);
                        if (_exists.n(data.translations)) {
                            get_translations(data.translations);
                            install(data.translations);
                        }
                    } else {
                        update_recently_read_by_user();
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["end_type", "xhr", "ev"]},
                    __module__ : {value: "book_list.main"}
                });
                return _anonfunc;
            })()).send();
        };
        if (!do_update_interface_data.__module__) Object.defineProperties(do_update_interface_data, {
            __module__ : {value: "book_list.main"}
        });

        function main() {
            var interface_data, sd;
            if (document.createElement("iframe").srcdoc === undefined) {
                document.body.innerHTML = "<p style=\"margin:1.5em; max-width: 40em\">" + _("You are using a browser that does not have the iframe srcdoc attribute. This is not supported. Use a better browser such as <b>Google Chrome</b> or <b>Mozilla Firefox</b>, instead. You can also use the simplified <a href=\"mobile\">/mobile</a> interface if you do not have access to a modern browser.");
                return;
            }
            interface_data = get_interface_data();
            if (interface_data.is_default || !interface_data.library_map) {
                load_interface_data();
            } else {
                sd = new UserSessionData(interface_data.username, interface_data.user_session_data);
                set_session_data(sd);
                do_update_interface_data();
                fetch_init_data();
                init_ui();
            }
        };
        if (!main.__module__) Object.defineProperties(main, {
            __module__ : {value: "book_list.main"}
        });

        _modules["book_list.main"].remove_initial_progress_bar = remove_initial_progress_bar;
        _modules["book_list.main"].onerror = onerror;
        _modules["book_list.main"].init_ui = init_ui;
        _modules["book_list.main"].install_data_and_init_ui = install_data_and_init_ui;
        _modules["book_list.main"].on_data_loaded = on_data_loaded;
        _modules["book_list.main"].on_data_load_progress = on_data_load_progress;
        _modules["book_list.main"].load_interface_data = load_interface_data;
        _modules["book_list.main"].do_update_interface_data = do_update_interface_data;
        _modules["book_list.main"].main = main;
    })();

    (function(){

        var __name__ = "__main__";


        var autoreload_enabled, AUTO_UPDATE_THRESHOLD, iframe_script, entry_point;
        var initialize = _modules.initialize;

        var ajax = _modules.ajax.ajax;
        var console_print = _modules.ajax.console_print;
        var set_default_timeout = _modules.ajax.set_default_timeout;

        var create_auto_reload_watcher = _modules.autoreload.create_auto_reload_watcher;

        var main_js = _modules["book_list.globals"].main_js;

        var main = _modules["book_list.main"].main;

        autoreload_enabled = false;
        AUTO_UPDATE_THRESHOLD = 1e3;
        function worker_main(entry_point) {
            var m, main;
            m = _get_module(entry_point);
            main = (typeof m !== "undefined" && m !== null ? m : Object.create(null)).main;
            if (main) {
                main();
            } else {
                console.log("worker entry_point " + entry_point + " not found");
            }
        };
        if (!worker_main.__argnames__) Object.defineProperties(worker_main, {
            __argnames__ : {value: ["entry_point"]},
            __module__ : {value: null}
        });

        function iframe_main(script) {
            var m, main;
            script.parentNode.removeChild(script);
            script = undefined;
            m = _get_module(window.iframe_entry_point);
            main = (typeof m !== "undefined" && m !== null ? m : Object.create(null)).main;
            if (main) {
                main();
            } else {
                console.log("iframe entry_point " + window.iframe_entry_point + " not found");
            }
        };
        if (!iframe_main.__argnames__) Object.defineProperties(iframe_main, {
            __argnames__ : {value: ["script"]},
            __module__ : {value: null}
        });

        function toplevel_main() {
            var script;
            script = document.currentScript || document.scripts[0];
            main_js(script.textContent);
            script.parentNode.removeChild(script);
            script = undefined;
            window.addEventListener("load", main);
            ajax("ajax-setup", (function() {
                var _anonfunc = function (end_type, xhr, event) {
                    var data, tim, port;
                    if (end_type === "load") {
                        try {
                            data = JSON.parse(xhr.responseText);
                        } catch (_Exception) {
                            _last_exception = _Exception;
                            {
                                return;
                            } 
                        }
                        tim = data.ajax_timeout;
                        if (!isNaN(tim) && tim > 0) {
                            set_default_timeout(tim);
                        }
                        port = data.auto_reload_port;
                        if (!isNaN(port) && port > 0) {
                            autoreload_enabled = true;
                            create_auto_reload_watcher(port);
                        }
                        if (data.allow_console_print) {
                            print = console_print;
                        }
                    }
                };
                if (!_anonfunc.__argnames__) Object.defineProperties(_anonfunc, {
                    __argnames__ : {value: ["end_type", "xhr", "event"]},
                    __module__ : {value: null}
                });
                return _anonfunc;
            })()).send();
        };
        if (!toplevel_main.__module__) Object.defineProperties(toplevel_main, {
            __module__ : {value: null}
        });

        if ((typeof document !== "undefined" && document !== null)) {
            iframe_script = document.getElementById("bootstrap");
            if (iframe_script) {
                iframe_main(iframe_script);
            } else {
                toplevel_main();
            }
        } else if ((typeof self !== "undefined" && self !== null)) {
            entry_point = self.location.hash.slice(1);
            worker_main(entry_point);
        }
    })();
})();
</script>
<!-- }}} -->
    </body>
</html>
